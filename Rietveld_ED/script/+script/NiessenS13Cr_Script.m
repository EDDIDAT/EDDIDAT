%% Choice of diffractometer, 1 = EDDI, 2 = LEDDI (calculation of tau is modified)
config.configParameter('Diffractometer',...
	'Value', 1);
%% If "Diffractometer" == 2, choice of Measurement Mode, 1 = Mode-I, 2 = Mode-II
config.configParameter('Mode',...
	'Value', 1);
%% If "Diffractometer" == 2, choice of detector, 1 = Det1 (rausgefahren), 2 = Det2 (Primaerstrahl)
config.configParameter('Detector',...
	'Value', 1);
%% Number of specs used in the evaluation
NumberofSpecs = 1;
%% Choice of scattering angle TwoTheta
config.configParameter('TwoTheta',...
	'Value', 13.989);

config.configParameter('LowerChannelBound',...
	'Value', 1350);

config.configParameter('UpperChannelBound',...
	'Value', 11800);

Pos = [14.08;14.64;15.17;17.44;18.84;19.61;19.96;24.01;33.48;60.58;68.44;70.75;81.11;83.10;86.78;90.25];

config.configParameter('DummyIntensity',...
	'Value', 1000*ones(length(Pos),1),...	%;0;0;0;0;0;0;0;0],...
	'LowerConstraint', 0,...
	'UpperConstraint', 1000000,...
	'Refinable', false);

config.configParameter('DummyMixingFactor',...
	'Value', 0.5*ones(length(Pos),1),...	%;1;1;1;1;1;1;1;1],...
	'LowerConstraint', 0,...
	'UpperConstraint', 1,...
	'Refinable', false);

config.configParameter('DummyPosition',...
	'Value', Pos,...	%; 20.98; 29.67; 36.34; 41.96; 46.91; 51.39
	'LowerConstraint', Pos - 0.2,... %[18.87; 21.55; 23.76; 32.11; 37.45; 44.61],...	%; 20.68; 29.37; 36.04; 41.66; 46.61; 51.09
	'UpperConstraint', Pos + 0.2,... %[19.37; 22.05; 24.26; 32.61; 37.95; 45.11],...	%; 21.28; 29.97; 36.64; 42.26; 47.21; 51.69
	'Refinable', false);

config.configParameter('DummyWidth',...
	'Value', 0.2*ones(length(Pos),1),...	%;0.1;0.1;0.1;0.1;0.1;0.1;0.1;0.1],...
	'LowerConstraint', 0,...
	'UpperConstraint', 1,...
	'Refinable', false);



config.configParameter('Dummy_P_Size',...
	'Value', 0.0496247844*ones(length(Pos),1),...	%; 20.98; 29.67; 36.34; 41.96; 46.91; 51.39
	'LowerConstraint', 0.0496247844,... %[18.87; 21.55; 23.76; 32.11; 37.45; 44.61],...	%; 20.68; 29.37; 36.04; 41.66; 46.61; 51.09
	'UpperConstraint', 1,... %[19.37; 22.05; 24.26; 32.61; 37.95; 45.11],...	%; 21.28; 29.97; 36.64; 42.26; 47.21; 51.69
	'Refinable', false);

config.configParameter('Dummy_X_Size',...
	'Value', 0.0072250868*ones(length(Pos),1),...	%;0.1;0.1;0.1;0.1;0.1;0.1;0.1;0.1],...
	'LowerConstraint', 0.0072250868,...
	'UpperConstraint', 1,...
	'Refinable', false);

config.configParameter('Dummy_U_Strain',...
	'Value', 0.0000245443*ones(length(Pos),1),...	%; 20.98; 29.67; 36.34; 41.96; 46.91; 51.39
	'LowerConstraint', 0.0000245443,... %[18.87; 21.55; 23.76; 32.11; 37.45; 44.61],...	%; 20.68; 29.37; 36.04; 41.66; 46.61; 51.09
	'UpperConstraint', 1,... %[19.37; 22.05; 24.26; 32.61; 37.95; 45.11],...	%; 21.28; 29.97; 36.64; 42.26; 47.21; 51.69
	'Refinable', false);

config.configParameter('Dummy_Y_Strain',...
	'Value', 0.0004669675*ones(length(Pos),1),...	%;0.1;0.1;0.1;0.1;0.1;0.1;0.1;0.1],...
	'LowerConstraint', 0.0004669675,...
	'UpperConstraint', 1,...
	'Refinable', false);


psiTmp = round(S.Psi);
for i = 1:numberOfSpecs
	config.configParameter('Psi',...
		'Value', psiTmp(i),...
		'SpecIndex', i);
end

%% Input of photon energies of principal K-, L-shell emmision lines
config.configParameter('FluorPos_K',...
	'Value', [6.403; 6.390; 7.058]);
config.configParameter('FluorPos_L',...
	'Value', zeros(0,1));
config.configParameter('FluorInt_K',...
	'Value', [1.00; 0.5; 0.17]);
config.configParameter('FluorInt_L',...
	'Value', zeros(0,1));
% 	'Value', [1; 0.25; 0.95; 0.4; 0.17]);

%% Input of the h k l values and multiplicity m values
% Phase 1
hklTmp1 = [1 1 0 12;...
    2 0 0 6;...
    2 1 1 24;...
    2 2 0 12;...
    3 1 0 24;...
    2 2 2 8;...
    3 2 1 48;...
    4 1 1 24;...
    4 2 0 24;...
    3 3 2 24];

% Phase 2
hklTmp2 = [1 1 1 8;...
    2 0 0 6;...
    2 2 0 12;...
    3 1 1 24;...
    2 2 2 8;...
    4 0 0 6;...
    3 3 1 24];...
%     4 2 0 6;...
%     4 2 2 24;...
%     3 3 3 8];

% Phase 1
config.configParameter('H',...
	'Value', hklTmp1(:,1),...
    'PhaseIndex', 1);
config.configParameter('K',...
	'Value', hklTmp1(:,2),...
    'PhaseIndex', 1);
config.configParameter('L',...
	'Value', hklTmp1(:,3),...
    'PhaseIndex', 1);
config.configParameter('Multiplicity',...
	'Value', hklTmp1(:,4),...
    'PhaseIndex', 1);
config.configParameter('Alpha',...
	'Value', 90,...
    'PhaseIndex', 1);
config.configParameter('Beta',...
	'Value', 90,...
    'PhaseIndex', 1);
config.configParameter('Gamma',...
	'Value', 90,...
    'PhaseIndex', 1);
config.configParameter('d0',...
	'Value', [2.02806442372041; 1.43433425576655; 1.17118571580656; 1.01442209381871; 0.907627099161091; 0.828427343176114; 0.767201013674323],...
    'PhaseIndex', 1);
% % Phase 2
config.configParameter('H',...
	'Value', hklTmp2(:,1),...
    'PhaseIndex', 2);
config.configParameter('K',...
	'Value', hklTmp2(:,2),...
    'PhaseIndex', 2);
config.configParameter('L',...
	'Value', hklTmp2(:,3),...
    'PhaseIndex', 2);
config.configParameter('Multiplicity',...
	'Value', hklTmp2(:,4),...
    'PhaseIndex', 2);
config.configParameter('Alpha',...
	'Value', 90,...
    'PhaseIndex', 2);
config.configParameter('Beta',...
	'Value', 90,...
    'PhaseIndex', 2);
config.configParameter('Gamma',...
	'Value', 90,...
    'PhaseIndex', 2);
% config.configParameter('d0',...
% 	'Value', [2.02806442372041; 1.43433425576655; 1.17118571580656; 1.01442209381871; 0.907627099161091; 0.828427343176114; 0.767201013674323],...
%     'PhaseIndex', 2);

config.configParameter('RingCurrent',...
	'Value', 300);

deadTimeTmp = S.DeadTime;

for i = 1:numberOfSpecs
	config.configParameter('DeadTime',...
		'Value', deadTimeTmp(i),...
		'SpecIndex', i);
end

%% Input of the DEK values
% Phase 1
DEK_S_Tmp1 = [-1.233e-006 5.7e-006
			-1.876e-006 7.628e-006
			-1.233e-006 5.7e-006
			-1.233e-006 5.7e-006
            -1.465e-006 6.395e-006
            -1.019e-006 5.058e-006
			-1.233e-006 5.7e-006
			-1.614e-006 6.843e-006
			-1.465e-006 6.395e-006
            -1.064e-006 5.191e-006];
        
% Phase 2
DEK_S_Tmp2 = [-1.11e-006 5.14e-006
			-2.35e-006 8.86e-006
			-1.42e-006 6.07e-006
			-1.77e-006 7.11e-006
			-1.11e-006 5.14e-006
            -2.35e-006 8.86e-006
            -1.34e-006 5.79e-006];
% 			-1.76e-006 7.07e-006
% 			-1.77e-006 7.11e-006
%             -1.11e-006 5.14e-006];        
	
config.configParameter('DEK_S1',...
	'Value', DEK_S_Tmp1(:,1),...
    'PhaseIndex', 1);
config.configParameter('DEK_S2',...
	'Value', DEK_S_Tmp1(:,2),...
    'PhaseIndex', 1);

config.configParameter('DEK_S1',...
	'Value', DEK_S_Tmp2(:,1),...
    'PhaseIndex', 2);
config.configParameter('DEK_S2',...
	'Value', DEK_S_Tmp2(:,2),...
    'PhaseIndex', 2);

%% Input of the attenuation factors
config.configParameter('DensityAir',...
	'Value', 1.2041e-003);
load(fullfile(rvpath,'data','Physics','Air_Absorption.mat'));
config.configParameter('X_airabsorption',...
	'Value', X_airabsorption);
config.configParameter('Y_airabsorption',...
	'Value', Y_airabsorption_en);
config.configParameter('DetectorDistance',...
	'Value', 110);

%% material absorption correction
config.configParameter('Density',...
	'Value', 7.87,...
    'PhaseIndex', 1);
load(fullfile(rvpath,'data','Physics','Fe_absorption_XCOM'));
config.configParameter('X_abs',...
	'Value', X_abs,...
    'PhaseIndex', 1);
config.configParameter('Y_abs',...
	'Value', Y_abs,...
    'PhaseIndex', 1);

config.configParameter('Density',...
	'Value', 7.87,...
    'PhaseIndex', 2);
load(fullfile(rvpath,'data','Physics','Fe_absorption_XCOM'));
config.configParameter('X_abs',...
	'Value', X_abs,...
    'PhaseIndex', 2);
config.configParameter('Y_abs',...
	'Value', Y_abs,...
    'PhaseIndex', 2);

%% FitParameter for the FWHM and the line position calibration
config.configParameter('FluorScaleFactor_K',...
	'Value', 1,...
	'LowerConstraint', 0,...
	'UpperConstraint', +Inf,...
	'Refinable', false);
config.configParameter('FluorScaleFactor_L',...
	'Value', 1,...
	'LowerConstraint', 0,...
	'UpperConstraint', +Inf,...
	'Refinable', false);
config.configParameter('FluorDeltaEnergy_K',...
	'Value', zeros(3,1),...
	'LowerConstraint', -Inf,...
	'UpperConstraint', +Inf,...
	'Refinable', false);
config.configParameter('FluorDeltaEnergy_L',...
	'Value', zeros(3,1),...
	'LowerConstraint', -Inf,...
	'UpperConstraint', +Inf,...
	'Refinable', false);
config.configParameter('FluorU_K',...
	'Value', 0.0025,...
	'LowerConstraint', -Inf,...
	'UpperConstraint', +Inf,...
	'Refinable', false);
config.configParameter('FluorW_K',...
	'Value', 0.0005,...
	'LowerConstraint', -Inf,...
	'UpperConstraint', +Inf,...
	'Refinable', false);
config.configParameter('FluorU_L',...
	'Value', 0.0025,...
	'LowerConstraint', -Inf,...
	'UpperConstraint', +Inf,...
	'Refinable', false);
config.configParameter('FluorW_L',...
	'Value', 0.0005,...
	'LowerConstraint', -Inf,...
	'UpperConstraint', +Inf,...
	'Refinable', false);

%% Phase 1
PeakCnt1 = 10;
config.configParameter('ScaleFactor',...
	'Value', 1,...
	'LowerConstraint', 0,...
	'UpperConstraint', +Inf,...
	'Refinable', true,...
    'PhaseIndex', 1);
config.configParameter('StructureFactor',...
	'Value', ones(PeakCnt1,1).*5000,...
	'LowerConstraint', 0,...
	'UpperConstraint', +Inf,...
	'Refinable', false,...
    'PhaseIndex', 1);
config.configParameter('DeltaEnergy_a',...
	'Value', 0,...
	'LowerConstraint', -Inf,...
	'UpperConstraint', +Inf,...
	'Refinable', false,...
    'PhaseIndex', 1);
config.configParameter('DeltaEnergy_b',...
	'Value', 0,...
	'LowerConstraint', -Inf,...
	'UpperConstraint', +Inf,...
	'Refinable', false,...
    'PhaseIndex', 1);
config.configParameter('DeltaEnergy_c',...
	'Value', 0,...
	'LowerConstraint', -Inf,...
	'UpperConstraint', +Inf,...
	'Refinable', false,...
    'PhaseIndex', 1);

config.configParameter('LatticeParam1',...
	'Value', 2.874,...
	'LowerConstraint', 0,...
	'UpperConstraint', +Inf,...
	'Refinable', false,...
    'PhaseIndex', 1);
config.configParameter('LatticeParam2',...
	'Value', 0,...
	'LowerConstraint', 0,...
	'UpperConstraint', +Inf,...
	'Refinable', false,...
    'PhaseIndex', 1);
config.configParameter('LatticeParam3',...
	'Value', 0,...
	'LowerConstraint', 0,...
	'UpperConstraint', +Inf,...
	'Refinable', false,...
    'PhaseIndex', 1);
config.configParameter('FitCarbonContent',...
	'Value', 0,...
	'LowerConstraint', 0,...
	'UpperConstraint', 1,...
	'Refinable', false,...
    'PhaseIndex', 1);
config.configParameter('CarbonContent',...
	'Value', 0,...
	'LowerConstraint', 0,...
	'UpperConstraint', 10,...
	'Refinable', false,...
    'PhaseIndex', 1);

config.configParameter('sigmatau',...
	'Value', zeros(PeakCnt1,1),...
	'LowerConstraint', -Inf,...
	'UpperConstraint', +Inf,...
	'Refinable', false,...
    'PhaseIndex', 1);
config.configParameter('epsilon',...
	'Value', zeros(PeakCnt1,1),...
	'LowerConstraint', -Inf,...
	'UpperConstraint', +Inf,...
	'Refinable', false,...
    'PhaseIndex', 1);

config.configParameter('P_Size',...
	'Value', 0.0496247844,...
	'LowerConstraint', 0.0496247844,...
	'UpperConstraint', 1,...
	'Refinable', false,...
    'PhaseIndex', 1);
config.configParameter('U_Strain',...
	'Value', 0.0000245443,...
	'LowerConstraint', 0.0000245443,...
	'UpperConstraint', 1,...
	'Refinable', false,...
    'PhaseIndex', 1);
config.configParameter('V_Detector',...
	'Value', 0,...
	'LowerConstraint', 0,...
	'UpperConstraint', 1,...
	'Refinable', false,...
    'PhaseIndex', 1);
config.configParameter('X_Size',...
	'Value', 0.0072250868,...
	'LowerConstraint', 0.0072250868,...
	'UpperConstraint', 1,...
	'Refinable', false,...
    'PhaseIndex', 1);
config.configParameter('Y_Strain',...
	'Value', 0.0004669675,...
	'LowerConstraint', 0.0004669675,...
	'UpperConstraint', 1,...
	'Refinable', false,...
    'PhaseIndex', 1);
config.configParameter('Z_Detector',...
	'Value', 0,...
	'LowerConstraint', 0,...
	'UpperConstraint', 1,...
	'Refinable', false,...
    'PhaseIndex', 1);
config.configParameter('PVmix',...
	'Value', ones(PeakCnt1,1)*0.5,...
	'LowerConstraint', 0,...
	'UpperConstraint', 1,...
	'Refinable', false,...
    'PhaseIndex', 1);
config.configParameter('FWHM',...
	'Value', ones(PeakCnt1,1)*0.25,...
	'LowerConstraint', 0.001,...
	'UpperConstraint', 1,...
	'Refinable', false,...
    'PhaseIndex', 1);

%% Phase 2
PeakCnt2 = 7; 
config.configParameter('ScaleFactor',...
	'Value', 1,...
	'LowerConstraint', 0,...
	'UpperConstraint', +Inf,...
	'Refinable', true,...
    'PhaseIndex', 2);
config.configParameter('StructureFactor',...
	'Value', ones(PeakCnt2,1).*5000,...
	'LowerConstraint', 0,...
	'UpperConstraint', +Inf,...
	'Refinable', false,...
    'PhaseIndex', 2);
config.configParameter('DeltaEnergy_a',...
	'Value', 0,...
	'LowerConstraint', -Inf,...
	'UpperConstraint', +Inf,...
	'Refinable', false,...
    'PhaseIndex', 2);
config.configParameter('DeltaEnergy_b',...
	'Value', 0,...
	'LowerConstraint', -Inf,...
	'UpperConstraint', +Inf,...
	'Refinable', false,...
    'PhaseIndex', 2);
config.configParameter('DeltaEnergy_c',...
	'Value', 0,...
	'LowerConstraint', -Inf,...
	'UpperConstraint', +Inf,...
	'Refinable', false,...
    'PhaseIndex', 2);

config.configParameter('LatticeParam1',...
	'Value', 3.595,...
	'LowerConstraint', 0,...
	'UpperConstraint', +Inf,...
	'Refinable', false,...
    'PhaseIndex', 2);
config.configParameter('LatticeParam2',...
	'Value', 0,...
	'LowerConstraint', 0,...
	'UpperConstraint', +Inf,...
	'Refinable', false,...
    'PhaseIndex', 2);
config.configParameter('LatticeParam3',...
	'Value', 0,...
	'LowerConstraint', 0,...
	'UpperConstraint', +Inf,...
	'Refinable', false,...
    'PhaseIndex', 2);
config.configParameter('FitCarbonContent',...
	'Value', 1,...
	'LowerConstraint', 0,...
	'UpperConstraint', 1,...
	'Refinable', false,...
    'PhaseIndex', 2);
config.configParameter('CarbonContent',...
	'Value', 0.4,...
	'LowerConstraint', 0,...
	'UpperConstraint', 10,...
	'Refinable', false,...
    'PhaseIndex', 2);

config.configParameter('sigmatau',...
	'Value', zeros(PeakCnt2,1),...
	'LowerConstraint', -Inf,...
	'UpperConstraint', +Inf,...
	'Refinable', false,...
    'PhaseIndex', 2);
config.configParameter('epsilon',...
	'Value', zeros(PeakCnt2,1),...
	'LowerConstraint', -Inf,...
	'UpperConstraint', +Inf,...
	'Refinable', false,...
    'PhaseIndex', 2);

config.configParameter('P_Size',...
	'Value', 0.0496247844,...
	'LowerConstraint', 0.0496247844,...
	'UpperConstraint', 1,...
	'Refinable', false,...
    'PhaseIndex', 2);
config.configParameter('U_Strain',...
	'Value', 0.0000245443,...
	'LowerConstraint', 0.0000245443,...
	'UpperConstraint', 1,...
	'Refinable', false,...
    'PhaseIndex', 2);
config.configParameter('V_Detector',...
	'Value', 0,...
	'LowerConstraint', 0,...
	'UpperConstraint', 1,...
	'Refinable', false,...
    'PhaseIndex', 2);
config.configParameter('X_Size',...
	'Value', 0.0072250868,...
	'LowerConstraint', 0.0072250868,...
	'UpperConstraint', 1,...
	'Refinable', false,...
    'PhaseIndex', 2);
config.configParameter('Y_Strain',...
	'Value', 0.0004669675,...
	'LowerConstraint', 0.0004669675,...
	'UpperConstraint', 1,...
	'Refinable', false,...
    'PhaseIndex', 2);
config.configParameter('Z_Detector',...
	'Value', 0,...
	'LowerConstraint', 0,...
	'UpperConstraint', 1,...
	'Refinable', false,...
    'PhaseIndex', 2);
config.configParameter('PVmix',...
	'Value', ones(PeakCnt2,1)*0.5,...
	'LowerConstraint', 0,...
	'UpperConstraint', 1,...
	'Refinable', false,...
    'PhaseIndex', 2);
config.configParameter('FWHM',...
	'Value', ones(PeakCnt2,1)*0.25,...
	'LowerConstraint', 0.001,...
	'UpperConstraint', 1,...
	'Refinable', false,...
    'PhaseIndex', 2);



%% Background
config.configParameter('Background',...
	'Value', zeros(7,1),...
	'LowerConstraint', -Inf,...
	'UpperConstraint', +Inf,...
	'Refinable', true);

config.configParameter('BkgRange',...
	'Value', [1;3482;3483;11800],...
	'LowerConstraint', 0,...
	'UpperConstraint', 10000,...
	'Refinable', false);

config.configParameter('Background1',...
	'Value', zeros(7,1),...
	'LowerConstraint', -Inf,...
	'UpperConstraint', +Inf,...
	'Refinable', true);

config.configParameter('Background2',...
	'Value', zeros(7,1),...
	'LowerConstraint', -Inf,...
	'UpperConstraint', +Inf,...
	'Refinable', true);

config.configParameter('MaxAmp',...
	'Value', [30; 55],...
	'LowerConstraint', 0,...
	'UpperConstraint', Inf,...
	'Refinable', false);
config.configParameter('Center',...
	'Value', [14; 48],...
	'LowerConstraint', 0,...
	'UpperConstraint', Inf,...
	'Refinable', false);
config.configParameter('Width',...
	'Value', [8; 29],...
	'LowerConstraint', 0,...
	'UpperConstraint', Inf,...
	'Refinable', false);
config.configParameter('Shape1',...
	'Value', [3.2; 4.8],...
	'LowerConstraint', 0,...
	'UpperConstraint', Inf,...
	'Refinable', false);
config.configParameter('Shape2',...
	'Value', [3.3; 7.9],...
	'LowerConstraint', 0,...
	'UpperConstraint', Inf,...
	'Refinable', false);

% out = fitter.executeFit(rc);