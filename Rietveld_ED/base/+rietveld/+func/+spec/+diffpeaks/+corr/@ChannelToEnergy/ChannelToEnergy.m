classdef ChannelToEnergy < rietveld.base.RVFunction
	
	methods (Access = public)
		
		function X = execute(obj, ~, ~, meas, ~, spec)

		%% Neue Totzeitkorrektur
			%akutelle ExpDec1 mit weniger Daten bei kleinen DT - bisher am
			%besten f¸r die Kalibrierung geeignet.
			deltaChannel = 6.34603 .* exp(-spec.DeadTime./7.44829) - 2.91412;
% 			deltaChannel = 6.20098 .* exp(-spec.DeadTime./7.27155) - 2.64471;
% 			deltaChannel

			%ExpDec2 mit allen Daten.
% 			deltaChannel = -3.01459 + 2.41626 .* exp(-spec.DeadTime./0.8898) + 4.75614 .* exp(-spec.DeadTime./11.00107);
% 			deltaChannel

			%ExpDec1 mit allen Daten.
% 			deltaChannel = 5.40721 .* exp(-spec.DeadTime./5.45975) - 2.16524;
% 			deltaChannel

			% neue ExpDec1 mit ausgewaehlten Daten (Ba 4262; Am 7264; Ba
			% 9885; W-Fluor 1,2; Au (111,200,220,311); Ba 6484) 23-08-12
% 			deltaChannel = 5.8106 .* exp(-spec.DeadTime./6.47624) - 2.34753;
			
			% neue ExpDec1 mit ausgewaehlten Daten (Ba 4262; Am 7264; Ba
			% 9885; W-Fluor 1,2; Au (111,200,220,311); Ba 6484, zusaetzlich
			% noch mehr Werte bei kleinen Totzeiten von Ba 6484; Ba 9885;
			% Am 2163) 23-08-12
% 			deltaChannel = 5.77503 .* exp(-spec.DeadTime./6.42012) - 2.3291;

			% Soenkes Totzeitkorrekturfunktion mit ausgewaehlten Daten (Ba
			% 4262; Am 7264; Ba 9885; W-Fluor 1,2; Au (111,200,220,311); Ba
			% 6484) 23-08-12
% 			deltaChannel = -3.88854 - exp(3.23406e014 .* (-3.87194e015 - spec.DeadTime)) + 45.85097./(6.04651 + spec.DeadTime);
			
			% Soenkes Totzeitkorrekturfunktion mit ausgewaehlten Daten (Ba
			% 4262; Am 7264; Ba 9885; W-Fluor 1,2; Au (111,200,220,311); Ba
			% 6484, zusaetzlich noch mehr Werte bei kleinen Totzeiten von
			% Ba 6484; Ba 9885; Am 2163) 23-08-12
% 			deltaChannel = -3.84247 - exp(3.22811e014 .* (-3.76133e015 - spec.DeadTime)) + 44.7791./(5.95126 + spec.DeadTime);
			
			ChannelCorr = meas.FluorChannelPositions(:,1) + deltaChannel;
% 			disp(deltaChannel)

			CalibrationFunction = polyfit(ChannelCorr, meas.FluorChannelPositions(:,2), 2);
% 			disp(CalibrationFunction)
% 			CalibrationFunction(3) = CalibrationFunction(3)-0.01;	%Al2O3-Probe
			CalibrationFunction(3) = CalibrationFunction(3)-0.01;	%Standard
% 			CalibrationFunction(3) = CalibrationFunction(3)+0.015;	%Fe-Probe
				
			Channel = meas.LowerChannelBound:meas.UpperChannelBound;
			
			% Polynomielle Kalibrierung mittels polyval (quadratische
			% Funktion zum anpassen) oder spline Kalibrierung.
			
				X = polyval(CalibrationFunction, Channel);
		%% alte Totzeitkorrektur				
% 				Channel = meas.LowerChannelBound:meas.UpperChannelBound;
% 				
% 				deltaE =((-0.005369)-exp((0.044193).*((-182.575) + spec.DeadTime))+(0.143431)./((3.38148) + spec.DeadTime));
% 
% 				p = [-1.32962e-09 0.00820874 -0.0118129];
%   
% 				
% 				X_DT = polyval(p, Channel);
% 				
% 				X = X_DT - deltaE;

		%% Testversuche			
% 				X = interp1(ChannelCorr,meas.FluorChannelPositions(:,2),Channel,'spline');
			
			% Kombinierte Kalibrierfunktion aus polyval und spline. Im
			% Channelbereich < 4875 Channel bzw. Energie < 40 keV und >
			% 6710 Channel bzw. > 54 keV werden die Channel gem‰ﬂ der
			% spline Kalibrierung umgerechnet. Dazwischen werden die
			% Channel mittels der polyval Kalibrierung umgerechnet.
			
%				X(Channel<4875) = interp1(ChannelCorr,meas.FluorChannelPositions(:,2),Channel(Channel<4875),'spline');
% 			
%				X(4875<=Channel&Channel<=6710) = polyval(CalibrationFunction, Channel(4875<=Channel&Channel<=6710));
% 			
%				X(Channel>6710) = interp1(ChannelCorr,meas.FluorChannelPositions(:,2),Channel(Channel>6710),'spline');
		end
		
		function obj = addFunctionParameters(obj, pc)
			
			obj.addParameter(pc, 'DeadTime',...
				'Category', 'Measurement',...
				'ParamSize', [1, 1],...
				'Constant', true,...
				'PhaseDep', false,...
				'SpecDep', true);
			obj.addParameter(pc, 'LowerChannelBound',...
				'Category', 'Measurement',...
				'ParamSize', [1, 1],...
				'Constant', true,...
				'PhaseDep', false,...
				'SpecDep', false);
			obj.addParameter(pc, 'UpperChannelBound',...
				'Category', 'Measurement',...
				'ParamSize', [1, 1],...
				'Constant', true,...
				'PhaseDep', false,...
				'SpecDep', false);
			obj.addParameter(pc, 'FluorChannelPositions',...
				'Category', 'Measurement',...
				'ParamSize', [NaN, 2],...
				'Constant', true,...
				'PhaseDep', false,...
				'SpecDep', false,...
				'Value',[1178.17126	9.672;...
						1211.80156	9.961;...
						1699.49913	13.9441;...
						2163.45945	17.7502;...
						3211.95046	26.3446;...
% 						3349.64769  27.448;...
						3734.15596	30.625;...
						3776.22149	30.973;...
% 						3867.78655  31.694;...
						4262.32879  34.987;...
% 						5471.63222  44.822;...
% 						6416.46202  52.559;...
						6484.17256  53.1622;...
						7264.47638	59.5409;...
						9885.76562	80.9979]);...

% 				'Value',[1023.36181	8.366;...
% 						1180.65638	9.672;...
% 						1700.5891	13.9441;...
% 						2164.5494	17.7502;...
% 						3213.0404	26.3446;...
% % 						3349.64769  27.448;...
% 						3735.2459	30.625;...
% 						3777.3114	30.973;...
% % 						3867.78655  31.694;...
% 						4263.4187  34.987;...
% % 						5471.63222  44.822;...
% % 						6416.46202  52.559;...
% 						6485.2625  53.1622;...
% 						7265.5663	59.5409;...
% 						9886.8556	80.9979]);...
% 						3349.64769 27.448;... Gold Peaks
% 						3867.78655 31.694;...
% 						5471.63222 44.822;...
% 						6416.46202 52.559;...
		end		
	end
	
	methods (Access = protected)
		
		function obj = initSubFunctions(obj)
		end
	end	
end
