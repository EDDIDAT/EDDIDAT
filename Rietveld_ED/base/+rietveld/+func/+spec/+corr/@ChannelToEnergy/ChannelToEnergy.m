classdef ChannelToEnergy < rietveld.base.RVFunction
	
	methods (Access = public)
		
		function X = execute(obj, ~, ~, meas, ~, spec)               
            %% Totzeitkorrektur 2016
            if meas.Diffractometer == 1
% %           - Februar 2016
%                 deltaChannel = -2.0540764369986 - exp(0.0235468494488942 .* (-4.0398219873578 + spec.DeadTime)) + (21.3788118913237./(2.94249931772483 + spec.DeadTime));
%               
                %% Umrechnung von der Kanal- auf die Energieskala
%                 ChannelCorr = meas.FluorChannelPositions(:,1) + deltaChannel;
%                 CalibrationFunction = polyfit(ChannelCorr, meas.FluorChannelPositions(:,2), 2);
%                 Channel = meas.LowerChannelBound:meas.UpperChannelBound;
% 
%                 % Polynomielle Kalibrierung mittels polyval (quadratische
%                 % Funktion zum anpassen) oder spline Kalibrierung.
% 			
% 				X = polyval(CalibrationFunction, Channel);
%                 calib = spec.DTFunc;
%                 % Neue Totzeitkorrektur
%                 % '30. Januar 2017'
%                 Channel = meas.LowerChannelBound:meas.UpperChannelBound;
%                 CalibParam_a = -0.02073 + exp(0.02353*(-208.20673 + ...
%                 spec.DeadTime)) - (0.17481/(2.94153+spec.DeadTime));
%                 CalibParam_b = 0.00818 - 5.29669e-10*spec.DeadTime + 2.43554e-12*spec.DeadTime.^2;
%                 CalibParam_c = -1.90829e-9 - 3.85551e-26*spec.DeadTime;
                
                
%                 %Berechnung mit Hilfe der Kalibirierungsfunktionen der Parameter
%                 %a,b und c.
%                 % Anfang 2015
%                 if strcmp(calib,'Januar 2015')
%                     CalibParam_a = 0.01401 + exp(0.01543*(-260.48858 + ...
%                         obj.DeadTime)) - (0.11759/(1.89065+spec.DeadTime));
%                     CalibParam_b = 0.0082 - 4.90133e-10*spec.DeadTime + ...
%                         2.33226e-12*spec.DeadTime.^2;
%                     CalibParam_c = -1.72537e-9 - 3.78725e-26*spec.DeadTime;
%                 % April 2015
%                 elseif strcmp(calib,'April 2015')
%                     CalibParam_a = -0.03767 + exp(0.01543*(-260.48841 + ...
%                         spec.DeadTime)) - (0.1176/(1.89065+spec.DeadTime));
%                     CalibParam_b = 0.0082 - 3.15213e-10*spec.DeadTime;
%                     CalibParam_c = -1.72537e-9 + 2.97789e-25*spec.DeadTime;
%                 % September 2015
%                 elseif strcmp(calib,'September 2015')
%                     CalibParam_a = -0.0214 + exp(0.02354*(-208.09989 + ...
%                         spec.DeadTime)) - (0.17511/(2.94224+spec.DeadTime));
%                     CalibParam_b = 0.00819 - 5.16723e-10*spec.DeadTime + 2.37589e-12*spec.DeadTime.^2;
%                     CalibParam_c = -1.8617e-9 - 3.7839e-25*spec.DeadTime;
%                 % Januar 2016
%                 elseif strcmp(calib,'Januar 2016')
%                     CalibParam_a = -0.01993 + exp(0.02355*(-208.09581 + ...
%                         spec.DeadTime)) - (0.17508/(2.94249+spec.DeadTime));
%                     CalibParam_b = 0.008119 - 4.82713e-10*spec.DeadTime + 2.21699e-12*spec.DeadTime.^2;
%                     CalibParam_c = -1.73724e-9 - 3.66366e-25*spec.DeadTime;
%                 % Februar 2016
%                 elseif strcmp(calib,'Februar 2016')
%                     CalibParam_a = -0.02402 + exp(0.02355*(-208.15056 + ...
%                         spec.DeadTime)) - (0.17486/(2.94249+spec.DeadTime));
%                     CalibParam_b = 0.00818 - 5.17547e-10*spec.DeadTime + 2.37964e-12*spec.DeadTime.^2;
%                     CalibParam_c = -1.86469e-9 + 6.22393e-25*spec.DeadTime;
%                 % August 2016
%                 elseif strcmp(calib,'August 2016')
%                     CalibParam_a = -0.0244 + exp(0.02354*(-208.17143 + ...
%                         spec.DeadTime)) - (0.17481/(2.94231+spec.DeadTime));
%                     CalibParam_b = 0.00818 - 5.15725e-10*spec.DeadTime + 2.37128e-12*spec.DeadTime.^2;
%                     CalibParam_c = -1.85811e-9 + 4.96803e-26*spec.DeadTime;
%                 % Januar 2017
%                 elseif strcmp(calib,'Januar 2017')
%                     CalibParam_a = -0.02278 + exp(0.02354*(-208.19883 + ...
%                         spec.DeadTime)) - (0.17479/(2.94182+spec.DeadTime));
%                     CalibParam_b = 0.00818 - 5.25536e-10*spec.DeadTime + 2.41649e-12*spec.DeadTime.^2;
%                     CalibParam_c = -1.89342e-9 - 6.89439e-27*spec.DeadTime;
%                 % 30. Januar 2017
%                 elseif strcmp(calib,'30.Januar 2017')
%                     CalibParam_a = -0.02073 + exp(0.02353*(-208.20673 + ...
%                         spec.DeadTime)) - (0.17481/(2.94153+spec.DeadTime));
%                     CalibParam_b = 0.00818 - 5.29669e-10*spec.DeadTime + 2.43554e-12*spec.DeadTime.^2;
%                     CalibParam_c = -1.90829e-9 - 3.85551e-26*spec.DeadTime;
%                 end
        
%         CalibParam_a = -0.0325086361210299 + exp(0.0235468608903271*(-194.534079284638 + ...
%                         spec.DeadTime)) - (0.240956334366071/(2.94249965091252+spec.DeadTime));
%         CalibParam_b = 0.0112707987133917 - 1.81961695506796E-10*spec.DeadTime + 8.36644694100003E-13*spec.DeadTime.^2;
%         CalibParam_c = -6.55595809751696E-10 - 1.83929967433582E-25*spec.DeadTime;
        % MetalJet
        CalibParam_a = -0.02402 + exp(0.02355*(-208.15056 + spec.DeadTime)) - (0.17486/(2.94249+spec.DeadTime));
        CalibParam_b = 0.00818 - 5.17547e-10*spec.DeadTime + 2.37964e-12*spec.DeadTime.^2;
        CalibParam_c = -1.86469e-9 + 6.22393e-25*spec.DeadTime;
        % LEDDI
%         CalibParam_a = -0.029973;
%         CalibParam_b = 0.007592;
%         CalibParam_c = 5.82058e-09;
        
        CalibParams = [CalibParam_c;CalibParam_b;CalibParam_a];
        Channel = meas.LowerChannelBound:meas.UpperChannelBound;
        X = polyval(CalibParams,Channel);
        
        
            %% Totzeitkorrektur Test Fe 3-1 Probe 2016    
%             % Probe Fe 3-1
%             ChannelCorr_Am = meas.FluorChannelPositionsAm(:,1) + deltaChannel_Am;
%             ChannelCorr_Ba = meas.FluorChannelPositionsBa(:,1) + deltaChannel_Ba;
%             ChannelCorr = [ChannelCorr_Am;ChannelCorr_Ba];
%             FluorChannelPositions = [meas.FluorChannelPositionsAm(:,2);meas.FluorChannelPositionsBa(:,2)];
% 			CalibrationFunction = polyfit(ChannelCorr, FluorChannelPositions, 2);
% 			Channel = meas.LowerChannelBound:meas.UpperChannelBound;
% 			
% 			% Polynomielle Kalibrierung mittels polyval (quadratische
% 			% Funktion zum anpassen) oder spline Kalibrierung.
% 			
% 				X = polyval(CalibrationFunction, Channel);
                
		%% LEDDI Totzeitkorrektur
            elseif meas.Diffractometer == 2
				Channel = meas.LowerChannelBound:meas.UpperChannelBound;
				
% 				deltaE =((-0.005369)-exp((0.044193).*((-182.575) + spec.DeadTime))+(0.143431)./((3.38148) + spec.DeadTime));
                
%                 deltaE = 0;

% 				p = flipud(meas.EnergyCalibParams);
                p = [-5.17082e-10, 0.00948, -0.05506];

                X = polyval(p, Channel);
            end
% 				X = X_DT - deltaE;
% 
%       %% LEDDI Totzeitkorrektur
%                 Channel = meas.LowerChannelBound:meas.UpperChannelBound;
% % % 				p = [-1.16289e-10 0.00473 -0.05743]; %Det1 (BSI_1) 16384 Kanaele
% % %                 p = [5.2558E-10 0.00408 -0.06245]; %Det2 (BSI_2) 16384 Kanaele
% % 				p = [5.170815639e-10 0.00947674850469 -0.055056018068]; %Det1 (BSI_1) 8192 Kanaele
% % %                 p = [2.232164035e-9 0.00813902326 -0.04709200399]; %Det2 (BSI_2) 8192 Kanaele
%                 p = [1.983962911388e-9 0.008144863992 -0.04129785988]; %Det2 (BSI_2) 8192 Kanaele neu 13042015
% %                 
% % % 				p = [-0.000000011966580 0.024626220000000 -0.011812899999971]; % Parameter fuer Kanalkonvertierung
% %   
% 				X_DT = polyval(p, Channel);
%                 
%                 deltaE = 0;
% 				
% 				X = X_DT - deltaE;
		end
		
		function obj = addFunctionParameters(obj, pc)

            obj.addParameter(pc, 'DeadTime',...
				'Category', 'Measurement',...
				'ParamSize', [1, 1],...
				'Constant', true,...
				'PhaseDep', false,...
				'SpecDep', true);
			obj.addParameter(pc, 'LowerChannelBound',...
				'Category', 'Measurement',...
				'ParamSize', [1, 1],...
				'Constant', true,...
				'PhaseDep', false,...
				'SpecDep', false);
			obj.addParameter(pc, 'UpperChannelBound',...
				'Category', 'Measurement',...
				'ParamSize', [1, 1],...
				'Constant', true,...
				'PhaseDep', false,...
				'SpecDep', false);
            obj.addParameter(pc, 'EnergyCalibParams',...
				'Category', 'Measurement',...
				'ParamSize', [3, 1],...
				'Constant', true,...
				'PhaseDep', false,...
				'SpecDep', false);
            obj.addParameter(pc, 'Diffractometer',...
				'Category', 'Measurement',...
				'ParamSize', [1, 1],...
				'Constant', true,...
				'PhaseDep', false,...
				'SpecDep', false);
			obj.addParameter(pc, 'FluorChannelPositions',...
				'Category', 'Measurement',...
				'ParamSize', [NaN, 2],...
				'Constant', true,...
				'PhaseDep', false,...
				'SpecDep', false,...
				'Value',[1707.4629		13.9441;...
                        2173.09397		17.7502;...
                        3224.01832		26.3446;...
                        3747.05905		30.625;...
                        3789.73661		30.973;...
                        4277.17749		34.987;...
                        6504.92434		53.1622;...
                        7285.79411		59.5409;...
                        9914.71741		80.9979]);
            obj.addParameter(pc, 'FluorChannelPositionsAm',...
				'Category', 'Measurement',...
				'ParamSize', [NaN, 2],...
				'Constant', true,...
				'PhaseDep', false,...
				'SpecDep', false,...
				'Value',[1699.92824     13.9441;...
                        2164.26401     17.7502;...
                        3211.53762     26.3446;...
                        7261.85036     59.5409]);
			obj.addParameter(pc, 'FluorChannelPositionsBa',...
				'Category', 'Measurement',...
				'ParamSize', [NaN, 2],...
				'Constant', true,...
				'PhaseDep', false,...
				'SpecDep', false,...
				'Value',[3732.29126     30.625;...
                        3774.49869     30.973;...
                        4261.27874     34.987;...
                        6481.32306     53.1622;...
                        9881.43572     80.9779]);                    



%% 2014
%	Referenz DT = 4.61111 %
% 				'Value',[1185.2878	9.672;...
% 						1189.19764	9.7133;...
% 						1219.48267	9.961;...
% 						1707.84862	13.9441;...
% 						2172.65724	17.7502;...
% 						3222.72144	26.3446;...
% 						3745.12434	30.625;...
% 						3787.74227	30.973;...
% % 						4275.48729  34.987;...
% % 						6500.68849  53.1622;...
% 						7283.03399	59.5409;...
% 						9908.85656	80.9979]);

%	Referenz DT = 4.06833 %
% 				'Value',[719.65219	5.88765;...
% 						1704.9247	13.9441;...
% 						2170.38722	17.7502;...
% 						3220.52571	26.3446;...
% % 						3349.64769  27.448;...
% 						3743.46036	30.625;...
% 						3786.10079	30.973;...
% % 						3867.78655  31.694;...
% 						4273.64958  34.987;...
% % 						5471.63222  44.822;...
% % 						6416.46202  52.559;...
% 						6498.9386   53.1622;...
% 						7280.00849	59.5409;...
% 						9906.68131	80.9979]);...

%	Referenz DT = 4.61111 % alt
% 				'Value',[1183.5149	9.672;...
% 						%1188.12453	9.7133;...	% Au-tth11,phi=0
% % 						1187.42474	9.7133;...
% 						1217.70977	9.961;...
% 						1706.07572	13.9441;...
% 						2170.88433	17.7502;...
% 						3220.94854	26.3446;...
% % 						3357.30742  27.470;...
% 						3743.35144	30.625;...
% 						3785.96937	30.973;...
% 						4273.71439  34.987;...
% % 						5482.8698   44.859;...
% % 						6430.20883  52.601;...
% 						6497.91986  53.1622;...
% 						7281.26109	59.5409;...
% 						9907.08366	80.9979]);
%% 2015
%	Referenz DT = 4.44 % ROI 16286
% 				'Value',[1706.35071498677	13.9441;...
% 						2171.60538402772	17.7502;...
% 						3221.1561461408		26.3446;...
% 						3743.73520210225	30.625;...
% 						3786.0888562853		30.973;...
% 						4272.90331797975  	34.987;...
% 						6497.63120687351  	53.1622;...
% 						7277.41958084649	59.5409;...
% 						9902.60889751722	80.9979]);
%	Referenz DT = 4.85333 % ROI 16384
% 				'Value',[1699.283267	13.9441;...
% 						2164.43137		17.7502;...
% 						3214.39654		26.3446;...
% 						3736.99061		30.625;...
% 						3779.33291		30.973;...
% 						4266.53274  	34.987;...
% 						6491.52216  	53.1622;...
% 						7272.70683		59.5409;...
% 						9897.88877		80.9979]);
%	Referenz DT = 4.85333 % ROI 16286
% 				'Value',[1705.58686	13.9441;...
% 						2170.73497		17.7502;...
% 						3220.70014		26.3446;...
% 						3743.29421		30.625;...
% 						3785.63651		30.973;...
% 						4272.83634  	34.987;...
% 						6497.85276  	53.1622;...
% 						7279.01043		59.5409;...
% 						9904.19237		80.9979]);

%   Referenz DT = 3.69666667
% 				'Value',[1707.4629		13.9441;...
%                         2173.09397		17.7502;...
%                         3224.01832		26.3446;...
%                         3747.05905		30.625;...
%                         3789.73661		30.973;...
%                         4277.17749		34.987;...
%                         6504.92434		53.1622;...
%                         7285.79411		59.5409;...
%                         9914.71741		80.9979]);
%% Original
% 				'Value',[1178.17126	9.672;...
% 						1211.80156	9.961;...
% 						1699.49913	13.9441;...
% 						2163.45945	17.7502;...
% 						3211.95046	26.3446;...
% % 						3349.64769  27.448;...
% 						3734.15596	30.625;...
% 						3776.22149	30.973;...
% % 						3867.78655  31.694;...
% 						4262.32879  34.987;...
% % 						5471.63222  44.822;...
% % 						6416.46202  52.559;...
% 						6484.17256  53.1622;...
% 						7264.47638	59.5409;...
% 						9885.76562	80.9979]);...
		end		
	end
	
	methods (Access = protected)
		
		function obj = initSubFunctions(obj)
		end
	end	
end



% classdef ChannelToEnergy < rietveld.base.RVFunction
% 	
% 	methods (Access = public)
% 		
% 		function X = execute(obj, ~, ~, meas, ~, spec)
% 			
% % 			p = [1.2607E-5;-9.86572E-4;0.03325;-0.64581;2.80773];
% 				
% % 			deltaChannel = polyval(p, spec.DeadTime);
% 			
% 			%alte ExpDec1 mit weniger Daten bei kleinen DT
% % 			if spec.DeadTime >= 0.5			
% 				deltaChannel = 6.34603 .* exp(-spec.DeadTime./7.44829) - 2.91412;
% 			
% % 			elseif spec.DeadTime < 0.5
% % 				deltaChannel = (4.63141200871134 .* exp(-spec.DeadTime./1.3738065508359) - 0.194275551609041);
% % 			end
% % 			disp(deltaChannel)
% 			ChannelCorr = meas.FluorChannelPositions(:,1) + deltaChannel;
% 
% 			CalibrationFunction = polyfit(ChannelCorr, meas.FluorChannelPositions(:,2), 2);
% % 			disp(polyfit(ChannelCorr, meas.FluorChannelPositions(:,2), 2))
% 			
% % 			CalibrationFunction = [-0.00000000325887;0.00821983;-0.0394427];
% 				
% 			Channel = meas.LowerChannelBound:meas.UpperChannelBound;
% 			X = polyval(CalibrationFunction, Channel);
% 		end
% 		
% 		function obj = addFunctionParameters(obj, pc)
% 			
% 			obj.addParameter(pc, 'DeadTime',...
% 				'Category', 'Measurement',...
% 				'ParamSize', [1, 1],...
% 				'Constant', true,...
% 				'PhaseDep', false,...
% 				'SpecDep', true);
% 			obj.addParameter(pc, 'LowerChannelBound',...
% 				'Category', 'Measurement',...
% 				'ParamSize', [1, 1],...
% 				'Constant', true,...
% 				'PhaseDep', false,...
% 				'SpecDep', false);
% 			obj.addParameter(pc, 'UpperChannelBound',...
% 				'Category', 'Measurement',...
% 				'ParamSize', [1, 1],...
% 				'Constant', true,...
% 				'PhaseDep', false,...
% 				'SpecDep', false);
% 			obj.addParameter(pc, 'FluorChannelPositions',...
% 				'Category', 'Measurement',...
% 				'ParamSize', [NaN, 2],...
% 				'Constant', true,...
% 				'PhaseDep', false,...
% 				'SpecDep', false,...
% 				'Value',[1178.17126	9.672;...
% 						1211.80156	9.961;...
% 						1699.49913	13.9441;...
% 						2163.45945	17.7502;...
% 						3211.95046	26.3446;...
% 						3734.15596	30.625;...
% 						3776.22149	30.973;...
% 						7264.47638	59.5409;...
% 						9885.76562	80.9979]);...
% % 						3349.64769150995 27.448;...
% % 						3867.78655594550 31.694;...
% % 						5471.63222789036 44.822;...
% % 						6416.46202498772 52.559]);
% 		end		
% 	end
% 	
% 	methods (Access = protected)
% 		
% 		function obj = initSubFunctions(obj)
% 		end
% 	end	
% end
