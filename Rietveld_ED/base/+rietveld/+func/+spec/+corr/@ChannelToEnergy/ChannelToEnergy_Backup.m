classdef ChannelToEnergy < rietveld.base.RVFunction
	
	methods (Access = public)
		
		function X = execute(obj, ~, ~, meas, ~, spec)
			
% 			p = [1.2607E-5;-9.86572E-4;0.03325;-0.64581;2.80773];
				
% 			deltaChannel = polyval(p, spec.DeadTime);
			
			%alte ExpDec1 mit weniger Daten bei kleinen DT
% 			if spec.DeadTime >= 0.5			
				deltaChannel = 6.34603 .* exp(-spec.DeadTime./7.44829) - 2.91412;
			
% 			elseif spec.DeadTime < 0.5
% 				deltaChannel = (4.63141200871134 .* exp(-spec.DeadTime./1.3738065508359) - 0.194275551609041);
% 			end
% 			disp(deltaChannel)
			ChannelCorr = meas.FluorChannelPositions(:,1) + deltaChannel;

			CalibrationFunction = polyfit(ChannelCorr, meas.FluorChannelPositions(:,2), 2);
% 			disp(polyfit(ChannelCorr, meas.FluorChannelPositions(:,2), 2))
			
% 			CalibrationFunction = [-0.00000000325887;0.00821983;-0.0394427];
				
			Channel = meas.LowerChannelBound:meas.UpperChannelBound;
			X = polyval(CalibrationFunction, Channel);
		end
		
		function obj = addFunctionParameters(obj, pc)
			
			obj.addParameter(pc, 'DeadTime',...
				'Category', 'Measurement',...
				'ParamSize', [1, 1],...
				'Constant', true,...
				'PhaseDep', false,...
				'SpecDep', true);
			obj.addParameter(pc, 'LowerChannelBound',...
				'Category', 'Measurement',...
				'ParamSize', [1, 1],...
				'Constant', true,...
				'PhaseDep', false,...
				'SpecDep', false);
			obj.addParameter(pc, 'UpperChannelBound',...
				'Category', 'Measurement',...
				'ParamSize', [1, 1],...
				'Constant', true,...
				'PhaseDep', false,...
				'SpecDep', false);
			obj.addParameter(pc, 'FluorChannelPositions',...
				'Category', 'Measurement',...
				'ParamSize', [NaN, 2],...
				'Constant', true,...
				'PhaseDep', false,...
				'SpecDep', false,...
				'Value',[1178.17126	9.672;...
						1211.80156	9.961;...
						1699.49913	13.9441;...
						2163.45945	17.7502;...
						3211.95046	26.3446;...
						3734.15596	30.625;...
						3776.22149	30.973;...
						7264.47638	59.5409;...
						9885.76562	80.9979]);...
% 						3349.64769150995 27.448;...
% 						3867.78655594550 31.694;...
% 						5471.63222789036 44.822;...
% 						6416.46202498772 52.559]);
		end		
	end
	
	methods (Access = protected)
		
		function obj = initSubFunctions(obj)
		end
	end	
end
