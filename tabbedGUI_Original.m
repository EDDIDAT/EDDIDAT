%% Main GUI
function tabbedGUI()
% h.myfig = figure('Name','EDDIDAT','ToolBar','none','NumberTitle','off','Tag','MainGUI','Position', [25 50 1250 550]);
h.myfig = figure('Name','EDDIDAT','MenuBar','none','ToolBar','none','NumberTitle','off','Tag','MainGUI','Position', [25 50 1250 550]);
% assignin('base', 'mydata', h.myfig);
% set (gcf, 'units', 'normalized', 'outerposition', [0.1 0.1 .759 .795]);
set (gcf, 'units', 'normalized', 'outerposition', [0.1 0.1 .759 .78]);
% set (gcf, 'WindowButtonMotionFcn', @mouseMove);
% set (gcf, 'units', 'normalized', 'outerposition', [0 0 1 1]);
% MaximizeFigureWindow
s = warning('off', 'MATLAB:uitabgroup:OldVersion');
h.TabGroup = uitabgroup('Parent',h.myfig,'units', 'normalized');
warning(s);
h.Tabs(1) = uitab('Parent',h.TabGroup, 'Title','Fitting');
h.Tabs(2) = uitab('Parent',h.TabGroup, 'Title','Stress Analysis');
h.Tabs(3) = uitab('Parent',h.TabGroup, 'Title','Universal Plot');
h.Tabs(4) = uitab('Parent',h.TabGroup, 'Title','Plot Fit Data');
h.Tabs(5) = uitab('Parent',h.TabGroup, 'Title','Qualitative Phase Analysis');
% h.Tabs(6) = uitab('Parent',h.TabGroup, 'Title','Rietveld Analysis');
% Load mpd files from directory
Files = dir(fullfile('Data','Materials','*.mpd'));
% Load MPD file list
MPDFileNameList = cell(size(Files,1),1);
for i=1:size(Files,1)
[~,MPDFileNameList{i},~] = fileparts(Files(i).name);
end
MPDFileNameList = MPDFileNameList';
h.MPDFileNameList = MPDFileNameList;

% Load calibration files from directory
CalibFiles = dir(fullfile('Data','Calibration','*.mat'));
% Load MPD file list
CalibrationFileList = cell(size(CalibFiles,1),1);
for i=1:size(CalibFiles,1)
[~,CalibrationFileList{i},~] = fileparts(CalibFiles(i).name);
end
CalibFileNameList = CalibrationFileList';
h.CalibFileNameList = CalibFileNameList;

% Load diffractometer files from directory
DiffractometerFiles = dir(fullfile('Data','Diffractometers','*.dif'));
% Load diffractometer file list
DiffractometerFileList = cell(size(DiffractometerFiles,1),1);
for i=1:size(DiffractometerFiles,1)
[~,DiffractometerFileList{i},~] = fileparts(DiffractometerFiles(i).name);
end
DiffractometerFileList = DiffractometerFileList';
h.DiffractometerFileList = DiffractometerFileList;

% Path of the fluorescence line file
fid = fopen(fullfile('Data','Materials','Fluorescence_Lines.dat'));
% Read file, column names are as follows
% No.;Element;Ka1;Ka2;Kb1;La1;La2;Lb1;Lb2;Lg1
h.FluorCellArray = textscan(fid,'%d %s %f %f %f %f %f %f %f %f',...
'headerlines',1, 'delimiter','\t');
% assignin('base','FluorCellArray',h.FluorCellArray)
% String vector with element names
h.ElementsString = h.FluorCellArray{1,2}(:,1);

h.Colors = 0;
% h.P = 0;
h.T = 0;
h.Sample = 0;
h.Measurement = 0;
% h.MeasurementBackup = 0;
h.Substrate = 0;
h.Diffractometer = 0;
h.DataTmp = 0;
h.P.MeasurementMode = 0;
h.P.SampleThickness = 0;
h.P.PopupValueMpd1 = 0;
h.P.PopupValueMpd2 = 0;
h.P.PopupValueMpd3 = 0;
h.P.PopupValueMpd4 = 0;
h.P.PopupValueMpd5 = 0;
h.P.PopupValueMpd6 = 0;
h.P.PopupValueFitFunc = 2;
% h.axesplot = 0;
% h.Plots = 0;
set(h.TabGroup,'SelectedTab',h.Tabs(1));
% Clear appdata
appdata = get(0,'ApplicationData');
fns = fieldnames(appdata);
for ii = 1:numel(fns)
    rmappdata(0,fns{ii});
end
% appdata = get(0,'ApplicationData') %make sure it's gone

%% fit data
%% Create sample panel
h.creatsamplepanel = uipanel( ...
'Parent', h.Tabs(1), ...
'Units', 'Normalized', ...
'Position', [0.0025 0.875 0.175 0.125], ...
'Title', '1. Create Sample' ...
);
% Create graphic objects in "Create Sample" Panel
% Text for information
h.textelement1 = uicontrol( ...
'Parent', h.creatsamplepanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.025 0.625 0.45 0.25], ...
'HorizontalAlignment', 'left', ...
'String', 'Enter elemental formula of material (e.g. Au1, Al2O3).' ...
);
% Edit field for entering elemental formula of sample
h.editfieldelement1 = uicontrol( ...
'Parent', h.creatsamplepanel, ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.025 0.45 0.4 0.2], ...
'String', 'Enter elemental formula', ...
'Tag', 'editfieldelement1', ...
'Enable', 'inactive', ...
'ButtonDownFcn', {@clearbuttondown} ...
);
% Text for information
h.textmpd1 = uicontrol( ...
'Parent', h.creatsamplepanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.025 0.225 0.45 0.125], ...
'HorizontalAlignment', 'left', ...
'String', 'Select mpd file' ...
);
% Popup menu to choose mpd file
h.popupmenumpd1 = uicontrol( ...
'Parent', h.creatsamplepanel, ...
'Style', 'popupmenu', ...
'Units', 'Normalized', ...
'Position', [0.025 0.1 0.325 0.2], ...
'Tag', 'popupmenumpd1', ...
'String', MPDFileNameList, ...
'Value', 1, ...
'Callback', {@popupmenuCallback1} ...
);
% Alignement of graphic objects
align([h.textelement1 h.editfieldelement1 h.textmpd1 h.popupmenumpd1],'left','fixed',2);

% Choose whether if substrate peaks should be plotted or not
h.checkboxsubstrate1 = uicontrol( ...
'Parent', h.creatsamplepanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.45 0.75 0.6 0.125], ...
'Tag', 'checkboxsubstrate1', ...
'String', 'Show peaks from 2nd phase', ...
'Visible', 'on', ...
'Value', 0 ...
);
% Edit field for entering elemental formula of substrate
h.editfieldelement2 = uicontrol( ...
'Parent', h.creatsamplepanel, ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.45 0.46 0.4 0.205], ...
'Tag', 'editfieldelement2', ...
'String', 'Enter elemental formula', ...
'Enable','inactive', ...
'Visible', 'on', ...
'ButtonDownFcn', {@clearbuttondown} ...
);
% Text for information
h.textmpd2 = uicontrol( ...
'Parent', h.creatsamplepanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.45 0.3225 0.45 0.125], ...
'HorizontalAlignment', 'left', ...
'Visible', 'on', ...
'String', 'Select mpd file' ...
);
% Popup menu to choose mpd file
h.popupmenumpd2 = uicontrol( ...
'Parent', h.creatsamplepanel, ...
'Style', 'popupmenu', ...
'Units', 'Normalized', ...
'Position', [0.45 0.1 0.325 0.2], ...
'Tag', 'popupmenumpd2', ...
'String', MPDFileNameList, ...
'Value', 1, ...
'Visible', 'on', ...
'Callback', {@popupmenuCallback2} ...
);
align([ h.editfieldelement2 h.textmpd2 h.popupmenumpd2],'left','fixed',2);

% Button for execution of create sample script
h.okbutton1 = uicontrol( ...
'Parent', h.creatsamplepanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.823 0.095 0.15 0.22], ...
'Tag', 'editfieldelement1', ...
'String', 'Ok', ...
'Tag', 'Okbutton1', ...
'Callback', {@okbuttoncreatesample} ...
);

%% Specfile conversion panel
h.loadmeasurementpanel = uipanel( ...
'Parent', h.Tabs(1), ...
'Units', 'Normalized', ...
'Position', [0.0025 0.795 0.175 0.08], ...
'Title', '2. Load measurement File' ...
);
% Create graphic objects in "Specfile conversion" Panel
% Edit field that shows the current measurement file
h.selectfilename = uicontrol( ...
'Parent', h.loadmeasurementpanel, ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.025 0.575 0.6 0.35], ...
'Tag', 'selectfilename', ...
'Enable', 'on', ...
'String', 'Select measurement file...' ...
);
% Open button in order to load the measurement file
h.openbutton1 = uicontrol( ...
'Parent', h.loadmeasurementpanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.65 0.575 0.15 0.36], ...
'String', 'Open', ...
'Tag', 'Loadbutton1', ...
'Callback', {@OpenFileCallback} ...
);
h.popupmenudiff = uicontrol( ...
'Parent', h.loadmeasurementpanel, ...
'Style', 'popupmenu', ...
'Units', 'Normalized', ...
'Position', [0.025 0.355 0.2875 0.12], ...
'Tag', 'popupmenudiff', ...
'String', DiffractometerFileList, ...
'String', {'Select Diffractometer', 'EDDI', 'LEDDI', 'LIMAX-160', 'LIMAX-70'}, ...
'Value', 2, ...
'Callback', {@popupmenuCallback3} ...
);

% 'String', DiffractometerFileList, ...
% 'Value', 1, ...
% 'Callback', {@popupmenuCallback3} ...
% );

% 'String', {'Select Diffractometer', 'EDDI', 'LEDDI', 'LIMAX-160', 'LIMAX-70'}, ...
% 'Value', 2, ...
% 'Callback', {@popupmenuCallback3} ...
% );

h.popupmenuscanmode = uicontrol( ...
'Parent', h.loadmeasurementpanel, ...
'Style', 'popupmenu', ...
'Units', 'Normalized', ...
'Position', [0.3375 0.355 0.2875 0.12], ...
'Tag', 'popupmenuscanmode', ...
'String', {'Select scan mode', 'mcaacq', 'a/d-scan'}, ...
'Value', 2, ...
'Callback', {@popupmenuCallback4} ...
);

h.popupmenuDTCorr = uicontrol( ...
'Parent', h.loadmeasurementpanel, ...
'Style', 'popupmenu', ...
'Units', 'Normalized', ...
'Position', [0.65 0.355 0.3175 0.12], ...
'Tag', 'popupmenuDTCorr', ...
'String', CalibFileNameList, ...
'Value', size(CalibFileNameList,2) - 1, ...
'Callback', {@popupmenuCallback5} ...
);


% Button for execution of create sample script
h.okbutton1 = uicontrol( ...
'Parent', h.loadmeasurementpanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.825 0.575 0.15 0.36], ...
'String', 'Ok', ...
'Tag', 'Okbutton1', ...
'Callback', {@okbuttonloadmeasurement} ...
);
%% Corrections panel
h.correctionspanel = uipanel( ...
'Parent', h.Tabs(1), ...
'Units', 'Normalized', ...
'Position', [0.0025 0.695 0.175 0.1], ...
'Title', '3. Corrections' ...
);
h.textcorr1 = uicontrol( ...
'Parent', h.correctionspanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.025 0.835 0.6 0.15], ...
'HorizontalAlignment', 'left', ...
'String', 'Select corrections to be performed' ...
);
h.checkboxcorrections1 = uicontrol( ...
'Parent', h.correctionspanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.025 0.615 0.35 0.15], ...
'Tag', 'checkboxcorrections1', ...
'String', 'Tube Spectrum', ...
'Value', 0 ...
);
h.checkboxcorrections2 = uicontrol( ...
'Parent', h.correctionspanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.4 0.615 0.35 0.15], ...
'Tag', 'checkboxcorrections2', ...
'String', 'Absorption', ...
'Value', 1 ...
);
h.checkboxcorrections3 = uicontrol( ...
'Parent', h.correctionspanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.675 0.615 0.35 0.15], ...
'Tag', 'checkboxcorrections3', ...
'String', 'RingCurrent', ...
'Value', 0 ...
);
h.textcorr2 = uicontrol( ...
'Parent', h.correctionspanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.025 0.425 0.4 0.125], ...
'HorizontalAlignment', 'left', ...
'String', 'Select measurement mode' ...
);
h.popupmenumeasmode = uicontrol( ...
'Parent', h.correctionspanel, ...
'Style', 'popupmenu', ...
'Units', 'Normalized', ...
'Position', [0.025 0.255 0.35 0.1], ...
'Tag', 'popupmenumeasmode', ...
'String', {'Select measurement mode', 'Reflection', 'Transmission', 'LEDDI Mode-I', 'LEDDI Mode-II', 'LEDDI Horizontal', 'LEDDI Vertical'}, ...
'Value', 2, ...
'Callback', {@popupmenuCallback6} ...
);
h.samplethickness = uicontrol( ...
'Parent', h.correctionspanel, ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.4 0.103 0.4 0.25], ...
'ForegroundColor', [0.4 0.4 0.4], ...
'Tag', 'samplethickness', ...
'String', 'Sample thickness [mm]', ...
'Enable', 'off' ...
);
h.checkboxcorrectionsExportData = uicontrol( ...
'Parent', h.correctionspanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.56 0.845 0.5 0.15], ...
'Tag', 'checkboxcorrectionsExportData', ...
'String', 'Export corrected spectra', ...
'Value', 0 ...
);
% Button for execution of corrections script
h.okbutton1 = uicontrol( ...
'Parent', h.correctionspanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.825 0.1 0.15 0.275], ...
'String', 'Ok', ...
'Tag', 'Okbutton1', ...
'Callback', {@okbuttoncorrections} ...
);
%% Plot data panel
h.plotpanel = uipanel( ...
'Parent', h.Tabs(1), ...
'Units', 'Normalized', ...
'Position', [0.1825 0.3 0.636 0.7], ...
'Title', 'Plot Window' ...
);

% Slider erzeugen
h.Slider = uicontrol(...
'Style','slider',...
'Tag','Slider',...
'Parent', h.plotpanel,...
'Units','normalized',...
'Position', [0.46 0.015 0.1 0.025],...
'Min',0,...
'Max', 1,...
'Value',1,...
'Callback',{@SliderCallbackPlotRawData});

% empty data for plot    
x = 0;
y = 0;
% Create plot
h.axesplotRawData = axes('Parent', h.plotpanel, 'Position', [0.06 0.1125 0.9 0.85]);
h.plotdata = plot(h.axesplotRawData, x,y); hold on;
h.plotEtheo = line(h.axesplotRawData,x,y,'LineStyle',':','LineWidth',1.5);
h.plotEtheoAdd1 = line(h.axesplotRawData,x,y,'LineStyle',':','LineWidth',1.5);
h.plotEtheoAdd2 = line(h.axesplotRawData,x,y,'LineStyle',':','LineWidth',1.5);
h.plotEtheoAdd3 = line(h.axesplotRawData,x,y,'LineStyle',':','LineWidth',1.5);
h.plotEtheoAdd4 = line(h.axesplotRawData,x,y,'LineStyle',':','LineWidth',1.5);
h.plotEtheoAdd5 = line(h.axesplotRawData,x,y,'LineStyle',':','LineWidth',1.5);
h.plotEtheoSub = line(h.axesplotRawData,x,y,'LineStyle',':','LineWidth',1.5);
h.plotFluorAdd1 = line(h.axesplotRawData,x,y,'LineStyle',':','LineWidth',1.5);

h.axesplotRawData.XLim = [0,100];
h.axesplotRawData.YLim = [0,1];
grid on
set(h.plotdata, 'Color', 'blue');
set(h.plotEtheo, 'Color', 'red');
set(h.plotEtheoAdd1, 'Color', 'green');
set(h.plotEtheoAdd2, 'Color', 'blue');
set(h.plotEtheoAdd3, 'Color', 'cyan');
set(h.plotEtheoAdd4, 'Color', 'magenta');
set(h.plotEtheoAdd5, 'Color', 'yellow');
set(h.plotEtheoSub, 'Color', [0.5 0.5 0.5]);
set(h.plotFluorAdd1, 'Color', 'cyan');

xlabel('Energy [keV]');
ylabel('Intensity [cts]');
title('No measurement data loaded')

% Add axes object in order to show zoom of plot window
h.axesplotRawDataZoom = axes('Parent', h.plotpanel, 'Position', [0.525 0.525 0.4 0.35], 'Box', 'on');
h.plotdataZoom = plot(h.axesplotRawDataZoom, x,y); hold on;
h.plotdataZoomCH = plot(h.axesplotRawDataZoom, x,y, 'Marker', 'o', 'MarkerSize', 10, 'MarkerEdgeColor', 'r', 'MarkerFaceColor', 'r');
set(h.plotdataZoomCH, 'Visible', 'off');
set(h.plotdataZoom, 'Visible', 'off');
set(h.plotdataZoom, 'Color', 'blue');
% h.axesplotRawDataZoom.XTickLabel = [];
% h.axesplotRawDataZoom.YTickLabel = [];
h.axesplotRawDataZoom.XGrid = 'on';
h.axesplotRawDataZoom.YGrid = 'on';
set(h.axesplotRawDataZoom,'Visible','off')

% Choose whether if sample/substrate peaks should be plotted or not
h.checkboxtheopeaks1 = uicontrol( ...
'Parent', h.plotpanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.0125 0.0425 0.2 0.03], ...
'Tag', 'checkboxtheopeaks1', ...
'String', 'Show sample peak positions', ...
'Value', 1, ...
'Visible', 'off', ...
'Callback', {@ShowHidePeaksCallback} ...
);
% Shift theoretical peak positions
h.checkboxshifttheopeaks1 = uicontrol( ...
'Parent', h.plotpanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.165 0.0425 0.2 0.03], ...
'Tag', 'checkboxtheopeaks2', ...
'String', 'Shift theo. E-Pos', ...
'Value', 0, ...
'Visible', 'off', ...
'Callback', {@ShiftEtheoCallback} ...
);
h.editshiftEtheo1 = uicontrol( ...
'Parent', h.plotpanel, ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.25 0.0425 0.04 0.03], ...
'Tag', 'editshiftEtheo1', ...
'Enable', 'off', ...
'Visible', 'off', ...
'String', 'delta E' ...
);
h.plusbuttonshiftEtheo1 = uicontrol( ...
'Parent', h.plotpanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.293 0.043 0.02 0.03], ...
'String', '+', ...
'Visible', 'off', ...
'Tag', 'okbuttonshiftEtheo1', ...
'Callback', {@plusbuttonshiftEtheo1} ...
);
h.minusbuttonshiftEtheo1 = uicontrol( ...
'Parent', h.plotpanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.315 0.043 0.02 0.03], ...
'String', '-', ...
'Visible', 'off', ...
'Tag', 'okbuttonshiftEtheo1', ...
'Callback', {@minusbuttonshiftEtheo1} ...
);
% Show substrate peak positions
h.checkboxtheopeaks2 = uicontrol( ...
'Parent', h.plotpanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.0125 0.0125 0.2 0.03], ...
'Tag', 'checkboxtheopeaks2', ...
'String', 'Show 2nd phase peak positions', ...
'Value', 1, ...
'Visible', 'off', ...
'Callback', {@ShowHideSubPeaksCallback} ...
);
% Shift theoretical peak positions
h.checkboxshifttheopeaks2 = uicontrol( ...
'Parent', h.plotpanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.165 0.0125 0.2 0.03], ...
'Tag', 'checkboxtheopeaks2', ...
'String', 'Shift theo. E-Pos', ...
'Value', 0, ...
'Visible', 'off', ...
'Callback', {@ShiftEtheosubCallback} ...
);
h.editshiftEtheo2 = uicontrol( ...
'Parent', h.plotpanel, ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.25 0.0125 0.04 0.03], ...
'Tag', 'editshiftEtheo2', ...
'Enable', 'off', ...
'Visible', 'off', ...
'String', 'delta E' ...
);
h.plusbuttonshiftEtheo2 = uicontrol( ...
'Parent', h.plotpanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.293 0.013 0.02 0.03], ...
'String', '+', ...
'Visible', 'off', ...
'Tag', 'okbuttonshiftEtheo2', ...
'Callback', {@plusbuttonshiftEtheosub2} ...
);
h.minusbuttonshiftEtheo2 = uicontrol( ...
'Parent', h.plotpanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.315 0.013 0.02 0.03], ...
'String', '-', ...
'Visible', 'off', ...
'Tag', 'okbuttonshiftEtheo2', ...
'Callback', {@minusbuttonshiftEtheosub2} ...
);

% Choose if all spectra should be plotted
h.checkboxplotall = uicontrol( ...
'Parent', h.plotpanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.875 0.02 0.2 0.03], ...
'Tag', 'checkboxplotall', ...
'String', 'Plot all spectra', ...
'Value', 0, ...
'Visible', 'on', ...
'Callback', {@PlotAllCallback} ...
);

% Button to exchange spectra
h.buttonexchangespectra = uicontrol( ...
'Parent', h.plotpanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.7875 0.02 0.1 0.03], ...
'String', 'Exchange spectra', ...
'Visible', 'on', ...
'Tag', 'buttonexchangespectra', ...
'Visible', 'off', ...
'Callback', {@buttonexchangespectra} ...
);

%% Select Measurements panel
h.selectmeasurementpanel = uipanel( ...
'Parent', h.Tabs(1), ...
'Units', 'Normalized', ...
'Position', [0.0025 0.547 0.175 0.146], ...
'Title', '4. Select Measurements' ...
);

h.textselectmeas1 = uicontrol( ...
'Parent', h.selectmeasurementpanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.025 0.8 0.5 0.125], ...
'HorizontalAlignment', 'left', ...
'String', 'Choose detector (LEDDI only)' ...
);
h.popupmenuselectmeas1 = uicontrol( ...
'Parent', h.selectmeasurementpanel, ...
'Style', 'popupmenu', ...
'Units', 'Normalized', ...
'Position', [0.525 0.835 0.385 0.13], ...
'Tag', 'popupmenuselectmeas1', ...
'String', {'Select detector', 'Detector 1', 'Detector 2'}, ...
'Enable', 'off', ...
'Value', 2, ...
'Callback', {@SelectDetectorCallback} ...
);
h.textselectmeas2 = uicontrol( ...
'Parent', h.selectmeasurementpanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.025 0.6 0.4 0.125], ...
'HorizontalAlignment', 'left', ...
'String', 'Total # of scans' ...
);
h.editfieldselectmeas1 = uicontrol( ...
'Parent', h.selectmeasurementpanel, ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.29 0.585 0.1 0.175], ...
'Tag', 'editfieldselectmeas1', ...
'String', '', ...
'Enable', 'inactive' ...
);
h.textselectmeas3 = uicontrol( ...
'Parent', h.selectmeasurementpanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.41 0.6 0.4 0.125], ...
'HorizontalAlignment', 'left', ...
'String', 'Select scan #' ...
);
h.editfieldselectmeas2 = uicontrol( ...
'Parent', h.selectmeasurementpanel, ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.635 0.585 0.1 0.175], ...
'Tag', 'editfieldselectmeas2', ...
'String', '', ...
'ButtonDownFcn', {@clearbuttondown}, ...
'Enable', 'inactive' ...
);
h.textselectmeas4 = uicontrol( ...
'Parent', h.selectmeasurementpanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.76 0.6 0.4 0.125], ...
'HorizontalAlignment', 'left', ...
'String', 'to' ...
);
h.editfieldselectmeas3 = uicontrol( ...
'Parent', h.selectmeasurementpanel, ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.81 0.585 0.1 0.175], ...
'Tag', 'editfieldselectmeas3', ...
'String', '', ...
'ButtonDownFcn', {@clearbuttondown}, ...
'Enable', 'inactive', ...
'Callback', {@popupmenuCallback7} ...
);
h.textselectmeas5 = uicontrol( ...
'Parent', h.selectmeasurementpanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.025 0.035 0.4 0.15], ...
'HorizontalAlignment', 'left', ...
'String', 'Energy range' ...
);
h.editfieldselectmeas4 = uicontrol( ...
'Parent', h.selectmeasurementpanel, ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.264 0.05 0.125 0.175], ...
'Tag', 'editfieldselectmeas4', ...
'String', 'Emin', ...
'ButtonDownFcn', {@clearbuttondown}, ...
'Enable', 'inactive' ...
);
h.textselectmeas6 = uicontrol( ...
'Parent', h.selectmeasurementpanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.41 0.035 0.4 0.15], ...
'HorizontalAlignment', 'left', ...
'String', 'to' ...
);
h.editfieldselectmeas5 = uicontrol( ...
'Parent', h.selectmeasurementpanel, ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.465 0.05 0.125 0.175], ...
'Tag', 'editfieldselectmeas5', ...
'String', 'Emax', ...
'ButtonDownFcn', {@clearbuttondown}, ...
'Enable', 'inactive' ...
);

h.checkboxselectmeas1 = uicontrol( ...
'Parent', h.selectmeasurementpanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.035 0.45 0.05 0.1], ...
'Tag', 'checkboxselectmeas1', ...
'Value', 0 ...
);
h.textselectmeas7 = uicontrol( ...
'Parent', h.selectmeasurementpanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.1 0.4 0.9 0.15], ...
'HorizontalAlignment', 'left', ...
'String', 'Integrate spectra - Select number of spectra to integrate' ...
);

h.textselectmeas8 = uicontrol( ...
'Parent', h.selectmeasurementpanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.025 0.275 0.4 0.125], ...
'HorizontalAlignment', 'left', ...
'String', '# Spectra to integrate' ...
);
h.editfieldselectmeas6 = uicontrol( ...
'Parent', h.selectmeasurementpanel, ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.365 0.25 0.1 0.175], ...
'Tag', 'editfieldselectmeas6', ...
'String', '', ...
'ButtonDownFcn', {@clearbuttondown}, ...
'Enable', 'inactive' ...
);
h.textselectmeas9 = uicontrol( ...
'Parent', h.selectmeasurementpanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.55 0.275 0.4 0.125], ...
'HorizontalAlignment', 'left', ...
'String', 'Discard remaining spectra' ...
);

h.checkboxselectmeas2 = uicontrol( ...
'Parent', h.selectmeasurementpanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.49 0.29 0.05 0.1], ...
'Tag', 'checkboxselectmeas2', ...
'Value', 0 ...
);

h.okbuttonselectmeas1 = uicontrol( ...
'Parent', h.selectmeasurementpanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.825 0.05 0.15 0.18], ...
'String', 'Ok', ...
'Tag', 'Okbuttonselectmeas1', ...
'Callback', {@okbuttonselectmeas} ...
);
h.undobuttonselectmeas1 = uicontrol( ...
'Parent', h.selectmeasurementpanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.655 0.05 0.15 0.18], ...
'String', 'Undo', ...
'Tag', 'Undobuttonselectmeas1', ...
'Callback', {@undobuttonselectmeas} ...
);

%% Background correction
h.backgroundpanel = uipanel( ...
'Parent', h.Tabs(1), ...
'Units', 'Normalized', ...
'Position', [0.0025 0.346 0.175 0.2], ...
'Title', '5. Background Correction' ...
);
% Button for creating background
h.textbkg1 = uicontrol( ...
'Parent', h.backgroundpanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.025 0.9 1 0.075], ...
'HorizontalAlignment', 'left', ...
'String', 'Define and save or load background file.' ...
);
h.buttonselectbkg1 = uicontrol( ...
'Parent', h.backgroundpanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.0125 0.75 0.3 0.13], ...
'String', 'Define Backround', ...
'Tag', 'buttonselectbkg1', ...
'Callback', {@buttonselectbkg1} ...
);
h.buttonselectbkg2 = uicontrol( ...
'Parent', h.backgroundpanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.35 0.75 0.227 0.13], ...
'String', 'Save to File', ...
'Tag', 'buttonselectbkg2', ...
'Callback', {@buttonselectbkg2} ...
);
h.buttonselectbkg3 = uicontrol( ...
'Parent', h.backgroundpanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.55 0.75 0.187 0.13], ...
'String', 'Load File', ...
'Tag', 'buttonselectbkg3', ...
'Callback', {@buttonselectbkg3} ...
);
h.buttonselectbkg7 = uicontrol( ...
'Parent', h.backgroundpanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.775 0.75 0.217 0.13], ...
'String', 'Temp. corr.', ...
'Tag', 'buttonselectbkg7', ...
'Callback', {@BackgroundTempCorr} ...
);
h.buttonselectbkg4 = uicontrol( ...
'Parent', h.backgroundpanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.025 0.031 0.3 0.128], ...
'String', 'Fit Background', ...
'Tag', 'buttonselectbkg4', ...
'Callback', {@buttonselectbkg4} ...
);
h.buttonselectbkg5 = uicontrol( ...
'Parent', h.backgroundpanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.35 0.031 0.225 0.128], ...
'String', 'Accept Fit', ...
'Tag', 'buttonselectbkg5', ...
'Callback', {@buttonselectbkg5} ...
);
h.buttonselectbkg6 = uicontrol( ...
'Parent', h.backgroundpanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.675 0.031 0.225 0.128], ...
'String', 'Decline Fit', ...
'Tag', 'buttonselectbkg6', ...
'Callback', {@buttonselectbkg6} ...
);
h.buttonselectbkg8 = uicontrol( ...
'Parent', h.backgroundpanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [1 0.031 0.15 0.128], ...
'String', 'Undo', ...
'Tag', 'buttonselectbkg8', ...
'Callback', {@buttonselectbkg8} ...
);
align([h.buttonselectbkg1 h.buttonselectbkg2 h.buttonselectbkg3 h.buttonselectbkg7],'Fixed',4,'VerticalAlignment');
align([h.buttonselectbkg4 h.buttonselectbkg5 h.buttonselectbkg6 h.buttonselectbkg8],'Fixed',4,'VerticalAlignment');
h.textbkg2 = uicontrol( ...
'Parent', h.backgroundpanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.025 0.63 1 0.075], ...
'HorizontalAlignment', 'left', ...
'String', 'Table of background data (points Left and Right of peak).' ...
);
d = [zeros(1,6);zeros(1,6)];
h.tablebkgdata = uitable(h.backgroundpanel, ...
'Units', 'Normalized', ...
'Position', [0.025 0.225 0.91 0.39], ...
'Tag', 'tablebkgdata', ...
'data', d, ...
'RowName', {'L';'R'}, ...
'ColumnEditable', true, ...
'CellEditCallback',{@updatetablebkgdata}, ...
'ColumnWidth',{45} ...
);
% Checkbox in order to apply changes to one or to all spectra
h.checkboxBKG = uicontrol( ...
'Parent', h.backgroundpanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.65 0.89 0.35 0.1], ...
'Tag', 'checkboxBKG', ...
'String', 'Use for all spectra', ...
'Value', 0);


%% Fit panel
h.fittingpanel = uipanel( ...
'Parent', h.Tabs(1), ...
'Units', 'Normalized', ...
'Position', [0.0025 0.159 0.175 0.185], ...
'Title', '6. Fitting' ...
);
h.textpeak1 = uicontrol( ...
'Parent', h.fittingpanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.025 0.9 1 0.075], ...
'HorizontalAlignment', 'left', ...
'String', 'Define and save or load peak positions.' ...
);
h.buttonselectpeak1 = uicontrol( ...
'Parent', h.fittingpanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.025 0.725 0.25 0.15], ...
'String', 'Define Peaks', ...
'Tag', 'buttonselectpeak1', ...
'Callback', {@buttonselectpeak1} ...
);
h.buttonselectpeak2 = uicontrol( ...
'Parent', h.fittingpanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.35 0.725 0.25 0.15], ...
'String', 'Save to File', ...
'Tag', 'buttonselectpeak2', ...
'Callback', {@buttonselectpeak2} ...
);
h.buttonselectpeak3 = uicontrol( ...
'Parent', h.fittingpanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.025 0.06 0.2 0.142], ...
'String', 'Fit Peaks', ...
'Tag', 'buttonselectpeak4', ...
'backgroundc',[0.94 .94 .94], ...
'busyaction','cancel', ...
'interrupt','off', ...
'Callback', {@buttonselectpeak3} ...
);    
h.buttonselectpeak4 = uicontrol( ...
'Parent', h.fittingpanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.35 0.06 0.15 0.142], ...
'String', 'Undo', ...
'Tag', 'buttonselectpeak5', ...
'Callback', {@buttonselectpeak4} ...
);
h.checkboxexportfits = uicontrol( ...
'Parent', h.fittingpanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.4 0.025 0.36 0.1], ...
'Tag', 'checkboxexportfits', ...
'String', 'Export fitted spectra', ...
'Value', 1 ...
);
h.textFitFunc = uicontrol( ...
'Parent', h.fittingpanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.55 0.7225 0.3 0.12], ...
'HorizontalAlignment', 'left', ...
'String', 'Fit-Func.' ...
);
h.popupmenuFitFunc = uicontrol( ...
'Parent', h.fittingpanel, ...
'Style', 'popupmenu', ...
'Units', 'Normalized', ...
'Position', [0.7 0.7425 0.28 0.12], ...
'Tag', 'popupmenuFitFunc', ...
'String', {'Select Fit Function', 'Pseudo-Voigt', 'TCH', 'Gauss', 'Lorentz'}, ...
'Value', 2, ...
'Callback', {@popupmenuFitFunc} ...
);
h.checkboxFitBothDetectors = uicontrol( ...
'Parent', h.fittingpanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.4 0.125 0.6 0.1], ...
'Tag', 'checkboxFitBothDetectors', ...
'String', 'Fit data of both detectors (LEDDI)', ...
'Value', 0 ...
);
h.textpeak2 = uicontrol( ...
'Parent', h.fittingpanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.0335 0.575 0.078 0.075], ...
'HorizontalAlignment', 'left', ...
'String', 'Peak' ...
);
h.textpeak3 = uicontrol( ...
'Parent', h.fittingpanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.034 0.47 0.078 0.075], ...
'HorizontalAlignment', 'left', ...
'String', 'keV' ...
);
h.textpeak4 = uicontrol( ...
'Parent', h.fittingpanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.034 0.37 0.078 0.075], ...
'HorizontalAlignment', 'left', ...
'String', 'lb' ...
);
h.textpeak5 = uicontrol( ...
'Parent', h.fittingpanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.034 0.27 0.078 0.075], ...
'HorizontalAlignment', 'left', ...
'String', 'ub' ...
);
% d = zeros(1,6);
d = [zeros(1,6);0.3.*ones(1,6);0.3.*ones(1,6)];
h.tablepeakdata = uitable(h.fittingpanel, ...
'Units', 'Normalized', ...
'Position', [0.02 0.255 0.97 0.42], ...
'Tag', 'tablepeakdata', ...
'data', d, ...
'RowName', {'E','lb','ub'}, ...
'ColumnEditable', true, ...
'CellEditCallback',{@updatetablepeakdata}, ...
'ColumnWidth',{45} ...
);
% uistack(h.textpeak2,'top');
% uistack(h.textpeak3,'top');
% uistack(h.textpeak4,'top');
% uistack(h.textpeak5,'top');
align([h.buttonselectpeak1 h.buttonselectpeak2],'Fixed',4,'VerticalAlignment');
align([h.buttonselectpeak3 h.buttonselectpeak4],'Fixed',4,'VerticalAlignment');
%% Fit Results
h.fitresultspanel = uipanel( ...
'Parent', h.Tabs(1), ...
'Units', 'Normalized', ...
'Position', [0.0025 0.0125 0.175 0.144], ...
'Title', '7. Fit results' ...
);
d = zeros(10,7);
h.tablefitresults = uitable(h.fitresultspanel, ...
'Units', 'Normalized', ...
'Position', [0.025 0.03 0.9675 0.95], ...
'Tag', 'tablefitresults', ...
'data', d, ...
'ColumnEditable', false, ...
'CellEditCallback',{}, ...
'ColumnFormat', {'long'}, ...
'ColumnWidth',{70,70,60,60,60,75,50}, ...
'ColumnName', {'Iint [cts]','Imax [cts]', ...
'E [keV]', [char(916),' ','E [keV]'], ...
'IB [keV]', 'FWHM [keV]', char(951)} ...
);

%% Create Psi File Panel
h.createpsifilepanel = uipanel( ...
'Parent', h.Tabs(1), ...
'Units', 'Normalized', ...
'Position', [0.1825 0.0125 0.636 0.285], ...
'Title', '8. Create Psi File' ...
);

h.checkboxcreatepsi1 = uicontrol( ...
'Parent', h.createpsifilepanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.00625 0.75 0.4 0.125], ...
'Tag', 'checkboxcreatepsi1', ...
'String', 'Apply filter options', ...
'Value', 0 ...
);
h.textcreatepsi2 = uicontrol( ...
'Parent', h.createpsifilepanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.00625 0.695 0.06 0.05], ...
'HorizontalAlignment', 'left', ...
'String', {[char(916) 'Emax [keV]']} ...
);
h.editfieldcreatepsi1 = uicontrol( ...
'Parent', h.createpsifilepanel, ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.08 0.68 0.03 0.075], ...
'Tag', 'editfieldcreatepsi1', ...
'String', '0.015', ...
'ButtonDownFcn', {@clearbuttondown}, ...
'Enable', 'inactive' ...
);
h.textcreatepsi3 = uicontrol( ...
'Parent', h.createpsifilepanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.00625 0.61 0.06 0.05], ...
'HorizontalAlignment', 'left', ...
'String', {['min.' ' ' char(921) 'int']} ...
);
h.editfieldcreatepsi2 = uicontrol( ...
'Parent', h.createpsifilepanel, ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.08 0.59 0.03 0.075], ...
'Tag', 'editfieldcreatepsi2', ...
'String', '100', ...
'ButtonDownFcn', {@clearbuttondown}, ...
'Enable', 'inactive' ...
);
h.textcreatepsi4 = uicontrol( ...
'Parent', h.createpsifilepanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.00625 0.52 0.06 0.05], ...
'HorizontalAlignment', 'left', ...
'String', {['min.' ' ' 'IB  [keV]']} ...
);
h.editfieldcreatepsi3 = uicontrol( ...
'Parent', h.createpsifilepanel, ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.08 0.5015 0.03 0.075], ...
'Tag', 'editfieldcreatepsi3', ...
'String', '0.2', ...
'ButtonDownFcn', {@clearbuttondown}, ...
'Enable', 'inactive' ...
);
h.textcreatepsi5 = uicontrol( ...
'Parent', h.createpsifilepanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.00625 0.43 0.06 0.05], ...
'HorizontalAlignment', 'left', ...
'String', {['max.' ' ' 'IB  [keV]']} ...
);
h.editfieldcreatepsi4 = uicontrol( ...
'Parent', h.createpsifilepanel, ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.08 0.413 0.03 0.075], ...
'Tag', 'editfieldcreatepsi4', ...
'String', '2', ...
'ButtonDownFcn', {@clearbuttondown}, ...
'Enable', 'inactive' ...
);
h.textcreatepsi6 = uicontrol( ...
'Parent', h.createpsifilepanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.00625 0.3145 0.08 0.075], ...
'HorizontalAlignment', 'left', ...
'String', 'Peak range [keV]' ...
);
h.editfieldcreatepsi5 = uicontrol( ...
'Parent', h.createpsifilepanel, ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.08 0.3245 0.03 0.075], ...
'Tag', 'editfieldcreatepsi5', ...
'String', '0.4', ...
'ButtonDownFcn', {@clearbuttondown}, ...
'Enable', 'inactive' ...
);
h.textcreatepsi7 = uicontrol( ...
'Parent', h.createpsifilepanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.00625 0.226 0.08 0.075], ...
'HorizontalAlignment', 'left', ...
'String', 'Phi [all - 0,90,...]' ...
);
h.editfieldcreatepsi6 = uicontrol( ...
'Parent', h.createpsifilepanel, ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.08 0.236 0.03 0.075], ...
'Tag', 'editfieldcreatepsi6', ...
'String', 'all', ...
'ButtonDownFcn', {@clearbuttondown}, ...
'Enable', 'inactive' ...
);

h.textcreatepsi8 = uicontrol( ...
'Parent', h.createpsifilepanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.00625 0.1375 0.08 0.075], ...
'HorizontalAlignment', 'left', ...
'String', 'delete Psi > [°]' ...
);
h.editfieldcreatepsi7 = uicontrol( ...
'Parent', h.createpsifilepanel, ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.08 0.1475 0.03 0.075], ...
'Tag', 'editfieldcreatepsi7', ...
'String', 'all', ...
'ButtonDownFcn', {@clearbuttondown}, ...
'Enable', 'inactive' ...
);

h.buttoncreatepsi1 = uicontrol( ...
'Parent', h.createpsifilepanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.125 0.75 0.065 0.1], ...
'String', 'Load fit data', ...
'Tag', 'buttoncreatepsi1', ...
'Callback', {@buttoncreatepsi1} ...
);
h.buttoncreatepsi2 = uicontrol( ...
'Parent', h.createpsifilepanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.125 0.62 0.065 0.1], ...
'String', 'Save Psi file', ...
'Tag', 'buttoncreatepsi2', ...
'Callback', {@buttoncreatepsi2} ...
);
h.textcreatepsi7 = uicontrol( ...
'Parent', h.createpsifilepanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.00625 0.88 0.11 0.1], ...
'HorizontalAlignment', 'left', ...
'String', 'Select peaks from fit to be considered creating psi file' ...
);
h.buttoncreatepsi3 = uicontrol( ...
'Parent', h.createpsifilepanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.125 0.88 0.065 0.1], ...
'String', 'Select peaks', ...
'Tag', 'buttoncreatepsi3', ...
'Callback', {@buttoncreatepsi3} ...
);
h.checkboxEditTableData = uicontrol( ...
'Parent', h.createpsifilepanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.00625 0.05 0.11 0.06], ...
'Tag', 'checkboxEditTableData', ...
'String', 'Edit table data manually', ...
'Callback', {@checkboxEditTableData}, ...
'Value', 0);

d = zeros(13,23);
h.tablepsifile = uitable(h.createpsifilepanel, ...
'Units', 'Normalized', ...
'Position', [0.2 0.03 0.7915 0.9615], ...
'Tag', 'tablepsifile', ...
'data', d, ...
'ColumnEditable', false, ...
'CellSelectionCallback',{@PsiFileTableData_CellEditCallback2}, ...
'ColumnFormat', {'numeric'}, ...
'ColumnWidth', {40 50 55 50 50 50 50 50 50 50 50 50 50 50 50 60 60 60 50 60 60 60 80}, ...
'ColumnName', {'LNr     ',...
'Emax   ',...
'dEmax    ',...
'Iint      ',...
'Ib      ',...
'tth     ',...
'phiP   ',...
'psiP   ',...
'etaP  ',...
'Ringstr  ',...
'RT  ',...
'DT   ',...
'xdiff   ',...
'ydiff   ',...
'zdiff   ',...
'motor1   ',...
'motor2   ',...
'motor3   ',...
'temp1   ',...
'temp2   ',...
'heatrate   ',...
'Time   ',...
'PeakCount   ',...
});

%% Options panel
h.optionspanel = uipanel( ...
'Parent', h.Tabs(1), ...
'Units', 'Normalized', ...
'Position', [0.823 0.335 0.175 0.11], ...
'Title', 'Save/load or clear evaluation' ...
);
h.buttonoptions1 = uicontrol( ...
'Parent', h.optionspanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.69 0.5 0.3 0.4], ...
'String', 'Clear Evaluation', ...
'Tag', 'buttonoptions1', ...
'Callback', {@ClearGUIButton} ...
);
h.buttonoptions2 = uicontrol( ...
'Parent', h.optionspanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.015 0.5 0.3 0.4], ...
'String', 'Save Evaluation', ...
'Tag', 'buttonoptions2', ...
'Callback', {@SaveGUIDataButton} ...
);
h.buttonoptions3 = uicontrol( ...
'Parent', h.optionspanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.3275 0.5 0.35 0.4], ...
'String', 'Load Evaluation file', ...
'Tag', 'buttonoptions3', ...
'Callback', {@LoadGUIDataButton} ...
); 
h.buttonoptions4 = uicontrol( ...
'Parent', h.optionspanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.015 0.05 0.978 0.4], ...
'String', 'Load new measurement file', ...
'Tag', 'buttonoptions4', ...
'Callback', {@NewFileButton} ...
); 


%% Calibate energy pos and twotheta panel
h.calibangEpospanel = uipanel( ...
'Parent', h.Tabs(1), ...
'Units', 'Normalized', ...
'Position', [0.823 0.0125 0.175 0.315], ...
'Title', 'Calibrate twotheta and energy positions' ...
);

h.TabGroupCalib = uitabgroup('Parent',h.calibangEpospanel,'units', 'normalized');
h.TabCalib(1) = uitab('Parent',h.TabGroupCalib, 'Title','Calibration (Absolute Offset) ');
h.TabCalib(2) = uitab('Parent',h.TabGroupCalib, 'Title','Pointwise Calibration ');

h.textcalibangEpos1 = uicontrol( ...
'Parent', h.TabCalib(1), ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.015 0.88 0.99 0.1], ...
'HorizontalAlignment', 'left', ...
'String', 'Use the current fit results for twotheta and energy calibration' ...
);
h.buttoncalibangEpos1 = uicontrol( ...
'Parent', h.TabCalib(1), ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.685 0.73 0.3 0.1], ...
'String', 'Start calibration', ...
'Tag', 'buttoncalibangEpos1', ...
'Callback', {@startcalib} ...
);
h.buttoncalibangEpos2 = uicontrol( ...
'Parent', h.TabCalib(1), ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.685 0.605 0.3 0.1], ...
'String', 'Save calibration', ...
'Tag', 'buttoncalibangEpos2', ...
'Callback', {@savecalib} ...
);
h.buttoncalibangEpos3 = uicontrol( ...
'Parent', h.TabCalib(1), ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.685 0.48 0.3 0.1], ...
'String', 'Load calibration', ...
'Tag', 'buttoncalibangEpos3', ...
'Callback', {@loadcalib} ...
);
h.textcalibangEpos2 = uicontrol( ...
'Parent', h.TabCalib(1), ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.015 0.86 0.5 0.05], ...
'HorizontalAlignment', 'left', ...
'String', 'Calibration data from ' ...
);
d = zeros(7,5);
h.tablecalibangEpos1 = uitable(h.TabCalib(1), ...
'Units', 'Normalized', ...
'Position', [0.015 0.45 0.645 0.4], ...
'Tag', 'tablecalibangEpos1', ...
'data', d, ...
'ColumnWidth', {22 22 22 35 60}, ...
'ColumnName', {'h', 'k', 'l', 'hkl²' 'Energy'});

h.textcalibangEpos3 = uicontrol( ...
'Parent', h.TabCalib(1), ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.015 0.3 0.9 0.1], ...
'HorizontalAlignment', 'left', ...
'String', 'a0 [A] = ' ...
);
h.texteditfieldcalibangEpos1 = uicontrol( ...
'Parent', h.TabCalib(1), ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.145 0.34 0.36 0.07], ...
'String', 'Lattice parameter', ...
'Tag', 'texteditfieldcalibangEpos1', ...
'Enable', 'inactive', ...
'ButtonDownFcn', {@clearbuttondown} ...
);

h.textcalibangEpos4 = uicontrol( ...
'Parent', h.TabCalib(1), ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.015 0.21 0.9 0.1], ...
'HorizontalAlignment', 'left', ...
'String', 'twotheta_true [°] = ' ...
);
h.texteditfieldcalibangEpos2 = uicontrol( ...
'Parent', h.TabCalib(1), ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.305 0.25 0.2 0.07], ...
'String', 'twotheta', ...
'Tag', 'texteditfieldcalibangEpos2', ...
'Enable', 'inactive', ...
'ButtonDownFcn', {@clearbuttondown} ...
);
h.checkboxcalibangEpos1 = uicontrol( ...
'Parent', h.TabCalib(1), ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.52 0.2525 0.06 0.06], ...
'Tag', 'checkboxcalibangEpos1', ...
'Value', 1);

h.textcalibangEpos5 = uicontrol( ...
'Parent', h.TabCalib(1), ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.015 0.12 0.9 0.1], ...
'HorizontalAlignment', 'left', ...
'String', 'deltaE_offset [keV] = ' ...
);
h.texteditfieldcalibangEpos3 = uicontrol( ...
'Parent', h.TabCalib(1), ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.33 0.16 0.175 0.07], ...
'String', 'deltaE', ...
'Tag', 'texteditfieldcalibangEpos3', ...
'Enable', 'inactive', ...
'ButtonDownFcn', {@clearbuttondown} ...
);
h.checkboxcalibangEpos2 = uicontrol( ...
'Parent', h.TabCalib(1), ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.52 0.165 0.06 0.06], ...
'Tag', 'checkboxcalibangEpos2', ...
'Value', 1);

h.checkboxcalibangEpos3 = uicontrol( ...
'Parent', h.TabCalib(1), ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.52 0.075 0.06 0.06], ...
'Tag', 'checkboxcalibangEpos3', ...
'Value', 1);
h.textcalibangEpos6 = uicontrol( ...
'Parent', h.TabCalib(1), ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.015 0.03 0.47 0.1], ...
'HorizontalAlignment', 'left', ...
'String', 'Correct twotheta of theoretical line positions only' ...
);

h.buttoncalibangEpos4 = uicontrol( ...
'Parent', h.TabCalib(1), ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.685 0.205 0.3 0.1], ...
'String', 'Apply calibration', ...
'Tag', 'buttoncalibangEpos4', ...
'Callback', {@applycalib} ...
);
h.buttoncalibangEpos5 = uicontrol( ...
'Parent', h.TabCalib(1), ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.685 0.08 0.3 0.1], ...
'String', 'Clear calibration', ...
'Tag', 'buttoncalibangEpos5', ...
'Callback', {@clearcalib} ...
);

% Correct energy position pointwise (need to be further implemented)
% Editfields with zeros, where user can enter numeric values in order
% to create correction function. Maybe polynom with 1 to 4 params?
% h.checkboxcorrEpos1 = uicontrol( ...
% 'Parent', h.TabCalib(2), ...
% 'Style', 'checkbox', ...
% 'Units', 'Normalized', ...
% 'Position', [0.05 0.9 0.5 0.06], ...
% 'String', 'Correct energy positions', ...
% 'Tag', 'checkboxcalibangEpos1', ...
% 'Value', 0);

h.textfield1 = uicontrol( ...
'Parent', h.TabCalib(2), ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.05 0.875 0.9 0.1], ...
'HorizontalAlignment', 'left', ...
'String', {'Correction of energy positions for each psi angle.'} ...
);

h.textfield2 = uicontrol( ...
'Parent', h.TabCalib(2), ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.05 0.8 0.9 0.1], ...
'HorizontalAlignment', 'left', ...
'String', {'Function of type'} ...
);

h.textfield3 = uicontrol( ...
'Parent', h.TabCalib(2), ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.05 0.725 0.9 0.1], ...
'HorizontalAlignment', 'left', ...
'String', {'               f(x) = a0 + a1*x + a2*x^2 + a3*x^3 + a4*x^4'} ...
);

h.textfield4 = uicontrol( ...
'Parent', h.TabCalib(2), ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.05 0.65 0.9 0.1], ...
'HorizontalAlignment', 'left', ...
'String', {'is used for correction.'} ...
);

h.textfield5 = uicontrol( ...
'Parent', h.TabCalib(2), ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.4 0.265 0.58 0.4], ...
'HorizontalAlignment', 'left', ...
'String', [{'Enter values for the parameters.'},{'If a parameter is not used, enter 0. Correction can only be performed after the fitting process.'},{''},{'Press "Calibrate" in order to correct the values from the psi file.'}] ...
);

h.textfieldpwparam1 = uicontrol( ...
'Parent', h.TabCalib(2), ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.07 0.6 0.1 0.05], ...
'HorizontalAlignment', 'left', ...
'String', 'a0 =' ...
);

h.texteditfieldpwparam1 = uicontrol( ...
'Parent', h.TabCalib(2), ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.145 0.59 0.2 0.07], ...
'String', '0', ...
'Tag', 'texteditfieldpwparam1', ...
'Enable', 'inactive', ...
'ButtonDownFcn', {@clearbuttondown} ...
);


h.textfieldpwparam2 = uicontrol( ...
'Parent', h.TabCalib(2), ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.07 0.5 0.1 0.05], ...
'HorizontalAlignment', 'left', ...
'String', 'a1 =' ...
);

h.texteditfieldpwparam2 = uicontrol( ...
'Parent', h.TabCalib(2), ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.145 0.49 0.2 0.07], ...
'String', '0', ...
'Tag', 'texteditfieldpwparam2', ...
'Enable', 'inactive', ...
'ButtonDownFcn', {@clearbuttondown} ...
);


h.textfieldpwparam3 = uicontrol( ...
'Parent', h.TabCalib(2), ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.07 0.4 0.1 0.05], ...
'HorizontalAlignment', 'left', ...
'String', 'a2 =' ...
);

h.texteditfieldpwparam3 = uicontrol( ...
'Parent', h.TabCalib(2), ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.145 0.39 0.2 0.07], ...
'String', '0', ...
'Tag', 'texteditfieldpwparam3', ...
'Enable', 'inactive', ...
'ButtonDownFcn', {@clearbuttondown} ...
);

h.textfieldpwparam4 = uicontrol( ...
'Parent', h.TabCalib(2), ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.07 0.3 0.1 0.05], ...
'HorizontalAlignment', 'left', ...
'String', 'a3 =' ...
);

h.texteditfieldpwparam4 = uicontrol( ...
'Parent', h.TabCalib(2), ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.145 0.29 0.2 0.07], ...
'String', '0', ...
'Tag', 'texteditfieldpwparam4', ...
'Enable', 'inactive', ...
'ButtonDownFcn', {@clearbuttondown} ...
);

h.textfieldpwparam5 = uicontrol( ...
'Parent', h.TabCalib(2), ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.07 0.2 0.1 0.05], ...
'HorizontalAlignment', 'left', ...
'String', 'a4 =' ...
);

h.texteditfieldpwparam5 = uicontrol( ...
'Parent', h.TabCalib(2), ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.145 0.19 0.2 0.07], ...
'String', '0', ...
'Tag', 'texteditfieldpwparam5', ...
'Enable', 'inactive', ...
'ButtonDownFcn', {@clearbuttondown} ...
);

h.buttonPWCorrEpos = uicontrol( ...
    'Parent', h.TabCalib(2), ...
    'Style', 'Pushbutton', ...
    'Units', 'Normalized', ...
    'Position', [0.4 0.1725 0.3 0.1], ...
    'String', 'Calibrate', ...
    'Tag', 'buttonPWCorrEpos', ...
    'Callback', {@startPWCorrEpos} ...
    );

h.buttonPWCorrUndo = uicontrol( ...
    'Parent', h.TabCalib(2), ...
    'Style', 'Pushbutton', ...
    'Units', 'Normalized', ...
    'Position', [0.725 0.1725 0.2 0.1], ...
    'String', 'Undo', ...
    'Tag', 'buttonPWCorrUndo', ...
    'Callback', {@startPWCorrUndo} ...
    );

%% Table theoretical peak positions and fluorescence lines
h.tablehklpanel = uipanel( ...
'Parent', h.Tabs(1), ...
'Units', 'Normalized', ...
'Position', [0.823 0.45 0.175 0.55], ...
'Title', 'Theoretical peak positions' ...
);
% Create table with empty data for hkl, d-spacing and E [keV] values.
% Sample phase data
d = zeros(14,5);
h.texthkltable1 = uicontrol( ...
'Parent', h.tablehklpanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.05 0.96 0.8 0.03], ...
'HorizontalAlignment', 'left', ...
'String', 'Sample phase data' ...
);

% h.tablephasehkl = uitable(h.tablehklpanel, ...
% 'Units', 'Normalized', ...
% 'Position', [0.05 0.57 0.895 0.39], ...
% 'Tag', 'tablephasehkl', ...
% 'data', d, ...
% 'ColumnWidth',{50}, ...
% 'ColumnWidth', {25 25 25 85 85}, ...
% 'ColumnName', {'h', 'k', 'l', 'dspacing', 'Energy'});
idxdata = d(:,1)>0;
h.tablephasehkl = uitable(h.tablehklpanel, ...
'Units', 'Normalized', ...
'Position', [0.05 0.58 0.895 0.375], ...
'Tag', 'tablephasehkl', ...
'data', [num2cell(d) num2cell(idxdata)],...
'ColumnEditable', [false false false false false true], ...
'ColumnWidth', {25 25 25 85 77 25}, ...
'CellEditCallback',{@celleditcallbackHKLTable}, ...
'ColumnName', {'h', 'k', 'l', 'dspacing', 'Energy', 'Use'});

% Create table with empty data for hkl, d-spacing and E [keV] values.
% Substrate phase data
d = zeros(10,5);
h.texthkltable2 = uicontrol( ...
'Parent', h.tablehklpanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.05 0.525 0.8 0.03], ...
'HorizontalAlignment', 'left', ...
'String', '2nd phase data' ...
);
h.tablephasehkl2 = uitable(h.tablehklpanel, ...
'Units', 'Normalized', ...
'Position', [0.05 0.295 0.895 0.23], ...
'Tag', 'tablephasehkl2', ...
'data', d, ...
'ColumnWidth',{50}, ...
'ColumnWidth', {25 25 25 85 85}, ...
'ColumnName', {'h', 'k', 'l', 'dspacing', 'Energy'});

% Add theoretical peak positions of various phases
h.textelementEtheo = uicontrol( ...
'Parent', h.tablehklpanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.05 0.215 0.5 0.05], ...
'HorizontalAlignment', 'left', ...
'String', 'Show peaks from another phase' ...
);
h.texteditfieldEtheo = uicontrol( ...
'Parent', h.tablehklpanel, ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.55 0.235 0.4 0.04], ...
'String', 'Enter elemental formula', ...
'Tag', 'editfieldelementEtheo', ...
'Enable', 'inactive', ...
'ButtonDownFcn', {@clearbuttondown} ...
);
h.textmpdEtheo = uicontrol( ...
'Parent', h.tablehklpanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.05 0.159 0.25 0.05], ...
'String', 'Select mpd file', ...
'HorizontalAlignment', 'left', ...
'Tag', 'editfieldelementEtheo'...
);
h.popupmenumpdEtheo = uicontrol( ...
'Parent', h.tablehklpanel, ...
'Style', 'popupmenu', ...
'Units', 'Normalized', ...
'Position', [0.29 0.205 0.15 0.01], ...
'Tag', 'popupmenumpdEtheo', ...
'String', MPDFileNameList, ...
'Value', 1, ...
'Callback', {@LoadMPDMenu} ...
);
h.buttonShowEtheoPeaks = uicontrol( ...
'Parent', h.tablehklpanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.48 0.17 0.225 0.05], ...
'String', 'Show peaks', ...
'Tag', 'buttonShowEtheoPeaks', ...
'Callback', {@okbuttonloadEtheo} ...
);
h.buttonHideEtheoPeaks = uicontrol( ...
'Parent', h.tablehklpanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.7305 0.17 0.225 0.05], ...
'String', 'Hide peaks', ...
'Tag', 'buttonHideEtheoPeaks', ...
'Callback', {@buttonhideEtheo} ...
);
% Grafical line element
h.textelementLine = uicontrol( ...
'Parent', h.tablehklpanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.05 0.11 0.9 0.05], ...
'ForegroundColor', [0.7 0.7 0.7], ...
'HorizontalAlignment', 'left', ...
'String', '_________________________________________________' ...
);

% Add fluorescence lines
h.textelementFluorescence = uicontrol( ...
'Parent', h.tablehklpanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.05 0.06 0.5 0.05], ...
'HorizontalAlignment', 'left', ...
'String', 'Show fluorescence lines' ...
);
h.textdataFluorescence = uicontrol( ...
'Parent', h.tablehklpanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.05 0.009 0.25 0.05], ...
'String', 'Select Element', ...
'HorizontalAlignment', 'left', ...
'Tag', 'textdataFluorescence'...
);
h.popupmenudataFluorescence = uicontrol( ...
'Parent', h.tablehklpanel, ...
'Style', 'popupmenu', ...
'Units', 'Normalized', ...
'Position', [0.29 0.055 0.15 0.01], ...
'Tag', 'popupmenudataFluorescence', ...
'String', h.ElementsString, ...
'Value', 1, ...
'Callback', {@LoadElementMenu} ...
);
h.buttonShowFluorescencePeaks = uicontrol( ...
'Parent', h.tablehklpanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.48 0.02 0.225 0.05], ...
'String', 'Show peaks', ...
'Tag', 'buttonShowFluorescencePeaks', ...
'Callback', {@okbuttonloadFluorescence} ...
);
h.buttonHideFluorescencePeaks = uicontrol( ...
'Parent', h.tablehklpanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.7305 0.02 0.225 0.05], ...
'String', 'Hide peaks', ...
'Tag', 'buttonHideFluorescencePeaks', ...
'Callback', {@buttonhideFluorescence} ...
);

%% Stress analysis
h.fitresultspanel = uipanel( ...
'Parent', h.Tabs(2), ...
'Units', 'Normalized', ...
'Position', [0.00375 0.0025 0.6 0.995], ...
'Title', 'Plot fit results' ...
);

% Button to enter DEK data
h.buttonloadDEK1 = uicontrol( ...
'Parent', h.fitresultspanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.01 0.96 0.1 0.035], ...
'String', 'Enter/Load DEC', ...
'Tag', 'buttonmodifystressdata1', ...
'Callback', {@buttonloadDEK} ...
);
% Button to load data from previous data fitting
h.buttonloadstressdata1 = uicontrol( ...
'Parent', h.fitresultspanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.12 0.96 0.1 0.035], ...
'String', 'Load stress data', ...
'Tag', 'buttonloadstressdata1', ...
'Callback', {@buttonloadstressdata} ...
);  
% Checkbox for the different azimuths phi
h.textazimuth = uicontrol( ...
'Parent', h.fitresultspanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.2325 0.9825 0.07 0.0175], ...
'HorizontalAlignment', 'left', ...
'String', 'Azimuth angle' ...
);
h.checkboxphi0 = uicontrol( ...
'Parent', h.fitresultspanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.23 0.96 0.06 0.025], ...
'Tag', 'checkboxphi0', ...
'String', '0°', ...
'Value', 0, ...
'Callback', {@ClickPhi0Callback} ...
);
h.checkboxphi90 = uicontrol( ...
'Parent', h.fitresultspanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.23 0.94 0.06 0.025], ...
'Tag', 'checkboxphi0', ...
'String', '90°', ...
'Value', 0, ...
'Callback', {@ClickPhi90Callback} ...
);
h.checkboxphi180 = uicontrol( ...
'Parent', h.fitresultspanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.265 0.96 0.06 0.025], ...
'Tag', 'checkboxphi0', ...
'String', '180°', ...
'Value', 0, ...
'Callback', {@ClickPhi180Callback} ...
);
h.checkboxphi270 = uicontrol( ...
'Parent', h.fitresultspanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.265 0.94 0.06 0.025], ...
'Tag', 'checkboxphi0', ...
'String', '270°', ...
'Value', 0, ...
'Callback', {@ClickPhi270Callback} ...
);

% Button to modifiy stress data
h.buttonmodifystressdata1 = uicontrol( ...
'Parent', h.fitresultspanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.31 0.96 0.1 0.035], ...
'String', 'Modify stress data', ...
'Tag', 'buttonmodifystressdata1', ...
'Callback', {@buttonmodifystressdata} ...
);
% Button to export plots
h.buttonexportplots1 = uicontrol( ...
'Parent', h.fitresultspanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.69 0.96 0.1 0.035], ...
'String', ['Export sin²',char(968),' ','plots'], ...
'Tag', 'buttonexportplots1', ...
'Callback', {@buttonexportplots} ...
);
% Button to create tau file
h.buttonexportplots2 = uicontrol( ...
'Parent', h.fitresultspanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.8 0.96 0.1 0.035], ...
'String', 'Export stress plots', ...
'Tag', 'buttonexportplots2', ...
'Callback', {@buttoncreatetaufile} ...
);
% Button to export evaluation data
h.buttonSaveModPsiFile = uicontrol( ...
'Parent', h.fitresultspanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.42 0.96 0.11 0.035], ...
'String', 'Save modified Psi file', ...
'Tag', 'buttonmodifystressdata1', ...
'Callback', {@buttonSaveModPsiFile} ...
);
% Button to load evaluation data
h.buttonSaveModEvalData = uicontrol( ...
'Parent', h.fitresultspanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.54 0.96 0.14 0.035], ...
'String', 'Save modified evaluation data', ...
'Tag', 'buttonSaveModEvalData', ...
'Callback', {@buttonSaveModEvalData} ...
);

% Button to create tau file
h.buttonexportplots2 = uicontrol( ...
'Parent', h.fitresultspanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.91 0.96 0.07 0.035], ...
'String', 'Averaging', ...
'Tag', 'buttonAveraging', ...
'Callback', {@buttonaveraging} ...
);

% Create slider
h.SliderStressData = uicontrol(...
    'Style','slider',...
    'Tag','Slider',...
    'Parent', h.fitresultspanel,...
    'Units','normalized',...
    'Position', [0.475 0.0125 0.1 0.025],...
    'Min',0,...
    'Max', 1,...
    'Value',1,...
    'Callback',{@SliderCallbackStressData});

% Get slider value
valueslider = get(h.SliderStressData,'Value');
% Define color array
%     h.Colors = {[0,0,0],[1,0,0],[0,0,1],[0,1,0],[1,1,0],[1,0,1],[0 1 1],[.5 .6 .7],[.8 .2 .6],[.5 .1 .2],[.3 .8 .4],[.1 .7 .5],[.2 .4 .6],[.3 .1 .9],[.5 .7 .2],[.7 .2 .6],[.4 .3 .8]};

h.Colors = {[0,0,0],[1,0,0],[0,0,1],[0,1,0],[1,0.8398,0],[1,0,1],[0 1 1],[0 .4 .8],[.6 .2 .8],[.8 .4 .4],[.2 .4 .2],[1,.5469,0],[.2 .4 .6],[1,.4102,.7031],[.2 .8 .6],[0.6445,0.1641,0.1641],[0 .7461 1]};
h.Colors2 = {[0.65,0.65,0.65],[1,0.65,0.65],[0.65,0.65,1],[0.65,1,0.65],[1,1,0.65],[1,0.65,1],[0.65 1 1],[0 .6 .8],[.6 .4 .8],[.8 .6 .4],[.2 .8 .2],[1 .8906 .7070],[.6875 .8750 .8984],[1 .75 .7930],[0 .9792 .6016],[0.8203 .7031 .5469],[.2 1 1]};
% Empty data for plot    
x = 0;
y = 0;
err = 0;
% Create axes objects for plot of stress, IB and Int.intensity
h.axesplotdspacing = axes('Parent', h.fitresultspanel, 'Position', [0.075 0.4 0.9 0.525]);
h.axesplotIB = axes('Parent', h.fitresultspanel, 'Position', [0.075 0.07 0.4 0.25]);
h.axesplotInt = axes('Parent', h.fitresultspanel, 'Position', [0.575 0.07 0.4 0.25]);
% Create plot of d-spacing with errorbars and regression line
hold(h.axesplotdspacing,'on')
h.plotdatadspacingphi0 = errorbar(h.axesplotdspacing, x,y,err,'Linestyle','none','Color','k','Marker','s','MarkerSize',14,'Clipping','off');
h.plotreglinedspacingphi0 = line(h.axesplotdspacing, x,y,'LineWidth',2);
h.plotdatadspacingphi90 = errorbar(h.axesplotdspacing, x,y,err,'Linestyle','none','Color','k','Marker','o','MarkerSize',14,'Clipping','off');
h.plotreglinedspacingphi90 = line(h.axesplotdspacing, x,y,'LineWidth',2);
h.plotdatadspacingphi180 = errorbar(h.axesplotdspacing, x,y,err,'Linestyle','none','Color','k','Marker','d','MarkerSize',14,'Clipping','off');
h.plotreglinedspacingphi180 = line(h.axesplotdspacing, x,y,'LineWidth',2);
h.plotdatadspacingphi270 = errorbar(h.axesplotdspacing, x,y,err,'Linestyle','none','Color','k','Marker','p','MarkerSize',14,'Clipping','off');
h.plotreglinedspacingphi270 = line(h.axesplotdspacing, x,y,'LineWidth',2);
% Set plot properties
set(h.plotdatadspacingphi0, {'MarkerFaceColor','MarkerEdgeColor','Visible'}, {h.Colors{valueslider},'k','off'});
set(h.plotreglinedspacingphi0, {'Color','Visible'}, {'k','off'});
set(h.plotdatadspacingphi90, {'MarkerFaceColor','MarkerEdgeColor','Visible'}, {h.Colors{valueslider},'k','off'});
set(h.plotreglinedspacingphi90, {'Color','Visible'}, {'k','off'});
set(h.plotdatadspacingphi180, {'MarkerFaceColor','MarkerEdgeColor','Visible'}, {h.Colors{valueslider},'k','off'});
set(h.plotreglinedspacingphi180, {'Color','Visible'}, {'k','off'});
set(h.plotdatadspacingphi270, {'MarkerFaceColor','MarkerEdgeColor','Visible'}, {h.Colors{valueslider},'k','off'});
set(h.plotreglinedspacingphi270, {'Color','Visible'}, {'k','off'});

box(h.axesplotdspacing,'on')
grid(h.axesplotdspacing,'on')
hold(h.axesplotdspacing,'off')

% Plot IB data
hold(h.axesplotIB,'on')
h.plotdataIBphi0 = plot(h.axesplotIB, x,y,'Linestyle','--','Color','k','Marker','s','MarkerSize',10);
h.plotdataIBphi90 = plot(h.axesplotIB, x,y,'Linestyle','--','Color','k','Marker','o','MarkerSize',10);
h.plotdataIBphi180 = plot(h.axesplotIB, x,y,'Linestyle','--','Color','k','Marker','d','MarkerSize',10);
h.plotdataIBphi270 = plot(h.axesplotIB, x,y,'Linestyle','--','Color','k','Marker','p','MarkerSize',10);
% Set plot properties
set(h.plotdataIBphi0, {'MarkerFaceColor','MarkerEdgeColor','Visible'}, {h.Colors{valueslider},'k','off'});
set(h.plotdataIBphi90, {'MarkerFaceColor','MarkerEdgeColor','Visible'}, {h.Colors{valueslider},'k','off'});
set(h.plotdataIBphi180, {'MarkerFaceColor','MarkerEdgeColor','Visible'}, {h.Colors{valueslider},'k','off'});
set(h.plotdataIBphi270, {'MarkerFaceColor','MarkerEdgeColor','Visible'}, {h.Colors{valueslider},'k','off'});

box(h.axesplotIB,'on')
grid(h.axesplotIB,'on')
hold(h.axesplotIB,'off')

% Plot IntegratedInt. data
hold(h.axesplotInt,'on')
h.plotdataIntphi0 = plot(h.axesplotInt, x,y,'Linestyle','--','Color','k','Marker','s','MarkerSize',10);
h.plotdataIntphi90 = plot(h.axesplotInt, x,y,'Linestyle','--','Color','k','Marker','o','MarkerSize',10);
h.plotdataIntphi180 = plot(h.axesplotInt, x,y,'Linestyle','--','Color','k','Marker','d','MarkerSize',10);
h.plotdataIntphi270 = plot(h.axesplotInt, x,y,'Linestyle','--','Color','k','Marker','p','MarkerSize',10);
% Set plot properties
set(h.plotdataIntphi0, {'MarkerFaceColor','MarkerEdgeColor','Visible'}, {h.Colors{valueslider},'k','off'})
set(h.plotdataIntphi90, {'MarkerFaceColor','MarkerEdgeColor','Visible'}, {h.Colors{valueslider},'k','off'})
set(h.plotdataIntphi180, {'MarkerFaceColor','MarkerEdgeColor','Visible'}, {h.Colors{valueslider},'k','off'})
set(h.plotdataIntphi270, {'MarkerFaceColor','MarkerEdgeColor','Visible'}, {h.Colors{valueslider},'k','off'})

box(h.axesplotInt,'on')
grid(h.axesplotInt,'on')
hold(h.axesplotInt,'off')

% Set initial axes limits
h.axesplotdspacing.XLim = [0,1];
h.axesplotdspacing.YLim = [0,1];
h.axesplotIB.XLim = [0,1];
h.axesplotIB.YLim = [0,1];
h.axesplotInt.XLim = [0,1];
h.axesplotInt.YLim = [0,1];

% Set labels and titles
xlabel(h.axesplotdspacing,'sin²\psi','FontSize', 14);
ylabel(h.axesplotdspacing,'d [nm]','FontSize', 14);
xlabel(h.axesplotIB,'sin²\psi','FontSize', 12);
ylabel(h.axesplotIB,'IB [keV]','FontSize', 12);
xlabel(h.axesplotInt,'sin²\psi','FontSize', 12);
ylabel(h.axesplotInt,'Integrated Int. [cts*keV]','FontSize', 12);
title(h.axesplotdspacing,'No measurement data loaded')
title(h.axesplotIB,'No measurement data loaded')
title(h.axesplotInt,'No measurement data loaded')


%% Plot stress results
h.plotstresspanel = uipanel( ...
'Parent', h.Tabs(2), ...
'Units', 'Normalized', ...
'Position', [0.6075 0.50125 0.39 0.495], ...
'Title', 'Plot stresses' ...
);
% Create slider
h.SliderPlotStressData = uicontrol(...
    'Style','slider',...
    'Tag','Slider',...
    'Parent', h.plotstresspanel,...
    'Units','normalized',...
    'Position', [0.475 0.0125 0.1 0.04],...
    'Min',0,...
    'Max', 1,...
    'Value',1,...
    'Callback',{@SliderCallbackPlotStressData});

% Empty data for plot    
x = 0;
y = 0;
err = 0;
% Create axes object to plot residual stress data
h.axesplotstressdata = axes('Parent', h.plotstresspanel, 'Position', [0.1 0.16 0.875 0.8]);
h.plotstressdata = errorbar(h.axesplotstressdata, x,y,err,'Linestyle','none','Color','k','Marker','s','MarkerSize',14,'Clipping','off','Visible','off');
grid on
hold on
% Set plot properties
% xlabel('<\tau> [µm]')
xlabel('\tau_{0} [µm]')
ylabel('<\sigma_{11} - \sigma_{33}> [MPa]')
title(h.axesplotstressdata,'No measurement data loaded')


% Plot fitted spectra
h.fitdatapanel = uipanel( ...
'Parent', h.Tabs(2), ...
'Units', 'Normalized', ...
'Position', [0.6075 0.0025 0.39 0.495], ...
'Title', 'Plot fit data' ...
);

% Create slider
h.SliderFitData = uicontrol(...
    'Style','slider',...
    'Tag','Slider',...
    'Parent', h.fitdatapanel,...
    'Units','normalized',...
    'Position', [0.475 0.0125 0.1 0.04],...
    'Min',0,...
    'Max', 1,...
    'Value',1,...
    'Callback',{@SliderCallbackFitData});

% Empty data for plot    
x = 0;
y = 0;
% Create axes object to plot raw and fitted data and residual
h.axesplotfitdata = axes('Parent', h.fitdatapanel, 'Position', [0.1 0.16 0.85 0.8]);
h.plotrawdata1 = plot(h.axesplotfitdata, x,y,'Color','b','Visible','off');
grid on
hold on
h.plotfitdata1 = plot(h.axesplotfitdata, x,y,'Color','r','LineWidth',1.5,'Visible','off');
h.plotresiualdata1 = plot(h.axesplotfitdata, x,y,'Color','k','Visible','off');
% Set plot properties
xlabel('Energy [keV]');
ylabel('Intensity [cts]');
title(h.axesplotfitdata,'No measurement data loaded')

%% Change X-lim of stress plot
h.modstressXlimbutton = uicontrol( ...
'Parent', h.Tabs(2), ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.6455 0.5175 0.05 0.03], ...
'String', 'Change X-scale', ...
'Tag', 'modstressXlimbutton', ...
'Callback', {@modstressXlim, h} ...
);

% Create new window that opens when button is pushed
h.Xlimfig = figure('menubar','none','units','normalized','Position',[0.45 0.5 0.15 0.08],'Name', 'Change X-limits of stress plot','NumberTitle','off','Visible','off');
% Create graphic elements
h.XlimMaxname = uicontrol('Style', 'text',...
'Parent', h.Xlimfig,...
'Units','normalized',...
'Position', [0.05 0.705 0.3 0.25],...
'String', 'Min',...
'FontSize', 14,...
'HorizontalAlignment', 'right');    
h.XlimMaxname1 = uicontrol('Style', 'text',...
'Parent', h.Xlimfig,...
'Units','normalized',...
'Position', [0.375 0.775 0.075 0.175],...
'String', '=',...
'FontSize', 14,...
'HorizontalAlignment', 'left');    
h.editXlimMin  = uicontrol('Style','edit',...
'String', '0',...
'FontSize', 12,...
'Tag', 'editXlimMax',...
'Units','normalized',...
'Position',[0.45 0.7125 0.2 0.225],...
'Parent',h.Xlimfig);

h.XlimMinname = uicontrol('Style', 'text',...
'Parent', h.Xlimfig,...
'Units','normalized',...
'Position', [0.05 0.405 0.3 0.25],...
'String', 'Max',...
'FontSize', 14,...
'HorizontalAlignment', 'right');    
h.XlimMinname1 = uicontrol('Style', 'text',...
'Parent', h.Xlimfig,...
'Units','normalized',...
'Position', [0.375 0.475 0.075 0.175],...
'String', '=',...
'FontSize', 14,...
'HorizontalAlignment', 'left');    
h.editXlimMax  = uicontrol('Style','edit',...
'String', '0',...
'FontSize', 12,...
'Tag', 'editXlimMin',...
'Units','normalized',...
'Position',[0.45 0.4125 0.2 0.225],...
'Parent',h.Xlimfig);

h.XlimTickname = uicontrol('Style', 'text',...
'Parent', h.Xlimfig,...
'Units','normalized',...
'Position', [0.05 0.105 0.3 0.25],...
'String', 'Tick mark',...
'FontSize', 14,...
'HorizontalAlignment', 'right');    
h.XlimTickname1 = uicontrol('Style', 'text',...
'Parent', h.Xlimfig,...
'Units','normalized',...
'Position', [0.375 0.175 0.075 0.175],...
'String', '=',...
'FontSize', 14,...
'HorizontalAlignment', 'left');    
h.editXlimTick  = uicontrol('Style','edit',...
'String', '0',...
'FontSize', 12,...
'Tag', 'editXlimTick',...
'Units','normalized',...
'Position',[0.45 0.1125 0.2 0.225],...
'Parent',h.Xlimfig);     

h.AcceptXEditButton = uicontrol( ...
'Parent', h.Xlimfig, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.7 0.5 0.275 0.3], ...
'String', 'Accept', ...
'FontSize', 11,...
'Tag', 'AcceptXButton', ...
'Callback', {@acceptXlimEdit, h} ...
);   
h.CancelXEditButton = uicontrol( ...
'Parent', h.Xlimfig, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.7 0.1 0.275 0.3], ...
'String', 'Cancel', ...
'FontSize', 11,...
'Tag', 'CancelXButton', ...
'Callback', {@cancelXlimEdit, h} ...
); 

%% Change Y-lim of stress plot
h.modstressYlimbutton = uicontrol( ...
'Parent', h.Tabs(2), ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.6975 0.5175 0.05 0.03], ...
'String', 'Change Y-scale', ...
'Callback', {@modstressYlim, h} ...
);

% Create new window that opens when modstressYlimbutton is pushed
h.Ylimfig = figure('menubar','none','units','normalized','Position',[0.45 0.5 0.15 0.08],'Name', 'Change Y-limits of stress plot','NumberTitle','off','Visible','off');
% Create graphic elements
h.YlimMaxname = uicontrol('Style', 'text',...
'Parent', h.Ylimfig,...
'Units','normalized',...
'Position', [0.05 0.705 0.3 0.25],...
'String', 'Max',...
'FontSize', 14,...
'HorizontalAlignment', 'right');    
h.YlimMaxname1 = uicontrol('Style', 'text',...
'Parent', h.Ylimfig,...
'Units','normalized',...
'Position', [0.375 0.775 0.075 0.175],...
'String', '=',...
'FontSize', 14,...
'HorizontalAlignment', 'left');    
h.editYlimMax  = uicontrol('Style','edit',...
'String', '0',...
'FontSize', 12,...
'Tag', 'editYlimMax',...
'Units','normalized',...
'Position',[0.45 0.7125 0.2 0.225],...
'Parent',h.Ylimfig);
h.YlimMinname = uicontrol('Style', 'text',...
'Parent', h.Ylimfig,...
'Units','normalized',...
'Position', [0.05 0.405 0.3 0.25],...
'String', 'Min',...
'FontSize', 14,...
'HorizontalAlignment', 'right');    
h.YlimMinname1 = uicontrol('Style', 'text',...
'Parent', h.Ylimfig,...
'Units','normalized',...
'Position', [0.375 0.475 0.075 0.175],...
'String', '=',...
'FontSize', 14,...
'HorizontalAlignment', 'left');    
h.editYlimMin  = uicontrol('Style','edit',...
'String', '0',...
'FontSize', 12,...
'Tag', 'editYlimMin',...
'Units','normalized',...
'Position',[0.45 0.4125 0.2 0.225],...
'Parent',h.Ylimfig);
h.YlimTickname = uicontrol('Style', 'text',...
'Parent', h.Ylimfig,...
'Units','normalized',...
'Position', [0.05 0.105 0.3 0.25],...
'String', 'Tick mark',...
'FontSize', 14,...
'HorizontalAlignment', 'right');    
h.YlimTickname1 = uicontrol('Style', 'text',...
'Parent', h.Ylimfig,...
'Units','normalized',...
'Position', [0.375 0.175 0.075 0.175],...
'String', '=',...
'FontSize', 14,...
'HorizontalAlignment', 'left');    
h.editYlimTick  = uicontrol('Style','edit',...
'String', '0',...
'FontSize', 12,...
'Tag', 'editYlimTick',...
'Units','normalized',...
'Position',[0.45 0.1125 0.2 0.225],...
'Parent',h.Ylimfig);     

h.AcceptYEditButton = uicontrol( ...
'Parent', h.Ylimfig, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.7 0.5 0.275 0.3], ...
'String', 'Accept', ...
'FontSize', 11,...
'Tag', 'AcceptYButton', ...
'Callback', {@acceptYlimEdit, h} ...
);   
h.CancelYEditButton = uicontrol( ...
'Parent', h.Ylimfig, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.7 0.1 0.275 0.3], ...
'String', 'Cancel', ...
'FontSize', 11,...
'Tag', 'CancelYButton', ...
'Callback', {@cancelYlimEdit, h} ...
);


%% Load tau data to stress plot and choose hkl to be plotted
h.loadtaudatabutton = uicontrol( ...
'Parent', h.Tabs(2), ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.938 0.52  0.05 0.03], ...
'String', 'Load tau data', ...
'Callback', {@loadtaudata} ...
);

%% Select hkl values for stress plot
h.fighklstressplottable = figure('menubar','none','NumberTitle','off','Name','Select hkl','units','normalized','Position',[0.1 0.6 0.085 0.22],'Visible','off');
% h.fighklstressplottable = figure('menubar','none','NumberTitle','off','Name','Select hkl','units','normalized','Position',[0.1 0.6 0.075 0.16],'Visible','off');

h.selecthklvaluesbutton = uicontrol( ...
'Parent', h.Tabs(2), ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.871 0.52  0.065 0.03], ...
'String', 'Select hkl for plotting', ...
'Callback', {@buttonselecthkltable} ...
);

h.panelhklstressplottable = uipanel( ...
'Parent', h.fighklstressplottable, ...
'Units', 'Normalized', ...
'Position', [0.025 0.225 0.975 0.75], ...
'Title', 'Diffracton lines hkl' ...
);

h.buttonhklstressplottable1 = uicontrol( ...
'Parent', h.fighklstressplottable, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.075 0.02 0.4 0.12], ...
'String', 'Ok', ...
'Tag', 'buttonSelectPeaktable1', ...
'Callback', {@buttonhklstressplottableok, h} ...
);
h.buttonhklstressplottable2 = uicontrol( ...
'Parent', h.fighklstressplottable, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.525 0.02 0.4 0.12], ...
'String', 'Cancel', ...
'Tag', 'buttonSelectPeaktable2', ...
'Callback', {@buttonhklstressplottablecancel, h} ...
); 

d = zeros(10,1);
idxdata = d(:,1)>0;
h.Selecthkltable = uitable(h.panelhklstressplottable, ...
'Units', 'Normalized', ...
'Position', [0.025 0.025 0.95 0.95], ...
'Tag', 'Selecthkltable', ...
'data', [num2cell(d) num2cell(d) num2cell(d) num2cell(idxdata)],...
'ColumnFormat', {[] [] [] 'logical'},...
'ColumnEditable', [false false false true], ...
'ColumnWidth', {28 28 28 35}, ...
'CellEditCallback',{@celleditcallbackSelecthkltable, h}, ...
'ColumnName', {'h','k','l', 'Use'});

set(h.buttonhklstressplottable1,'callback',{@buttonhklstressplottableok, h})
set(h.buttonhklstressplottable2,'callback',{@buttonhklstressplottablecancel, h})
set(h.Selecthkltable,'CellEditCallback',{@celleditcallbackSelecthkltable, h})
set(h.fighklstressplottable,'CloseRequestFcn',@my_Figclosereq)


%% Change type of psi data used for plotting stress values
% h.checkboxTauData = uicontrol( ...
% 'Parent', h.Tabs(2), ...
% 'Style', 'checkbox', ...
% 'Units', 'Normalized', ...
% 'Position', [0.905 0.52 0.085 0.025], ...
% 'Tag', 'checkboxTauData', ...
% 'String', ['Plot stresses vs.' char(964) char(8320),' ','(' char(968) ' = 0°)'], ...
% 'Value', 0, ...
% 'Callback', {@ClickCheckboxTauData} ...
% );

%% Create DEK table
h.figDEKtable = figure('menubar','none','NumberTitle','off','Name','Enter/load DEC','units','normalized','Position',[0.1 0.6 0.175 0.25],'Visible','off');

h.panelDEKtable = uipanel( ...
'Parent', h.figDEKtable, ...
'Units', 'Normalized', ...
'Position', [0.025 0.225 0.975 0.75], ...
'Title', 'DEK values' ...
);

h.buttonDEKtable1 = uicontrol( ...
'Parent', h.figDEKtable, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.025 0.05 0.2 0.12], ...
'String', 'Ok', ...
'Tag', 'buttonDEKtable1', ...
'Callback', {@buttonDEKtableok, h} ...
);
h.buttonDEKtable2 = uicontrol( ...
'Parent', h.figDEKtable, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.25 0.05 0.2 0.12], ...
'String', 'Cancel', ...
'Tag', 'buttonDEKtable2', ...
'Callback', {@buttonDEKtablecancel, h} ...
);
h.buttonDEKtable3 = uicontrol( ...
'Parent', h.figDEKtable, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.475 0.05 0.2 0.12], ...
'String', 'Load data', ...
'Tag', 'buttonDEKtable3', ...
'Callback', {@buttonDEKtableload, h} ...
);
h.buttonDEKtable4 = uicontrol( ...
'Parent', h.figDEKtable, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.7 0.05 0.2 0.12], ...
'String', 'Save data', ...
'Tag', 'buttonDEKtable4', ...
'Callback', {@buttonDEKtablesave, h} ...
);    
d = zeros(20,5);
h.loadDEKtable = uitable(h.panelDEKtable, ...
'Units', 'Normalized', ...
'Position', [0.025 0.025 0.918 0.96], ...
'Tag', 'loadDEKtable', ...
'data', d, ...
'ColumnEditable', [false, false, false, true, true], ...
'ColumnWidth', {25 25 25 85 85}, ...
'CellEditCallback',{@celleditcallbackDEKtable}, ...
'ColumnName', {'h', 'k', 'l', 'S1', '1/2 S2'});



set(h.buttonDEKtable1,'callback',{@buttonDEKtableok, h})
set(h.buttonDEKtable2,'callback',{@buttonDEKtablecancel, h})
set(h.buttonDEKtable3,'callback',{@buttonDEKtableload, h})
set(h.buttonDEKtable4,'callback',{@buttonDEKtablesave, h})
set(h.loadDEKtable,'CellEditCallback',{@celleditcallbackDEKtable, h})
set(h.figDEKtable,'CloseRequestFcn',@my_Figclosereq)
% set(h.fighklstressplottable,'CloseRequestFcn',@my_Figclosereq)
% set(h.figSelectPeaktable,'CloseRequestFcn',@my_Figclosereq)

%% Create Peak selection table
h.figSelectPeaktable = figure('menubar','none','NumberTitle','off','Tag','SelectPeakTableGUI','units','normalized','Position',[0.3 0.6 0.12 0.25],'Visible','off');
% h.figSelectPeaktable = figure('menubar','none','NumberTitle','off','Tag','SelectPeakTableGUI','units','normalized','Position',[0.3 0.6 0.0935 0.15],'Visible','off');
set(gca,'Visible','off')

h.panelSelectPeaktable = uipanel( ...
'Parent', h.figSelectPeaktable, ...
'Units', 'Normalized', ...
'Position', [0.025 0.175 0.975 0.8], ...
'Title', 'Select peaks for analysis' ...
);

h.buttonSelectPeaktable1 = uicontrol( ...
'Parent', h.figSelectPeaktable, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.075 0.02 0.4 0.12], ...
'String', 'Ok', ...
'Tag', 'buttonSelectPeaktable1', ...
'Callback', {@buttonSelectPeaktableok, h} ...
);
h.buttonSelectPeaktable2 = uicontrol( ...
'Parent', h.figSelectPeaktable, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.525 0.02 0.4 0.12], ...
'String', 'Cancel', ...
'Tag', 'buttonSelectPeaktable2', ...
'Callback', {@buttonSelectPeaktablecancel, h} ...
); 

d = zeros(10,1);
idxdata = logical(false(10,1));
h.SelectPeaktable = uitable(h.panelSelectPeaktable, ...
'Units', 'Normalized', ...
'Position', [0.025 0.025 0.95 0.95], ...
'Tag', 'SelectPeaktable', ...
'data', [num2cell(d) num2cell(d) num2cell(d) num2cell(d) num2cell(idxdata)],...
'ColumnFormat', {[] [] [] [] 'logical'},...
'ColumnEditable', [false  false  false  false  true], ...
'ColumnWidth', {25 25 25 55 35}, ...
'CellEditCallback',{@celleditcallbackSelectPeaktable}, ...
'ColumnName', {'h', 'k', 'l','Energy', 'Use'});

% set(h.figSelectPeaktable,'CloseRequestFcn',@my_Figclosereq2)

%% Plot Fit Data Panel
% Plot fit data 1
h.plotwindowfitdata1 = uipanel( ...
'Parent', h.Tabs(4), ...
'Units', 'Normalized', ...
'Position', [0.005 0.50125 0.495 0.495], ...
'Title', 'Plot Fit Data' ...
);
% Create slider
h.Sliderplotwindowfitdata1 = uicontrol(...
    'Style','slider',...
    'Tag','Slider',...
    'Parent', h.plotwindowfitdata1,...
    'Units','normalized',...
    'Position', [0.6 0.0125 0.08 0.04],...
    'Min',0,...
    'Max', 1,...
    'Value',1,...
    'Callback',{@SliderCallbackPlotfitdata1, h});

% Empty data for plot    
x = 0;
y = 0;
err = 0;
% Create axes object to plot residual stress data
h.axesplotfitdata1 = axes('Parent', h.plotwindowfitdata1, 'Position', [0.3 0.16 0.675 0.75]);

hold(h.axesplotfitdata1,'on')

h.fitdata1plotphi0 = plot(h.axesplotfitdata1, x, y, 'Color','k','Marker','s','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');
h.fitdata1plotphi90 = plot(h.axesplotfitdata1, x, y, 'Color','k','Marker','o','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');
h.fitdata1plotphi180 = plot(h.axesplotfitdata1, x, y, 'Color','k','Marker','d','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');
h.fitdata1plotphi270 = plot(h.axesplotfitdata1, x, y, 'Color','k','Marker','p','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');
h.fitdata1ploterrphi0 = errorbar(h.axesplotfitdata1, x, y, err,'Linestyle','-','Color','k','Marker','s','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');
h.fitdata1ploterrphi90 = errorbar(h.axesplotfitdata1, x, y, err,'Linestyle','-','Color','k','Marker','o','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');
h.fitdata1ploterrphi180 = errorbar(h.axesplotfitdata1, x, y, err,'Linestyle','-','Color','k','Marker','d','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');
h.fitdata1ploterrphi270 = errorbar(h.axesplotfitdata1, x, y, err,'Linestyle','-','Color','k','Marker','p','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');

box(h.axesplotfitdata1,'on')
grid(h.axesplotfitdata1,'on')
hold(h.axesplotfitdata1,'off')
% Set plot properties
xlabel(h.axesplotfitdata1,'Choose Data')
ylabel(h.axesplotfitdata1,'Choose Data')
title(h.axesplotfitdata1,{'No measurement data loaded';'   '})

h.TextPlotData1 = uicontrol( ...
'Style', 'text',...
'Parent', h.plotwindowfitdata1,...
'Units','normalized',...
'Position', [0.03 0.89 0.18 0.04],...
'FontWeight', 'bold', ...
'String', 'Choose data to be plotted',...
'FontSize', 10,...
'HorizontalAlignment', 'left');    

h.TextXData1 = uicontrol( ...
'Style', 'text',...
'Parent', h.plotwindowfitdata1,...
'Units','normalized',...
'Position', [0.025 0.808 0.045 0.04],...
'FontWeight', 'bold', ...
'String', 'X-axis',...
'FontSize', 10,...
'HorizontalAlignment', 'left');     

% Popup menu to choose xdata for plotting
h.popupmenuXData1 = uicontrol( ...
'Parent', h.plotwindowfitdata1, ...
'Style', 'popupmenu', ...
'Units', 'Normalized', ...
'Position', [0.09 0.65 0.12 0.2], ...
'Tag', 'popupmenuXData1', ...
'String', {'Choose data','Psi','sin²Psi','Eta','sin²Eta','tau','Energy','Temperature','Scan number'}, ...
'Value', 1, ...
'Callback', {@CallbackpopupmenuXData1, h} ...
);

h.TextYData1 = uicontrol( ...
'Style', 'text',...
'Parent', h.plotwindowfitdata1,...
'Units','normalized',...
'Position', [0.025 0.748 0.045 0.04],...
'FontWeight', 'bold', ...
'String', 'Y-axis',...
'FontSize', 10,...
'HorizontalAlignment', 'left');     

% Popup menu to choose mpd file
h.popupmenuYData1 = uicontrol( ...
'Parent', h.plotwindowfitdata1, ...
'Style', 'popupmenu', ...
'Units', 'Normalized', ...
'Position', [0.09 0.59 0.12 0.2], ...
'Tag', 'popupmenuYData1', ...
'String', {'Choose data','d-spacing','Energy','Integral Breadth','FWHM','Weighting Factor','Form Factor','Int. Intensity','Max. Intensity'}, ...
'Value', 1, ...
'Callback', {@CallbackpopupmenuYData1, h} ...
);

h.buttonExportFitData1 = uicontrol( ...
'Parent', h.plotwindowfitdata1, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'FontSize', 11, ...
'Position', [0.04 0.4 0.14 0.06], ...
'String', 'Export Plots', ...
'Tag', 'buttonExportFitData1', ...
'Callback', {@buttonExportFitData1, h} ...
);

h.buttonClearFitData1 = uicontrol( ...
'Parent', h.plotwindowfitdata1, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'FontSize', 11, ...
'Position', [0.04 0.32 0.14 0.06], ...
'String', 'Clear Plots', ...
'Tag', 'buttonClearFitData1', ...
'Callback', {@buttonClearFitData1, h} ...
);

h.TextPhiData1 = uicontrol( ...
'Style', 'text',...
'Parent', h.plotwindowfitdata1,...
'Units','normalized',...
'Position', [0.063 0.63 0.15 0.04],...
'FontWeight', 'bold', ...
'String', 'Azimuth angle',...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.plotwindowfitdata1checkboxphi0 = uicontrol( ...
'Parent', h.plotwindowfitdata1, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.065 0.575 0.06 0.04], ...
'Tag', 'plotwindowfitdata1checkboxphi0', ...
'String', '0°', ...
'Value', 0, ...
'Callback', {@Callbackplotwindowfitdata1checkboxphi0} ...
);
h.plotwindowfitdata1checkboxphi90 = uicontrol( ...
'Parent', h.plotwindowfitdata1, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.065 0.515 0.06 0.04], ...
'Tag', 'plotwindowfitdata1checkboxphi90', ...
'String', '90°', ...
'Value', 0, ...
'Callback', {@Callbackplotwindowfitdata1checkboxphi90} ...
);
h.plotwindowfitdata1checkboxphi180 = uicontrol( ...
'Parent', h.plotwindowfitdata1, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.115 0.575 0.06 0.04], ...
'Tag', 'plotwindowfitdata1checkboxphi180', ...
'String', '180°', ...
'Value', 0, ...
'Callback', {@Callbackplotwindowfitdata1checkboxphi180} ...
);
h.plotwindowfitdata1checkboxphi270 = uicontrol( ...
'Parent', h.plotwindowfitdata1, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.115 0.515 0.06 0.04], ...
'Tag', 'plotwindowfitdata1checkboxphi270', ...
'String', '270°', ...
'Value', 0, ...
'Callback', {@Callbackplotwindowfitdata1checkboxphi270} ...
);


%% Plot fit data 2
h.plotwindowfitdata2 = uipanel( ...
'Parent', h.Tabs(4), ...
'Units', 'Normalized', ...
'Position', [0.005 0.00125 0.495 0.495], ...
'Title', 'Plot Fit Data' ...
);


% Create slider
h.Sliderplotwindowfitdata2 = uicontrol(...
    'Style','slider',...
    'Tag','Slider',...
    'Parent', h.plotwindowfitdata2,...
    'Units','normalized',...
    'Position', [0.6 0.0125 0.08 0.04],...
    'Min',0,...
    'Max', 1,...
    'Value',1,...
    'Callback',{@SliderCallbackPlotfitdata2, h});

% Empty data for plot    
x = 0;
y = 0;
err = 0;
% Create axes object to plot residual stress data
h.axesplotfitdata2 = axes('Parent', h.plotwindowfitdata2, 'Position', [0.3 0.16 0.675 0.75]);

hold(h.axesplotfitdata2,'on')

h.fitdata2plotphi0 = plot(h.axesplotfitdata2, x, y, 'Color','k','Marker','s','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');
h.fitdata2plotphi90 = plot(h.axesplotfitdata2, x, y, 'Color','k','Marker','o','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');
h.fitdata2plotphi180 = plot(h.axesplotfitdata2, x, y, 'Color','k','Marker','d','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');
h.fitdata2plotphi270 = plot(h.axesplotfitdata2, x, y, 'Color','k','Marker','p','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');
h.fitdata2ploterrphi0 = errorbar(h.axesplotfitdata2, x, y, err,'Linestyle','-','Color','k','Marker','s','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');
h.fitdata2ploterrphi90 = errorbar(h.axesplotfitdata2, x, y, err,'Linestyle','-','Color','k','Marker','o','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');
h.fitdata2ploterrphi180 = errorbar(h.axesplotfitdata2, x, y, err,'Linestyle','-','Color','k','Marker','d','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');
h.fitdata2ploterrphi270 = errorbar(h.axesplotfitdata2, x, y, err,'Linestyle','-','Color','k','Marker','p','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');

box(h.axesplotfitdata2,'on')
grid(h.axesplotfitdata2,'on')
hold(h.axesplotfitdata2,'off')
% Set plot properties
xlabel(h.axesplotfitdata2,'Choose Data')
ylabel(h.axesplotfitdata2,'Choose Data')
title(h.axesplotfitdata2,{'No measurement data loaded';'   '})

h.TextPlotData2 = uicontrol( ...
'Style', 'text',...
'Parent', h.plotwindowfitdata2,...
'Units','normalized',...
'Position', [0.03 0.89 0.18 0.04],...
'FontWeight', 'bold', ...
'String', 'Choose data to be plotted',...
'FontSize', 10,...
'HorizontalAlignment', 'left');    

h.TextXData2 = uicontrol( ...
'Style', 'text',...
'Parent', h.plotwindowfitdata2,...
'Units','normalized',...
'Position', [0.025 0.808 0.045 0.04],...
'FontWeight', 'bold', ...
'String', 'X-axis',...
'FontSize', 10,...
'HorizontalAlignment', 'left');     

% Popup menu to choose xdata for plotting
h.popupmenuXData2 = uicontrol( ...
'Parent', h.plotwindowfitdata2, ...
'Style', 'popupmenu', ...
'Units', 'Normalized', ...
'Position', [0.09 0.65 0.12 0.2], ...
'Tag', 'popupmenuXData1', ...
'String', {'Choose data','Psi','sin²Psi','Eta','sin²Eta','tau','Energy','Temperature','Scan number'}, ...
'Value', 1, ...
'Callback', {@CallbackpopupmenuXData2, h} ...
);

h.TextYData2 = uicontrol( ...
'Style', 'text',...
'Parent', h.plotwindowfitdata2,...
'Units','normalized',...
'Position', [0.025 0.748 0.045 0.04],...
'FontWeight', 'bold', ...
'String', 'Y-axis',...
'FontSize', 10,...
'HorizontalAlignment', 'left');     

% Popup menu to choose mpd file
h.popupmenuYData2 = uicontrol( ...
'Parent', h.plotwindowfitdata2, ...
'Style', 'popupmenu', ...
'Units', 'Normalized', ...
'Position', [0.09 0.59 0.12 0.2], ...
'Tag', 'popupmenuYData1', ...
'String', {'Choose data','d-spacing','Energy','Integral Breadth','FWHM','Weighting Factor','Form Factor','Int. Intensity','Max. Intensity'}, ...
'Value', 1, ...
'Callback', {@CallbackpopupmenuYData2, h} ...
);

h.buttonExportFitData2 = uicontrol( ...
'Parent', h.plotwindowfitdata2, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'FontSize', 11, ...
'Position', [0.04 0.4 0.14 0.06], ...
'String', 'Export Plots', ...
'Tag', 'buttonExportFitData1', ...
'Callback', {@buttonExportFitData2, h} ...
);

h.buttonClearFitData2 = uicontrol( ...
'Parent', h.plotwindowfitdata2, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'FontSize', 11, ...
'Position', [0.04 0.32 0.14 0.06], ...
'String', 'Clear Plots', ...
'Tag', 'buttonClearFitData1', ...
'Callback', {@buttonClearFitData2, h} ...
);

h.TextPhiData2 = uicontrol( ...
'Style', 'text',...
'Parent', h.plotwindowfitdata2,...
'Units','normalized',...
'Position', [0.063 0.63 0.15 0.04],...
'FontWeight', 'bold', ...
'String', 'Azimuth angle',...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.plotwindowfitdata2checkboxphi0 = uicontrol( ...
'Parent', h.plotwindowfitdata2, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.065 0.575 0.06 0.04], ...
'Tag', 'plotwindowfitdata2checkboxphi0', ...
'String', '0°', ...
'Value', 0, ...
'Callback', {@Callbackplotwindowfitdata2checkboxphi0} ...
);
h.plotwindowfitdata2checkboxphi90 = uicontrol( ...
'Parent', h.plotwindowfitdata2, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.065 0.515 0.06 0.04], ...
'Tag', 'plotwindowfitdata2checkboxphi90', ...
'String', '90°', ...
'Value', 0, ...
'Callback', {@Callbackplotwindowfitdata2checkboxphi90} ...
);
h.plotwindowfitdata2checkboxphi180 = uicontrol( ...
'Parent', h.plotwindowfitdata2, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.115 0.575 0.06 0.04], ...
'Tag', 'plotwindowfitdata2checkboxphi180', ...
'String', '180°', ...
'Value', 0, ...
'Callback', {@Callbackplotwindowfitdata2checkboxphi180} ...
);
h.plotwindowfitdata2checkboxphi270 = uicontrol( ...
'Parent', h.plotwindowfitdata2, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.115 0.515 0.06 0.04], ...
'Tag', 'plotwindowfitdata2checkboxphi270', ...
'String', '270°', ...
'Value', 0, ...
'Callback', {@Callbackplotwindowfitdata2checkboxphi270} ...
);


%% Plot fit data 3
h.plotwindowfitdata3 = uipanel( ...
'Parent', h.Tabs(4), ...
'Units', 'Normalized', ...
'Position', [0.5025 0.50125 0.495 0.495], ...
'Title', 'Plot Fit Data' ...
);
% Create slider
h.Sliderplotwindowfitdata3 = uicontrol(...
    'Style','slider',...
    'Tag','Slider',...
    'Parent', h.plotwindowfitdata3,...
    'Units','normalized',...
    'Position', [0.6 0.0125 0.08 0.04],...
    'Min',0,...
    'Max', 1,...
    'Value',1,...
    'Callback',{@SliderCallbackPlotfitdata3, h});

% Empty data for plot    
x = 0;
y = 0;
err = 0;
% Create axes object to plot residual stress data
h.axesplotfitdata3 = axes('Parent', h.plotwindowfitdata3, 'Position', [0.3 0.16 0.675 0.75]);

hold(h.axesplotfitdata3,'on')

h.fitdata3plotphi0 = plot(h.axesplotfitdata3, x, y, 'Color','k','Marker','s','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');
h.fitdata3plotphi90 = plot(h.axesplotfitdata3, x, y, 'Color','k','Marker','o','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');
h.fitdata3plotphi180 = plot(h.axesplotfitdata3, x, y, 'Color','k','Marker','d','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');
h.fitdata3plotphi270 = plot(h.axesplotfitdata3, x, y, 'Color','k','Marker','p','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');
h.fitdata3ploterrphi0 = errorbar(h.axesplotfitdata3, x, y, err,'Linestyle','-','Color','k','Marker','s','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');
h.fitdata3ploterrphi90 = errorbar(h.axesplotfitdata3, x, y, err,'Linestyle','-','Color','k','Marker','o','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');
h.fitdata3ploterrphi180 = errorbar(h.axesplotfitdata3, x, y, err,'Linestyle','-','Color','k','Marker','d','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');
h.fitdata3ploterrphi270 = errorbar(h.axesplotfitdata3, x, y, err,'Linestyle','-','Color','k','Marker','p','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');

box(h.axesplotfitdata3,'on')
grid(h.axesplotfitdata3,'on')
hold(h.axesplotfitdata3,'off')
% Set plot properties
xlabel(h.axesplotfitdata3,'Choose Data')
ylabel(h.axesplotfitdata3,'Choose Data')
title(h.axesplotfitdata3,{'No measurement data loaded';'   '})

h.TextPlotData3 = uicontrol( ...
'Style', 'text',...
'Parent', h.plotwindowfitdata3,...
'Units','normalized',...
'Position', [0.03 0.89 0.18 0.04],...
'FontWeight', 'bold', ...
'String', 'Choose data to be plotted',...
'FontSize', 10,...
'HorizontalAlignment', 'left');    

h.TextXData3 = uicontrol( ...
'Style', 'text',...
'Parent', h.plotwindowfitdata3,...
'Units','normalized',...
'Position', [0.025 0.808 0.045 0.04],...
'FontWeight', 'bold', ...
'String', 'X-axis',...
'FontSize', 10,...
'HorizontalAlignment', 'left');     

% Popup menu to choose xdata for plotting
h.popupmenuXData3 = uicontrol( ...
'Parent', h.plotwindowfitdata3, ...
'Style', 'popupmenu', ...
'Units', 'Normalized', ...
'Position', [0.09 0.65 0.12 0.2], ...
'Tag', 'popupmenuXData1', ...
'String', {'Choose data','Psi','sin²Psi','Eta','sin²Eta','tau','Energy','Temperature','Scan number'}, ...
'Value', 1, ...
'Callback', {@CallbackpopupmenuXData3, h} ...
);

h.TextYData3 = uicontrol( ...
'Style', 'text',...
'Parent', h.plotwindowfitdata3,...
'Units','normalized',...
'Position', [0.025 0.748 0.045 0.04],...
'FontWeight', 'bold', ...
'String', 'Y-axis',...
'FontSize', 10,...
'HorizontalAlignment', 'left');     

% Popup menu to choose mpd file
h.popupmenuYData3 = uicontrol( ...
'Parent', h.plotwindowfitdata3, ...
'Style', 'popupmenu', ...
'Units', 'Normalized', ...
'Position', [0.09 0.59 0.12 0.2], ...
'Tag', 'popupmenuYData1', ...
'String', {'Choose data','d-spacing','Energy','Integral Breadth','FWHM','Weighting Factor','Form Factor','Int. Intensity','Max. Intensity'}, ...
'Value', 1, ...
'Callback', {@CallbackpopupmenuYData3, h} ...
);

h.buttonExportFitData3 = uicontrol( ...
'Parent', h.plotwindowfitdata3, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'FontSize', 11, ...
'Position', [0.04 0.4 0.14 0.06], ...
'String', 'Export Plots', ...
'Tag', 'buttonExportFitData1', ...
'Callback', {@buttonExportFitData3, h} ...
);

h.buttonClearFitData3 = uicontrol( ...
'Parent', h.plotwindowfitdata3, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'FontSize', 11, ...
'Position', [0.04 0.32 0.14 0.06], ...
'String', 'Clear Plots', ...
'Tag', 'buttonClearFitData1', ...
'Callback', {@buttonClearFitData3, h} ...
);

h.TextPhiData3 = uicontrol( ...
'Style', 'text',...
'Parent', h.plotwindowfitdata3,...
'Units','normalized',...
'Position', [0.063 0.63 0.15 0.04],...
'FontWeight', 'bold', ...
'String', 'Azimuth angle',...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.plotwindowfitdata3checkboxphi0 = uicontrol( ...
'Parent', h.plotwindowfitdata3, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.065 0.575 0.06 0.04], ...
'Tag', 'plotwindowfitdata3checkboxphi0', ...
'String', '0°', ...
'Value', 0, ...
'Callback', {@Callbackplotwindowfitdata3checkboxphi0} ...
);
h.plotwindowfitdata3checkboxphi90 = uicontrol( ...
'Parent', h.plotwindowfitdata3, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.065 0.515 0.06 0.04], ...
'Tag', 'plotwindowfitdata3checkboxphi90', ...
'String', '90°', ...
'Value', 0, ...
'Callback', {@Callbackplotwindowfitdata3checkboxphi90} ...
);
h.plotwindowfitdata3checkboxphi180 = uicontrol( ...
'Parent', h.plotwindowfitdata3, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.115 0.575 0.06 0.04], ...
'Tag', 'plotwindowfitdata3checkboxphi180', ...
'String', '180°', ...
'Value', 0, ...
'Callback', {@Callbackplotwindowfitdata3checkboxphi180} ...
);
h.plotwindowfitdata3checkboxphi270 = uicontrol( ...
'Parent', h.plotwindowfitdata3, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.115 0.515 0.06 0.04], ...
'Tag', 'plotwindowfitdata3checkboxphi270', ...
'String', '270°', ...
'Value', 0, ...
'Callback', {@Callbackplotwindowfitdata3checkboxphi270} ...
);


%% Plot fit data 4
h.plotwindowfitdata4 = uipanel( ...
'Parent', h.Tabs(4), ...
'Units', 'Normalized', ...
'Position', [0.5025 0.0025 0.495 0.495], ...
'Title', 'Plot Fit Data' ...
);

% Create slider
h.Sliderplotwindowfitdata4 = uicontrol(...
    'Style','slider',...
    'Tag','Slider',...
    'Parent', h.plotwindowfitdata4,...
    'Units','normalized',...
    'Position', [0.6 0.0125 0.08 0.04],...
    'Min',0,...
    'Max', 1,...
    'Value',1,...
    'Callback',{@SliderCallbackPlotfitdata4, h});

% Empty data for plot    
x = 0;
y = 0;
err = 0;
% Create axes object to plot residual stress data
h.axesplotfitdata4 = axes('Parent', h.plotwindowfitdata4, 'Position', [0.3 0.16 0.675 0.75]);

hold(h.axesplotfitdata4,'on')

h.fitdata4plotphi0 = plot(h.axesplotfitdata4, x, y, 'Color','k','Marker','s','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');
h.fitdata4plotphi90 = plot(h.axesplotfitdata4, x, y, 'Color','k','Marker','o','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');
h.fitdata4plotphi180 = plot(h.axesplotfitdata4, x, y, 'Color','k','Marker','d','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');
h.fitdata4plotphi270 = plot(h.axesplotfitdata4, x, y, 'Color','k','Marker','p','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');
h.fitdata4ploterrphi0 = errorbar(h.axesplotfitdata4, x, y, err,'Linestyle','-','Color','k','Marker','s','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');
h.fitdata4ploterrphi90 = errorbar(h.axesplotfitdata4, x, y, err,'Linestyle','-','Color','k','Marker','o','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');
h.fitdata4ploterrphi180 = errorbar(h.axesplotfitdata4, x, y, err,'Linestyle','-','Color','k','Marker','d','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');
h.fitdata4ploterrphi270 = errorbar(h.axesplotfitdata4, x, y, err,'Linestyle','-','Color','k','Marker','p','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');

box(h.axesplotfitdata4,'on')
grid(h.axesplotfitdata4,'on')
hold(h.axesplotfitdata4,'off')
% Set plot properties
xlabel(h.axesplotfitdata4,'Choose Data')
ylabel(h.axesplotfitdata4,'Choose Data')
title(h.axesplotfitdata4,{'No measurement data loaded';'   '})

h.TextPlotData4 = uicontrol( ...
'Style', 'text',...
'Parent', h.plotwindowfitdata4,...
'Units','normalized',...
'Position', [0.03 0.89 0.18 0.04],...
'FontWeight', 'bold', ...
'String', 'Choose data to be plotted',...
'FontSize', 10,...
'HorizontalAlignment', 'left');    

h.TextXData4 = uicontrol( ...
'Style', 'text',...
'Parent', h.plotwindowfitdata4,...
'Units','normalized',...
'Position', [0.025 0.808 0.045 0.04],...
'FontWeight', 'bold', ...
'String', 'X-axis',...
'FontSize', 10,...
'HorizontalAlignment', 'left');     

% Popup menu to choose xdata for plotting
h.popupmenuXData4 = uicontrol( ...
'Parent', h.plotwindowfitdata4, ...
'Style', 'popupmenu', ...
'Units', 'Normalized', ...
'Position', [0.09 0.65 0.12 0.2], ...
'Tag', 'popupmenuXData1', ...
'String', {'Choose data','Psi','sin²Psi','Eta','sin²Eta','tau','Energy','Temperature','Scan number'}, ...
'Value', 1, ...
'Callback', {@CallbackpopupmenuXData4, h} ...
);

h.TextYData4 = uicontrol( ...
'Style', 'text',...
'Parent', h.plotwindowfitdata4,...
'Units','normalized',...
'Position', [0.025 0.748 0.045 0.04],...
'FontWeight', 'bold', ...
'String', 'Y-axis',...
'FontSize', 10,...
'HorizontalAlignment', 'left');     

% Popup menu to choose mpd file
h.popupmenuYData4 = uicontrol( ...
'Parent', h.plotwindowfitdata4, ...
'Style', 'popupmenu', ...
'Units', 'Normalized', ...
'Position', [0.09 0.59 0.12 0.2], ...
'Tag', 'popupmenuYData1', ...
'String', {'Choose data','d-spacing','Energy','Integral Breadth','FWHM','Weighting Factor','Form Factor','Int. Intensity','Max. Intensity'}, ...
'Value', 1, ...
'Callback', {@CallbackpopupmenuYData4, h} ...
);

h.buttonExportFitData4 = uicontrol( ...
'Parent', h.plotwindowfitdata4, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'FontSize', 11, ...
'Position', [0.04 0.4 0.14 0.06], ...
'String', 'Export Plots', ...
'Tag', 'buttonExportFitData1', ...
'Callback', {@buttonExportFitData4, h} ...
);

h.buttonClearFitData4 = uicontrol( ...
'Parent', h.plotwindowfitdata4, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'FontSize', 11, ...
'Position', [0.04 0.32 0.14 0.06], ...
'String', 'Clear Plots', ...
'Tag', 'buttonClearFitData1', ...
'Callback', {@buttonClearFitData4, h} ...
);

h.TextPhiData4 = uicontrol( ...
'Style', 'text',...
'Parent', h.plotwindowfitdata4,...
'Units','normalized',...
'Position', [0.063 0.63 0.15 0.04],...
'FontWeight', 'bold', ...
'String', 'Azimuth angle',...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.plotwindowfitdata4checkboxphi0 = uicontrol( ...
'Parent', h.plotwindowfitdata4, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.065 0.575 0.06 0.04], ...
'Tag', 'plotwindowfitdata4checkboxphi0', ...
'String', '0°', ...
'Value', 0, ...
'Callback', {@Callbackplotwindowfitdata4checkboxphi0} ...
);
h.plotwindowfitdata4checkboxphi90 = uicontrol( ...
'Parent', h.plotwindowfitdata4, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.065 0.515 0.06 0.04], ...
'Tag', 'plotwindowfitdata4checkboxphi90', ...
'String', '90°', ...
'Value', 0, ...
'Callback', {@Callbackplotwindowfitdata4checkboxphi90} ...
);
h.plotwindowfitdata4checkboxphi180 = uicontrol( ...
'Parent', h.plotwindowfitdata4, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.115 0.575 0.06 0.04], ...
'Tag', 'plotwindowfitdata4checkboxphi180', ...
'String', '180°', ...
'Value', 0, ...
'Callback', {@Callbackplotwindowfitdata4checkboxphi180} ...
);
h.plotwindowfitdata4checkboxphi270 = uicontrol( ...
'Parent', h.plotwindowfitdata4, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.115 0.515 0.06 0.04], ...
'Tag', 'plotwindowfitdata4checkboxphi270', ...
'String', '270°', ...
'Value', 0, ...
'Callback', {@Callbackplotwindowfitdata4checkboxphi270} ...
);

%% Universal plot tab
h.uplotoptionspanel = uipanel( ...
'Parent', h.Tabs(3), ...
'Units', 'Normalized', ...
'Position', [0.0025 0.0025 0.185 0.9975], ...
'Title', 'Universal Plot - Preferences' ...
);

%% Button to load table data
h.buttonloaduplotdata1 = uicontrol( ...
'Parent', h.uplotoptionspanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'FontSize', 9, ...
'Position', [0.0325 0.9575 0.4 0.03], ...
'String', 'Load fit data', ...
'Tag', 'buttonloaduplotdata1', ...
'Callback', {@buttonloaduplotdata1} ...
);

%% Table with hkl and d-spacing data
d = zeros(8,5);
idxdata = d(:,1)>0;
h.tableuplotdspacing = uitable(h.uplotoptionspanel, ...
'Units', 'Normalized', ...
'Position', [0.0325 0.83 0.9115 0.1125], ...
'Tag', 'tableuplotdspacing', ...
'data', [num2cell(d) num2cell(idxdata)],...
'ColumnEditable', [false false false false true true], ...
'ColumnWidth',{50}, ...
'ColumnWidth', {25 25 25 82 82 30}, ...
'CellEditCallback',{@celleditcallbacktableuplotdspacing}, ...
'ColumnName', {'h', 'k', 'l', 'd0(fit)', 'd0(user)', 'Use'});

%% Define sample thickness
h.textsamplethickness = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.0325 0.79 0.5 0.0225],...
'String', 'Sample thickness [mm]',...
'FontSize', 9,...
'FontWeight', 'bold',...
'HorizontalAlignment', 'left');    

h.editsamplethickness  = uicontrol('Style','edit',...
'String', 'Infinity',...
'Enable', 'on',...
'FontSize', 9,...
'Tag', 'editsamplethickness',...
'Units','normalized',...
'Position',[0.45 0.7925 0.225 0.0225],...
'Parent',h.uplotoptionspanel);

%% Use user defined d0 values
h.textuserdzero = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.0325 0.755 0.5 0.0225],...
'String', 'Use user defined d0 values',...
'FontSize', 9,...
'FontWeight', 'bold',...
'HorizontalAlignment', 'left');    

h.userdzerocheckbox = uicontrol( ...
'Parent', h.uplotoptionspanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.5 0.75 0.06 0.04], ...
'Tag', 'userdzerocheckbox', ...
'Value', 0 ...
);

%% Define d0(z) gradient
h.textdzerozgradient = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.0325 0.72 0.5 0.0225],...
'String', 'Consider d0(z) gradient',...
'FontSize', 9,...
'FontWeight', 'bold',...
'HorizontalAlignment', 'left');

h.dzerozgradientcheckbox = uicontrol( ...
'Parent', h.uplotoptionspanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.45 0.715 0.06 0.04], ...
'Tag', 'dzerozgradientcheckbox', ...
'Value', 0, ...
'Callback', {@Callbackdzerozgradientcheckbox} ...
);

h.textsdzeropoly1 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.03 0.6875 0.15 0.0225],...
'String', 'd0(z) =',...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.editdzeropoly1  = uicontrol('Style','edit',...
'String', '0',...
'FontSize', 10,...
'Tag', 'editdzeropoly1',...
'Units','normalized',...
'Position',[0.16 0.69 0.18 0.0225],...
'Parent',h.uplotoptionspanel);

h.textsdzeropoly2 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.36 0.6875 0.05 0.0225],...
'String', '+',...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.editdzeropoly2  = uicontrol('Style','edit',...
'String', '0',...
'FontSize', 10,...
'Tag', 'editdzeropoly2',...
'Units','normalized',...
'Position',[0.41 0.69 0.18 0.0225],...
'Parent',h.uplotoptionspanel);

h.textsdzeropoly3 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.6 0.6875 0.1 0.0225],...
'String', '*z +',...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.editdzeropoly3  = uicontrol('Style','edit',...
'String', '0',...
'FontSize', 10,...
'Tag', 'editdzeropoly3',...
'Units','normalized',...
'Position',[0.69 0.69 0.18 0.0225],...
'Parent',h.uplotoptionspanel);

h.textsdzeropoly4 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.88 0.6875 0.1 0.0225],...
'String', '*z',...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.textsdzeropoly5 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.915 0.688 0.1 0.0225],...
'String', '2',...
'FontSize', 8,...
'HorizontalAlignment', 'left');

%% Define sin²psi range
h.textsin2psirange = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.0325 0.64 0.9 0.0225],...
'String', ['Define sin²',char(968),' range, for which data should be plotted'],...
'FontSize', 9,...
'FontWeight', 'bold',...
'HorizontalAlignment', 'left');

h.textsin2psirange1 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.03 0.6125 0.18 0.0225],...
'String', ['min sin²',char(968)],...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.editsin2psirange1 = uicontrol('Style','edit',...
'String', '0.4',...
'FontSize', 9,...
'Tag', 'editsin2psirange1',...
'Units','normalized',...
'Position',[0.225 0.61475 0.2 0.0225],...
'Parent',h.uplotoptionspanel);

h.textsin2psirange2 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.46 0.6125 0.18 0.0225],...
'String', ['max sin²',char(968)],...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.editsin2psirange2 = uicontrol('Style','edit',...
'String', '0.99',...
'FontSize', 9,...
'Tag', 'editsin2psirange2',...
'Units','normalized',...
'Position',[0.67 0.61475 0.2 0.0225],...
'Parent',h.uplotoptionspanel);

%% Data filter options
%% Filter sigma11
h.textfilter1 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.35 0.57 0.9 0.0225],...
'String', 'Filter options',...
'FontSize', 11,...
'FontWeight', 'bold',...
'HorizontalAlignment', 'left');

h.filteruplotdatacheckbox = uicontrol( ...
'Parent', h.uplotoptionspanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.22 0.5401 0.06 0.04], ...
'Tag', 'filteruplotdatacheckbox', ...
'Value', 1 ...
);

h.textfilter2 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.28 0.545 0.4 0.0225],...
'String', 'Delete data points with',...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.textfilter1sigma11 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.08 0.5135 0.15 0.0225],...
'String', [char(916),char(963),char(8321),char(8321),' >'],...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.editfilter1sigma11 = uicontrol('Style','edit',...
'String', '500',...
'FontSize', 9,...
'Tag', 'editfilter1sigma11',...
'Units','normalized',...
'Position',[0.21 0.51575 0.1 0.0225],...
'Parent',h.uplotoptionspanel);

h.textfilter2sigma11 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.325 0.5135 0.15 0.0225],...
'String', '[MPa]',...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.textfilter3sigma11 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.02 0.4785 0.15 0.0225],...
'String', [char(916),char(963),char(8321),char(8321),' >'],...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.editfilter2sigma11 = uicontrol('Style','edit',...
'String', '4',...
'FontSize', 9,...
'Tag', 'editfilter2sigma11',...
'Units','normalized',...
'Position',[0.15 0.48075 0.07 0.0225],...
'Parent',h.uplotoptionspanel);

h.textfilter4sigma11 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.225 0.4785 0.3 0.0225],...
'String', ['* mean (',char(916),char(963),char(8321),char(8321),')'],...
'FontSize', 10,...
'HorizontalAlignment', 'left');

%% Filter sigma13
h.textfilter1sigma13 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.08 0.4335 0.15 0.0225],...
'String', [char(916),char(963),char(8321),char(8323),' >'],...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.editfilter1sigma13 = uicontrol('Style','edit',...
'String', '500',...
'FontSize', 9,...
'Tag', 'editfilter1sigma13',...
'Units','normalized',...
'Position',[0.21 0.43575 0.1 0.0225],...
'Parent',h.uplotoptionspanel);

h.textfilter2sigma13 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.325 0.4335 0.15 0.0225],...
'String', '[MPa]',...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.textfilter3sigma13 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.02 0.3985 0.15 0.0225],...
'String', [char(916),char(963),char(8321),char(8323),' >'],...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.editfilter2sigma13 = uicontrol('Style','edit',...
'String', '4',...
'FontSize', 9,...
'Tag', 'editfilter2sigma13',...
'Units','normalized',...
'Position',[0.15 0.40075 0.07 0.0225],...
'Parent',h.uplotoptionspanel);

h.textfilter4sigma13 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.225 0.3985 0.3 0.0225],...
'String', ['* mean (',char(916),char(963),char(8321),char(8323),')'],...
'FontSize', 10,...
'HorizontalAlignment', 'left');

%% Filter sigma22
h.textfilter1sigma22 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.58 0.5135 0.15 0.0225],...
'String', [char(916),char(963),char(8322),char(8322),' >'],...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.editfilter1sigma22 = uicontrol('Style','edit',...
'String', '500',...
'FontSize', 9,...
'Tag', 'editfilter1sigma22',...
'Units','normalized',...
'Position',[0.71 0.51575 0.1 0.0225],...
'Parent',h.uplotoptionspanel);

h.textfilter2sigma22 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.825 0.5135 0.15 0.0225],...
'String', '[MPa]',...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.textfilter3sigma22 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.52 0.4785 0.15 0.0225],...
'String', [char(916),char(963),char(8322),char(8322),' >'],...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.editfilter2sigma22 = uicontrol('Style','edit',...
'String', '4',...
'FontSize', 9,...
'Tag', 'editfilter2sigma22',...
'Units','normalized',...
'Position',[0.65 0.48075 0.07 0.0225],...
'Parent',h.uplotoptionspanel);

h.textfilter4sigma22 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.725 0.4785 0.3 0.0225],...
'String', ['* mean (',char(916),char(963),char(8322),char(8322),')'],...
'FontSize', 10,...
'HorizontalAlignment', 'left');

%% Filter sigma23
h.textfilter1sigma23 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.58 0.4335 0.15 0.0225],...
'String', [char(916),char(963),char(8322),char(8323),' >'],...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.editfilter1sigma23 = uicontrol('Style','edit',...
'String', '500',...
'FontSize', 9,...
'Tag', 'editfilter1sigma23',...
'Units','normalized',...
'Position',[0.71 0.43575 0.1 0.0225],...
'Parent',h.uplotoptionspanel);

h.textfilter2sigma23 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.825 0.4335 0.15 0.0225],...
'String', '[MPa]',...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.textfilter3sigma23 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.52 0.3985 0.15 0.0225],...
'String', [char(916),char(963),char(8322),char(8323),' >'],...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.editfilter2sigma23 = uicontrol('Style','edit',...
'String', '4',...
'FontSize', 9,...
'Tag', 'editfilter2sigma23',...
'Units','normalized',...
'Position',[0.65 0.40075 0.07 0.0225],...
'Parent',h.uplotoptionspanel);

h.textfilter4sigma23 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.725 0.3985 0.3 0.0225],...
'String', ['* mean (',char(916),char(963),char(8322),char(8323),')'],...
'FontSize', 10,...
'HorizontalAlignment', 'left');

%% Define fit options
h.textsin2psirange = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.0325 0.36 0.9 0.0225],...
'String', 'Fit properties',...
'FontSize', 11,...
'FontWeight', 'bold',...
'HorizontalAlignment', 'center');

h.uplotplotfitscheckbox = uicontrol( ...
'Parent', h.uplotoptionspanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.1 0.325 0.06 0.04], ...
'Tag', 'uplotplotfitscheckbox', ...
'Value', 1 ...
);

% Fit stress distributions
h.textplotfits1 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.165 0.33 0.9 0.0225],...
'String', 'Fit stress distributions with polynomial',...
'FontSize', 10,...
'HorizontalAlignment', 'left');

%% Fit sigma11 stress component
h.textplotfits11 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.1 0.3 0.9 0.0225],...
'String', 'Fit of',...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.textplotfits12 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.203 0.301 0.9 0.0225],...
'String', [char(963),char(8321),char(8321)],...
'FontSize', 11,...
'HorizontalAlignment', 'left');

h.textplotfits13 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.28 0.30 0.9 0.0225],...
'String', 'using',...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.textdegreepoly1 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.11 0.2685 0.15 0.0225],...
'String', 'Degree',...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.editdegree1 = uicontrol('Style','edit',...
'String', '1',...
'FontSize', 9,...
'Tag', 'editdegree1',...
'Units','normalized',...
'Position',[0.255 0.27075 0.1 0.0225],...
'Parent',h.uplotoptionspanel);

h.dampingcheckbox1 = uicontrol( ...
'Parent', h.uplotoptionspanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.29 0.245 0.06 0.02], ...
'Tag', 'dampingcheckbox1', ...
'Value', 1 ...
);

h.textdamping1 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.11 0.24 0.18 0.0225],...
'String', 'Damping',...
'FontSize', 10,...
'HorizontalAlignment', 'left');

%% Fit sigma22 stress component
h.textplotfits21 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.55 0.3 0.9 0.0225],...
'String', 'Fit of',...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.textplotfits22 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.653 0.301 0.15 0.0225],...
'String', [char(963),char(8322),char(8322)],...
'FontSize', 11,...
'HorizontalAlignment', 'left');

h.textplotfits23 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.73 0.3 0.15 0.0225],...
'String', 'using',...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.textdegreepoly2 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.56 0.2685 0.15 0.0225],...
'String', 'Degree',...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.editdegree2  = uicontrol('Style','edit',...
'String', '1',...
'FontSize', 9,...
'Tag', 'editdegree2',...
'Units','normalized',...
'Position',[0.705 0.27075 0.1 0.0225],...
'Parent',h.uplotoptionspanel);

h.dampingcheckbox2 = uicontrol( ...
'Parent', h.uplotoptionspanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.74 0.245 0.06 0.02], ...
'Tag', 'dampingcheckbox1', ...
'Value', 1 ...
);

h.textdamping2 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.56 0.24 0.18 0.0225],...
'String', 'Damping',...
'FontSize', 10,...
'HorizontalAlignment', 'left');

%% Fit sigma13 stress component
h.textplotfits31 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.1 0.21 0.9 0.0225],...
'String', 'Fit of',...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.textplotfits32 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.203 0.211 0.9 0.0225],...
'String', [char(963),char(8321),char(8323)],...
'FontSize', 11,...
'HorizontalAlignment', 'left');

h.textplotfits33 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.28 0.21 0.9 0.0225],...
'String', 'using',...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.textdegreepoly3 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.11 0.1785 0.15 0.0225],...
'String', 'Degree',...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.editdegree3 = uicontrol('Style','edit',...
'String', '1',...
'FontSize', 9,...
'Tag', 'editdegree3',...
'Units','normalized',...
'Position',[0.255 0.18075 0.1 0.0225],...
'Parent',h.uplotoptionspanel);

h.dampingcheckbox3 = uicontrol( ...
'Parent', h.uplotoptionspanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.29 0.155 0.06 0.02], ...
'Tag', 'dampingcheckbox3', ...
'Value', 1 ...
);

h.textdamping3 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.11 0.15 0.18 0.0225],...
'String', 'Damping',...
'FontSize', 10,...
'HorizontalAlignment', 'left');

%% Fit sigma23 stress component
h.textplotfits41 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.55 0.21 0.9 0.0225],...
'String', 'Fit of',...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.textplotfits42 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.653 0.211 0.15 0.0225],...
'String', [char(963),char(8322),char(8323)],...
'FontSize', 11,...
'HorizontalAlignment', 'left');

h.textplotfits43 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.73 0.21 0.15 0.0225],...
'String', 'using',...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.textdegreepoly4 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.56 0.1785 0.15 0.0225],...
'String', 'Degree',...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.editdegree4 = uicontrol('Style','edit',...
'String', '1',...
'FontSize', 9,...
'Tag', 'editdegree4',...
'Units','normalized',...
'Position',[0.705 0.18075 0.1 0.0225],...
'Parent',h.uplotoptionspanel);

h.dampingcheckbox4 = uicontrol( ...
'Parent', h.uplotoptionspanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.74 0.155 0.06 0.02], ...
'Tag', 'dampingcheckbox4', ...
'Value', 1 ...
);

h.textdamping4 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.56 0.15 0.18 0.0225],...
'String', 'Damping',...
'FontSize', 10,...
'HorizontalAlignment', 'left');

%% Show or hide CI95 intervals
h.ShowCIboundscheckbox = uicontrol( ...
'Parent', h.uplotoptionspanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.3 0.095 0.06 0.04], ...
'Tag', 'ShowCIboundscheckbox', ...
'Value', 0, ...
'Callback', {@ShowCIboundscheckbox} ...
);

h.textplotfits1 = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.365 0.10 0.9 0.0225],...
'String', 'Show 95% confidence bounds',...
'FontSize', 10,...
'HorizontalAlignment', 'left');

%% Buttons
h.buttonplotuplotdata = uicontrol( ...
'Parent', h.uplotoptionspanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'FontSize', 9, ...
'Position', [0.07 0.10 0.2 0.03], ...
'String', 'Plot data', ...
'Tag', 'buttonplotuplotdata', ...
'Callback', {@buttonplotuplotdata} ...
);

h.buttonplotdsin2psi = uicontrol( ...
'Parent', h.uplotoptionspanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'FontSize', 9, ...
'Position', [0.07 0.06 0.475 0.03], ...
'String', ['Plot d - sin²',char(968),' distributions'], ...
'Tag', 'buttonplotdsin2psi', ...
'Callback', {@buttonplotdsin2psi} ...
);

h.exportrecalcdcheckbox = uicontrol( ...
'Parent', h.uplotoptionspanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.58 0.055 0.06 0.04], ...
'Tag', 'exportrecalcdcheckbox', ...
'Value', 1 ...
);

h.textexportrecalcd = uicontrol('Style', 'text',...
'Parent', h.uplotoptionspanel,...
'Units','normalized',...
'Position', [0.644 0.06 0.9 0.0225],...
'String', 'Export plots',...
'FontSize', 10,...
'HorizontalAlignment', 'left');

h.buttonclearuplotdata = uicontrol( ...
'Parent', h.uplotoptionspanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'FontSize', 9, ...
'Position', [0.35 0.02 0.275 0.03], ...
'String', 'Clear data', ...
'Tag', 'buttonclearuplotdata', ...
'Callback', {@buttonclearuplotdata} ...
);

h.buttonexportuplotdata = uicontrol( ...
'Parent', h.uplotoptionspanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'FontSize', 9, ...
'Position', [0.07 0.02 0.26 0.03], ...
'String', 'Export data', ...
'Tag', 'buttonexportuplotdata', ...
'Callback', {@buttonexportuplotdata} ...
);


%% Plot panel for universal plot data
h.uplotplotpanel = uipanel( ...
'Parent', h.Tabs(3), ...
'Units', 'Normalized', ...
'Position', [0.189 0.002 0.81 0.997], ...
'Title', 'Universal Plot - Plot Window' ...
);

% Create plot windows for stress components
% Empty data for plot    
x = 0;
y = 0;
err = 0;

%% Create axes object to plot sigma11 stress component
h.axesuplotdatasigma11 = axes('Parent', h.uplotplotpanel, 'Position', [0.06 0.558 0.4 0.4]);

hold(h.axesuplotdatasigma11,'on')

h.uplotdatasigma11 = errorbar(h.axesuplotdatasigma11, x, y, err,'Linestyle','-','Color','k','Marker','s','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');

box(h.axesuplotdatasigma11,'on')
grid(h.axesuplotdatasigma11,'on')
hold(h.axesuplotdatasigma11,'off')
% Set plot properties
xlabel(h.axesuplotdatasigma11,'z, \tau [µm]')
ylabel(h.axesuplotdatasigma11,'\sigma_{11} [MPa]')
title(h.axesuplotdatasigma11,{'No measurement data loaded';'   '})

% Change plot limits sigma11
h.ChangeAxLimcheckbox1 = uicontrol( ...
'Parent', h.uplotplotpanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.0025 0.5085 0.056 0.0225], ...
'Tag', 'ChangeAxLimcheckbox1', ...
'Value', 0, ...
'String', {'Change limits'},...
'Callback', {@ChangeAxLimcheckbox} ...
);

h.textXlimmin1 = uicontrol('Style', 'text',...
'Parent', h.uplotplotpanel,...
'Units','normalized',...
'Position', [0.06 0.5035 0.03 0.0225],...
'String', 'Xmin',...
'FontSize', 9,...
'FontWeight', 'bold',...
'Visible', 'off' ,...
'HorizontalAlignment', 'left');

h.editXlimmin1 = uicontrol('Style','edit',...
'String', '0',...
'FontSize', 9,...
'Callback', {@callbackeditXlimmin}, ...
'Tag', 'editXlimmin1',...
'Units','normalized',...
'Visible', 'off' ,...
'Position',[0.084 0.50775 0.025 0.02],...
'Parent',h.uplotplotpanel);

h.textXlimmax1 = uicontrol('Style', 'text',...
'Parent', h.uplotplotpanel,...
'Units','normalized',...
'Position', [0.115 0.5035 0.03 0.0225],...
'String', 'Xmax',...
'FontSize', 9,...
'FontWeight', 'bold',...
'Visible', 'off' ,...
'HorizontalAlignment', 'left');

h.editXlimmax1 = uicontrol('Style','edit',...
'String', '1',...
'FontSize', 9,...
'Callback', {@callbackeditXlimmax}, ...
'Tag', 'editXlimmax1',...
'Units','normalized',...
'Visible', 'off' ,...
'Position',[0.1425 0.50775 0.025 0.02],...
'Parent',h.uplotplotpanel);

h.textXlimtick1 = uicontrol('Style', 'text',...
'Parent', h.uplotplotpanel,...
'Units','normalized',...
'Position', [0.1725 0.5035 0.03 0.0225],...
'String', 'Xtick',...
'FontSize', 9,...
'FontWeight', 'bold',...
'Visible', 'off' ,...
'HorizontalAlignment', 'left');

h.editXlimtick1 = uicontrol('Style','edit',...
'String', '0.1',...
'FontSize', 9,...
'Callback', {@callbackeditXlimtick}, ...
'Tag', 'editXlimtick1',...
'Units','normalized',...
'Visible', 'off' ,...
'Position',[0.1975 0.50775 0.025 0.02],...
'Parent',h.uplotplotpanel);

h.textYlimmin1 = uicontrol('Style', 'text',...
'Parent', h.uplotplotpanel,...
'Units','normalized',...
'Position', [0.3 0.5035 0.03 0.0225],...
'String', 'Ymin',...
'FontSize', 9,...
'FontWeight', 'bold',...
'Visible', 'off' ,...
'HorizontalAlignment', 'left');

h.editYlimmin1 = uicontrol('Style','edit',...
'String', '0',...
'FontSize', 9,...
'Callback', {@callbackeditYlimmin}, ...
'Tag', 'editYlimmin1',...
'Units','normalized',...
'Visible', 'off' ,...
'Position',[0.324 0.50775 0.025 0.02],...
'Parent',h.uplotplotpanel);

h.textYlimmax1 = uicontrol('Style', 'text',...
'Parent', h.uplotplotpanel,...
'Units','normalized',...
'Position', [0.355 0.5035 0.03 0.0225],...
'String', 'Ymax',...
'FontSize', 9,...
'FontWeight', 'bold',...
'Visible', 'off' ,...
'HorizontalAlignment', 'left');

h.editYlimmax1 = uicontrol('Style','edit',...
'String', '1',...
'FontSize', 9,...
'Callback', {@callbackeditYlimmax}, ...
'Tag', 'editYlimmax1',...
'Units','normalized',...
'Visible', 'off' ,...
'Position',[0.3825 0.50775 0.025 0.02],...
'Parent',h.uplotplotpanel);

h.textYlimtick1 = uicontrol('Style', 'text',...
'Parent', h.uplotplotpanel,...
'Units','normalized',...
'Position', [0.4125 0.5035 0.03 0.0225],...
'String', 'Ytick',...
'FontSize', 9,...
'FontWeight', 'bold',...
'Visible', 'off' ,...
'HorizontalAlignment', 'left');

h.editYlimtick1 = uicontrol('Style','edit',...
'String', '0.1',...
'FontSize', 9,...
'Callback', {@callbackeditYlimtick}, ...
'Tag', 'editYlimtick1',...
'Units','normalized',...
'Visible', 'off' ,...
'Position',[0.4375 0.50775 0.025 0.02],...
'Parent',h.uplotplotpanel);


%% Create axes object to plot sigma13 stress component
h.axesuplotdatasigma13 = axes('Parent', h.uplotplotpanel, 'Position', [0.06 0.058 0.4 0.4]);

hold(h.axesuplotdatasigma13,'on')

h.uplotdatasigma13 = errorbar(h.axesuplotdatasigma13, x, y, err,'Linestyle','-','Color','k','Marker','s','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');

box(h.axesuplotdatasigma13,'on')
grid(h.axesuplotdatasigma13,'on')
hold(h.axesuplotdatasigma13,'off')
% Set plot properties
xlabel(h.axesuplotdatasigma13,'z, \tau [µm]')
ylabel(h.axesuplotdatasigma13,'\sigma_{13} [MPa]')
title(h.axesuplotdatasigma13,{'No measurement data loaded';'   '})

% Change plot limits sigma13
h.ChangeAxLimcheckbox2 = uicontrol( ...
'Parent', h.uplotplotpanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.0025 0.007 0.056 0.0225], ...
'Tag', 'ChangeAxLimcheckbox2', ...
'Value', 0, ...
'String', {'Change limits'},...
'Callback', {@ChangeAxLimcheckbox} ...
);

h.textXlimmin2 = uicontrol('Style', 'text',...
'Parent', h.uplotplotpanel,...
'Units','normalized',...
'Position', [0.06 0.002 0.03 0.0225],...
'String', 'Xmin',...
'FontSize', 9,...
'FontWeight', 'bold',...
'Visible', 'off' ,...
'HorizontalAlignment', 'left');

h.editXlimmin2 = uicontrol('Style','edit',...
'String', '0',...
'FontSize', 9,...
'Callback', {@callbackeditXlimmin}, ...
'Tag', 'editXlimmin2',...
'Units','normalized',...
'Visible', 'off' ,...
'Position',[0.084 0.007 0.025 0.02],...
'Parent',h.uplotplotpanel);

h.textXlimmax2 = uicontrol('Style', 'text',...
'Parent', h.uplotplotpanel,...
'Units','normalized',...
'Position', [0.115 0.002 0.03 0.0225],...
'String', 'Xmax',...
'FontSize', 9,...
'FontWeight', 'bold',...
'Visible', 'off' ,...
'HorizontalAlignment', 'left');

h.editXlimmax2 = uicontrol('Style','edit',...
'String', '1',...
'FontSize', 9,...
'Callback', {@callbackeditXlimmax}, ...
'Tag', 'editXlimmax2',...
'Units','normalized',...
'Visible', 'off' ,...
'Position',[0.1425 0.007 0.025 0.02],...
'Parent',h.uplotplotpanel);

h.textXlimtick2 = uicontrol('Style', 'text',...
'Parent', h.uplotplotpanel,...
'Units','normalized',...
'Position', [0.1725 0.002 0.03 0.0225],...
'String', 'Xtick',...
'FontSize', 9,...
'FontWeight', 'bold',...
'Visible', 'off' ,...
'HorizontalAlignment', 'left');

h.editXlimtick2 = uicontrol('Style','edit',...
'String', '0.1',...
'FontSize', 9,...
'Callback', {@callbackeditXlimtick}, ...
'Tag', 'editXlimtick2',...
'Units','normalized',...
'Visible', 'off' ,...
'Position',[0.1975 0.007 0.025 0.02],...
'Parent',h.uplotplotpanel);

h.textYlimmin2 = uicontrol('Style', 'text',...
'Parent', h.uplotplotpanel,...
'Units','normalized',...
'Position', [0.3 0.002 0.03 0.0225],...
'String', 'Ymin',...
'FontSize', 9,...
'FontWeight', 'bold',...
'Visible', 'off' ,...
'HorizontalAlignment', 'left');

h.editYlimmin2 = uicontrol('Style','edit',...
'String', '0',...
'FontSize', 9,...
'Callback', {@callbackeditYlimmin}, ...
'Tag', 'editYlimmin2',...
'Units','normalized',...
'Visible', 'off' ,...
'Position',[0.324 0.007 0.025 0.02],...
'Parent',h.uplotplotpanel);

h.textYlimmax2 = uicontrol('Style', 'text',...
'Parent', h.uplotplotpanel,...
'Units','normalized',...
'Position', [0.355 0.002 0.03 0.0225],...
'String', 'Ymax',...
'FontSize', 9,...
'FontWeight', 'bold',...
'Visible', 'off' ,...
'HorizontalAlignment', 'left');

h.editYlimmax2 = uicontrol('Style','edit',...
'String', '1',...
'FontSize', 9,...
'Callback', {@callbackeditYlimmax}, ...
'Tag', 'editYlimmax2',...
'Units','normalized',...
'Visible', 'off' ,...
'Position',[0.3825 0.007 0.025 0.02],...
'Parent',h.uplotplotpanel);

h.textYlimtick2 = uicontrol('Style', 'text',...
'Parent', h.uplotplotpanel,...
'Units','normalized',...
'Position', [0.4125 0.002 0.03 0.0225],...
'String', 'Ytick',...
'FontSize', 9,...
'FontWeight', 'bold',...
'Visible', 'off' ,...
'HorizontalAlignment', 'left');

h.editYlimtick2 = uicontrol('Style','edit',...
'String', '0.1',...
'FontSize', 9,...
'Callback', {@callbackeditYlimtick}, ...
'Tag', 'editYlimtick2',...
'Units','normalized',...
'Visible', 'off' ,...
'Position',[0.4375 0.007 0.025 0.02],...
'Parent',h.uplotplotpanel);



%% Create axes object to plot sigma22 stress component
h.axesuplotdatasigma22 = axes('Parent', h.uplotplotpanel, 'Position', [0.56 0.558 0.4 0.4]);

hold(h.axesuplotdatasigma22,'on')

h.uplotdatasigma22 = errorbar(h.axesuplotdatasigma22, x, y, err,'Linestyle','-','Color','k','Marker','s','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');

box(h.axesuplotdatasigma22,'on')
grid(h.axesuplotdatasigma22,'on')
hold(h.axesuplotdatasigma22,'off')
% Set plot properties
xlabel(h.axesuplotdatasigma22,'z, \tau [µm]')
ylabel(h.axesuplotdatasigma22,'\sigma_{22} [MPa]')
title(h.axesuplotdatasigma22,{'No measurement data loaded';'   '})

% Change plot limits sigma22
h.ChangeAxLimcheckbox3 = uicontrol( ...
'Parent', h.uplotplotpanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.5025 0.5085 0.056 0.0225], ...
'Tag', 'ChangeAxLimcheckbox3', ...
'Value', 0, ...
'String', {'Change limits'},...
'Callback', {@ChangeAxLimcheckbox} ...
);

h.textXlimmin3 = uicontrol('Style', 'text',...
'Parent', h.uplotplotpanel,...
'Units','normalized',...
'Position', [0.56 0.5035 0.03 0.0225],...
'String', 'Xmin',...
'FontSize', 9,...
'FontWeight', 'bold',...
'Visible', 'off' ,...
'HorizontalAlignment', 'left');

h.editXlimmin3 = uicontrol('Style','edit',...
'String', '0',...
'FontSize', 9,...
'Callback', {@callbackeditXlimmin}, ...
'Tag', 'editXlimmin3',...
'Units','normalized',...
'Visible', 'off' ,...
'Position',[0.584 0.50775 0.025 0.02],...
'Parent',h.uplotplotpanel);

h.textXlimmax3 = uicontrol('Style', 'text',...
'Parent', h.uplotplotpanel,...
'Units','normalized',...
'Position', [0.615 0.5035 0.03 0.0225],...
'String', 'Xmax',...
'FontSize', 9,...
'FontWeight', 'bold',...
'Visible', 'off' ,...
'HorizontalAlignment', 'left');

h.editXlimmax3 = uicontrol('Style','edit',...
'String', '1',...
'FontSize', 9,...
'Callback', {@callbackeditXlimmax}, ...
'Tag', 'editXlimmax3',...
'Units','normalized',...
'Visible', 'off' ,...
'Position',[0.6425 0.50775 0.025 0.02],...
'Parent',h.uplotplotpanel);

h.textXlimtick3 = uicontrol('Style', 'text',...
'Parent', h.uplotplotpanel,...
'Units','normalized',...
'Position', [0.6725 0.5035 0.03 0.0225],...
'String', 'Xtick',...
'FontSize', 9,...
'FontWeight', 'bold',...
'Visible', 'off' ,...
'HorizontalAlignment', 'left');

h.editXlimtick3 = uicontrol('Style','edit',...
'String', '0.1',...
'FontSize', 9,...
'Callback', {@callbackeditXlimtick}, ...
'Tag', 'editXlimtick3',...
'Units','normalized',...
'Visible', 'off' ,...
'Position',[0.6975 0.50775 0.025 0.02],...
'Parent',h.uplotplotpanel);

h.textYlimmin3 = uicontrol('Style', 'text',...
'Parent', h.uplotplotpanel,...
'Units','normalized',...
'Position', [0.8 0.5035 0.03 0.0225],...
'String', 'Ymin',...
'FontSize', 9,...
'FontWeight', 'bold',...
'Visible', 'off' ,...
'HorizontalAlignment', 'left');

h.editYlimmin3 = uicontrol('Style','edit',...
'String', '0',...
'FontSize', 9,...
'Callback', {@callbackeditYlimmin}, ...
'Tag', 'editYlimmin3',...
'Units','normalized',...
'Visible', 'off' ,...
'Position',[0.824 0.50775 0.025 0.02],...
'Parent',h.uplotplotpanel);

h.textYlimmax3 = uicontrol('Style', 'text',...
'Parent', h.uplotplotpanel,...
'Units','normalized',...
'Position', [0.855 0.5035 0.03 0.0225],...
'String', 'Ymax',...
'FontSize', 9,...
'FontWeight', 'bold',...
'Visible', 'off' ,...
'HorizontalAlignment', 'left');

h.editYlimmax3 = uicontrol('Style','edit',...
'String', '1',...
'FontSize', 9,...
'Callback', {@callbackeditYlimmax}, ...
'Tag', 'editYlimmax3',...
'Units','normalized',...
'Visible', 'off' ,...
'Position',[0.8825 0.50775 0.025 0.02],...
'Parent',h.uplotplotpanel);

h.textYlimtick3 = uicontrol('Style', 'text',...
'Parent', h.uplotplotpanel,...
'Units','normalized',...
'Position', [0.9125 0.5035 0.03 0.0225],...
'String', 'Ytick',...
'FontSize', 9,...
'FontWeight', 'bold',...
'Visible', 'off' ,...
'HorizontalAlignment', 'left');

h.editYlimtick3 = uicontrol('Style','edit',...
'String', '0.1',...
'FontSize', 9,...
'Callback', {@callbackeditYlimtick}, ...
'Tag', 'editYlimtick3',...
'Units','normalized',...
'Visible', 'off' ,...
'Position',[0.9375 0.50775 0.025 0.02],...
'Parent',h.uplotplotpanel);


%% Create axes object to plot sigma23 stress component
h.axesuplotdatasigma23 = axes('Parent', h.uplotplotpanel, 'Position', [0.56 0.058 0.4 0.4]);

hold(h.axesuplotdatasigma23,'on')

h.uplotdatasigma23 = errorbar(h.axesuplotdatasigma23, x, y, err,'Linestyle','-','Color','k','Marker','s','MarkerSize',14,'MarkerFaceColor','k','MarkerEdgeColor','k','Clipping','off','Visible','off');

box(h.axesuplotdatasigma23,'on')
grid(h.axesuplotdatasigma23,'on')
hold(h.axesuplotdatasigma23,'off')
% Set plot properties
xlabel(h.axesuplotdatasigma23,'z, \tau [µm]')
ylabel(h.axesuplotdatasigma23,'\sigma_{23} [MPa]')
title(h.axesuplotdatasigma23,{'No measurement data loaded';'   '})

% Change plot limits sigma23
h.ChangeAxLimcheckbox4 = uicontrol( ...
'Parent', h.uplotplotpanel, ...
'Style', 'checkbox', ...
'Units', 'Normalized', ...
'Position', [0.5025 0.007 0.056 0.0225], ...
'Tag', 'ChangeAxLimcheckbox4', ...
'Value', 0, ...
'String', {'Change limits'},...
'Callback', {@ChangeAxLimcheckbox} ...
);

h.textXlimmin4 = uicontrol('Style', 'text',...
'Parent', h.uplotplotpanel,...
'Units','normalized',...
'Position', [0.56 0.002 0.03 0.0225],...
'String', 'Xmin',...
'FontSize', 9,...
'FontWeight', 'bold',...
'Visible', 'off' ,...
'HorizontalAlignment', 'left');

h.editXlimmin4 = uicontrol('Style','edit',...
'String', '0',...
'FontSize', 9,...
'Callback', {@callbackeditXlimmin}, ...
'Tag', 'editXlimmin4',...
'Units','normalized',...
'Visible', 'off' ,...
'Position',[0.584 0.007 0.025 0.02],...
'Parent',h.uplotplotpanel);

h.textXlimmax4 = uicontrol('Style', 'text',...
'Parent', h.uplotplotpanel,...
'Units','normalized',...
'Position', [0.615 0.002 0.03 0.0225],...
'String', 'Xmax',...
'FontSize', 9,...
'FontWeight', 'bold',...
'Visible', 'off' ,...
'HorizontalAlignment', 'left');

h.editXlimmax4 = uicontrol('Style','edit',...
'String', '1',...
'FontSize', 9,...
'Callback', {@callbackeditXlimmax}, ...
'Tag', 'editXlimmax4',...
'Units','normalized',...
'Visible', 'off' ,...
'Position',[0.6425 0.007 0.025 0.02],...
'Parent',h.uplotplotpanel);

h.textXlimtick4 = uicontrol('Style', 'text',...
'Parent', h.uplotplotpanel,...
'Units','normalized',...
'Position', [0.6725 0.002 0.03 0.0225],...
'String', 'Xtick',...
'FontSize', 9,...
'FontWeight', 'bold',...
'Visible', 'off' ,...
'HorizontalAlignment', 'left');

h.editXlimtick4 = uicontrol('Style','edit',...
'String', '0.1',...
'FontSize', 9,...
'Callback', {@callbackeditXlimtick}, ...
'Tag', 'editXlimtick4',...
'Units','normalized',...
'Visible', 'off' ,...
'Position',[0.6975 0.007 0.025 0.02],...
'Parent',h.uplotplotpanel);

h.textYlimmin4 = uicontrol('Style', 'text',...
'Parent', h.uplotplotpanel,...
'Units','normalized',...
'Position', [0.8 0.002 0.03 0.0225],...
'String', 'Ymin',...
'FontSize', 9,...
'FontWeight', 'bold',...
'Visible', 'off' ,...
'HorizontalAlignment', 'left');

h.editYlimmin4 = uicontrol('Style','edit',...
'String', '0',...
'FontSize', 9,...
'Callback', {@callbackeditYlimmin}, ...
'Tag', 'editYlimmin4',...
'Units','normalized',...
'Visible', 'off' ,...
'Position',[0.824 0.007 0.025 0.02],...
'Parent',h.uplotplotpanel);

h.textYlimmax4 = uicontrol('Style', 'text',...
'Parent', h.uplotplotpanel,...
'Units','normalized',...
'Position', [0.855 0.002 0.03 0.0225],...
'String', 'Ymax',...
'FontSize', 9,...
'FontWeight', 'bold',...
'Visible', 'off' ,...
'HorizontalAlignment', 'left');

h.editYlimmax4 = uicontrol('Style','edit',...
'String', '1',...
'FontSize', 9,...
'Callback', {@callbackeditYlimmax}, ...
'Tag', 'editYlimmax4',...
'Units','normalized',...
'Visible', 'off' ,...
'Position',[0.8825 0.007 0.025 0.02],...
'Parent',h.uplotplotpanel);

h.textYlimtick4 = uicontrol('Style', 'text',...
'Parent', h.uplotplotpanel,...
'Units','normalized',...
'Position', [0.9125 0.002 0.03 0.0225],...
'String', 'Ytick',...
'FontSize', 9,...
'FontWeight', 'bold',...
'Visible', 'off' ,...
'HorizontalAlignment', 'left');

h.editYlimtick4 = uicontrol('Style','edit',...
'String', '0.1',...
'FontSize', 9,...
'Callback', {@callbackeditYlimtick}, ...
'Tag', 'editYlimtick4',...
'Units','normalized',...
'Visible', 'off' ,...
'Position',[0.9375 0.007 0.025 0.02],...
'Parent',h.uplotplotpanel);

%% Plot panel for qualitative phase analysis
h.PhaseAnalysisLoadDataPanel = uipanel( ...
'Parent', h.Tabs(5), ...
'Units', 'Normalized', ...
'Position', [0.0025 0.0025 0.185 0.9975], ...
'Title', 'Data preparation' ...
);

% Load measurement data for qualitative phase analysis
h.LoadMeasDataQAText1 = uicontrol( ...
'Parent', h.PhaseAnalysisLoadDataPanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.0025 0.975 0.45 0.015], ...
'Tag', 'LoadMeasDataQAText1', ...
'FontSize', 9,...
'FontWeight', 'bold',...
'String', 'Load measurement data' ...
);
% Edit field that shows the current measurement file
h.LoadMeasDataQA = uicontrol( ...
'Parent', h.PhaseAnalysisLoadDataPanel, ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.025 0.94 0.5 0.025], ...
'Tag', 'LoadMeasDataQA', ...
'Enable', 'on', ...
'String', 'Select measurement file...' ...
);
% Open button in order to load the measurement file
h.openbuttonQA1 = uicontrol( ...
'Parent', h.PhaseAnalysisLoadDataPanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.55 0.939 0.2 0.0275], ...
'String', 'Open', ...
'Tag', 'openbuttonQA1', ...
'Callback', {@OpenFileCallbackQA} ...
);
% Button for execution of create sample script
h.okbuttonQA1 = uicontrol( ...
'Parent', h.PhaseAnalysisLoadDataPanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.775 0.939 0.2 0.0275], ...
'String', 'Load', ...
'Tag', 'Okbutton1', ...
'Callback', {@okbuttonloadmeasurementQA} ...
);

h.popupmenudiffQA = uicontrol( ...
'Parent', h.PhaseAnalysisLoadDataPanel, ...
'Style', 'popupmenu', ...
'Units', 'Normalized', ...
'Position', [0.025 0.81 0.2875 0.12], ...
'Tag', 'popupmenudiffQA', ...
'String', {'Select Diffractometer', 'EDDI', 'LEDDI', 'LIMAX-160', 'LIMAX-70'}, ...
'Value', 2, ...
'Callback', {@popupmenuCallback3} ...
);
h.popupmenuscanmodeQA = uicontrol( ...
'Parent', h.PhaseAnalysisLoadDataPanel, ...
'Style', 'popupmenu', ...
'Units', 'Normalized', ...
'Position', [0.3375 0.81 0.2875 0.12], ...
'Tag', 'popupmenuscanmodeQA', ...
'String', {'Select scan mode', 'mcaacq', 'a/d-scan'}, ...
'Value', 2, ...
'Callback', {@popupmenuCallback4} ...
);
h.popupmenuDTCorrQA = uicontrol( ...
'Parent', h.PhaseAnalysisLoadDataPanel, ...
'Style', 'popupmenu', ...
'Units', 'Normalized', ...
'Position', [0.65 0.81 0.3175 0.12], ...
'Tag', 'popupmenuDTCorrQA', ...
'String', CalibFileNameList, ...
'Value', size(CalibFileNameList,2) - 1, ...
'Callback', {@popupmenuCallback5} ...
);


h.SelectMeasDataQAText1 = uicontrol( ...
'Parent', h.PhaseAnalysisLoadDataPanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.0025 0.875 0.45 0.015], ...
'Tag', 'SelectMeasDataQAText1', ...
'FontSize', 9,...
'FontWeight', 'bold',...
'String', 'Select measurement' ...
);

h.SelectMeasDataQAText2 = uicontrol( ...
'Parent', h.PhaseAnalysisLoadDataPanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Tag', 'SelectMeasDataQAText2', ...
'Position', [0.025 0.85 0.45 0.015], ...
'HorizontalAlignment', 'left', ...
'String', 'Choose detector (LEDDI only)' ...
);
h.PopupMenuSelectDetQA = uicontrol( ...
'Parent', h.PhaseAnalysisLoadDataPanel, ...
'Style', 'popupmenu', ...
'Units', 'Normalized', ...
'Position', [0.525 0.74 0.385 0.13], ...
'Tag', 'PopupMenuSelectDetQA', ...
'String', {'Select detector', 'Detector 1', 'Detector 2'}, ...
'Enable', 'off', ...
'Value', 2, ...
'Callback', {@SelectDetectorCallbackQA} ...
);


h.SelectMeasDataQAText3 = uicontrol( ...
'Parent', h.PhaseAnalysisLoadDataPanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.025 0.8205 0.31 0.015], ...
'HorizontalAlignment', 'left', ...
'Tag', 'SelectMeasDataQAText3', ...
'String', 'Select Energy range' ...
);
h.SelectMeasDataQAedit1 = uicontrol( ...
'Parent', h.PhaseAnalysisLoadDataPanel, ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.34 0.816 0.125 0.0225], ...
'Tag', 'SelectMeasDataQAedit1', ...
'String', 'Emin', ...
'ButtonDownFcn', {@clearbuttondown}, ...
'Callback', {@SelectEminQA}, ...
'Enable', 'inactive' ...
);
h.SelectMeasDataQAText4 = uicontrol( ...
'Parent', h.PhaseAnalysisLoadDataPanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.5 0.82 0.05 0.015], ...
'HorizontalAlignment', 'left', ...
'String', 'to' ...
);
h.SelectMeasDataQAedit2 = uicontrol( ...
'Parent', h.PhaseAnalysisLoadDataPanel, ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.565 0.816 0.125 0.0225], ...
'Tag', 'SelectMeasDataQAedit2', ...
'String', 'Emax', ...
'ButtonDownFcn', {@clearbuttondown}, ...
'Callback', {@SelectEmaxQA}, ...
'Enable', 'inactive' ...
);


h.SelectPeaksQAText1 = uicontrol( ...
'Parent', h.PhaseAnalysisLoadDataPanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.0025 0.78 0.55 0.015], ...
'Tag', 'SelectMeasDataQAText1', ...
'FontSize', 9,...
'FontWeight', 'bold',...
'String', 'Select peaks to be analyzed' ...
);

h.SelectBKGbuttonQA = uicontrol( ...
'Parent', h.PhaseAnalysisLoadDataPanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.025 0.745 0.32 0.025], ...
'String', 'Correct Background', ...
'Tag', 'SelectPeaksbuttonQA', ...
'Callback', {@buttonselectbkgQA} ...
);

h.SelectPeaksbuttonQA = uicontrol( ...
'Parent', h.PhaseAnalysisLoadDataPanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.36 0.745 0.22 0.025], ...
'String', 'Define Peaks', ...
'Tag', 'SelectPeaksbuttonQA', ...
'Callback', {@buttonselectpeaksQA} ...
);

h.FitPeaksbuttonQA = uicontrol( ...
'Parent', h.PhaseAnalysisLoadDataPanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.5975 0.745 0.16 0.025], ...
'String', 'Fit Peaks', ...
'Tag', 'FitPeaksbuttonQA', ...
'Callback', {@buttonfitpeaksQA} ...
);

h.ClearDatabuttonQA = uicontrol( ...
'Parent', h.PhaseAnalysisLoadDataPanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.7725 0.745 0.2 0.025], ...
'String', 'Clear Data', ...
'Tag', 'ClearDatabuttonQA', ...
'Callback', {@buttonclearpeaksQA} ...
);

% Table peak positions
d = zeros(8,3);
idxdata = d(:,1)>0;
h.tablepeaksQA = uitable(h.PhaseAnalysisLoadDataPanel, ...
'Units', 'Normalized', ...
'Position', [0.0325 0.605 0.855 0.1255], ...
'Tag', 'tablepeaksQA', ...
'data', [num2cell(d) num2cell(idxdata)],...
'ColumnEditable', [false false false true], ...
'ColumnWidth', {80 100 40 30}, ...
'CellEditCallback',{@celleditcallbacktablePeakTableQA}, ...
'ColumnName', {'EPos [keV]', 'd-spacing [nm]', ['2',char(952)], 'Use'});


h.CheckFluorPosQAText1 = uicontrol( ...
'Parent', h.PhaseAnalysisLoadDataPanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.0025 0.575 0.7 0.015], ...
'Tag', 'CheckFluorPosQAText1', ...
'FontSize', 9,...
'FontWeight', 'bold',...
'String', 'Check peaks for fluorescence lines' ...
);

h.CheckFluorPosQAText2 = uicontrol( ...
'Parent', h.PhaseAnalysisLoadDataPanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.0325 0.555 0.67 0.015], ...
'Tag', 'CheckFluorPosQAText2', ...
'HorizontalAlignment', 'left', ...
'String', 'Possible matches are shown in the table' ...
);

% Table peak positions
d = zeros(7,1);
idxdata = d(:,1)>0;
h.tableFluorQA = uitable(h.PhaseAnalysisLoadDataPanel, ...
'Units', 'Normalized', ...
'Position', [0.0325 0.445 0.4 0.108], ...
'Tag', 'tableFluorQA', ...
'data', [num2cell(d) num2cell(idxdata)],...
'ColumnEditable', [false true], ...
'ColumnWidth', {60 30}, ...
'CellEditCallback',{@celleditcallbacktableCheckFluorQA}, ...
'ColumnName', {'Element', 'Plot'});

h.CheckFluorPeaksbuttonQA = uicontrol( ...
'Parent', h.PhaseAnalysisLoadDataPanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.47 0.525 0.5 0.025], ...
'String', 'Check for fluorescence peaks', ...
'Tag', 'CheckFluorPeaksbuttonQA', ...
'Callback', {@buttonCheckFluorPeaksQA} ...
);

% Load measurement data for qualitative phase analysis
h.LoadMeasDataQAText2 = uicontrol( ...
'Parent', h.PhaseAnalysisLoadDataPanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.0025 0.41 0.92 0.015], ...
'Tag', 'LoadMeasDataQAText2', ...
'FontSize', 9,...
'FontWeight', 'bold',...
'String', 'Select elements to be considered for the analysis' ...
);

% Open button in order to select the elements
h.openPeriodicTablebutton = uicontrol( ...
'Parent', h.PhaseAnalysisLoadDataPanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.025 0.375 0.38 0.025], ...
'String', 'Open periodic table', ...
'Tag', 'openPeriodicTablebutton', ...
'Callback', {@OpenPeriodicTableCallback} ...
);

h.SelectedElementsQAedit1 = uicontrol( ...
'Parent', h.PhaseAnalysisLoadDataPanel, ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.465 0.375 0.48 0.025], ...
'Tag', 'SelectedElementsQAedit1', ...
'String', 'No elements selected', ...
'Enable', 'inactive' ...
);

h.SelectElementsQAText1 = uicontrol( ...
'Parent', h.PhaseAnalysisLoadDataPanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.0325 0.34 0.7 0.015], ...
'Tag', 'SelectElementsQAText1', ...
'HorizontalAlignment', 'left', ...
'String', 'Select the min. number of elements to be matched' ...
);

h.SelectedElementsQAedit2 = uicontrol( ...
'Parent', h.PhaseAnalysisLoadDataPanel, ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.75 0.335 0.1 0.025], ...
'Tag', 'SelectedElementsQAedit2', ...
'ButtonDownFcn', {@clearbuttondown}, ...
'String', '1', ...
'Enable', 'inactive' ...
);

h.SelectElementsQAText2 = uicontrol( ...
'Parent', h.PhaseAnalysisLoadDataPanel, ...
'Style', 'text', ...
'Units', 'Normalized', ...
'Position', [0.0325 0.301 0.7 0.03], ...
'Tag', 'SelectElementsQAText2', ...
'HorizontalAlignment', 'left', ...
'String', 'Select the max. number of elements the matched compound should have' ...
);

h.SelectedElementsQAedit3 = uicontrol( ...
'Parent', h.PhaseAnalysisLoadDataPanel, ...
'Style', 'edit', ...
'Units', 'Normalized', ...
'Position', [0.75 0.305 0.1 0.025], ...
'Tag', 'SelectedElementsQAedit3', ...
'ButtonDownFcn', {@clearbuttondown}, ...
'String', '1', ...
'Enable', 'inactive' ...
);

% Start button for peak matching
h.StartPeakMatchbutton = uicontrol( ...
'Parent', h.PhaseAnalysisLoadDataPanel, ...
'Style', 'Pushbutton', ...
'Units', 'Normalized', ...
'Position', [0.025 0.26 0.38 0.025], ...
'String', 'Start peak matching', ...
'Tag', 'StartPeakMatchbutton', ...
'Callback', {@StartPeakMatchCallback} ...
);

%% Qualitative analysis - Plot window
h.PhaseAnalysisPlotDataPanel = uipanel( ...
'Parent', h.Tabs(5), ...
'Units', 'Normalized', ...
'Position', [0.189 0.255 0.81 0.745], ...
'Title', 'Plot Window' ...
);

% Slider erzeugen
h.SliderQA = uicontrol(...
'Style','slider',...
'Tag','SliderQA',...
'Parent', h.PhaseAnalysisPlotDataPanel,...
'Units','normalized',...
'Position', [0.46 0.015 0.1 0.025],...
'Min',0,...
'Max', 1,...
'Value',1,...
'Callback',{@SliderCallbackPlotDataQA});

% empty data for plot    
x = 0;
y = 0;
% Create plot
h.axesplotMeasDataQA = axes('Parent', h.PhaseAnalysisPlotDataPanel, 'Position', [0.06 0.1125 0.9 0.85]);
h.plotdataQA = plot(h.axesplotMeasDataQA, x,y); hold on;

h.axesplotMeasDataQA.XLim = [0,100];
h.axesplotMeasDataQA.YLim = [0,1];
grid(h.axesplotMeasDataQA,'on')
set(h.plotdataQA, 'Color', 'blue');

xlabel(h.axesplotMeasDataQA,'Energy [keV]');
ylabel(h.axesplotMeasDataQA,'Intensity [cts]');
title(h.axesplotMeasDataQA,'No measurement data loaded')


%% Results table Search and Match 
h.PhaseAnalysisResultTablePanel = uipanel( ...
'Parent', h.Tabs(5), ...
'Units', 'Normalized', ...
'Position', [0.189 0.002 0.61 0.25], ...
'Title', 'Results from search and match' ...
);

% Table matched compounds/elements
d = zeros(15,7);
idxdata = d(:,1)>0;
h.tableresultsSAMQA = uitable(h.PhaseAnalysisResultTablePanel, ...
'Units', 'Normalized', ...
'Position', [0.01 0.015 0.974 0.963], ...
'Tag', 'tableresultsSAMQA', ...
'data', [num2cell(idxdata) num2cell(d)],...
'ColumnEditable', [true false false false false false false false], ...
'ColumnWidth', {30 80 80 130 130 130 130 376}, ...
'CellEditCallback',{@celleditcallbacktableresultsSAMQA}, ...
'ColumnName', {'Plot', 'Matches', 'PDF #', 'Formula', 'Name', 'Space group name', 'Space group no.', 'd-spacing [nm]'});


%% Add fluorescence lines 
h.AddFluorLinesTablePanel = uipanel( ...
'Parent', h.Tabs(5), ...
'Units', 'Normalized', ...
'Position', [0.801 0.1175 0.11 0.135], ...
'Title', 'Add fluorescence lines' ...
);

d = zeros(8,1);
dropdowntitle{1} = 'Select element';
idxdata = d(:,1)>0;
[FluorElements, h.orderFluorElements] = sort(h.FluorCellArray{2}(:));
h.AddFluorLinestable = uitable(h.AddFluorLinesTablePanel,...
'Units', 'Normalized', ...
'Position', [0.01 0.05 0.974 0.89], ...
'data', [num2cell(idxdata) repmat(dropdowntitle,size(d,1),1)],...
'ColumnWidth', {30 120 100},...
'ColumnName', {'Plot','Select element'},...
'ColumnFormat', {'logical',['Select element',FluorElements']},...
'CellEditCallback',{@celleditcallbackAddFluorLines}, ...
'ColumnEditable', [true true]...
);



% %% Rietveld analysis tab
% %% Create sample panel
% h.creatsamplepanelRV = uipanel( ...
% 'Parent', h.Tabs(6), ...
% 'Units', 'Normalized', ...
% 'Position', [0.0025 0.9175 0.175 0.08], ...
% 'Title', '1. Create Sample' ...
% );
% % Create graphic objects in "Create Sample" Panel
% % Text for information
% h.textelementRV1 = uicontrol( ...
% 'Parent', h.creatsamplepanelRV, ...
% 'Style', 'text', ...
% 'Units', 'Normalized', ...
% 'Position', [0.025 0.45 0.45 0.5], ...
% 'HorizontalAlignment', 'left', ...
% 'String', 'Enter elemental formula of material (e.g. Au1, Al2O3).' ...
% );
% % Edit field for entering elemental formula of sample
% h.editfieldelementRV1 = uicontrol( ...
% 'Parent', h.creatsamplepanelRV, ...
% 'Style', 'edit', ...
% 'Units', 'Normalized', ...
% 'Position', [0.025 0.09 0.45 0.35], ...
% 'String', 'Enter elemental formula', ...
% 'Tag', 'editfieldelementRV1', ...
% 'Enable', 'inactive', ...
% 'ButtonDownFcn', {@clearbuttondown} ...
% );
% % Text for information
% h.textmpdRV1 = uicontrol( ...
% 'Parent', h.creatsamplepanelRV, ...
% 'Style', 'text', ...
% 'Units', 'Normalized', ...
% 'Position', [0.505 0.5 0.45 0.25], ...
% 'HorizontalAlignment', 'left', ...
% 'String', 'Select mpd file' ...
% );
% % Popup menu to choose mpd file
% h.popupmenumpdRV1 = uicontrol( ...
% 'Parent', h.creatsamplepanelRV, ...
% 'Style', 'popupmenu', ...
% 'Units', 'Normalized', ...
% 'Position', [0.5 0.24 0.25 0.2], ...
% 'Tag', 'popupmenumpdRV1', ...
% 'String', MPDFileNameList, ...
% 'Value', 1, ...
% 'Callback', {@popupmenuCallback1} ...
% );
% % Alignement of graphic objects
% align([h.textelementRV1 h.editfieldelementRV1],'left','fixed',1);
% % align([h.textmpdRV1 h.popupmenumpdRV1],'right','fixed',2);
% 
% % Button for execution of create sample script
% h.okbuttonRV1 = uicontrol( ...
% 'Parent', h.creatsamplepanelRV, ...
% 'Style', 'Pushbutton', ...
% 'Units', 'Normalized', ...
% 'Position', [0.775 0.08 0.2 0.38], ...
% 'Tag', 'editfieldelement1', ...
% 'String', 'Ok', ...
% 'Tag', 'Okbutton1RV', ...
% 'Callback', {@okbuttoncreatesampleRV} ...
% );
% 
% %% Specfile conversion panel
% h.loadmeasurementpanelRV = uipanel( ...
% 'Parent', h.Tabs(6), ...
% 'Units', 'Normalized', ...
% 'Position', [0.18 0.9175 0.175 0.08], ...
% 'Title', '2. Load measurement File' ...
% );
% 
% % 'Position', [0.0025 0.835 0.175 0.08], ...
% 
% % Create graphic objects in "Specfile conversion" Panel
% % Edit field that shows the current measurement file
% h.selectfilenameRV = uicontrol( ...
% 'Parent', h.loadmeasurementpanelRV, ...
% 'Style', 'edit', ...
% 'Units', 'Normalized', ...
% 'Position', [0.025 0.575 0.6 0.35], ...
% 'Tag', 'selectfilename', ...
% 'Enable', 'on', ...
% 'String', 'Select measurement file...' ...
% );
% % Open button in order to load the measurement file
% h.openbuttonRV1 = uicontrol( ...
% 'Parent', h.loadmeasurementpanelRV, ...
% 'Style', 'Pushbutton', ...
% 'Units', 'Normalized', ...
% 'Position', [0.65 0.575 0.15 0.36], ...
% 'String', 'Open', ...
% 'Tag', 'Loadbutton1', ...
% 'Callback', {@OpenFileCallbackRV} ...
% );
% h.popupmenudiffRV = uicontrol( ...
% 'Parent', h.loadmeasurementpanelRV, ...
% 'Style', 'popupmenu', ...
% 'Units', 'Normalized', ...
% 'Position', [0.025 0.355 0.2875 0.12], ...
% 'Tag', 'popupmenudiff', ...
% 'String', {'Select Diffractometer', 'EDDI', 'LEDDI', 'LIMAX-160', 'LIMAX-70'}, ...
% 'Value', 2, ...
% 'Callback', {@popupmenuCallback3} ...
% );
% h.popupmenuscanmodeRV = uicontrol( ...
% 'Parent', h.loadmeasurementpanelRV, ...
% 'Style', 'popupmenu', ...
% 'Units', 'Normalized', ...
% 'Position', [0.3375 0.355 0.2875 0.12], ...
% 'Tag', 'popupmenuscanmode', ...
% 'String', {'Select scan mode', 'mcaacq', 'a/d-scan'}, ...
% 'Value', 2, ...
% 'Callback', {@popupmenuCallback4} ...
% );
% 
% h.popupmenuDTCorrRV = uicontrol( ...
% 'Parent', h.loadmeasurementpanelRV, ...
% 'Style', 'popupmenu', ...
% 'Units', 'Normalized', ...
% 'Position', [0.65 0.355 0.3175 0.12], ...
% 'Tag', 'popupmenuDTCorr', ...
% 'String', CalibFileNameList, ...
% 'Value', size(CalibFileNameList,2) - 1, ...
% 'Callback', {@popupmenuCallback5} ...
% );
% 
% % Button for execution of create sample script
% h.okbuttonRV1 = uicontrol( ...
% 'Parent', h.loadmeasurementpanelRV, ...
% 'Style', 'Pushbutton', ...
% 'Units', 'Normalized', ...
% 'Position', [0.825 0.575 0.15 0.36], ...
% 'String', 'Ok', ...
% 'Tag', 'Okbutton1', ...
% 'Callback', {@okbuttonloadmeasurementRV} ...
% );
% 
% %% Select energy range and detector (LEDDI)
% 
% h.selectErangeRV = uipanel( ...
% 'Parent', h.Tabs(6), ...
% 'Units', 'Normalized', ...
% 'Position', [0.3575 0.9175 0.15 0.08], ...
% 'Title', '3. Select detector (LEDDI only) and energy range' ...
% );
% 
% h.SelectMeasDataRVText2 = uicontrol( ...
% 'Parent', h.selectErangeRV, ...
% 'Style', 'text', ...
% 'Units', 'Normalized', ...
% 'Tag', 'SelectMeasDataRVText2', ...
% 'Position', [0.025 0.625 0.6 0.2], ...
% 'HorizontalAlignment', 'left', ...
% 'String', 'Choose detector (LEDDI only)' ...
% );
% h.PopupMenuSelectDetRV = uicontrol( ...
% 'Parent', h.selectErangeRV, ...
% 'Style', 'popupmenu', ...
% 'Units', 'Normalized', ...
% 'Position', [0.625 0.74 0.3 0.13], ...
% 'Tag', 'PopupMenuSelectDetRV', ...
% 'String', {'Select detector', 'Detector 1', 'Detector 2'}, ...
% 'Enable', 'off', ...
% 'Value', 2, ...
% 'Callback', {@SelectDetectorCallbackRV} ...
% );
% 
% 
% h.SelectMeasDataRVText3 = uicontrol( ...
% 'Parent', h.selectErangeRV, ...
% 'Style', 'text', ...
% 'Units', 'Normalized', ...
% 'Position', [0.025 0.05 0.5 0.3], ...
% 'HorizontalAlignment', 'left', ...
% 'Tag', 'SelectMeasDataRVText3', ...
% 'String', 'Select Energy range' ...
% );
% h.SelectMeasDataRVedit1 = uicontrol( ...
% 'Parent', h.selectErangeRV, ...
% 'Style', 'edit', ...
% 'Units', 'Normalized', ...
% 'Position', [0.42 0.0625 0.175 0.35], ...
% 'Tag', 'SelectMeasDataRVedit1', ...
% 'String', 'Emin', ...
% 'ButtonDownFcn', {@clearbuttondown}, ...
% 'Callback', {@SelectEminRV}, ...
% 'Enable', 'inactive' ...
% );
% h.SelectMeasDataRVText4 = uicontrol( ...
% 'Parent', h.selectErangeRV, ...
% 'Style', 'text', ...
% 'Units', 'Normalized', ...
% 'Position', [0.625 0.15 0.1 0.2], ...
% 'HorizontalAlignment', 'left', ...
% 'String', 'to' ...
% );
% h.SelectMeasDataRVedit2 = uicontrol( ...
% 'Parent', h.selectErangeRV, ...
% 'Style', 'edit', ...
% 'Units', 'Normalized', ...
% 'Position', [0.7 0.0625 0.175 0.35], ...
% 'Tag', 'SelectMeasDataRVedit2', ...
% 'String', 'Emax', ...
% 'ButtonDownFcn', {@clearbuttondown}, ...
% 'Callback', {@SelectEmaxRV}, ...
% 'Enable', 'inactive' ...
% );
% 
% 
% %% Rietveld analysis - Rietveld function and parameter editor and plot window
% s = warning('off', 'MATLAB:uitabgroup:OldVersion');
% h.TabGroupRV = uitabgroup('Parent',h.Tabs(6),'units', 'normalized','Position', [0.0025 0.0025 0.9995 0.915]);
% warning(s);
% 
% h.TabRV(1) = uitab('Parent', h.TabGroupRV, 'Title','Rietveld Function Editor');
% h.TabRV(2) = uitab('Parent', h.TabGroupRV, 'Title','Parameter Editor');
% h.TabRV(3) = uitab('Parent', h.TabGroupRV, 'Title','Plot Window');
% 
% h.RVAnalysisPlotDataPanel = uipanel( ...
% 'Parent', h.TabRV(3), ...
% 'Units', 'Normalized', ...
% 'Position', [0.0025 0.0025 0.785 1], ...
% 'Title', 'Plot Window' ...
% );
% 
% % Slider erzeugen
% h.SliderRV = uicontrol(...
% 'Style','slider',...
% 'Tag','SliderRV',...
% 'Parent', h.RVAnalysisPlotDataPanel,...
% 'Units','normalized',...
% 'Position', [0.46 0.005 0.1 0.025],...
% 'Min',0,...
% 'Max', 1,...
% 'Value',1,...
% 'Callback',{@SliderCallbackPlotDataRV});
% 
% % empty data for plot    
% x = 0;
% y = 0;
% % Create plot
% h.axesplotMeasDataRV = axes('Parent', h.RVAnalysisPlotDataPanel, 'Position', [0.06 0.275 0.9 0.7]);
% h.plotdataRV = plot(h.axesplotMeasDataRV, x,y); hold on;
% h.plotEtheoRV = line(h.axesplotMeasDataRV,x,y,'LineStyle',':','LineWidth',1.5);
% 
% h.axesplotMeasDataRV.XLim = [0,100];
% h.axesplotMeasDataRV.YLim = [0,1];
% grid(h.axesplotMeasDataRV,'on')
% set(h.plotdataRV, 'Color', 'blue');
% set(h.plotEtheoRV, 'Color', 'red');
% xlabel(h.axesplotMeasDataRV,'Energy [keV]');
% ylabel(h.axesplotMeasDataRV,'Intensity [cts]');
% title(h.axesplotMeasDataRV,'No measurement data loaded')
% 
% h.axesplotResidualDataRV = axes('Parent', h.RVAnalysisPlotDataPanel, 'Position', [0.06 0.05 0.9 0.165]);
% h.plotResidualdataRV = plot(h.axesplotResidualDataRV, x,y);
% h.axesplotResidualDataRV.YLim = [0,1];
% grid(h.axesplotResidualDataRV,'on')
% set(h.plotResidualdataRV, 'Color', 'black')
% set(h.axesplotResidualDataRV, 'xtick', [])
% xlabel(h.axesplotResidualDataRV,'')
% ylabel(h.axesplotResidualDataRV,'Residuum')
% title(h.axesplotResidualDataRV,'')
% 
% %% Table with theoretical peak positions
% h.tablehklpanelRV = uipanel( ...
% 'Parent', h.TabRV(3), ...
% 'Units', 'Normalized', ...
% 'Position', [0.79 0.65 0.21 0.35], ...
% 'Title', 'Theoretical peak positions' ...
% );
% % Create table with empty data for hkl, d-spacing and E [keV] values.
% % Sample phase data
% d = zeros(15,6);
% h.texthkltableRV1 = uicontrol( ...
% 'Parent', h.tablehklpanel, ...
% 'Style', 'text', ...
% 'Units', 'Normalized', ...
% 'Position', [0.05 0.96 0.8 0.03], ...
% 'HorizontalAlignment', 'left', ...
% 'String', 'Sample phase data' ...
% );
% 
% idxdata = d(:,1)>0;
% h.tablephasehklRV = uitable(h.tablehklpanelRV, ...
% 'Units', 'Normalized', ...
% 'Position', [0.025 0.01 0.95 0.966], ...
% 'Tag', 'tablephasehklRV', ...
% 'data', [num2cell(d) num2cell(idxdata)],...
% 'ColumnEditable', [false false false true false false true], ...
% 'ColumnWidth',{50}, ...
% 'ColumnWidth', {25 25 25 80 65 55 35}, ...
% 'CellEditCallback',{@celleditcallbackHKLTableRV}, ...
% 'ColumnName', {'h', 'k', 'l', 'Multiplicity', 'dspacing', 'Energy', 'Use'});
% 
% %% Parameter tab
% h.RVAnalysisParamEditorPanel = uipanel( ...
% 'Parent', h.TabRV(2), ...
% 'Units', 'Normalized', ...
% 'Position', [0.00125 0.0025 0.9975 0.9975], ...
% 'Title', 'Parameter Editor' ...
% );
% 
% % javaaddpath('D:\Profile\hrp\Eigene Dateien\MATLAB\\Matlab - Auswertesoftware\Classes\Rietveld\base\gui\RietveldGUI\dist\RietveldGUI.jar',1)
% 
% h.ParamEditor = RietveldED.base.rietveld.gui.ParameterEditor(h.RVAnalysisParamEditorPanel);
% % h.ParamEditor = Rietveld.base.rietveld.gui.ParameterEditor(h.RVAnalysisParamEditorPanel);

%% Set callbacks    
set(h.buttonSelectPeaktable1,'callback',{@buttonSelectPeaktableok, h})
set(h.buttonSelectPeaktable2,'callback',{@buttonSelectPeaktablecancel, h})
set(h.SelectPeaktable,'CellEditCallback',{@celleditcallbackSelectPeaktable, h})
set(h.figSelectPeaktable,'CloseRequestFcn',@my_Figclosereq2)

set(h.AcceptXEditButton,'callback',{@acceptXlimEdit, h})
set(h.CancelXEditButton,'callback',{@cancelXlimEdit, h})
set(h.AcceptYEditButton,'callback',{@acceptYlimEdit, h})
set(h.CancelYEditButton,'callback',{@cancelYlimEdit, h})

% set (gcf, 'WindowButtonMotionFcn', @mouseMove);
f = fieldnames(h);
assignin('base','fieldnames',f)
guidata(h.myfig, h);

%% Callbacks and functions
%% Create Sample panel
function okbuttoncreatesample(hObj,~)
% Callback for "Open File" pushbutton
h = guidata(hObj);

if strcmp(get(h.editfieldelement1,'string'),'Enter elemental formula')
    errordlg('Please enter formula','Warning');
else
    h.P.ElementalFormula = get(h.editfieldelement1,'string');
    h.P.MPDFileName = h.P.PopupValueMpd1;
    h.P.ShowSubstratePeaks = get(h.checkboxsubstrate1,'value');
    h.P.SubstrateFormula = get(h.editfieldelement2,'string');
    h.P.SusbtrateMPDFileName = h.P.PopupValueMpd2;
    % Set FileName to string and ExPath to UserData of Edit-Field
    [Sample,T] = CreateSampleGUI(h.P);
    h.T = T;
    h.Sample = Sample;
    
    msgbox({'Sample Created'});
end
% assignin('base','Sample',h.Sample)
guidata(hObj, h);

function popupmenuCallback1(hObj,~)
% Callback for "pop up menu" in create sample panel
h = guidata(hObj);
% Determine the selected data set.
str = get(hObj, 'String');
val = get(hObj, 'Value');
h.P.PopupValueMpd1 = str{val};

guidata(hObj,h);

function popupmenuCallback2(hObj,~)
% Callback for "pop up menu" in create sample panel
h = guidata(hObj);
% Determine the selected data set.
str = get(hObj, 'String');
val = get(hObj, 'Value');
h.P.PopupValueMpd2 = str{val};

guidata(hObj,h);

%% Load measurement file panel
function OpenFileCallback(hObj,~)
% Callback for "Open File" pushbutton
h = guidata(hObj);

% h = handles;
% Open file dialog box - Folder may have to be changed manually
[FileName,FilePath]  = uigetfile('*.*','Load measurement file',[General.ProgramInfo.Path,'\Data\Measurements\']);

if FileName == 0
  % user pressed cancel
  return
end

ExPath = fullfile(FilePath, FileName);
% Set FileName to string and ExPath to UserData of Edit-Field
set(h.selectfilename,'string',FileName)
set(h.selectfilename,'UserData',ExPath)

guidata(hObj, h);

function okbuttonloadmeasurement(hObj,~)
% Callback for "Load Measurement" ok pushbutton
h = guidata(hObj);
% Get measurement mode
measstr = get(h.popupmenumeasmode,'string');
measval = get(h.popupmenumeasmode,'value');
measmode = measstr{measval};
h.measmode = measmode;
% Get diffractometer name
Diffstr = get(h.popupmenudiff,'String');
Diffval = get(h.popupmenudiff,'Value');
Diffsel = Diffstr{Diffval};
h.Diffsel = Diffsel;
% Get detector from LEDDI measurements
Detstr = get(h.popupmenuselectmeas1,'String');
Detval = get(h.popupmenuselectmeas1,'Value');
Detsel = Detstr{Detval};
h.Detsel = Detsel;

% Function to make "Fit" button blink in red during fitting process
col = get(hObj,'backg');  % Get the background color of the figure.
set(hObj,'str','Loading','backg',[1 .6 .6]) % Change color of button. 
% The pause (or drawnow) is necessary to make button changes appear.
pause(.01)

if strcmp(get(h.selectfilename,'string'),'Select measurement file...')
    errordlg('No measurement selected','Warning');
else
    % Get parameters for the SpecFileConversionGUI script
    h.P.SpecFileName = get(h.selectfilename,'string');
    h.P.DiffractometerType = get(h.popupmenudiff,'value') - 1;  % -1 since the first value is for info
%     diffstr = get(h.popupmenudiff,'string');
%     diffval = get(h.popupmenudiff,'value');
%     diffmode = diffstr{diffval};
    h.P.LoadFromSpecFile = get(h.popupmenuscanmode,'value') - 1;    % -1 since the first value is for info
    calib = get(h.popupmenuDTCorr,'string');
    h.P.Calibration = calib{get(h.popupmenuDTCorr,'value')};
    % Run "SpecFileConversionGUI" script
    [meas,~,DataTmp,Substrate,Diffractometer,P,T] = SpecFileConversionGUI(h.P,h.Sample,h.T);
    % IF LEDDI measurements were conducted using only one detector
%     assignin('base','measbefore',meas)
    if strcmp(h.Diffsel,'LEDDI')
        if meas(1).NumberOfDetectors == 1
            meas = reshape(repmat(meas,2,1),size(meas,2)*2,[]);
            meas = meas';
            DataTmp = reshape(repmat(DataTmp,2,1),size(DataTmp,2)*2,[]);
            DataTmp = DataTmp';
        end
    end

    % Change Emax according to diffractometer
    if strcmp(h.Diffsel,'LEDDI')
        for k = 1:length(meas)
            meas(k).Sample.Materials.EnergyMax = 60;
        end
    end
    % Set output to variables
    h.Measurement = meas;
    h.MeasurementRawData = meas.Clone;
    h.Substrate = Substrate;
    h.Diffractometer = Diffractometer;
    h.DataTmp = DataTmp;
    h.DataTmpBackup = DataTmp;
    h.RawData = DataTmp;
    h.P = P;
    h.T = T;
    assignin('base','meas',meas)
    % Get theoretical peak positions
    h.TPeaks = TheoreticalPeakPositions(meas,DataTmp);
    if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
        a = h.TPeaks.T.Etheo < h.TPeaks.T.EMax;
        EtheoLimit = h.TPeaks.T.Etheo(a);
%         X1Limit = h.TPeaks.T.X1(a,:);
        X3Limit = h.TPeaks.T.X3((1:(3*length(EtheoLimit)-1)),:);
        Y3Limit = h.TPeaks.T.Y3((1:(3*length(EtheoLimit)-1)),:);
        % Set data for table with hkl, d-spacing and E[keV] values
        set(h.tablephasehkl,'data',[num2cell(h.TPeaks.T.Peaks(a,:)) num2cell(false(size(num2cell(h.TPeaks.T.Peaks(a,:)),1),1))])
    elseif strcmp(h.Diffsel,'LEDDI')
        if strcmp(h.Detsel,'Detector 1')
            Slidersteps = 2:2:length(h.Measurement);
            h.TPeaksDet1 = TheoreticalPeakPositions(h.Measurement(Slidersteps),h.DataTmp(Slidersteps));
            a = h.TPeaksDet1.T.Etheo < 60;
            EtheoLimit = h.TPeaksDet1.T.Etheo(a);
%             X1Limit = h.TPeaksDet1.T.X1(a,:);
            X3Limit = h.TPeaksDet1.T.X3((1:(3*length(EtheoLimit)-1)),:);
            Y3Limit = h.TPeaksDet1.T.Y3((1:(3*length(EtheoLimit)-1)),:);
            % Set data for table with hkl, d-spacing and E[keV] values
%             set(h.tablephasehkl,'data',h.TPeaksDet1.T.Peaks(a,:))
            set(h.tablephasehkl,'data',[num2cell(h.TPeaksDet1.T.Peaks(a,:)) num2cell(false(size(h.TPeaksDet1.T.Peaks(a,:),1),1))])
        elseif strcmp(h.Detsel,'Detector 2')
            Slidersteps = 1:2:length(h.Measurement);
            h.TPeaksDet2 = TheoreticalPeakPositions(h.Measurement(Slidersteps),h.DataTmp(Slidersteps));
            a = h.TPeaksDet2.T.Etheo < 60;
            EtheoLimit = h.TPeaksDet2.T.Etheo(a);
%             X1Limit = h.TPeaksDet2.T.X1(a,:);
            X3Limit = h.TPeaksDet2.T.X3((1:(3*length(EtheoLimit)-1)),:);
            Y3Limit = h.TPeaksDet2.T.Y3((1:(3*length(EtheoLimit)-1)),:);
            % Set data for table with hkl, d-spacing and E[keV] values
%             set(h.tablephasehkl,'data',h.TPeaksDet2.T.Peaks(a,:))
            set(h.tablephasehkl,'data',[num2cell(h.TPeaksDet2.T.Peaks(a,:)) num2cell(false(size(h.TPeaksDet2.T.Peaks(a,:),1),1))])
        end
    end

    if h.P.ShowSubstratePeaks == 1
        if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
            b = h.TPeaks.S.Etheo < h.TPeaks.S.EMax;
        elseif strcmp(h.Diffsel,'LEDDI')
            b = h.TPeaks.S.Etheo < 60;
        end
        SEtheoLimit = h.TPeaks.S.Etheo(b);
%         SX1Limit = h.TPeaks.S.X1(b,:);
        SX3Limit = h.TPeaks.S.X3((1:(3*length(SEtheoLimit)-1)),:);
        SY3Limit = h.TPeaks.S.Y3((1:(3*length(SEtheoLimit)-1)),:);
    end
    % Set plot data for theoretical line positions
    if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
        set(h.plotEtheo,'xdata',X3Limit(:,1))
        set(h.plotEtheo,'ydata',Y3Limit(:,1))
    elseif strcmp(h.Diffsel,'LEDDI')
        % Distinguish between Det1 and Det2
        if strcmp(h.Detsel,'Detector 1')
            assignin('base','X3Limit',X3Limit)
            Slidersteps = 2:2:length(h.Measurement);
            if size(X3Limit,2) ~= 1
                set(h.plotEtheo,'xdata',X3Limit(:,Slidersteps(1)))
                set(h.plotEtheo,'ydata',Y3Limit(:,Slidersteps(1)))
            else
                set(h.plotEtheo,'xdata',X3Limit(:,1))
                set(h.plotEtheo,'ydata',Y3Limit(:,1))
            end
        elseif strcmp(h.Detsel,'Detector 2')
            Slidersteps = 1:2:length(h.Measurement);
            if size(X3Limit,2) ~= 1
                set(h.plotEtheo,'xdata',X3Limit(:,Slidersteps(1)))
                set(h.plotEtheo,'ydata',Y3Limit(:,Slidersteps(1)))
            else
                set(h.plotEtheo,'xdata',X3Limit(:,1))
                set(h.plotEtheo,'ydata',Y3Limit(:,1))
            end   
        end
    end
    set(h.plotEtheo,'Visible','on')
    if h.P.ShowSubstratePeaks == 1
        set(h.plotEtheoSub,'xdata',SX3Limit(:,1))
        set(h.plotEtheoSub,'ydata',SY3Limit(:,1))
    end
%     % Set data for table with hkl, d-spacing and E[keV] values
%     set(h.tablephasehkl,'data',h.TPeaks.T.Peaks(a,:))
    if h.P.ShowSubstratePeaks == 1
        set(h.tablephasehkl2,'data',h.TPeaks.S.Peaks(b,:))
    end
    % Change slider parameters according to size of meas
    if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
        if length(meas) == 1
            set(h.Slider,'Min',1);
            set(h.Slider,'Max',length(meas));
            set(h.Slider,'SliderStep',[1 1]);
            set(h.Slider,'Visible','off');
        else
            set(h.Slider,'Min',1);
            set(h.Slider,'Max',length(meas));
            set(h.Slider,'SliderStep',[1/(length(meas)-1) 1/(length(meas)-1)]);
        end
    elseif strcmp(h.Diffsel,'LEDDI')
        if length(meas) == 2
            set(h.Slider,'Min',1);
            set(h.Slider,'Max',length(meas));
            set(h.Slider,'SliderStep',[1 1]);
            set(h.Slider,'Visible','off');
        else
            set(h.Slider,'Min',1);
            set(h.Slider,'Max',length(meas)/2);
            set(h.Slider,'SliderStep',[1/((length(meas)/2)-1) 1/((length(meas)/2)-1)]);
        end
    end
    % Set plot data and parameters
    if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
        set(h.plotdata,'xdata',DataTmp{1}(:,1))
        set(h.plotdata,'ydata',DataTmp{1}(:,2))
        set(h.plotdataZoom,'xdata',DataTmp{1}(:,1))
        set(h.plotdataZoom,'ydata',DataTmp{1}(:,2))
        set(h.axesplotRawData.Title,'String',['Measurement data for ', meas(1).Name])
    elseif strcmp(h.Diffsel,'LEDDI')
        if strcmp(h.Detsel,'Detector 1')
            Slidersteps = 2:2:length(h.Measurement);
            set(h.plotdata,'xdata',DataTmp{2}(:,1))
            set(h.plotdata,'ydata',DataTmp{2}(:,2))
            set(h.plotdataZoom,'xdata',DataTmp{Slidersteps(1)}(:,1))
            set(h.plotdataZoom,'ydata',DataTmp{Slidersteps(1)}(:,2))
%             set(h.plotdataZoom,'xdata',DataTmp{2}(:,1))
%             set(h.plotdataZoom,'ydata',DataTmp{2}(:,2))
            set(h.axesplotRawData.Title,'String',['Measurement data for ', meas(2).Name])
        elseif strcmp(h.Detsel,'Detector 2')
            Slidersteps = 1:2:length(h.Measurement);
            set(h.plotdata,'xdata',DataTmp{1}(:,1))
            set(h.plotdata,'ydata',DataTmp{1}(:,2))
            set(h.plotdataZoom,'xdata',DataTmp{Slidersteps(1)}(:,1))
            set(h.plotdataZoom,'ydata',DataTmp{Slidersteps(1)}(:,2))
%             set(h.plotdataZoom,'xdata',DataTmp{1}(:,1))
%             set(h.plotdataZoom,'ydata',DataTmp{1}(:,2))
            set(h.axesplotRawData.Title,'String',['Measurement data for ', meas(1).Name])
        end 
    end
    % Set initial parameters for panel "Select Measurements"
    if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
        set(h.editfieldselectmeas1,'String',length(meas))
        set(h.editfieldselectmeas2,'String',1)
        set(h.editfieldselectmeas3,'String',length(meas))
        h.axesplotRawData.XLim = [0, Inf];
        h.axesplotRawData.YLim = [0, Inf];
    elseif strcmp(h.Diffsel,'LEDDI')
        set(h.editfieldselectmeas1,'String',length(meas)/2)
        set(h.editfieldselectmeas2,'String',1)
        set(h.editfieldselectmeas3,'String',length(meas)/2)
        h.axesplotRawData.XLim = [0, 60];
        h.axesplotRawData.YLim = [0, Inf];
    end
    % Make checkbox for show/hide theoretical peak positions visible 
    set(h.checkboxtheopeaks1,'Visible','on')
    set(h.checkboxshifttheopeaks1,'visible','on')
    set(h.editshiftEtheo1,'visible','on')
    set(h.plusbuttonshiftEtheo1,'visible','on')
    set(h.minusbuttonshiftEtheo1,'visible','on')
    if h.P.ShowSubstratePeaks == 1
        set(h.checkboxtheopeaks2,'visible','on')
        set(h.checkboxshifttheopeaks2,'visible','on')
        set(h.editshiftEtheo2,'visible','on')
        set(h.plusbuttonshiftEtheo2,'visible','on')
        set(h.minusbuttonshiftEtheo2,'visible','on')
    end
    % Set table title
    set(h.texthkltable1,'String',[get(h.texthkltable1,'String') ' - ' h.P.PopupValueMpd1])
    if h.P.ShowSubstratePeaks == 1
        set(h.texthkltable2,'String',[get(h.texthkltable2,'String') ' - ' h.P.PopupValueMpd2])
    end
    % Create measurement Folder
    if strcmp(h.Diffsel,'EDDI') 
        formatOut = 'ddmmyyyy';
        d = datestr(now, formatOut);
        name = strtrim(h.Measurement(1).MeasurementSeries);
        material = h.P.PopupValueMpd1;
        h.PathName = [General.ProgramInfo.Path,'\Data\Results\EDDI\',[name,'_',material,'_',d]];
        Path = fullfile(h.PathName);
        % Before creating a new folder check if it already exists. If it
        % already exists, create an new folder with the same name but added
        % with a number. If the folder already exists but is empty use this
        % one, without creating a new folder.
        if exist(Path,'dir') == 7
            count = 1;
            while exist(Path,'dir') == 7 
                FolderContent = dir(Path);
                if numel(FolderContent) > 2
                    Path = fullfile([General.ProgramInfo.Path,'\Data\Results\EDDI\',[name,'_',material,'_',d],'_',num2str(count)]);
                    h.PathName = [General.ProgramInfo.Path,'\Data\Results\EDDI\',name,'_',material,'_',d,'_',num2str(count)];
                    count = count + 1;
                end
                    FolderContent = dir(Path);
                if numel(FolderContent) == 0
                    mkdir(Path);
                    break
                elseif numel(FolderContent) == 2
                    if count-1 == 0
                        h.PathName = [General.ProgramInfo.Path,'\Data\Results\EDDI\',name,'_',material,'_',d];
                    else
                        h.PathName = [General.ProgramInfo.Path,'\Data\Results\EDDI\',name,'_',material,'_',d,'_',num2str(count-1)];
                    end
                    break
                end
            end
        elseif exist(Path,'dir') ~= 7
            mkdir(Path);
        end
    elseif strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
        formatOut = 'ddmmyyyy';
        d = datestr(now, formatOut);
        name = strtrim(h.Measurement(1).MeasurementSeries);
        material = h.P.PopupValueMpd1;
        h.PathName = [General.ProgramInfo.Path,'\Data\Results\MetalJet\',[name,'_',material,'_',d]];
        Path = fullfile(h.PathName);
        % Before creating a new folder check if it already exists. If it
        % already exists, create an new folder with the same name but added
        % with a number. If the folder already exists but is empty use this
        % one, without creating a new folder.
        if exist(Path,'dir') == 7
            count = 1;
            while exist(Path,'dir') == 7 
                FolderContent = dir(Path);
                if numel(FolderContent) > 2
                    Path = fullfile([General.ProgramInfo.Path,'\Data\Results\MetalJet\',[name,'_',material,'_',d],'_',num2str(count)]);
                    h.PathName = [General.ProgramInfo.Path,'\Data\Results\MetalJet\',name,'_',material,'_',d,'_',num2str(count)];
                    count = count + 1;
                end
                    FolderContent = dir(Path);
                if numel(FolderContent) == 0
                    mkdir(Path);
                    break
                elseif numel(FolderContent) == 2
                    if count-1 == 0
                        h.PathName = [General.ProgramInfo.Path,'\Data\Results\MetalJet\',name,'_',material,'_',d];
                    else
                        h.PathName = [General.ProgramInfo.Path,'\Data\Results\MetalJet\',name,'_',material,'_',d,'_',num2str(count-1)];
                    end
                    break
                end
            end
        elseif exist(Path,'dir') ~= 7
            mkdir(Path);
        end
    elseif strcmp(h.Diffsel,'LEDDI')
        formatOut = 'ddmmyyyy';
        d = datestr(now, formatOut);
        name = strtrim(h.Measurement(1).MeasurementSeries);
        material = h.P.PopupValueMpd1;
        h.PathName = [General.ProgramInfo.Path,'\Data\Results\LEDDI\',[name,'_',material,'_',d]];
        Path = fullfile(h.PathName);
        % Before creating a new folder check if it already exists. If it
        % already exists, create an new folder with the same name but added
        % with a number. If the folder already exists but is empty use this
        % one, without creating a new folder.
        if exist(Path,'dir') == 7
            count = 1;
            while exist(Path,'dir') == 7 
                FolderContent = dir(Path);
                if numel(FolderContent) > 2
                    Path = fullfile([General.ProgramInfo.Path,'\Data\Results\LEDDI\',[name,'_',material,'_',d],'_',num2str(count)]);
                    h.PathName = [General.ProgramInfo.Path,'\Data\Results\LEDDI\',name,'_',material,'_',d,'_',num2str(count)];
                    count = count + 1;
                end
                    FolderContent = dir(Path);
                if numel(FolderContent) == 0
                    mkdir(Path);
                    break
                elseif numel(FolderContent) == 2
                    if count-1 == 0
                        h.PathName = [General.ProgramInfo.Path,'\Data\Results\LEDDI\',name,'_',material,'_',d];
                    else
                        h.PathName = [General.ProgramInfo.Path,'\Data\Results\LEDDI\',name,'_',material,'_',d,'_',num2str(count-1)];
                    end
                    break
                end
            end
        elseif exist(Path,'dir') ~= 7
            mkdir(Path);
        end
    end
    % Messagebox
    msgbox({'Measurement loaded'});
end

% Reset the button color
set(hObj,'str','Ok','backg',col)  % Now reset the button features.

assignin('base','DataTmpLoad',h.DataTmp)
assignin('base','MeasurementLoad',h.Measurement)

guidata(hObj, h);

function popupmenuCallback3(hObj,~)
% Callback for "pop up menu" in load measurement panel
h = guidata(hObj);
% Determine the selected data set.
% str = get(hObj, 'String');
val = get(hObj, 'Value');
h.P.PopupValueMpd3 = val;

% If LEDDI diffractomter selected, set "Choose detector" field active
if h.P.PopupValueMpd3 == 3
    % Allow input of detector number
    set(h.popupmenuselectmeas1, 'enable', 'on')
    % Search for LEDDI string in popup menu
    StringDTcorr = get(h.popupmenuDTCorr,'String');
    LeddiValtmp = strcmp(StringDTcorr,'LEDDI');
    LedddiVal = find(LeddiValtmp==1);
    if strcmp(hObj.Tag,'popupmenudiffQA')
        set(h.popupmenuDTCorrQA,'Value',LedddiVal)
    elseif strcmp(hObj.Tag,'popupmenudiff')
        set(h.popupmenuDTCorr,'Value',LedddiVal)
    end
else
    % Block input of detector number
    set(h.popupmenuselectmeas1, 'enable', 'off')
end

guidata(hObj,h);

function popupmenuCallback4(hObj,~)
% Callback for "pop up menu" in load measurement panel
h = guidata(hObj);
% Determine the selected data set.
% str = get(hObj, 'String');
val = get(hObj, 'Value');
% h.P.PopupValueMpd4 = val;

h.PopUpMeasMode.(hObj.Tag) = val;

guidata(hObj,h);

function popupmenuCallback5(hObj,~)
% Callback for "pop up menu" in load measurement panel
h = guidata(hObj);
% Determine the selected data set.
str = get(hObj, 'String');
val = get(hObj, 'Value');
% h.P.PopupValueMpd5 = str{val};

h.PopUpDTCorr.(hObj.Tag) = str{val};

guidata(hObj,h);

function PlotAllCallback(hObj, ~)
% Callback for open table to select peaks 
h = guidata(hObj);
% Get value from checkbox
ValueCheckBox = get(hObj, 'value');
% Get slider value
valueSlider = round(get(h.Slider, 'Value'));

if ValueCheckBox == 1
    if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
        PlotDataXtmp = cell(1);
        PlotDataYtmp = cell(1);
        for k = 1:size(h.DataTmp,2)
           PlotDataXtmp{k} = h.DataTmp{k}(:,1);
           PlotDataYtmp{k} = h.DataTmp{k}(:,2);
        end
        % If cell arrays have different lengths, add zeros
        m = cellfun(@numel,PlotDataXtmp);
        PlotDataXtmp = cellfun(@(x,y)[x(:);zeros(max(m)-y,1)],PlotDataXtmp,num2cell(m),'un',0);
        h.PlotDataX = cell2mat(PlotDataXtmp);
        n = cellfun(@numel,PlotDataYtmp);
        PlotDataYtmp = cellfun(@(x,y)[x(:);zeros(max(n)-y,1)],PlotDataYtmp,num2cell(n),'un',0);
        h.PlotDataY = cell2mat(PlotDataYtmp);
%         assignin('base','PlotDataX',h.PlotDataX)
        % Set plot data
        set(h.plotdata,'xdata',h.DataTmp{valueSlider}(:,1))
        set(h.plotdata,'ydata',h.DataTmp{valueSlider}(:,2))

        h.plotdataAll = plot(h.axesplotRawData, h.PlotDataX(:,1), h.PlotDataY);
        set(h.plotdataAll, 'Color', [0.7 0.7 0.7]);
        uistack(h.plotdata,'top');
        if isfield(h,'plotfits')
           uistack(h.plotfits,'top'); 
        end
    elseif strcmp(h.Diffsel,'LEDDI')
        PlotDataXtmp = cell(1);
        PlotDataYtmp = cell(1);
        if strcmp(h.Detsel,'Detector 1')
            Slidersteps = 2:2:length(h.Measurement);
            for k = 1:length(Slidersteps)
                PlotDataXtmp{k} = h.DataTmp{Slidersteps(k)}(:,1);
                PlotDataYtmp{k} = h.DataTmp{Slidersteps(k)}(:,2);
            end
            % If cell arrays have different lengths, add zeros
            m = cellfun(@numel,PlotDataXtmp);
            PlotDataXtmp = cellfun(@(x,y)[x(:);zeros(max(m)-y,1)],PlotDataXtmp,num2cell(m),'un',0);
            h.PlotDataXDet1 = cell2mat(PlotDataXtmp);
            n = cellfun(@numel,PlotDataYtmp);
            PlotDataYtmp = cellfun(@(x,y)[x(:);zeros(max(n)-y,1)],PlotDataYtmp,num2cell(n),'un',0);
            h.PlotDataYDet1 = cell2mat(PlotDataYtmp);
            % Set plot data
            set(h.plotdata,'xdata',h.DataTmp{Slidersteps(valueSlider)}(:,1))
            set(h.plotdata,'ydata',h.DataTmp{Slidersteps(valueSlider)}(:,2))

            h.plotdataAll = plot(h.axesplotRawData, h.PlotDataXDet1(:,1), h.PlotDataYDet1);
            set(h.plotdataAll, 'Color', [0.7 0.7 0.7]);
            uistack(h.plotdata,'top');
            if isfield(h,'plotfits')
               uistack(h.plotfits,'top'); 
            end
        elseif strcmp(h.Detsel,'Detector 2')
            Slidersteps = 1:2:length(h.Measurement);
            for k = 1:length(Slidersteps)
                PlotDataXtmp{k} = h.DataTmp{Slidersteps(k)}(:,1);
                PlotDataYtmp{k} = h.DataTmp{Slidersteps(k)}(:,2);
            end
            % If cell arrays have different lengths, add zeros
            m = cellfun(@numel,PlotDataXtmp);
            PlotDataXtmp = cellfun(@(x,y)[x(:);zeros(max(m)-y,1)],PlotDataXtmp,num2cell(m),'un',0);
            h.PlotDataXDet2 = cell2mat(PlotDataXtmp);
            n = cellfun(@numel,PlotDataYtmp);
            PlotDataYtmp = cellfun(@(x,y)[x(:);zeros(max(n)-y,1)],PlotDataYtmp,num2cell(n),'un',0);
            h.PlotDataYDet2 = cell2mat(PlotDataYtmp);
            % Set plot data
            set(h.plotdata,'xdata',h.DataTmp{Slidersteps(valueSlider)}(:,1))
            set(h.plotdata,'ydata',h.DataTmp{Slidersteps(valueSlider)}(:,2))

            h.plotdataAll = plot(h.axesplotRawData, h.PlotDataXDet2(:,1), h.PlotDataYDet2);
            set(h.plotdataAll, 'Color', [0.7 0.7 0.7]);
            uistack(h.plotdata,'top');
            if isfield(h,'plotfits')
               uistack(h.plotfits,'top'); 
            end
        end
    end
else
    if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
        set(h.plotdata,'xdata',h.DataTmp{valueSlider}(:,1))
        set(h.plotdata,'ydata',h.DataTmp{valueSlider}(:,2))
    elseif strcmp(h.Diffsel,'LEDDI')
        if strcmp(h.Detsel,'Detector 1')
            Slidersteps = 2:2:length(h.Measurement);
            set(h.plotdata,'xdata',h.DataTmp{Slidersteps(valueSlider)}(:,1))
            set(h.plotdata,'ydata',h.DataTmp{Slidersteps(valueSlider)}(:,2))
        elseif strcmp(h.Detsel,'Detector 2')
            Slidersteps = 1:2:length(h.Measurement);
            set(h.plotdata,'xdata',h.DataTmp{Slidersteps(valueSlider)}(:,1))
            set(h.plotdata,'ydata',h.DataTmp{Slidersteps(valueSlider)}(:,2))
        end
    end
    set(h.plotdataAll,'Visible','off')
end

guidata(hObj, h);

%% Corrections panel
function okbuttoncorrections(hObj,~)
% Callback for "Corrections" ok pushbutton
h = guidata(hObj);

% Get parameters for the CorrectionsGUI script
h.P.CorrectWiggler = get(h.checkboxcorrections1,'value');
h.P.CorrectAbsortption = get(h.checkboxcorrections2,'value');
h.P.CorrectRC = get(h.checkboxcorrections3,'value');
h.P.MeasurementMode = get(h.popupmenumeasmode,'value') - 1;
% Set sample thickness in transmission mode
if h.P.MeasurementMode == 2
    h.P.SampleThickness = str2double(get(h.samplethickness,'string'));
else
    h.P.SampleThickness = 0;
end

Detstr = get(h.popupmenuselectmeas1,'String');
Detval = get(h.popupmenuselectmeas1,'Value');
Detsel = Detstr{Detval};
h.Detsel = Detsel;

if isfield(h,'corrcnt')
    msgbox({'Corrections already performed'});  
else
    % Run "CorrectionsGUI" script
    [Measurement,DataTmp,S] = CorrectionsGUI(h.Measurement,h.P);
    h.corrcnt = 1;
    % Set output to variables
    h.Measurement = Measurement;
    h.MeasurementBackup = Measurement.Clone;
    h.S = S;
    h.DataTmp = DataTmp;
%     assignin('base','hDataTmpCorr',h.DataTmp)
    % Set plot data and title  
    if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
        set(h.plotdata,'xdata',h.DataTmp{1}(:,1))
        set(h.plotdata,'ydata',h.DataTmp{1}(:,2))
        set(h.plotdataZoom,'xdata',h.DataTmp{1}(:,1))
        set(h.plotdataZoom,'ydata',h.DataTmp{1}(:,2))
    elseif strcmp(h.Diffsel,'LEDDI')
        % Distinguish between Det1 and Det2
        if strcmp(h.Detsel,'Detector 1')
            Slidersteps = 2:2:length(h.Measurement);
            set(h.plotdata,'xdata',h.DataTmp{Slidersteps(1)}(:,1))
            set(h.plotdata,'ydata',h.DataTmp{Slidersteps(1)}(:,2))
            set(h.plotdataZoom,'xdata',h.DataTmp{Slidersteps(1)}(:,1))
            set(h.plotdataZoom,'ydata',h.DataTmp{Slidersteps(1)}(:,2))
        elseif strcmp(h.Detsel,'Detector 2')
            Slidersteps = 1:2:length(h.Measurement);
            set(h.plotdata,'xdata',h.DataTmp{Slidersteps(1)}(:,1))
            set(h.plotdata,'ydata',h.DataTmp{Slidersteps(1)}(:,2))
            set(h.plotdataZoom,'xdata',h.DataTmp{Slidersteps(1)}(:,1))
            set(h.plotdataZoom,'ydata',h.DataTmp{Slidersteps(1)}(:,2))
        end
    end
    
    set(h.axesplotRawData.Title,'String',['Corrected measurement data for ', Measurement(1).Name])
    % Set axes limits
    h.axesplotRawData.YLim = [0 Inf];
    % Ydata of Etheo has to be changed according to the change in intensity due
    % to applied corrections
    % Set plot data for theoretical line positions
    if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
        set(h.plotEtheo,'ydata',get(h.plotEtheo,'ydata').*(max(h.DataTmp{1}(:,2))/max(get(h.plotEtheo,'ydata'))))
        if h.P.ShowSubstratePeaks == 1
            set(h.plotEtheoSub,'ydata',get(h.plotEtheoSub,'ydata').*(max(h.DataTmp{1}(:,2))/max(get(h.plotEtheoSub,'ydata')))) 
        end
    elseif strcmp(h.Diffsel,'LEDDI')
        % Distinguish between Det1 and Det2
        if strcmp(h.Detsel,'Detector 1')
            Slidersteps = 2:2:length(h.Measurement);
            set(h.plotEtheo,'ydata',get(h.plotEtheo,'ydata').*(max(h.DataTmp{Slidersteps(1)}(:,2))/max(get(h.plotEtheo,'ydata'))))
            if h.P.ShowSubstratePeaks == 1
                set(h.plotEtheoSub,'ydata',get(h.plotEtheoSub,'ydata').*(max(h.DataTmp{Slidersteps(1)}(:,2))/max(get(h.plotEtheoSub,'ydata')))) 
            end
        elseif strcmp(h.Detsel,'Detector 2')
            Slidersteps = 1:2:length(h.Measurement);
            set(h.plotEtheo,'ydata',get(h.plotEtheo,'ydata').*(max(h.DataTmp{Slidersteps(1)}(:,2))/max(get(h.plotEtheo,'ydata'))))
            if h.P.ShowSubstratePeaks == 1
                set(h.plotEtheoSub,'ydata',get(h.plotEtheoSub,'ydata').*(max(h.DataTmp{Slidersteps(1)}(:,2))/max(get(h.plotEtheoSub,'ydata')))) 
            end  
        end
    end
%     set(h.plotEtheo,'ydata',get(h.plotEtheo,'ydata').*(max(h.DataTmp{1}(:,2))/max(get(h.plotEtheo,'ydata'))))
%     if h.P.ShowSubstratePeaks == 1
%        set(h.plotEtheoSub,'ydata',get(h.plotEtheoSub,'ydata').*(max(h.DataTmp{1}(:,2))/max(get(h.plotEtheoSub,'ydata')))) 
%     end
    % Messagebox
    msgbox({'Corrections performed'});
end

ExportCorrSpec = get(h.checkboxcorrectionsExportData,'value');

if ExportCorrSpec == 1
    % Create new folder in plot folder with name of measurement file
    name = strtrim(h.Measurement(1).MeasurementSeries);
    Folder = '\CorrectedData\';
    Path = fullfile([h.PathName,Folder]);
    formatOut = 'ddmmyyyy';
    d = datestr(now, formatOut);

    if exist(Path,'dir') ~= 7
        mkdir(Path);
    end
    
    XCorrDataExport = cell(1);
    YCorrDataExport = cell(1);
    for k = 1:size(h.DataTmpBackup, 2)
        XCorrDataExport{k} = h.DataTmp{k}(:, 1);
        YCorrDataExport{k} = h.DataTmp{k}(:, 2);
    end


    for k = 1:size(h.DataTmpBackup, 2)
        fid = fopen([[Path,'\'],name,'_','CorrData','_',num2str(k),'_',d,'.dat'],'w');
        fprintf(fid,'%12s %15s \r\n','Energy[keV]','Intensity[cts]');
            fprintf(fid,'%.6f %.6f \n',[XCorrDataExport{k} YCorrDataExport{k}]');
            fprintf(fid,'\n');
        fclose(fid);
    end
end
% assignin('base','DataTmpCorr',h.DataTmp)
guidata(hObj, h);

function popupmenuCallback6(hObj,~)
% Callback for "pop up menu" in corrections panel
h = guidata(hObj);
% Determine the selected measurement mode
% str = get(hObj, 'String');
val = get(hObj, 'Value');
h.P.PopupValueMpd6 = val;

% If transmission mode is selected, set edit field active
if h.P.PopupValueMpd6 == 3
    %Allow input for sample thickness
    set(h.samplethickness, 'ForegroundColor', [0 0 0])
    set(h.samplethickness, 'enable', 'inactive')
    set(h.samplethickness, 'ButtonDownFcn', {@clearbuttondown})
else
    %Block input for sample thickness
    set(h.samplethickness, 'enable', 'off')
    set(h.samplethickness, 'ButtonDownFcn', {})
    set(h.samplethickness, 'String', 'Sample thickness [mm]')
end

guidata(hObj,h);

%% Select measurements panel
function okbuttonselectmeas(hObj,~)
% Callback for "SelectMeasurementsGUI" "OK" pushbutton
h = guidata(hObj);
if ~isfield(h,'MeasurementBackup')
    msgbox({'Please perform corrections first. If no corrections are desired, uncheck all options and press OK.'});
  % user pressed cancel
  return
end
% Get measurement mode
measstr = get(h.popupmenumeasmode,'string');
measval = get(h.popupmenumeasmode,'value');
measmode = measstr{measval};
h.measmode = measmode;
h.P.measmode = h.measmode;
% Get diffractometer name
h.P.Diffsel = h.Diffsel;
% Get detector from LEDDI measurements
Detstr = get(h.popupmenuselectmeas1,'String');
Detval = get(h.popupmenuselectmeas1,'Value');
Detsel = Detstr{Detval};
h.Detsel = Detsel;
h.P.Detsel = Detsel;

% Get value of checkbox to integrate spectra
IntegrateSpectra = get(h.checkboxselectmeas1,'Value');
% Select measurements depending on the diffractometer and measurement mode
% used.
if IntegrateSpectra == 0
    if strcmp(h.measmode,'Reflection') || strcmp(h.measmode,'Transmission') %measmode == 'Reflection' || measmode == 'Transmission'
        h.P.WhichMeasurementsDetector(1) = str2double(get(h.editfieldselectmeas2,'String'));
        h.P.WhichMeasurementsDetector(2) = str2double(get(h.editfieldselectmeas3,'String'));
        h.P.WhichMeasurements = (str2double(get(h.editfieldselectmeas2,'String')):str2double(get(h.editfieldselectmeas3,'String')));
        for k = 1:length(h.MeasurementBackup)
            h.DataTmpBackup{k} = h.MeasurementBackup(k).EDSpectrum;
        end
        h.DataTmp = h.DataTmpBackup(h.P.WhichMeasurementsDetector(1):h.P.WhichMeasurementsDetector(2));
    elseif strcmp(h.measmode,'LEDDI Mode-I') || strcmp(h.measmode,'LEDDI Mode-II') || strcmp(h.measmode,'LEDDI Horizontal') || strcmp(h.measmode,'LEDDI Vertical')
        % For LEDDI mode: selection of spectra not implemented yet
        h.P.WhichMeasurementsDetector(1) = str2double(get(h.editfieldselectmeas2,'String'));
        h.P.WhichMeasurementsDetector(2) = str2double(get(h.editfieldselectmeas3,'String'));
        h.P.WhichMeasurements = (str2double(get(h.editfieldselectmeas2,'String')):str2double(get(h.editfieldselectmeas3,'String')));
        for k = 1:length(h.MeasurementBackup)
            h.DataTmpBackup{k} = h.MeasurementBackup(k).EDSpectrum;
        end
%         h.DataTmpBackup = h.DataTmp;
    end

    % If Emin and Emax have not been set, set them to the min and max value of
    % the raw data
    if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
        if strcmp(get(h.editfieldselectmeas4,'String'),'Emin') && strcmp(get(h.editfieldselectmeas5,'String'),'Emax')
            h.P.EnergyRange = [ceil(min(h.DataTmp{1}(:,1))) ceil(max(h.DataTmp{1}(:,1)))-1];
        else
            h.P.EnergyRange = [str2double(get(h.editfieldselectmeas4,'String')) str2double(get(h.editfieldselectmeas5,'String'))];
        end
    elseif strcmp(h.Diffsel,'LEDDI')
        if strcmp(h.Detsel,'Detector 1')
            if strcmp(get(h.editfieldselectmeas4,'String'),'Emin') && strcmp(get(h.editfieldselectmeas5,'String'),'Emax')
                h.P.EnergyRangeDet1 = [ceil(min(h.DataTmp{1}(:,1))) ceil(max(h.DataTmp{1}(:,1)))-1];
            else
                h.P.EnergyRangeDet1 = [str2double(get(h.editfieldselectmeas4,'String')) str2double(get(h.editfieldselectmeas5,'String'))];
            end
        elseif strcmp(h.Detsel,'Detector 2')
            if strcmp(get(h.editfieldselectmeas4,'String'),'Emin') && strcmp(get(h.editfieldselectmeas5,'String'),'Emax')
                h.P.EnergyRangeDet2 = [ceil(min(h.DataTmp{1}(:,1))) ceil(max(h.DataTmp{1}(:,1)))-1];
            else
                h.P.EnergyRangeDet2 = [str2double(get(h.editfieldselectmeas4,'String')) str2double(get(h.editfieldselectmeas5,'String'))];
            end
        end
    end

    % Run "SelectMeasurementsGUI" script
    if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
        % Create variable in order to save unedited spectra (only if it was not
        % already created)
        if ~isfield(h, 'SpectrumBackup')
            h.SpectrumBackup = cell(1,length(h.Measurement));
        end
        % Create variable from object in order not to overwrite object data
        Measurement = h.MeasurementBackup;
        [meas,Sample,EnergyRange,SpectrumBackup] = SelectMeasurementsGUI(Measurement,h.Substrate,h.Sample,h.P,h.SpectrumBackup);
        h.SpectrumBackup = SpectrumBackup;
    elseif strcmp(h.Diffsel,'LEDDI')
        if strcmp(h.Detsel,'Detector 1')
            % Create variable in order to save unedited spectra (only if it was not
            % already created)
            if ~isfield(h, 'SpectrumBackupDet1')
                h.SpectrumBackupDet1 = cell(1,length(h.MeasurementBackup)/2);
            end
            Slidersteps = 2:2:length(h.MeasurementBackup);
            % Create variable from object in order not to overwrite object data
            Measurement = h.MeasurementBackup(Slidersteps);
            [meas,Sample,EnergyRange,SpectrumBackup] = SelectMeasurementsGUI(Measurement,h.Substrate,h.Sample,h.P,h.SpectrumBackupDet1);
            h.SpectrumBackupDet1 = SpectrumBackup;
        elseif strcmp(h.Detsel,'Detector 2')
            % Create variable in order to save unedited spectra (only if it was not
            % already created)
            if ~isfield(h, 'SpectrumBackupDet2')
                h.SpectrumBackupDet2 = cell(1,length(h.MeasurementBackup)/2);
            end
            Slidersteps = 1:2:length(h.MeasurementBackup);
            % Create variable from object in order not to overwrite object data
            Measurement = h.MeasurementBackup(Slidersteps);
            [meas,Sample,EnergyRange,SpectrumBackup] = SelectMeasurementsGUI(Measurement,h.Substrate,h.Sample,h.P,h.SpectrumBackupDet2);
            h.SpectrumBackupDet2 = SpectrumBackup;
        end
    end
%     assignin('base','meas',meas)
    % Set output to variables
    h.Sample = Sample;
    % Define energy range
    if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
        h.EnergyRange = EnergyRange;
        % Update DataTmp
        h.DataTmp = cell(1, length(meas));
        for c = 1:length(meas)
            h.DataTmp{c} = meas(c).EDSpectrum;
        end
        % Update Measurement
        h.Measurement = meas;
%         assignin('base','Measurement',h.Measurement)
    elseif strcmp(h.Diffsel,'LEDDI')
        if strcmp(h.Detsel,'Detector 1')
            % Energy range for Det1
            h.EnergyRangeDet1 = EnergyRange;
            % Plot data considering the user defined energy range
            SliderstepsDet1 = 2:2:length(h.Measurement);
%             SliderstepsDet1keep = SliderstepsDet1(h.P.WhichMeasurements);
%             indexkeepDet1 = ismember(SliderstepsDet1,SliderstepsDet1keep);
%             SliderstepsDet1del = SliderstepsDet1(~indexkeepDet1);
            h.DataTmpDet1 = cell(1, length(meas));
            for c = 1:length(meas)
                h.DataTmpDet1{c} = meas(c).EDSpectrum;
                h.Measurement(SliderstepsDet1(c)) = meas(c);
            end

        elseif strcmp(h.Detsel,'Detector 2')
            h.EnergyRangeDet2 = EnergyRange;
            % Plot data considering the user defined energy range
            h.DataTmpDet2 = cell(1, length(meas));
            SliderstepsDet2 = 1:2:length(h.Measurement);
%             SliderstepsDet2 = SliderstepsDet2(h.P.WhichMeasurements);
            for c = 1:length(meas)
                h.DataTmpDet2{c} = meas(c).EDSpectrum;
                h.Measurement(SliderstepsDet2(c)) = meas(c);
            end
        end
        % Combine plot data from both detectors
        if isfield(h, 'DataTmpDet1')
            SliderstepsDet1 = 2:2:length(h.Measurement);
            h.DataTmp(SliderstepsDet1) = h.DataTmpDet1;
        end
        if isfield(h, 'DataTmpDet2')
            SliderstepsDet2 = 1:2:length(h.Measurement);
            h.DataTmp(SliderstepsDet2) = h.DataTmpDet2;
        end
    end

else
    %% Nr of Spectra to integrate [integer]
    Binning = str2double(get(h.editfieldselectmeas6,'String'));
    % [1 | 0] Discard remaining scans without integration
    DiscardRemainder = get(h.checkboxselectmeas2,'Value');
    % Energy Range of Interest
    EnergyRange = [str2double(get(h.editfieldselectmeas4,'String')) str2double(get(h.editfieldselectmeas5,'String'))];
    % Energy Resolution
    EnergyRes = 0.01;                                                          

    % Processing
    if Binning ~= 1
        if Binning > length(h.Measurement)
            Binning = length(h.Measurement);
        end
        % Nr of spectra
        NrMeas = length(h.Measurement);
        % Computing Energy Scale
        X = linspace(EnergyRange(1),EnergyRange(2),...
                 (EnergyRange(2)-EnergyRange(1))/EnergyRes);
        % Make Copy of h.Measurement
        h.MeasurementInt = h.Measurement.Clone;
        h.MeasurementBackup = h.Measurement.Clone;
        % Choose every "n th" h.Measurement
        h.MeasurementInt = h.MeasurementInt(1:Binning:NrMeas);                     

        %Loop over h.Measurements
        for i = Binning:Binning:NrMeas 
           % Sum up RealTime
           h.MeasurementInt(i/Binning).RealTime = sum([h.Measurement(i-Binning+1:i).RealTime]);
           % Sum up DeadTime                                  
           h.MeasurementInt(i/Binning).DeadTime = mean([h.Measurement(i-Binning+1:i).DeadTime]);
           %Loop over spectra to integrate                                  
           for j = 1:Binning
               % Save current EDSpectrum
               EDSpectrum = h.Measurement(i-Binning+j).EDSpectrum;
               % Interpolate Spectrum on common Energy range vector
               Intensity_interp(j,:) = interp1(EDSpectrum(:,1),EDSpectrum(:,2),X);
           end
           % Integrate Spectra to new EDSpectrum
           NewEDSpectrum = [X;sum(Intensity_interp,1)]';
           % Delete NaN entries
           NewEDSpectrum = NewEDSpectrum(~any(isnan(NewEDSpectrum),2),:);
           % Overwrite prior spectrum data
           h.MeasurementInt(i/Binning).EDSpectrum = NewEDSpectrum;
        end

        % if remainder should be removed and if remainder is present 
        if DiscardRemainder && logical((NrMeas - i))
            % remove remainder
            h.MeasurementInt(end) = [];
        end
        %% Overwrite Data
        % Backup Measurement data
%         h.MeasurementBackup = h.Measurement.Clone;
        % Overwrite h.Measurement object with integrated data
        h.Measurement = h.MeasurementInt;                                              
        % Screen Output
        disp('spectra integrated');                                          
    end
end    
%     %% Select measurements depending on the diffractometer and measurement mode used.
%     
%     if strcmp(h.measmode,'Reflection') || strcmp(h.measmode,'Transmission') %measmode == 'Reflection' || measmode == 'Transmission'
%         h.P.WhichMeasurementsDetector(1) = 1;
%         h.P.WhichMeasurementsDetector(2) = length(h.Measurement);
%         h.P.WhichMeasurements = 1:length(h.Measurement);
%         for k = 1:length(h.Measurement)
%             h.DataTmp{k} = h.Measurement(k).EDSpectrum;
%         end
% %     elseif strcmp(measmode,'LEDDI Mode-I') || strcmp(measmode,'LEDDI Mode-II') || strcmp(measmode,'LEDDI Horizontal') || strcmp(measmode,'LEDDI Vertical')
% %         % For LEDDI mode: selection of spectra not implemented yet
% %         h.P.WhichMeasurementsDetector(1) = 1;
% %         h.P.WhichMeasurementsDetector(2) = length(h.Measurement);
% %         h.P.WhichMeasurements = 1:length(h.Measurement);
% %         if strcmp(Detsel,'Detector 1')
% %             Slidersteps = 2:2:length(h.Measurement);
% %             for k = 1:length(Slidersteps)
% %                 h.DataTmpDet1{k} = h.Measurement(Slidersteps(k)).EDSpectrum;
% %             end
% %         elseif strcmp(Detsel,'Detector 2')
% %             Slidersteps = 1:2:length(h.Measurement);
% %             for k = 1:length(Slidersteps)
% %                 h.DataTmpDet2{k} = h.Measurement(Slidersteps(k)).EDSpectrum;
% %             end
% %         end  
%     end
%     
%     % If Emin and Emax have not been set, set them to the min and max value of
%     % the raw data
%     if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160')
%         if strcmp(get(h.editfieldselectmeas4,'String'),'Emin') && strcmp(get(h.editfieldselectmeas5,'String'),'Emax')
%             h.P.EnergyRange = [ceil(min(h.DataTmp{1}(:,1))) ceil(max(h.DataTmp{1}(:,1)))-1];
%         else
%             h.P.EnergyRange = [str2double(get(h.editfieldselectmeas4,'String')) str2double(get(h.editfieldselectmeas5,'String'))];
%         end
%         h.Sample.Materials.EnergyMax = h.P.EnergyRange(2);
%     elseif strcmp(h.Diffsel,'LEDDI')
%         if strcmp(h.Detsel,'Detector 1')
%             if strcmp(get(h.editfieldselectmeas4,'String'),'Emin') && strcmp(get(h.editfieldselectmeas5,'String'),'Emax')
%                 h.P.EnergyRangeDet1 = [ceil(min(h.DataTmp{1}(:,1))) ceil(max(h.DataTmp{1}(:,1)))-1];
%             else
%                 h.P.EnergyRangeDet1 = [str2double(get(h.editfieldselectmeas4,'String')) str2double(get(h.editfieldselectmeas5,'String'))];
%             end
%             h.Sample.Materials.EnergyMax = h.P.EnergyRangeDet1(2);
%         elseif strcmp(h.Detsel,'Detector 2')
%             if strcmp(get(h.editfieldselectmeas4,'String'),'Emin') && strcmp(get(h.editfieldselectmeas5,'String'),'Emax')
%                 h.P.EnergyRangeDet2 = [ceil(min(h.DataTmp{1}(:,1))) ceil(max(h.DataTmp{1}(:,1)))-1];
%             else
%                 h.P.EnergyRangeDet2 = [str2double(get(h.editfieldselectmeas4,'String')) str2double(get(h.editfieldselectmeas5,'String'))];
%             end
%             h.Sample.Materials.EnergyMax = h.P.EnergyRangeDet2(2);
%         end
%     end
    
    if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
        h.Measurement = h.Measurement(h.P.WhichMeasurementsDetector(1):h.P.WhichMeasurementsDetector(2));
        if length(h.Measurement) == 1
            set(h.Slider,'Min',1);
            set(h.Slider,'Max',length(h.Measurement));
            set(h.Slider,'SliderStep',[1 1]);
            set(h.Slider,'Visible','off');
        else
            set(h.Slider,'Min',1);
            set(h.Slider,'Max',length(h.Measurement));
            set(h.Slider,'SliderStep',[1/(length(h.Measurement)-1) 1/(length(h.Measurement)-1)]);
        end
    elseif strcmp(h.Diffsel,'LEDDI')
        if strcmp(h.Detsel,'Detector 1')
           if length(h.DataTmpDet1) == 1
                set(h.Slider,'Min',1);
                set(h.Slider,'Max',length(h.DataTmpDet1));
                set(h.Slider,'SliderStep',[1 1]);
                set(h.Slider,'Visible','off');
            else
                set(h.Slider,'Min',1);
                set(h.Slider,'Max',length(h.DataTmpDet1));
                set(h.Slider,'SliderStep',[1/(length(h.DataTmpDet1)-1) 1/(length(h.DataTmpDet1)-1)]);
            end
        elseif strcmp(h.Detsel,'Detector 2')
            if length(h.DataTmpDet2) == 1
                set(h.Slider,'Min',1);
                set(h.Slider,'Max',length(h.DataTmpDet2));
                set(h.Slider,'SliderStep',[1 1]);
                set(h.Slider,'Visible','off');
            else
                set(h.Slider,'Min',1);
                set(h.Slider,'Max',length(h.DataTmpDet2));
                set(h.Slider,'SliderStep',[1/(length(h.DataTmpDet2)-1) 1/(length(h.DataTmpDet2)-1)]);
            end    
        end
    end
 
% end
% Get slider value
valueSlider = round(get(h.Slider, 'Value'));
% Set plot data and change energy range according to USER input
if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    set(h.plotdata,'xdata',h.DataTmp{valueSlider}(:,1))
    set(h.plotdata,'ydata',h.DataTmp{valueSlider}(:,2))
    % Set plot title
    % Consider changes of the number of measurements (or deleted plots)
    set(h.axesplotRawData.Title,'String',['Measurement data for ', h.Measurement(1).Name])
    h.axesplotRawData.XLim = h.P.EnergyRange;
    % Get theoretical peak positions
    a = h.TPeaks.T.Etheo > h.P.EnergyRange(1) & h.TPeaks.T.Etheo < h.P.EnergyRange(2);
    h.FitPeaksLogicalErange = a;
    X3Limit = h.TPeaks.T.X3((1:(3*find(a, 1, 'last')-1)),:);
    Y3Limit = h.TPeaks.T.Y3((1:(3*find(a, 1, 'last')-1)),:);
    if h.P.ShowSubstratePeaks == 1
        b = h.TPeaks.S.Etheo < h.TPeaks.S.EMax;
        SEtheoLimit = h.TPeaks.S.Etheo(b);
%         SX1Limit = h.TPeaks.S.X1(b,:);
        SX3Limit = h.TPeaks.S.X3((1:(3*length(SEtheoLimit)-1)),:);
        SY3Limit = h.TPeaks.S.Y3((1:(3*length(SEtheoLimit)-1)),:);
    end
    % Change Ymax according to energy range
    set(h.plotEtheo,'xdata',X3Limit(:,valueSlider))
    set(h.plotEtheo,'ydata',Y3Limit(:,valueSlider).*(max(h.DataTmp{valueSlider}(:,2))/max(Y3Limit(:,valueSlider))))
    if isfield(h, 'PeaksTheoAdd') 
        Y3LimitAdd1 = h.PeaksTheoAdd.T.Y3((1:(3*length(h.EtheoLimitPeaksAdd1)-1)),:);
        set(h.plotEtheoAdd1,'ydata',Y3LimitAdd1(:,valueSlider).*(max(h.DataTmp{valueSlider}(:,2))/max(Y3LimitAdd1(:,valueSlider))))
    end
    if h.P.ShowSubstratePeaks == 1
        set(h.plotEtheoSub,'xdata',SX3Limit(:,valueSlider))
        set(h.plotEtheoSub,'ydata',SY3Limit(:,valueSlider).*(max(h.DataTmp{valueSlider}(:,2))/max(SY3Limit(:,valueSlider))))
    end
    % Set data for table with hkl, d-spacing and E[keV] values
    if ~isfield(h, 'TableBkgColorArray')
        set(h.tablephasehkl,'data',[num2cell(h.TPeaks.T.Peaks(a,:)) num2cell(false(size(num2cell(h.TPeaks.T.Peaks(a,:)),1),1))])
    else
        PeakSelLogical = false(length(h.TableBkgColorArray(:,3)),1);
        PeakSelLogical(h.TableBkgColorArray(:,3)==0.6) = true;
        set(h.tablephasehkl,'data',[num2cell(h.TPeaks.T.Peaks(a,:)) num2cell(PeakSelLogical)])
    end
    
    if h.P.ShowSubstratePeaks == 1
        set(h.tablephasehkl2,'data',h.TPeaks.S.Peaks(b,:))
    end
elseif strcmp(h.Diffsel,'LEDDI')
    if strcmp(h.Detsel,'Detector 1')
        % Set plot data and limits
        Slidersteps = 2:2:length(h.Measurement);
        set(h.plotdata,'xdata',h.DataTmp{Slidersteps(valueSlider)}(:,1))
        set(h.plotdata,'ydata',h.DataTmp{Slidersteps(valueSlider)}(:,2))
        % Set plot title
        % Consider changes of the number of measurements (or deleted plots)
        set(h.axesplotRawData.Title,'String',['Measurement data for ', h.Measurement(Slidersteps(valueSlider)).Name])
        h.axesplotRawData.XLim = h.P.EnergyRangeDet1;
        % Get theoretical peak positions
        h.TPeaksDet1 = TheoreticalPeakPositions(h.MeasurementBackup(Slidersteps),h.DataTmp(Slidersteps));
%         assignin('base','TPeaksDet1',h.TPeaksDet1)
        a = h.TPeaksDet1.T.Etheo > h.P.EnergyRangeDet1(1) & h.TPeaksDet1.T.Etheo < h.P.EnergyRangeDet1(2);
%         assignin('base','a',a)
        h.FitPeaksLogicalErangeDet1 = a;
        X3Limit = h.TPeaksDet1.T.X3((1:(3*find(a, 1, 'last')-1)),:);
        Y3Limit = h.TPeaksDet1.T.Y3((1:(3*find(a, 1, 'last')-1)),:);
        if h.P.ShowSubstratePeaks == 1
            b = h.TPeaks.S.Etheo < h.TPeaks.S.EMax;
            SEtheoLimit = h.TPeaks.S.Etheo(b);
%             SX1Limit = h.TPeaks.S.X1(b,:);
            SX3Limit = h.TPeaks.S.X3((1:(3*length(SEtheoLimit)-1)),:);
            SY3Limit = h.TPeaks.S.Y3((1:(3*length(SEtheoLimit)-1)),:);
        end
        % Change Ymax according to energy range        
        set(h.plotEtheo,'xdata',X3Limit(:,valueSlider))
        set(h.plotEtheo,'ydata',Y3Limit(:,valueSlider).*(max(h.DataTmp{1,Slidersteps(valueSlider)}(:,2))/max(Y3Limit(:,valueSlider))))
        h.axesplotRawData.YLim =[-Inf round(max(h.DataTmp{Slidersteps(valueSlider)}(:,2)),-1)];
        if isfield(h, 'PeaksTheoAdd') 
            Y3LimitAdd1 = h.PeaksTheoAdd.T.Y3((1:(3*length(h.EtheoLimitPeaksAdd1)-1)),:);
            set(h.plotEtheoAdd1,'ydata',Y3LimitAdd1(:,valueSlider).*(max(h.DataTmp{Slidersteps(valueSlider)}(:,2))/max(Y3LimitAdd1(:,valueSlider))))
        end
        if h.P.ShowSubstratePeaks == 1
            set(h.plotEtheoSub,'xdata',SX3Limit(:,valueSlider))
            set(h.plotEtheoSub,'ydata',SY3Limit(:,valueSlider).*(max(h.DataTmp{Slidersteps(valueSlider)}(:,2))/max(SY3Limit(:,valueSlider))))
        end
        % Set data for table with hkl, d-spacing and E[keV] values
        if ~isfield(h, 'TableBkgColorArrayDet1')
            set(h.tablephasehkl,'data',[num2cell(h.TPeaksDet1.T.Peaks(a,:)) num2cell(false(size(num2cell(h.TPeaksDet1.T.Peaks(a,:)),1),1))])
        else
            PeakSelLogical = false(length(h.TableBkgColorArrayDet1(:,3)),1);
            PeakSelLogical(h.TableBkgColorArrayDet1(:,3)==0.6) = true;
            set(h.tablephasehkl,'data',[num2cell(h.TPeaksDet1.T.Peaks(a,:)) num2cell(PeakSelLogical)])
        end
        
        if h.P.ShowSubstratePeaks == 1
            set(h.tablephasehkl2,'data',h.TPeaks.S.Peaks(b,:))
        end
    elseif strcmp(h.Detsel,'Detector 2')
        % Set plot data and limits
        Slidersteps = 1:2:length(h.Measurement);
        set(h.plotdata,'xdata',h.DataTmp{Slidersteps(valueSlider)}(:,1))
        set(h.plotdata,'ydata',h.DataTmp{Slidersteps(valueSlider)}(:,2))
        % Set plot title
        % Consider changes of the number of measurements (or deleted plots)
        set(h.axesplotRawData.Title,'String',['Measurement data for ', h.Measurement(Slidersteps(valueSlider)).Name])
        h.axesplotRawData.XLim = h.P.EnergyRangeDet2;
        % Get theoretical peak positions
        h.TPeaksDet2 = TheoreticalPeakPositions(h.Measurement(Slidersteps),h.DataTmp(Slidersteps));
        a = h.TPeaksDet2.T.Etheo > h.P.EnergyRangeDet2(1) & h.TPeaksDet2.T.Etheo < h.P.EnergyRangeDet2(2);
        h.FitPeaksLogicalErangeDet2 = a;
%         X1Limit = h.TPeaksDet2.T.X1(a,:);
        X3Limit = h.TPeaksDet2.T.X3((1:(3*find(a, 1, 'last')-1)),:);
        Y3Limit = h.TPeaksDet2.T.Y3((1:(3*find(a, 1, 'last')-1)),:);
        if h.P.ShowSubstratePeaks == 1
            b = h.TPeaks.S.Etheo < h.TPeaks.S.EMax;
            SEtheoLimit = h.TPeaks.S.Etheo(b);
%             SX1Limit = h.TPeaks.S.X1(b,:);
            SX3Limit = h.TPeaks.S.X3((1:(3*length(SEtheoLimit)-1)),:);
            SY3Limit = h.TPeaks.S.Y3((1:(3*length(SEtheoLimit)-1)),:);
        end
        % Change Ymax according to energy range        
        set(h.plotEtheo,'xdata',X3Limit(:,valueSlider))
        set(h.plotEtheo,'ydata',Y3Limit(:,valueSlider).*(max(h.DataTmp{Slidersteps(valueSlider)}(:,2))/max(Y3Limit(:,valueSlider))))
        h.axesplotRawData.YLim =[-Inf round(max(h.DataTmp{Slidersteps(valueSlider)}(:,2)),-1)];
        if isfield(h, 'PeaksTheoAdd') 
            Y3LimitAdd1 = h.PeaksTheoAdd.T.Y3((1:(3*length(h.EtheoLimitPeaksAdd1)-1)),:);
            set(h.plotEtheoAdd1,'ydata',Y3LimitAdd1(:,Slidersteps(valueSlider)).*(max(h.DataTmp{Slidersteps(valueSlider)}(:,2))/max(Y3LimitAdd1(:,Slidersteps(valueSlider)))))
        end
        if h.P.ShowSubstratePeaks == 1
            set(h.plotEtheoSub,'xdata',SX3Limit(:,valueSlider))
            set(h.plotEtheoSub,'ydata',SY3Limit(:,valueSlider).*(max(h.DataTmp{Slidersteps(valueSlider)}(:,2))/max(SY3Limit(:,Slidersteps(valueSlider)))))
        end
        % Set data for table with hkl, d-spacing and E[keV] values
        if ~isfield(h, 'TableBkgColorArrayDet2')
            set(h.tablephasehkl,'data',[num2cell(h.TPeaksDet2.T.Peaks(a,:)) num2cell(false(size(num2cell(h.TPeaksDet2.T.Peaks(a,:)),1),1))])
        else
            PeakSelLogical = false(length(h.TableBkgColorArrayDet2(:,3)),1);
            PeakSelLogical(h.TableBkgColorArrayDet2(:,3)==0.6) = true;
            set(h.tablephasehkl,'data',[num2cell(h.TPeaksDet2.T.Peaks(a,:)) num2cell(PeakSelLogical)])
        end
        if h.P.ShowSubstratePeaks == 1
            set(h.tablephasehkl2,'data',h.TPeaks.S.Peaks(b,:))
        end
    end
end
% assignin('base','DataTmp1',h.DataTmp)
% assignin('base','Measurement',h.Measurement)
% assignin('base','MeasurementBackup',h.MeasurementBackup)
% Messagebox
msgbox({'Measurements selected'});

guidata(hObj, h);

function popupmenuCallback7(hObj,~)
% Callback for "pop up menu" in corrections panel
h = guidata(hObj);
% Determine the selected measurement mode
% str = get(hObj, 'String');
val = get(hObj, 'Value');
h.P.PopupValueMpd7 = val;

guidata(hObj,h);

function SelectDetectorCallback(hObj,~)
% Callback for "Select detector menu" in select measurement panel that
% allows to switch between data of the two detectors
h = guidata(hObj);
% Get slider value
valueSlider = round(get(h.Slider, 'Value'));
% Determine the selected detector
val = get(hObj, 'Value');
h.P.DetectorLEDDIselected = val;

% If detector 1 has been selected
if h.P.DetectorLEDDIselected == 2
    % Set slider properties
    if length(h.Measurement)/2 == 1
        set(h.Slider,'Min',0);
        set(h.Slider,'Max',1);
        set(h.Slider,'SliderStep',[1 1]);
    else
        set(h.Slider,'Min',1);
        set(h.Slider,'Max',length(h.Measurement)/2);
        set(h.Slider,'SliderStep',[1/((length(h.Measurement)/2)-1) 1/((length(h.Measurement)/2)-1)]);
    end
    Slidersteps = 2:2:length(h.Measurement);
    % Set plot data
    set(h.plotdata,'xdata',h.DataTmp{Slidersteps(valueSlider)}(:,1))
    set(h.plotdata,'ydata',h.DataTmp{Slidersteps(valueSlider)}(:,2))
    set(h.plotdataZoom,'xdata',h.DataTmp{Slidersteps(1)}(:,1))
    set(h.plotdataZoom,'ydata',h.DataTmp{Slidersteps(1)}(:,2))
    % Set XLim and YLim, depending whether an energy range has been defined
    % by the user
    if isfield(h, 'EnergyRangeDet1')
        h.axesplotRawData.XLim = h.P.EnergyRangeDet1;
    else
        h.axesplotRawData.XLim = [ceil(min(h.DataTmp{Slidersteps(valueSlider)}(:,1))) 60];
    end
    h.axesplotRawData.YLim =[-Inf round(max(h.DataTmp{Slidersteps(valueSlider)}(:,2)),-1)];
    % Set measurement title
    set(h.axesplotRawData.Title,'String',['Measurement Data for ', h.Measurement(Slidersteps(valueSlider)).Name])
    % Set peak properties (Pos, Int etc.) of theoretical peaks, depending
    % whether an energy range has been defined by the user
    h.TPeaksDet1 = TheoreticalPeakPositions(h.Measurement(Slidersteps),h.DataTmp(Slidersteps));
    if isfield(h, 'EnergyRangeDet1')
        a = h.TPeaksDet1.T.Etheo > h.P.EnergyRangeDet1(1) & h.TPeaksDet1.T.Etheo < h.P.EnergyRangeDet1(2);
    else
        a = h.TPeaksDet1.T.Etheo < h.TPeaksDet1.T.EMax;
    end
%     EtheoLimit = h.TPeaksDet1.T.Etheo(a);
%     X1Limit = h.TPeaksDet1.T.X1(a,:);
    X3Limit = h.TPeaksDet1.T.X3((1:(3*find(a, 1, 'last')-1)),:);
    Y3Limit = h.TPeaksDet1.T.Y3((1:(3*find(a, 1, 'last')-1)),:);
    set(h.plotEtheo,'xdata',X3Limit(:,1))
    % Set table data for theoretical peak positions
%     set(h.tablephasehkl,'data',h.TPeaksDet1.T.Peaks(a,:))
    set(h.tablephasehkl,'data',[num2cell(h.TPeaksDet1.T.Peaks(a,:)) num2cell(false(size(num2cell(h.TPeaksDet1.T.Peaks(a,:)),1),1))])
    % Set YLim of theoretical peaks and set user defined energy range in
    % the GUI, depending whether an energy range has been defined by the
    % user
    if isfield(h, 'EnergyRangeDet1')
        set(h.plotEtheo,'ydata',Y3Limit(:,valueSlider).*(max(h.DataTmp{Slidersteps(valueSlider)}(:,2))/max(Y3Limit(:,valueSlider))))
        h.axesplotRawData.YLim =[-Inf round(max(h.DataTmp{Slidersteps(valueSlider)}(:,2)),-1)];
        % Set GUI fields for energy range
        set(h.editfieldselectmeas4,'String',num2str(floor(h.P.EnergyRangeDet1(1))))
        set(h.editfieldselectmeas5,'String',num2str(floor(h.P.EnergyRangeDet1(2))))
    else
        set(h.plotEtheo,'ydata',Y3Limit(:,valueSlider).*(max(h.DataTmp{1,Slidersteps(valueSlider)}(:,2))/max(Y3Limit(:,valueSlider))))
        h.axesplotRawData.YLim =[-Inf round(max(h.DataTmp{Slidersteps(valueSlider)}(:,2)),-1)];
        % Set GUI fields for energy range
        set(h.editfieldselectmeas4,'String','Emin')
        set(h.editfieldselectmeas5,'String','Emax')
    end
    % Set backgroundpoints, if defined by user
    if isfield(h, 'PeakRegionsXdataDet1')
        set(h.tablebkgdata,'data',h.PeakRegionsXDet1{valueSlider})
        set(h.plotbkgpoints,'xdata',[h.PeakRegionsXdataDet1{valueSlider,:}])
        set(h.plotbkgpoints,'ydata',[h.PeakRegionsYdataDet1{valueSlider,:}])
        set(h.plotbkgpoints,'Visible','on')
    else
        % Set BKG points table data
        BkgDataDet1 = [zeros(1,6);zeros(1,6)];
        set(h.tablebkgdata,'data',BkgDataDet1)
        if isfield(h, 'plotbkgpoints')
            set(h.plotbkgpoints,'Visible','off')
        end
    end
    % Set corrected background data, if bkg was already fitted
    if isfield(h, 'DataTmpToAcceptDet1') && ~isfield(h, 'FittedPeaksDet1')
        set(h.plotBKG,'xdata',h.DataTmpToAcceptDet1{valueSlider}(:,1))
        set(h.plotBKG,'ydata',h.DataTmpToAcceptDet1{valueSlider}(:,2))
        set(h.plotbkgpoints,'Visible','off')
    end
    % Set user defined peak positions
    if isfield(h, 'PeaksDet1')
        Slidersteps = 2:2:length(h.Measurement);
%         set(h.tablepeakdata,'data',h.PeaksDet1{valueSlider})
        set(h.tablepeakdata,'data',[h.PeaksDet1{valueSlider};h.Peakslb{valueSlider};h.Peaksub{valueSlider}])
        % Interpolate RawData to get YData for PeakRegions
        h.DataInterpPeaksDet1 = interp1(h.DataTmp{Slidersteps(valueSlider)}(:,1),h.DataTmp{Slidersteps(valueSlider)}(:,2),h.PeaksDet1{valueSlider});
        % Plot of peak positions
        set(h.plotpeakpoints,'xdata',h.PeaksDet1{valueSlider})
        set(h.plotpeakpoints,'ydata',h.DataInterpPeaksDet1)
        set(h.plotpeakpoints,'visible','on')
        set(h.tablephasehkl,'BackgroundColor',h.TableBkgColorArrayDet1)
        % Set hkl table data. Set checkboxes according to user selected peaks.
        tabledata = get(h.tablephasehkl,'data');
        tabledata(1:end,6) = num2cell(logical(h.FitPeaksLogicalDet1(:,1)));
        set(h.tablephasehkl,'data',tabledata)
    else
        PeakDataDet1 = zeros(1,6);
%         set(h.tablepeakdata,'data',PeakDataDet1)
        set(h.tablepeakdata,'data',[PeakDataDet1;0.3.*ones(1,6);0.3.*ones(1,6)])
        if isfield(h, 'plotpeakpoints')
            set(h.plotpeakpoints,'visible','off')
        end
        TableBkgColor = [1 1 1];
        TableBkgColorArray = repmat(TableBkgColor,size(h.TPeaksDet1.T.Peaks(:,5),1),1);
        set(h.tablephasehkl,'BackgroundColor',TableBkgColorArray)
    end
    
    if isfield(h, 'FittedPeaksDet1')
        set(h.plotbkgpoints,'Visible','off')
        set(h.plotfits,'visible','off')
        set(h.plotfitresidual,'visible','off')
        Slidersteps = 2:2:length(h.Measurement);
        % Set RawData for current slider value
        XFit = h.DataTmp{Slidersteps(valueSlider)}(:, 1);
        YFit = h.DataTmp{Slidersteps(valueSlider)}(:, 2);
        % Set Fit-Data for current slider value
        XPlot = XFit(1):0.001:XFit(end);
        YPlot = zeros(size(XPlot));
        % Calculate fitted profile using Fitted PeakData for current slider
        % value
        for d = 1:size(h.FittedPeaksDet1{valueSlider}, 1)
            if h.P.PopupValueFitFunc == 2 %PV-Func
                SinglePlot = Tools.Science.Math.FF_PseudoVoigt(XPlot, ...
                    h.FittedPeaksDet1{valueSlider}(d, 1), h.FittedPeaksDet1{valueSlider}(d, 2), h.FittedPeaksDet1{valueSlider}(d, 3),h.FittedPeaksDet1{valueSlider}(d, 4));
            elseif h.P.PopupValueFitFunc == 3 %TCH-Func
                SinglePlot = Tools.Science.Math.FF_TCH(XPlot, ...
                    h.FittedPeaksDet1{valueSlider}(d, 1), h.FittedPeaksDet1{valueSlider}(d, 2), h.FittedPeaksDet1{valueSlider}(d, 3),h.FittedPeaksDet1{valueSlider}(d, 4));
            elseif h.P.PopupValueFitFunc == 4 %Gauss-Func
                SinglePlot = Tools.Science.Math.FF_Gauss(XPlot, ...
                    h.FittedPeaksDet1{valueSlider}(d, 1), h.FittedPeaksDet1{valueSlider}(d, 2), h.FittedPeaksDet1{valueSlider}(d, 3));
            elseif h.P.PopupValueFitFunc == 5 %Lorentz-Func
                SinglePlot = Tools.Science.Math.FF_Lorentz(XPlot, ...
                    h.FittedPeaksDet1{valueSlider}(d, 1), h.FittedPeaksDet1{valueSlider}(d, 2), h.FittedPeaksDet1{valueSlider}(d, 3));
            end
                YPlot = YPlot + SinglePlot;
        end
        % Add plots of fitted peaks and residual to axes according to current 
        % slider value
        set(h.plotfits,'xdata',XPlot)
        set(h.plotfits,'ydata',YPlot)
        % Set data of plot residual according to current slider value
        set(h.plotfitresidual,'xdata',XFit)
        YDataResidual = (YFit - interp1(XPlot,YPlot,XFit)) - (max(YFit) /4);
        set(h.plotfitresidual,'ydata', YDataResidual)
        % Set Ylim according to current slider value
        h.axesplotRawData.YLim = [-Inf round(max(h.DataTmp{Slidersteps(valueSlider)}(:,2)),-1)];
        
        % Set table data
        if h.P.PopupValueFitFunc == 2 %PV-Func
        set(h.tablefitresults,'data',[h.FittedPeaksCalctmpDet1{1,valueSlider}(:,7), h.FittedPeaksCalctmpDet1{1,valueSlider}(:,1),...
            h.FittedPeaksCalctmpDet1{1,valueSlider}(:,2),h.FittedPeaksCalctmpDet1{1,valueSlider}(:,3),...
            h.FittedPeaksCalctmpDet1{1,valueSlider}(:,5),h.FittedPeaksCalctmpDet1{1,valueSlider}(:,6),...
            h.FittedPeaksCalctmpDet1{1,valueSlider}(:,4)])
        elseif h.P.PopupValueFitFunc == 3 %TCH-Func
            set(h.tablefitresults,'data',[h.FittedPeaksCalctmpDet1{1,valueSlider}(:,1), h.FittedPeaksCalctmpDet1{1,valueSlider}(:,9),...
            h.FittedPeaksCalctmpDet1{1,valueSlider}(:,2),h.FittedPeaksCalctmpDet1{1,valueSlider}(:,3),...
            h.FittedPeaksCalctmpDet1{1,valueSlider}(:,4),h.FittedPeaksCalctmpDet1{1,valueSlider}(:,5),...
            h.FittedPeaksCalctmpDet1{1,valueSlider}(:,6),h.FittedPeaksCalctmpDet1{1,valueSlider}(:,7),...
            h.FittedPeaksCalctmpDet1{1,valueSlider}(:,8)])
        elseif h.P.PopupValueFitFunc == 4 || h.P.PopupValueFitFunc == 5 %Gauss %Lorentz
            set(h.tablefitresults,'data',[h.FittedPeaksCalctmpDet1{1,valueSlider}(:,6), h.FittedPeaksCalctmpDet1{1,valueSlider}(:,1),...
                h.FittedPeaksCalctmpDet1{1,valueSlider}(:,2),h.FittedPeaksCalctmpDet1{1,valueSlider}(:,3),...
                h.FittedPeaksCalctmpDet1{1,valueSlider}(:,4),h.FittedPeaksCalctmpDet1{1,valueSlider}(:,5)])
        end
        set(h.plotpeakpoints,'Visible','off')
        set(h.plotfits,'visible','on')
        set(h.plotfitresidual,'visible','on')
    else
        if isfield(h, 'plotfits')
            set(h.plotfits,'visible','off')
            set(h.plotfitresidual,'visible','off')
        end
    end
    
    if isfield(h, 'PsiFileTableDataDet1')
        % Set table data
        set(h.tablepsifile,'data',h.PsiFileTableDataDet1);
    end

% If detector 2 has been selected
elseif h.P.DetectorLEDDIselected == 3
    % Set slider properties
    if length(h.Measurement)/2 == 1
        set(h.Slider,'Min',0);
        set(h.Slider,'Max',1);
        set(h.Slider,'SliderStep',[1 1]);
    else
        set(h.Slider,'Min',1);
        set(h.Slider,'Max',length(h.Measurement)/2);
        set(h.Slider,'SliderStep',[1/((length(h.Measurement)/2)-1) 1/((length(h.Measurement)/2)-1)]);
    end
    Slidersteps = 1:2:length(h.Measurement);
    % Set plot data
    set(h.plotdata,'xdata',h.DataTmp{Slidersteps(valueSlider)}(:,1))
    set(h.plotdata,'ydata',h.DataTmp{Slidersteps(valueSlider)}(:,2))
    set(h.plotdataZoom,'xdata',h.DataTmp{Slidersteps(1)}(:,1))
    set(h.plotdataZoom,'ydata',h.DataTmp{Slidersteps(1)}(:,2))
    % Set XLim and YLim, depending whether an energy range has been defined
    % by the user
    if isfield(h, 'EnergyRangeDet2')
        h.axesplotRawData.XLim = h.P.EnergyRangeDet2;
    else
        h.axesplotRawData.XLim = [ceil(min(h.DataTmp{Slidersteps(valueSlider)}(:,1))) 60];
    end
    h.axesplotRawData.YLim =[-Inf round(max(h.DataTmp{Slidersteps(valueSlider)}(:,2)),-1)];
    % Set measurement title
    set(h.axesplotRawData.Title,'String',['Measurement Data for ', h.Measurement(Slidersteps(valueSlider)).Name])
    % Set peak properties (Pos, Int etc.) of theoretical peaks, depending
    % whether an energy range has been defined by the user
    h.TPeaksDet2 = TheoreticalPeakPositions(h.Measurement(Slidersteps),h.DataTmp(Slidersteps));
    if isfield(h, 'EnergyRangeDet2')
        a = h.TPeaksDet2.T.Etheo > h.P.EnergyRangeDet2(1) & h.TPeaksDet2.T.Etheo < h.P.EnergyRangeDet2(2);
    else
        a = h.TPeaksDet2.T.Etheo < h.TPeaksDet2.T.EMax;
    end
%     EtheoLimit = h.TPeaksDet2.T.Etheo(a);
%     X1Limit = h.TPeaksDet2.T.X1(a,:);
    X3Limit = h.TPeaksDet2.T.X3((1:(3*find(a, 1, 'last')-1)),:);
    Y3Limit = h.TPeaksDet2.T.Y3((1:(3*find(a, 1, 'last')-1)),:);
    set(h.plotEtheo,'xdata',X3Limit(:,1))
    % Set table data for theoretical peak positions
%     set(h.tablephasehkl,'data',h.TPeaksDet2.T.Peaks(a,:))
    set(h.tablephasehkl,'data',[num2cell(h.TPeaksDet2.T.Peaks(a,:)) num2cell(false(size(num2cell(h.TPeaksDet2.T.Peaks(a,:)),1),1))])
    % Set YLim of theoretical peaks and set user defined energy range in
    % the GUI, depending whether an energy range has been defined by the
    % user
    if isfield(h, 'EnergyRangeDet2')
        set(h.plotEtheo,'ydata',Y3Limit(:,valueSlider).*(max(h.DataTmp{Slidersteps(valueSlider)}(:,2))/max(Y3Limit(:,valueSlider))))
        h.axesplotRawData.YLim =[-Inf round(max(h.DataTmp{Slidersteps(valueSlider)}(:,2)),-1)];
        % Set GUI fields for energy range
        set(h.editfieldselectmeas4,'String',num2str(floor(h.P.EnergyRangeDet2(1))))
        set(h.editfieldselectmeas5,'String',num2str(floor(h.P.EnergyRangeDet2(2))))
    else
        set(h.plotEtheo,'ydata',Y3Limit(:,valueSlider).*(max(h.DataTmp{Slidersteps(valueSlider)}(:,2))/max(Y3Limit(:,valueSlider))))
        h.axesplotRawData.YLim =[-Inf round(max(h.DataTmp{Slidersteps(valueSlider)}(:,2)),-1)];
        % Set GUI fields for energy range
        set(h.editfieldselectmeas4,'String','Emin')
        set(h.editfieldselectmeas5,'String','Emax')
    end
    % Set backgroundpoints, if defined by user
    if isfield(h, 'PeakRegionsXdataDet2')
%         a = h.PeakRegionsXDet1;
%         b = h.plotbkgpoints;
        set(h.tablebkgdata,'data',h.PeakRegionsXDet2{valueSlider})
        set(h.plotbkgpoints,'xdata',[h.PeakRegionsXdataDet2{valueSlider,:}])
        set(h.plotbkgpoints,'ydata',[h.PeakRegionsYdataDet2{valueSlider,:}])
        set(h.plotbkgpoints,'visible','on')
    else
        % Set BKG points table data
        BkgDataDet2 = [zeros(1,6);zeros(1,6)];
        set(h.tablebkgdata,'data',BkgDataDet2)
        if isfield(h, 'plotbkgpoints')
            set(h.plotbkgpoints,'Visible','off')
        end
    end
    % Set corrected background data, if bkg was already fitted
    if isfield(h, 'DataTmpToAcceptDet2') && ~isfield(h, 'FittedPeaksDet2')
        set(h.plotBKG,'xdata',h.DataTmpToAcceptDet2{valueSlider}(:,1))
        set(h.plotBKG,'ydata',h.DataTmpToAcceptDet2{valueSlider}(:,2))
        set(h.plotbkgpoints,'Visible','off')
    end
    % Set user defined peak positions
    if isfield(h, 'PeaksDet2')
        Slidersteps = 1:2:length(h.Measurement);
%         set(h.tablepeakdata,'data',h.PeaksDet2{valueSlider})
        set(h.tablepeakdata,'data',[h.PeaksDet2{valueSlider};h.Peakslb{valueSlider};h.Peaksub{valueSlider}])
        % Interpolate RawData to get YData for PeakRegions
        h.DataInterpPeaksDet2 = interp1(h.DataTmp{Slidersteps(valueSlider)}(:,1),h.DataTmp{Slidersteps(valueSlider)}(:,2),h.PeaksDet2{valueSlider});
        % Plot of peak positions
        set(h.plotpeakpoints,'xdata',h.PeaksDet2{valueSlider})
        set(h.plotpeakpoints,'ydata',h.DataInterpPeaksDet2)
        set(h.plotpeakpoints,'visible','on')
        set(h.tablephasehkl,'BackgroundColor',h.TableBkgColorArrayDet2)
        % Set hkl table data. Set checkboxes according to user selected peaks.
        tabledata = get(h.tablephasehkl,'data');
        tabledata(1:end,6) = num2cell(logical(h.FitPeaksLogicalDet2(:,1)));
        set(h.tablephasehkl,'data',tabledata)
    else
        PeakDataDet2 = zeros(1,6);
%         set(h.tablepeakdata,'data',PeakDataDet2)
        set(h.tablepeakdata,'data',[PeakDataDet2;0.3.*ones(1,6);0.3.*ones(1,6)])
        if isfield(h, 'plotpeakpoints')
            set(h.plotpeakpoints,'visible','off')
        end
        TableBkgColor = [1 1 1];
        TableBkgColorArray = repmat(TableBkgColor,size(h.TPeaksDet2.T.Peaks(:,5),1),1);
        set(h.tablephasehkl,'BackgroundColor',TableBkgColorArray)
    end
    
    if isfield(h, 'FittedPeaksDet2')
        set(h.plotfits,'visible','off')
        set(h.plotfitresidual,'visible','off')
        set(h.plotbkgpoints,'Visible','off')
        Slidersteps = 1:2:length(h.Measurement);
        % Set RawData for current slider value
        XFit = h.DataTmp{Slidersteps(valueSlider)}(:, 1);
        YFit = h.DataTmp{Slidersteps(valueSlider)}(:, 2);
        % Set Fit-Data for current slider value
        XPlot = XFit(1):0.001:XFit(end);
        YPlot = zeros(size(XPlot));
        % Calculate fitted profile using Fitted PeakData for current slider
        % value
        for d = 1:size(h.FittedPeaksDet2{valueSlider}, 1)
            if h.P.PopupValueFitFunc == 2 %PV-Func
                SinglePlot = Tools.Science.Math.FF_PseudoVoigt(XPlot, ...
                    h.FittedPeaksDet2{valueSlider}(d, 1), h.FittedPeaksDet2{valueSlider}(d, 2), h.FittedPeaksDet2{valueSlider}(d, 3),h.FittedPeaksDet2{valueSlider}(d, 4));
            elseif h.P.PopupValueFitFunc == 3 %TCH-Func
                SinglePlot = Tools.Science.Math.FF_TCH(XPlot, ...
                    h.FittedPeaksDet2{valueSlider}(d, 1), h.FittedPeaksDet2{valueSlider}(d, 2), h.FittedPeaksDet2{valueSlider}(d, 3),h.FittedPeaksDet2{valueSlider}(d, 4));
            elseif h.P.PopupValueFitFunc == 4 %Gauss-Func
                SinglePlot = Tools.Science.Math.FF_Gauss(XPlot, ...
                    h.FittedPeaksDet2{valueSlider}(d, 1), h.FittedPeaksDet2{valueSlider}(d, 2), h.FittedPeaksDet2{valueSlider}(d, 3));
            elseif h.P.PopupValueFitFunc == 5 %Lorentz-Func
                SinglePlot = Tools.Science.Math.FF_Lorentz(XPlot, ...
                    h.FittedPeaksDet2{valueSlider}(d, 1), h.FittedPeaksDet2{valueSlider}(d, 2), h.FittedPeaksDet2{valueSlider}(d, 3));
            end
                YPlot = YPlot + SinglePlot;
        end
        % Add plots of fitted peaks and residual to axes according to current 
        % slider value
        set(h.plotfits,'xdata',XPlot)
        set(h.plotfits,'ydata',YPlot)
        % Set data of plot residual according to current slider value
        set(h.plotfitresidual,'xdata',XFit)
        YDataResidual = (YFit - interp1(XPlot,YPlot,XFit)) - (max(YFit) /4);
        set(h.plotfitresidual,'ydata', YDataResidual)
        % Set Ylim according to current slider value
        h.axesplotRawData.YLim = [-Inf round(max(h.DataTmp{Slidersteps(valueSlider)}(:,2)),-1)];
        
        % Set table data
        if h.P.PopupValueFitFunc == 2 %PV-Func
            set(h.tablefitresults,'data',[h.FittedPeaksCalctmpDet2{1,valueSlider}(:,7), h.FittedPeaksCalctmpDet2{1,valueSlider}(:,1),...
                h.FittedPeaksCalctmpDet2{1,valueSlider}(:,2),h.FittedPeaksCalctmpDet2{1,valueSlider}(:,3),...
                h.FittedPeaksCalctmpDet2{1,valueSlider}(:,5),h.FittedPeaksCalctmpDet2{1,valueSlider}(:,6),...
                h.FittedPeaksCalctmpDet2{1,valueSlider}(:,4)])
        elseif h.P.PopupValueFitFunc == 3 %TCH-Func
            set(h.tablefitresults,'data',[h.FittedPeaksCalctmpDet2{1,valueSlider}(:,1), h.FittedPeaksCalctmpDet2{1,valueSlider}(:,9),...
                h.FittedPeaksCalctmpDet2{1,valueSlider}(:,2),h.FittedPeaksCalctmpDet2{1,valueSlider}(:,3),...
                h.FittedPeaksCalctmpDet2{1,valueSlider}(:,4),h.FittedPeaksCalctmpDet2{1,valueSlider}(:,5),...
                h.FittedPeaksCalctmpDet2{1,valueSlider}(:,6),h.FittedPeaksCalctmpDet2{1,valueSlider}(:,7),...
                h.FittedPeaksCalctmpDet2{1,valueSlider}(:,8)])
        elseif h.P.PopupValueFitFunc == 4 || h.P.PopupValueFitFunc == 5 %Gauss %Lorentz
            set(h.tablefitresults,'data',[h.FittedPeaksCalctmpDet2{1,valueSlider}(:,6), h.FittedPeaksCalctmpDet2{1,valueSlider}(:,1),...
                h.FittedPeaksCalctmpDet2{1,valueSlider}(:,2),h.FittedPeaksCalctmpDet2{1,valueSlider}(:,3),...
                h.FittedPeaksCalctmpDet2{1,valueSlider}(:,4),h.FittedPeaksCalctmpDet2{1,valueSlider}(:,5)])
        end
        set(h.plotpeakpoints,'Visible','off')
        set(h.plotfits,'visible','on')
        set(h.plotfitresidual,'visible','on')
    else
        if isfield(h, 'plotfits')
            set(h.plotfits,'visible','off')
            set(h.plotfitresidual,'visible','off')
        end
    end
    
    if isfield(h, 'PsiFileTableDataDet2')
        % Set table data
        set(h.tablepsifile,'data',h.PsiFileTableDataDet2);
    end
end

guidata(hObj,h);

function undobuttonselectmeas(hObj,~)
% Callback for "Undo" pushbutton
h = guidata(hObj);
% Get uncorrected measurement data
for c = 1:length(h.Measurement)
    h.Measurement(c).EDSpectrum = h.DataTmp{c};
end

% Set strings for Emin Emax of panel "Select Measurements"
set(h.editfieldselectmeas4,'String',num2str(ceil(min(h.DataTmp{1}(:,1)))))
set(h.editfieldselectmeas5,'String',num2str(ceil(max(h.DataTmp{1}(:,1)))-1))
% Set slider parameter
if size(h.DataTmp,2) == 1
    set(h.Slider,'Min',0);
    set(h.Slider,'Max',size(h.DataTmp,2));
    set(h.Slider,'SliderStep',[1 1]);
else
    set(h.Slider,'Min',1);
    set(h.Slider,'Max',size(h.DataTmp,2));
    set(h.Slider,'SliderStep',[1/(size(h.DataTmp,2)-1) 1/(size(h.DataTmp,2)-1)]);
end
% Get slider value
valueSlider = round(get(h.Slider, 'Value'));
% Set plot data 
set(h.plotdata,'xdata',h.DataTmp{valueSlider}(:,1))
set(h.plotdata,'ydata',h.DataTmp{valueSlider}(:,2))
h.axesplotRawData.XLim = [0 Inf];
h.Measurement(1).Sample.Materials.EnergyMax = (ceil(max(h.DataTmp{1,1}(:,1)))-1);
h.TPeaks = TheoreticalPeakPositions(h.Measurement,h.DataTmp);
a = h.TPeaks.T.Etheo < h.TPeaks.T.EMax;
EtheoLimit = h.TPeaks.T.Etheo(a);
% X1Limit = h.TPeaks.T.X1(a,:);
X3Limit = h.TPeaks.T.X3((1:(3*length(EtheoLimit)-1)),:);
Y3Limit = h.TPeaks.T.Y3((1:(3*length(EtheoLimit)-1)),:);
if h.P.ShowSubstratePeaks == 1
    b = h.TPeaks.S.Etheo < h.TPeaks.S.EMax;
    SEtheoLimit = h.TPeaks.S.Etheo(b);
%     SX1Limit = h.TPeaks.S.X1(b,:);
    SX3Limit = h.TPeaks.S.X3((1:(3*length(SEtheoLimit)-1)),:);
    SY3Limit = h.TPeaks.S.Y3((1:(3*length(SEtheoLimit)-1)),:);
end
set(h.plotEtheo,'xdata',X3Limit(:,valueSlider))
set(h.plotEtheo,'ydata',Y3Limit(:,valueSlider).*(max(h.DataTmp{valueSlider}(:,2))/max(Y3Limit(:,valueSlider))))
if h.P.ShowSubstratePeaks == 1
    set(h.plotEtheoSub,'xdata',SX3Limit(:,valueSlider))
    set(h.plotEtheoSub,'ydata',SY3Limit(:,valueSlider).*(max(h.DataTmp{valueSlider}(:,2))/max(SY3Limit(:,valueSlider))))
end
% Set data for table with hkl, d-spacing and E[keV] values
% set(h.tablephasehkl,'data',h.TPeaks.T.Peaks(a,:))
set(h.tablephasehkl,'data',[num2cell(h.TPeaks.T.Peaks(a,:)) num2cell(false(size(num2cell(h.TPeaks.T.Peaks(a,:)),1),1))])
if h.P.ShowSubstratePeaks == 1
    set(h.tablephasehkl2,'data',h.TPeaks.S.Peaks(b,:))
end

guidata(hObj, h);

%% Background correction panel
function buttonselectbkg1(hObj, ~)
% Callback for "Define Background" button in background panel
h = guidata(hObj);
% Get slider value
valueSlider = round(get(h.Slider, 'Value'));

Detstr = get(h.popupmenuselectmeas1,'String');
Detval = get(h.popupmenuselectmeas1,'Value');
Detsel = Detstr{Detval};
h.Detsel = Detsel;

if strcmp(h.Diffsel,'LEDDI')
    if strcmp(h.Detsel,'Detector 1')
        Slidersteps = 2:2:length(h.Measurement);
    elseif strcmp(h.Detsel,'Detector 2')
        Slidersteps = 1:2:length(h.Measurement);
    end
else
    Slidersteps = 1:length(h.Measurement);
end

% Messagebox
k = msgbox('Set a marker left and right of each peak. Confirm by Enter.');
% Wait for user to press ok
uiwait(k);
% Show explanatory text for definitioin of background points
h.textbkg = text('Units','normalized','Position',[0.3 0.95 0],...
    'BackgroundColor',[1 1 1],'EdgeColor', [0 0 0], ...
    'String','Push \textbf{enter} to resume | \textbf{return} to undo',...
    'interpreter','latex','FontSize', 16);

% Calculate max Intensity of current plot in order to set limits of zoom.
IntMaxZoomtmp = cellfun(@max,h.DataTmp,'UniformOutput',0);
IntMaxZoom = round(IntMaxZoomtmp{Slidersteps(valueSlider)}(2));
IntMeanZoom = mean(h.DataTmp{Slidersteps(valueSlider)}(:,2));
% Slidersteps
% assignin('base','hDataTmp',h.DataTmp)
% Get points selected from user
% Set axes with zoomed data visible
set(h.axesplotRawDataZoom,'Visible','on')
set(h.plotdataZoom, 'Visible', 'on');
set(h.plotdataZoomCH, 'Visible', 'on');
[HT.x,~] = getptszoom(h.axesplotRawData,h.axesplotRawDataZoom,h.plotdataZoomCH,IntMaxZoom,IntMeanZoom,h.DataTmp{Slidersteps(valueSlider)});
% Set axes with zoomed data invisible
set(h.axesplotRawDataZoom,'Visible','off')
set(h.plotdataZoom, 'Visible', 'off');
set(h.plotdataZoomCH, 'Visible', 'off');
% Set explanatory text visible off
set(h.textbkg,'Visible','off')

% Find closest point to user selected point
indexUSP = Tools.Data.DataSetOperations.FindNearestIndex(h.DataTmp{Slidersteps(valueSlider)}(:,1),HT.x);
% assignin('base','indexUSP',indexUSP)
% assignin('base','DataTmp2',h.DataTmp)
if strcmp(h.Diffsel,'LEDDI')
    % Get x and y data in the range of +/- 5 channels of user selected bkg point
    xBKG = cell(1,1);
    yBKG = cell(1,1);
    for l = 1:size(h.DataTmp,2)/2
        for k = 1:length(indexUSP)
            indexBKG(:,k) = (indexUSP(k)-5):(indexUSP(k)+5);
            xBKG{l,k} = h.DataTmp{Slidersteps(l)}((indexUSP(k)-5):(indexUSP(k)+5),1);
            yBKG{l,k} = h.DataTmp{Slidersteps(l)}((indexUSP(k)-5):(indexUSP(k)+5),2);
        end
    end

    % Find min of yBKG
    indexYmin = cell(1);
    for l = 1:size(h.DataTmp,2)/2
        for k = 1:length(indexUSP)
            if all(yBKG{l,k} == 0)
                indexYmin{l,k} = 4;
            else
                indexYmin{l,k} = find(min(yBKG{l,k}(yBKG{l,k}>0)) == yBKG{l,k});
            end
        end
    end

    % Find and delete duplicate entries
    for l = 1:size(h.DataTmp,2)/2
        for k = 1:length(indexUSP)
            if length(indexYmin{l,k}) ~= 1
                indexYmin{l,k} = indexYmin{l,k}(1);
            end
        end
    end

    % Get index of Ymin
    indexYminDataTmp = cell(size(h.DataTmp,2)/2,length(indexUSP));
    for l = 1:size(h.DataTmp,2)/2
        for k = 1:length(indexUSP)
            indexYminDataTmp{l,k} = indexBKG(indexYmin{l,k},k); 
        end
    end
    % Get x and y data for Ymin and create PeakRegions data X and Y
    h.PeakRegionsXdata = cell(size(h.DataTmp,2)/2,length(indexUSP));
    h.PeakRegionsYdata = cell(size(h.DataTmp,2)/2,length(indexUSP));
    for l = 1:size(h.DataTmp,2)/2
        for k = 1:length(indexUSP)
            h.PeakRegionsXdata{l,k} = h.DataTmp{Slidersteps(l)}(indexYminDataTmp{l,k},1);
            h.PeakRegionsYdata{l,k} = h.DataTmp{Slidersteps(l)}(indexYminDataTmp{l,k},2);
        end
    end

    % Create PeakregionsX data
    h.PeakRegionsX = cell(size(h.DataTmp,2)/2,1);
    for l = 1:size(h.DataTmp,2)/2
        h.PeakRegionsX{l} = reshape([h.PeakRegionsXdata{l,:}],2,size([h.PeakRegionsXdata{l,:}],2)/2);
    end
else
    % Get x and y data in the range of +/- 5 channels of user selected bkg point
    xBKG = cell(1,1);
    yBKG = cell(1,1);
    for l = 1:size(h.DataTmp,2)
        for k = 1:length(indexUSP)
            indexBKG(:,k) = (indexUSP(k)-5):(indexUSP(k)+5);
            xBKG{l,k} = h.DataTmp{l}((indexUSP(k)-5):(indexUSP(k)+5),1);
            yBKG{l,k} = h.DataTmp{l}((indexUSP(k)-5):(indexUSP(k)+5),2);
        end
    end
%     assignin('base','yBKG',yBKG)
%     assignin('base','indexBKG',indexBKG)
%     assignin('base','xBKG',xBKG)
%     assignin('base','DataTmp',h.DataTmp)
%     assignin('base','indexUSP',indexUSP)
    % Find min of yBKG
    indexYmin = cell(1);
    for l = 1:size(h.DataTmp,2)
        for k = 1:length(indexUSP)
            if all(yBKG{l,k} == 0)
                indexYmin{l,k} = 4;
            else
                indexYmin{l,k} = find(min(yBKG{l,k}(yBKG{l,k}>0)) == yBKG{l,k});
            end
        end
    end

    % Find and delete duplicate entries
    for l = 1:size(h.DataTmp,2)
        for k = 1:length(indexUSP)
            if length(indexYmin{l,k}) ~= 1
                indexYmin{l,k} = indexYmin{l,k}(1);
            end
        end
    end

    % Get index of Ymin
    indexYminDataTmp = cell(1);
    for l = 1:size(h.DataTmp,2)
        for k = 1:length(indexUSP)
            indexYminDataTmp{l,k} = indexBKG(indexYmin{l,k},k); 
        end
    end
    % Get x and y data for Ymin and create PeakRegions data X and Y
    for l = 1:size(h.DataTmp,2)
        for k = 1:length(indexUSP)
            h.PeakRegionsXdata{l,k} = h.DataTmp{l}(indexYminDataTmp{l,k},1);
            h.PeakRegionsYdata{l,k} = h.DataTmp{l}(indexYminDataTmp{l,k},2);
        end
    end

    % Create PeakregionsX data
    for l = 1:size(h.DataTmp,2)
        h.PeakRegionsX{l} = reshape([h.PeakRegionsXdata{l,:}],2,size([h.PeakRegionsXdata{l,:}],2)/2);
    end
end

% Set table data
if strcmp(h.Diffsel,'LEDDI')
    if strcmp(h.Detsel,'Detector 1')
        h.PeakRegionsXDet1 = h.PeakRegionsX;
        h.PeakRegionsXdataDet1 = h.PeakRegionsXdata;
        h.PeakRegionsYdataDet1 = h.PeakRegionsYdata;
        set(h.tablebkgdata,'data',h.PeakRegionsXDet1{valueSlider})
    elseif strcmp(h.Detsel,'Detector 2')
        h.PeakRegionsXDet2 = h.PeakRegionsX;
        h.PeakRegionsXdataDet2 = h.PeakRegionsXdata;
        h.PeakRegionsYdataDet2 = h.PeakRegionsYdata;
        set(h.tablebkgdata,'data',h.PeakRegionsXDet2{valueSlider})
    end
else
    set(h.tablebkgdata,'data',h.PeakRegionsX{valueSlider})
end

% Set plot data
if strcmp(h.Diffsel,'LEDDI')
    if strcmp(h.Detsel,'Detector 1')
        h.plotbkgpoints = plot(h.axesplotRawData,[h.PeakRegionsXdataDet1{valueSlider,:}],[h.PeakRegionsYdataDet1{valueSlider,:}],'o','Color','r','MarkerFaceColor','r','MarkerSize',5,'Tag','plotbkgpoints');
    elseif strcmp(h.Detsel,'Detector 2')
        h.plotbkgpoints = plot(h.axesplotRawData,[h.PeakRegionsXdataDet2{valueSlider,:}],[h.PeakRegionsYdataDet2{valueSlider,:}],'o','Color','r','MarkerFaceColor','r','MarkerSize',5,'Tag','plotbkgpoints');
    end
else
    h.plotbkgpoints = plot(h.axesplotRawData,[h.PeakRegionsXdata{valueSlider,:}],[h.PeakRegionsYdata{valueSlider,:}],'o','Color','r','MarkerFaceColor','r','MarkerSize',5,'Tag','plotbkgpoints');
end
set(h.plotbkgpoints,'Visible','on')
% Message box
msgbox('Background points created.');

guidata(hObj, h);

function buttonselectbkg2(hObj, ~)
% Callback for "Save File" button in background panel
h = guidata(hObj);
% Material
material = h.P.PopupValueMpd1;
% Create variables to be saved in the ULD file
if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    PeakRegionsX = h.PeakRegionsX;
    PeakRegionsXdata = h.PeakRegionsXdata;
    PeakRegionsYdata = h.PeakRegionsYdata;
    EnergyRange = h.EnergyRange;
    
    uisave({'PeakRegionsX','PeakRegionsXdata','PeakRegionsYdata','EnergyRange'},[General.ProgramInfo.Path,'\Data\ULD\',...
                [strtrim(h.Measurement(1).MeasurementSeries),'_',material]]);
                  
elseif strcmp(h.Diffsel,'LEDDI')
    if isfield(h, 'PeakRegionsXDet1') && ~isfield(h, 'PeakRegionsXDet2')
        PeakRegionsXDet1 = h.PeakRegionsXDet1;
        PeakRegionsXdataDet1 = h.PeakRegionsXdataDet1;
        PeakRegionsYdataDet1 = h.PeakRegionsYdataDet1;
        EnergyRangeDet1 = h.EnergyRangeDet1;
        
        uisave({'PeakRegionsXDet1','PeakRegionsXdataDet1','PeakRegionsYdataDet1','EnergyRangeDet1'},[General.ProgramInfo.Path,'\Data\ULD\',...
                [strtrim(h.Measurement(1).MeasurementSeries),'_',material]]);
    
    elseif isfield(h, 'PeakRegionsXDet2') && ~isfield(h, 'PeakRegionsXDet1')
        PeakRegionsXDet2 = h.PeakRegionsXDet2;
        PeakRegionsXdataDet2 = h.PeakRegionsXdataDet2;
        PeakRegionsYdataDet2 = h.PeakRegionsYdataDet2;
        EnergyRangeDet2 = h.EnergyRangeDet2;
        
        uisave({'PeakRegionsXDet2','PeakRegionsXdataDet2','PeakRegionsYdataDet2','EnergyRangeDet2'},[General.ProgramInfo.Path,'\Data\ULD\',...
                [strtrim(h.Measurement(1).MeasurementSeries),'_',material]]);
                  
    elseif isfield(h, 'PeakRegionsXDet1') && isfield(h, 'PeakRegionsXDet2')
        PeakRegionsXDet1 = h.PeakRegionsXDet1;
        PeakRegionsXdataDet1 = h.PeakRegionsXdataDet1;
        PeakRegionsYdataDet1 = h.PeakRegionsYdataDet1;
        EnergyRangeDet1 = h.EnergyRangeDet1;
        PeakRegionsXDet2 = h.PeakRegionsXDet2;
        PeakRegionsXdataDet2 = h.PeakRegionsXdataDet2;
        PeakRegionsYdataDet2 = h.PeakRegionsYdataDet2;
        EnergyRangeDet2 = h.EnergyRangeDet2;
        
        uisave({'PeakRegionsXDet1','PeakRegionsXdataDet1','PeakRegionsYdataDet1','EnergyRangeDet1',...
            'PeakRegionsXDet2','PeakRegionsXdataDet2','PeakRegionsYdataDet2','EnergyRangeDet2'},...
            [General.ProgramInfo.Path,'\Data\ULD\',[strtrim(h.Measurement(1).MeasurementSeries),'_',material]]);
    end
end

msgbox('Background file saved.');

guidata(hObj, h);

function buttonselectbkg3(hObj, ~)
% Callback for "Load File" button in background panel
h = guidata(hObj);
% Get slider value
valueSlider = round(get(h.Slider, 'Value'));
% Load background file
[baseFileName, folder] = uigetfile('*.mat','Load background (ULD) file',[General.ProgramInfo.Path,'/Data/ULD/']);

if baseFileName == 0
  % user pressed cancel
  return
end

BackgroundFileName = fullfile(folder, baseFileName);
load(BackgroundFileName);

Detstr = get(h.popupmenuselectmeas1,'String');
Detval = get(h.popupmenuselectmeas1,'Value');
Detsel = Detstr{Detval};
h.Detsel = Detsel;
if exist('MinVal','var')
    h.MinVal = MinVal;
end

if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    % If size of PeakRegions is equal to the length of h.Measurement, it
    % can be used directly. If not, then the first entry of PeakRegions is
    % used to calculate the PeakRegions with correct size
    if size(PeakRegionsX,2) == length(h.Measurement)
        h.PeakRegionsX = PeakRegionsX;
        if exist('PeakRegionsXdata','var')
            h.PeakRegionsXdata = PeakRegionsXdata;
            h.PeakRegionsYdata = PeakRegionsYdata;
        else
            [~,PeakRegionsXdatanew,PeakRegionsYdatanew] = SearchBKGPoints(h.DataTmp,PeakRegionsX{1}(:),valueSlider);
            h.PeakRegionsXdata = PeakRegionsXdatanew;
            h.PeakRegionsYdata = PeakRegionsYdatanew;
        end
%         h.EnergyRange = EnergyRange - (EnergyRange(1)-1);
%         h.P.EnergyRange = [round(h.DataTmp{valueSlider}(h.EnergyRange(1),1)) round(h.DataTmp{valueSlider}(h.EnergyRange(2),1))];
        h.EnergyRange = EnergyRange;% - (EnergyRange(1)-1);
%         h.P.EnergyRange = [0,0];
        h.P.EnergyRange = [ceil(h.DataTmp{valueSlider}(EnergyRange(1),1)) ceil(h.DataTmp{valueSlider}(EnergyRange(2),1))];
        h.FitPeaksLogicalErange = h.TPeaks.T.Etheo > h.P.EnergyRange(1) & h.TPeaks.T.Etheo < h.P.EnergyRange(2);
        set(h.editfieldselectmeas4,'String',string(floor(h.P.EnergyRange(1)))) 
        set(h.editfieldselectmeas5,'String',string(floor(h.P.EnergyRange(2)))) 
        h.plotbkgpoints = plot(h.axesplotRawData,[h.PeakRegionsXdata{valueSlider,:}],[h.PeakRegionsYdata{valueSlider,:}],'o','Color','r','MarkerFaceColor','r','MarkerSize',5,'Tag','plotbkgpoints');
        % Set background table data
        set(h.tablebkgdata,'data',h.PeakRegionsX{valueSlider})
    else
        % If size of PeakRegions is not equal to the length of
        % h.Measurement, Peakregions is calculated
        PeakRegionsXtmp = PeakRegionsX{1}(:);
        PeakRegionsXtmp = sort(PeakRegionsXtmp);
        [PeakRegionsXnew,PeakRegionsXdatanew,PeakRegionsYdatanew] = SearchBKGPoints(h.DataTmp,PeakRegionsXtmp,valueSlider);
        h.PeakRegionsX = PeakRegionsXnew;
        h.PeakRegionsXdata = PeakRegionsXdatanew;
        h.PeakRegionsYdata = PeakRegionsYdatanew;
%         h.EnergyRange = EnergyRange - (EnergyRange(1)-1);
%         h.P.EnergyRange = [round(h.DataTmp{valueSlider}(h.EnergyRange(1),1)) round(h.DataTmp{valueSlider}(h.EnergyRange(2),1))];
        h.EnergyRange = EnergyRange;% - (EnergyRange(1)-1);
        h.P.EnergyRange = [ceil(h.DataTmp{valueSlider}(EnergyRange(1),1)) ceil(h.DataTmp{valueSlider}(EnergyRange(2),1))];
        h.FitPeaksLogicalErange = h.TPeaks.T.Etheo > h.P.EnergyRange(1) & h.TPeaks.T.Etheo < h.P.EnergyRange(2);
        set(h.editfieldselectmeas4,'String',string(floor(h.P.EnergyRange(1)))) 
        set(h.editfieldselectmeas5,'String',string(floor(h.P.EnergyRange(2)))) 
        h.plotbkgpoints = plot(h.axesplotRawData,[h.PeakRegionsXdata{valueSlider,:}],[h.PeakRegionsYdata{valueSlider,:}],'o','Color','r','MarkerFaceColor','r','MarkerSize',5,'Tag','plotbkgpoints');
        % Set background table data
        set(h.tablebkgdata,'data',h.PeakRegionsX{valueSlider})
    end
% assignin('base','FitPeaksLogicalErange',h.FitPeaksLogicalErange)
% assignin('base','EnergyRange',h.P.EnergyRange)
% assignin('base','Etheo',h.TPeaks.T.Etheo)
    if exist('Peaks','var') == 1 && size(PeakRegionsX,2) == length(h.Measurement)
        h.Peaks = Peaks;
        h.Peakslb = Peakslb;
        h.Peaksub = Peaksub;
        PeaksTheo = h.TPeaks.T.Peaks(:,5);
        PeaksTheo = PeaksTheo.*h.FitPeaksLogicalErange;
        PeaksTheo(PeaksTheo==0) = [];
        [CompareFitPeaksLogical,MinVal,IndVal,PeakHit] = ComparePeaks(h.Peaks,PeaksTheo);
        h.FitPeaksLogical = CompareFitPeaksLogical;
        h.TableBkgColorArray = TableBkgColorArray;
%         set(h.tablepeakdata,'data',h.Peaks{valueSlider})
        set(h.tablepeakdata,'data',[h.Peaks{valueSlider};h.Peakslb{valueSlider};h.Peaksub{valueSlider}])
        % Interpolate RawData to get YData for PeakRegions
        h.DataInterpPeaks = interp1(h.DataTmp{valueSlider}(:,1),h.DataTmp{valueSlider}(:,2),h.Peaks{valueSlider});
        % Plot of peak positions
        h.plotpeakpoints = plot(h.axesplotRawData,h.Peaks{valueSlider},h.DataInterpPeaks,'d','Color','r','MarkerFaceColor','r','MarkerSize',5);
        set(h.tablephasehkl,'BackgroundColor',h.TableBkgColorArray)
    elseif exist('Peaks','var') == 1 && size(PeakRegionsX,1) ~= length(h.Measurement)
        Peakstmp = Peaks{1}(:);
        Peakslbtmp = Peakslb{1}(:);
        Peaksubtmp = Peaksub{1}(:);
        for l = 1:size(h.DataTmp,2)
            h.Peaks{l} = Peakstmp';
            h.Peakslb{l} = Peakslbtmp';
            h.Peaksub{l} = Peaksubtmp';
        end
        PeaksTheo = h.TPeaks.T.Peaks(:,5);
        PeaksTheo = PeaksTheo.*h.FitPeaksLogicalErange;
        PeaksTheo(PeaksTheo==0) = [];
        [CompareFitPeaksLogical,MinVal,IndVal,PeakHit] = ComparePeaks(h.Peaks,PeaksTheo);
        h.FitPeaksLogical = CompareFitPeaksLogical;
        h.TableBkgColorArray = TableBkgColorArray;
%         set(h.tablepeakdata,'data',h.Peaks{valueSlider})
        set(h.tablepeakdata,'data',[h.Peaks{valueSlider};h.Peakslb{valueSlider};h.Peaksub{valueSlider}])
        % Interpolate RawData to get YData for PeakRegions
        h.DataInterpPeaks = interp1(h.DataTmp{valueSlider}(:,1),h.DataTmp{valueSlider}(:,2),h.Peaks{valueSlider});
        % Plot of peak positions
        h.plotpeakpoints = plot(h.axesplotRawData,h.Peaks{valueSlider},h.DataInterpPeaks,'d','Color','r','MarkerFaceColor','r','MarkerSize',5);
        set(h.tablephasehkl,'BackgroundColor',h.TableBkgColorArray)
    end
    
elseif strcmp(h.Diffsel,'LEDDI')
    if exist('PeakRegionsXDet1','var') == 1 && size(PeakRegionsXDet1,1) == length(h.Measurement)/2
        Slidersteps = 2:2:length(h.Measurement);
        h.PeakRegionsXDet1 = PeakRegionsXDet1;
        h.PeakRegionsXdataDet1 = PeakRegionsXdataDet1;
        h.PeakRegionsYdataDet1 = PeakRegionsYdataDet1;
        h.EnergyRangeDet1 = EnergyRangeDet1;% - (EnergyRangeDet1(1)-1);
        h.P.EnergyRangeDet1 = [ceil(h.DataTmp{Slidersteps(valueSlider)}(EnergyRangeDet1(1),1)) ceil(h.DataTmp{Slidersteps(valueSlider)}(EnergyRangeDet1(2),1))];
        h.TPeaksDet1 = TheoreticalPeakPositions(h.MeasurementBackup(Slidersteps),h.DataTmp(Slidersteps));
        h.FitPeaksLogicalErangeDet1 = h.TPeaksDet1.T.Etheo > h.P.EnergyRangeDet1(1) & h.TPeaksDet1.T.Etheo < h.P.EnergyRangeDet1(2);
        if strcmp(h.Detsel,'Detector 1')
            set(h.editfieldselectmeas4,'String',string(floor(h.P.EnergyRangeDet1(1)))) 
            set(h.editfieldselectmeas5,'String',string(floor(h.P.EnergyRangeDet1(2))))      
            h.plotbkgpoints = plot(h.axesplotRawData,[h.PeakRegionsXdataDet1{valueSlider,:}],[h.PeakRegionsYdataDet1{valueSlider,:}],'o','Color','r','MarkerFaceColor','r','MarkerSize',5,'Tag','plotbkgpoints');
            % Set background table data
            set(h.tablebkgdata,'data',h.PeakRegionsXDet1{valueSlider})
        end
    elseif exist('PeakRegionsXDet1','var') == 1 && size(PeakRegionsXDet1,1) ~= length(h.Measurement)/2
        % If size of PeakRegionsXDet1 is not equal to the length of
        % h.Measurement, PeakRegionsXDet1 is calculated
        Slidersteps = 2:2:length(h.Measurement);
        PeakRegionsXDet1tmp = PeakRegionsXDet1{1}(:);
        PeakRegionsXDet1tmp = sort(PeakRegionsXDet1tmp);
        [PeakRegionsXDet1new,PeakRegionsXdataDet1new,PeakRegionsYdataDet1new] = SearchBKGPoints(h.DataTmp(Slidersteps),PeakRegionsXDet1tmp,valueSlider);
        h.PeakRegionsXDet1 = PeakRegionsXDet1new;
        h.PeakRegionsXdataDet1 = PeakRegionsXdataDet1new;
        h.PeakRegionsYdataDet1 = PeakRegionsYdataDet1new;
        h.EnergyRangeDet1 = EnergyRangeDet1;% - (EnergyRangeDet1(1)-1);
        h.P.EnergyRangeDet1 = [ceil(h.DataTmp{Slidersteps(valueSlider)}(EnergyRangeDet1(1),1)) ceil(h.DataTmp{Slidersteps(valueSlider)}(EnergyRangeDet1(2),1))];
        h.TPeaksDet1 = TheoreticalPeakPositions(h.MeasurementBackup(Slidersteps),h.DataTmp(Slidersteps));
        h.FitPeaksLogicalErangeDet1 = h.TPeaksDet1.T.Etheo > h.P.EnergyRangeDet1(1) & h.TPeaksDet1.T.Etheo < h.P.EnergyRangeDet1(2);  
        if strcmp(h.Detsel,'Detector 1')
            set(h.editfieldselectmeas4,'String',string(floor(h.P.EnergyRangeDet1(1)))) 
            set(h.editfieldselectmeas5,'String',string(floor(h.P.EnergyRangeDet1(2))))
            h.plotbkgpoints = plot(h.axesplotRawData,[h.PeakRegionsXdataDet1{Slidersteps(valueSlider),:}],[h.PeakRegionsYdataDet1{Slidersteps(valueSlider),:}],'o','Color','r','MarkerFaceColor','r','MarkerSize',5,'Tag','plotbkgpoints');
            % Set background table data
            set(h.tablebkgdata,'data',h.PeakRegionsXDet1{valueSlider})
        end
    end
    
    if exist('PeaksDet1','var') == 1 && size(PeakRegionsXDet1,1) == length(h.Measurement)/2
        h.PeaksDet1 = PeaksDet1;
        h.Peakslb = Peakslb;
        h.Peaksub = Peaksub;
        PeaksTheo = h.TPeaksDet1.T.Peaks(:,5);
        PeaksTheo = PeaksTheo.*h.FitPeaksLogicalErangeDet1;
        PeaksTheo(PeaksTheo==0) = [];
        [CompareFitPeaksLogical,MinVal,IndVal,PeakHit] = ComparePeaks(h.PeaksDet1,PeaksTheo);
        h.FitPeaksLogicalDet1 = CompareFitPeaksLogical;
        h.TableBkgColorArrayDet1 = TableBkgColorArrayDet1;
        if strcmp(h.Detsel,'Detector 1')
            Slidersteps = 2:2:length(h.Measurement);
%             set(h.tablepeakdata,'data',h.PeaksDet1{valueSlider})
            set(h.tablepeakdata,'data',[h.PeaksDet1{valueSlider};h.Peakslb{valueSlider};h.Peaksub{valueSlider}])
            % Interpolate RawData to get YData for PeakRegions
            h.DataInterpPeaksDet1 = interp1(h.DataTmp{Slidersteps(valueSlider)}(:,1),h.DataTmp{Slidersteps(valueSlider)}(:,2),h.PeaksDet1{valueSlider});
            % Plot of peak positions
            h.plotpeakpoints = plot(h.axesplotRawData,h.PeaksDet1{valueSlider},h.DataInterpPeaksDet1,'d','Color','r','MarkerFaceColor','r','MarkerSize',5);
            set(h.tablephasehkl,'BackgroundColor',h.TableBkgColorArrayDet1)
            
        end
    elseif exist('PeaksDet1','var') == 1 && size(PeakRegionsXDet1,1) ~= length(h.Measurement)/2
        PeaksDet1tmp = PeaksDet1{1}(:);
        Peakslbtmp = Peakslb{1}(:);
        Peaksubtmp = Peaksub{1}(:);
        h.TableBkgColorArrayDet1 = TableBkgColorArrayDet1;
        for l = 1:size(h.DataTmp,2)/2
            h.PeaksDet1{l} = PeaksDet1tmp';
            h.Peakslb{l} = Peakslbtmp';
            h.Peaksub{l} = Peaksubtmp';
        end
        
        PeaksTheo = h.TPeaksDet1.T.Peaks(:,5);
        PeaksTheo = PeaksTheo.*h.FitPeaksLogicalErangeDet1;
        PeaksTheo(PeaksTheo==0) = [];
        [CompareFitPeaksLogical,MinVal,IndVal,PeakHit] = ComparePeaks(h.PeaksDet1,PeaksTheo);
        h.FitPeaksLogicalDet1 = CompareFitPeaksLogical;
        
        if strcmp(h.Detsel,'Detector 1')
            Slidersteps = 2:2:length(h.Measurement);
            set(h.tablepeakdata,'data',[h.PeaksDet1{valueSlider};h.Peakslb{valueSlider};h.Peaksub{valueSlider}])
            % Interpolate RawData to get YData for PeakRegions
            h.DataInterpPeaksDet1 = interp1(h.DataTmp{Slidersteps(valueSlider)}(:,1),h.DataTmp{Slidersteps(valueSlider)}(:,2),h.PeaksDet1{valueSlider});
            % Plot of peak positions
            h.plotpeakpoints = plot(h.axesplotRawData,h.PeaksDet1{valueSlider},h.DataInterpPeaksDet1,'d','Color','r','MarkerFaceColor','r','MarkerSize',5);
            set(h.tablephasehkl,'BackgroundColor',h.TableBkgColorArrayDet1)
        end
    end
    
    if exist('PeakRegionsXDet2','var') == 1 && size(PeakRegionsXDet2,1) == length(h.Measurement)/2
        Slidersteps = 1:2:length(h.Measurement);
        h.PeakRegionsXDet2 = PeakRegionsXDet2;
        h.PeakRegionsXdataDet2 = PeakRegionsXdataDet2;
        h.PeakRegionsYdataDet2 = PeakRegionsYdataDet2;
        h.EnergyRangeDet2 = EnergyRangeDet2;% - (EnergyRangeDet2(1)-1);
        h.P.EnergyRangeDet2 = ceil([h.DataTmp{Slidersteps(valueSlider)}(EnergyRangeDet2(1),1) h.DataTmp{Slidersteps(valueSlider)}(EnergyRangeDet2(2),1)]);
        h.TPeaksDet2 = TheoreticalPeakPositions(h.MeasurementBackup(Slidersteps),h.DataTmp(Slidersteps));
        h.FitPeaksLogicalErangeDet2 = h.TPeaksDet2.T.Etheo > h.P.EnergyRangeDet2(1) & h.TPeaksDet2.T.Etheo < h.P.EnergyRangeDet2(2);
        if strcmp(h.Detsel,'Detector 2')
            set(h.editfieldselectmeas4,'String',string(floor(h.P.EnergyRangeDet2(1))))
            set(h.editfieldselectmeas5,'String',string(floor(h.P.EnergyRangeDet2(2)))) 
            h.plotbkgpoints = plot(h.axesplotRawData,[h.PeakRegionsXdataDet2{valueSlider,:}],[h.PeakRegionsYdataDet2{valueSlider,:}],'o','Color','r','MarkerFaceColor','r','MarkerSize',5,'Tag','plotbkgpoints');
            % Set background table data
            set(h.tablebkgdata,'data',h.PeakRegionsXDet2{valueSlider})
        end
    elseif exist('PeakRegionsXDet2','var') == 1 && size(PeakRegionsXDet2,1) ~= length(h.Measurement)/2
        % If size of PeakRegionsXDet2 is not equal to the length of
        % h.Measurement, PeakRegionsXDet2 is calculated
        Slidersteps = 1:2:length(h.Measurement);
        PeakRegionsXDet2tmp = PeakRegionsXDet2{1}(:);
        PeakRegionsXDet2tmp = sort(PeakRegionsXDet2tmp);
        [PeakRegionsXDet2new,PeakRegionsXdataDet2new,PeakRegionsYdataDet2new] = SearchBKGPoints(h.DataTmp(Slidersteps),PeakRegionsXDet2tmp,valueSlider);
        h.PeakRegionsXDet2 = PeakRegionsXDet2new;
        h.PeakRegionsXdataDet2 = PeakRegionsXdataDet2new;
        h.PeakRegionsYdataDet2 = PeakRegionsYdataDet2new;
        h.EnergyRangeDet2 = EnergyRangeDet2;% - (EnergyRangeDet2(1)-1);
        h.P.EnergyRangeDet2 = ceil([h.DataTmp{Slidersteps(valueSlider)}(EnergyRangeDet2(1),1) h.DataTmp{Slidersteps(valueSlider)}(EnergyRangeDet2(2),1)]);
        h.TPeaksDet2 = TheoreticalPeakPositions(h.MeasurementBackup(Slidersteps),h.DataTmp(Slidersteps));
        h.FitPeaksLogicalErangeDet2 = h.TPeaksDet2.T.Etheo > h.P.EnergyRangeDet2(1) & h.TPeaksDet2.T.Etheo < h.P.EnergyRangeDet2(2);
        if strcmp(h.Detsel,'Detector 2')
            set(h.editfieldselectmeas4,'String',string(floor(h.P.EnergyRangeDet2(1)))) 
            set(h.editfieldselectmeas5,'String',string(floor(h.P.EnergyRangeDet2(2))))
            h.plotbkgpoints = plot(h.axesplotRawData,[h.PeakRegionsXdataDet2{Slidersteps(valueSlider),:}],[h.PeakRegionsYdataDet2{Slidersteps(valueSlider),:}],'o','Color','r','MarkerFaceColor','r','MarkerSize',5,'Tag','plotbkgpoints');    
            % Set background table data
            set(h.tablebkgdata,'data',h.PeakRegionsXDet2{valueSlider})
        end   
    end
    
    if exist('PeaksDet2','var') == 1 && size(PeakRegionsXDet2,1) == length(h.Measurement)/2
        h.PeaksDet2 = PeaksDet2;
        h.Peakslb = Peakslb;
        h.Peaksub = Peaksub;
        PeaksTheo = h.TPeaksDet2.T.Peaks(:,5);
        PeaksTheo = PeaksTheo.*h.FitPeaksLogicalErangeDet2;
        PeaksTheo(PeaksTheo==0) = [];
        [CompareFitPeaksLogical,MinVal,IndVal,PeakHit] = ComparePeaks(h.PeaksDet2,PeaksTheo);
        h.FitPeaksLogicalDet2 = CompareFitPeaksLogical;
        h.TableBkgColorArrayDet2 = TableBkgColorArrayDet2; 
        if strcmp(h.Detsel,'Detector 2')
            Slidersteps = 1:2:length(h.Measurement);
%             set(h.tablepeakdata,'data',h.PeaksDet2{valueSlider})
            set(h.tablepeakdata,'data',[h.PeaksDet2{valueSlider};h.Peakslb{valueSlider};h.Peaksub{valueSlider}])
            % Interpolate RawData to get YData for PeakRegions
            h.DataInterpPeaksDet2 = interp1(h.DataTmp{Slidersteps(valueSlider)}(:,1),h.DataTmp{Slidersteps(valueSlider)}(:,2),h.PeaksDet2{valueSlider});
            % Plot of peak positions
            h.plotpeakpoints = plot(h.axesplotRawData,h.PeaksDet2{valueSlider},h.DataInterpPeaksDet2,'d','Color','r','MarkerFaceColor','r','MarkerSize',5);
            set(h.tablephasehkl,'BackgroundColor',h.TableBkgColorArrayDet2)
        end
    elseif exist('PeaksDet2','var') == 1 && size(PeakRegionsXDet2,1) ~= length(h.Measurement)/2
        PeaksDet2tmp = PeaksDet2{1}(:);
        Peakslbtmp = Peakslb{1}(:);
        Peaksubtmp = Peaksub{1}(:);
        h.TableBkgColorArrayDet2 = TableBkgColorArrayDet2;
        
        for l = 1:size(h.DataTmp,2)/2
            h.PeaksDet2{l} = PeaksDet2tmp';
            h.Peakslb{l} = Peakslbtmp';
            h.Peaksub{l} = Peaksubtmp';
        end
        
        PeaksTheo = h.TPeaksDet2.T.Peaks(:,5);
        PeaksTheo = PeaksTheo.*h.FitPeaksLogicalErangeDet2;
        PeaksTheo(PeaksTheo==0) = [];
        [CompareFitPeaksLogical,MinVal,IndVal,PeakHit] = ComparePeaks(h.PeaksDet2,PeaksTheo);
        h.FitPeaksLogicalDet2 = CompareFitPeaksLogical;
        
        if strcmp(h.Detsel,'Detector 2')
            Slidersteps = 1:2:length(h.Measurement);
            set(h.tablepeakdata,'data',[h.PeaksDet2{valueSlider};h.Peakslb{valueSlider};h.Peaksub{valueSlider}])
            % Interpolate RawData to get YData for PeakRegions
            h.DataInterpPeaksDet2 = interp1(h.DataTmp{Slidersteps(valueSlider)}(:,1),h.DataTmp{Slidersteps(valueSlider)}(:,2),h.PeaksDet2{valueSlider});
            % Plot of peak positions
            h.plotpeakpoints = plot(h.axesplotRawData,h.PeaksDet2{valueSlider},h.DataInterpPeaksDet2,'d','Color','r','MarkerFaceColor','r','MarkerSize',5);
            set(h.tablephasehkl,'BackgroundColor',h.TableBkgColorArrayDet2)
        end    
    end 
end

% Message box
msgbox('Background file loaded.');

guidata(hObj, h);

function buttonselectbkg4(hObj, ~)
% Callback for "Fit" button in background panel
h = guidata(hObj);

% if ~isfield(h,'PeakRegionsX') || ~isfield(h,'PeakRegionsXDet1') || ~isfield(h,'PeakRegionsXDet2')
%     msgbox({'Background correction already performed.'});
%   % user pressed cancel
%   return
% end

Detstr = get(h.popupmenuselectmeas1,'String');
Detval = get(h.popupmenuselectmeas1,'Value');
Detsel = Detstr{Detval};
h.Detsel = Detsel;

% Run "BackgroundReductionGUI" script
if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    [Measurement,DataTmp,T] = BackgroundReductionGUI(h.Measurement,h.DataTmp,h.PeakRegionsX);
    h.DataTmpToAccept = DataTmp;
    h.MeasurementToAccept = Measurement;
    h.BackgroundCorrDataToAccept = DataTmp;
elseif strcmp(h.Diffsel,'LEDDI')
    if strcmp(h.Detsel,'Detector 1')
        Slidersteps = 2:2:length(h.Measurement);
        [Measurement,DataTmp,T] = BackgroundReductionGUI(h.Measurement(Slidersteps),h.DataTmp(Slidersteps),h.PeakRegionsXDet1);
        h.DataTmpToAcceptDet1 = DataTmp;
        h.MeasurementToAcceptDet1 = Measurement;
        h.BackgroundCorrDataToAcceptDet1 = DataTmp;
    elseif strcmp(h.Detsel,'Detector 2')
        Slidersteps = 1:2:length(h.Measurement);
        [Measurement,DataTmp,T] = BackgroundReductionGUI(h.Measurement(Slidersteps),h.DataTmp(Slidersteps),h.PeakRegionsXDet2);
        h.DataTmpToAcceptDet2 = DataTmp;
        h.MeasurementToAcceptDet2 = Measurement;
        h.BackgroundCorrDataToAcceptDet2 = DataTmp;
    end
end

% Get slider value
valueSlider = round(get(h.Slider, 'Value'));
% Set plot of bkg points visible off
set(h.plotbkgpoints,'Visible','off')
% if isfield(h, 'plotpeakpoints')
%     set(h.plotpeakpoints,'Visible','off')
% end

% Plot background corrected data
if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    h.plotBKG = plot(h.axesplotRawData, DataTmp{valueSlider}(:,1), DataTmp{valueSlider}(:,2),'Color','r','LineWidth',2);
elseif strcmp(h.Diffsel,'LEDDI')
    if strcmp(h.Detsel,'Detector 1')
%         Slidersteps = 2:2:length(h.Measurement);
        h.plotBKG = plot(h.axesplotRawData, h.DataTmpToAcceptDet1{valueSlider}(:,1), h.DataTmpToAcceptDet1{valueSlider}(:,2),'Color','r','LineWidth',2);
    elseif strcmp(h.Detsel,'Detector 2')
%         Slidersteps = 1:2:length(h.Measurement);
        h.plotBKG = plot(h.axesplotRawData, h.DataTmpToAcceptDet2{valueSlider}(:,1), h.DataTmpToAcceptDet2{valueSlider}(:,2),'Color','r','LineWidth',2);
    end
end

% h.plotBKG = plot(h.axesplotRawData, DataTmp{valueSlider}(:,1), DataTmp{valueSlider}(:,2),'Color','r','LineWidth',2);
% h.DataTmpToAccept = DataTmp;
% h.MeasurementToAccept = Measurement;
% h.BackgroundCorrDataToAccept = DataTmp;
if h.P.ShowSubstratePeaks == 1
        set(h.plotEtheoSub,'visible','off')
end
% Messagebox
if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    msgbox('Background corrected. Accept if background correction is good.');
elseif strcmp(h.Diffsel,'LEDDI') && strcmp(h.Detsel,'Detector 1')
    msgbox('Background of Det1 corrected. Accept if background correction is good.');
elseif strcmp(h.Diffsel,'LEDDI') && strcmp(h.Detsel,'Detector 2')
	msgbox('Background of Det2 corrected. Accept if background correction is good.'); 
end

guidata(hObj, h);

function buttonselectbkg5(hObj, ~)
% Callback for "Accept" button in background panel
h = guidata(hObj);

% Get slider value
valueSlider = round(get(h.Slider, 'Value'));

Detstr = get(h.popupmenuselectmeas1,'String');
Detval = get(h.popupmenuselectmeas1,'Value');
Detsel = Detstr{Detval};
h.Detsel = Detsel;

if strcmp(h.Diffsel,'LEDDI')
    if strcmp(h.Detsel,'Detector 1')
        Slidersteps = 2:2:length(h.Measurement);
            for c = 1:length(h.DataTmpToAcceptDet1)
                h.DataTmp{Slidersteps(c)} = h.DataTmpToAcceptDet1{c};
                h.Measurement(Slidersteps(c)) = h.MeasurementToAcceptDet1(c);
            end
    elseif strcmp(h.Detsel,'Detector 2')
        Slidersteps = 1:2:length(h.Measurement);
            for c = 1:length(h.DataTmpToAcceptDet2)
                h.DataTmp{Slidersteps(c)} = h.DataTmpToAcceptDet2{c};
                h.Measurement(Slidersteps(c)) = h.MeasurementToAcceptDet2(c);
            end
    end
else
    h.DataTmp = h.DataTmpToAccept;
    h.Measurement = h.MeasurementToAccept;
    h.DataTmpBackgroundCorrData = h.BackgroundCorrDataToAccept;
end

% Set plot data
if strcmp(h.Diffsel,'LEDDI')
    if strcmp(h.Detsel,'Detector 1')
        Slidersteps = 2:2:length(h.Measurement);
        set(h.plotdata,'xdata',h.DataTmp{Slidersteps(valueSlider)}(:,1))
        set(h.plotdata,'ydata',h.DataTmp{Slidersteps(valueSlider)}(:,2))
        h.axesplotRawData.YLim =[-Inf round(max(h.DataTmp{Slidersteps(valueSlider)}(:,2)),-1)];
    elseif strcmp(h.Detsel,'Detector 2')
        Slidersteps = 1:2:length(h.Measurement);
        set(h.plotdata,'xdata',h.DataTmp{Slidersteps(valueSlider)}(:,1))
        set(h.plotdata,'ydata',h.DataTmp{Slidersteps(valueSlider)}(:,2))
        h.axesplotRawData.YLim =[-Inf round(max(h.DataTmp{Slidersteps(valueSlider)}(:,2)),-1)];
    end
else
    set(h.plotdata,'xdata',h.DataTmp{valueSlider}(:,1))
    set(h.plotdata,'ydata',h.DataTmp{valueSlider}(:,2))
    h.axesplotRawData.YLim =[-Inf round(max(h.DataTmp{valueSlider}(:,2)),-1)];
    
end
% Set plot background corrected data visible off
set(h.plotBKG,'Visible','off')
% Set peak position plot visible
if isfield(h, 'Peaks') || isfield(h, 'PeaksDet1') || isfield(h, 'PeaksDet2')
    if strcmp(h.Diffsel,'LEDDI')
        if strcmp(h.Detsel,'Detector 1')
            Slidersteps = 2:2:length(h.Measurement);
            h.DataInterpPeaksDet1 = interp1(h.DataTmp{Slidersteps(valueSlider)}(:,1),h.DataTmp{Slidersteps(valueSlider)}(:,2),h.PeaksDet1{valueSlider});
            % Plot of peak positions
            set(h.plotpeakpoints,'ydata',h.DataInterpPeaksDet1)
%             h.plotpeakpoints = plot(h.axesplotRawData,h.PeaksDet1{valueSlider},h.DataInterpPeaksDet1,'d','Color','r','MarkerFaceColor','r','MarkerSize',5);
        elseif strcmp(h.Detsel,'Detector 2')
            Slidersteps = 1:2:length(h.Measurement);
            h.DataInterpPeaksDet2 = interp1(h.DataTmp{Slidersteps(valueSlider)}(:,1),h.DataTmp{Slidersteps(valueSlider)}(:,2),h.PeaksDet2{valueSlider});
            % Plot of peak positions
            set(h.plotpeakpoints,'ydata',h.DataInterpPeaksDet2)
%             h.plotpeakpoints = plot(h.axesplotRawData,h.PeaksDet2{valueSlider},h.DataInterpPeaksDet2,'d','Color','r','MarkerFaceColor','r','MarkerSize',5);
        end
    else
        h.DataInterpPeaks = interp1(h.DataTmp{valueSlider}(:,1),h.DataTmp{valueSlider}(:,2),h.Peaks{valueSlider});
        % Plot of peak positions
        set(h.plotpeakpoints,'ydata',h.DataInterpPeaks)
%         h.plotpeakpoints = plot(h.axesplotRawData,h.Peaks{valueSlider},h.DataInterpPeaks,'d','Color','r','MarkerFaceColor','r','MarkerSize',5);
    end
end

% Messagebox
if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    msgbox('Background correction accepted.');
elseif strcmp(h.Diffsel,'LEDDI') && strcmp(h.Detsel,'Detector 1')
    msgbox('Background correction for Det1 accepted.');
elseif strcmp(h.Diffsel,'LEDDI') && strcmp(h.Detsel,'Detector 2')
	msgbox('Background correction for Det2 accepted.');
end

guidata(hObj, h);

function buttonselectbkg6(hObj, ~)
% Callback for "Decline" button in background panel
h = guidata(hObj);
% Set plot background corrected data visible off
set(h.plotBKG,'Visible','off')
% Set plot background points visible on
set(h.plotbkgpoints,'Visible','on')
% Messagebox
msgbox('Background correction declined. Change background values.')
guidata(hObj, h);

function buttonselectbkg8(hObj, ~)
% Callback for "Undo" button in background panel
h = guidata(hObj);

set(h.tablebkgdata,'data', [zeros(1,6);zeros(1,6)])
set(h.plotbkgpoints,'visible','off')

h = rmfield(h,'plotbkgpoints');

guidata(hObj, h);

function updatetablebkgdata(hObj, eventdata)
% Callback for updating user selected background points table 
h = guidata(hObj);

Detstr = get(h.popupmenuselectmeas1,'String');
Detval = get(h.popupmenuselectmeas1,'Value');
Detsel = Detstr{Detval};
h.Detsel = Detsel;

% Get slider value
valueSlider = round(get(h.Slider, 'Value'));
% Calculate plot data for updated BKG points
% Find closest point to user selected point
NewBkgPoint = eventdata.NewData;
NewBKGPointIdx = eventdata.Indices;
if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    indexUSP = Tools.Data.DataSetOperations.FindNearestIndex(h.DataTmp{valueSlider}(:,1),NewBkgPoint);
elseif strcmp(h.Diffsel,'LEDDI')
    if strcmp(h.Detsel,'Detector 1')
        Slidersteps = 2:2:length(h.Measurement);
        indexUSP = Tools.Data.DataSetOperations.FindNearestIndex(h.DataTmp{Slidersteps(valueSlider)}(:,1),NewBkgPoint);
    elseif strcmp(h.Detsel,'Detector 2')
        Slidersteps = 1:2:length(h.Measurement);
        indexUSP = Tools.Data.DataSetOperations.FindNearestIndex(h.DataTmp{Slidersteps(valueSlider)}(:,1),NewBkgPoint);
    end
end

% Check if changes should be applied to one or to all spectra
value = get(h.checkboxBKG,'value');
if value == 0
    if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    % Update changed X position of background from current slider value
    h.PeakRegionsX{valueSlider}(NewBKGPointIdx(1),NewBKGPointIdx(2)) = h.DataTmp{valueSlider}(indexUSP,1);
    % Set table data
    set(h.tablebkgdata,'data',h.PeakRegionsX{valueSlider})
    h.PeakRegionsXdata{valueSlider,prod(NewBKGPointIdx)} = h.DataTmp{valueSlider}(indexUSP,1);
    h.PeakRegionsYdata{valueSlider,prod(NewBKGPointIdx)} = h.DataTmp{valueSlider}(indexUSP,2);
    % Set plot data
    set(h.plotbkgpoints,'XData',[h.PeakRegionsXdata{valueSlider,:}])
    set(h.plotbkgpoints,'YData',[h.PeakRegionsYdata{valueSlider,:}])
    elseif strcmp(h.Diffsel,'LEDDI')
        if strcmp(h.Detsel,'Detector 1')
            Slidersteps = 2:2:length(h.Measurement);
            % Update changed X position of background from current slider value
            h.PeakRegionsXDet1{valueSlider}(NewBKGPointIdx(1),NewBKGPointIdx(2)) = h.DataTmp{Slidersteps(valueSlider)}(indexUSP,1);
            % Set table data
            set(h.tablebkgdata,'data',h.PeakRegionsXDet1{valueSlider})
            h.PeakRegionsXdataDet1{valueSlider,prod(NewBKGPointIdx)} = h.DataTmp{Slidersteps(valueSlider)}(indexUSP,1);
            h.PeakRegionsYdataDet1{valueSlider,prod(NewBKGPointIdx)} = h.DataTmp{Slidersteps(valueSlider)}(indexUSP,2);
            % Set plot data
            set(h.plotbkgpoints,'XData',[h.PeakRegionsXdataDet1{valueSlider,:}])
            set(h.plotbkgpoints,'YData',[h.PeakRegionsYdataDet1{valueSlider,:}])
        elseif strcmp(h.Detsel,'Detector 2')
            Slidersteps = 1:2:length(h.Measurement);
            % Update changed X position of background from current slider value
            h.PeakRegionsXDet2{valueSlider}(NewBKGPointIdx(1),NewBKGPointIdx(2)) = h.DataTmp{Slidersteps(valueSlider)}(indexUSP,1);
            % Set table data
            set(h.tablebkgdata,'data',h.PeakRegionsXDet1{valueSlider})
            h.PeakRegionsXdataDet2{valueSlider,prod(NewBKGPointIdx)} = h.DataTmp{Slidersteps(valueSlider)}(indexUSP,1);
            h.PeakRegionsYdataDet2{valueSlider,prod(NewBKGPointIdx)} = h.DataTmp{Slidersteps(valueSlider)}(indexUSP,2);
            % Set plot data
            set(h.plotbkgpoints,'XData',[h.PeakRegionsXdataDet2{valueSlider,:}])
            set(h.plotbkgpoints,'YData',[h.PeakRegionsYdataDet2{valueSlider,:}])
        end
    end
elseif value == 1
    if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    % Update changed X position of background for all slider values
    for k = 1:size(h.PeakRegionsX,2)
        h.PeakRegionsX{k}(NewBKGPointIdx(1),NewBKGPointIdx(2)) = h.DataTmp{k}(indexUSP,1);
        h.PeakRegionsXdata{k,prod(NewBKGPointIdx)} = h.DataTmp{k}(indexUSP,1);
        h.PeakRegionsYdata{k,prod(NewBKGPointIdx)} = h.DataTmp{k}(indexUSP,2);
    end
    % Set table data
    set(h.tablebkgdata,'data',h.PeakRegionsX{valueSlider})
    % Set plot data
    set(h.plotbkgpoints,'XData',[h.PeakRegionsXdata{valueSlider,:}])
    set(h.plotbkgpoints,'YData',[h.PeakRegionsYdata{valueSlider,:}])
    elseif strcmp(h.Diffsel,'LEDDI')
        if strcmp(h.Detsel,'Detector 1')
            Slidersteps = 2:2:length(h.Measurement);
            % Update changed X position of background for all slider values
            for k = 1:size(h.PeakRegionsXDet1,1)
                h.PeakRegionsXDet1{k}(NewBKGPointIdx(1),NewBKGPointIdx(2)) = h.DataTmp{Slidersteps(k)}(indexUSP,1);
                h.PeakRegionsXdataDet1{k,prod(NewBKGPointIdx)} = h.DataTmp{Slidersteps(k)}(indexUSP,1);
                h.PeakRegionsYdataDet1{k,prod(NewBKGPointIdx)} = h.DataTmp{Slidersteps(k)}(indexUSP,2);
            end
            % Set table data
            set(h.tablebkgdata,'data',h.PeakRegionsXDet1{valueSlider})
            % Set plot data
            set(h.plotbkgpoints,'XData',[h.PeakRegionsXdataDet1{valueSlider,:}])
            set(h.plotbkgpoints,'YData',[h.PeakRegionsYdataDet1{valueSlider,:}])
        elseif strcmp(h.Detsel,'Detector 2')
            size(h.PeakRegionsXDet2,1)
            size(h.PeakRegionsXDet2,2)
            Slidersteps = 1:2:length(h.Measurement);
            % Update changed X position of background for all slider values
            for k = 1:size(h.PeakRegionsXDet2,1)
                h.PeakRegionsXDet2{k}(NewBKGPointIdx(1),NewBKGPointIdx(2)) = h.DataTmp{Slidersteps(k)}(indexUSP,1);
                h.PeakRegionsXdataDet2{k,prod(NewBKGPointIdx)} = h.DataTmp{Slidersteps(k)}(indexUSP,1);
                h.PeakRegionsYdataDet2{k,prod(NewBKGPointIdx)} = h.DataTmp{Slidersteps(k)}(indexUSP,2);
            end
            % Set table data
            set(h.tablebkgdata,'data',h.PeakRegionsXDet2{valueSlider})
            % Set plot data
            set(h.plotbkgpoints,'XData',[h.PeakRegionsXdataDet2{valueSlider,:}])
            set(h.plotbkgpoints,'YData',[h.PeakRegionsYdataDet2{valueSlider,:}])
        end
    end
end

% Messagebox
msgbox('Background data updated.');

guidata(hObj, h);

function BackgroundTempCorr(hObj, ~)
% Callback for temperature correction in background panel
h = guidata(hObj);

% Create new window that opens when button is pushed
h.BackgroundTempCorr = figure('menubar','none','units','normalized','Position',[0.25 0.25 0.4 0.5],'Name', 'Create temperature corrected peak and background positions','NumberTitle','off','Visible','on');
% Create window elements
h.BackgroundTempCorrPanel = uipanel( ...
'Parent',  h.BackgroundTempCorr, ...
'Units', 'Normalized', ...
'Position', [0.005 0.0025 0.99 0.995], ...
'FontSize', 11 ,...
'Title', 'Analyze temperature dependency of energy shift' ...
);

h.textBKGTC1 = uicontrol( ...
    'Parent', h.BackgroundTempCorr, ...
    'Style', 'text', ...
    'FontSize', 9 ,...
    'Units', 'Normalized', ...
    'Position', [0.01 0.92 0.3 0.025], ...
    'HorizontalAlignment', 'left', ...
    'String', 'Select peak to analyze temperature induced peak shift' ...
    );

h.textBKGTC2 = uicontrol( ...
    'Parent', h.BackgroundTempCorr, ...
    'Style', 'text', ...
    'FontSize', 9 ,...
    'Units', 'Normalized', ...
    'Position', [0.075 0.872 0.05 0.025], ...
    'HorizontalAlignment', 'left', ...
    'String', 'Peak' ...
    );

h.editSelectPeak  = uicontrol( ...
    'Parent', h.BackgroundTempCorr, ...        
    'Style','edit',...
    'String', '1',...
    'FontSize', 9,...
    'Tag', 'editSelectPeak',...
    'Units','normalized',...
    'Position',[0.115 0.868 0.03 0.035] ...
    );

h.buttonSelectPeak = uicontrol( ...
    'Parent', h.BackgroundTempCorr, ...
    'Style', 'Pushbutton', ...
    'Units', 'Normalized', ...
    'Position', [0.157 0.868 0.075 0.035], ...
    'String', 'Select peak', ...
    'FontSize', 8, ...
    'Tag', 'buttonSelectPeak', ...
    'Callback', {@buttonSelectPeak, h} ...
    );

h.textBKGTC3 = uicontrol( ...
    'Parent', h.BackgroundTempCorr, ...
    'Style', 'text', ...
    'FontSize', 9 ,...
    'Units', 'Normalized', ...
    'Position', [0.01 0.79 0.3 0.06], ...
    'HorizontalAlignment', 'left', ...
    'String', 'Define background points for temperature range. Up to 4 different ranges can be defined.' ...
    );

h.checkboxTRange1 = uicontrol( ...
        'Parent', h.BackgroundTempCorr, ...
        'Style', 'checkbox', ...
        'Units', 'Normalized', ...
        'Position', [0.098 0.78 0.02 0.02], ...
        'Tag', 'checkboxTRange1', ...
        'Value', 1 ...
        );

h.checkboxTRange2 = uicontrol( ...
        'Parent', h.BackgroundTempCorr, ...
        'Style', 'checkbox', ...
        'Units', 'Normalized', ...
        'Position', [0.153 0.78 0.02 0.02], ...
        'Tag', 'checkboxTRange2', ...
        'Value', 0 ...
        );
    
h.checkboxTRange3 = uicontrol( ...
        'Parent', h.BackgroundTempCorr, ...
        'Style', 'checkbox', ...
        'Units', 'Normalized', ...
        'Position', [0.208 0.78 0.02 0.02], ...
        'Tag', 'checkboxTRange3', ...
        'Value', 0 ...
        );    

h.checkboxTRange4 = uicontrol( ...
        'Parent', h.BackgroundTempCorr, ...
        'Style', 'checkbox', ...
        'Units', 'Normalized', ...
        'Position', [0.263 0.78 0.02 0.02], ...
        'Tag', 'checkboxTRange4', ...
        'Value', 0 ...
        );      
    
h.buttonSetEmin = uicontrol( ...
    'Parent', h.BackgroundTempCorr, ...
    'Style', 'Pushbutton', ...
    'Units', 'Normalized', ...
    'Position', [0.01 0.74 0.06 0.035], ...
    'String', 'Set Emin', ...
    'Tag', 'buttonSetEmin', ...
    'Callback', {@buttonSetEmin, h} ...
    );

h.editEmin1  = uicontrol( ...
    'Parent', h.BackgroundTempCorr, ...        
    'Style','edit',...
    'String', 'NaN',...
    'FontSize', 8,...
    'Tag', 'editEmin1',...
    'Units','normalized',...
    'Position',[0.08 0.7395 0.05 0.035] ...
    );

h.editEmin2  = uicontrol( ...
    'Parent', h.BackgroundTempCorr, ...        
    'Style','edit',...
    'String', 'NaN',...
    'FontSize', 8,...
    'Tag', 'editEmin2',...
    'Units','normalized',...
    'Position',[0.135 0.7395 0.05 0.035] ...
    );

h.editEmin3  = uicontrol( ...
    'Parent', h.BackgroundTempCorr, ...        
    'Style','edit',...
    'String', 'NaN',...
    'FontSize', 8,...
    'Tag', 'editEmin3',...
    'Units','normalized',...
    'Position',[0.19 0.7395 0.05 0.035] ...
    );

h.editEmin4  = uicontrol( ...
    'Parent', h.BackgroundTempCorr, ...        
    'Style','edit',...
    'String', 'NaN',...
    'FontSize', 8,...
    'Tag', 'editEmin4',...
    'Units','normalized',...
    'Position',[0.245 0.7395 0.05 0.035] ...
    );

h.buttonSetEmax = uicontrol( ...
    'Parent', h.BackgroundTempCorr, ...
    'Style', 'Pushbutton', ...
    'Units', 'Normalized', ...
    'Position', [0.01 0.695 0.06 0.035], ...
    'String', 'Set Emax', ...
    'Tag', 'buttonSetEmax', ...
    'Callback', {@buttonSetEmax, h} ...
    );

h.editEmax1  = uicontrol( ...
    'Parent', h.BackgroundTempCorr, ...        
    'Style','edit',...
    'String', 'NaN',...
    'FontSize', 8,...
    'Tag', 'editEmax1',...
    'Units','normalized',...
    'Position',[0.08 0.6945 0.05 0.035] ...
    );

h.editEmax2  = uicontrol( ...
    'Parent', h.BackgroundTempCorr, ...        
    'Style','edit',...
    'String', 'NaN',...
    'FontSize', 8,...
    'Tag', 'editEmax2',...
    'Units','normalized',...
    'Position',[0.135 0.6945 0.05 0.035] ...
    );

h.editEmax3  = uicontrol( ...
    'Parent', h.BackgroundTempCorr, ...        
    'Style','edit',...
    'String', 'NaN',...
    'FontSize', 8,...
    'Tag', 'editEmax3',...
    'Units','normalized',...
    'Position',[0.19 0.6945 0.05 0.035] ...
    );

h.editEmax4  = uicontrol( ...
    'Parent', h.BackgroundTempCorr, ...        
    'Style','edit',...
    'String', 'NaN',...
    'FontSize', 8,...
    'Tag', 'editEmax4',...
    'Units','normalized',...
    'Position',[0.245 0.6945 0.05 0.035] ...
    );

h.textBKGTC4 = uicontrol( ...
    'Parent', h.BackgroundTempCorr, ...
    'Style', 'text', ...
    'FontSize', 9 ,...
    'Units', 'Normalized', ...
    'Position', [0.01 0.63 0.32 0.04], ...
    'HorizontalAlignment', 'left', ...
    'String', 'Find and plot peak maximum as a function of temperature' ...
    );

h.buttonFindPeakMax = uicontrol( ...
    'Parent', h.BackgroundTempCorr, ...
    'Style', 'Pushbutton', ...
    'Units', 'Normalized', ...
    'Position', [0.06 0.575 0.18 0.05], ...
    'String', 'Find and plot peak maximum', ...
    'FontSize', 9 , ...
    'Tag', 'buttonFindPeakMax', ...
    'Callback', {@buttonFindPeakMax, h} ...
    );

h.textBKGTC5 = uicontrol( ...
    'Parent', h.BackgroundTempCorr, ...
    'Style', 'text', ...
    'FontSize', 9 ,...
    'Units', 'Normalized', ...
    'Position', [0.01 0.5 0.32 0.04], ...
    'HorizontalAlignment', 'left', ...
    'String', 'Exclude points from fit' ...
    );

h.buttonExcludePoints = uicontrol( ...
    'Parent', h.BackgroundTempCorr, ...
    'Style', 'Pushbutton', ...
    'Units', 'Normalized', ...
    'Position', [0.14 0.513 0.1 0.035], ...
    'String', 'Exclude points', ...
    'FontSize', 9 , ...
    'Tag', 'buttonFindPeakMax', ...
    'Callback', {@buttonExcludePoints, h} ...
    );


% Empty data for plot    
x = 0;
y = 0;
% Create axes objects for plot windows of raw data
h.axesPlotWindowOne = axes('Parent', h.BackgroundTempCorrPanel, 'Box', 'on', 'BoxStyle', 'Full', 'Position', [0.35 0.57 0.3 0.4]);
h.axesPlotWindowTwo = axes('Parent', h.BackgroundTempCorrPanel, 'Box', 'on', 'BoxStyle', 'Full', 'Position', [0.69 0.57 0.3 0.4]);

% Set axes properties
h.axesPlotWindowOne.Title.String = 'T = T1 °C';
h.axesPlotWindowOne.Title.FontWeight = 'normal';
h.axesPlotWindowOne.XLabel.String = 'Energy [keV]';
h.axesPlotWindowOne.YLabel.String = 'Intensity [cts]';
h.axesPlotWindowOne.XLim = [0 1];
h.axesPlotWindowOne.YLim = [0 1];
% h.text1 = text(h.axesPlotWindowOne,0.025,0.95,'Define Emin here','BackgroundColor','w','FontSize',12);
grid(h.axesPlotWindowOne,'on')
h.axesPlotWindowTwo.Title.String = 'T = T2 °C';
h.axesPlotWindowTwo.Title.FontWeight = 'normal';
h.axesPlotWindowTwo.XLabel.String = 'Energy [keV]';
h.axesPlotWindowTwo.XLim = [0 1];
h.axesPlotWindowTwo.YLim = [0 1];
% h.text2 = text(h.axesPlotWindowTwo,0.025,0.95,'Define Emax here','BackgroundColor','w','FontSize',12);
grid(h.axesPlotWindowTwo,'on')

% Create plots for plot windows of raw data
hold(h.axesPlotWindowOne,'on')
h.plotBKGTempCorrRawDataOne = plot(h.axesPlotWindowOne, x, y, 'Color', 'blue', 'LineWidth', 1);
h.plotBKGTempCorrBKGPointsOneUSP1a = plot(h.axesPlotWindowOne, x, y, 'o', 'Color', 'r', 'MarkerFaceColor', 'r' , 'MarkerSize', 5, 'Visible', 'off');
h.plotBKGTempCorrBKGPointsOneUSP1b = plot(h.axesPlotWindowOne, x, y, 'o', 'Color', 'green', 'MarkerFaceColor', 'green' , 'MarkerSize', 5, 'Visible', 'off');
h.plotBKGTempCorrBKGPointsOneUSP1c = plot(h.axesPlotWindowOne, x, y, 'o', 'Color', 'cyan', 'MarkerFaceColor', 'cyan' , 'MarkerSize', 5, 'Visible', 'off');
h.plotBKGTempCorrBKGPointsOneUSP1d = plot(h.axesPlotWindowOne, x, y, 'o', 'Color', 'magenta', 'MarkerFaceColor', 'magenta' , 'MarkerSize', 5, 'Visible', 'off');
hold(h.axesPlotWindowOne,'off')

hold(h.axesPlotWindowTwo,'on')
h.plotBKGTempCorrRawDataTwo = plot(h.axesPlotWindowTwo, x, y, 'Color', 'blue', 'LineWidth', 1);
h.plotBKGTempCorrBKGPointsTwoUSP2a = plot(h.axesPlotWindowTwo, x, y, 'o', 'Color', 'r', 'MarkerFaceColor', 'r' , 'MarkerSize', 5, 'Visible', 'off');
h.plotBKGTempCorrBKGPointsTwoUSP2b = plot(h.axesPlotWindowTwo, x, y, 'o', 'Color', 'green', 'MarkerFaceColor', 'green' , 'MarkerSize', 5, 'Visible', 'off');
h.plotBKGTempCorrBKGPointsTwoUSP2c = plot(h.axesPlotWindowTwo, x, y, 'o', 'Color', 'cyan', 'MarkerFaceColor', 'cyan' , 'MarkerSize', 5, 'Visible', 'off');
h.plotBKGTempCorrBKGPointsTwoUSP2d = plot(h.axesPlotWindowTwo, x, y, 'o', 'Color', 'magenta', 'MarkerFaceColor', 'magenta' , 'MarkerSize', 5, 'Visible', 'off');
hold(h.axesPlotWindowTwo,'off')

% Create slider for plot window one
h.SliderPlotWindowOne = uicontrol(...
        'Style','slider',...
        'Tag','Slider',...
        'Parent', h.BackgroundTempCorrPanel,...
        'Units','normalized',...
        'Position', [0.46 0.465 0.08 0.025],...
        'Min',0,...
        'Max', 1,...
        'Value',1,...
        'Callback',{@SliderCallbackPlotWindowOne});
% Create slider for plot window two
h.SliderPlotWindowTwo = uicontrol(...
        'Style','slider',...
        'Tag','Slider',...
        'Parent', h.BackgroundTempCorrPanel,...
        'Units','normalized',...
        'Position', [0.8 0.465 0.08 0.025],...
        'Min',0,...
        'Max', 1,...
        'Value',1,...
        'Callback',{@SliderCallbackPlotWindowTwo});

h.textBKGTC6 = uicontrol( ...
    'Parent', h.BackgroundTempCorr, ...
    'Style', 'text', ...
    'FontSize', 12 ,...
    'Units', 'Normalized', ...
    'Position', [0.61 0.38 0.32 0.04], ...
    'HorizontalAlignment', 'left', ...
    'String', 'Fit temperature dependency of energy shift' ...
    );

% Create axes objects for plot windows of E vs. Temp data
h.axesPlotEvsTemp = axes('Parent', h.BackgroundTempCorrPanel, 'Box', 'on', 'BoxStyle', 'Full', 'Position', [0.06 0.08 0.45 0.35]);

h.axesPlotEvsTemp.Title.String = 'Plot of energy shift';
h.axesPlotEvsTemp.Title.FontWeight = 'normal';
h.axesPlotEvsTemp.XLabel.String = 'Temperature [°C]';
h.axesPlotEvsTemp.YLabel.String = 'Energy [keV]';
h.axesPlotEvsTemp.XLim = [0 1];
h.axesPlotEvsTemp.YLim = [0 1];
grid(h.axesPlotEvsTemp,'on')    

% Create plots for plot windows of E vs. Temp data
hold(h.axesPlotEvsTemp,'on')
h.plotEPosDatavsTRange1 = plot(h.axesPlotEvsTemp, x, y, 'o', 'Color', 'blue', 'MarkerFaceColor', 'blue' , 'MarkerSize', 5, 'Visible', 'off');
h.plotEPosDatavsTRange2 = plot(h.axesPlotEvsTemp, x, y, 'o', 'Color', 'blue', 'MarkerFaceColor', 'r' , 'MarkerSize', 5, 'Visible', 'off');
h.plotEPosDatavsTRange3 = plot(h.axesPlotEvsTemp, x, y, 'o', 'Color', 'blue', 'MarkerFaceColor', 'cyan' , 'MarkerSize', 5, 'Visible', 'off');
h.plotEPosDatavsTRange4 = plot(h.axesPlotEvsTemp, x, y, 'o', 'Color', 'blue', 'MarkerFaceColor', 'magenta' , 'MarkerSize', 5, 'Visible', 'off');
h.plotFitEPosDatavsTRange1 = plot(h.axesPlotEvsTemp, x, y, '--', 'Color', [1 0 0], 'LineWidth', 2);
h.plotFitEPosDatavsTRange2 = plot(h.axesPlotEvsTemp, x, y, '--', 'Color', [1 0.8 0], 'LineWidth', 2);
h.plotFitEPosDatavsTRange3 = plot(h.axesPlotEvsTemp, x, y, '--', 'Color', [0.6 0 0.2], 'LineWidth', 2);
h.plotFitEPosDatavsTRange4 = plot(h.axesPlotEvsTemp, x, y, '--', 'Color', [0.6 0.4 0], 'LineWidth', 2);

h.textBKGTC7 = uicontrol( ...
    'Parent', h.BackgroundTempCorr, ...
    'Style', 'text', ...
    'FontSize', 9 ,...
    'Units', 'Normalized', ...
    'Position', [0.53 0.32 0.32 0.04], ...
    'HorizontalAlignment', 'left', ...
    'String', 'Use                                                         to fit' ...
    );

h.popupmenuBKGFitFunc = uicontrol( ...
        'Parent', h.BackgroundTempCorr, ...
        'Style', 'popupmenu', ...
        'Units', 'Normalized', ...
        'Position', [0.565 0.277 0.14 0.09], ...
        'FontSize', 10, ...
        'Tag', 'popupmenuBKGFitFunc', ...
        'String', {'Select Fit Function', 'Polynomial Deg 1', 'Polynomial Deg 2', 'Polynomial Deg 3', 'Polynomial Deg 4', 'Polynomial Deg 5', 'Polynomial Deg 6', 'Boltzmann'}, ...
        'Value', 1 ...
        );
%         'Callback', {@popupmenuBKGFitFunc} ...
%         );

h.popupmenuDataSet = uicontrol( ...
        'Parent', h.BackgroundTempCorr, ...
        'Style', 'popupmenu', ...
        'Units', 'Normalized', ...
        'Position', [0.756 0.277 0.12 0.09], ...
        'FontSize', 10, ...
        'Tag', 'popupmenuDataSet', ...
        'String', {'Select Data Set', 'Data Set 1', 'Data Set 2', 'Data Set 3', 'Data Set 4'}, ...
        'Value', 1 ...
        );
%         'Callback', {@popupmenuDataSet} ...
%         );    
    
h.buttonPolyFit = uicontrol( ...
    'Parent', h.BackgroundTempCorr, ...
    'Style', 'Pushbutton', ...
    'Units', 'Normalized', ...
    'Position', [0.9 0.333 0.06 0.035], ...
    'String', 'Fit', ...
    'FontSize', 9,...
    'Tag', 'buttonPolyFit', ...
    'Callback', {@buttonPolyFit, h} ...
    );

d = {num2str(nan) num2str(nan) num2str(nan) num2str(nan);num2str(nan) num2str(nan) num2str(nan) num2str(nan)};
h.tableFitDataQuality = uitable(h.BackgroundTempCorr, ...
    'Units', 'Normalized', ...
    'Position', [0.57 0.21 0.362 0.075], ...
    'Tag', 'tableFitDataQuality', ...
    'data', d, ...
    'RowName', {'FitFunc';'R^2/RMSE'}, ...
    'ColumnName', {'Data Set 1','Data Set 2','Data Set 3','Data Set 4'}, ...
    'ColumnFormat', {'char','char','char','char'}, ...
    'ColumnEditable', false, ...
    'CellEditCallback',{@tableFitDataQuality}, ...
    'ColumnWidth',{70} ...
    );


h.buttonApplyCorr = uicontrol( ...
    'Parent', h.BackgroundTempCorr, ...
    'Style', 'Pushbutton', ...
    'Units', 'Normalized', ...
    'Position', [0.73 0.08 0.11 0.055], ...
    'String', 'Apply Correction', ...
    'FontSize', 9,...
    'Tag', 'buttonApplyCorr', ...
    'Callback', {@buttonApplyCorr, h} ...
    );

h.buttonOkCancelCorr = uicontrol( ...
    'Parent', h.BackgroundTempCorr, ...
    'Style', 'Pushbutton', ...
    'Units', 'Normalized', ...
    'Position', [0.85 0.08 0.11 0.055], ...
    'String', 'Ok / Cancel', ...
    'FontSize', 9,...
    'Tag', 'buttonApplyCorr', ...
    'Callback', {@buttonOkCancelCorr, h} ...
    );

% Set current handle h to callbacks
set(h.buttonSelectPeak,'callback',{@buttonSelectPeak, h})
set(h.SliderPlotWindowOne,'callback',{@SliderCallbackPlotWindowOne, h})
set(h.SliderPlotWindowTwo,'callback',{@SliderCallbackPlotWindowTwo, h})

set(h.buttonSetEmin,'callback',{@buttonSetEmin, h})
% set(h.buttonSetEminManual,'callback',{@buttonSetEminManual, h})
set(h.buttonSetEmax,'callback',{@buttonSetEmax, h})
% set(h.buttonSetEmaxManual,'callback',{@buttonSetEmaxManual, h})
set(h.buttonFindPeakMax,'callback',{@buttonFindPeakMax, h})
set(h.buttonExcludePoints,'callback',{@buttonExcludePoints, h})

set(h.buttonPolyFit,'callback',{@buttonPolyFit, h})
set(h.buttonApplyCorr,'callback',{@buttonApplyCorr, h})
set(h.buttonOkCancelCorr,'callback',{@buttonOkCancelCorr, h})

% Set slider data
if length(h.Measurement) == 1
    set(h.SliderPlotWindowOne,'Min',0);
    set(h.SliderPlotWindowOne,'Max',length(h.Measurement));
    set(h.SliderPlotWindowOne,'SliderStep',[1 1]);
    set(h.SliderPlotWindowTwo,'Min',0);
    set(h.SliderPlotWindowTwo,'Max',length(h.Measurement));
    set(h.SliderPlotWindowTwo,'SliderStep',[1 1]);
else
    set(h.SliderPlotWindowOne,'Min',1);
    set(h.SliderPlotWindowOne,'Max',length(h.Measurement));
    set(h.SliderPlotWindowOne,'SliderStep',[1/(length(h.Measurement)-1) 1/(length(h.Measurement)-1)]);
    set(h.SliderPlotWindowTwo,'Min',1);
    set(h.SliderPlotWindowTwo,'Max',length(h.Measurement));
    set(h.SliderPlotWindowTwo,'SliderStep',[1/(length(h.Measurement)-1) 1/(length(h.Measurement)-1)]);
end

guidata(hObj, h);

function buttonSelectPeak(hObj, ~, handles)
% Callback for selecting peak to analyze energy shift
h = handles;

% Get slider value Max
valueSliderMax = get(h.Slider, 'Max');
% Get slider value Min
valueSliderMin = get(h.Slider, 'Min');
% Set slider value Min
set(h.SliderPlotWindowOne,'Value',valueSliderMin);
% Set slider value Max
set(h.SliderPlotWindowTwo,'Value',valueSliderMax);
% Get number of selected peak
PeakSel = str2double(get(h.editSelectPeak,'String'));
% Get index of user defined background points
IndexEminWindowOne = find(h.DataTmp{valueSliderMin}(:,1) == h.PeakRegionsX{valueSliderMin}(1,PeakSel));
IndexEmaxWindowOne = find(h.DataTmp{valueSliderMin}(:,1) == h.PeakRegionsX{valueSliderMin}(2,PeakSel));

IndexEminWindowTwo = find(h.DataTmp{valueSliderMax}(:,1) == h.PeakRegionsX{valueSliderMax}(1,PeakSel));
IndexEmaxWindowTwo = find(h.DataTmp{valueSliderMax}(:,1) == h.PeakRegionsX{valueSliderMax}(2,PeakSel));
% Set plot window data according to previously defined indices 
set(h.plotBKGTempCorrRawDataOne,{'xdata','ydata'},{h.DataTmp{valueSliderMin}(IndexEminWindowOne-30:IndexEmaxWindowOne+30,1),h.DataTmp{valueSliderMin}(IndexEminWindowOne-30:IndexEmaxWindowOne+30,2)});
set(h.plotBKGTempCorrRawDataTwo,{'xdata','ydata'},{h.DataTmp{valueSliderMax}(IndexEminWindowTwo-30:IndexEmaxWindowTwo+30,1),h.DataTmp{valueSliderMax}(IndexEminWindowTwo-30:IndexEmaxWindowTwo+30,2)});
% Set plot title and limits
h.axesPlotWindowOne.Title.String = ['T = ', num2str(h.Measurement(valueSliderMin).Temperatures(1)), '°C'];
h.axesPlotWindowOne.XLim = [-Inf Inf];
h.axesPlotWindowOne.YLim = [0 Inf];

h.axesPlotWindowTwo.Title.String = ['T = ', num2str(h.Measurement(valueSliderMax).Temperatures(1)), '°C'];
h.axesPlotWindowTwo.XLim = [-Inf Inf];
h.axesPlotWindowTwo.YLim = [0 Inf];

% Set default values for background points and make them invisible
set(h.plotBKGTempCorrBKGPointsOneUSP1a,{'xdata','ydata','Visible'},{0,0,'off'});
set(h.plotBKGTempCorrBKGPointsOneUSP1b,{'xdata','ydata','Visible'},{0,0,'off'});
set(h.plotBKGTempCorrBKGPointsOneUSP1c,{'xdata','ydata','Visible'},{0,0,'off'});
set(h.plotBKGTempCorrBKGPointsOneUSP1d,{'xdata','ydata','Visible'},{0,0,'off'});

set(h.plotBKGTempCorrBKGPointsTwoUSP2a,{'xdata','ydata','Visible'},{0,0,'off'});
set(h.plotBKGTempCorrBKGPointsTwoUSP2b,{'xdata','ydata','Visible'},{0,0,'off'});
set(h.plotBKGTempCorrBKGPointsTwoUSP2c,{'xdata','ydata','Visible'},{0,0,'off'});
set(h.plotBKGTempCorrBKGPointsTwoUSP2d,{'xdata','ydata','Visible'},{0,0,'off'});

% Set strings of edit fields to NaN 
set(h.editEmin1,'String','NaN');
set(h.editEmin2,'String','NaN');
set(h.editEmin3,'String','NaN');
set(h.editEmin4,'String','NaN');

set(h.editEmax1,'String','NaN');
set(h.editEmax2,'String','NaN');
set(h.editEmax3,'String','NaN');
set(h.editEmax4,'String','NaN');

% Set default values for background points and make them invisible
set(h.plotEPosDatavsTRange1,{'xdata','ydata','Visible'},{0,0,'off'});
set(h.plotEPosDatavsTRange2,{'xdata','ydata','Visible'},{0,0,'off'});
set(h.plotEPosDatavsTRange3,{'xdata','ydata','Visible'},{0,0,'off'});
set(h.plotEPosDatavsTRange4,{'xdata','ydata','Visible'},{0,0,'off'});

set(h.plotFitEPosDatavsTRange1,{'xdata','ydata'},{0,0});
set(h.plotFitEPosDatavsTRange2,{'xdata','ydata'},{0,0});
set(h.plotFitEPosDatavsTRange3,{'xdata','ydata'},{0,0});
set(h.plotFitEPosDatavsTRange4,{'xdata','ydata'},{0,0});

legend(h.axesPlotEvsTemp,'off')

guidata(hObj, h);

function SliderCallbackPlotWindowOne(hObj, ~, handles)
% Slider Callback for window one
h = handles;

% Get slider value
value = round(get(hObj, 'Value'));
% Get selected peak number
PeakSel = str2double(get(h.editSelectPeak,'String'));
% Find index of Emin and Emax
IndexEminWindowOne = find(h.DataTmp{value}(:,1) == h.PeakRegionsX{value}(1,PeakSel));
IndexEmaxWindowOne = find(h.DataTmp{value}(:,1) == h.PeakRegionsX{value}(2,PeakSel));
% Set plot data
set(h.plotBKGTempCorrRawDataOne,{'xdata','ydata'},{h.DataTmp{value}(IndexEminWindowOne-30:IndexEmaxWindowOne+30,1),h.DataTmp{value}(IndexEminWindowOne-30:IndexEmaxWindowOne+30,2)});
% Set title of plot window
h.axesPlotWindowOne.Title.String = ['T = ', num2str(h.Measurement(value).Temperatures(1)), '°C'];

guidata(hObj, h);

function SliderCallbackPlotWindowTwo(hObj, ~, handles)
% Slider Callback for window two
h = handles;

% Get slider value
value = get(hObj, 'Value');
% Get selected peak number
PeakSel = str2double(get(h.editSelectPeak,'String'));
% Find index of Emin and Emax
IndexEminWindowTwo = find(h.DataTmp{value}(:,1) == h.PeakRegionsX{value}(1,PeakSel));
IndexEmaxWindowTwo = find(h.DataTmp{value}(:,1) == h.PeakRegionsX{value}(2,PeakSel));
% Set plot data
set(h.plotBKGTempCorrRawDataTwo,{'xdata','ydata'},{h.DataTmp{value}(IndexEminWindowTwo-30:IndexEmaxWindowTwo+30,1),h.DataTmp{value}(IndexEminWindowTwo-30:IndexEmaxWindowTwo+30,2)});
% Set title of plot window
h.axesPlotWindowTwo.Title.String = ['T = ', num2str(h.Measurement(value).Temperatures(1)), '°C'];

guidata(hObj, h);

function buttonSetEmin(hObj, ~, handles)
% Callback for updating user selected background points table
h = handles;
% Get slider value
value = round(get(h.SliderPlotWindowOne, 'Value'));
% Get values of checkboxes
BoxSel = [get(h.checkboxTRange1,'Value') get(h.checkboxTRange2,'Value') get(h.checkboxTRange3,'Value') get(h.checkboxTRange4,'Value')];

% Messagebox
k = msgbox('Set a marker left of the peak. Confirm by Enter.');
% Wait for user to press ok
uiwait(k);
% Get points selected from user
[BKGP1,~] = getpts(h.axesPlotWindowOne);

% Find closest point to user selected point
indexUSP1 = Tools.Data.DataSetOperations.FindNearestIndex(h.DataTmp{value}(:,1),BKGP1);

% UserSelectedPoints = ismembertol(h.DataTmp{value}(:,1),ceil(BKGP1*1000)/1000,0.008,'DataScale',1);
% % Find index of user selected bkg points
% indexUSP1 = find(UserSelectedPoints == 1);
% 
% n = 0.00001;
% 
% while length(BKGP1) ~= length(indexUSP1)
%     UserSelectedPoints = ismembertol(h.DataTmp{value}(:,1),ceil(BKGP1*1000)/1000,(0.008-n),'DataScale',1);
%     % Find index of user selected bkg points
%     indexUSP1 = find(UserSelectedPoints == 1);
%     n = n + 0.00001;
% end

% Set Emin as string for edit field
if BoxSel(1) == 1
    h.indexUSP1a = indexUSP1;
    h.indexUSP1b = 0;
    h.indexUSP1c = 0;
    h.indexUSP1d = 0;
    h.ScanNrUSP1a = value;
    h.ScanNrUSP1b = 0;
    h.ScanNrUSP1c = 0;
    h.ScanNrUSP1d = 0;
    set(h.editEmin1,'String',num2str(h.DataTmp{value}(h.indexUSP1a,1)));
    % Plot background point in plot window one
    set(h.plotBKGTempCorrBKGPointsOneUSP1a,{'xdata','ydata','Visible'},{h.DataTmp{value}(h.indexUSP1a,1),h.DataTmp{value}(h.indexUSP1a,2),'on'});
elseif BoxSel(2) == 1
    h.indexUSP1b = indexUSP1;
    h.ScanNrUSP1b = value;
    set(h.editEmin2,'String',num2str(h.DataTmp{value}(h.indexUSP1b,1)));
    % Plot background point in plot window one
    set(h.plotBKGTempCorrBKGPointsOneUSP1b,{'xdata','ydata','Visible'},{h.DataTmp{value}(h.indexUSP1b,1),h.DataTmp{value}(h.indexUSP1b,2),'on'});
elseif BoxSel(3) == 1
    h.indexUSP1c = indexUSP1;
    h.ScanNrUSP1c = value;
    set(h.editEmin3,'String',num2str(h.DataTmp{value}(h.indexUSP1c,1)));
    % Plot background point in plot window one
    set(h.plotBKGTempCorrBKGPointsOneUSP1c,{'xdata','ydata','Visible'},{h.DataTmp{value}(h.indexUSP1c,1),h.DataTmp{value}(h.indexUSP1c,2),'on'});
elseif BoxSel(4) == 1
    h.indexUSP1d = indexUSP1;
    h.ScanNrUSP1d = value;
    set(h.editEmin4,'String',num2str(h.DataTmp{value}(h.indexUSP1d,1)));
    % Plot background point in plot window one
    set(h.plotBKGTempCorrBKGPointsOneUSP1d,{'xdata','ydata','Visible'},{h.DataTmp{value}(h.indexUSP1d,1),h.DataTmp{value}(h.indexUSP1d,2),'on'});
end

% Update callback data
set(h.buttonSetEmax,'callback',{@buttonSetEmax, h})
set(h.buttonSetEmin,'callback',{@buttonSetEmin, h})

guidata(hObj, h);

function buttonSetEmax(hObj, ~, handles)
% Callback for updating user selected background points table
% h = guidata(hObj);
h = handles;
% Get slider value
value = get(h.SliderPlotWindowTwo, 'Value');
% Get values of checkboxes
BoxSel = [get(h.checkboxTRange1,'Value') get(h.checkboxTRange2,'Value') get(h.checkboxTRange3,'Value') get(h.checkboxTRange4,'Value')];

% Messagebox
k = msgbox('Set a marker right of the peak. Confirm by Enter.');
% Wait for user to press ok
uiwait(k);
% Get points selected from user
[BKGP2,~] = getpts(h.axesPlotWindowTwo);

% Find closest point to user selected point
indexUSP2 = Tools.Data.DataSetOperations.FindNearestIndex(h.DataTmp{value}(:,1),BKGP2);

% UserSelectedPoints = ismembertol(h.DataTmp{value}(:,1),ceil(BKGP2*1000)/1000,0.008,'DataScale',1);
% % Find index of user selected bkg points
% indexUSP2 = find(UserSelectedPoints == 1);
% 
% n = 0.00001;
% 
% while length(BKGP2) ~= length(indexUSP2)
%     UserSelectedPoints = ismembertol(h.DataTmp{value}(:,1),ceil(BKGP2*1000)/1000,(0.008-n),'DataScale',1);
%     % Find index of user selected bkg points
%     indexUSP2 = find(UserSelectedPoints == 1);
%     n = n + 0.00001;
% end

% Set Emax as string for edit field
if BoxSel(1) == 1
    h.indexUSP2a = indexUSP2;
    h.indexUSP2b = 0;
    h.indexUSP2c = 0;
    h.indexUSP2d = 0;
    h.ScanNrUSP2a = value;
    h.ScanNrUSP2b = 0;
    h.ScanNrUSP2c = 0;
    h.ScanNrUSP2d = 0;
    set(h.editEmax1,'String',num2str(h.DataTmp{value}(h.indexUSP2a,1)));
    % Plot background point in plot window one
    set(h.plotBKGTempCorrBKGPointsTwoUSP2a,{'xdata','ydata','Visible'},{h.DataTmp{value}(h.indexUSP2a,1),h.DataTmp{value}(h.indexUSP2a,2),'on'});
elseif BoxSel(2) == 1
    h.indexUSP2b = indexUSP2;
    h.ScanNrUSP2b = value;
    set(h.editEmax2,'String',num2str(h.DataTmp{value}(h.indexUSP2b,1)));
    % Plot background point in plot window one
    set(h.plotBKGTempCorrBKGPointsTwoUSP2b,{'xdata','ydata','Visible'},{h.DataTmp{value}(h.indexUSP2b,1),h.DataTmp{value}(h.indexUSP2b,2),'on'});
elseif BoxSel(3) == 1
    h.indexUSP2c = indexUSP2;
    h.ScanNrUSP2c = value;
    set(h.editEmax3,'String',num2str(h.DataTmp{value}(h.indexUSP2c,1)));
    % Plot background point in plot window one
    set(h.plotBKGTempCorrBKGPointsTwoUSP2c,{'xdata','ydata','Visible'},{h.DataTmp{value}(h.indexUSP2c,1),h.DataTmp{value}(h.indexUSP2c,2),'on'});
elseif BoxSel(4) == 1
    h.indexUSP2d = indexUSP2;
    h.ScanNrUSP2d = value;
    set(h.editEmax4,'String',num2str(h.DataTmp{value}(h.indexUSP2d,1)));
    % Plot background point in plot window one
    set(h.plotBKGTempCorrBKGPointsTwoUSP2d,{'xdata','ydata','Visible'},{h.DataTmp{value}(h.indexUSP2d,1),h.DataTmp{value}(h.indexUSP2d,2),'on'});
end

% Update callback data
set(h.buttonSetEmin,'callback',{@buttonSetEmin, h})
set(h.buttonSetEmax,'callback',{@buttonSetEmax, h})
set(h.buttonFindPeakMax,'callback',{@buttonFindPeakMax, h})

guidata(hObj, h);

function buttonFindPeakMax(hObj, ~, handles)
% Callback for updating user selected background points table
% h = guidata(hObj);
h = handles;

% Get indices and scan numbers of user selected energy ranges
IndexUSP1 = [h.indexUSP1a h.indexUSP1b h.indexUSP1c h.indexUSP1d];
IndexUSP2 = [h.indexUSP2a h.indexUSP2b h.indexUSP2c h.indexUSP2d];
ScanNrUSP1 = [h.ScanNrUSP1a h.ScanNrUSP1b h.ScanNrUSP1c h.ScanNrUSP1d];
ScanNrUSP2 = [h.ScanNrUSP2a h.ScanNrUSP2b h.ScanNrUSP2c h.ScanNrUSP2d];

% Find Int max and corresponding EPos and get temperatures from measurement
for j = 1:length(ScanNrUSP1(ScanNrUSP1~=0))
    if ScanNrUSP2(j) > ScanNrUSP1(j)
        for k = ScanNrUSP1(j):ScanNrUSP2(j)
            [~,h.IMax{j}(k)] = max(h.DataTmp{k}(IndexUSP1(j):IndexUSP2(j),2));
            h.EPosIMax{j}(k) = h.DataTmp{k}(h.IMax{j}(k)+IndexUSP1(j),1);
            h.Temp{j}(k) = h.Measurement(k).Temperatures(1);
        end
    else
        for k = ScanNrUSP2(j):ScanNrUSP1(j)
            [~,h.IMax{j}(k)] = max(h.DataTmp{k}(IndexUSP1(j):IndexUSP2(j),2));
            h.EPosIMax{j}(k) = h.DataTmp{k}(h.IMax{j}(k)+IndexUSP1(j),1);
            h.Temp{j}(k) = h.Measurement(k).Temperatures(1);
        end
    end
        
end

% Find and delete zero entries
indexToDel = cell(1);
for j = 1:length(ScanNrUSP1(ScanNrUSP1~=0))
    indexToDel{j} = find([h.EPosIMax{1,j}] == 0);
    h.EPosIMax{1,j}(indexToDel{j}) = [];
    h.Temp{1,j}(indexToDel{j}) = [];
end

% Set plot data and limits
if IndexUSP1(1) ~= 0
    set(h.plotEPosDatavsTRange1,{'xdata','ydata','Visible'},{h.Temp{1},h.EPosIMax{1},'on'});
end
if IndexUSP1(2) ~= 0
    set(h.plotEPosDatavsTRange2,{'xdata','ydata','Visible'},{h.Temp{2},h.EPosIMax{2},'on'});
end
if IndexUSP1(3) ~= 0
    set(h.plotEPosDatavsTRange3,{'xdata','ydata','Visible'},{h.Temp{3},h.EPosIMax{3},'on'});
end
if IndexUSP1(4) ~= 0
    set(h.plotEPosDatavsTRange4,{'xdata','ydata','Visible'},{h.Temp{4},h.EPosIMax{4},'on'});
end

% Define titles for legend
LegNamesData = {'Data Set 1','Data Set 2','Data Set 3','Data Set 4'};
% Check which titles should be active
h.LegNamesIdxData = [0 0 0 0];
idxLeg = find(ScanNrUSP1(ScanNrUSP1~=0));
h.LegNamesIdxData(idxLeg) = 1;
% Create legend
legend(h.axesPlotEvsTemp,LegNamesData{logical(h.LegNamesIdxData)})

h.axesPlotEvsTemp.XLim = [min(cellfun(@min,h.Temp))-50 max(cellfun(@max,h.Temp))+50];
h.axesPlotEvsTemp.YLim = [min(cellfun(@min,h.EPosIMax))-0.2 max(cellfun(@max,h.EPosIMax))+0.2];

% Update callback data
set(h.buttonExcludePoints,'callback',{@buttonExcludePoints, h})
set(h.buttonPolyFit,'callback',{@buttonPolyFit, h})

guidata(hObj, h);

function buttonExcludePoints(hObj, ~, handles)
% Callback for updating user selected background points table
% h = guidata(hObj);
h = handles;




guidata(hObj, h);

function buttonPolyFit(hObj, ~, handles)
% Callback for updating user selected background points table
% h = guidata(hObj);
h = handles;
% Get fit func selected by the user
BKGFitFuncVal = get(h.popupmenuBKGFitFunc,'Value');
BKGFitFuncStr = get(h.popupmenuBKGFitFunc,'String');
% Get data set selected by the user
BKGDataSetVal = get(h.popupmenuDataSet,'Value');
% Fit selected data set using selected fit function
plotFitEPosDatavsTRange = {h.plotFitEPosDatavsTRange1;h.plotFitEPosDatavsTRange2;h.plotFitEPosDatavsTRange3;h.plotFitEPosDatavsTRange4};
% Get data from tableFitDataQuality
Data = get(h.tableFitDataQuality,'Data');
% Fit selected data using selected fit function
if strcmp(BKGFitFuncStr{BKGFitFuncVal},'Polynomial Deg 1')
    % Fit data
    [p1,S1] = polyfit(h.Temp{BKGDataSetVal-1},h.EPosIMax{BKGDataSetVal-1},1);
    RSquareP1 = 1-(S1.normr/norm(h.EPosIMax{BKGDataSetVal-1} - mean(h.EPosIMax{BKGDataSetVal-1})))^2;
    % Calculate fitted curve
    Poly1Data = polyval(p1,h.Temp{BKGDataSetVal-1},S1);
    % Plot fitted curve
    set(plotFitEPosDatavsTRange{BKGDataSetVal-1},{'xdata','ydata','Visible'},{h.Temp{BKGDataSetVal-1},Poly1Data,'on'});
    % Set table data
    Data{1,BKGDataSetVal-1} = 'Poly1';
    Data{2,BKGDataSetVal-1} = num2str(RSquareP1);
    % Save correction data
    h.BKGCorrData{BKGDataSetVal-1} = Poly1Data;
elseif strcmp(BKGFitFuncStr{BKGFitFuncVal},'Polynomial Deg 2')
    % Fit data
    [p2,S2] = polyfit(h.Temp{BKGDataSetVal-1},h.EPosIMax{BKGDataSetVal-1},2);
    RSquareP2 = 1-(S2.normr/norm(h.EPosIMax{BKGDataSetVal-1} - mean(h.EPosIMax{BKGDataSetVal-1})))^2;
    % Calculate fitted curve
    Poly2Data = polyval(p2,h.Temp{BKGDataSetVal-1},S2);
    % Plot fitted curve
    set(plotFitEPosDatavsTRange{BKGDataSetVal-1},{'xdata','ydata','Visible'},{h.Temp{BKGDataSetVal-1},Poly2Data,'on'});
    % Set table data
    Data{1,BKGDataSetVal-1} = 'Poly2';
    Data{2,BKGDataSetVal-1} = num2str(RSquareP2);
    % Save correction data
    h.BKGCorrData{BKGDataSetVal-1} = Poly2Data;
elseif strcmp(BKGFitFuncStr{BKGFitFuncVal},'Polynomial Deg 3')
    % Fit data
    [p3,S3] = polyfit(h.Temp{BKGDataSetVal-1},h.EPosIMax{BKGDataSetVal-1},3);
    RSquareP3 = 1-(S3.normr/norm(h.EPosIMax{BKGDataSetVal-1} - mean(h.EPosIMax{BKGDataSetVal-1})))^2;
    % Calculate fitted curve
    Poly3Data = polyval(p3,h.Temp{BKGDataSetVal-1},S3);
    % Plot fitted curve
    set(plotFitEPosDatavsTRange{BKGDataSetVal-1},{'xdata','ydata','Visible'},{h.Temp{BKGDataSetVal-1},Poly3Data,'on'});
    % Set table data
    Data{1,BKGDataSetVal-1} = 'Poly3';
    Data{2,BKGDataSetVal-1} = num2str(RSquareP3);
    % Save correction data
    h.BKGCorrData{BKGDataSetVal-1} = Poly3Data;
elseif strcmp(BKGFitFuncStr{BKGFitFuncVal},'Polynomial Deg 4')    
    % Fit data
    [p4,S4] = polyfit(h.Temp{BKGDataSetVal-1},h.EPosIMax{BKGDataSetVal-1},4);
    RSquareP4 = 1-(S4.normr/norm(h.EPosIMax{BKGDataSetVal-1} - mean(h.EPosIMax{BKGDataSetVal-1})))^2;
    % Calculate fitted curve
    Poly4Data = polyval(p4,h.Temp{BKGDataSetVal-1},S4);
    % Plot fitted curve
    set(plotFitEPosDatavsTRange{BKGDataSetVal-1},{'xdata','ydata','Visible'},{h.Temp{BKGDataSetVal-1},Poly4Data,'on'});
    % Set table data
    Data{1,BKGDataSetVal-1} = 'Poly4';
    Data{2,BKGDataSetVal-1} = num2str(RSquareP4);
    % Save correction data
    h.BKGCorrData{BKGDataSetVal-1} = Poly4Data;
elseif strcmp(BKGFitFuncStr{BKGFitFuncVal},'Polynomial Deg 5')
    % Fit data
    [p5,S5] = polyfit(h.Temp{BKGDataSetVal-1},h.EPosIMax{BKGDataSetVal-1},5);
    RSquareP5 = 1-(S5.normr/norm(h.EPosIMax{BKGDataSetVal-1} - mean(h.EPosIMax{BKGDataSetVal-1})))^2;
    % Calculate fitted curve
    Poly5Data = polyval(p5,h.Temp{BKGDataSetVal-1},S5);
    % Plot fitted curve
    set(plotFitEPosDatavsTRange{BKGDataSetVal-1},{'xdata','ydata','Visible'},{h.Temp{BKGDataSetVal-1},Poly5Data,'on'});
    % Set table data
    Data{1,BKGDataSetVal-1} = 'Poly5';
    Data{2,BKGDataSetVal-1} = num2str(RSquareP5);
    % Save correction data
    h.BKGCorrData{BKGDataSetVal-1} = Poly5Data;
elseif strcmp(BKGFitFuncStr{BKGFitFuncVal},'Polynomial Deg 6')    
    % Fit data
    [p6,S6] = polyfit(h.Temp{BKGDataSetVal-1},h.EPosIMax{BKGDataSetVal-1},6);
    RSquareP6 = 1-(S6.normr/norm(h.EPosIMax{BKGDataSetVal-1} - mean(h.EPosIMax{BKGDataSetVal-1})))^2;
    % Calculate fitted curve
    Poly6Data = polyval(p6,h.Temp{BKGDataSetVal-1},S6);
    % Plot fitted curve
    set(plotFitEPosDatavsTRange{BKGDataSetVal-1},{'xdata','ydata','Visible'},{h.Temp{BKGDataSetVal-1},Poly6Data,'on'});
    % Set table data
    Data{1,BKGDataSetVal-1} = 'Poly6';
    Data{2,BKGDataSetVal-1} = num2str(RSquareP6);
    % Save correction data
    h.BKGCorrData{BKGDataSetVal-1} = Poly6Data;
elseif strcmp(BKGFitFuncStr{BKGFitFuncVal},'Boltzmann')
    % Define start parameter
    StartParams = [min(h.EPosIMax{BKGDataSetVal-1});max(h.EPosIMax{BKGDataSetVal-1});(h.Temp{BKGDataSetVal-1}(1)+h.Temp{BKGDataSetVal-1}(end))/2;20];
    % Fit function
    BoltzmannFun = @(a,x)a(1)+(a(1)-a(2))./(1+exp((x-a(3))./a(4)));
    opts = statset('nlinfit');
    opts.MaxIter = 1000;
    % Fit
    [FitParamsBoltzmann,~,~,~,MSE,~] = nlinfit(h.Temp{BKGDataSetVal-1},h.EPosIMax{BKGDataSetVal-1},BoltzmannFun,StartParams,opts);
    % Calculate fitted curve
    FitDataBoltzmann = BoltzmannFun(FitParamsBoltzmann,h.Temp{BKGDataSetVal-1});
    % Plot fitted curve
    set(plotFitEPosDatavsTRange{BKGDataSetVal-1},{'xdata','ydata','Visible'},{h.Temp{BKGDataSetVal-1},FitDataBoltzmann,'on'});
    % Set table data
    Data{1,BKGDataSetVal-1} = 'Boltzmann';
    Data{2,BKGDataSetVal-1} = num2str(sqrt(MSE));
    % Save correction data
    h.BKGCorrData{BKGDataSetVal-1} = FitDataBoltzmann;
end

% Set table data
set(h.tableFitDataQuality,'data',Data);

% Create vector with information about which plot is active
if ~isfield(h, 'LegnamesIdxFitData')
    h.LegnamesIdxFitData = [0 0 0 0 0 0 0 0];
end
% Get info about which data set is active
h.LegnamesIdxFitData(logical(h.LegNamesIdxData)) = 1;
% Save info about which data set was fitted
h.LegnamesIdxFitData(BKGDataSetVal-1+4) = 1;
% Create dummy plots in order to be able to create adjustable legend
hold on
LH(1) = plot(nan, nan, 'o', 'Color', 'blue', 'MarkerFaceColor', 'blue');
LH(2) = plot(nan, nan, 'o', 'Color', 'blue', 'MarkerFaceColor', 'red');
LH(3) = plot(nan, nan, 'o', 'Color', 'blue', 'MarkerFaceColor', 'cyan');
LH(4) = plot(nan, nan, 'o', 'Color', 'blue', 'MarkerFaceColor', 'magenta');
L{1} = 'Data Set 1';
L{2} = 'Data Set 2';
L{3} = 'Data Set 3';
L{4} = 'Data Set 4';
LH(5) = plot(nan, nan, '--', 'Color', [1 0 0]);
LH(6) = plot(nan, nan, '--', 'Color', [1 0.8 0]);
LH(7) = plot(nan, nan, '--', 'Color', [0.6 0 0.2]);
LH(8) = plot(nan, nan, '--', 'Color', [0.6 0.4 0]);
L{5} = 'Fit of Data Set 1';
L{6} = 'Fit of Data Set 2';
L{7} = 'Fit of Data Set 3';
L{8} = 'Fit of Data Set 4';
legend(h.axesPlotEvsTemp, LH(logical(h.LegnamesIdxFitData)), L{logical(h.LegnamesIdxFitData)});
hold off

% Update callback data
set(h.buttonPolyFit,'callback',{@buttonPolyFit, h})
set(h.buttonApplyCorr,'callback',{@buttonApplyCorr, h})

guidata(hObj, h);

function buttonApplyCorr(hObj, ~, handles)
% Callback for updating user selected background points table
% h = guidata(hObj);
h = handles;
% assignin('base','DataTmp',h.DataTmp)

% Function to make "Fit" button blink in red during fitting process
col = get(hObj,'backg');  % Get the background color of the figure.
set(hObj,'str','Applying','backg',[1 .6 .6]) % Change color of button. 
% The pause (or drawnow) is necessary to make button changes appear.
pause(.01)
% Get slider value
valueSlider = round(get(h.Slider, 'Value'));
% Calculate energy shift for the different temperature ranges
EshiftTemptmp = cell(1);
for k = 1:length(h.BKGCorrData)
    EshiftTemptmp{k} = abs(h.BKGCorrData{k} - h.BKGCorrData{k}(1));
end
% Convert cell to matrix
h.EshiftTemp = cell2mat(EshiftTemptmp);
% Apply temperature induced energy shift correction
for k = 1:length(h.PeakRegionsX)
    h.PeakRegionsXCorr{k} = h.PeakRegionsX{k} - h.EshiftTemp(k);
end
% Create backup of uncorrected PeakRegionsX
h.PeakRegionsXBackup = h.PeakRegionsX;

% Apply correction to current background data
indexUSP = cell(1);
for k = 1:length(h.PeakRegionsXCorr)
    % Find closest point to user selected point
    indexUSP{k} = Tools.Data.DataSetOperations.FindNearestIndex(h.DataTmp{k}(:,1),reshape(h.PeakRegionsXCorr{k},1,numel(h.PeakRegionsXCorr{k})));
end


% Get x and y data in the range of +/- 5 channels of user selected bkg point
indexBKG = cell(1);
xBKG = cell(1);
yBKG = cell(1);
for l = 1:size(h.DataTmp,2)
    for k = 1:length(indexUSP{l})
        indexBKG{l,k} = (indexUSP{l}(k)-5):(indexUSP{l}(k)+5);
        xBKG{l,k} = h.DataTmp{l}((indexUSP{l}(k)-5):(indexUSP{l}(k)+5),1);
        yBKG{l,k} = h.DataTmp{l}((indexUSP{l}(k)-5):(indexUSP{l}(k)+5),2);
    end
end
% Find min of yBKG
indexYmin = cell(1);
for l = 1:size(h.DataTmp,2)
    for k = 1:length(indexUSP{l})
        if all(yBKG{l,k} == 0)
            indexYmin{l,k} = 4;
        else
            indexYmin{l,k} = find(min(yBKG{l,k}(yBKG{l,k}>0)) == yBKG{l,k});
        end
    end
end
% Find and delete duplicate entries
for l = 1:size(h.DataTmp,2)
    for k = 1:length(indexUSP{l})
        if length(indexYmin{l,k}) ~= 1
            indexYmin{l,k} = indexYmin{l,k}(1);
        end
    end
end
% Get index of Ymin
indexYminDataTmp = cell(1);
for l = 1:size(h.DataTmp,2)
    for k = 1:length(indexUSP{l})
        indexYminDataTmp{l,k} = indexBKG{l,k}(indexYmin{l,k}); 
    end
end
% Get x and y data for Ymin and create PeakRegions data X and Y
for l = 1:size(h.DataTmp,2)
    for k = 1:length(indexUSP{l})
        h.PeakRegionsXdata{l,k} = h.DataTmp{l}(indexYminDataTmp{l,k},1);
        h.PeakRegionsYdata{l,k} = h.DataTmp{l}(indexYminDataTmp{l,k},2);
    end
end
% Create PeakregionsX data
for l = 1:size(h.DataTmp,2)
    h.PeakRegionsX{l} = reshape([h.PeakRegionsXdata{l,:}],2,size([h.PeakRegionsXdata{l,:}],2)/2);
end
% Set background table data
set(h.tablebkgdata,'data',h.PeakRegionsX{valueSlider})

% Reset the button color
set(hObj,'str','Apply Correction','backg',col)  % Now reset the button features.

% Messagebox
msgbox('Temperature correction applied.');

% Update guidata from main window
guidata(h.myfig, h);

guidata(hObj, h);

function buttonOkCancelCorr(~, ~, handles)
% Callback for updating user selected background points table
% h = guidata(hObj);
h = handles;

close(h.BackgroundTempCorr)

%% Fitting panel
function buttonselectpeak1(hObj, ~)
% Callback for "Define Peaks" button in fit panel
h = guidata(hObj);

% Set visibility of theoretical line positions off
set(h.checkboxtheopeaks1,'Value',0)
set(h.plotEtheo,'Visible','off')
% Messagebox
k = msgbox('Please add the peaks you want to fit. Confirm by Enter.');
% Wait for user to press ok
uiwait(k);
% Show explanatory text for definitioin of background points
h.textbkg = text('Units','normalized','Position',[0.3 0.95 0],...
    'BackgroundColor',[1 1 1],'EdgeColor', [0 0 0], ...
    'String','Push \textbf{enter} to resume | \textbf{return} to undo',...
    'interpreter','latex','FontSize', 16);

% Get slider value
valueSlider = round(get(h.Slider, 'Value'));

Detstr = get(h.popupmenuselectmeas1,'String');
Detval = get(h.popupmenuselectmeas1,'Value');
Detsel = Detstr{Detval};
h.Detsel = Detsel;

% Interpolate RawData to get YData for PeakRegions after background
% correction
if strcmp(h.Diffsel,'LEDDI')
    if strcmp(h.Detsel,'Detector 1')
        Slidersteps = 2:2:length(h.Measurement);
        h.DataInterpBkgYDet1 = interp1(h.DataTmp{Slidersteps(valueSlider)}(:,1),h.DataTmp{Slidersteps(valueSlider)}(:,2),h.PeakRegionsXDet1{valueSlider});
        % Set new YData of background point plot
        h.plotbkgpointscorr = plot(h.axesplotRawData,h.PeakRegionsXDet1{valueSlider},h.DataInterpBkgYDet1,'o','Color','r','MarkerFaceColor','r','MarkerSize',5);
        % Set YLimit
        h.axesplotRawData.YLim =[-Inf round(max(h.DataTmp{Slidersteps(valueSlider)}(:,2)),-1)];
    elseif strcmp(h.Detsel,'Detector 2')
        Slidersteps = 1:2:length(h.Measurement);
        h.DataInterpBkgYDet2 = interp1(h.DataTmp{Slidersteps(valueSlider)}(:,1),h.DataTmp{Slidersteps(valueSlider)}(:,2),h.PeakRegionsXDet2{valueSlider});
        % Set new YData of background point plot
        h.plotbkgpointscorr = plot(h.axesplotRawData,h.PeakRegionsXDet2{valueSlider},h.DataInterpBkgYDet2,'o','Color','r','MarkerFaceColor','r','MarkerSize',5);
        % Set YLimit
        h.axesplotRawData.YLim =[-Inf round(max(h.DataTmp{Slidersteps(valueSlider)}(:,2)),-1)];
    end
else
    h.DataInterpBkgY = interp1(h.DataTmp{valueSlider}(:,1),h.DataTmp{valueSlider}(:,2),h.PeakRegionsX{valueSlider});
    % Set new YData of background point plot
    h.plotbkgpointscorr = plot(h.axesplotRawData,h.PeakRegionsX{valueSlider},h.DataInterpBkgY,'o','Color','r','MarkerFaceColor','r','MarkerSize',5);
    % Set YLimit
    h.axesplotRawData.YLim =[-Inf Inf];
end

% Get points selected from user
[HT.x,~] = getpts(h.axesplotRawData);

if strcmp(h.Diffsel,'LEDDI')
    % Set peak data
    for l = 1:size(h.DataTmp,2)/2
        h.Peaks{l} = HT.x';
        h.Peakslb{l} = 0.3.*ones(1,size(HT.x,1));
        h.Peaksub{l} = 0.3.*ones(1,size(HT.x,1));
    end
else
    % Set peak data
    for l = 1:size(h.DataTmp,2)
        h.Peaks{l} = HT.x';
        h.Peakslb{l} = 0.3.*ones(1,size(HT.x,1));
        h.Peaksub{l} = 0.3.*ones(1,size(HT.x,1));
    end
end

% Set explanatory text visible off
set(h.textbkg,'Visible','off')

% Set table data
if strcmp(h.Diffsel,'LEDDI')
    if strcmp(h.Detsel,'Detector 1')
        Slidersteps = 2:2:length(h.Measurement);
        h.PeaksDet1 = h.Peaks;
        set(h.tablepeakdata,'data',[h.PeaksDet1{valueSlider};h.Peakslb{valueSlider};h.Peaksub{valueSlider}])
        % Interpolate RawData to get YData for PeakRegions
        h.DataInterpPeaksDet1 = interp1(h.DataTmp{Slidersteps(valueSlider)}(:,1),h.DataTmp{Slidersteps(valueSlider)}(:,2),h.PeaksDet1{valueSlider});
        % Plot of peak positions
        h.plotpeakpoints = plot(h.axesplotRawData,h.PeaksDet1{valueSlider},h.DataInterpPeaksDet1,'d','Color','r','MarkerFaceColor','r','MarkerSize',5);
        % Set plot of bkg points visible off
        set(h.plotbkgpointscorr,'Visible','off')
        % Compare user defined peaks and theoretical peak positons and
        % mark the respective peaks in the phase data table
        PeaksTheo = h.TPeaksDet1.T.Peaks(:,5);
        PeaksTheo = PeaksTheo.*h.FitPeaksLogicalErangeDet1;
        PeaksTheo(PeaksTheo==0) = [];
        TableBkgColor = [1 0.6 0.6];
        TableBkgColorArrayDet1 = repmat(TableBkgColor,size(PeaksTheo,1),1);
        [CompareFitPeaksLogical,MinVal,IndVal,~] = ComparePeaks(h.PeaksDet1,PeaksTheo);
%         assignin('base','CompareFitPeaksLogical',CompareFitPeaksLogical)
        h.MinVal = MinVal;
        h.FitPeaksLogicalDet1 = CompareFitPeaksLogical;
        CompareFitPeaksLogical = double(CompareFitPeaksLogical);
        h.IndValDet1 = IndVal;
        % Repmat of logical vector in order to match size of T.Peaks array
        TableBkgColorArrayDet1 = TableBkgColorArrayDet1.*CompareFitPeaksLogical;
        TableBkgColorArrayDet1(TableBkgColorArrayDet1==0) = 1;
        h.TableBkgColorArrayDet1 = TableBkgColorArrayDet1; 
        set(h.tablephasehkl,'BackgroundColor',h.TableBkgColorArrayDet1)
        % Set hkl table data. Set checkboxes according to user selected peaks.
        tabledata = get(h.tablephasehkl,'data');
        tabledata(1:end,6) = num2cell(logical(CompareFitPeaksLogical(:,1)));
        set(h.tablephasehkl,'data',tabledata)
    elseif strcmp(h.Detsel,'Detector 2')
        Slidersteps = 1:2:length(h.Measurement);
        h.PeaksDet2 = h.Peaks;
        set(h.tablepeakdata,'data',[h.PeaksDet2{valueSlider};h.Peakslb{valueSlider};h.Peaksub{valueSlider}])
        % Interpolate RawData to get YData for PeakRegions
        h.DataInterpPeaksDet2 = interp1(h.DataTmp{Slidersteps(valueSlider)}(:,1),h.DataTmp{Slidersteps(valueSlider)}(:,2),h.PeaksDet2{valueSlider});
        % Plot of peak positions
        h.plotpeakpoints = plot(h.axesplotRawData,h.PeaksDet2{valueSlider},h.DataInterpPeaksDet2,'d','Color','r','MarkerFaceColor','r','MarkerSize',5);
        % Set plot of bkg points visible off
        set(h.plotbkgpointscorr,'Visible','off')
        % Compare user defined peaks and theoretical peak positons and
        % mark the respective peaks in the phase data table 
        PeaksTheo = h.TPeaksDet2.T.Peaks(:,5);
        PeaksTheo = PeaksTheo.*h.FitPeaksLogicalErangeDet2;
        PeaksTheo(PeaksTheo==0) = [];
        TableBkgColor = [1 0.6 0.6];
        TableBkgColorArrayDet2 = repmat(TableBkgColor,size(PeaksTheo,1),1);
        [CompareFitPeaksLogical,MinVal,IndVal,~] = ComparePeaks(h.PeaksDet2,PeaksTheo);
        h.MinVal = MinVal;
        h.FitPeaksLogicalDet2 = CompareFitPeaksLogical;
        CompareFitPeaksLogical = double(CompareFitPeaksLogical);
        h.IndValDet2 = IndVal;
        % Repmat of logical vector in order to match size of T.Peaks array
        TableBkgColorArrayDet2 = TableBkgColorArrayDet2.*CompareFitPeaksLogical;
        TableBkgColorArrayDet2(TableBkgColorArrayDet2==0) = 1;
        h.TableBkgColorArrayDet2 = TableBkgColorArrayDet2;
        set(h.tablephasehkl,'BackgroundColor',h.TableBkgColorArrayDet2)
        % Set hkl table data. Set checkboxes according to user selected peaks.
        tabledata = get(h.tablephasehkl,'data');
        tabledata(1:end,6) = num2cell(logical(CompareFitPeaksLogical(:,1)));
        set(h.tablephasehkl,'data',tabledata)
    end
else
    if isfield(h, 'EshiftTemp')
       % Apply temperature induced energy shift correction
        for k = 1:length(h.PeakRegionsX)
            h.PeaksCorr{k} = h.Peaks{k} - h.EshiftTemp(k);
        end
        h.PeaksBackup = h.Peaks;
        h.Peaks = h.PeaksCorr;
    end
    set(h.tablepeakdata,'data',[h.Peaks{valueSlider};h.Peakslb{valueSlider};h.Peaksub{valueSlider}])
    % Interpolate RawData to get YData for PeakRegions
    h.DataInterpPeaks = interp1(h.DataTmp{valueSlider}(:,1),h.DataTmp{valueSlider}(:,2),h.Peaks{valueSlider});
    % Plot of peak positions
    h.plotpeakpoints = plot(h.axesplotRawData,h.Peaks{valueSlider},h.DataInterpPeaks,'d','Color','r','MarkerFaceColor','r','MarkerSize',5);
    % Set plot of bkg points visible off
    set(h.plotbkgpointscorr,'Visible','off')
    % Compare user defined peaks and theoretical peak positons and
    % mark the respective peaks in the phase data table
    a = h.TPeaks.T.Peaks(:,5) > h.P.EnergyRange(1) & h.TPeaks.T.Peaks(:,5) < h.P.EnergyRange(2);
    PeaksTheo = h.TPeaks.T.Peaks(:,5).*a;
%     h.FitPeaksLogicalErange;
    PeaksTheo(PeaksTheo==0) = [];
    
    TableBkgColor = [1 0.6 0.6];
    TableBkgColorArray = repmat(TableBkgColor,size(PeaksTheo,1),1);
    [CompareFitPeaksLogical,MinVal,IndVal,~] = ComparePeaks(h.Peaks,PeaksTheo);    
    h.FitPeaksLogical = CompareFitPeaksLogical;
    h.MinVal = MinVal;
%     assignin('base','PeaksTheo',PeaksTheo)
%     assignin('base','hPeaks',h.Peaks)
    CompareFitPeaksLogical = double(CompareFitPeaksLogical);
    h.IndVal = IndVal;
    % Repmat of logical vector in order to match size of T.Peaks array
    TableBkgColorArray = TableBkgColorArray.*CompareFitPeaksLogical;
    TableBkgColorArray(TableBkgColorArray==0) = 1;
    h.TableBkgColorArray = TableBkgColorArray;
    set(h.tablephasehkl,'BackgroundColor',TableBkgColorArray)
    % Set hkl table data. Set checkboxes according to user selected peaks.
    tabledata = get(h.tablephasehkl,'data');
    tabledata(1:end,6) = num2cell(logical(CompareFitPeaksLogical(:,1)));
    set(h.tablephasehkl,'data',tabledata)
end
% Messagebox
msgbox('Peak positions created.');

guidata(hObj, h);

function buttonselectpeak2(hObj, ~)
% Callback for "Save File" button in fit panel
h = guidata(hObj);

% Load ULD file
[baseFileName, folder] = uigetfile('*.mat','Save peak positions to (ULD) file',[General.ProgramInfo.Path,'/Data/ULD/']);
BackgroundFileName = fullfile(folder, baseFileName);

ULDDataFile = matfile(BackgroundFileName,'Writable',true);
if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    ULDDataFile.Peaks = h.Peaks;
    ULDDataFile.Peakslb = h.Peakslb;
    ULDDataFile.Peaksub = h.Peaksub;
    ULDDataFile.TableBkgColorArray = h.TableBkgColorArray;
    ULDDataFile.MinVal = h.MinVal;
%     disp('Test')
elseif strcmp(h.Diffsel,'LEDDI')
    if isfield(h, 'PeaksDet1') && ~isfield(h, 'PeaksDet2')
        ULDDataFile.PeaksDet1 = h.PeaksDet1;
        ULDDataFile.Peakslb = h.Peakslb;
        ULDDataFile.Peaksub = h.Peaksub;
        ULDDataFile.MinVal = h.MinVal;
        ULDDataFile.TableBkgColorArrayDet1 = h.TableBkgColorArrayDet1;
    elseif isfield(h, 'PeaksDet2') && ~isfield(h, 'PeaksDet1')
        ULDDataFile.PeaksDet2 = h.PeaksDet2;
        ULDDataFile.Peakslb = h.Peakslb;
        ULDDataFile.Peaksub = h.Peaksub;
        ULDDataFile.MinVal = h.MinVal;
        ULDDataFile.TableBkgColorArrayDet2 = h.TableBkgColorArrayDet2;
                  
    elseif isfield(h, 'PeaksDet1') && isfield(h, 'PeaksDet2')
        ULDDataFile.PeaksDet1 = h.PeaksDet1;
        ULDDataFile.PeaksDet2 = h.PeaksDet2;
        ULDDataFile.Peakslb = h.Peakslb;
        ULDDataFile.Peaksub = h.Peaksub;
        ULDDataFile.MinVal = h.MinVal;
        ULDDataFile.TableBkgColorArrayDet1 = h.TableBkgColorArrayDet1;
        ULDDataFile.TableBkgColorArrayDet2 = h.TableBkgColorArrayDet2;
    end
end
        
% If user pressed cancel, abort saving process
if baseFileName==0
  % user pressed cancel
  return
end

clear ULDDataFile   

msgbox('Peak positions saved to file.');

guidata(hObj, h);

function buttonselectpeak3(hObj, ~)
% Callback for "Fit" button in fit panel
h = guidata(hObj);
% Get value of checkbox "fit data from both detectors"
FitBothDet = get(h.checkboxFitBothDetectors,'value');
% Function to make "Fit" button blink in red during fitting process
col = get(hObj,'backg');  % Get the background color of the figure.
set(hObj,'str','Fitting','backg',[1 .6 .6]) % Change color of button. 
% The pause (or drawnow) is necessary to make button changes appear.
pause(.01)
% Get slider value
valueSlider = round(get(h.Slider, 'Value'));

Detstr = get(h.popupmenuselectmeas1,'String');
Detval = get(h.popupmenuselectmeas1,'Value');
Detsel = Detstr{Detval};
h.Detsel = Detsel;

% Run FittingGUI function in order to fit the user defined peaks. Depending
% on the diffractometer used, different cases need to be considered
if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    % Run fit script
    [Measurement,DataTmp,FittedPeaks,CI,SE] = FittingGUI2(h.Measurement,h.DataTmp,h.PeakRegionsX,h.Peaks,h.Peakslb,h.Peaksub,h.P.PopupValueFitFunc);
    
    % Korrektur Energielage tth9 z-0.3
%     for k = 1:length(Measurement)
%         if round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.00558 - 0.00377.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.1
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.00861 - 0.00359.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.2
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.01164 - 0.00342.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.3
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.01467 - 0.00325.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.4
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.0177 - 0.00307.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.5
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.02073 - 0.0029.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.6
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.02375 - 0.00273.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.7
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.02678 - 0.00255.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.8
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.02981 - 0.00238.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.9
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.03284 - 0.00221.*FittedPeaks{k}(l,2));
%             end
%         end
%     end
    

%     % Korrektur Energielage tth9 z-0.4
%     for k = 1:length(Measurement)
%         if round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.01708 - 0.00527.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.1
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.01816 - 0.00491.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.2
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.01924 - 0.00455.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.3
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.02032 - 0.00419.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.4
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.0214 - 0.00382.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.5
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.02248 - 0.00346.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.6
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.02356 - 0.0031.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.7
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.02464 - 0.00274.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.8
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.02572 - 0.00237.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.9
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.0268 - 0.00201.*FittedPeaks{k}(l,2));
%             end
%         end
%     end
    
%     % Korrektur Energielage tth13 z-0.36
%     for k = 1:length(Measurement)
%         if round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.00688 - 0.00279.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.1
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.0073 - 0.00254.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.2
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.00771 - 0.00228.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.3
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.00812 - 0.00202.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.4
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.0853 - 0.00176.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.5
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.00895 - 0.00151.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.6
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.00936 - 0.00125.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.7
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.00977 -9.89753e-4.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.8
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.01018 - 7.31935e-4.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.9
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.01059 - 4.74118e-4.*FittedPeaks{k}(l,2));
%             end
%         end
%     end

%     % Korrektur Energielage tth13 z-0.42
%     for k = 1:length(Measurement)
%         if round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.0146 - 0.00338.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.1
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.01684 - 0.00315.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.2
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.01908 - 0.00292.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.3
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.02132 - 0.00269.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.4
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.02356 - 0.00246.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.5
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.0258 - 0.00223.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.6
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.02804 - 0.002.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.7
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.03028 - 0.00177.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.8
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.03252 - 0.00154.*FittedPeaks{k}(l,2));
%             end
%         elseif round(sind(Measurement(k).SCSAngles.psi)^2,1) == 0.9
%             for l = 1:size(FittedPeaks{k},1)
%                 FittedPeaks{k}(l,2) = FittedPeaks{k}(l,2) - (0.03476 - 0.00131.*FittedPeaks{k}(l,2));
%             end
%         end
%     end


    
    % Set and update handle variables
    h.Measurement = Measurement;
    h.DataTmp = DataTmp;
    h.FittedPeaks = FittedPeaks;
    % Find nan in SE and CI and replace with zero
    idx = cellfun(@isnan, SE,'UniformOutput',false);
    for k = 1:length(SE)
        SE{1,k}(idx{1,k}) = 0;
        CI{1,k}(idx{1,k}) = 0;
    end
    % Set handle data
    h.SE = SE;
    h.CI = CI;
elseif strcmp(h.Diffsel,'LEDDI') && FitBothDet == 0
        if strcmp(h.Detsel,'Detector 1')
            % Consider the following spectra
            Slidersteps = 2:2:length(h.Measurement);
            % Run fit script
            [Measurement,DataTmp,FittedPeaks,CI,SE] = FittingGUI2(h.Measurement(Slidersteps),h.DataTmp(Slidersteps),h.PeakRegionsXDet1,h.PeaksDet1,h.Peakslb,h.Peaksub,h.P.PopupValueFitFunc);
            % Update Measurement and Datatmp
            for c = 1:length(DataTmp)
                h.DataTmp{Slidersteps(c)} = DataTmp{c};
                h.Measurement(Slidersteps(c)) = Measurement(c);
            end
            % Create handle for fitted peak data
            h.FittedPeaksDet1 = FittedPeaks;
            % Find nan in SE and replace with zero
            idx = cellfun(@isnan, SE,'UniformOutput',false);
            for k = 1:length(SE)
                SE{1,k}(idx{1,k}) = 0;
                CI{1,k}(idx{1,k}) = 0;
            end
            h.CIDet1 = CI;
            h.SEDet1 = SE;
        elseif strcmp(h.Detsel,'Detector 2')
            Slidersteps = 1:2:length(h.Measurement);
            [Measurement,DataTmp,FittedPeaks,CI,SE] = FittingGUI2(h.Measurement(Slidersteps),h.DataTmp(Slidersteps),h.PeakRegionsXDet2,h.PeaksDet2,h.Peakslb,h.Peaksub,h.P.PopupValueFitFunc);
            % Update Measurement and Datatmp
            for c = 1:length(DataTmp)
                h.DataTmp{Slidersteps(c)} = DataTmp{c};
                h.Measurement(Slidersteps(c)) = Measurement(c);
            end
            h.FittedPeaksDet2 = FittedPeaks;
            % Find nan in SE and replace with zero
            idx = cellfun(@isnan, SE,'UniformOutput',false);
            for k = 1:length(SE)
                SE{1,k}(idx{1,k}) = 0;
                CI{1,k}(idx{1,k}) = 0;
            end
            h.CIDet2 = CI;
            h.SEDet2 = SE;
        end
elseif strcmp(h.Diffsel,'LEDDI') && FitBothDet == 1
            % Here, no case analysis is done, the data from both detectors
            % is fitted directly one after the other
            Slidersteps = 2:2:length(h.Measurement);
            [Measurement,DataTmp,FittedPeaks,CI,SE] = FittingGUI2(h.Measurement(Slidersteps),h.DataTmp(Slidersteps),h.PeakRegionsXDet1,h.PeaksDet1,h.Peakslb,h.Peaksub,h.P.PopupValueFitFunc);
            % Update Measurement and Datatmp
            for c = 1:length(DataTmp)
                h.DataTmp{Slidersteps(c)} = DataTmp{c};
                h.Measurement(Slidersteps(c)) = Measurement(c);
            end
            h.FittedPeaksDet1 = FittedPeaks;
            % Find nan in SE and replace with zero
            idx = cellfun(@isnan, SE,'UniformOutput',false);
            for k = 1:length(SE)
                SE{1,k}(idx{1,k}) = 0;
                CI{1,k}(idx{1,k}) = 0;
            end
            h.CIDet1 = CI;
            h.SEDet1 = SE;

            Slidersteps = 1:2:length(h.Measurement);
            [Measurement,DataTmp,FittedPeaks,CI,SE] = FittingGUI2(h.Measurement(Slidersteps),h.DataTmp(Slidersteps),h.PeakRegionsXDet2,h.PeaksDet2,h.Peakslb,h.Peaksub,h.P.PopupValueFitFunc);
            % Update Measurement and Datatmp
            for c = 1:length(DataTmp)
                h.DataTmp{Slidersteps(c)} = DataTmp{c};
                h.Measurement(Slidersteps(c)) = Measurement(c);
            end
            h.FittedPeaksDet2 = FittedPeaks;
            % Find nan in SE and replace with zero
            idx = cellfun(@isnan, SE,'UniformOutput',false);
            for k = 1:length(SE)
                SE{1,k}(idx{1,k}) = 0;
                CI{1,k}(idx{1,k}) = 0;
            end
            h.CIDet2 = CI;
            h.SEDet2 = SE;
end


% Reset the button color
set(hObj,'str','Fit','backg',col)  % Now reset the button features.

% Prepare plot of fitted data
set(h.plotpeakpoints,'Visible','off')
if FitBothDet == 0
    % Prepare data for plotting fit results
    if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
        DataTmpCalc = DataTmp;
        FittedPeaksCalc = FittedPeaks;
        PeakRegionsXCalc = h.PeakRegionsX;
        PeaksCalc = h.Peaks;
    elseif strcmp(h.Diffsel,'LEDDI')
        if strcmp(h.Detsel,'Detector 1')
            Slidersteps = 2:2:length(h.Measurement);
            DataTmpCalc = h.DataTmp(Slidersteps);
            FittedPeaksCalc = h.FittedPeaksDet1;
            PeakRegionsXCalc = h.PeakRegionsXDet1;
            PeaksCalc = h.PeaksDet1;
        elseif strcmp(h.Detsel,'Detector 2')
            Slidersteps = 1:2:length(h.Measurement);
            DataTmpCalc = h.DataTmp(Slidersteps);
            FittedPeaksCalc = h.FittedPeaksDet2;
            PeakRegionsXCalc = h.PeakRegionsXDet2;
            PeaksCalc = h.PeaksDet2;
        end
    end
%     assignin('base','FittedPeaksCalc',FittedPeaksCalc)
%     assignin('base','DataTmpCalc',DataTmpCalc)
    % Run script to prepare the plot data
    [FittedPeaksCalc,FittedPeaksCalctmp,xDataTmpCalc,XFit,YFit,XPlot,YPlot] = PrepareFitPeaksPlot(DataTmpCalc,FittedPeaksCalc,PeaksCalc,PeakRegionsXCalc,SE,h.P.PopupValueFitFunc,valueSlider);
    
    % Add plots of fitted peaks to axes
    h.plotfits = plot(h.axesplotRawData, XPlot, YPlot,'Color','red','LineWidth',1.5);
    h.plotfitresidual = plot(h.axesplotRawData,XFit,(YFit - interp1(XPlot,YPlot,XFit)) - (max(YFit) /4),'Color','k','LineWidth',0.5);
    % Change YLim
    h.axesplotRawData.YLim =[-Inf round(max(DataTmpCalc{valueSlider}(:,2)),-1)];

    % Set table data
    if h.P.PopupValueFitFunc == 2 %PV-Func
        set(h.tablefitresults,'data',[FittedPeaksCalctmp{1,valueSlider}(:,7), FittedPeaksCalctmp{1,valueSlider}(:,1),...
            FittedPeaksCalctmp{1,valueSlider}(:,2),FittedPeaksCalctmp{1,valueSlider}(:,3),...
            FittedPeaksCalctmp{1,valueSlider}(:,5),FittedPeaksCalctmp{1,valueSlider}(:,6),...
            FittedPeaksCalctmp{1,valueSlider}(:,4)])
    elseif h.P.PopupValueFitFunc == 3 %TCH-Func
        set(h.tablefitresults,'data',[FittedPeaksCalctmp{1,valueSlider}(:,1), FittedPeaksCalctmp{1,valueSlider}(:,9),...
            FittedPeaksCalctmp{1,valueSlider}(:,2),FittedPeaksCalctmp{1,valueSlider}(:,3),...
            FittedPeaksCalctmp{1,valueSlider}(:,4),FittedPeaksCalctmp{1,valueSlider}(:,5),...
            FittedPeaksCalctmp{1,valueSlider}(:,6),FittedPeaksCalctmp{1,valueSlider}(:,7),...
            FittedPeaksCalctmp{1,valueSlider}(:,8)])
    elseif h.P.PopupValueFitFunc == 4 %Gauss
        set(h.tablefitresults,'data',[FittedPeaksCalctmp{1,valueSlider}(:,6), FittedPeaksCalctmp{1,valueSlider}(:,1),...
            FittedPeaksCalctmp{1,valueSlider}(:,2),FittedPeaksCalctmp{1,valueSlider}(:,3),...
            FittedPeaksCalctmp{1,valueSlider}(:,4),FittedPeaksCalctmp{1,valueSlider}(:,5)])
    elseif h.P.PopupValueFitFunc == 5 %Lorentz
        set(h.tablefitresults,'data',[FittedPeaksCalctmp{1,valueSlider}(:,6), FittedPeaksCalctmp{1,valueSlider}(:,1),...
            FittedPeaksCalctmp{1,valueSlider}(:,2),FittedPeaksCalctmp{1,valueSlider}(:,3),...
            FittedPeaksCalctmp{1,valueSlider}(:,4),FittedPeaksCalctmp{1,valueSlider}(:,5)])
    end

    if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
        h.xDataTmpCalc = xDataTmpCalc;
%         checkboxCorrEPos = get(h.checkboxcorrEpos1,'Value');
%         if checkboxCorrEPos == 1
%             % Energiekorrektur
%             deltaE = zeros(1,1);
%             for k = 1:length(h.Measurement)
% %                     deltaE(k) = 0.00462 - 0.05749.*sind(h.Measurement(k).SCSAngles.psi).^2 + 0.01208.*(sind(h.Measurement(k).SCSAngles.psi).^2).^2;
% %                     deltaE(k) = -0.00138 + 0.03581.*sind(h.Measurement(k).SCSAngles.psi).^2;
%                     deltaE(k) = 0.00228 + 0.04258.*sind(h.Measurement(k).SCSAngles.psi).^2;
%             end
% 
%             for k = 1:length(h.Measurement)
%                 FittedPeaksCalc{k}(:,2) = FittedPeaksCalc{k}(:,2) - deltaE(k);
%             end
%         end
        h.FittedPeaks = FittedPeaksCalc;
        h.FittedPeaksCalctmp = FittedPeaksCalctmp;
        h.XFit = XFit;
        h.YFit = YFit;
        h.XPlot = XPlot;
        h.YPlot = YPlot;
%         assignin('base','FittedPeaks',FittedPeaksCalc)
    elseif strcmp(h.Diffsel,'LEDDI')
        if strcmp(h.Detsel,'Detector 1')
            Slidersteps = 2:2:length(h.Measurement);
            h.xDataTmpCalcDet1 = xDataTmpCalc;
            h.FittedPeaksDet1 = FittedPeaksCalc;
            h.FittedPeaksCalctmpDet1 = FittedPeaksCalctmp;
            h.XFitDet1 = XFit;
            h.YFitDet1 = YFit;
            h.XPlotDet1 = XPlot;
            h.YPlotDet1 = YPlot;
%             assignin('base','FittedPeaksDet1',FittedPeaksCalc)
        elseif strcmp(h.Detsel,'Detector 2')
            Slidersteps = 1:2:length(h.Measurement);
            h.xDataTmpCalcDet2 = xDataTmpCalc;
            h.FittedPeaksDet2 = FittedPeaksCalc;
            h.FittedPeaksCalctmpDet2 = FittedPeaksCalctmp;
            h.XFitDet2 = XFit;
            h.YFitDet2 = YFit;
            h.XPlotDet2 = XPlot;
            h.YPlotDet2 = YPlot;
%             assignin('base','FittedPeaksDet2',FittedPeaksCalc)
        end
    end
elseif strcmp(h.Diffsel,'LEDDI') && FitBothDet == 1
    % Fit data from both detectors at once
    SliderstepsDet1 = 2:2:length(h.Measurement);
    DataTmpCalcDet1 = h.DataTmp(SliderstepsDet1);
    FittedPeaksCalcDet1 = h.FittedPeaksDet1;
    PeakRegionsXCalcDet1 = h.PeakRegionsXDet1;
    PeaksCalcDet1 = h.PeaksDet1;

    SliderstepsDet2 = 1:2:length(h.Measurement);
    DataTmpCalcDet2 = h.DataTmp(SliderstepsDet2);
    FittedPeaksCalcDet2 = h.FittedPeaksDet2;
    PeakRegionsXCalcDet2 = h.PeakRegionsXDet2;
    PeaksCalcDet2 = h.PeaksDet2;
    % Run script to prepare the plot data
    [FittedPeaksCalcDet1,FittedPeaksCalctmpDet1,xDataTmpCalcDet1,XFitDet1,YFitDet1,XPlotDet1,YPlotDet1] = PrepareFitPeaksPlot(DataTmpCalcDet1,FittedPeaksCalcDet1,PeaksCalcDet1,PeakRegionsXCalcDet1,h.SEDet1,h.P.PopupValueFitFunc,valueSlider);
    
    h.FittedPeaksDet1 = FittedPeaksCalcDet1;
    h.FittedPeaksCalctmpDet1 = FittedPeaksCalctmpDet1;
    h.xDataTmpCalcDet1 = xDataTmpCalcDet1;
    h.XFitDet1 = XFitDet1;
    h.YFitDet1 = YFitDet1;
    h.XPlotDet1 = XPlotDet1;
    h.YPlotDet1 = YPlotDet1;
    
    % Run script to prepare the plot data
    [FittedPeaksCalcDet2,FittedPeaksCalctmpDet2,xDataTmpCalcDet2,XFitDet2,YFitDet2,XPlotDet2,YPlotDet2] = PrepareFitPeaksPlot(DataTmpCalcDet2,FittedPeaksCalcDet2,PeaksCalcDet2,PeakRegionsXCalcDet2,h.SEDet2,h.P.PopupValueFitFunc,valueSlider);

    h.FittedPeaksDet2 = FittedPeaksCalcDet2;
    h.FittedPeaksCalctmpDet2 = FittedPeaksCalctmpDet2;
    h.xDataTmpCalcDet2 = xDataTmpCalcDet2;
    h.XFitDet2 = XFitDet2;
    h.YFitDet2 = YFitDet2;
    h.XPlotDet2 = XPlotDet2;
    h.YPlotDet2 = YPlotDet2;
    
    % Add plots of fitted peaks to axes
    if strcmp(h.Detsel,'Detector 1')
        h.plotfits = plot(h.axesplotRawData, XPlotDet1, YPlotDet1,'Color','red','LineWidth',1.5);
        h.plotfitresidual = plot(h.axesplotRawData,XFitDet1,(YFitDet1 - interp1(XPlotDet1,YPlotDet1,XFitDet1)) - (max(YFitDet1) /4),'Color','k','LineWidth',0.5);
        % Change YLim
        h.axesplotRawData.YLim =[-Inf round(max(DataTmpCalcDet1{valueSlider}(:,2)),-1)];
        % Set table data
        if h.P.PopupValueFitFunc == 2 %PV-Func
            set(h.tablefitresults,'data',[FittedPeaksCalctmpDet1{1,valueSlider}(:,7), FittedPeaksCalctmpDet1{1,valueSlider}(:,1),...
                FittedPeaksCalctmpDet1{1,valueSlider}(:,2),FittedPeaksCalctmpDet1{1,valueSlider}(:,3),...
                FittedPeaksCalctmpDet1{1,valueSlider}(:,5),FittedPeaksCalctmpDet1{1,valueSlider}(:,6),...
                FittedPeaksCalctmpDet1{1,valueSlider}(:,4)])
        elseif h.P.PopupValueFitFunc == 3 %TCH-Func
            set(h.tablefitresults,'data',[FittedPeaksCalctmpDet1{1,valueSlider}(:,1), FittedPeaksCalctmpDet1{1,valueSlider}(:,9),...
                FittedPeaksCalctmpDet1{1,valueSlider}(:,2),FittedPeaksCalctmpDet1{1,valueSlider}(:,3),...
                FittedPeaksCalctmpDet1{1,valueSlider}(:,4),FittedPeaksCalctmpDet1{1,valueSlider}(:,5),...
                FittedPeaksCalctmpDet1{1,valueSlider}(:,6),FittedPeaksCalctmpDet1{1,valueSlider}(:,7),...
                FittedPeaksCalctmpDet1{1,valueSlider}(:,8)])
        elseif h.P.PopupValueFitFunc == 4 %Gauss
            set(h.tablefitresults,'data',[FittedPeaksCalctmpDet1{1,valueSlider}(:,6), FittedPeaksCalctmpDet1{1,valueSlider}(:,1),...
                FittedPeaksCalctmpDet1{1,valueSlider}(:,2),FittedPeaksCalctmpDet1{1,valueSlider}(:,3),...
                FittedPeaksCalctmpDet1{1,valueSlider}(:,4),FittedPeaksCalctmpDet1{1,valueSlider}(:,5)])
        elseif h.P.PopupValueFitFunc == 5 %Lorentz
            set(h.tablefitresults,'data',[FittedPeaksCalctmpDet1{1,valueSlider}(:,6), FittedPeaksCalctmpDet1{1,valueSlider}(:,1),...
                FittedPeaksCalctmpDet1{1,valueSlider}(:,2),FittedPeaksCalctmpDet1{1,valueSlider}(:,3),...
                FittedPeaksCalctmpDet1{1,valueSlider}(:,4),FittedPeaksCalctmpDet1{1,valueSlider}(:,5)])
        end
    elseif strcmp(h.Detsel,'Detector 2')
        h.plotfits = plot(h.axesplotRawData, XPlotDet2, YPlotDet2,'Color','red','LineWidth',1.5);
        h.plotfitresidual = plot(h.axesplotRawData,XFitDet2,(YFitDet2 - interp1(XPlotDet2,YPlotDet2,XFitDet2)) - (max(YFitDet2) /4),'Color','k','LineWidth',0.5);
        % Change YLim
        h.axesplotRawData.YLim =[-Inf round(max(DataTmpCalcDet2{valueSlider}(:,2)),-1)];
        % Set table data
        if h.P.PopupValueFitFunc == 2 %PV-Func
            set(h.tablefitresults,'data',[FittedPeaksCalctmpDet2{1,valueSlider}(:,7), FittedPeaksCalctmpDet2{1,valueSlider}(:,1),...
                FittedPeaksCalctmpDet2{1,valueSlider}(:,2),FittedPeaksCalctmpDet2{1,valueSlider}(:,3),...
                FittedPeaksCalctmpDet2{1,valueSlider}(:,5),FittedPeaksCalctmpDet2{1,valueSlider}(:,6),...
                FittedPeaksCalctmpDet2{1,valueSlider}(:,4)])
        elseif h.P.PopupValueFitFunc == 3 %TCH-Func
            set(h.tablefitresults,'data',[FittedPeaksCalctmpDet2{1,valueSlider}(:,1), FittedPeaksCalctmpDet2{1,valueSlider}(:,9),...
                FittedPeaksCalctmpDet2{1,valueSlider}(:,2),FittedPeaksCalctmpDet2{1,valueSlider}(:,3),...
                FittedPeaksCalctmpDet2{1,valueSlider}(:,4),FittedPeaksCalctmpDet2{1,valueSlider}(:,5),...
                FittedPeaksCalctmpDet2{1,valueSlider}(:,6),FittedPeaksCalctmpDet2{1,valueSlider}(:,7),...
                FittedPeaksCalctmpDet2{1,valueSlider}(:,8)])
        elseif h.P.PopupValueFitFunc == 4 %Gauss
            set(h.tablefitresults,'data',[FittedPeaksCalctmpDet2{1,valueSlider}(:,6), FittedPeaksCalctmpDet2{1,valueSlider}(:,1),...
                FittedPeaksCalctmpDet2{1,valueSlider}(:,2),FittedPeaksCalctmpDet2{1,valueSlider}(:,3),...
                FittedPeaksCalctmpDet2{1,valueSlider}(:,4),FittedPeaksCalctmpDet2{1,valueSlider}(:,5)])
        elseif h.P.PopupValueFitFunc == 5 %Lorentz
            set(h.tablefitresults,'data',[FittedPeaksCalctmpDet2{1,valueSlider}(:,6), FittedPeaksCalctmpDet2{1,valueSlider}(:,1),...
                FittedPeaksCalctmpDet2{1,valueSlider}(:,2),FittedPeaksCalctmpDet2{1,valueSlider}(:,3),...
                FittedPeaksCalctmpDet2{1,valueSlider}(:,4),FittedPeaksCalctmpDet2{1,valueSlider}(:,5)])
        end
    end
end
 

% Prepare data for export
if get(h.checkboxexportfits,'value') == 1
    if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
        for k = 1:size(FittedPeaksCalc, 2)
            XFitExport{k} = DataTmpCalc{k}(:, 1);
            YFitExport{k} = DataTmpCalc{k}(:, 2);
        end

        YPlotExport = cell(size(XFitExport));

        for l = 1:size(FittedPeaksCalc, 2)
            for d = 1:size(FittedPeaksCalc{l}, 1)
                if h.P.PopupValueFitFunc == 2 %PV-Func
                    SinglePlot = Tools.Science.Math.FF_PseudoVoigt(XFitExport{l}, FittedPeaksCalc{l}(d, 1), FittedPeaksCalc{l}(d, 2), FittedPeaksCalc{l}(d, 3),FittedPeaksCalc{l}(d, 4));
                elseif h.P.PopupValueFitFunc == 3 %TCH
                    SinglePlot = Tools.Science.Math.FF_TCH(XFitExport{l}, FittedPeaksCalc{l}(d, 1), FittedPeaksCalc{l}(d, 2), FittedPeaksCalc{l}(d, 3),FittedPeaksCalc{l}(d, 4));
                elseif h.P.PopupValueFitFunc == 4 %Gauss-Func
                    SinglePlot = Tools.Science.Math.FF_Gauss(XFitExport{l}, FittedPeaksCalc{l}(d, 1), FittedPeaksCalc{l}(d, 2), FittedPeaksCalc{l}(d, 3));
                elseif h.P.PopupValueFitFunc == 5 %Lorentz-Func
                    SinglePlot = Tools.Science.Math.FF_Lorentz(XFitExport{l}, FittedPeaksCalc{l}(d, 1), FittedPeaksCalc{l}(d, 2), FittedPeaksCalc{l}(d, 3));
                end
                YPlotExport{l} = SinglePlot;
            end
        end

        for l = 1:size(FittedPeaksCalc, 2)
            FitResidual{l} = (YFitExport{l} - interp1(XFitExport{l},YPlotExport{l},XFitExport{l})) - (max(YFitExport{l}) /4);
        end

        formatOut = 'ddmmyyyy';
        d = datestr(now, formatOut);
        name = strtrim(h.Measurement(1).MeasurementSeries);
        Folder = '\FittedSpectra\';
        Path = fullfile(h.PathName,Folder);
        
        if exist(Path,'dir') ~= 7
            mkdir(Path);
        end

        for k = 1:size(FittedPeaksCalc, 2)
            fid = fopen([[Path,'\'],name,'_','FittedSpectra','_',num2str(k),'_',d,'.dat'],'w');
            fprintf(fid,'%6s %8s %11s %10s \r\n','X','Y','YFit','Residual');
                fprintf(fid,'%.6f %.6f %.6f %.6f \n',[XFitExport{k} YFitExport{k} YPlotExport{k} FitResidual{k}]');
                fprintf(fid,'\n');
            fclose(fid);
        end
    elseif strcmp(h.Diffsel,'LEDDI') && FitBothDet == 0
        if strcmp(h.Detsel,'Detector 1')
            Slidersteps = 2:2:length(h.Measurement);
            DataTmpCalc = h.DataTmp(Slidersteps);
            FittedPeaksCalc = h.FittedPeaksDet1;
            
            for k = 1:size(FittedPeaksCalc, 2)
                XFitExport(:,k) = DataTmpCalc{k}(:, 1);
                YFitExport(:,k) = DataTmpCalc{k}(:, 2);
            end

        YPlotExport = zeros(size(XFitExport));
        
        for l = 1:size(FittedPeaksCalc, 2)
            for d = 1:size(FittedPeaksCalc{l}, 1)
                if h.P.PopupValueFitFunc == 2 %PV-Func
                    SinglePlot = Tools.Science.Math.FF_PseudoVoigt(XFitExport(:,l), FittedPeaksCalc{l}(d, 1), FittedPeaksCalc{l}(d, 2), FittedPeaksCalc{l}(d, 3),FittedPeaksCalc{l}(d, 4));
                elseif h.P.PopupValueFitFunc == 3 %TCH
                    SinglePlot = Tools.Science.Math.FF_TCH(XFitExport(:,l), FittedPeaksCalc{l}(d, 1), FittedPeaksCalc{l}(d, 2), FittedPeaksCalc{l}(d, 3),FittedPeaksCalc{l}(d, 4));
                elseif h.P.PopupValueFitFunc == 4 %Gauss-Func
                    SinglePlot = Tools.Science.Math.FF_Gauss(XFitExport(:,l), FittedPeaksCalc{l}(d, 1), FittedPeaksCalc{l}(d, 2), FittedPeaksCalc{l}(d, 3));
                elseif h.P.PopupValueFitFunc == 5 %Lorentz-Func
                    SinglePlot = Tools.Science.Math.FF_Lorentz(XFitExport(:,l), FittedPeaksCalc{l}(d, 1), FittedPeaksCalc{l}(d, 2), FittedPeaksCalc{l}(d, 3));
                end
                YPlotExport(:,l) = YPlotExport(:,l) + SinglePlot;
            end
        end

        for l = 1:size(FittedPeaksCalc, 2)
            FitResidual(:,l) = (YFitExport(:,l) - interp1(XFitExport(:,l),YPlotExport(:,l),XFitExport(:,l))) - (max(YFitExport(:,l)) /4);
        end

        formatOut = 'ddmmyyyy';
        d = datestr(now, formatOut);
        name = strtrim(h.Measurement(1).MeasurementSeries);
        Folder = '\FittedSpectra\';
        Path = fullfile(h.PathName,Folder);

        if exist(Path,'dir') ~= 7
            mkdir(Path);
        end
        
        for k = 1:size(FittedPeaksCalc, 2)
            fid = fopen([[Path,'\'],name,'_','FittedSpectra_Det1','_',num2str(k),'_',d,'.dat'],'w');
            fprintf(fid,'%6s %8s %11s %10s \r\n','X','Y','YFit','Residual');
                fprintf(fid,'%.6f %.6f %.6f %.6f \n',[XFitExport(:,k) YFitExport(:,k) YPlotExport(:,k) FitResidual(:,k)]');
                fprintf(fid,'\n');
            fclose(fid);
        end
        
        elseif strcmp(h.Detsel,'Detector 2')
            Slidersteps = 1:2:length(h.Measurement);
            DataTmpCalc = h.DataTmp(Slidersteps);
            FittedPeaksCalc = h.FittedPeaksDet2;
            
            for k = 1:size(FittedPeaksCalc, 2)
                XFitExport(:,k) = DataTmpCalc{k}(:, 1);
                YFitExport(:,k) = DataTmpCalc{k}(:, 2);
            end

            YPlotExport = zeros(size(XFitExport));

            for l = 1:size(FittedPeaksCalc, 2)
                for d = 1:size(FittedPeaksCalc{l}, 1)
                    if h.P.PopupValueFitFunc == 2 %PV-Func
                        SinglePlot = Tools.Science.Math.FF_PseudoVoigt(XFitExport(:,l), FittedPeaksCalc{l}(d, 1), FittedPeaksCalc{l}(d, 2), FittedPeaksCalc{l}(d, 3),FittedPeaksCalc{l}(d, 4));
                    elseif h.P.PopupValueFitFunc == 3 %TCH
                        SinglePlot = Tools.Science.Math.FF_TCH(XFitExport(:,l), FittedPeaksCalc{l}(d, 1), FittedPeaksCalc{l}(d, 2), FittedPeaksCalc{l}(d, 3),FittedPeaksCalc{l}(d, 4));
                    elseif h.P.PopupValueFitFunc == 4 %Gauss-Func
                        SinglePlot = Tools.Science.Math.FF_Gauss(XFitExport(:,l), FittedPeaksCalc{l}(d, 1), FittedPeaksCalc{l}(d, 2), FittedPeaksCalc{l}(d, 3));
                    elseif h.P.PopupValueFitFunc == 5 %Lorentz-Func
                        SinglePlot = Tools.Science.Math.FF_Lorentz(XFitExport(:,l), FittedPeaksCalc{l}(d, 1), FittedPeaksCalc{l}(d, 2), FittedPeaksCalc{l}(d, 3));
                    end
                    YPlotExport(:,l) = YPlotExport(:,l) + SinglePlot;
                end
            end

            for l = 1:size(FittedPeaksCalc, 2)
                FitResidual(:,l) = (YFitExport(:,l) - interp1(XFitExport(:,l),YPlotExport(:,l),XFitExport(:,l))) - (max(YFitExport(:,l)) /4);
            end

            formatOut = 'ddmmyyyy';
            d = datestr(now, formatOut);
            name = strtrim(h.Measurement(1).MeasurementSeries);
            Folder = '\FittedSpectra\';
            Path = fullfile(h.PathName,Folder);

            if exist(Path,'dir') ~= 7
                mkdir(Path);
            end
            
            for k = 1:size(FittedPeaksCalc, 2)
                fid = fopen([[Path,'\'],name,'_','FittedSpectra_Det2','_',num2str(k),'_',d,'.dat'],'w');
                fprintf(fid,'%6s %8s %11s %10s \r\n','X','Y','YFit','Residual');
                    fprintf(fid,'%.6f %.6f %.6f %.6f \n',[XFitExport(:,k) YFitExport(:,k) YPlotExport(:,k) FitResidual(:,k)]');
                    fprintf(fid,'\n');
                fclose(fid);
            end
        end
        
    elseif strcmp(h.Diffsel,'LEDDI') && FitBothDet == 1
            SliderstepsDet1 = 2:2:length(h.Measurement);
            DataTmpCalcDet1 = h.DataTmp(SliderstepsDet1);
            FittedPeaksCalcDet1 = h.FittedPeaksDet1;
            
            SliderstepsDet2 = 1:2:length(h.Measurement);
            DataTmpCalcDet2 = h.DataTmp(SliderstepsDet2);
            FittedPeaksCalcDet2 = h.FittedPeaksDet2;
            
            for k = 1:size(FittedPeaksCalcDet1, 2)
                XFitExportDet1(:,k) = DataTmpCalcDet1{k}(:, 1);
                YFitExportDet1(:,k) = DataTmpCalcDet1{k}(:, 2);
            end
            
            for k = 1:size(FittedPeaksCalcDet2, 2)
                XFitExportDet2(:,k) = DataTmpCalcDet2{k}(:, 1);
                YFitExportDet2(:,k) = DataTmpCalcDet2{k}(:, 2);
            end

            YPlotExportDet1 = zeros(size(XFitExportDet1));
            YPlotExportDet2 = zeros(size(XFitExportDet2));
                       
            for l = 1:size(FittedPeaksCalcDet1, 2)
                for d = 1:size(FittedPeaksCalcDet1{l}, 1)
                    if h.P.PopupValueFitFunc == 2 %PV-Func
                        SinglePlot = Tools.Science.Math.FF_PseudoVoigt(XFitExportDet1(:,l), FittedPeaksCalcDet1{l}(d, 1), FittedPeaksCalcDet1{l}(d, 2), FittedPeaksCalcDet1{l}(d, 3),FittedPeaksCalcDet1{l}(d, 4));
                    elseif h.P.PopupValueFitFunc == 3 %TCH
                        SinglePlot = Tools.Science.Math.FF_TCH(XFitExportDet1(:,l), FittedPeaksCalcDet1{l}(d, 1), FittedPeaksCalcDet1{l}(d, 2), FittedPeaksCalcDet1{l}(d, 3),FittedPeaksCalcDet1{l}(d, 4));
                    elseif h.P.PopupValueFitFunc == 4 %Gauss-Func
                        SinglePlot = Tools.Science.Math.FF_Gauss(XFitExportDet1(:,l), FittedPeaksCalcDet1{l}(d, 1), FittedPeaksCalcDet1{l}(d, 2), FittedPeaksCalcDet1{l}(d, 3));
                    elseif h.P.PopupValueFitFunc == 5 %Lorentz-Func
                        SinglePlot = Tools.Science.Math.FF_Lorentz(XFitExportDet1(:,l), FittedPeaksCalcDet1{l}(d, 1), FittedPeaksCalcDet1{l}(d, 2), FittedPeaksCalcDet1{l}(d, 3));
                    end
                    YPlotExportDet1(:,l) = YPlotExportDet1(:,l) + SinglePlot;
                end
            end
            
            for l = 1:size(FittedPeaksCalcDet2, 2)
                for d = 1:size(FittedPeaksCalcDet2{l}, 1)
                    if h.P.PopupValueFitFunc == 2 %PV-Func
                        SinglePlot = Tools.Science.Math.FF_PseudoVoigt(XFitExportDet2(:,l), FittedPeaksCalcDet2{l}(d, 1), FittedPeaksCalcDet2{l}(d, 2), FittedPeaksCalcDet2{l}(d, 3),FittedPeaksCalcDet2{l}(d, 4));
                    elseif h.P.PopupValueFitFunc == 3 %TCH
                        SinglePlot = Tools.Science.Math.FF_TCH(XFitExportDet2(:,l), FittedPeaksCalcDet2{l}(d, 1), FittedPeaksCalcDet2{l}(d, 2), FittedPeaksCalcDet2{l}(d, 3),FittedPeaksCalcDet2{l}(d, 4));
                    elseif h.P.PopupValueFitFunc == 4 %Gauss-Func
                        SinglePlot = Tools.Science.Math.FF_Gauss(XFitExportDet2(:,l), FittedPeaksCalcDet2{l}(d, 1), FittedPeaksCalcDet2{l}(d, 2), FittedPeaksCalcDet2{l}(d, 3));
                    elseif h.P.PopupValueFitFunc == 5 %Lorentz-Func
                        SinglePlot = Tools.Science.Math.FF_Lorentz(XFitExportDet2(:,l), FittedPeaksCalcDet2{l}(d, 1), FittedPeaksCalcDet2{l}(d, 2), FittedPeaksCalcDet2{l}(d, 3));
                    end
                    YPlotExportDet2(:,l) = YPlotExportDet2(:,l) + SinglePlot;
                end
            end

            for l = 1:size(FittedPeaksCalcDet1, 2)
                FitResidualDet1(:,l) = (YFitExportDet1(:,l) - interp1(XFitExportDet1(:,l),YPlotExportDet1(:,l),XFitExportDet1(:,l))) - (max(YFitExportDet1(:,l)) /4);
            end
            
            for l = 1:size(FittedPeaksCalcDet2, 2)
                FitResidualDet2(:,l) = (YFitExportDet2(:,l) - interp1(XFitExportDet2(:,l),YPlotExportDet2(:,l),XFitExportDet2(:,l))) - (max(YFitExportDet2(:,l)) /4);
            end
            
            formatOut = 'ddmmyyyy';
            d = datestr(now, formatOut);
            name = strtrim(h.Measurement(1).MeasurementSeries);
            Folder = '\FittedSpectra\';
            Path = fullfile(h.PathName,Folder);
            
            if exist(Path,'dir') ~= 7
                mkdir(Path);
            end
            
            for k = 1:size(FittedPeaksCalcDet1, 2)
                fid = fopen([[Path,'\'],name,'_','FittedSpectra_Det1','_',num2str(k),'_',d,'.dat'],'w');
                fprintf(fid,'%6s %8s %11s %10s \r\n','X','Y','YFit','Residual');
                    fprintf(fid,'%.6f %.6f %.6f %.6f \n',[XFitExportDet1(:,k) YFitExportDet1(:,k) YPlotExportDet1(:,k) FitResidualDet1(:,k)]');
                    fprintf(fid,'\n');
                fclose(fid);
            end
            
            for k = 1:size(FittedPeaksCalcDet2, 2)
                fid = fopen([[Path,'\'],name,'_','FittedSpectra_Det2','_',num2str(k),'_',d,'.dat'],'w');
                fprintf(fid,'%6s %8s %11s %10s \r\n','X','Y','YFit','Residual');
                    fprintf(fid,'%.6f %.6f %.6f %.6f \n',[XFitExportDet2(:,k) YFitExportDet2(:,k) YPlotExportDet2(:,k) FitResidualDet2(:,k)]');
                    fprintf(fid,'\n');
                fclose(fid);
            end

    end
end

% h.idxkeepPeaks = 0;
% h.idxdeletePeaks = 0;
% Messagebox
msgbox('Fitting completed.');

guidata(hObj, h);

function buttonselectpeak4(hObj, ~)
% Callback for "Undo" button in peak panel
h = guidata(hObj);

Detstr = get(h.popupmenuselectmeas1,'String');
Detval = get(h.popupmenuselectmeas1,'Value');
Detsel = Detstr{Detval};
h.Detsel = Detsel;

% Get slider value
% valueSlider = round(get(h.Slider, 'Value'));
% Set plot table data
if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    set(h.tablephasehkl,'BackgroundColor',ones(size(h.FitPeaksLogicalErange,2),3))
    % Set hkl table data. Set checkboxes according to user selected peaks.
    tabledata = get(h.tablephasehkl,'data');
    tabledata(1:end,6) = num2cell(false(size(h.FitPeaksLogicalErange(:,1),2)));
    set(h.tablephasehkl,'data',tabledata)
elseif strcmp(h.Diffsel,'LEDDI')
    if strcmp(h.Detsel,'Detector 1')
        set(h.tablephasehkl,'BackgroundColor',ones(size(h.FitPeaksLogicalErangeDet1,2),3))
        tabledata = get(h.tablephasehkl,'data');
        tabledata(1:end,6) = num2cell(false(size(h.FitPeaksLogicalErangeDet1(:,1),2)));
        set(h.tablephasehkl,'data',tabledata)
    elseif strcmp(h.Detsel,'Detector 2')
        set(h.tablephasehkl,'BackgroundColor',ones(size(h.FitPeaksLogicalErangeDet2,2),3))
        tabledata = get(h.tablephasehkl,'data');
        tabledata(1:end,6) = num2cell(false(size(h.FitPeaksLogicalErangeDet2(:,1),2)));
        set(h.tablephasehkl,'data',tabledata)
    end
end

set(h.tablepeakdata,'data', [zeros(1,6);0.3.*ones(1,6);0.3.*ones(1,6)])
set(h.plotpeakpoints,'visible','off')

h = rmfield(h,'plotpeakpoints');

guidata(hObj, h);

function popupmenuFitFunc(hObj,~)
% Callback for "pop up menu" in load measurement panel
h = guidata(hObj);
% Determine the selected data set.
val = get(hObj, 'Value');
h.P.PopupValueFitFunc = val;

% Change column names of fit results table
if h.P.PopupValueFitFunc == 2
    % Set Fit Results table properties
    set(h.tablefitresults, 'ColumnName', {'Iint [cts]','Imax [cts]', ...
        'E [keV]', [char(916),' ','E [keV]'], ...
        'IB [keV]', 'FWHM [keV]', char(951)})
    set(h.tablefitresults, 'ColumnWidth',{70,70,60,60,60,75,50});
    set(h.tablefitresults, 'data',zeros(10,7));
    % Set Psi File table properties
    set(h.tablepsifile, 'ColumnName', {'LNr     ',...
    'Emax   ',...
    'dEmax    ',...
    'Iint      ',...
    'Ib      ',...
    'tth     ',...
    'phiP   ',...
    'psiP   ',...
    'etaP  ',...
    'Ringstr  ',...
    'RT  ',...
    'DT   ',...
    'xdiff   ',...
    'ydiff   ',...
    'zdiff   ',...
    'motor1   ',...
    'motor2   ',...
    'motor3   ',...
    'temp1   ',...
    'temp2   ',...
    'heatrate   ',...
    'Time   ',...
    'PeakCount   ',...
    })
    set(h.tablepsifile, 'ColumnWidth',{40 50 55 50 50 50 50 50 50 50 50 50 50 50 50 60 60 60 50 60 60 60 80});
    set(h.tablepsifile, 'data',zeros(13,23));
elseif h.P.PopupValueFitFunc == 3
    % Set Fit Results table properties
    set(h.tablefitresults, 'ColumnName', {'Iint [cts]','Imax [cts]', ...
        'E [keV]', [char(916),' ','E [keV]'], ...
        'FWHM_Gauss [keV]', 'FWHM_Lorentz [keV]',...
        'IB [keV]', 'FWHM [keV]', char(951)})
    set(h.tablefitresults, 'ColumnWidth',{70,70,60,60,110,115,60,75,50});
    set(h.tablefitresults, 'data',zeros(10,9));
    % Set Psi File table properties
    set(h.tablepsifile, 'ColumnName', {'LNr     ',...
    'Emax   ',...
    'dEmax    ',...
    'Iint      ',...
    'Ib      ',...
    'FWHM      ',...
    'FWHM_Gauss      ',...
    'FWHM_Lorentz      ',...
    'tth     ',...
    'phiP   ',...
    'psiP   ',...
    'etaP  ',...
    'Ringstr  ',...
    'RT  ',...
    'DT   ',...
    'xdiff   ',...
    'ydiff   ',...
    'zdiff   ',...
    'motor1   ',...
    'motor2   ',...
    'motor3   ',...
    'temp1   ',...
    'temp2   ',...
    'heatrate   ',...
    'Time   ',...
    'PeakCount   ',...
    })
    set(h.tablepsifile, 'ColumnWidth',{40 50 55 50 50 60 100 105 50 50 50 50 50 50 50 50 50 50 60 60 60 50 60 60 60 80});
    set(h.tablepsifile, 'data',zeros(16,23));
elseif h.P.PopupValueFitFunc == 4 || h.P.PopupValueFitFunc == 5
    % Set Fit Results table properties
    set(h.tablefitresults, 'ColumnName', {'Iint [cts]','Imax [cts]', ...
        'E [keV]', [char(916),' ','E [keV]'], ...
        'IB [keV]', 'FWHM [keV]'})
    set(h.tablefitresults, 'ColumnWidth',{70,70,60,60,60,75});
    set(h.tablefitresults, 'data',zeros(10,6));
    % Set Psi File table properties
    set(h.tablepsifile, 'ColumnName', {'LNr     ',...
    'Emax   ',...
    'dEmax    ',...
    'Iint      ',...
    'Ib      ',...
    'tth     ',...
    'phiP   ',...
    'psiP   ',...
    'etaP  ',...
    'Ringstr  ',...
    'RT  ',...
    'DT   ',...
    'xdiff   ',...
    'ydiff   ',...
    'zdiff   ',...
    'motor1   ',...
    'motor2   ',...
    'motor3   ',...
    'temp1   ',...
    'temp2   ',...
    'heatrate   ',...
    'Time   ',...
    'PeakCount   ',...
    })
    set(h.tablepsifile, 'ColumnWidth',{40 50 55 50 50 50 50 50 50 50 50 50 50 50 50 60 60 60 50 60 60 60 80});
    set(h.tablepsifile, 'data',zeros(13,23));    
end

guidata(hObj,h);

function updatetablepeakdata(hObj, eventdata)
% Callback for updating user selected peak positions table 
h = guidata(hObj);
% Get slider value
valueSlider = round(get(h.Slider, 'Value'));
% Calculate plot data for updated BKG points
% Find closest point to user selected point
NewPeakPoint = eventdata.NewData;
NewPeakPointIdx = eventdata.Indices;

if NewPeakPointIdx(1) == 1
    indexUSP = Tools.Data.DataSetOperations.FindNearestIndex(h.DataTmp{valueSlider}(:,1),NewPeakPoint);

    % Check if changes should be applied to one or to all spectra
    value = get(h.checkboxBKG,'value');
    if value == 0
        % Update changed X position of background from current slider value
        h.Peaks{valueSlider}(1,NewPeakPointIdx(2)) = h.DataTmp{valueSlider}(indexUSP,1);
        % Interpolate RawData to get YData for PeakRegions
        h.DataInterpPeaks = interp1(h.DataTmp{valueSlider}(:,1),h.DataTmp{valueSlider}(:,2),h.Peaks{valueSlider});
        % Set table data
        set(h.tablepeakdata,'data',[h.Peaks{valueSlider};h.Peakslb{valueSlider};h.Peaksub{valueSlider}])
        % Set plot data
        set(h.plotpeakpoints,'XData',h.Peaks{valueSlider})
        set(h.plotpeakpoints,'YData',h.DataInterpPeaks)
    elseif value == 1
        % Update changed X position of background for all slider values
        for k = 1:size(h.Peaks,2)
            h.Peaks{k}(1,NewPeakPointIdx(2)) = h.DataTmp{k}(indexUSP,1);
        end
        % Set table data
        set(h.tablepeakdata,'data',[h.Peaks{valueSlider};h.Peakslb{valueSlider};h.Peaksub{valueSlider}])
        % Interpolate RawData to get YData for PeakRegions
        h.DataInterpPeaks = interp1(h.DataTmp{valueSlider}(:,1),h.DataTmp{valueSlider}(:,2),h.Peaks{valueSlider});
        % Set plot data
        set(h.plotpeakpoints,'XData',h.Peaks{valueSlider})
        set(h.plotpeakpoints,'YData',h.DataInterpPeaks)
    end
elseif NewPeakPointIdx(1) == 2
        % Check if changes should be applied to one or to all spectra
        value = get(h.checkboxBKG,'value');
        if value == 0
            % Update changed X position of background from current slider value
            h.Peakslb{valueSlider}(1,NewPeakPointIdx(2)) = NewPeakPoint;
            % Set table data
            set(h.tablepeakdata,'data',[h.Peaks{valueSlider};h.Peakslb{valueSlider};h.Peaksub{valueSlider}])
        elseif value == 1
            % Update changed X position of background for all slider values
            for k = 1:size(h.Peakslb,2)
                h.Peakslb{k}(1,NewPeakPointIdx(2)) = NewPeakPoint;
            end
            % Set table data
            set(h.tablepeakdata,'data',[h.Peaks{valueSlider};h.Peakslb{valueSlider};h.Peaksub{valueSlider}])
        end
elseif NewPeakPointIdx(1) == 3
        % Check if changes should be applied to one or to all spectra
        value = get(h.checkboxBKG,'value');
        if value == 0
            % Update changed X position of background from current slider value
            h.Peaksub{valueSlider}(1,NewPeakPointIdx(2)) = NewPeakPoint;
            % Set table data
            set(h.tablepeakdata,'data',[h.Peaks{valueSlider};h.Peakslb{valueSlider};h.Peaksub{valueSlider}])
        elseif value == 1
            % Update changed X position of background for all slider values
            for k = 1:size(h.Peaksub,2)
                h.Peaksub{k}(1,NewPeakPointIdx(2)) = NewPeakPoint;
            end
            % Set table data
            set(h.tablepeakdata,'data',[h.Peaks{valueSlider};h.Peakslb{valueSlider};h.Peaksub{valueSlider}])
        end
end

% Messagebox
msgbox('Peak data updated.');

guidata(hObj, h);

function celleditcallbackHKLTable(hObj, ~)
% Callback for uitable to select peaks hkl to be used in stress analysis 
h = guidata(hObj);
% Get data from hkl table 
SelectPeaktabledata = get(hObj,'data');

Detstr = get(h.popupmenuselectmeas1,'String');
Detval = get(h.popupmenuselectmeas1,'Value');
Detsel = Detstr{Detval};
h.Detsel = Detsel;

% Extract only logical (last column) - this logical replaces the one found
% from defining peaks manually. Keep backup of original one!
idxhklPeaks = [SelectPeaktabledata{:,6}]';

if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    if ~isfield(h, 'FitPeaksLogical')
        warndlg('No peaks defined. Please define peaks before choosing hkl values.','Warning')
        SelectPeaktabledata(1:end,6) = num2cell(false(size(SelectPeaktabledata,1),1));
        set(h.tablephasehkl,'data',SelectPeaktabledata)
    else
        h.idxFitPeaksLogicalbkp = h.FitPeaksLogical;
        h.FitPeaksLogical = idxhklPeaks;
    end
elseif strcmp(h.Diffsel,'LEDDI')
    if strcmp(h.Detsel,'Detector 1')
        if ~isfield(h, 'FitPeaksLogicalDet1')
            warndlg('No peaks defined. Please define peaks before choosing hkl values.','Warning')
            SelectPeaktabledata(1:end,6) = num2cell(false(size(SelectPeaktabledata,1),1));
            set(h.tablephasehkl,'data',SelectPeaktabledata)
        else
            h.idxFitPeaksLogicalDet1bkp = h.FitPeaksLogicalDet1;
            h.FitPeaksLogicalDet1 = idxhklPeaks;
        end
    elseif strcmp(h.Detsel,'Detector 2')
        if ~isfield(h, 'FitPeaksLogicalDet2')
            warndlg('No peaks defined. Please define peaks before choosing hkl values.','Warning')
            SelectPeaktabledata(1:end,6) = num2cell(false(size(SelectPeaktabledata,1),1));
            set(h.tablephasehkl,'data',SelectPeaktabledata)
        else
            h.idxFitPeaksLogicalDet2bkp = h.FitPeaksLogicalDet2;
            h.FitPeaksLogicalDet2 = idxhklPeaks;
        end
    end
end

% Array of table color usd to mark selected hkl peaks
TableBkgColor = [1 0.6 0.6];
TableBkgColorArray = repmat(TableBkgColor,size(idxhklPeaks,1),1);
% Create double from logical index
SelectedhklPeaks = double(idxhklPeaks);
% Set table background color for user selected peaks hkl
TableBkgColorArray = TableBkgColorArray.*SelectedhklPeaks;
TableBkgColorArray(TableBkgColorArray==0) = 1;
set(h.tablephasehkl,'BackgroundColor',TableBkgColorArray)

guidata(hObj, h);

%% Create psi file panel
function h = buttoncreatepsi1(hObj, ~, handles)
% Callback to load fit data
h = guidata(hObj);

% assignin('base','h',h)

Detstr = get(h.popupmenuselectmeas1,'String');
Detval = get(h.popupmenuselectmeas1,'Value');
Detsel = Detstr{Detval};
h.Detsel = Detsel;

% Get value of checkbox "fit data from both detectors"
FitBothDet = get(h.checkboxFitBothDetectors,'value');
% Check if filter options should be applied
if get(h.checkboxcreatepsi1,'Value') == 1
    h.FilterOptions.EvaluateFits = true;
else
    h.FilterOptions.EvaluateFits = false;
end
% assignin('base','Measurement',h.Measurement)
% assignin('base','Measurement',h.DataTmp)

% assignin('base','FittedPeaks',h.FittedPeaks)
% All peaks whose energy position confidence values are greater than
% this one are removed for the following process
h.FilterOptions.MaxDeltaEnergy = str2double(get(h.editfieldcreatepsi1,'String'));
% All peaks whose max-intensity confidence values are greater than this
% one are removed for the following process
h.FilterOptions.MaxDeltaIntensity = 10e10;
% All peaks whose integral intensity values are less than this one are
% removed for the following process
h.FilterOptions.MinIntegralIntensity = str2double(get(h.editfieldcreatepsi2,'String'));
% All peaks whose integral width values are less than this one are
% removed for the following process
h.FilterOptions.MinIntegralWidth = str2double(get(h.editfieldcreatepsi3,'String'));
% All peaks whose integral width values are greater than this one are
% removed for the following process
h.FilterOptions.MaxIntegralWidth = str2double(get(h.editfieldcreatepsi4,'String'));
% All peaks whose peak reange is larger than this one are removed for the 
% following process
h.FilterOptions.RangeWidth = str2double(get(h.editfieldcreatepsi5,'String'));
% All peaks whose phi values are unequal to the ones selected from the user
% are removed for the following process
PhiFilter = cellfun(@str2double,strsplit(get(h.editfieldcreatepsi6,'String'),","));
if ~isnan(PhiFilter)
    h.FilterOptions.Phi = PhiFilter;
else
    h.FilterOptions.Phi = get(h.editfieldcreatepsi6,'String');
end
% All peaks whose psi values are larger than the one selected from the user
% are removed for the following process
PsiFilter = str2double(get(h.editfieldcreatepsi7,'String'));
if ~isnan(PsiFilter)
    h.FilterOptions.Psi = PsiFilter;
else
    h.FilterOptions.Psi = get(h.editfieldcreatepsi7,'String');
end

% if ~ischar(get(h.editfieldcreatepsi6,'String'))
%     h.FilterOptions.Phi = cellfun(@str2double,strsplit(get(h.editfieldcreatepsi6,'String'),","));
%     assignin('base','Phi',h.FilterOptions.Phi)
% else
%     h.FilterOptions.Phi = get(h.editfieldcreatepsi6,'String');
% end
% All peaks whose psi values are unequal to the ones selected from the user
% are removed for the following process
% h.FilterOptions.Psi = cellfun(@str2double,strsplit(get(h.editfieldcreatepsi7,'String'),","));
% Linien aus dem Fits erzeugen und bewerten
h.DiffractionLines = cell(length(h.Measurement),1);
% To be updated
%--------------------------------------------------------------------------
% If FittedPeaks data was already changed by the user, load backup of
% FittedPeaks data in order to allow for unaffected changes. Also check
% whether point wise correction is used, then do not load backup data.
if isfield(h,'FittedPeaksbkp')
    if isfield(h,'PWcorrcheck')
        if h.PWcorrcheck == 0
            h.FittedPeaks = h.FittedPeaksbkp;
        end
    else
        h.FittedPeaks = h.FittedPeaksbkp;
    end
end
% Create difraction lines from fitted peaks
% For the cases where EDDI or LIMAX-160 were used
if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    % Filter applied to the diffraction line data
    [DiffractionLines] = FilterDiffLine(h.Measurement,h.FittedPeaks,h.SE,h.P.PopupValueFitFunc,h.FilterOptions);
    h.DiffractionLines = DiffractionLines;
    assignin('base','DiffractionLines',DiffractionLines)
    % If peaks were deselected by the user, delete them from DiffractionLines
    if isfield(h, 'idxkeepPeaks')
        if size(DiffractionLines{1},2) ~= size(h.idxkeepPeaks,1)
            for k = 1:length(DiffractionLines)
                DiffractionLines{k}(h.idxdeletePeaks) = [];
            end
        end
    end

% 
% %     assignin('base','idxSelectPeaktable1',h2data.idxSelectPeaktable)
% %     if ~isfield(h, 'idxSelectPeaktable')
%     if all(cell2mat(h.SelectPeaktable.Data(:,2)) == 0)
%         h.idxSelectPeaktable = true(size(DiffractionLines{1},2),1);
%         h.idxkeepPeaks = find(h.idxSelectPeaktable == 1);
%         h.idxdeletePeaks = find(h.idxSelectPeaktable == 0);
%         idxkeep = h.idxkeepPeaks;
%         idxdelete = h.idxdeletePeaks;
%     else
%         idxkeep = h.idxkeepPeaks;
%         idxdelete = h.idxdeletePeaks;
%     end
% 
%     % Delete peaks from DiffractionLines
%     if ~isempty(idxdelete)
%         for k = 1:length(DiffractionLines)
%             DiffractionLines{k}(idxdelete) = [];
%         end
%     end
% %     h.idxkeepPeaks = (1:size(DiffractionLines{1},2))';
%     assignin('base','idxkeep',idxkeep)
%     assignin('base','idxdelete',idxdelete)
%         idxkeep = getappdata(0,'idxkeepPeaks');
%     if ~isempty(idxkeep)
%         % Create vector with indices of peaks to keep
%         indexkeeptmp = zeros(1,size(DiffractionLines{1},2));
%         indexkeeptmp(idxkeep) = 1;
%         % Create index for peaks to delete
%         indexdel = find(indexkeeptmp==0);
%         % Delete peaks from DiffractionLines
%         for k = 1:length(DiffractionLines)
%             DiffractionLines{k}(indexdel) = [];
%         end
%     end
% For the case where LEDDI was used and single detector data should be
% fitted
elseif strcmp(h.Diffsel,'LEDDI') && FitBothDet == 0
    if strcmp(h.Detsel,'Detector 1')
        Slidersteps = 2:2:length(h.Measurement);
        % Filter applied to the diffraction line data
        [DiffractionLines] = FilterDiffLine(h.Measurement(Slidersteps),h.FittedPeaksDet1,h.SEDet1,h.P.PopupValueFitFunc,h.FilterOptions);
        h.DiffractionLinesDet1 = DiffractionLines;
        % If peaks were deselected by the user, delete them from DiffractionLines
        if isfield(h, 'idxkeepPeaks')
            if size(DiffractionLines{1},2) ~= size(h.idxkeepPeaks,1)
                for k = 1:length(DiffractionLines)
                    DiffractionLines{k}(h.idxdeletePeaks) = [];
                end
            end
        end
%         % Get index of peaks to keep
%         idxkeep = getappdata(0,'idxkeepPeaks');
%         if ~isempty(idxkeep)
%             % Create vector with indices of peaks to keep
%             indexkeeptmp = zeros(1,size(DiffractionLines{1},2));
%             indexkeeptmp(idxkeep) = 1;
%             % Create index for peaks to delete
%             indexdel = find(indexkeeptmp==0);
%             % Delete peaks from DiffractionLines
%             for k = 1:length(DiffractionLines)
%                 DiffractionLines{k}(indexdel) = [];
%             end
%         end
    elseif strcmp(h.Detsel,'Detector 2')
        Slidersteps = 1:2:length(h.Measurement);
        [DiffractionLines] = FilterDiffLine(h.Measurement(Slidersteps),h.FittedPeaksDet2,h.SEDet2,h.P.PopupValueFitFunc,h.FilterOptions);
        h.DiffractionLinesDet2 = DiffractionLines;
        % If peaks were deselected by the user, delete them from DiffractionLines
        if isfield(h, 'idxkeepPeaks')
            if size(DiffractionLines{1},2) ~= size(h.idxkeepPeaks,1)
                for k = 1:length(DiffractionLines)
                    DiffractionLines{k}(h.idxdeletePeaks) = [];
                end
            end
        end
%         % Get index of peaks to keep
%         idxkeep = getappdata(0,'idxkeepPeaks');
%         if ~isempty(idxkeep)
%             % Create vector with indices of peaks to keep
%             indexkeeptmp = zeros(1,size(DiffractionLines{1},2));
%             indexkeeptmp(idxkeep) = 1;
%             % Create index for peaks to delete
%             indexdel = find(indexkeeptmp==0);
%             % Delete peaks from DiffractionLines
%             for k = 1:length(DiffractionLines)
%                 DiffractionLines{k}(indexdel) = [];
%             end
%         end
    end
% For the case where LEDDI was used and data from both detectors should be 
% fitted  
elseif strcmp(h.Diffsel,'LEDDI') && FitBothDet == 1
    Slidersteps = 2:2:length(h.Measurement);
    % Filter applied to the diffraction line data
    [DiffractionLines] = FilterDiffLine(h.Measurement(Slidersteps),h.FittedPeaksDet1,h.SEDet1,h.P.PopupValueFitFunc,h.FilterOptions);
    h.DiffractionLinesDet1 = DiffractionLines;
    % If peaks were deselected by the user, delete them from DiffractionLines
    if isfield(h, 'idxkeepPeaks')
        if size(DiffractionLines{1},2) ~= size(h.idxkeepPeaks,1)
            for k = 1:length(DiffractionLines)
                DiffractionLines{k}(h.idxdeletePeaks) = [];
            end
        end
    end
%     % Get index of peaks to keep
%     idxkeep = getappdata(0,'idxkeepPeaks');
%     if ~isempty(idxkeep)
%         % Create vector with indices of peaks to keep
%         indexkeeptmp = zeros(1,size(DiffractionLines{1},2));
%         indexkeeptmp(idxkeep) = 1;
%         % Create index for peaks to delete
%         indexdel = find(indexkeeptmp==0);
%         % Delete peaks from DiffractionLines
%         for k = 1:length(DiffractionLines)
%             DiffractionLines{k}(indexdel) = [];
%         end
%     end
    Slidersteps = 1:2:length(h.Measurement);
    [DiffractionLines] = FilterDiffLine(h.Measurement(Slidersteps),h.FittedPeaksDet2,h.SEDet2,h.P.PopupValueFitFunc,h.FilterOptions);
    h.DiffractionLinesDet2 = DiffractionLines;
    % If peaks were deselected by the user, delete them from DiffractionLines
    if isfield(h, 'idxkeepPeaks')
        if size(DiffractionLines{1},2) ~= size(h.idxkeepPeaks,1)
            for k = 1:length(DiffractionLines)
                DiffractionLines{k}(h.idxdeletePeaks) = [];
            end
        end
    end
%     % Get index of peaks to keep
%     idxkeep = getappdata(0,'idxkeepPeaks');
%     if ~isempty(idxkeep)
%         % Create vector with indices of peaks to keep
%         indexkeeptmp = zeros(1,size(DiffractionLines{1},2));
%         indexkeeptmp(idxkeep) = 1;
%         % Create index for peaks to delete
%         indexdel = find(indexkeeptmp==0);
%         % Delete peaks from DiffractionLines
%         for k = 1:length(DiffractionLines)
%             DiffractionLines{k}(indexdel) = [];
%         end
%     end
end

% Prepare diffraction line data for table in the case where LEDDI was used
% and data from both detectors was fitted
if  strcmp(h.Diffsel,'LEDDI') && FitBothDet == 1
    % Create structure with information from both detectors
    DiffractionLinestmp = struct;
    DiffractionLinestmp(1).LEDDI = h.DiffractionLinesDet1;
    DiffractionLinestmp(2).LEDDI = h.DiffractionLinesDet2;
    % Create Psidata for the two detectors, depending on the fit function
    % used to fit the data
    for k = 1:size(DiffractionLinestmp,2)
        if h.P.PopupValueFitFunc == 2 || h.P.PopupValueFitFunc == 4 || h.P.PopupValueFitFunc == 5%PV-Func
            if h.P.DiffractometerType == 1 % EDDI
                [DiffractionLinestmp(k).Psidata] = EDDIPsiDataPV(DiffractionLinestmp(k).LEDDI);
            elseif h.P.DiffractometerType == 2 % LEDDI
                [DiffractionLinestmp(k).Psidata] = LEDDIPsiDataPV(DiffractionLinestmp(k).LEDDI);
            elseif h.P.DiffractometerType == 3 % LIMAX-160
                [DiffractionLinestmp(k).Psidata] = LIMAX160PsiDataPV(DiffractionLinestmp(k).LEDDI);
            end
            
            % Adjust LinNumber in case peaks were deselected
            LineCnt = 1:size(DiffractionLinestmp(k).Psidata.LineNumber,2);
            LineCnt = repmat(LineCnt,size(DiffractionLinestmp(k).Psidata.LineNumber,1),1);

            % Replace Line number with ordered one
            for m = 1:size(DiffractionLinestmp(k).Psidata.LineNumber,2)
                for l = 1:size(DiffractionLinestmp(k).Psidata.LineNumber,1)
                    DiffractionLinestmp(k).Psidata.LineNumber{l,m} = num2str(LineCnt(l,m));
                end
            end
            
            % Create PsiFileTableData for both detectors
            DiffractionLinestmp(k).PsiFileTableData = [reshape(DiffractionLinestmp(k).Psidata.LineNumber,numel(DiffractionLinestmp(k).Psidata.LineNumber),1),...
                reshape(DiffractionLinestmp(k).Psidata.Energy_Max,numel(DiffractionLinestmp(k).Psidata.Energy_Max),1),...
                reshape(DiffractionLinestmp(k).Psidata.Energy_Max_Delta,numel(DiffractionLinestmp(k).Psidata.Energy_Max_Delta),1),...
                reshape(DiffractionLinestmp(k).Psidata.Intensity_Int_calc,numel(DiffractionLinestmp(k).Psidata.Intensity_Int_calc),1),...
                reshape(DiffractionLinestmp(k).Psidata.IntegralWidth,numel(DiffractionLinestmp(k).Psidata.IntegralWidth),1),...
                reshape(DiffractionLinestmp(k).Psidata.twotheta,numel(DiffractionLinestmp(k).Psidata.twotheta),1),...
                reshape(DiffractionLinestmp(k).Psidata.phi,numel(DiffractionLinestmp(k).Psidata.phi),1),...
                reshape(DiffractionLinestmp(k).Psidata.psi,numel(DiffractionLinestmp(k).Psidata.psi),1),...
                reshape(DiffractionLinestmp(k).Psidata.eta,numel(DiffractionLinestmp(k).Psidata.eta),1),...
                reshape(DiffractionLinestmp(k).Psidata.RingCurrent,numel(DiffractionLinestmp(k).Psidata.RingCurrent),1),...
                reshape(DiffractionLinestmp(k).Psidata.RealTime,numel(DiffractionLinestmp(k).Psidata.RealTime),1),...
                reshape(DiffractionLinestmp(k).Psidata.DeadTime,numel(DiffractionLinestmp(k).Psidata.DeadTime),1),...
                reshape(DiffractionLinestmp(k).Psidata.x_achse,numel(DiffractionLinestmp(k).Psidata.x_achse),1),...
                reshape(DiffractionLinestmp(k).Psidata.y_achse,numel(DiffractionLinestmp(k).Psidata.y_achse),1),...
                reshape(DiffractionLinestmp(k).Psidata.z_achse,numel(DiffractionLinestmp(k).Psidata.z_achse),1),...
                reshape(DiffractionLinestmp(k).Psidata.SampleStagePos1,numel(DiffractionLinestmp(k).Psidata.SampleStagePos1),1),...
                reshape(DiffractionLinestmp(k).Psidata.SampleStagePos2,numel(DiffractionLinestmp(k).Psidata.SampleStagePos2),1),...
                reshape(DiffractionLinestmp(k).Psidata.SampleStagePos3,numel(DiffractionLinestmp(k).Psidata.SampleStagePos3),1),...
                reshape(DiffractionLinestmp(k).Psidata.Temperatures1,numel(DiffractionLinestmp(k).Psidata.Temperatures1),1),...
                reshape(DiffractionLinestmp(k).Psidata.Temperatures2,numel(DiffractionLinestmp(k).Psidata.Temperatures2),1),...
                reshape(DiffractionLinestmp(k).Psidata.HeatRate,numel(DiffractionLinestmp(k).Psidata.HeatRate),1),...
                reshape(DiffractionLinestmp(k).Psidata.Time,numel(DiffractionLinestmp(k).Psidata.Time),1),...
                reshape(DiffractionLinestmp(k).Psidata.PeakCount,numel(DiffractionLinestmp(k).Psidata.PeakCount),1),...
                ];
        elseif h.P.PopupValueFitFunc == 3 %TCH-Func
            if h.P.DiffractometerType == 1 % EDDI
                [DiffractionLinestmp(k).Psidata] = EDDIPsiDataTCH(DiffractionLinestmp(k).LEDDI);
            elseif h.P.DiffractometerType == 2 % LEDDI
                [DiffractionLinestmp(k).Psidata] = LEDDIPsiDataTCH(DiffractionLinestmp(k).LEDDI);
            elseif h.P.DiffractometerType == 3 % LIMAX-160
                [DiffractionLinestmp(k).Psidata] = LIMAX160PsiDataTCH(DiffractionLinestmp(k).LEDDI);
            end
            
            % Adjust LinNumber in case peaks were deselected
            LineCnt = 1:size(DiffractionLinestmp(k).Psidata.LineNumber,2);
            LineCnt = repmat(LineCnt,size(DiffractionLinestmp(k).Psidata.LineNumber,1),1);

            % Replace Line number with ordered one
            for m = 1:size(DiffractionLinestmp(k).Psidata.LineNumber,2)
                for l = 1:size(DiffractionLinestmp(k).Psidata.LineNumber,1)
                    DiffractionLinestmp(k).Psidata.LineNumber{l,m} = num2str(LineCnt(l,m));
                end
            end
            
            % Create PsiFileTableData for both detectors
            DiffractionLinestmp(k).PsiFileTableData = [reshape(DiffractionLinestmp(k).Psidata.LineNumber,numel(DiffractionLinestmp(k).Psidata.LineNumber),1),...
                reshape(DiffractionLinestmp(k).Psidata.Energy_Max,numel(DiffractionLinestmp(k).Psidata.Energy_Max),1),...
                reshape(DiffractionLinestmp(k).Psidata.Energy_Max_Delta,numel(DiffractionLinestmp(k).Psidata.Energy_Max_Delta),1),...
                reshape(DiffractionLinestmp(k).Psidata.Intensity_Int_calc,numel(DiffractionLinestmp(k).Psidata.Intensity_Int_calc),1),...
                reshape(DiffractionLinestmp(k).Psidata.IntegralWidth,numel(DiffractionLinestmp(k).Psidata.IntegralWidth),1),...
                reshape(DiffractionLinestmp(k).Psidata.FWHM,numel(DiffractionLinestmp(k).Psidata.IntegralWidth),1),...
                reshape(DiffractionLinestmp(k).Psidata.FWHM_Gauss,numel(DiffractionLinestmp(k).Psidata.IntegralWidth),1),...
                reshape(DiffractionLinestmp(k).Psidata.FWHM_Lorentz,numel(DiffractionLinestmp(k).Psidata.IntegralWidth),1),...
                reshape(DiffractionLinestmp(k).Psidata.twotheta,numel(DiffractionLinestmp(k).Psidata.twotheta),1),...
                reshape(DiffractionLinestmp(k).Psidata.phi,numel(DiffractionLinestmp(k).Psidata.phi),1),...
                reshape(DiffractionLinestmp(k).Psidata.psi,numel(DiffractionLinestmp(k).Psidata.psi),1),...
                reshape(DiffractionLinestmp(k).Psidata.eta,numel(DiffractionLinestmp(k).Psidata.eta),1),...
                reshape(DiffractionLinestmp(k).Psidata.RingCurrent,numel(DiffractionLinestmp(k).Psidata.RingCurrent),1),...
                reshape(DiffractionLinestmp(k).Psidata.RealTime,numel(DiffractionLinestmp(k).Psidata.RealTime),1),...
                reshape(DiffractionLinestmp(k).Psidata.DeadTime,numel(DiffractionLinestmp(k).Psidata.DeadTime),1),...
                reshape(DiffractionLinestmp(k).Psidata.x_achse,numel(DiffractionLinestmp(k).Psidata.x_achse),1),...
                reshape(DiffractionLinestmp(k).Psidata.y_achse,numel(DiffractionLinestmp(k).Psidata.y_achse),1),...
                reshape(DiffractionLinestmp(k).Psidata.z_achse,numel(DiffractionLinestmp(k).Psidata.z_achse),1),...
                reshape(DiffractionLinestmp(k).Psidata.SampleStagePos1,numel(DiffractionLinestmp(k).Psidata.SampleStagePos1),1),...
                reshape(DiffractionLinestmp(k).Psidata.SampleStagePos2,numel(DiffractionLinestmp(k).Psidata.SampleStagePos2),1),...
                reshape(DiffractionLinestmp(k).Psidata.SampleStagePos3,numel(DiffractionLinestmp(k).Psidata.SampleStagePos3),1),...
                reshape(DiffractionLinestmp(k).Psidata.Temperatures1,numel(DiffractionLinestmp(k).Psidata.Temperatures1),1),...
                reshape(DiffractionLinestmp(k).Psidata.Temperatures2,numel(DiffractionLinestmp(k).Psidata.Temperatures2),1),...
                reshape(DiffractionLinestmp(k).Psidata.HeatRate,numel(DiffractionLinestmp(k).Psidata.HeatRate),1),...
                reshape(DiffractionLinestmp(k).Psidata.Time,numel(DiffractionLinestmp(k).Psidata.Time),1),...
                reshape(DiffractionLinestmp(k).Psidata.PeakCount,numel(DiffractionLinestmp(k).Psidata.PeakCount),1),...
                ];    
        end
    end
    % Create data from structure for both detectors
    h.PsiFileTableDataDet1 = DiffractionLinestmp(1).PsiFileTableData;
    h.PsidataDet1 = DiffractionLinestmp(1).Psidata;
    h.PsiFileTableDataDet2 = DiffractionLinestmp(2).PsiFileTableData;
    h.PsidataDet2 = DiffractionLinestmp(2).Psidata;
% Prepare diffraction line data for table in the case where LEDDI or any 
% other diffractometer was used (data from both detectors was fitted
% seperately)
else
    % Create psidata
    if h.P.PopupValueFitFunc == 2 || h.P.PopupValueFitFunc == 4 || h.P.PopupValueFitFunc == 5 %PV-Func
        if h.P.DiffractometerType == 1 % EDDI
            [Psidata] = EDDIPsiDataPV(DiffractionLines);
        elseif h.P.DiffractometerType == 2 % LEDDI
            [Psidata] = LEDDIPsiDataPV(DiffractionLines);
        elseif h.P.DiffractometerType == 3 % LIMAX-160
            [Psidata] = LIMAX160PsiDataPV(DiffractionLines);
        elseif h.P.DiffractometerType == 4 % LIMAX-70
            [Psidata] = LIMAX70PsiDataPV(DiffractionLines);    
        end
        assignin('base','Psidata',Psidata)
        % Adjust LineNumber in case peaks were deselected
        LineCnt = 1:size(Psidata.LineNumber,2);
        LineCnt = repmat(LineCnt,size(Psidata.LineNumber,1),1);
        % Replace Line number with ordered one
        for k = 1:size(Psidata.LineNumber,2)
            for l = 1:size(Psidata.LineNumber,1)
                Psidata.LineNumber{l,k} = num2str(LineCnt(l,k));
            end
        end
        
        % Create PsiFileTableData
%         h.PsiFileTableData = [reshape(Psidata.LineNumber,numel(Psidata.LineNumber),1),...
%             reshape(Psidata.Energy_Max,numel(Psidata.Energy_Max),1),...
%             reshape(Psidata.Energy_Max_Delta,numel(Psidata.Energy_Max_Delta),1),...
%             reshape(Psidata.Intensity_Int_calc,numel(Psidata.Intensity_Int_calc),1),...
%             reshape(Psidata.IntegralWidth,numel(Psidata.IntegralWidth),1),...
%             reshape(Psidata.twotheta,numel(Psidata.twotheta),1),...
%             reshape(Psidata.phi,numel(Psidata.phi),1),...
%             reshape(Psidata.psi,numel(Psidata.psi),1),...
%             reshape(Psidata.eta,numel(Psidata.eta),1),...
%             reshape(Psidata.RingCurrent,numel(Psidata.RingCurrent),1),...
%             reshape(Psidata.RealTime,numel(Psidata.RealTime),1),...
%             reshape(Psidata.DeadTime,numel(Psidata.DeadTime),1),...
%             reshape(Psidata.x_achse,numel(Psidata.x_achse),1),...
%             reshape(Psidata.y_achse,numel(Psidata.y_achse),1),...
%             reshape(Psidata.z_achse,numel(Psidata.z_achse),1),...
%             reshape(Psidata.SampleStagePos1,numel(Psidata.SampleStagePos1),1),...
%             reshape(Psidata.SampleStagePos2,numel(Psidata.SampleStagePos2),1),...
%             reshape(Psidata.SampleStagePos3,numel(Psidata.SampleStagePos3),1),...
%             reshape(Psidata.Temperatures1,numel(Psidata.Temperatures1),1),...
%             reshape(Psidata.Temperatures2,numel(Psidata.Temperatures2),1),...
%             reshape(Psidata.HeatRate,numel(Psidata.HeatRate),1),...
%             reshape(Psidata.Time,numel(Psidata.Time),1),...
%             reshape(Psidata.PeakCount,numel(Psidata.PeakCount),1),...
%             ];
        % Create PsiFileTableData
        Psidata_tmp = struct2cell(Psidata);
        PsiFileTableData_tmp = cellfun(@(x) reshape(x,prod(size(Psidata_tmp{1})),[]),Psidata_tmp,'un',0);
        h.PsiFileTableData = [PsiFileTableData_tmp{:}];
        
        assignin('base','PsiFileTableData',h.PsiFileTableData)
    elseif h.P.PopupValueFitFunc == 3 %TCH-Func
        if h.P.DiffractometerType == 1 % EDDI
            [Psidata] = EDDIPsiDataTCH(DiffractionLines);
        elseif h.P.DiffractometerType == 2 % LEDDI
            [Psidata] = LEDDIPsiDataTCH(DiffractionLines);
        elseif h.P.DiffractometerType == 3 % LIMAX-160
            [Psidata] = LIMAX160PsiDataTCH(DiffractionLines);
        elseif h.P.DiffractometerType == 4 % LIMAX-70
            [Psidata] = LIMAX70PsiDataTCH(DiffractionLines);    
        end
        
        % Adjust LinNumber in case peaks were deselected
        LineCnt = 1:size(Psidata.LineNumber,2);
        LineCnt = repmat(LineCnt,size(Psidata.LineNumber,1),1);

        % Replace Line number with ordered one
        for k = 1:size(Psidata.LineNumber,2)
            for l = 1:size(Psidata.LineNumber,1)
                Psidata.LineNumber{l,k} = num2str(LineCnt(l,k));
            end
        end
        
%         % Create PsiFileTableData
%         h.PsiFileTableData = [reshape(Psidata.LineNumber,numel(Psidata.LineNumber),1),...
%             reshape(Psidata.Energy_Max,numel(Psidata.Energy_Max),1),...
%             reshape(Psidata.Energy_Max_Delta,numel(Psidata.Energy_Max_Delta),1),...
%             reshape(Psidata.Intensity_Int_calc,numel(Psidata.Intensity_Int_calc),1),...
%             reshape(Psidata.IntegralWidth,numel(Psidata.IntegralWidth),1),...
%             reshape(Psidata.FWHM,numel(Psidata.IntegralWidth),1),...
%             reshape(Psidata.FWHM_Gauss,numel(Psidata.IntegralWidth),1),...
%             reshape(Psidata.FWHM_Lorentz,numel(Psidata.IntegralWidth),1),...
%             reshape(Psidata.twotheta,numel(Psidata.twotheta),1),...
%             reshape(Psidata.phi,numel(Psidata.phi),1),...
%             reshape(Psidata.psi,numel(Psidata.psi),1),...
%             reshape(Psidata.eta,numel(Psidata.eta),1),...
%             reshape(Psidata.RingCurrent,numel(Psidata.RingCurrent),1),...
%             reshape(Psidata.RealTime,numel(Psidata.RealTime),1),...
%             reshape(Psidata.DeadTime,numel(Psidata.DeadTime),1),...
%             reshape(Psidata.x_achse,numel(Psidata.x_achse),1),...
%             reshape(Psidata.y_achse,numel(Psidata.y_achse),1),...
%             reshape(Psidata.z_achse,numel(Psidata.z_achse),1),...
%             reshape(Psidata.SampleStagePos1,numel(Psidata.SampleStagePos1),1),...
%             reshape(Psidata.SampleStagePos2,numel(Psidata.SampleStagePos2),1),...
%             reshape(Psidata.SampleStagePos3,numel(Psidata.SampleStagePos3),1),...
%             reshape(Psidata.Temperatures1,numel(Psidata.Temperatures1),1),...
%             reshape(Psidata.Temperatures2,numel(Psidata.Temperatures2),1),...
%             reshape(Psidata.HeatRate,numel(Psidata.HeatRate),1),...
%             reshape(Psidata.Time,numel(Psidata.Time),1),...
%             reshape(Psidata.PeakCount,numel(Psidata.PeakCount),1),...
%             ];
        % Create PsiFileTableData
        Psidata_tmp = struct2cell(Psidata);
        PsiFileTableData_tmp = cellfun(@(x) reshape(x,prod(size(Psidata_tmp{1})),[]),Psidata_tmp,'un',0);
        h.PsiFileTableData = [PsiFileTableData_tmp{:}];
    elseif h.P.PopupValueFitFunc == 4 %PV-Func
        if h.P.DiffractometerType == 1 % EDDI
            [Psidata] = EDDIPsiDataPV(DiffractionLines);
        elseif h.P.DiffractometerType == 2 % LEDDI
            [Psidata] = LEDDIPsiDataPV(DiffractionLines);
        elseif h.P.DiffractometerType == 3 % LIMAX-160
            [Psidata] = LIMAX160PsiDataPV(DiffractionLines);
        elseif h.P.DiffractometerType == 4 % LIMAX-70
            [Psidata] = LIMAX70PsiDataPV(DiffractionLines);    
        end
        
        % Adjust LineNumber in case peaks were deselected
        LineCnt = 1:size(Psidata.LineNumber,2);
        LineCnt = repmat(LineCnt,size(Psidata.LineNumber,1),1);
        % Replace Line number with ordered one
        for k = 1:size(Psidata.LineNumber,2)
            for l = 1:size(Psidata.LineNumber,1)
                Psidata.LineNumber{l,k} = num2str(LineCnt(l,k));
            end
        end
        
        % Create PsiFileTableData
        h.PsiFileTableData = [reshape(Psidata.LineNumber,numel(Psidata.LineNumber),1),...
            reshape(Psidata.Energy_Max,numel(Psidata.Energy_Max),1),...
            reshape(Psidata.Energy_Max_Delta,numel(Psidata.Energy_Max_Delta),1),...
            reshape(Psidata.Intensity_Int_calc,numel(Psidata.Intensity_Int_calc),1),...
            reshape(Psidata.IntegralWidth,numel(Psidata.IntegralWidth),1),...
            reshape(Psidata.twotheta,numel(Psidata.twotheta),1),...
            reshape(Psidata.phi,numel(Psidata.phi),1),...
            reshape(Psidata.psi,numel(Psidata.psi),1),...
            reshape(Psidata.eta,numel(Psidata.eta),1),...
            reshape(Psidata.RingCurrent,numel(Psidata.RingCurrent),1),...
            reshape(Psidata.RealTime,numel(Psidata.RealTime),1),...
            reshape(Psidata.DeadTime,numel(Psidata.DeadTime),1),...
            reshape(Psidata.x_achse,numel(Psidata.x_achse),1),...
            reshape(Psidata.y_achse,numel(Psidata.y_achse),1),...
            reshape(Psidata.z_achse,numel(Psidata.z_achse),1),...
            reshape(Psidata.SampleStagePos1,numel(Psidata.SampleStagePos1),1),...
            reshape(Psidata.SampleStagePos2,numel(Psidata.SampleStagePos2),1),...
            reshape(Psidata.SampleStagePos3,numel(Psidata.SampleStagePos3),1),...
            reshape(Psidata.Temperatures1,numel(Psidata.Temperatures1),1),...
            reshape(Psidata.Temperatures2,numel(Psidata.Temperatures2),1),...
            reshape(Psidata.HeatRate,numel(Psidata.HeatRate),1),...
            reshape(Psidata.Time,numel(Psidata.Time),1),...
            reshape(Psidata.PeakCount,numel(Psidata.PeakCount),1),...
            ];
    elseif h.P.PopupValueFitFunc == 5 %PV-Func
        if h.P.DiffractometerType == 1 % EDDI
            [Psidata] = EDDIPsiDataPV(DiffractionLines);
        elseif h.P.DiffractometerType == 2 % LEDDI
            [Psidata] = LEDDIPsiDataPV(DiffractionLines);
        elseif h.P.DiffractometerType == 3 % LIMAX-160
            [Psidata] = LIMAX160PsiDataPV(DiffractionLines);
        end
        
        % Adjust LineNumber in case peaks were deselected
        LineCnt = 1:size(Psidata.LineNumber,2);
        LineCnt = repmat(LineCnt,size(Psidata.LineNumber,1),1);
        % Replace Line number with ordered one
        for k = 1:size(Psidata.LineNumber,2)
            for l = 1:size(Psidata.LineNumber,1)
                Psidata.LineNumber{l,k} = num2str(LineCnt(l,k));
            end
        end
        
        % Create PsiFileTableData
        h.PsiFileTableData = [reshape(Psidata.LineNumber,numel(Psidata.LineNumber),1),...
            reshape(Psidata.Energy_Max,numel(Psidata.Energy_Max),1),...
            reshape(Psidata.Energy_Max_Delta,numel(Psidata.Energy_Max_Delta),1),...
            reshape(Psidata.Intensity_Int_calc,numel(Psidata.Intensity_Int_calc),1),...
            reshape(Psidata.IntegralWidth,numel(Psidata.IntegralWidth),1),...
            reshape(Psidata.twotheta,numel(Psidata.twotheta),1),...
            reshape(Psidata.phi,numel(Psidata.phi),1),...
            reshape(Psidata.psi,numel(Psidata.psi),1),...
            reshape(Psidata.eta,numel(Psidata.eta),1),...
            reshape(Psidata.RingCurrent,numel(Psidata.RingCurrent),1),...
            reshape(Psidata.RealTime,numel(Psidata.RealTime),1),...
            reshape(Psidata.DeadTime,numel(Psidata.DeadTime),1),...
            reshape(Psidata.x_achse,numel(Psidata.x_achse),1),...
            reshape(Psidata.y_achse,numel(Psidata.y_achse),1),...
            reshape(Psidata.z_achse,numel(Psidata.z_achse),1),...
            reshape(Psidata.SampleStagePos1,numel(Psidata.SampleStagePos1),1),...
            reshape(Psidata.SampleStagePos2,numel(Psidata.SampleStagePos2),1),...
            reshape(Psidata.SampleStagePos3,numel(Psidata.SampleStagePos3),1),...
            reshape(Psidata.Temperatures1,numel(Psidata.Temperatures1),1),...
            reshape(Psidata.Temperatures2,numel(Psidata.Temperatures2),1),...
            reshape(Psidata.HeatRate,numel(Psidata.HeatRate),1),...
            reshape(Psidata.Time,numel(Psidata.Time),1),...
            reshape(Psidata.PeakCount,numel(Psidata.PeakCount),1),...
            ];
    end
    % Create data if EDDI or LIMAX-160 was used
    if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
       h.PsiFileTableDataBkp = h.PsiFileTableData;
       h.Psidata = Psidata;
    end
    % Create data for both detectors if LEDDI was used
    if strcmp(h.Diffsel,'LEDDI') && FitBothDet == 0
        if strcmp(h.Detsel,'Detector 1')
            h.PsiFileTableDataDet1 = h.PsiFileTableData;
            h.PsiFileTableDataDet1Bkp = h.PsiFileTableData;
            h.PsidataDet1 = Psidata;
        elseif strcmp(h.Detsel,'Detector 2')
            h.PsiFileTableDataDet2 = h.PsiFileTableData;
            h.PsiFileTableDataDet2Bkp = h.PsiFileTableData;
            h.PsidataDet2 = Psidata;
        end
    end
end

% Delete Lines where energies are zero and delete data from peak numbers of
% "dummy" peaks, i.e. from peaks that are from a diferent phase
if strcmp(h.Diffsel,'LEDDI') && FitBothDet == 0
    if strcmp(h.Detsel,'Detector 1')
        h.PsiFileTableDataDet1(strcmp(h.PsiFileTableDataDet1(:, 2), '0.0000'), :) = [];
        % Set table data
        set(h.tablepsifile,'data',h.PsiFileTableDataDet1);
    elseif strcmp(h.Detsel,'Detector 2')
        h.PsiFileTableDataDet2(strcmp(h.PsiFileTableDataDet2(:, 2), '0.0000'), :) = [];
        % Set table data
        set(h.tablepsifile,'data',h.PsiFileTableDataDet2);
    end
elseif strcmp(h.Diffsel,'LEDDI') && FitBothDet == 1
    if strcmp(h.Detsel,'Detector 1')
        h.PsiFileTableDataDet1(strcmp(h.PsiFileTableDataDet1(:, 2), '0.0000'), :) = [];
        % Set table data
        set(h.tablepsifile,'data',h.PsiFileTableDataDet1);
    elseif strcmp(h.Detsel,'Detector 2')
        h.PsiFileTableDataDet2(strcmp(h.PsiFileTableDataDet2(:, 2), '0.0000'), :) = [];
        % Set table data
        set(h.tablepsifile,'data',h.PsiFileTableDataDet2);
    end
elseif strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    h.PsiFileTableData(strcmp(h.PsiFileTableData(:, 2), '0.0000'), :) = [];
    % Set table data
    set(h.tablepsifile,'data',h.PsiFileTableData);
end

% Messagebox
msgbox('Diffraction Peaks created.');

f = fieldnames(h);
assignin('base','fieldnamesLoadPsi',f)

% assignin('base','PsiFileTableData',h.PsiFileTableData)
% set(h.SliderPlotfitdata1,'callback',{@SliderCallbackPlotfitdata1, h})
% set(h.popupmenuXData1,'callback',{@CallbackpopupmenuXData1, h})
% set(h.popupmenuYData1,'callback',{@CallbackpopupmenuYData1, h})
% set(h.buttonPlotFitData1,'callback',{@buttonPlotFitData1, h})
% set(h.buttonExportFitData1,'callback',{@buttonExportFitData1, h})
% set(h.buttonClearFitData1,'callback',{@buttonClearFitData1, h})

guidata(hObj, h);

function buttoncreatepsi2(hObj, ~)
% Callback for saving psi file
h = guidata(hObj);

Detstr = get(h.popupmenuselectmeas1,'String');
Detval = get(h.popupmenuselectmeas1,'Value');
Detsel = Detstr{Detval};
h.Detsel = Detsel;

% Get value of checkbox "fit data from both detectors"
FitBothDet = get(h.checkboxFitBothDetectors,'value');
% Material
material = h.P.PopupValueMpd1;
% Create new folder in plot folder with name of measurement file
% formatOut = 'ddmmyyyy';
% d = datestr(now, formatOut);
% name = strtrim(h.Measurement(1).MeasurementSeries);
Folder = '\Psi_and_tau_File\';
if ~isfield(h,'PathName')
    formatOut = 'ddmmyyyy';
    d = datestr(now, formatOut);
    name = strtrim(h.Measurement(1).MeasurementSeries);
    material = h.P.PopupValueMpd1;
    if strcmp(h.Diffsel,'LEDDI')
        h.PathName = [General.ProgramInfo.Path,'\Data\Results\LEDDI\',[name,'_',material,'_','added_plots','_',d]];
    elseif strcmp(h.Diffsel,'EDDI')
        h.PathName = [General.ProgramInfo.Path,'\Data\Results\EDDI\',[name,'_',material,'_','added_plots','_',d]];
    elseif strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
        h.PathName = [General.ProgramInfo.Path,'\Data\Results\MetalJet\',[name,'_',material,'_','added_plots','_',d]];    
    end
end

Path = fullfile(h.PathName,Folder);

if exist(Path,'dir') ~= 7
    mkdir(Path);
end

if strcmp(h.Diffsel,'LEDDI') %&& FitBothDet == 0
    if strcmp(h.Detsel,'Detector 1') 
        [FileName,PathName] = uiputfile('*.psi','Save Psi file',[Path,...
                          strtrim(h.Measurement(1).MeasurementSeries),'_',h.Sample.Materials.Name,'_','Det1','_',datestr(now, 'ddmmyyyy')]);
    elseif strcmp(h.Detsel,'Detector 2')
        [FileName,PathName] = uiputfile('*.psi','Save Psi file',[Path,...
                          strtrim(h.Measurement(1).MeasurementSeries),'_',h.Sample.Materials.Name,'_','Det2','_',datestr(now, 'ddmmyyyy')]);
    end
else
    [FileName,PathName] = uiputfile('*.psi','Save Psi file',[Path,...
                          strtrim(h.Measurement(1).MeasurementSeries),'_',h.Sample.Materials.Name,'_',datestr(now, 'ddmmyyyy')]);
end

% If user pressed cancel, abort saving process
if FileName==0
  % user pressed cancel
  return
end

PsiFileName = fullfile(PathName, FileName);

% Function to make "Fit" button blink in red during fitting process
col = get(hObj,'backg');  % Get the background color of the figure.
set(hObj,'str','Saving','backg',[1 .6 .6]) % Change color of button. 
% The pause (or drawnow) is necessary to make button changes appear.
pause(.01)
                  
PsiFileTableData = get(h.tablepsifile,'data');
% Convert cell to array (datestr converts to NaN)
DiffractionLines = str2double(PsiFileTableData);
if h.P.PopupValueFitFunc == 2 || h.P.PopupValueFitFunc == 4 || h.P.PopupValueFitFunc == 5
    %PV-Func
    % Convert date string to date number
    for i = 1:size(PsiFileTableData,1)
        date(:,i) = datenum(PsiFileTableData{i,22},'dd-mm-yyyy-HH-MM-SS');
    end
    % Transpose date data
    date = date';
    % Add date data column to DiffractionLines array
    DiffractionLines(:,22) = date;
elseif h.P.PopupValueFitFunc == 3 %TCH-Func
   % Convert date string to date number
    for i = 1:size(PsiFileTableData,1)
        date(:,i) = datenum(PsiFileTableData{i,25},'dd-mm-yyyy-HH-MM-SS');
    end
    % Transpose date data
    date = date';
    % Add date data column to DiffractionLines array
    DiffractionLines(:,25) = date; 
end

SaveToPsiFileNew(DiffractionLines,PsiFileName,FileName,h.P.PopupValueFitFunc)

% Create new folder in plot folder with name of measurement file
name = strtrim(h.Measurement(1).MeasurementSeries);
Folder = '\RawData\';
formatOut = 'ddmmyyyy';
d = datestr(now, formatOut);
Path = fullfile(h.PathName,Folder);

if exist(Path,'dir') ~= 7
    mkdir(Path);
end

if isfield(h,'RawData')
    for k = 1:size(h.DataTmpBackup, 2)
        XRawDataExport{k} = h.RawData{k}(:, 1);
        YRawDataExport{k} = h.RawData{k}(:, 2);
    end

    for k = 1:size(h.DataTmpBackup, 2)
        fid = fopen([[Path,'\'],name,'_','RawData','_',num2str(k),'_',d,'.dat'],'w');
        fprintf(fid,'%12s %15s \r\n','Energy [keV]','Intensity [cts]');
            fprintf(fid,'%.6f %.6f \n',[XRawDataExport{k} YRawDataExport{k}]');
            fprintf(fid,'\n');
        fclose(fid);
    end
end

% Reset the button color
set(hObj,'str','Save Psi file','backg',col)  % Now reset the button features.

% Messagebox
msgbox('Psi file created.');

guidata(hObj, h);

function buttoncreatepsi3(hObj, ~)
% Callback for open table to select peaks 
h = guidata(hObj);

% Check if peaks where already fitted (in case User clicks on this button
% before peaks were fitted)
if isfield(h,'FittedPeaks') || isfield(h,'FittedPeaksDet1') || isfield(h,'FittedPeaksDet2')
    % Load fit data from fit results table
    FitDatatmp = get(h.tablefitresults,'data');
    % Load energy positions
    EnergyPos = str2double(FitDatatmp(:,3));
    % Check whether peaks where already selected
    if ~isfield(h,'idxSelectPeaktable')
        h.idxSelectPeaktable = logical(ones(length(EnergyPos),1));
    end
%     h.idxSelectPeaktable = logical(ones(length(EnergyPos),1));
    if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
        a = h.TPeaks.T.Peaks(:,5) > h.P.EnergyRange(1) & h.TPeaks.T.Peaks(:,5) < h.P.EnergyRange(2);
        PeaksTheo = h.TPeaks.T.hkl_sort.*a;
        PeaksTheo( ~any(PeaksTheo,2), : ) = [];
        hkltmp = PeaksTheo(h.FitPeaksLogical(:,1),1:3);
    elseif strcmp(h.Diffsel,'LEDDI')
        if strcmp(h.Detsel,'Detector 1')
            a = h.TPeaksDet1.T.Peaks(:,5) > h.P.EnergyRangeDet1(1) & h.TPeaksDet1.T.Peaks(:,5) < h.P.EnergyRangeDet1(2);
            PeaksTheo = h.TPeaksDet1.T.hkl_sort.*a;
            PeaksTheo( ~any(PeaksTheo,2), : ) = [];
            hkltmp = PeaksTheo(h.FitPeaksLogicalDet1(:,1),1:3);
        elseif strcmp(h.Detsel,'Detector 2')
            a = h.TPeaksDet2.T.Peaks(:,5) > h.P.EnergyRangeDet2(1) & h.TPeaksDet2.T.Peaks(:,5) < h.P.EnergyRangeDet2(2);
            PeaksTheo = h.TPeaksDet2.T.hkl_sort.*a;
            PeaksTheo( ~any(PeaksTheo,2), : ) = [];
            hkltmp = PeaksTheo(h.FitPeaksLogicalDet2(:,1),1:3);
        end
    end
    
    n = 1;

    for k = 1:size(EnergyPos,1)
        if h.MinVal(k) >= 0.3
            hkl_table(k,:) = [NaN NaN NaN];
        else
            hkl_table(k,:) = hkltmp(n,:);
            n = n + 1;
        end
    end

    set(h.SelectPeaktable,'data',[num2cell(hkl_table(:,1)) num2cell(hkl_table(:,2)) num2cell(hkl_table(:,3)) num2cell(EnergyPos) num2cell(h.idxSelectPeaktable)])
end    
% Make figure visible
set(h.figSelectPeaktable,'Visible','on')

guidata(hObj, h);

function buttonSelectPeaktableok(hObj, ~, ~)
% Callback for ok click in select peak table figure
h = findobj('Tag','MainGUI');
h1data = guidata(h);
handles1 = guidata(hObj);

% Create handle if it does not already exist in order to prevent error
% message.
if ~isfield(handles1, 'idxSelectPeaktable')
    handles1.idxSelectPeaktable = true(size(h1data.SelectPeaktable.Data,1),1);
end

h1data.idxSelectPeaktable = handles1.idxSelectPeaktable;
h1data.idxkeepPeaks = find(handles1.idxSelectPeaktable == 1);
h1data.idxdeletePeaks = find(handles1.idxSelectPeaktable == 0);

set(h1data.figSelectPeaktable, 'Visible', 'off')

guidata(h, h1data);
guidata(hObj, handles1);

function buttonSelectPeaktablecancel(hObj, ~, ~)
% Callback for 'Cancel' pushbutton
h = findobj('Tag','MainGUI');
h1data = guidata(h);

% Close window
set(h1data.figSelectPeaktable, 'Visible', 'off');
 
guidata(hObj, h);

function celleditcallbackSelectPeaktable(hObj, ~, handles)
% Callback for uitable to select peaks to be used in analysis 
h = handles;

h.SelectPeaktabledata = get(hObj,'data');
h.idxSelectPeaktable = cell2mat(h.SelectPeaktabledata(:,5));

guidata(hObj, h);

function PsiFileTableData_CellEditCallback1(hObj, eventdata, ~)
% Callback for saving selected peaks
h = guidata(hObj);

if ~isempty(eventdata.Indices)
    selectedRow = eventdata.Indices(1);
    PsiFileTableData = get(h.tablepsifile,'data');

    answer = questdlg('Delete this line from psi file?', ...
        'Delete line', ...
        'Yes','No','No');
% Handle response

    switch answer
        case 'Yes'
            PsiFileTableData(selectedRow,:) = [];
            disp([answer ' Line deleted.'])
        case 'No'
            disp([answer ' Deletion cancled.'])
    end

    set(h.tablepsifile,'data',PsiFileTableData);
end

guidata(hObj, h);

function PsiFileTableData_CellEditCallback2(hObj, ~, ~)
% Callback for saving selected peaks
h = guidata(hObj);

guidata(hObj, h);

%% Stress analysis tab
% Enter/load DEK button
function buttonloadDEK(hObj, ~)
% Function to load DEK data.
h = guidata(hObj);

Detstr = get(h.popupmenuselectmeas1,'String');
Detval = get(h.popupmenuselectmeas1,'Value');
Detsel = Detstr{Detval};
h.Detsel = Detsel;

% Set current handle h to callback for buttonDEKtable4
set(h.buttonDEKtable4,'callback',{@buttonDEKtablesave, h})
% Set slier value to 1, otherwise there could be an error if the user does
% change the number of peaks used for stress analysis
set(h.SliderStressData, 'Value',1);

% Set figure visible
set(h.figDEKtable,'Visible','on')
% Option to automatically load the DEK values, if a "DEKListe" with the
% materials name is found in the "Data\Materials\" folder.
% Get material name
MaterialName = h.Sample.Materials.Name;
% Check if "DEKListe" of material exists
IdxMaterial = strcmp(MaterialName,h.MPDFileNameList);
% Root name for DEK file to be loaded
FileRoot = 'DEKListe';
% Get DEK table data
% DEKdatatmp = get(h.loadDEKtable,'data');
DEKdatatmp = zeros(20,5);

if isfield(h,'FitPeaksLogical') || isfield(h,'FitPeaksLogicalDet1') || isfield(h,'FitPeaksLogicalDet2')
    if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
        % Get theoretical peak positions in the user selected energy range
        h.FitPeaksLogicalErange = h.TPeaks.T.Etheo > h.P.EnergyRange(1) & h.TPeaks.T.Etheo < h.P.EnergyRange(2);
        PeaksTheo = h.TPeaks.T.Peaks(h.FitPeaksLogicalErange,1:5);
%         % Compare user selected peaks with theoretical peak positions
%         [CompareFitPeaksLogical,~,~,~] = ComparePeaks(h.Peaks,PeaksTheo(:,5));
%         h.FitPeaksLogical = CompareFitPeaksLogical;
%         assignin('base','PeaksTheo',PeaksTheo)
%         assignin('base','FitPeaksLogical',h.FitPeaksLogical)
        PeaksTmp = PeaksTheo(h.FitPeaksLogical(:,1),1:3);
        EPosTmp = PeaksTheo(h.FitPeaksLogical(:,1),5);
        % Check if peaks where already selected, if yes, use FittedPeaksbkp
        % instead of FittedPeaks
        if isfield(h,'FittedPeaksbkp')
            FittedPeakstmp = h.FittedPeaksbkp;
        else
            h.FittedPeaksbkp = h.FittedPeaks;
            FittedPeakstmp = h.FittedPeaks;
        end
%         assignin('base','hPeaks',h.Peaks)
%         assignin('base','FittedPeakstmp1',FittedPeakstmp)

    elseif strcmp(h.Diffsel,'LEDDI')
        if strcmp(h.Detsel,'Detector 1')
            h.FitPeaksLogicalErangeDet1 = h.TPeaksDet1.T.Etheo > h.P.EnergyRangeDet1(1) & h.TPeaksDet1.T.Etheo < h.P.EnergyRangeDet1(2);
            PeaksTheo = h.TPeaksDet1.T.Peaks(h.FitPeaksLogicalErangeDet1,1:5);
%             assignin('base','FitPeaksLogicalDet1',h.FitPeaksLogicalDet1)
%             PeaksTheo = h.TPeaksDet1.T.Peaks(:,5);
%             PeaksTheo = PeaksTheo.*h.FitPeaksLogicalErangeDet1;
%             PeaksTheo(PeaksTheo==0) = [];
%             [CompareFitPeaksLogical,~,~,~] = ComparePeaks(h.PeaksDet1,PeaksTheo);
%             [CompareFitPeaksLogical,~,~,~] = ComparePeaks(h.PeaksDet1,PeaksTheo(:,5));
%             h.FitPeaksLogicalDet1 = CompareFitPeaksLogical;
            PeaksTmp = PeaksTheo(h.FitPeaksLogicalDet1(:,1),1:3);
            EPosTmp = PeaksTheo(h.FitPeaksLogicalDet1(:,1),5);
%             assignin('base','TPeaks',h.TPeaksDet1.T.Peaks)
%             assignin('base','FitPeaksLogicalErangeDet1',h.FitPeaksLogicalErangeDet1)
%             assignin('base','FitPeaksLogicalDet1',h.FitPeaksLogicalDet1)
%             assignin('base','CompareFitPeaksLogical',CompareFitPeaksLogical)
%             assignin('base','PeaksTheo',PeaksTheo)
%             assignin('base','PeaksDet1',h.PeaksDet1)
            % Check if peaks where already selected, if yes, use
            % FittedPeaksbkpDet1 instead of FittedPeaksDet1
            if isfield(h,'FittedPeaksbkpDet1')
                FittedPeakstmp = h.FittedPeaksbkpDet1;
            else
                h.FittedPeaksbkpDet1 = h.FittedPeaksDet1;
                FittedPeakstmp = h.FittedPeaksDet1;
            end

        elseif strcmp(h.Detsel,'Detector 2')
            h.FitPeaksLogicalErangeDet2 = h.TPeaksDet2.T.Etheo > h.P.EnergyRangeDet2(1) & h.TPeaksDet2.T.Etheo < h.P.EnergyRangeDet2(2);
            PeaksTheo = h.TPeaksDet2.T.Peaks(h.FitPeaksLogicalErangeDet2,1:5);
%             [CompareFitPeaksLogical,~,~,~] = ComparePeaks(h.PeaksDet2,PeaksTheo(:,5));
%             h.FitPeaksLogicalDet2 = CompareFitPeaksLogical;
            PeaksTmp = PeaksTheo(h.FitPeaksLogicalDet2(:,1),1:3);
            EPosTmp = PeaksTheo(h.FitPeaksLogicalDet2(:,1),5);
%             PeaksTheo = h.TPeaksDet2.T.Peaks(:,5);
%             PeaksTheo = PeaksTheo.*h.FitPeaksLogicalErangeDet2;
%             PeaksTheo(PeaksTheo==0) = [];
%             [CompareFitPeaksLogical,~,~,~] = ComparePeaks(h.PeaksDet2,PeaksTheo);
%             h.FitPeaksLogicalDet2 = CompareFitPeaksLogical;
%             PeaksTmp = h.TPeaksDet2.T.Peaks(h.FitPeaksLogicalDet2(:,1),1:3);
%             EPosTmp = h.TPeaksDet2.T.Peaks(h.FitPeaksLogicalDet2(:,1),5);
            % Check if peaks where already selected, if yes, use
            % FittedPeaksbkpDet2 instead of FittedPeaksDet2
            if isfield(h,'FittedPeaksbkpDet2')
                FittedPeakstmp = h.FittedPeaksbkpDet2;
            else
                h.FittedPeaksbkpDet2 = h.FittedPeaksDet2;
                FittedPeakstmp = h.FittedPeaksDet2;
            end
        end
    end
    % Delete user selected lines from h.FittedPeaks
    % If peaks were deselected by the user, delete them from DiffractionLines
    if isfield(h, 'idxkeepPeaks')
        if size(FittedPeakstmp{1},1) ~= size(h.idxkeepPeaks,1)
%             assignin('base','hidxkeepPeaks',h.idxkeepPeaks)
            EPoskeeptmp = FittedPeakstmp{4}(h.idxkeepPeaks,2);
            EPoskeep = mat2cell(EPoskeeptmp',1,size(EPoskeeptmp,1));
%             assignin('base','EPoskeep',EPoskeep)
        else
            % If user clicked on select peaks and did not change the
            % selected peaks
            EPoskeeptmp = FittedPeakstmp{4}(:,2);
            EPoskeep = mat2cell(EPoskeeptmp',1,size(EPoskeeptmp,1));
        end
    else
        EPoskeeptmp = FittedPeakstmp{4}(:,2);
        EPoskeep = mat2cell(EPoskeeptmp',1,size(EPoskeeptmp,1));
    end

    % Compare energy positions of user selected peaks in order to update
    % DEK table
    [CompareFitPeaksLogicalDEK,~,~,~] = ComparePeaks(EPoskeep,EPosTmp);
    h.KeepPeaksDEKLogical = CompareFitPeaksLogicalDEK;
    
%     if length(find(h.FitPeaksLogical==1)) ~= length(find(h.KeepPeaksDEKLogical(:,1)==1))
%         h.KeepPeaksDEKLogical = logical(ones(length(find(h.FitPeaksLogical==1)),3));
%     end
    
%     h.KeepPeaksDEKLogical = PeaksTheo(h.FitPeaksLogical,1:3);
    
%     assignin('base','KeepPeaksDEKLogical',h.KeepPeaksDEKLogical)
    % Delete user deselected peaks from FittedPeaks
    if isfield(h, 'idxdeletePeaks')
        if ~isempty(h.idxdeletePeaks)
            for k = 1:size(FittedPeakstmp,2)
                FittedPeakstmp{1,k}(h.idxdeletePeaks,:) = [];
            end
        end
    end

    % Update FittedPeaks file
    if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
        h.FittedPeaks = FittedPeakstmp;
    elseif strcmp(h.Diffsel,'LEDDI')
        if strcmp(h.Detsel,'Detector 1')
            h.FittedPeaksDet1 = FittedPeakstmp;
        elseif strcmp(h.Detsel,'Detector 2')
            h.FittedPeaksDet2 = FittedPeakstmp;
        end
    end
%     assignin('base','PeaksTmp',PeaksTmp)
    PeaksTmp = [PeaksTmp DEKdatatmp(1:size(PeaksTmp,1),4:5)];
    PeaksTmp = PeaksTmp(h.KeepPeaksDEKLogical(:,1),:);

    set(h.loadDEKtable, 'Data', PeaksTmp)

    if ~isempty(IdxMaterial)
        MatName = h.MPDFileNameList{IdxMaterial};
        FileName = [FileRoot,MatName,'.mat'];
        Path = fullfile('Data','Materials\');
        if exist([Path,FileName], 'file')
            DEKMatFile = load([Path,FileName]);
            DEKdatatmp = get(h.loadDEKtable,'data');
            % Convert hkl from DEKtable to string
            for k = 1:length(DEKdatatmp(:,1))
                hklDEKtmp(k) = DEKdatatmp(k,1)*100 + DEKdatatmp(k,2)*10 + DEKdatatmp(k,3);
            end
            % Transpose vector
            hklDEKtmp = hklDEKtmp';
            % Compare hkl from DEKTable with DEK from file
            for l = 1:length(hklDEKtmp)
                for k = 1:size(DEKMatFile.DEK,1)
                        IndexHittmp{k,l} = strcmp(num2str(hklDEKtmp(l,1)),num2str(DEKMatFile.DEK(k,1)));
                end
            end
            % Convert cell array and create vector
            IndexHittmp = cell2mat(IndexHittmp);
            % Add DEK values to PeaksTmp, if Index returns empty cell, add
            % zeros. In this case, the User has to enter the DEK manually
            for k = 1:size(PeaksTmp,1)
                if isempty(DEKMatFile.DEK(IndexHittmp(:,k),2:3))
                    PeaksTmp(k,4:5) = [0 0];
                else
                    PeaksTmp(k,4:5) = DEKMatFile.DEK(IndexHittmp(:,k),2:3);
                end
            end

            % Set DEK table data
            set(h.loadDEKtable,'data', PeaksTmp)        
        end
    else
        warningMessage = sprintf('Warning: file does not exist:\n%s', MatName);
        uiwait(msgbox(warningMessage));
    end
end

guidata(hObj, h);

function buttonDEKtableok(hObj, ~, handles)
% Callback for updating user selected background points table
% h = guidata(hObj);
h = handles;

set(h.figDEKtable, 'Visible', 'off')
 
guidata(hObj, h);

function buttonDEKtablecancel(hObj, ~, handles)
% Callback for deleting the user input for DEK values
% h = guidata(hObj);
h = handles;

% table = get(h.loadDEKtable,'data');
% 
% table(:,4:5) = 0;
% set(h.loadDEKtable,'data',table)

set(h.figDEKtable, 'Visible', 'off')

guidata(hObj, h);

function buttonDEKtableload(hObj, ~, handles)
% Callback for deleting the user input for DEK values
h = handles;

[baseFileName, folder] = uigetfile('*.mat','Load DEK data',[General.ProgramInfo.Path,'/Data/Materials/']);

% If user pressed cancel, abort saving process
if baseFileName == 0
  % user pressed cancel
  return
end

DEKDataFileName = fullfile(folder, baseFileName);
DEKdata = load(DEKDataFileName);
DEKdatatmp = get(h.loadDEKtable,'data');

for k = 1:length(DEKdatatmp(:,1))
    hklDEKtmp(k) = DEKdatatmp(k,1)*100 + DEKdatatmp(k,2)*10 + DEKdatatmp(k,3);
end

hklDEKtmp = hklDEKtmp';

for l = 1:length(hklDEKtmp)
    for k = 1:size(DEKdata.DEK,1)
			a{k,l} = strcmp(num2str(hklDEKtmp(l,1)),num2str(DEKdata.DEK(k,1)));
    end
end

for k = 1:size(a,2)
	TableDataDEK(k,:) = [a{:,k}]*DEKdata.DEK(:,2:3);
end

DEKdatatmp(:,4:5) = TableDataDEK;

set(h.loadDEKtable,'data', DEKdatatmp)

guidata(hObj, h);

function buttonDEKtablesave(hObj, ~, handles)
% Callback for deleting the user input for DEK values
h = handles;

% Get DEK table data
DEKtmp = get(h.loadDEKtable,'data');
% assignin('base','DEKtmp',DEKtmp)
% Combine columns of hkl values into one column
for k = 1:size(DEKtmp,1)
    hklDEKtmp(k) = DEKtmp(k,1)*100 + DEKtmp(k,2)*10 + DEKtmp(k,3);
end

hklDEKtmp = hklDEKtmp';
% Create new DEK file and save into folder
DEK = [hklDEKtmp DEKtmp(:,4:5)];

uisave('DEK', [General.ProgramInfo.Path,'\Data\Materials\','DEKListe',h.Sample.Materials.Name]);

guidata(hObj, h);

function celleditcallbackDEKtable(hObj, ~, handles)
% Callback for updating user selected background points table 
h = handles;

h.dataDEKtable = get(hObj,'data');

guidata(hObj, h);

%% Load/modify stress data
function buttonloadstressdata(hObj, ~)
% Function to load data for the "Stress Analysis" tab.
h = guidata(hObj);

% Get value of checkbox "fit data from both detectors"
FitBothDet = get(h.checkboxFitBothDetectors,'value');
% Slidersteps
SliderstepsDet1 = 2:2:length(h.Measurement);
SliderstepsDet2 = 1:2:length(h.Measurement);

Detstr = get(h.popupmenuselectmeas1,'String');
Detval = get(h.popupmenuselectmeas1,'Value');
Detsel = Detstr{Detval};
h.Detsel = Detsel;

if isfield(h, 'YlimChanged') && size(h.YlimChanged,2) ~= h.SliderPlotStressData.Max
        h.YlimChanged = zeros(1,h.SliderPlotStressData.Max);
        h.YlimMinnew = zeros(1,h.SliderPlotStressData.Max);
        h.YlimMaxnew = zeros(1,h.SliderPlotStressData.Max);
        h.YlimYTicknew = zeros(1,h.SliderPlotStressData.Max);
end

if isfield(h, 'XlimChanged') && size(h.XlimChanged,2) ~= h.SliderPlotStressData.Max
        h.XlimChanged = zeros(1,h.SliderPlotStressData.Max);
        h.XlimMinnew = zeros(1,h.SliderPlotStressData.Max);
        h.XlimMaxnew = zeros(1,h.SliderPlotStressData.Max);
        h.XlimYTicknew = zeros(1,h.SliderPlotStressData.Max);
end

% Function to make "Fit" button blink in red during fitting process
col = get(hObj,'backg');  % Get the background color of the figure.
set(hObj,'str','Loading stress data','backg',[1 .6 .6]) % Change color of button. 
% The pause (or drawnow) is necessary to make button changes appear.
pause(.01)

%% Plot window d-spacing, IB and Int.Int

% Get slider value
set(h.SliderStressData, 'Value',1);
valueSlider = get(h.SliderStressData, 'Value');

% Load "DiffractionLines" variable, depending on diffractometer used
if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    % Change slider parameters according to number of FittedPeaks
    DiffractionLinestmp = h.DiffractionLines;
elseif strcmp(h.Diffsel,'LEDDI')
    if strcmp(h.Detsel,'Detector 1')
        % Change slider parameters according to number of FittedPeaksDet1
        DiffractionLinestmp = h.DiffractionLinesDet1;
    elseif strcmp(h.Detsel,'Detector 2')
        % Change slider parameters according to number of FittedPeaksDet2
        DiffractionLinestmp = h.DiffractionLinesDet2;
    end
end

% Get index from peaks to be kept
if isfield(h, 'idxkeepPeaks')
    idxkeepPeaks = h.idxkeepPeaks;
else
    % If idxkeepPeaks does not exist, use size of "DiffractionLinestmp"
    % instead.
    idxkeepPeaks = (1:size(DiffractionLinestmp{1},2))';
end


% % Get index from peaks to be kept
% % idxkeepPeaks = getappdata(0,'idxkeepPeaks');
% idxkeepPeaks = h.idxkeepPeaks;
% % If idxkeepPeaks is empty, use size of "DiffractionLinestmp" instead
% if isempty(idxkeepPeaks)
%     idxkeepPeaks = 1:size(DiffractionLinestmp{1},2);
% end

if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    % Change slider parameters according to number of FittedPeaks
    if size(h.FittedPeaks{1,1},1) == 1
        set(h.SliderStressData,'Min',0);
        set(h.SliderStressData,'Max',size(idxkeepPeaks,1));
        set(h.SliderStressData,'SliderStep',[1 1]);
    else
        set(h.SliderStressData,'Min',1);
        set(h.SliderStressData,'Max',size(idxkeepPeaks,1));
        set(h.SliderStressData,'SliderStep',[1/(size(idxkeepPeaks,1)-1) 1/(size(idxkeepPeaks,1)-1)]);
    end
elseif strcmp(h.Diffsel,'LEDDI')
    if strcmp(h.Detsel,'Detector 1')
        % Change slider parameters according to number of FittedPeaksDet1
        if size(h.FittedPeaksDet1{1,1},1) == 1
            set(h.SliderStressData,'Min',0);
            set(h.SliderStressData,'Max',size(h.FittedPeaksDet1{1,1},1));
            set(h.SliderStressData,'SliderStep',[1 1]);
        else
            set(h.SliderStressData,'Min',1);
            set(h.SliderStressData,'Max',size(h.FittedPeaksDet1{1,1},1));
            set(h.SliderStressData,'SliderStep',[1/(size(h.FittedPeaksDet1{1,1},1)-1) 1/(size(h.FittedPeaksDet1{1,1},1)-1)]);
        end
    elseif strcmp(h.Detsel,'Detector 2')
        % Change slider parameters according to number of FittedPeaksDet2
        if size(h.FittedPeaksDet2{1,1},1) == 1
            set(h.SliderStressData,'Min',0);
            set(h.SliderStressData,'Max',size(h.FittedPeaksDet2{1,1},1));
            set(h.SliderStressData,'SliderStep',[1 1]);
        else
            set(h.SliderStressData,'Min',1);
            set(h.SliderStressData,'Max',size(h.FittedPeaksDet2{1,1},1));
            set(h.SliderStressData,'SliderStep',[1/(size(h.FittedPeaksDet2{1,1},1)-1) 1/(size(h.FittedPeaksDet2{1,1},1)-1)]);
        end
    end
end

% Load parameters needed to calculate and plot stresses
% Convert cell array of, strings to cell array of double
PsiFileTableData = get(h.tablepsifile,'data');

PsiFileTableDataArray = cellfun(@str2num, PsiFileTableData);
% Find unique values in column 1 from PsiFileTableDataArray
[C,~,~] = unique(PsiFileTableDataArray(:,1));
% Get row index containing unique C 
indexUniquePeak = cell(1);

for k = 1:length(C)
    indexUniquePeak{k} = find(PsiFileTableDataArray(:,1) == C(k));
end
% Get index from peak to be kept during further analysis
indexPeakToKeep = cell(1);
for k = 1:length(C)
    if h.P.PopupValueFitFunc == 2 || h.P.PopupValueFitFunc == 4 || h.P.PopupValueFitFunc == 5
        %PV-Func
        indexPeakToKeep{k} = PsiFileTableDataArray(indexUniquePeak{k},23);
    elseif h.P.PopupValueFitFunc == 3 %TCH-Func
        indexPeakToKeep{k} = PsiFileTableDataArray(indexUniquePeak{k},26);
    end
end

% Delete field if already present, in case of reloading stress data with
% different number of peaks
if isfield(h, 'Params')
    h = rmfield(h,'Params');
end

% Get parameters from fitted peak data
for m = 1:size(idxkeepPeaks,1)
    for k = 1:length(indexPeakToKeep{m})
        % Read in Emax
        h.Params.Energy_Max{m}(k,:) = DiffractionLinestmp{indexPeakToKeep{m}(k),1}(1,idxkeepPeaks(m)).Energy_Max;
        % Read in FWHM
        h.Params.FWHM{m}(k,:) = DiffractionLinestmp{indexPeakToKeep{m}(k),1}(1,idxkeepPeaks(m)).FWHM;
        % Read in IB
        h.Params.IntegralWidth{m}(k,:) = DiffractionLinestmp{indexPeakToKeep{m}(k),1}(1,idxkeepPeaks(m)).IntegralWidth;
        % Read in IntensityInt
        h.Params.Intensity_Int{m}(k,:) = DiffractionLinestmp{indexPeakToKeep{m}(k),1}(1,idxkeepPeaks(m)).Intensity_Int;
        % Read in IntensityMax
        h.Params.Intensity_Max{m}(k,:) = DiffractionLinestmp{indexPeakToKeep{m}(k),1}(1,idxkeepPeaks(m)).Intensity_Max;
        % Read in d-spacing
        h.Params.LatticeSpacing{m}(k,:) = DiffractionLinestmp{indexPeakToKeep{m}(k),1}(1,idxkeepPeaks(m)).LatticeSpacing;
        % Read in d-spacing error
        h.Params.LatticeSpacing_Delta{m}(k,:) = DiffractionLinestmp{indexPeakToKeep{m}(k),1}(1,idxkeepPeaks(m)).LatticeSpacing_Delta;
        % Read in psi Winkel
        h.Params.Psi_Winkel{m}(k,:) = DiffractionLinestmp{indexPeakToKeep{m}(k),1}(1,idxkeepPeaks(m)).SCSAngles.psi;
        % Read in phi Winkel
        h.Params.Phi_Winkel{m}(k,:) = DiffractionLinestmp{indexPeakToKeep{m}(k),1}(1,idxkeepPeaks(m)).SCSAngles.phi;
    end
end
% assignin('base','indexPeakToKeep',indexPeakToKeep)
% assignin('base','idxkeepPeaks',idxkeepPeaks)
% If measured under more than one phi angle, rearrange data
for k = 1:size(h.Params.Phi_Winkel,2)
	[PhiWinkel{k},ia{k},~] = unique(h.Params.Phi_Winkel{k});
end

% Delete previous plots (if  present) in order to update the plot
if ~ismember(0,PhiWinkel{1})
    set(h.plotdatadspacingphi0,'visible', 'off')
    set(h.plotreglinedspacingphi0,'visible', 'off')
    set(h.plotdataIBphi0,'visible', 'off')
    set(h.plotdataIntphi0,'visible', 'off')
else
    set(h.plotdatadspacingphi0,'visible', 'on')
    set(h.plotreglinedspacingphi0,'visible', 'on')
    set(h.plotdataIBphi0,'visible', 'on')
    set(h.plotdataIntphi0,'visible', 'on')
end

if ~ismember(90,PhiWinkel{1})
    set(h.plotdatadspacingphi90,'visible', 'off')
    set(h.plotreglinedspacingphi90,'visible', 'off')
    set(h.plotdataIBphi90,'visible', 'off')
    set(h.plotdataIntphi90,'visible', 'off')
else
    set(h.plotdatadspacingphi90,'visible', 'on')
    set(h.plotreglinedspacingphi90,'visible', 'on')
    set(h.plotdataIBphi90,'visible', 'on')
    set(h.plotdataIntphi90,'visible', 'on')

end

if ~ismember(180,PhiWinkel{1})
    set(h.plotdatadspacingphi180,'visible', 'off')
    set(h.plotreglinedspacingphi180,'visible', 'off')
    set(h.plotdataIBphi180,'visible', 'off')
    set(h.plotdataIntphi180,'visible', 'off')
else
    set(h.plotdatadspacingphi180,'visible', 'on')
    set(h.plotreglinedspacingphi180,'visible', 'on')
    set(h.plotdataIBphi180,'visible', 'on')
    set(h.plotdataIntphi180,'visible', 'on')
end

if ~ismember(270,PhiWinkel{1})
    set(h.plotdatadspacingphi270,'visible', 'off')
    set(h.plotreglinedspacingphi270,'visible', 'off')
    set(h.plotdataIBphi270,'visible', 'off')
    set(h.plotdataIntphi270,'visible', 'off')
else
    set(h.plotdatadspacingphi270,'visible', 'on')
    set(h.plotreglinedspacingphi270,'visible', 'on')
    set(h.plotdataIBphi270,'visible', 'on')
    set(h.plotdataIntphi270,'visible', 'on')
end

% Delete field if already present, in case of reloading stress data with
% different number of peaks
if isfield(h, 'ParamsToFit')
    h = rmfield(h,'ParamsToFit');
end

% Distinction between measurements under different phi angles
if length(ia{1}) == 2
    % Measurements performed under two different phi angles
    for j = 1:length(ia{1})
        for k = 1:size(h.Params.Energy_Max,2)
            if j ~= 2
                % Read in Emax
                h.ParamsToFit(j).Energy_Max{k} = h.Params.Energy_Max{k}(ia{k}(j):ia{k}(j+1)-1);
                % Read in FWHM
                h.ParamsToFit(j).FWHM{k} = h.Params.FWHM{k}(ia{k}(j):ia{k}(j+1)-1);
                % Read in IB
                h.ParamsToFit(j).IntegralWidth{k} = h.Params.IntegralWidth{k}(ia{k}(j):ia{k}(j+1)-1);
                % Read in Intensity
                h.ParamsToFit(j).Intensity_Int{k} = h.Params.Intensity_Int{k}(ia{k}(j):ia{k}(j+1)-1);
                % Read in d-spacing
                h.ParamsToFit(j).LatticeSpacing{k} = h.Params.LatticeSpacing{k}(ia{k}(j):ia{k}(j+1)-1);
                % Read in d-spacing error
                h.ParamsToFit(j).LatticeSpacing_Delta{k} = h.Params.LatticeSpacing_Delta{k}(ia{k}(j):ia{k}(j+1)-1);
                % Read in psi Winkel
                h.ParamsToFit(j).Psi_Winkel{k} = h.Params.Psi_Winkel{k}(ia{k}(j):ia{k}(j+1)-1);
                % Read in phi Winkel
                h.ParamsToFit(j).Phi_Winkel{k} = h.Params.Phi_Winkel{k}(ia{k}(j):ia{k}(j+1)-1);
            elseif j == 2
                % Read in Emax
                h.ParamsToFit(j).Energy_Max{k} = h.Params.Energy_Max{k}(ia{k}(j):end);
                % Read in FWHM
                h.ParamsToFit(j).FWHM{k} = h.Params.FWHM{k}(ia{k}(j):end);
                % Read in IB
                h.ParamsToFit(j).IntegralWidth{k} = h.Params.IntegralWidth{k}(ia{k}(j):end);
                % Read in Intensity
                h.ParamsToFit(j).Intensity_Int{k} = h.Params.Intensity_Int{k}(ia{k}(j):end);
                % Read in d-spacing
                h.ParamsToFit(j).LatticeSpacing{k} = h.Params.LatticeSpacing{k}(ia{k}(j):end);
                % Read in d-spacing error
                h.ParamsToFit(j).LatticeSpacing_Delta{k} = h.Params.LatticeSpacing_Delta{k}(ia{k}(j):end);
                % Read in psi Winkel
                h.ParamsToFit(j).Psi_Winkel{k} = h.Params.Psi_Winkel{k}(ia{k}(j):end);
                % Read in phi Winkel
                h.ParamsToFit(j).Phi_Winkel{k} = h.Params.Phi_Winkel{k}(ia{k}(j):end);
            end
        end
    end
elseif length(ia{1}) == 3
    % Measurements performed under three different phi angles
    for j = 1:length(ia{1})
        for k = 1:size(h.Params.Energy_Max,2)
            if j ~= 3
                % Read in Emax
                h.ParamsToFit(j).Energy_Max{k} = h.Params.Energy_Max{k}(ia{k}(j):ia{k}(j+1)-1);
                % Read in FWHM
                h.ParamsToFit(j).FWHM{k} = h.Params.FWHM{k}(ia{k}(j):ia{k}(j+1)-1);
                % Read in IB
                h.ParamsToFit(j).IntegralWidth{k} = h.Params.IntegralWidth{k}(ia{k}(j):ia{k}(j+1)-1);
                % Read in Intensity
                h.ParamsToFit(j).Intensity_Int{k} = h.Params.Intensity_Int{k}(ia{k}(j):ia{k}(j+1)-1);
                % Read in d-spacing
                h.ParamsToFit(j).LatticeSpacing{k} = h.Params.LatticeSpacing{k}(ia{k}(j):ia{k}(j+1)-1);
                % Read in d-spacing error
                h.ParamsToFit(j).LatticeSpacing_Delta{k} = h.Params.LatticeSpacing_Delta{k}(ia{k}(j):ia{k}(j+1)-1);
                % Read in psi Winkel
                h.ParamsToFit(j).Psi_Winkel{k} = h.Params.Psi_Winkel{k}(ia{k}(j):ia{k}(j+1)-1);
                % Read in phi Winkel
                h.ParamsToFit(j).Phi_Winkel{k} = h.Params.Phi_Winkel{k}(ia{k}(j):ia{k}(j+1)-1);
            elseif j == 3
                % Read in Emax
                h.ParamsToFit(j).Energy_Max{k} = h.Params.Energy_Max{k}(ia{k}(j):end);
                % Read in FWHM
                h.ParamsToFit(j).FWHM{k} = h.Params.FWHM{k}(ia{k}(j):end);
                % Read in IB
                h.ParamsToFit(j).IntegralWidth{k} = h.Params.IntegralWidth{k}(ia{k}(j):end);
                % Read in Intensity
                h.ParamsToFit(j).Intensity_Int{k} = h.Params.Intensity_Int{k}(ia{k}(j):end);
                % Read in d-spacing
                h.ParamsToFit(j).LatticeSpacing{k} = h.Params.LatticeSpacing{k}(ia{k}(j):end);
                % Read in d-spacing error
                h.ParamsToFit(j).LatticeSpacing_Delta{k} = h.Params.LatticeSpacing_Delta{k}(ia{k}(j):end);
                % Read in psi Winkel
                h.ParamsToFit(j).Psi_Winkel{k} = h.Params.Psi_Winkel{k}(ia{k}(j):end);
                % Read in phi Winkel
                h.ParamsToFit(j).Phi_Winkel{k} = h.Params.Phi_Winkel{k}(ia{k}(j):end);
            end
        end
    end
elseif length(ia{1}) == 4
    % Measurements performed under four different phi angles
    for j = 1:length(ia{1})
        for k = 1:size(h.Params.Energy_Max,2)
            if j ~= 4
                % Read in Emax
                h.ParamsToFit(j).Energy_Max{k} = h.Params.Energy_Max{k}(ia{k}(j):ia{k}(j+1)-1);
                % Read in FWHM
                h.ParamsToFit(j).FWHM{k} = h.Params.FWHM{k}(ia{k}(j):ia{k}(j+1)-1);
                % Read in IB
                h.ParamsToFit(j).IntegralWidth{k} = h.Params.IntegralWidth{k}(ia{k}(j):ia{k}(j+1)-1);
                % Read in Intensity
                h.ParamsToFit(j).Intensity_Int{k} = h.Params.Intensity_Int{k}(ia{k}(j):ia{k}(j+1)-1);
                % Read in d-spacing
                h.ParamsToFit(j).LatticeSpacing{k} = h.Params.LatticeSpacing{k}(ia{k}(j):ia{k}(j+1)-1);
                % Read in d-spacing error
                h.ParamsToFit(j).LatticeSpacing_Delta{k} = h.Params.LatticeSpacing_Delta{k}(ia{k}(j):ia{k}(j+1)-1);
                % Read in psi Winkel
                h.ParamsToFit(j).Psi_Winkel{k} = h.Params.Psi_Winkel{k}(ia{k}(j):ia{k}(j+1)-1);
                % Read in phi Winkel
                h.ParamsToFit(j).Phi_Winkel{k} = h.Params.Phi_Winkel{k}(ia{k}(j):ia{k}(j+1)-1);
            elseif j == 4
                % Read in Emax
                h.ParamsToFit(j).Energy_Max{k} = h.Params.Energy_Max{k}(ia{k}(j):end);
                % Read in FWHM
                h.ParamsToFit(j).FWHM{k} = h.Params.FWHM{k}(ia{k}(j):end);
                % Read in IB
                h.ParamsToFit(j).IntegralWidth{k} = h.Params.IntegralWidth{k}(ia{k}(j):end);
                % Read in Intensity
                h.ParamsToFit(j).Intensity_Int{k} = h.Params.Intensity_Int{k}(ia{k}(j):end);
                % Read in d-spacing
                h.ParamsToFit(j).LatticeSpacing{k} = h.Params.LatticeSpacing{k}(ia{k}(j):end);
                % Read in d-spacing error
                h.ParamsToFit(j).LatticeSpacing_Delta{k} = h.Params.LatticeSpacing_Delta{k}(ia{k}(j):end);
                % Read in psi Winkel
                h.ParamsToFit(j).Psi_Winkel{k} = h.Params.Psi_Winkel{k}(ia{k}(j):end);
                % Read in phi Winkel
                h.ParamsToFit(j).Phi_Winkel{k} = h.Params.Phi_Winkel{k}(ia{k}(j):end);
            end
        end
    end
end
% Interpolate lattice spacings, in order to be able to average even if the
% number of lattice spacings is not equal (required only if under more than
% one phi angle was measured)

% Delete field if already present, in case of reloading stress data with
% different number of peaks
if isfield(h, 'PsiforInterpoltmp1')
    h = rmfield(h,'PsiforInterpoltmp1');
    h = rmfield(h,'PsiforInterpoltmp2');
    h = rmfield(h,'PsiforInterpol');
end

if length(ia{1}) ~= 1
    for j = 1:size(h.ParamsToFit,2)
        for k = 1:size(h.ParamsToFit(j).LatticeSpacing,2)
            h.PsiforInterpoltmp1{j,k} = h.ParamsToFit(j).Psi_Winkel{k};
        end
    end
    
    for k = 1:size(h.ParamsToFit(j).LatticeSpacing,2)
        h.PsiforInterpoltmp2 = h.PsiforInterpoltmp1(:,k);
        h.PsiforInterpol{k} = unique(cell2mat(h.PsiforInterpoltmp2));
    end
else
    h.PsiforInterpol = h.Params.Psi_Winkel;
end
% assignin('base','PsiforInterpol',h.PsiforInterpol)
if length(ia{1}) ~= 1
    for j = 1:size(h.ParamsToFit,2)
        for k = 1:size(h.ParamsToFit(j).LatticeSpacing,2)
                h.ParamsToFit(j).LatticeSpacingInterpol{k} = interp1(h.ParamsToFit(j).Psi_Winkel{k},h.ParamsToFit(j).LatticeSpacing{k},h.PsiforInterpol{k},'linear','extrap');
                h.ParamsToFit(j).LatticeSpacing_DeltaInterpol{k} = interp1(h.ParamsToFit(j).Psi_Winkel{k},h.ParamsToFit(j).LatticeSpacing_Delta{k},h.PsiforInterpol{k},'linear','extrap');
        end
    end
elseif length(ia{1}) == 1   
    for k = 1:size(h.Params.LatticeSpacing,2)
            h.Params.LatticeSpacingInterpol{k} = h.Params.LatticeSpacing{k};
            h.Params.LatticeSpacing_DeltaInterpol{k} = h.Params.LatticeSpacing_Delta{k};
    end
end

% Find indices of phi angles.
h.idxphi0 = find(PhiWinkel{1}==0);
h.idxphi90 = find(PhiWinkel{1}==90);
h.idxphi180 = find(PhiWinkel{1}==180);
h.idxphi270 = find(PhiWinkel{1}==270);
% Delete field if already present, in case of reloading stress data with
% different number of peaks
if isfield(h, 'sin2psi')
    h = rmfield(h,'sin2psi');
end
% assignin('base','Params',h.Params)
% Create vectors with dspacings according to the number of phi angles used
% in the measurement
if ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
    % sigma11 || sigma22
    h.sin2psi.dphi0 = h.Params.LatticeSpacingInterpol;
    h.sin2psi.dphi90 = h.Params.LatticeSpacingInterpol;
    h.sin2psi.dphi180 = h.Params.LatticeSpacingInterpol;
    h.sin2psi.dphi270 = h.Params.LatticeSpacingInterpol;
    h.sin2psi.dphi0delta = h.Params.LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi90delta = h.Params.LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi180delta = h.Params.LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi270delta = h.Params.LatticeSpacing_DeltaInterpol;
    set(h.checkboxphi0,'Value',1)
    set(h.checkboxphi0,'Enable','on')
    set(h.checkboxphi90,'Value',0)
    set(h.checkboxphi90,'Enable','off')
    set(h.checkboxphi180,'Value',0)
    set(h.checkboxphi180,'Enable','off')
    set(h.checkboxphi270,'Value',0)
    set(h.checkboxphi270,'Enable','off')
elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
    % sigma11 || sigma22
    h.sin2psi.dphi0 = h.Params.LatticeSpacingInterpol;
    h.sin2psi.dphi90 = h.Params.LatticeSpacingInterpol;
    h.sin2psi.dphi180 = h.Params.LatticeSpacingInterpol;
    h.sin2psi.dphi270 = h.Params.LatticeSpacingInterpol;
    h.sin2psi.dphi0delta = h.Params.LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi90delta = h.Params.LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi180delta = h.Params.LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi270delta = h.Params.LatticeSpacing_DeltaInterpol;
    set(h.checkboxphi0,'Value',0)
    set(h.checkboxphi0,'Enable','off')
    set(h.checkboxphi90,'Value',1)
    set(h.checkboxphi90,'Enable','on')
    set(h.checkboxphi180,'Value',0)
    set(h.checkboxphi180,'Enable','off')
    set(h.checkboxphi270,'Value',0)
    set(h.checkboxphi270,'Enable','off')
elseif isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
    % sigma11 || sigma22
    h.sin2psi.dphi0 = h.Params.LatticeSpacingInterpol;
    h.sin2psi.dphi90 = h.Params.LatticeSpacingInterpol;
    h.sin2psi.dphi180 = h.Params.LatticeSpacingInterpol;
    h.sin2psi.dphi270 = h.Params.LatticeSpacingInterpol;
    h.sin2psi.dphi0delta = h.Params.LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi90delta = h.Params.LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi180delta = h.Params.LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi270delta = h.Params.LatticeSpacing_DeltaInterpol;
    set(h.checkboxphi0,'Value',0)
    set(h.checkboxphi0,'Enable','off')
    set(h.checkboxphi90,'Value',0)
    set(h.checkboxphi90,'Enable','off')
    set(h.checkboxphi180,'Value',1)
    set(h.checkboxphi180,'Enable','on')
    set(h.checkboxphi270,'Value',0)
    set(h.checkboxphi270,'Enable','off')
elseif isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
    % sigma11 || sigma22
    h.sin2psi.dphi0 = h.Params.LatticeSpacingInterpol;
    h.sin2psi.dphi90 = h.Params.LatticeSpacingInterpol;
    h.sin2psi.dphi180 = h.Params.LatticeSpacingInterpol;
    h.sin2psi.dphi270 = h.Params.LatticeSpacingInterpol;
    h.sin2psi.dphi0delta = h.Params.LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi90delta = h.Params.LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi180delta = h.Params.LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi270delta = h.Params.LatticeSpacing_DeltaInterpol;
    set(h.checkboxphi0,'Value',0)
    set(h.checkboxphi0,'Enable','off')
    set(h.checkboxphi90,'Value',0)
    set(h.checkboxphi90,'Enable','off')
    set(h.checkboxphi180,'Value',0)
    set(h.checkboxphi180,'Enable','off')
    set(h.checkboxphi270,'Value',1)
    set(h.checkboxphi270,'Enable','on')     
elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
    % sigma11 + sigma22
    h.sin2psi.dphi0 = h.ParamsToFit(h.idxphi0).LatticeSpacingInterpol;
    h.sin2psi.dphi90 = h.ParamsToFit(h.idxphi90).LatticeSpacingInterpol;
    h.sin2psi.dphi180 = h.ParamsToFit(h.idxphi0).LatticeSpacingInterpol;
    h.sin2psi.dphi270 = h.ParamsToFit(h.idxphi90).LatticeSpacingInterpol;
    h.sin2psi.dphi0delta = h.ParamsToFit(h.idxphi0).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi90delta = h.ParamsToFit(h.idxphi90).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi180delta = h.ParamsToFit(h.idxphi0).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi270delta = h.ParamsToFit(h.idxphi90).LatticeSpacing_DeltaInterpol;
    set(h.checkboxphi0,'Value',1)
    set(h.checkboxphi0,'Enable','on')
    set(h.checkboxphi90,'Value',1)
    set(h.checkboxphi90,'Enable','on')
    set(h.checkboxphi180,'Value',0)
    set(h.checkboxphi180,'Enable','off')
    set(h.checkboxphi270,'Value',0)
    set(h.checkboxphi270,'Enable','off')
elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
    % sigma11 + sigma22
    h.sin2psi.dphi0 = h.ParamsToFit(h.idxphi180).LatticeSpacingInterpol;
    h.sin2psi.dphi90 = h.ParamsToFit(h.idxphi90).LatticeSpacingInterpol;
    h.sin2psi.dphi180 = h.ParamsToFit(h.idxphi180).LatticeSpacingInterpol;
    h.sin2psi.dphi270 = h.ParamsToFit(h.idxphi90).LatticeSpacingInterpol;
    h.sin2psi.dphi0delta = h.ParamsToFit(h.idxphi180).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi90delta = h.ParamsToFit(h.idxphi90).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi180delta = h.ParamsToFit(h.idxphi180).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi270delta = h.ParamsToFit(h.idxphi90).LatticeSpacing_DeltaInterpol;
    set(h.checkboxphi0,'Value',0)
    set(h.checkboxphi0,'Enable','off')
    set(h.checkboxphi90,'Value',1)
    set(h.checkboxphi90,'Enable','on')
    set(h.checkboxphi180,'Value',1)
    set(h.checkboxphi180,'Enable','on')
    set(h.checkboxphi270,'Value',0)
    set(h.checkboxphi270,'Enable','off')
elseif isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
    % sigma11 + sigma22
    h.sin2psi.dphi0 = h.ParamsToFit(h.idxphi180).LatticeSpacingInterpol;
    h.sin2psi.dphi90 = h.ParamsToFit(h.idxphi270).LatticeSpacingInterpol;
    h.sin2psi.dphi180 = h.ParamsToFit(h.idxphi180).LatticeSpacingInterpol;
    h.sin2psi.dphi270 = h.ParamsToFit(h.idxphi270).LatticeSpacingInterpol;
    h.sin2psi.dphi0delta = h.ParamsToFit(h.idxphi180).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi90delta = h.ParamsToFit(h.idxphi270).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi180delta = h.ParamsToFit(h.idxphi180).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi270delta = h.ParamsToFit(h.idxphi270).LatticeSpacing_DeltaInterpol;
    set(h.checkboxphi0,'Value',0)
    set(h.checkboxphi0,'Enable','off')
    set(h.checkboxphi90,'Value',0)
    set(h.checkboxphi90,'Enable','off')
    set(h.checkboxphi180,'Value',1)
    set(h.checkboxphi180,'Enable','on')
    set(h.checkboxphi270,'Value',1)
    set(h.checkboxphi270,'Enable','on')
elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
    % sigma11 + sigma22
    h.sin2psi.dphi0 = h.ParamsToFit(h.idxphi0).LatticeSpacingInterpol;
    h.sin2psi.dphi90 = h.ParamsToFit(h.idxphi270).LatticeSpacingInterpol;
    h.sin2psi.dphi180 = h.ParamsToFit(h.idxphi0).LatticeSpacingInterpol;
    h.sin2psi.dphi270 = h.ParamsToFit(h.idxphi270).LatticeSpacingInterpol;
    h.sin2psi.dphi0delta = h.ParamsToFit(h.idxphi0).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi90delta = h.ParamsToFit(h.idxphi270).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi180delta = h.ParamsToFit(h.idxphi0).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi270delta = h.ParamsToFit(h.idxphi270).LatticeSpacing_DeltaInterpol;
    set(h.checkboxphi0,'Value',1)
    set(h.checkboxphi0,'Enable','on')
    set(h.checkboxphi90,'Value',0)
    set(h.checkboxphi90,'Enable','off')
    set(h.checkboxphi180,'Value',0)
    set(h.checkboxphi180,'Enable','off')
    set(h.checkboxphi270,'Value',1)
    set(h.checkboxphi270,'Enable','on')
elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
    % sigma11 + sigma13
    h.sin2psi.dphi0 = h.ParamsToFit(h.idxphi0).LatticeSpacingInterpol;
    h.sin2psi.dphi90 = h.ParamsToFit(h.idxphi0).LatticeSpacingInterpol;
    h.sin2psi.dphi180 = h.ParamsToFit(h.idxphi180).LatticeSpacingInterpol;
    h.sin2psi.dphi270 = h.ParamsToFit(h.idxphi180).LatticeSpacingInterpol;
    h.sin2psi.dphi0delta = h.ParamsToFit(h.idxphi0).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi90delta = h.ParamsToFit(h.idxphi0).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi180delta = h.ParamsToFit(h.idxphi180).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi270delta = h.ParamsToFit(h.idxphi180).LatticeSpacing_DeltaInterpol;
    set(h.checkboxphi0,'Value',1)
    set(h.checkboxphi0,'Enable','on')
    set(h.checkboxphi90,'Value',0)
    set(h.checkboxphi90,'Enable','off')
    set(h.checkboxphi180,'Value',1)
    set(h.checkboxphi180,'Enable','on')
    set(h.checkboxphi270,'Value',0)
    set(h.checkboxphi270,'Enable','off')
elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
    % sigma22 + sigma23
    h.sin2psi.dphi0 = h.ParamsToFit(h.idxphi90).LatticeSpacingInterpol;
    h.sin2psi.dphi90 = h.ParamsToFit(h.idxphi90).LatticeSpacingInterpol;
    h.sin2psi.dphi180 = h.ParamsToFit(h.idxphi270).LatticeSpacingInterpol;
    h.sin2psi.dphi270 = h.ParamsToFit(h.idxphi270).LatticeSpacingInterpol;
    h.sin2psi.dphi0delta = h.ParamsToFit(h.idxphi90).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi90delta = h.ParamsToFit(h.idxphi90).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi180delta = h.ParamsToFit(h.idxphi270).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi270delta = h.ParamsToFit(h.idxphi270).LatticeSpacing_DeltaInterpol;
    set(h.checkboxphi0,'Value',0)
    set(h.checkboxphi0,'Enable','off')
    set(h.checkboxphi90,'Value',1)
    set(h.checkboxphi90,'Enable','on')
    set(h.checkboxphi180,'Value',0)
    set(h.checkboxphi180,'Enable','off')
    set(h.checkboxphi270,'Value',1)
    set(h.checkboxphi270,'Enable','on')
elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
    % sigma11 + sigma13 + sigma22
    h.sin2psi.dphi0 = h.ParamsToFit(h.idxphi0).LatticeSpacingInterpol;
    h.sin2psi.dphi90 = h.ParamsToFit(h.idxphi270).LatticeSpacingInterpol;
    h.sin2psi.dphi180 = h.ParamsToFit(h.idxphi180).LatticeSpacingInterpol;
    h.sin2psi.dphi270 = h.ParamsToFit(h.idxphi270).LatticeSpacingInterpol;
    h.sin2psi.dphi0delta = h.ParamsToFit(h.idxphi0).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi90delta = h.ParamsToFit(h.idxphi270).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi180delta = h.ParamsToFit(h.idxphi180).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi270delta = h.ParamsToFit(h.idxphi270).LatticeSpacing_DeltaInterpol;
    set(h.checkboxphi0,'Value',1)
    set(h.checkboxphi0,'Enable','on')
    set(h.checkboxphi90,'Value',0)
    set(h.checkboxphi90,'Enable','off')
    set(h.checkboxphi180,'Value',1)
    set(h.checkboxphi180,'Enable','on')
    set(h.checkboxphi270,'Value',1)
    set(h.checkboxphi270,'Enable','on')
elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
    % sigma11 + sigma13 + sigma22
    h.sin2psi.dphi0 = h.ParamsToFit(h.idxphi0).LatticeSpacingInterpol;
    h.sin2psi.dphi90 = h.ParamsToFit(h.idxphi90).LatticeSpacingInterpol;
    h.sin2psi.dphi180 = h.ParamsToFit(h.idxphi180).LatticeSpacingInterpol;
    h.sin2psi.dphi270 = h.ParamsToFit(h.idxphi90).LatticeSpacingInterpol;
    h.sin2psi.dphi0delta = h.ParamsToFit(h.idxphi0).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi90delta = h.ParamsToFit(h.idxphi90).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi180delta = h.ParamsToFit(h.idxphi180).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi270delta = h.ParamsToFit(h.idxphi90).LatticeSpacing_DeltaInterpol;
    set(h.checkboxphi0,'Value',1)
    set(h.checkboxphi0,'Enable','on')
    set(h.checkboxphi90,'Value',1)
    set(h.checkboxphi90,'Enable','on')
    set(h.checkboxphi180,'Value',1)
    set(h.checkboxphi180,'Enable','on')
    set(h.checkboxphi270,'Value',0)
    set(h.checkboxphi270,'Enable','off')
elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
    % sigma11 + sigma22 + sigma23
    h.sin2psi.dphi0 = h.ParamsToFit(h.idxphi0).LatticeSpacingInterpol;
    h.sin2psi.dphi90 = h.ParamsToFit(h.idxphi90).LatticeSpacingInterpol;
    h.sin2psi.dphi180 = h.ParamsToFit(h.idxphi0).LatticeSpacingInterpol;
    h.sin2psi.dphi270 = h.ParamsToFit(h.idxphi270).LatticeSpacingInterpol;
    h.sin2psi.dphi0delta = h.ParamsToFit(h.idxphi0).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi90delta = h.ParamsToFit(h.idxphi90).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi180delta = h.ParamsToFit(h.idxphi0).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi270delta = h.ParamsToFit(h.idxphi270).LatticeSpacing_DeltaInterpol;
    set(h.checkboxphi0,'Value',1)
    set(h.checkboxphi0,'Enable','on')
    set(h.checkboxphi90,'Value',1)
    set(h.checkboxphi90,'Enable','on')
    set(h.checkboxphi180,'Value',0)
    set(h.checkboxphi180,'Enable','off')
    set(h.checkboxphi270,'Value',1)
    set(h.checkboxphi270,'Enable','on')
elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
    % sigma11 + sigma22 + sigma23
    h.sin2psi.dphi0 = h.ParamsToFit(h.idxphi180).LatticeSpacingInterpol;
    h.sin2psi.dphi90 = h.ParamsToFit(h.idxphi90).LatticeSpacingInterpol;
    h.sin2psi.dphi180 = h.ParamsToFit(h.idxphi180).LatticeSpacingInterpol;
    h.sin2psi.dphi270 = h.ParamsToFit(h.idxphi270).LatticeSpacingInterpol;
    h.sin2psi.dphi0delta = h.ParamsToFit(h.idxphi180).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi90delta = h.ParamsToFit(h.idxphi90).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi180delta = h.ParamsToFit(h.idxphi180).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi270delta = h.ParamsToFit(h.idxphi270).LatticeSpacing_DeltaInterpol;
    set(h.checkboxphi0,'Value',0)
    set(h.checkboxphi0,'Enable','off')
    set(h.checkboxphi90,'Value',1)
    set(h.checkboxphi90,'Enable','on')
    set(h.checkboxphi180,'Value',1)
    set(h.checkboxphi180,'Enable','on')
    set(h.checkboxphi270,'Value',1)
    set(h.checkboxphi270,'Enable','on')
elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
    % sigma11 + sigma13 + sigma22 + sigma23
    h.sin2psi.dphi0 = h.ParamsToFit(h.idxphi0).LatticeSpacingInterpol;
    h.sin2psi.dphi90 = h.ParamsToFit(h.idxphi90).LatticeSpacingInterpol;
    h.sin2psi.dphi180 = h.ParamsToFit(h.idxphi180).LatticeSpacingInterpol;
    h.sin2psi.dphi270 = h.ParamsToFit(h.idxphi270).LatticeSpacingInterpol;
    h.sin2psi.dphi0delta = h.ParamsToFit(h.idxphi0).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi90delta = h.ParamsToFit(h.idxphi90).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi180delta = h.ParamsToFit(h.idxphi180).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi270delta = h.ParamsToFit(h.idxphi270).LatticeSpacing_DeltaInterpol; 
    set(h.checkboxphi0,'Value',1)
    set(h.checkboxphi0,'Enable','on')
    set(h.checkboxphi90,'Value',1)
    set(h.checkboxphi90,'Enable','on')
    set(h.checkboxphi180,'Value',1)
    set(h.checkboxphi180,'Enable','on')
    set(h.checkboxphi270,'Value',1)
    set(h.checkboxphi270,'Enable','on')
end
% assignin('base','sin2psi',h.sin2psi)

% Bereitstellung der im Weiteren benötigten, über die verschiedenen Azimute
% gemittelten Verteilungen; es gilt:
% dphi0p180 =
% (d_phi0 + d_phi180)/2% -> sigma_11 / sin²psi-Auswertung
% dphi0m180 = 
% (d_phi0 - d_phi180)/2% -> sigma_13 / |sin2psi|-Auswertung
% dphi90p270 = 
% (d_phi90 + d_phi270)/2% -> sigma_22 / sin²psi-Auswertung
% dphi90m270 = 
% (d_phi90 - d_phi270)/2% -> sigma_23 / |sin2psi|-Auswertung
% dphi0p180p90p270 = 
% (d_phi0 + d_phi180 + d_phi90 + d_phi270)/4% -> sigma_|| und d0% / U-Plot
% dphi0p180m90p270 = 
% [(d_phi0 + d_phi180) - (d_phi90 + d_phi270)]/4 -> sigma_11 - sigma_22% / U-Plot 

if length(ia{1}) == 1
    for k = 1:size(h.sin2psi.dphi0,2)
        h.sin2psi.dphi0p180{k} = (h.sin2psi.dphi0{k} + h.sin2psi.dphi180{k})./2;
        h.sin2psi.dphi0m180{k} = (h.sin2psi.dphi0{k} - h.sin2psi.dphi180{k})./2;
        h.sin2psi.dphi90p270{k} = (h.sin2psi.dphi90{k} + h.sin2psi.dphi270{k})./2;
        h.sin2psi.dphi90m270{k} = (h.sin2psi.dphi90{k} - h.sin2psi.dphi270{k})./2;
        h.sin2psi.dphi0p180p90p270{k} = (h.sin2psi.dphi0{k} + h.sin2psi.dphi180{k} + h.sin2psi.dphi90{k} + h.sin2psi.dphi270{k})./4;
        h.sin2psi.dphi0p180m90p270{k} = ((h.sin2psi.dphi0{k} + h.sin2psi.dphi180{k}) - (h.sin2psi.dphi90{k} + h.sin2psi.dphi270{k}))./4;
        h.sin2psi.dphi0p180delta{k} = sqrt(h.sin2psi.dphi0delta{k}.^2 + h.sin2psi.dphi180delta{k}.^2);
        h.sin2psi.dphi0m180delta{k} = sqrt(h.sin2psi.dphi0delta{k}.^2 + h.sin2psi.dphi180delta{k}.^2);
        h.sin2psi.dphi90p270delta{k} = sqrt(h.sin2psi.dphi90delta{k}.^2 + h.sin2psi.dphi270delta{k}.^2);
        h.sin2psi.dphi90m270delta{k} = sqrt(h.sin2psi.dphi90delta{k}.^2 + h.sin2psi.dphi270delta{k}.^2);
        h.sin2psi.dphi0p180p90p270delta{k} = sqrt(h.sin2psi.dphi0delta{k}.^2 + h.sin2psi.dphi180delta{k}.^2 + h.sin2psi.dphi90delta{k}.^2 + h.sin2psi.dphi270delta{k}.^2);
        h.sin2psi.dphi0p180m90p270delta{k} = sqrt(h.sin2psi.dphi0delta{k}.^2 + h.sin2psi.dphi180delta{k}.^2 + h.sin2psi.dphi90delta{k}.^2 + h.sin2psi.dphi270delta{k}.^2);
    end
elseif length(ia{1}) ~= 1
    for k = 1:size(h.sin2psi.dphi0,2)
        h.sin2psi.dphi0p180{k} = (h.sin2psi.dphi0{k} + h.sin2psi.dphi180{k})./2;
        h.sin2psi.dphi0m180{k} = (h.sin2psi.dphi0{k} - h.sin2psi.dphi180{k})./2;
        h.sin2psi.dphi90p270{k} = (h.sin2psi.dphi90{k} + h.sin2psi.dphi270{k})./2;
        h.sin2psi.dphi90m270{k} = (h.sin2psi.dphi90{k} - h.sin2psi.dphi270{k})./2;
        h.sin2psi.dphi0p180p90p270{k} = (h.sin2psi.dphi0{k} + h.sin2psi.dphi180{k} + h.sin2psi.dphi90{k} + h.sin2psi.dphi270{k})./4;
        h.sin2psi.dphi0p180m90p270{k} = ((h.sin2psi.dphi0{k} + h.sin2psi.dphi180{k}) - (h.sin2psi.dphi90{k} + h.sin2psi.dphi270{k}))./4;
        h.sin2psi.dphi0p180delta{k} = sqrt(h.sin2psi.dphi0delta{k}.^2 + h.sin2psi.dphi180delta{k}.^2);
        h.sin2psi.dphi0m180delta{k} = sqrt(h.sin2psi.dphi0delta{k}.^2 + h.sin2psi.dphi180delta{k}.^2);
        h.sin2psi.dphi90p270delta{k} = sqrt(h.sin2psi.dphi90delta{k}.^2 + h.sin2psi.dphi270delta{k}.^2);
        h.sin2psi.dphi90m270delta{k} = sqrt(h.sin2psi.dphi90delta{k}.^2 + h.sin2psi.dphi270delta{k}.^2);
        h.sin2psi.dphi0p180p90p270delta{k} = sqrt(h.sin2psi.dphi0delta{k}.^2 + h.sin2psi.dphi180delta{k}.^2 + h.sin2psi.dphi90delta{k}.^2 + h.sin2psi.dphi270delta{k}.^2);
        h.sin2psi.dphi0p180m90p270delta{k} = sqrt(h.sin2psi.dphi0delta{k}.^2 + h.sin2psi.dphi180delta{k}.^2 + h.sin2psi.dphi90delta{k}.^2 + h.sin2psi.dphi270delta{k}.^2);
    end
end

% Prepare sin2psi data for regression
if length(ia{1}) == 1
    for k = 1:size(h.sin2psi.dphi0,2)
        h.sin2psi.dphi0p180sinquadratpsi{k} = [sind(h.PsiforInterpol{k}).^2,h.sin2psi.dphi0p180{k},h.sin2psi.dphi0p180delta{k}];
        h.sin2psi.dphi0m180sinquadratpsi{k} = [sind(h.PsiforInterpol{k}).^2,h.sin2psi.dphi0m180{k},h.sin2psi.dphi0m180delta{k}];
        h.sin2psi.dphi0m180sin2psi{k} = [sind(2.*h.PsiforInterpol{k}),h.sin2psi.dphi0m180{k},h.sin2psi.dphi0m180delta{k}];
        h.sin2psi.dphi90p270sinquadratpsi{k} = [sind(h.PsiforInterpol{k}).^2,h.sin2psi.dphi90p270{k},h.sin2psi.dphi90p270delta{k}];
        h.sin2psi.dphi90m270sinquadratpsi{k} = [sind(h.PsiforInterpol{k}).^2,h.sin2psi.dphi90m270{k},h.sin2psi.dphi90m270delta{k}];
        h.sin2psi.dphi90m270sin2psi{k} = [sind(2.*h.PsiforInterpol{k}),h.sin2psi.dphi90m270{k},h.sin2psi.dphi90m270delta{k}];
    end
elseif length(ia{1}) ~= 1
    for k = 1:size(h.sin2psi.dphi0,2)
        h.sin2psi.dphi0p180sinquadratpsi{k} = [sind(h.PsiforInterpol{k}).^2,h.sin2psi.dphi0p180{k},h.sin2psi.dphi0p180delta{k}];
        h.sin2psi.dphi0m180sinquadratpsi{k} = [sind(h.PsiforInterpol{k}).^2,h.sin2psi.dphi0m180{k},h.sin2psi.dphi0m180delta{k}];
        h.sin2psi.dphi0m180sin2psi{k} = [sind(2.*h.PsiforInterpol{k}),h.sin2psi.dphi0m180{k},h.sin2psi.dphi0m180delta{k}];
        h.sin2psi.dphi90p270sinquadratpsi{k} = [sind(h.PsiforInterpol{k}).^2,h.sin2psi.dphi90p270{k},h.sin2psi.dphi90p270delta{k}];
        h.sin2psi.dphi90m270sinquadratpsi{k} = [sind(h.PsiforInterpol{k}).^2,h.sin2psi.dphi90m270{k},h.sin2psi.dphi90m270delta{k}];
        h.sin2psi.dphi90m270sin2psi{k} = [sind(2.*h.PsiforInterpol{k}),h.sin2psi.dphi90m270{k},h.sin2psi.dphi90m270delta{k}];
    end
end

% Perform linear regeression
for k = 1:size(h.sin2psi.dphi0,2)
    h.sin2psi.dphi0p180sinquadratpsiregress{k} = fitlm(h.sin2psi.dphi0p180sinquadratpsi{k}(:,1),h.sin2psi.dphi0p180sinquadratpsi{k}(:,2),'Weight',1./h.sin2psi.dphi0p180sinquadratpsi{k}(:,3));
    h.sin2psi.dphi90p270sinquadratpsiregress{k} = fitlm(h.sin2psi.dphi90p270sinquadratpsi{k}(:,1),h.sin2psi.dphi90p270sinquadratpsi{k}(:,2),'Weight',1./h.sin2psi.dphi90p270sinquadratpsi{k}(:,3));
    funsigmashear = @(m,x)(m.*x);
    h.sin2psi.dphi0m180sin2psiregress{k} = fitnlm(h.sin2psi.dphi0m180sin2psi{k}(:,1),h.sin2psi.dphi0m180sin2psi{k}(:,2),funsigmashear,0,'Weights',1./h.sin2psi.dphi0m180sin2psi{k}(:,3));
    h.sin2psi.dphi90m270sin2psiregress{k} = fitnlm(h.sin2psi.dphi90m270sin2psi{k}(:,1),h.sin2psi.dphi90m270sin2psi{k}(:,2),funsigmashear,0,'Weights',1./h.sin2psi.dphi90m270sin2psi{k}(:,3));
end

% Delete field if already present, in case of reloading stress data with
% different number of peaks
if isfield(h, 'StressesMW')
    h = rmfield(h,'StressesMW');
end

% Calculate tau
if length(ia{1}) == 1
    % Calculate absorbtion coefficient for Emax values
    h.StressesMW.absorbcoeff = cell(1);
    for k = 1:size(h.Params.Energy_Max,2)
        h.StressesMW.absorbcoeff{k} = h.Sample.Materials(1).LAC(h.Params.Energy_Max{k});
    end
    % Calculate tau for Emax values
    h.StressesMW.temptau = cell(1);
    for k = 1:size(h.Params.Energy_Max,2)
        h.StressesMW.temptau{k} = (sind(h.Measurement(1).twotheta./2).*cosd(h.Params.Psi_Winkel{k}))./(2.*h.StressesMW.absorbcoeff{k}./10000);
    end
    % Calculate average <tau>
    for ii = 1:size(h.Params.Energy_Max,2)
        h.StressesMW.tau(ii) = (h.StressesMW.temptau{ii}(1)+h.StressesMW.temptau{ii}(end))/2;
        h.StressesMW.taupsizero(ii) = h.StressesMW.temptau{ii}(1);
    end
elseif length(ia{1}) ~= 1
    % Calculate absorbtion coefficient for Emax values
    for j = 1:length(ia{1})
        h.StressesMW(j).absorbcoeff = cell(1);
        for k = 1:size(h.ParamsToFit(j).Energy_Max,2)
            h.StressesMW(j).absorbcoeff{k} = h.Sample.Materials(1).LAC(h.ParamsToFit(j).Energy_Max{k});
        end
    end

    for j = 1:length(ia{1})
        % Calculate tau for Emax values
        % Calculate average <tau>
        h.StressesMW(j).temptau = cell(1);
        for k = 1:size(h.ParamsToFit(j).Energy_Max,2)
            h.StressesMW(j).temptau{k} = (sind(h.Measurement(1).twotheta./2).*cosd(h.ParamsToFit(j).Psi_Winkel{k}))./(2.*h.StressesMW(j).absorbcoeff{k}./10000);
            h.StressesMW(j).tau(k) = (h.StressesMW(j).temptau{k}(1)+h.StressesMW(j).temptau{k}(end))/2;
%             h.StressesMW(j).taupsizero(k) = h.StressesMW(j).temptau{k}(1);
            h.StressesMW(j).taupsizero(k) = (sind(h.Measurement(1).twotheta./2).*cosd(0))./(2.*h.StressesMW(j).absorbcoeff{k}(1)./10000);
        end
    end
end

% Calculate aveerage tau from all measured azimuths
for j = 1:size(h.StressesMW,2)
    h.sin2psi.tautmp(:,j) = h.StressesMW(j).tau;
    h.sin2psi.taupsizero(:,j) = h.StressesMW(j).taupsizero;
end

for k = 1:size(h.sin2psi.tautmp,1)
    h.sin2psi.taumean(k) = mean(h.sin2psi.tautmp(k,:));
    h.sin2psi.taupsizeromean(k) = mean(h.sin2psi.taupsizero(k,:));
end

% Load DEK data previously entered by user
DEKdatatmp = get(h.loadDEKtable,'data');
% Convert hkl to vector
for k = 1:length(DEKdatatmp(:,1))
    hklDEKtmp(k) = DEKdatatmp(k,1)*100 + DEKdatatmp(k,2)*10 + DEKdatatmp(k,3);
end

hklDEKtmp = hklDEKtmp';
% Set DEK values to Params structure
h.Params.DEK = [hklDEKtmp DEKdatatmp(:,4:5)];
% assignin('base','hParamsToFit',h.ParamsToFit)
% assignin('base','hParams',h.Params)
% assignin('base','hsin2psi',h.sin2psi)
% Calculate dzero
if length(ia{1}) == 1
    for k = 1:size(h.Params.LatticeSpacing,2)
        % Calculate dzero
        h.sin2psi.dzero(k) = interp1(h.PsiforInterpol{k},h.sin2psi.dphi0p180p90p270{k},asind(sqrt(-2.*h.Params.DEK(k,2)./h.Params.DEK(k,3))),'linear','extrap');
    end
elseif length(ia{1}) ~= 1    
    for k = 1:size(h.ParamsToFit(1).LatticeSpacingInterpol,2)
        % Calculate dzero
        h.sin2psi.dzero(k) = interp1(h.PsiforInterpol{k},h.sin2psi.dphi0p180p90p270{k},asind(sqrt(-2.*h.Params.DEK(k,2)./h.Params.DEK(k,3))),'linear','extrap');
    end
end
% h.sin2psi.dzero(1) = 0.14475;
% Calculate sigma11 and sigma22
for k = 1:size(h.sin2psi.dphi0p180sinquadratpsi,2)
    h.sin2psi.dphi0p180sinquadratpsiregress{k} = fitlm(h.sin2psi.dphi0p180sinquadratpsi{k}(:,1),h.sin2psi.dphi0p180sinquadratpsi{k}(:,2),'Weight',1./h.sin2psi.dphi0p180sinquadratpsi{k}(:,3));
    h.sin2psi.dphi90p270sinquadratpsiregress{k} = fitlm(h.sin2psi.dphi90p270sinquadratpsi{k}(:,1),h.sin2psi.dphi90p270sinquadratpsi{k}(:,2),'Weight',1./h.sin2psi.dphi90p270sinquadratpsi{k}(:,3));
end

% Calculate sigma13 and sigma23
for k = 1:size(h.sin2psi.dphi0m180sin2psi,2)
	h.sin2psi.dphi0m180sin2psiregress{k} = fitnlm(h.sin2psi.dphi0m180sin2psi{k}(:,1),h.sin2psi.dphi0m180sin2psi{k}(:,2),funsigmashear,0,'Weights',1./h.sin2psi.dphi0m180sin2psi{k}(:,3));
	h.sin2psi.dphi90m270sin2psiregress{k} = fitnlm(h.sin2psi.dphi90m270sin2psi{k}(:,1),h.sin2psi.dphi90m270sin2psi{k}(:,2),funsigmashear,0,'Weights',1./h.sin2psi.dphi90m270sin2psi{k}(:,3));
end
% assignin('base','StressesMW',h.StressesMW)
% Create sigmatau list
for k = 1:size(h.sin2psi.dphi0p180sinquadratpsiregress,2)
    if ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
        % sigma11
        h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taupsizero(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taumean(k)];
    elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
        % sigma22
        h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taupsizero(k),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taumean(k)];
    elseif isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
        % sigma11
        h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taupsizero(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taumean(k)];
    elseif isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
        % sigma22
        h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taupsizero(k),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taumean(k)];      
    elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
        % sigma11, sigma22
        h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taupsizero(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taumean(k)];
    elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
        % sigma11, sigma22
        h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taupsizero(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taumean(k)];
    elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
        % sigma11, sigma22
        h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taupsizero(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taumean(k)];
    elseif isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
        % sigma11, sigma22
        h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taupsizero(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taumean(k)];                
    elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
        % sigma11, sigma13
        h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taupsizero(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi0m180sin2psiregress{k}.Coefficients.Estimate(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0m180sin2psiregress{k}.Coefficients.SE(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taumean(k)];
    elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
        % sigma22, sigma23
        h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taupsizero(k),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi90m270sin2psiregress{k}.Coefficients.Estimate(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90m270sin2psiregress{k}.Coefficients.SE(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taumean(k)]; 
    elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)	
        % sigma11, sigma22, sigma13
        h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taupsizero(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi0m180sin2psiregress{k}.Coefficients.Estimate(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0m180sin2psiregress{k}.Coefficients.SE(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taumean(k)];   
    elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)	
        % sigma11, sigma22, sigma13
        h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taupsizero(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi0m180sin2psiregress{k}.Coefficients.Estimate(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0m180sin2psiregress{k}.Coefficients.SE(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taumean(k)]; 
    elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
        % sigma11, sigma22, sigma23
        h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taupsizero(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi90m270sin2psiregress{k}.Coefficients.Estimate(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90m270sin2psiregress{k}.Coefficients.SE(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taumean(k)];
    elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)	
        % sigma11, sigma22, sigma23
        h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taupsizero(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi90m270sin2psiregress{k}.Coefficients.Estimate(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90m270sin2psiregress{k}.Coefficients.SE(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taumean(k)];  
    elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
        % sigma11, sigma22, sigma13, sigma23	
        h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taupsizero(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi0m180sin2psiregress{k}.Coefficients.Estimate(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0m180sin2psiregress{k}.Coefficients.SE(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi90m270sin2psiregress{k}.Coefficients.Estimate(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90m270sin2psiregress{k}.Coefficients.SE(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taumean(k)];
    end
%     if ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
%         % sigma11
%         h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taumean(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taupsizero(k)];
%     elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
%         % sigma22
%         h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taumean(k),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taupsizero(k)];
%     elseif isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
%         % sigma11
%         h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taumean(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taupsizero(k)];
%     elseif isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
%         % sigma22
%         h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taumean(k),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taupsizero(k)];      
%     elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
%         % sigma11, sigma22
%         h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taumean(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taupsizero(k)];
%     elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
%         % sigma11, sigma22
%         h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taumean(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taupsizero(k)];
%     elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
%         % sigma11, sigma22
%         h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taumean(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taupsizero(k)];
%     elseif isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
%         % sigma11, sigma22
%         h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taumean(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taupsizero(k)];                
%     elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
%         % sigma11, sigma13
%         h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taumean(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi0m180sin2psiregress{k}.Coefficients.Estimate(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0m180sin2psiregress{k}.Coefficients.SE(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taupsizero(k)];
%     elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
%         % sigma22, sigma23
%         h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taumean(k),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi90m270sin2psiregress{k}.Coefficients.Estimate(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90m270sin2psiregress{k}.Coefficients.SE(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taupsizero(k)]; 
%     elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)	
%         % sigma11, sigma22, sigma13
%         h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taumean(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi0m180sin2psiregress{k}.Coefficients.Estimate(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0m180sin2psiregress{k}.Coefficients.SE(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taupsizero(k)];   
%     elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)	
%         % sigma11, sigma22, sigma13
%         h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taumean(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi0m180sin2psiregress{k}.Coefficients.Estimate(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0m180sin2psiregress{k}.Coefficients.SE(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taupsizero(k)]; 
%     elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
%         % sigma11, sigma22, sigma23
%         h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taumean(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi90m270sin2psiregress{k}.Coefficients.Estimate(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90m270sin2psiregress{k}.Coefficients.SE(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taupsizero(k)];
%     elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)	
%         % sigma11, sigma22, sigma23
%         h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taumean(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi90m270sin2psiregress{k}.Coefficients.Estimate(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90m270sin2psiregress{k}.Coefficients.SE(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taupsizero(k)];  
%     elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
%         % sigma11, sigma22, sigma13, sigma23	
%         h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taumean(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi0m180sin2psiregress{k}.Coefficients.Estimate(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0m180sin2psiregress{k}.Coefficients.SE(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi90m270sin2psiregress{k}.Coefficients.Estimate(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90m270sin2psiregress{k}.Coefficients.SE(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taupsizero(k)];
%     end
end

% h.sin2psi.sigmataulist = sortrows(h.sin2psi.sigmataulist,1);

% Calculate regression lines
sinpsisquare = linspace(0,1,51);
h.sinpsisquare = sinpsisquare;

for k = 1:size(h.sin2psi.dphi0p180sinquadratpsiregress,2)
    if ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
        % sigma11
        h.sin2psi.reglinephi0(:,k) = h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(1) + h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2).*sinpsisquare;
    elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
        % sigma22
        h.sin2psi.reglinephi90(:,k) = h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(1) + h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2).*sinpsisquare;
    elseif isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
        % sigma11
        h.sin2psi.reglinephi180(:,k) = h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(1) + h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2).*sinpsisquare;
    elseif isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
        % sigma22
        h.sin2psi.reglinephi270(:,k) = h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(1) + h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2).*sinpsisquare;    
    elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
        % sigma11, sigma22
        h.sin2psi.reglinephi0(:,k) = h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(1) + h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2).*sinpsisquare;
        h.sin2psi.reglinephi90(:,k) = h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(1) + h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2).*sinpsisquare;
    elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
        % sigma11, sigma22
        h.sin2psi.reglinephi0(:,k) = h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(1) + h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2).*sinpsisquare;
        h.sin2psi.reglinephi270(:,k) = h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(1) + h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2).*sinpsisquare;
    elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
        % sigma11, sigma22
        h.sin2psi.reglinephi180(:,k) = h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(1) + h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2).*sinpsisquare;
        h.sin2psi.reglinephi90(:,k) = h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(1) + h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2).*sinpsisquare;
    elseif isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
        % sigma11, sigma22
        h.sin2psi.reglinephi180(:,k) = h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(1) + h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2).*sinpsisquare;
        h.sin2psi.reglinephi270(:,k) = h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(1) + h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2).*sinpsisquare;     
    elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
        % sigma11, sigma13
        h.sin2psi.reglinephi0(:,k) = (h.Params.DEK(k,3).*(h.sin2psi.sigmataulist(k,2).*sinpsisquare + ...
                           h.sin2psi.sigmataulist(k,4).*2.*sqrt(sinpsisquare.*(1-sinpsisquare))) + ...
                           h.Params.DEK(k,2).*2.*(h.sin2psi.sigmataulist(k,2))).*h.sin2psi.dzero(k) + h.sin2psi.dzero(k);
        h.sin2psi.reglinephi180(:,k) = (h.Params.DEK(k,3).*(h.sin2psi.sigmataulist(k,2).*sinpsisquare - ...
                           h.sin2psi.sigmataulist(k,4).*2.*sqrt(sinpsisquare.*(1-sinpsisquare))) + ...
                           h.Params.DEK(k,2).*2.*(h.sin2psi.sigmataulist(k,2))).*h.sin2psi.dzero(k) + h.sin2psi.dzero(k);				   
    elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
        % sigma11, sigma22, sigma13
        h.sin2psi.reglinephi0(:,k) = (h.Params.DEK(k,3).*(h.sin2psi.sigmataulist(k,2).*sinpsisquare + ...
                           h.sin2psi.sigmataulist(k,6).*2.*sqrt(sinpsisquare.*(1-sinpsisquare))) + ...
                           h.Params.DEK(k,2).*(h.sin2psi.sigmataulist(k,2) + h.sin2psi.sigmataulist(k,4))).*h.sin2psi.dzero(k) + h.sin2psi.dzero(k);
        h.sin2psi.reglinephi90(:,k) = h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(1) + h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2).*sinpsisquare;				   
        h.sin2psi.reglinephi180(:,k) = (h.Params.DEK(k,3).*(h.sin2psi.sigmataulist(k,2).*sinpsisquare - ...
                           h.sin2psi.sigmataulist(k,6).*2.*sqrt(sinpsisquare.*(1-sinpsisquare))) + ...
                           h.Params.DEK(k,2).*(h.sin2psi.sigmataulist(k,2) + h.sin2psi.sigmataulist(k,4))).*h.sin2psi.dzero(k) + h.sin2psi.dzero(k);
    elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)	
        % sigma11, sigma22, sigma13
        h.sin2psi.reglinephi0(:,k) = (h.Params.DEK(k,3).*(h.sin2psi.sigmataulist(k,2).*sinpsisquare + ...
                           h.sin2psi.sigmataulist(k,6).*2.*sqrt(sinpsisquare.*(1-sinpsisquare))) + ...
                           h.Params.DEK(k,2).*(h.sin2psi.sigmataulist(k,2) + h.sin2psi.sigmataulist(k,4))).*h.sin2psi.dzero(k) + h.sin2psi.dzero(k);
        h.sin2psi.reglinephi180(:,k) = (h.Params.DEK(k,3).*(h.sin2psi.sigmataulist(k,2).*sinpsisquare - ...
                           h.sin2psi.sigmataulist(k,6).*2.*sqrt(sinpsisquare.*(1-sinpsisquare))) + ...
                           h.Params.DEK(k,2).*(h.sin2psi.sigmataulist(k,2) + h.sin2psi.sigmataulist(k,4))).*h.sin2psi.dzero(k) + h.sin2psi.dzero(k);
        h.sin2psi.reglinephi270(:,k) = h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(1) + h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2).*sinpsisquare;
    elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
        % sigma22, sigma23
        h.sin2psi.reglinephi90(:,k) = (h.Params.DEK(k,3).*(h.sin2psi.sigmataulist(k,2).*sinpsisquare + ...
                           h.sin2psi.sigmataulist(k,4).*2.*sqrt(sinpsisquare.*(1-sinpsisquare))) + ...
                           h.Params.DEK(k,2).*2.*(h.sin2psi.sigmataulist(k,2))).*h.sin2psi.dzero(k) + h.sin2psi.dzero(k);
        h.sin2psi.reglinephi270(:,k) = (h.Params.DEK(k,3).*(h.sin2psi.sigmataulist(k,2).*sinpsisquare - ...
                           h.sin2psi.sigmataulist(k,4).*2.*sqrt(sinpsisquare.*(1-sinpsisquare))) + ...
                           h.Params.DEK(k,2).*2.*(h.sin2psi.sigmataulist(k,2))).*h.sin2psi.dzero(k) + h.sin2psi.dzero(k);
    elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
        % sigma11, sigma22, sigma23
        h.sin2psi.reglinephi0(:,k) = h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(1) + h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2).*sinpsisquare;
        h.sin2psi.reglinephi90(:,k) = (h.Params.DEK(k,3).*(h.sin2psi.sigmataulist(k,4).*sinpsisquare + ...
                           h.sin2psi.sigmataulist(k,6).*2.*sqrt(sinpsisquare.*(1-sinpsisquare))) + ...
                           h.Params.DEK(k,2).*(h.sin2psi.sigmataulist(k,2) + h.sin2psi.sigmataulist(k,4))).*h.sin2psi.dzero(k) + h.sin2psi.dzero(k);			   
        h.sin2psi.reglinephi270(:,k) = (h.Params.DEK(k,3).*(h.sin2psi.sigmataulist(k,4).*sinpsisquare - ...
                           h.sin2psi.sigmataulist(k,6).*2.*sqrt(sinpsisquare.*(1-sinpsisquare))) + ...
                           h.Params.DEK(k,2).*(h.sin2psi.sigmataulist(k,2) + h.sin2psi.sigmataulist(k,4))).*h.sin2psi.dzero(k) + h.sin2psi.dzero(k);
    elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)	
        % sigma11, sigma22, sigma23
        h.sin2psi.reglinephi90(:,k) = (h.Params.DEK(k,3).*(h.sin2psi.sigmataulist(k,4).*sinpsisquare - ...
                           h.sin2psi.sigmataulist(k,6).*2.*sqrt(sinpsisquare.*(1-sinpsisquare))) + ...
                           h.Params.DEK(k,2).*(h.sin2psi.sigmataulist(k,2) + h.sin2psi.sigmataulist(k,4))).*h.sin2psi.dzero(k) + h.sin2psi.dzero(k);
        h.sin2psi.reglinephi180(:,k) = h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(1) + h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2).*sinpsisquare;
        h.sin2psi.reglinephi270(:,k) = (h.Params.DEK(k,3).*(h.sin2psi.sigmataulist(k,4).*sinpsisquare - ...
                           h.sin2psi.sigmataulist(k,6).*2.*sqrt(sinpsisquare.*(1-sinpsisquare))) + ...
                           h.Params.DEK(k,2).*(h.sin2psi.sigmataulist(k,2) + h.sin2psi.sigmataulist(k,4))).*h.sin2psi.dzero(k) + h.sin2psi.dzero(k);                   
    elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
        % sigma11, sigma22, sigma13, sigma23
        h.sin2psi.reglinephi0(:,k) = (h.Params.DEK(k,3).*(h.sin2psi.sigmataulist(k,2).*sinpsisquare + ...
                           h.sin2psi.sigmataulist(k,6).*2.*sqrt(sinpsisquare.*(1-sinpsisquare))) + ...
                           h.Params.DEK(k,2).*(h.sin2psi.sigmataulist(k,2) + h.sin2psi.sigmataulist(k,4))).*h.sin2psi.dzero(k) + h.sin2psi.dzero(k);
        h.sin2psi.reglinephi90(:,k) = (h.Params.DEK(k,3).*(h.sin2psi.sigmataulist(k,4).*sinpsisquare + ...
                           h.sin2psi.sigmataulist(k,8).*2.*sqrt(sinpsisquare.*(1-sinpsisquare))) + ...
                           h.Params.DEK(k,2).*(h.sin2psi.sigmataulist(k,2) + h.sin2psi.sigmataulist(k,4))).*h.sin2psi.dzero(k) + h.sin2psi.dzero(k);
        h.sin2psi.reglinephi180(:,k) = (h.Params.DEK(k,3).*(h.sin2psi.sigmataulist(k,2).*sinpsisquare - ...
                           h.sin2psi.sigmataulist(k,6).*2.*sqrt(sinpsisquare.*(1-sinpsisquare))) + ...
                           h.Params.DEK(k,2).*(h.sin2psi.sigmataulist(k,2) + h.sin2psi.sigmataulist(k,4))).*h.sin2psi.dzero(k) + h.sin2psi.dzero(k);
        h.sin2psi.reglinephi270(:,k) = (h.Params.DEK(k,3).*(h.sin2psi.sigmataulist(k,4).*sinpsisquare - ...
                           h.sin2psi.sigmataulist(k,8).*2.*sqrt(sinpsisquare.*(1-sinpsisquare))) + ...
                           h.Params.DEK(k,2).*(h.sin2psi.sigmataulist(k,2) + h.sin2psi.sigmataulist(k,4))).*h.sin2psi.dzero(k) + h.sin2psi.dzero(k);
    end
end

% Get peak hkl and sort acording to tau value of peak
if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    % 
    FitPeaks = h.FitPeaksLogical(:,1);
    % Repmat of logical vector in order to match size of T.Peaks array
    FitPeaksLogical = repmat(FitPeaks,1,size(h.TPeaks.T.Peaks,2));
    % Reduce T.Peaks array according to the actual peaks fitted
    % Creat temporary file Peakstmp
    Peakstmp = h.TPeaks.T.Peaks;
    PeakstmpLogical = Peakstmp(:,5) > h.P.EnergyRange(1) & Peakstmp(:,5) < h.P.EnergyRange(2);
elseif strcmp(h.Diffsel,'LEDDI')
    if strcmp(h.Detsel,'Detector 1')
        % 
        FitPeaks = h.FitPeaksLogicalDet1(:,1);
        % Repmat of logical vector in order to match size of T.Peaks array
        FitPeaksLogical = repmat(FitPeaks,1,size(h.TPeaksDet1.T.Peaks,2));
        % Reduce T.Peaks array according to the actual peaks fitted
        % Creat temporary file Peakstmp
        Peakstmp = h.TPeaksDet1.T.Peaks;
        PeakstmpLogical = Peakstmp(:,5) > h.P.EnergyRangeDet1(1) & Peakstmp(:,5) < h.P.EnergyRangeDet1(2);
    elseif strcmp(h.Detsel,'Detector 2')
        % 
        FitPeaks = h.FitPeaksLogicalDet2(:,1);
        % Repmat of logical vector in order to match size of T.Peaks array
        FitPeaksLogical = repmat(FitPeaks,1,size(h.TPeaksDet2.T.Peaks,2));
        % Reduce T.Peaks array according to the actual peaks fitted
        % Creat temporary file Peakstmp
        Peakstmp = h.TPeaksDet2.T.Peaks;
        PeakstmpLogical = Peakstmp(:,5) > h.P.EnergyRangeDet2(1) & Peakstmp(:,5) < h.P.EnergyRangeDet2(2);
    end
end
% assignin('base','Peakstmp2',Peakstmp)
% assignin('base','FitPeaksLogical',FitPeaksLogical)
% Reduce Peakstmp using the logicals 'FitPeaksLogical' and
% 'KeepPeaksDEKLogical'
Peakstmp = Peakstmp(PeakstmpLogical(:,1),:);
Peakstmp = Peakstmp(FitPeaksLogical(:,1),:);
Peakstmp = Peakstmp(h.KeepPeaksDEKLogical(:,1),:);

% assignin('base','Peakstmp',Peakstmp)
% assignin('base','FitPeaksLogical',FitPeaksLogical)
% assignin('base','KeepPeaksDEKLogical',h.KeepPeaksDEKLogical)
% Reshape vector into array
% Delete field if already present, in case of reloading stress data with
% different number of peaks
if isfield(h, 'PeaksforLabel')
    h = rmfield(h,'PeaksforLabel');
end
% h.PeaksforLabel = reshape(Peakstmp,[length(FitPeaks)-length(find(FitPeaks==0)),size(h.TPeaks.T.Peaks,2)]);
h.PeaksforLabel = reshape(Peakstmp,[length(h.KeepPeaksDEKLogical(:,1))-length(find(h.KeepPeaksDEKLogical(:,1)==0)),size(Peakstmp,2)]);

% Sort Colors according to energy positions of peaks
% Delete field if already present, in case of reloading stress data with
% different number of peaks
if isfield(h, 'ColorsUsed')
    h = rmfield(h,'ColorsUsed');
end
if isfield(h, 'ColorsUsedtmp')
    h = rmfield(h,'ColorsUsedtmp');
end
% Get colors that are used for the plot
for k = 1:size(h.Params.LatticeSpacing,2)
    h.ColorsUsed{k} = h.Colors{k};
end
% Convert to integers
for k = 1:size(h.Params.LatticeSpacing,2)
    h.ColorsUsedtmp(k,:) = h.ColorsUsed{1,k}(:);
end

% Create array with tau, sigma, labe and color data
StressPlotDatatmp = [h.sin2psi.sigmataulist h.PeaksforLabel h.ColorsUsedtmp];

% Sort array according to tau values
h.sin2psi.StressPlotDatatmpsorted = sortrows(StressPlotDatatmp, 1);

% Update hkl label order
h.PeaksforLabel = h.sin2psi.StressPlotDatatmpsorted(:,(size(h.sin2psi.sigmataulist,2)+1:size(h.sin2psi.sigmataulist,2)+4));
% Update color order if deleting data point caused a considerable shift of
% tau
h.ColorsUsedSorted = h.sin2psi.StressPlotDatatmpsorted(:,(size(h.sin2psi.sigmataulist,2)+6:size(h.sin2psi.sigmataulist,2)+8));
% Convert back to cell array
h.ColorsUsedSorted = num2cell(h.ColorsUsedSorted,2);
% Create hkl label for plot of d-spacings (sorted according to d-value)
label = CreateHKLlabel(h);
% If only under one phi angle was measured, set ParamsToFit = Params
if length(ia{1}) == 1 
    h.ParamsToFit = h.Params;
end
% assignin('base','sin2psi',h.sin2psi)
% Set data for plot of d-spacings, regression line, IB and Intensity
if ~isempty(h.idxphi0)
    set(h.plotdatadspacingphi0,'xdata',sind(h.ParamsToFit(h.idxphi0).Psi_Winkel{valueSlider}).^2)
    set(h.plotdatadspacingphi0,'ydata',h.ParamsToFit(h.idxphi0).LatticeSpacing{valueSlider})
    set(h.plotdatadspacingphi0,'YNegativeDelta',h.ParamsToFit(h.idxphi0).LatticeSpacing_Delta{valueSlider})
    set(h.plotdatadspacingphi0,'YPositiveDelta',h.ParamsToFit(h.idxphi0).LatticeSpacing_Delta{valueSlider})
    set(h.plotreglinedspacingphi0,'xdata',h.sinpsisquare)
    set(h.plotreglinedspacingphi0,'ydata',h.sin2psi.reglinephi0(:,valueSlider))
    set(h.plotdataIBphi0,'xdata',sind(h.ParamsToFit(h.idxphi0).Psi_Winkel{valueSlider}).^2)
    set(h.plotdataIBphi0,'ydata',h.ParamsToFit(h.idxphi0).IntegralWidth{valueSlider})
    set(h.plotdataIntphi0,'xdata',sind(h.ParamsToFit(h.idxphi0).Psi_Winkel{valueSlider}).^2)
    set(h.plotdataIntphi0,'ydata',h.ParamsToFit(h.idxphi0).Intensity_Int{valueSlider})
end

if ~isempty(h.idxphi90)
    set(h.plotdatadspacingphi90,'xdata',sind(h.ParamsToFit(h.idxphi90).Psi_Winkel{valueSlider}).^2)
    set(h.plotdatadspacingphi90,'ydata',h.ParamsToFit(h.idxphi90).LatticeSpacing{valueSlider})
    set(h.plotdatadspacingphi90,'YNegativeDelta',h.ParamsToFit(h.idxphi90).LatticeSpacing_Delta{valueSlider})
    set(h.plotdatadspacingphi90,'YPositiveDelta',h.ParamsToFit(h.idxphi90).LatticeSpacing_Delta{valueSlider})
    set(h.plotreglinedspacingphi90,'xdata',h.sinpsisquare)
    set(h.plotreglinedspacingphi90,'ydata',h.sin2psi.reglinephi90(:,valueSlider))
    set(h.plotdataIBphi90,'xdata',sind(h.ParamsToFit(h.idxphi90).Psi_Winkel{valueSlider}).^2)
    set(h.plotdataIBphi90,'ydata',h.ParamsToFit(h.idxphi90).IntegralWidth{valueSlider})
    set(h.plotdataIntphi90,'xdata',sind(h.ParamsToFit(h.idxphi90).Psi_Winkel{valueSlider}).^2)
    set(h.plotdataIntphi90,'ydata',h.ParamsToFit(h.idxphi90).Intensity_Int{valueSlider})
end

if ~isempty(h.idxphi180)  
    set(h.plotdatadspacingphi180,'xdata',sind(h.ParamsToFit(h.idxphi180).Psi_Winkel{valueSlider}).^2)
    set(h.plotdatadspacingphi180,'ydata',h.ParamsToFit(h.idxphi180).LatticeSpacing{valueSlider})
    set(h.plotdatadspacingphi180,'YNegativeDelta',h.ParamsToFit(h.idxphi180).LatticeSpacing_Delta{valueSlider})
    set(h.plotdatadspacingphi180,'YPositiveDelta',h.ParamsToFit(h.idxphi180).LatticeSpacing_Delta{valueSlider})
    set(h.plotreglinedspacingphi180,'xdata',h.sinpsisquare)
    set(h.plotreglinedspacingphi180,'ydata',h.sin2psi.reglinephi180(:,valueSlider))
    set(h.plotdataIBphi180,'xdata',sind(h.ParamsToFit(h.idxphi180).Psi_Winkel{valueSlider}).^2)
    set(h.plotdataIBphi180,'ydata',h.ParamsToFit(h.idxphi180).IntegralWidth{valueSlider})
    set(h.plotdataIntphi180,'xdata',sind(h.ParamsToFit(h.idxphi180).Psi_Winkel{valueSlider}).^2)
    set(h.plotdataIntphi180,'ydata',h.ParamsToFit(h.idxphi180).Intensity_Int{valueSlider})
end

if ~isempty(h.idxphi270)  
    set(h.plotdatadspacingphi270,'xdata',sind(h.ParamsToFit(h.idxphi270).Psi_Winkel{valueSlider}).^2)
    set(h.plotdatadspacingphi270,'ydata',h.ParamsToFit(h.idxphi270).LatticeSpacing{valueSlider})
    set(h.plotdatadspacingphi270,'YNegativeDelta',h.ParamsToFit(h.idxphi270).LatticeSpacing_Delta{valueSlider})
    set(h.plotdatadspacingphi270,'YPositiveDelta',h.ParamsToFit(h.idxphi270).LatticeSpacing_Delta{valueSlider})
    set(h.plotreglinedspacingphi270,'xdata',h.sinpsisquare)
    set(h.plotreglinedspacingphi270,'ydata',h.sin2psi.reglinephi270(:,valueSlider))
    set(h.plotdataIBphi270,'xdata',sind(h.ParamsToFit(h.idxphi270).Psi_Winkel{valueSlider}).^2)
    set(h.plotdataIBphi270,'ydata',h.ParamsToFit(h.idxphi270).IntegralWidth{valueSlider})
    set(h.plotdataIntphi270,'xdata',sind(h.ParamsToFit(h.idxphi270).Psi_Winkel{valueSlider}).^2)
    set(h.plotdataIntphi270,'ydata',h.ParamsToFit(h.idxphi270).Intensity_Int{valueSlider})
end

% Set axes limits for lattice spacings
YLimd1 = [floor(min(h.Params.LatticeSpacing{valueSlider})*15000)/15000,ceil(max(h.Params.LatticeSpacing{valueSlider})*15000)/15000];
YLimd2 = [YLimd1(1) - abs(diff(YLimd1))/2,YLimd1(2) + abs(diff(YLimd1))/2];
h.axesplotdspacing.YLim = [YLimd2(1) YLimd2(2)];

% Set axes limits for IB
YLimIB1 = [floor(min(h.Params.IntegralWidth{valueSlider})*10)/10,ceil(max(h.Params.IntegralWidth{valueSlider})*10)/10];
YLimIB2 = round((min(h.Params.IntegralWidth{valueSlider}) - YLimIB1(1) + max(h.Params.IntegralWidth{valueSlider}) - YLimIB1(2))/2,2);
YLimIB1 = YLimIB1+YLimIB2;
h.axesplotIB.YLim = YLimIB1;

% Set axes limits for intensity
exponentIntLim = numel(num2str(ceil(max(h.Params.Intensity_Int{valueSlider}))));
h.axesplotInt.YLim = [0,ceil(max(h.Params.Intensity_Int{valueSlider})*(10*10^(-exponentIntLim)))/(10*10^(-exponentIntLim))];

% Set plot properties
if ~isempty(h.idxphi0)
	set(h.plotdatadspacingphi0, {'Color','MarkerFaceColor','MarkerEdgeColor'}, {'k',h.Colors{valueSlider},'k'});
	set(h.plotreglinedspacingphi0, {'Color'}, {'k'});
    set(h.plotdataIBphi0, {'Color','MarkerFaceColor','MarkerEdgeColor'}, {'k',h.Colors{valueSlider},'k'});
    set(h.plotdataIntphi0, {'Color','MarkerFaceColor','MarkerEdgeColor'}, {'k',h.Colors{valueSlider},'k'});
end

if ~isempty(h.idxphi90)
	set(h.plotdatadspacingphi90, {'Color','MarkerFaceColor','MarkerEdgeColor'}, {'k',h.Colors{valueSlider},'k'});
	set(h.plotreglinedspacingphi90, {'Color'}, {'k'});
    set(h.plotdataIBphi90, {'Color','MarkerFaceColor','MarkerEdgeColor'}, {'k',h.Colors{valueSlider},'k'});
    set(h.plotdataIntphi90, {'Color','MarkerFaceColor','MarkerEdgeColor'}, {'k',h.Colors{valueSlider},'k'});
end

if ~isempty(h.idxphi180)
	set(h.plotdatadspacingphi180, {'Color','MarkerFaceColor','MarkerEdgeColor'}, {'k',h.Colors{valueSlider},'k'});
	set(h.plotreglinedspacingphi180, {'Color'}, {'k'});
    set(h.plotdataIBphi180, {'Color','MarkerFaceColor','MarkerEdgeColor'}, {'k',h.Colors{valueSlider},'k'});
    set(h.plotdataIntphi180, {'Color','MarkerFaceColor','MarkerEdgeColor'}, {'k',h.Colors{valueSlider},'k'});
end

if ~isempty(h.idxphi270)
	set(h.plotdatadspacingphi270, {'Color','MarkerFaceColor','MarkerEdgeColor'}, {'k',h.Colors{valueSlider},'k'});
	set(h.plotreglinedspacingphi270, {'Color'}, {'k'});
    set(h.plotdataIBphi270, {'Color','MarkerFaceColor','MarkerEdgeColor'}, {'k',h.Colors{valueSlider},'k'});
    set(h.plotdataIntphi270, {'Color','MarkerFaceColor','MarkerEdgeColor'}, {'k',h.Colors{valueSlider},'k'});
end

% Set plot visibility
if ~isempty(h.idxphi0)
	set(h.plotdatadspacingphi0,'Visible','on')
	set(h.plotreglinedspacingphi0,'Visible','on')
	set(h.plotdataIBphi0,'Visible','on')
	set(h.plotdataIntphi0,'Visible','on')
end

if ~isempty(h.idxphi90)
	set(h.plotdatadspacingphi90,'Visible','on')
	set(h.plotreglinedspacingphi90,'Visible','on')
	set(h.plotdataIBphi90,'Visible','on')
	set(h.plotdataIntphi90,'Visible','on')
end

if ~isempty(h.idxphi180)
	set(h.plotdatadspacingphi180,'Visible','on')
	set(h.plotreglinedspacingphi180,'Visible','on')
	set(h.plotdataIBphi180,'Visible','on')
	set(h.plotdataIntphi180,'Visible','on')
end

if ~isempty(h.idxphi270)
	set(h.plotdatadspacingphi270,'Visible','on')
	set(h.plotreglinedspacingphi270,'Visible','on')
	set(h.plotdataIBphi270,'Visible','on')
	set(h.plotdataIntphi270,'Visible','on')
end

% Set plot titles
title(h.axesplotdspacing,['Stress data for Peak', ' ', num2str(valueSlider)])
title(h.axesplotIB,['IB data for Peak', ' ', num2str(valueSlider)])
title(h.axesplotInt,['Integrated Int. data for Peak', ' ', num2str(valueSlider)])
% Create legend
if ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
    h.LegDatadspacing = [h.plotdatadspacingphi0];
    h.LegLabelData = {'\phi = 0°'};
    h.LegDataIB = [h.plotdataIBphi0];
    h.LegDataInt = [h.plotdataIntphi0];
elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
    h.LegDatadspacing = [h.plotdatadspacingphi90];
    h.LegLabelData = {'\phi = 90°'};
    h.LegDataIB = [h.plotdataIBphi90];
    h.LegDataInt = [h.plotdataIntphi90];
elseif isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
    h.LegDatadspacing = [h.plotdatadspacingphi180];
    h.LegLabelData = {'\phi = 180°'};
    h.LegDataIB = [h.plotdataIBphi180];
    h.LegDataInt = [h.plotdataIntphi180];
elseif isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
    h.LegDatadspacing = [h.plotdatadspacingphi270];
    h.LegLabelData = {'\phi = 270°'};
    h.LegDataIB = [h.plotdataIBphi270];
    h.LegDataInt = [h.plotdataIntphi270];
elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
    h.LegDatadspacing = [h.plotdatadspacingphi0 h.plotdatadspacingphi90];
    h.LegLabelData = {'\phi = 0°','\phi = 90°'};
    h.LegDataIB = [h.plotdataIBphi0 h.plotdataIBphi90];
    h.LegDataInt = [h.plotdataIntphi0 h.plotdataIntphi90];
elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
    h.LegDatadspacing = [h.plotdatadspacingphi0 h.plotdatadspacingphi180];
    h.LegLabelData = {'\phi = 0°','\phi = 180°'};
    h.LegDataIB = [h.plotdataIBphi0 h.plotdataIBphi180];
    h.LegDataInt = [h.plotdataIntphi0 h.plotdataIntphi180];
elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
    h.LegDatadspacing = [h.plotdatadspacingphi90 h.plotdatadspacingphi180];
    h.LegLabelData = {'\phi = 90°','\phi = 180°'};
    h.LegDataIB = [h.plotdataIBphi90 h.plotdataIBphi180];
    h.LegDataInt = [h.plotdataIntphi90 h.plotdataIntphi180];    
elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
    h.LegDatadspacing = [h.plotdatadspacingphi90 h.plotdatadspacingphi270];
    h.LegLabelData = {'\phi = 90°','\phi = 270°'};
    h.LegDataIB = [h.plotdataIBphi90 h.plotdataIBphi270];
    h.LegDataInt = [h.plotdataIntphi90 h.plotdataIntphi270];
elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
    h.LegDatadspacing = [h.plotdatadspacingphi0 h.plotdatadspacingphi270];
    h.LegLabelData = {'\phi = 0°','\phi = 270°'};
    h.LegDataIB = [h.plotdataIBphi0 h.plotdataIBphi270];
    h.LegDataInt = [h.plotdataIntphi0 h.plotdataIntphi270];
elseif isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
    h.LegDatadspacing = [h.plotdatadspacingphi180 h.plotdatadspacingphi270];
    h.LegLabelData = {'\phi = 180°','\phi = 270°'};
    h.LegDataIB = [h.plotdataIBphi180 h.plotdataIBphi270];
    h.LegDataInt = [h.plotdataIntphi180 h.plotdataIntphi270];      
elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
    h.LegDatadspacing = [h.plotdatadspacingphi0 h.plotdatadspacingphi90 h.plotdatadspacingphi180];
    h.LegLabelData = {'\phi = 0°','\phi = 90°','\phi = 180°'};
    h.LegDataIB = [h.plotdataIBphi0 h.plotdataIBphi90 h.plotdataIBphi180];
    h.LegDataInt = [h.plotdataIntphi0 h.plotdataIntphi90 h.plotdataIntphi180]; 
elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
    h.LegDatadspacing = [h.plotdatadspacingphi0 h.plotdatadspacingphi90 h.plotdatadspacingphi270];
    h.LegLabelData = {'\phi = 0°','\phi = 90°','\phi = 270°'};
    h.LegDataIB = [h.plotdataIBphi0 h.plotdataIBphi90 h.plotdataIBphi270];
    h.LegDataInt = [h.plotdataIntphi0 h.plotdataIntphi90 h.plotdataIntphi270];
elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
    h.LegDatadspacing = [h.plotdatadspacingphi90 h.plotdatadspacingphi180 h.plotdatadspacingphi270];
    h.LegLabelData = {'\phi = 90°','\phi = 180°','\phi = 270°'};
    h.LegDataIB = [h.plotdataIBphi90 h.plotdataIBphi180 h.plotdataIBphi270];
    h.LegDataInt = [h.plotdataIntphi90 h.plotdataIntphi180 h.plotdataIntphi270];
elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
    h.LegDatadspacing = [h.plotdatadspacingphi0 h.plotdatadspacingphi180 h.plotdatadspacingphi270];
    h.LegLabelData = {'\phi = 0°','\phi = 180°','\phi = 270°'};
    h.LegDataIB = [h.plotdataIBphi0 h.plotdataIBphi180 h.plotdataIBphi270];
    h.LegDataInt = [h.plotdataIntphi0 h.plotdataIntphi180 h.plotdataIntphi270];
elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
    h.LegDatadspacing = [h.plotdatadspacingphi0 h.plotdatadspacingphi90 h.plotdatadspacingphi180 h.plotdatadspacingphi270];
    h.LegLabelData = {'\phi = 0°','\phi = 90°','\phi = 180°','\phi = 270°'};
    h.LegDataIB = [h.plotdataIBphi0 h.plotdataIBphi90 h.plotdataIBphi180 h.plotdataIBphi270];
    h.LegDataInt = [h.plotdataIntphi0 h.plotdataIBphi90 h.plotdataIntphi180 h.plotdataIntphi270];
end

% Legend for plot of d-spacings
h.legdspacing = legend(h.axesplotdspacing,h.LegDatadspacing,h.LegLabelData);
h.legdspacing.Visible = 'on';
% legdspacing = h.legdspacing;
% assignin('base','legdspacing',legdspacing)
title(h.legdspacing,label(valueSlider,:))
% Create legend for plot of IB and Int.Intensity, depending on phi
% if ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270) ...
%         || isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270) ...
%         || ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270) ...
%         || isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270) ...
%         || ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270) ...
%         || isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270) ...
%         || isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270) ...
%         || isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270) ...
%         || ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270) ...
%         || isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270) ...
%         || ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
    h.legIB = legend(h.axesplotIB,h.LegDataIB,h.LegLabelData);
    h.legInt = legend(h.axesplotInt,h.LegDataInt,h.LegLabelData);
% else
%     h.legIB = legend(h.axesplotIB,h.LegLabelData);
%     h.legInt = legend(h.axesplotInt,h.LegLabelData);
% end
% Legend for plot of integral width
h.legIB.Visible = 'on';
title(h.legIB,label(valueSlider,:))
% Legend for plot of intensity
h.legInt.Visible = 'on';
title(h.legInt,label(valueSlider,:))
%% Plot window fit data
% Get slider value
set(h.SliderFitData, 'Value', 1);
valueSliderFit = get(h.SliderFitData, 'Value');

% Load "DiffractionLines" variable, depending on diffractometer used
if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    % Change slider parameters according to number of Measurements
    if length(h.Measurement) == 1
        set(h.SliderFitData,'Min',0);
        set(h.SliderFitData,'Max',length(h.Measurement));
        set(h.SliderFitData,'SliderStep',[1 1]);
    else
        set(h.SliderFitData,'Min',1);
%         set(h.SliderFitData,'Max',length(h.Measurement));
%         set(h.SliderFitData,'SliderStep',[1/(length(h.Measurement)-1) 1/(length(h.Measurement)-1)]);
        set(h.SliderFitData,'Max',length(h.Params.Psi_Winkel{valueSlider}));
        set(h.SliderFitData,'SliderStep',[1/(length(h.Params.Psi_Winkel{valueSlider})-1) 1/(length(h.Params.Psi_Winkel{valueSlider})-1)]);
%         assignin('base','SliderFitData',h.SliderFitData)
    end
    % Set plot data of raw and fitted data
    set(h.plotrawdata1,{'xdata','Visible'},{h.DataTmp{valueSliderFit}(:,1),'on'})
    set(h.plotrawdata1,{'ydata','Visible'},{h.DataTmp{valueSliderFit}(:,2),'on'})
    % Set data of fitted plots according to current slider value
    % RawData for current slider value
    XFit = h.DataTmp{valueSliderFit}(:, 1);
    YFit = h.DataTmp{valueSliderFit}(:, 2);
    % Fit-Data for current slider value
    XPlot = XFit;
    YPlot = zeros(size(XPlot));
    % 
    FittedPeakstmp = h.FittedPeaks;
elseif strcmp(h.Diffsel,'LEDDI')
    if length(h.Measurement) == 1
        set(h.SliderFitData,'Min',0);
        set(h.SliderFitData,'Max',length(h.Measurement));
        set(h.SliderFitData,'SliderStep',[1 1]);
    else
        set(h.SliderFitData,'Min',1);
        set(h.SliderFitData,'Max',length(h.Params.Psi_Winkel{valueSlider}));
        set(h.SliderFitData,'SliderStep',[1/(length(h.Params.Psi_Winkel{valueSlider})-1) 1/(length(h.Params.Psi_Winkel{valueSlider})-1)]);
    end
    
    if strcmp(h.Detsel,'Detector 1')
        % Set plot data of raw and fitted data
        set(h.plotrawdata1,{'xdata','Visible'},{h.DataTmp{SliderstepsDet1(valueSliderFit)}(:,1),'on'})
        set(h.plotrawdata1,{'ydata','Visible'},{h.DataTmp{SliderstepsDet1(valueSliderFit)}(:,2),'on'})
        % Set data of fitted plots according to current slider value
        % RawData for current slider value
        XFit = h.DataTmp{SliderstepsDet1(valueSliderFit)}(:, 1);
        YFit = h.DataTmp{SliderstepsDet1(valueSliderFit)}(:, 2);
        % Fit-Data for current slider value
        XPlot = XFit;
        YPlot = zeros(size(XPlot));
        % 
        FittedPeakstmp = h.FittedPeaksDet1;
    elseif strcmp(h.Detsel,'Detector 2')
        % Set plot data of raw and fitted data
        set(h.plotrawdata1,{'xdata','Visible'},{h.DataTmp{SliderstepsDet2(valueSliderFit)}(:,1),'on'})
        set(h.plotrawdata1,{'ydata','Visible'},{h.DataTmp{SliderstepsDet2(valueSliderFit)}(:,2),'on'})
        % Set data of fitted plots according to current slider value
        % RawData for current slider value
        XFit = h.DataTmp{SliderstepsDet2(valueSliderFit)}(:, 1);
        YFit = h.DataTmp{SliderstepsDet2(valueSliderFit)}(:, 2);
        % Fit-Data for current slider value
        XPlot = XFit;
        YPlot = zeros(size(XPlot));
        % 
        FittedPeakstmp = h.FittedPeaksDet2;
    end
end

% Calculate fitted profile using Fitted PeakData for current slider value
for d = 1:size(FittedPeakstmp{valueSliderFit}, 1)
    if h.P.PopupValueFitFunc == 2 %PV-Func
        SinglePlot = Tools.Science.Math.FF_PseudoVoigt(XPlot, ...
        FittedPeakstmp{valueSliderFit}(d, 1), FittedPeakstmp{valueSliderFit}(d, 2), FittedPeakstmp{valueSliderFit}(d, 3),FittedPeakstmp{valueSliderFit}(d, 4));
    elseif h.P.PopupValueFitFunc == 3 %TCH
        SinglePlot = Tools.Science.Math.FF_TCH(XPlot, ...
        FittedPeakstmp{valueSliderFit}(d, 1), FittedPeakstmp{valueSliderFit}(d, 2), FittedPeakstmp{valueSliderFit}(d, 3),FittedPeakstmp{valueSliderFit}(d, 4));
    elseif h.P.PopupValueFitFunc == 4 %Gauss-Func
        SinglePlot = Tools.Science.Math.FF_Gauss(XPlot, ...
        FittedPeakstmp{valueSliderFit}(d, 1), FittedPeakstmp{valueSliderFit}(d, 2), FittedPeakstmp{valueSliderFit}(d, 3));
    elseif h.P.PopupValueFitFunc == 5 %Lorentz-Func
        SinglePlot = Tools.Science.Math.FF_Lorentz(XPlot, ...
        FittedPeakstmp{valueSliderFit}(d, 1), FittedPeakstmp{valueSliderFit}(d, 2), FittedPeakstmp{valueSliderFit}(d, 3));
    end
%     SinglePlot = Tools.Science.Math.FF_PseudoVoigt(XPlot, ...
%         FittedPeakstmp{valueSliderFit}(d, 1), FittedPeakstmp{valueSliderFit}(d, 2), FittedPeakstmp{valueSliderFit}(d, 3),FittedPeakstmp{valueSliderFit}(d, 4));
    YPlot = YPlot + SinglePlot;
end

% Add plots of fitted peaks to axes for current slider value
set(h.plotfitdata1,'xdata',XPlot)
set(h.plotfitdata1,'ydata',YPlot)
set(h.plotfitdata1,'visible','on')
set(h.plotresiualdata1,'xdata',XFit)
% Scale value for plotting the residual - 13.03.2018 - Residual not shown
% anymore in plot window
if valueSliderFit == 1
    scalevalue = valueSliderFit.*1;
else
    scalevalue = valueSliderFit.*0.5;
end

YFitPlotdata = (YFit - interp1(XPlot,YPlot,XFit)) - (max(YFit) .* 0.5.*(scalevalue));

% Set ydata of plot residual
set(h.plotresiualdata1,'ydata',YFitPlotdata)
set(h.plotresiualdata1,'visible','off')
% Set plot properties
if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    set(h.axesplotfitdata.Title,'String',['Fitted peaks for ', h.Measurement(valueSliderFit).Name])
elseif strcmp(h.Diffsel,'LEDDI')
    if strcmp(h.Detsel,'Detector 1')
        set(h.axesplotfitdata.Title,'String',['Fitted peaks for ', h.Measurement(SliderstepsDet1(valueSliderFit)).Name])
    elseif strcmp(h.Detsel,'Detector 2')
        set(h.axesplotfitdata.Title,'String',['Fitted peaks for ', h.Measurement(SliderstepsDet2(valueSliderFit)).Name])
    end
end

for k = 1:size(h.Params.Energy_Max,2)
    h.XLimEnergy{k} = h.Params.Energy_Max{1,k}(1);
end

% Get slider value
valueSliderStressData = get(h.SliderPlotStressData, 'Value');
% Set axes limits
h.axesplotfitdata.XLim = [min(h.Params.Energy_Max{valueSliderStressData}(valueSliderFit))-1.5,max(h.Params.Energy_Max{valueSliderStressData}(valueSliderFit))+1.5];
h.axesplotfitdata.YLim = [-Inf Inf];
% Create text element with value of psi angle
% Delete current text element and replace with new one when slider is
% pushed
if isfield(h,'ptext')
    delete(h.ptext)
end

if numel(num2str(h.Params.Psi_Winkel{valueSliderFit}(1))) == 1
    h.ptext = text(h.axesplotfitdata,0.903,0.92,['\psi =',' ', num2str(h.Params.Psi_Winkel{valueSliderFit}(1)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');
elseif numel(num2str(h.Params.Psi_Winkel{valueSliderFit}(1))) == 2
    h.ptext = text(h.axesplotfitdata,0.89,0.92,['\psi =',' ', num2str(h.Params.Psi_Winkel{valueSliderFit}(1)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');
elseif numel(num2str(h.Params.Psi_Winkel{valueSliderFit}(1))) == 5
    h.ptext = text(h.axesplotfitdata,0.859,0.92,['\psi =',' ', num2str(h.Params.Psi_Winkel{valueSliderFit}(1)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');
end

%% Plot window stress data
% SliderStressData needs to be adjusted according to the number of phi
% angles. For now it is set to one.
% Get slider value
set(h.SliderPlotStressData, 'Value', 1);
valueSliderStress = get(h.SliderPlotStressData, 'Value');

% Change slider parameters according to number of stress components
if length(ia{1}) == 1
    set(h.SliderPlotStressData,'Min',0);
    set(h.SliderPlotStressData,'Max',length(ia{1}));
    set(h.SliderPlotStressData,'SliderStep',[1 1]);
else
    set(h.SliderPlotStressData,'Min',1);
    set(h.SliderPlotStressData,'Max',length(ia{1}));
    set(h.SliderPlotStressData,'SliderStep',[1/(length(ia{1})-1) 1/(length(ia{1})-1)]);
end
% Delete field if already present, in case of reloading stress data with
% different number of peaks, set scatter plots "visible" to "off"
if isfield(h, 'ScatterData')
    delete(findobj(h.axesplotstressdata, 'type', 'scatter', 'visible', 'on'))
    h = rmfield(h,'ScatterData');
end

if isfield(h, 'ScatterData')
	for j = 1:length(ia{1})
		for k = 1:size(h.ScatterData(j).StressesPhi,2)
			h.ScatterData(j).StressesPhi(k).Visible = 'off';
		end
	end	
end

% %% Select hkl values to be plotted
% h.sin2psi.StressPlotDatatmpsorted = h.sin2psi.StressPlotDatatmpsorted(1:end,:);

%% Set stress data for stress plot
if length(ia{1}) == 1
    for k = 1:size(h.sin2psi.StressPlotDatatmpsorted,1)
        h.ScatterData(1).StressesPhi(:,k) = scatter(h.axesplotstressdata, h.sin2psi.StressPlotDatatmpsorted(k,1),h.sin2psi.StressPlotDatatmpsorted(k,2),200,'Marker','s','MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'LineWidth',1.5);
    end
elseif length(ia{1}) == 2
    for k = 1:size(h.sin2psi.StressPlotDatatmpsorted,1)
        h.ScatterData(1).StressesPhi(:,k) = scatter(h.axesplotstressdata, h.sin2psi.StressPlotDatatmpsorted(k,1),h.sin2psi.StressPlotDatatmpsorted(k,2),200,'Marker','s','MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'LineWidth',1.5);
        h.ScatterData(2).StressesPhi(:,k) = scatter(h.axesplotstressdata, h.sin2psi.StressPlotDatatmpsorted(k,1),h.sin2psi.StressPlotDatatmpsorted(k,4),200,'Marker','s','MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'LineWidth',1.5);
    end
elseif length(ia{1}) == 3
    for k = 1:size(h.sin2psi.StressPlotDatatmpsorted,1)
        h.ScatterData(1).StressesPhi(:,k) = scatter(h.axesplotstressdata, h.sin2psi.StressPlotDatatmpsorted(k,1),h.sin2psi.StressPlotDatatmpsorted(k,2),200,'Marker','s','MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'LineWidth',1.5);
        h.ScatterData(2).StressesPhi(:,k) = scatter(h.axesplotstressdata, h.sin2psi.StressPlotDatatmpsorted(k,1),h.sin2psi.StressPlotDatatmpsorted(k,4),200,'Marker','s','MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'LineWidth',1.5);
        h.ScatterData(3).StressesPhi(:,k) = scatter(h.axesplotstressdata, h.sin2psi.StressPlotDatatmpsorted(k,1),h.sin2psi.StressPlotDatatmpsorted(k,6),200,'Marker','s','MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'LineWidth',1.5);
    end
elseif length(ia{1}) == 4
    for k = 1:size(h.sin2psi.StressPlotDatatmpsorted,1)
        h.ScatterData(1).StressesPhi(:,k) = scatter(h.axesplotstressdata, h.sin2psi.StressPlotDatatmpsorted(k,1),h.sin2psi.StressPlotDatatmpsorted(k,2),200,'Marker','s','MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'LineWidth',1.5);
        h.ScatterData(2).StressesPhi(:,k) = scatter(h.axesplotstressdata, h.sin2psi.StressPlotDatatmpsorted(k,1),h.sin2psi.StressPlotDatatmpsorted(k,4),200,'Marker','s','MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'LineWidth',1.5);
        h.ScatterData(3).StressesPhi(:,k) = scatter(h.axesplotstressdata, h.sin2psi.StressPlotDatatmpsorted(k,1),h.sin2psi.StressPlotDatatmpsorted(k,6),200,'Marker','s','MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'LineWidth',1.5);
        h.ScatterData(4).StressesPhi(:,k) = scatter(h.axesplotstressdata, h.sin2psi.StressPlotDatatmpsorted(k,1),h.sin2psi.StressPlotDatatmpsorted(k,8),200,'Marker','s','MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'LineWidth',1.5);
    end
end

% Set scatter plot visibility off if not active
for j = 1:length(ia{1})
    if j ~= valueSliderStress
        for k = 1:size(h.sin2psi.StressPlotDatatmpsorted,1)
            h.ScatterData(j).StressesPhi(k).Visible = 'off';
        end
    else
        for k = 1:size(h.sin2psi.StressPlotDatatmpsorted,1)
            h.ScatterData(j).StressesPhi(k).Visible = 'on';
        end
    end
end

% Create label for stress plot
Peaks = h.PeaksforLabel;
% Read hkl values from array
for ii = 1:size(Peaks,1)
	hkllabeltmp(ii,:) = mat2str(Peaks(ii,(1:3)));
end
% Remove '[' and ']' from character array
for ii = 1:size(hkllabeltmp,1)
    hkllabeltmp1(ii,:) = regexprep(hkllabeltmp(ii,:),'[','');
end

for ii = 1:size(hkllabeltmp,1)
    hkllabeltmp2(ii,:) = regexprep(hkllabeltmp1(ii,:),']','');
end
% Final output with hkl values
hkllabel = hkllabeltmp2;
h.LabelForPlot = hkllabel;

% Create legend for stress plot
h.legstressdata = legend(h.axesplotstressdata, [h.ScatterData(valueSliderStress).StressesPhi], hkllabel);
h.legstressdata.Visible = 'on';
h.legstressdata.FontSize = 15;
h.legstressdata.Location = 'northeast';
% Set plot properties
set(h.plotstressdata,{'xdata','visible'},{h.sin2psi.StressPlotDatatmpsorted(:,1),'on'})
set(h.plotstressdata,{'ydata','visible'},{h.sin2psi.StressPlotDatatmpsorted(:,2),'on'})
set(h.plotstressdata,{'YNegativeDelta','visible'},{h.sin2psi.StressPlotDatatmpsorted(:,3),'on'})
set(h.plotstressdata,{'YPositiveDelta','visible'},{h.sin2psi.StressPlotDatatmpsorted(:,3),'on'})
set(h.plotstressdata,'LineStyle', '--')
% Set axis label
if valueSliderStress == 1
    % Set axis label
    if length(PhiWinkel{1}) == 2 && PhiWinkel{1}(1) == 90 && PhiWinkel{1}(2) == 270
        ylabel(h.axesplotstressdata,'<\sigma_{22} - \sigma_{33}> [MPa]')
    else
        ylabel(h.axesplotstressdata,'<\sigma_{11} - \sigma_{33}> [MPa]')  
    end
end
% Set axis limits
if size(h.sin2psi.StressPlotDatatmpsorted,1) == 1
    h.axesplotstressdata.XLim = [0,(ceil(max(h.sin2psi.StressPlotDatatmpsorted(:,1))*0.1)/0.1 + (ceil(max(h.sin2psi.StressPlotDatatmpsorted(:,1))*0.1)/0.1)./2)];
    if min(h.sin2psi.StressPlotDatatmpsorted(:,2)) > 0
        h.axesplotstressdata.YLim = [0,round(max(h.sin2psi.StressPlotDatatmpsorted(:,2))+max(h.sin2psi.StressPlotDatatmpsorted(:,3))*0.1,-1)];
    elseif min(h.sin2psi.StressPlotDatatmpsorted(:,2)) < 0
        h.axesplotstressdata.YLim = [-1*abs(round(max(h.sin2psi.StressPlotDatatmpsorted(:,2))+max(h.sin2psi.StressPlotDatatmpsorted(:,3))*0.1)),0];
    end
%     assignin('base','sin2psi',h.sin2psi)
else
    h.axesplotstressdata.XLim = [0,(ceil(max(h.sin2psi.StressPlotDatatmpsorted(:,1))*0.1)/0.1)];
    YLimErr = [(min(h.sin2psi.StressPlotDatatmpsorted(:,2)) + max(h.sin2psi.StressPlotDatatmpsorted(:,3))) ...
        (min(h.sin2psi.StressPlotDatatmpsorted(:,2)) - max(h.sin2psi.StressPlotDatatmpsorted(:,3))) ...
        (max(h.sin2psi.StressPlotDatatmpsorted(:,2)) + max(h.sin2psi.StressPlotDatatmpsorted(:,3))) ...
        (max(h.sin2psi.StressPlotDatatmpsorted(:,2)) - max(h.sin2psi.StressPlotDatatmpsorted(:,3)))];

    YLimtmp = [min(YLimErr) max(YLimErr)];

    YLimMinExpFactor = 1*10^(numel(num2str(abs(round(YLimtmp(1)))))-1);
    YLimMaxExpFactor = 1*10^(numel(num2str(abs(round(YLimtmp(2)))))-1);

    h.axesplotstressdata.YLim = [-(abs(floor(YLimtmp(1)/YLimMinExpFactor))*YLimMinExpFactor), ceil(YLimtmp(2)/YLimMaxExpFactor)*YLimMaxExpFactor];
end
xticks(h.axesplotstressdata,'auto')
yticks(h.axesplotstressdata,'auto')
% Set title
title(h.axesplotstressdata,['Residual stress data for ',strrep(h.Measurement(1).MeasurementSeries,' ','')], 'HorizontalAlignment', 'center', 'Interpreter', 'none')

% Reset the button color
set(hObj,'str','Load stress data','backg',col)  % Now reset the button features.
% assignin('base','ParamsToFitLoadStress',h.ParamsToFit)
% assignin('base','Params',h.Params)
% DEKdattatmp = get(h.loadDEKtable,'data');
% assignin('base','sin2psiLoadStressData',h.sin2psi)
% Delete text object from unknown origin from axes since it conflicts with
% loading a new measurement file
% assignin('base','axesplotdspacingloadstressdata',h.axesplotdspacing)
if size(h.axesplotdspacing.Children,1) == 9
    delete(h.axesplotdspacing.Children(1))
end
% assignin('base','axesplotdspacingloadstressdatamod',h.axesplotdspacing)
% assignin('base','hsin2psiloadstress',h.sin2psi)
guidata(hObj, h);

function buttonmodifystressdata(hObj, ~)
% Function to load data for the "Stress Analysis" tab.
h = guidata(hObj);

% Get value of checkbox "fit data from both detectors"
FitBothDet = get(h.checkboxFitBothDetectors,'value');
% Slidersteps
SliderstepsDet1 = 2:2:length(h.Measurement);
SliderstepsDet2 = 1:2:length(h.Measurement);
% Get slider value
valueSlider = get(h.SliderStressData, 'Value');
valueSliderStress = get(h.SliderPlotStressData, 'Value');
% Get checkbox values
CheckBoxesPhi = [get(h.checkboxphi0,'Value'),get(h.checkboxphi90,'Value'),get(h.checkboxphi180,'Value'),get(h.checkboxphi270,'Value')];
% Get phi angles
% assignin('base','axesplotdspacingorg',h.axesplotdspacing)
for k = 1:size(h.Params.Phi_Winkel,2)
	[PhiWinkel{k},ia{k},~] = unique(h.Params.Phi_Winkel{k});
end
% assignin('base','PhiWinkel',PhiWinkel)
% assignin('base','Params',h.Params)
% Run function used to delete data point from plot
[pointslist,xselect,yselect] = selectdatastressvalues('Handle',h.axesplotdspacing,'CheckBoxesPhi',CheckBoxesPhi,'PhiWinkel',PhiWinkel,'sel','closest','action','delete','verify','on');
% Update modified peak data depending on the choosen phi angle
if CheckBoxesPhi(1) == 1
    % Phi = 0°
    % Load x and y data from IB and Int.Intensity plots
    PointsXIB = get(h.plotdataIBphi0,'xdata');
    PointsYIB = get(h.plotdataIBphi0,'ydata');
    PointsXInt = get(h.plotdataIntphi0,'xdata');
    PointsYInt = get(h.plotdataIntphi0,'ydata');
    % Delete points using index pointslist
    PointsXIB(pointslist) = [];
    PointsYIB(pointslist) = [];
    PointsXInt(pointslist) = [];
    PointsYInt(pointslist) = [];
    % Save changed data to handle
    set(h.plotdataIBphi0,'xdata',PointsXIB);
    set(h.plotdataIBphi0,'ydata',PointsYIB);
    set(h.plotdataIntphi0,'xdata',PointsXInt);
    set(h.plotdataIntphi0,'ydata',PointsYInt);
    % Modify Params array
    h.ParamsToFit(1).Energy_Max{valueSlider}(pointslist) = [];
    h.ParamsToFit(1).FWHM{valueSlider}(pointslist) = [];
    h.ParamsToFit(1).IntegralWidth{valueSlider}(pointslist) = [];
    h.ParamsToFit(1).Intensity_Int{valueSlider}(pointslist) = [];
    h.ParamsToFit(1).LatticeSpacing{valueSlider}(pointslist) = [];
    h.ParamsToFit(1).LatticeSpacing_Delta{valueSlider}(pointslist) = [];
    h.ParamsToFit(1).Psi_Winkel{valueSlider}(pointslist) = [];
    h.ParamsToFit(1).Phi_Winkel{valueSlider}(pointslist) = [];
    h.ParamsToFit(1).LatticeSpacingInterpol{valueSlider}(pointslist) = [];
    h.ParamsToFit(1).LatticeSpacing_DeltaInterpol{valueSlider}(pointslist) = [];
elseif CheckBoxesPhi(2) == 1
    % Phi = 90°
    % Load x and y data from IB and Int.Intensity plots
    PointsXIB = get(h.plotdataIBphi90,'xdata');
    PointsYIB = get(h.plotdataIBphi90,'ydata');
    PointsXInt = get(h.plotdataIntphi90,'xdata');
    PointsYInt = get(h.plotdataIntphi90,'ydata');
    % Delete points using index pointslist
    PointsXIB(pointslist) = [];
    PointsYIB(pointslist) = [];
    PointsXInt(pointslist) = [];
    PointsYInt(pointslist) = [];
    % Save changed data to handle
    set(h.plotdataIBphi90,'xdata',PointsXIB);
    set(h.plotdataIBphi90,'ydata',PointsYIB);
    set(h.plotdataIntphi90,'xdata',PointsXInt);
    set(h.plotdataIntphi90,'ydata',PointsYInt);
    % Modify Params array
    if length(ia{1}) == 1
        h.ParamsToFit(1).Energy_Max{valueSlider}(pointslist) = [];
        h.ParamsToFit(1).FWHM{valueSlider}(pointslist) = [];
        h.ParamsToFit(1).IntegralWidth{valueSlider}(pointslist) = [];
        h.ParamsToFit(1).Intensity_Int{valueSlider}(pointslist) = [];
        h.ParamsToFit(1).LatticeSpacing{valueSlider}(pointslist) = [];
        h.ParamsToFit(1).LatticeSpacing_Delta{valueSlider}(pointslist) = [];
        h.ParamsToFit(1).Psi_Winkel{valueSlider}(pointslist) = [];
        h.ParamsToFit(1).Phi_Winkel{valueSlider}(pointslist) = [];
        h.ParamsToFit(1).LatticeSpacingInterpol{valueSlider}(pointslist) = [];
        h.ParamsToFit(1).LatticeSpacing_DeltaInterpol{valueSlider}(pointslist) = [];
    elseif length(ia{1}) == 2
        PhiInd = find(PhiWinkel{1}==90);
        if PhiInd == 2
            % Phi = 0°/90°
            h.ParamsToFit(2).Energy_Max{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).FWHM{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).IntegralWidth{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).Intensity_Int{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).LatticeSpacing{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).LatticeSpacing_Delta{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).Psi_Winkel{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).Phi_Winkel{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).LatticeSpacingInterpol{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).LatticeSpacing_DeltaInterpol{valueSlider}(pointslist) = [];
        elseif PhiInd == 1
            % Phi = 90°/180° or Phi = 90°/270°
            h.ParamsToFit(1).Energy_Max{valueSlider}(pointslist) = [];
            h.ParamsToFit(1).FWHM{valueSlider}(pointslist) = [];
            h.ParamsToFit(1).IntegralWidth{valueSlider}(pointslist) = [];
            h.ParamsToFit(1).Intensity_Int{valueSlider}(pointslist) = [];
            h.ParamsToFit(1).LatticeSpacing{valueSlider}(pointslist) = [];
            h.ParamsToFit(1).LatticeSpacing_Delta{valueSlider}(pointslist) = [];
            h.ParamsToFit(1).Psi_Winkel{valueSlider}(pointslist) = [];
            h.ParamsToFit(1).Phi_Winkel{valueSlider}(pointslist) = [];
            h.ParamsToFit(1).LatticeSpacingInterpol{valueSlider}(pointslist) = [];
            h.ParamsToFit(1).LatticeSpacing_DeltaInterpol{valueSlider}(pointslist) = [];
        end
    elseif length(ia{1}) == 3
        PhiInd = find(PhiWinkel{1}==90);
        if PhiInd == 2
            % Phi = 0°/90°/180° or Phi = 0°/90°/270°
            h.ParamsToFit(2).Energy_Max{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).FWHM{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).IntegralWidth{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).Intensity_Int{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).LatticeSpacing{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).LatticeSpacing_Delta{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).Psi_Winkel{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).Phi_Winkel{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).LatticeSpacingInterpol{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).LatticeSpacing_DeltaInterpol{valueSlider}(pointslist) = [];
        elseif PhiInd == 1
            % Phi = 90°/180°/270°
            h.ParamsToFit(1).Energy_Max{valueSlider}(pointslist) = [];
            h.ParamsToFit(1).FWHM{valueSlider}(pointslist) = [];
            h.ParamsToFit(1).IntegralWidth{valueSlider}(pointslist) = [];
            h.ParamsToFit(1).Intensity_Int{valueSlider}(pointslist) = [];
            h.ParamsToFit(1).LatticeSpacing{valueSlider}(pointslist) = [];
            h.ParamsToFit(1).LatticeSpacing_Delta{valueSlider}(pointslist) = [];
            h.ParamsToFit(1).Psi_Winkel{valueSlider}(pointslist) = [];
            h.ParamsToFit(1).Phi_Winkel{valueSlider}(pointslist) = [];
            h.ParamsToFit(1).LatticeSpacingInterpol{valueSlider}(pointslist) = [];
            h.ParamsToFit(1).LatticeSpacing_DeltaInterpol{valueSlider}(pointslist) = [];
        end
    elseif length(ia{1}) == 4
        % Phi = 0°/90°/180°/270°
        h.ParamsToFit(2).Energy_Max{valueSlider}(pointslist) = [];
        h.ParamsToFit(2).FWHM{valueSlider}(pointslist) = [];
        h.ParamsToFit(2).IntegralWidth{valueSlider}(pointslist) = [];
        h.ParamsToFit(2).Intensity_Int{valueSlider}(pointslist) = [];
        h.ParamsToFit(2).LatticeSpacing{valueSlider}(pointslist) = [];
        h.ParamsToFit(2).LatticeSpacing_Delta{valueSlider}(pointslist) = [];
        h.ParamsToFit(2).Psi_Winkel{valueSlider}(pointslist) = [];
        h.ParamsToFit(2).Phi_Winkel{valueSlider}(pointslist) = [];
        h.ParamsToFit(2).LatticeSpacingInterpol{valueSlider}(pointslist) = [];
        h.ParamsToFit(2).LatticeSpacing_DeltaInterpol{valueSlider}(pointslist) = [];
    end
elseif CheckBoxesPhi(3) == 1
    % Phi = 180°
    % Load x and y data from IB and Int.Intensity plots
    PointsXIB = get(h.plotdataIBphi180,'xdata');
    PointsYIB = get(h.plotdataIBphi180,'ydata');
    PointsXInt = get(h.plotdataIntphi180,'xdata');
    PointsYInt = get(h.plotdataIntphi180,'ydata');
    % Delete points using index pointslist
    PointsXIB(pointslist) = [];
    PointsYIB(pointslist) = [];
    PointsXInt(pointslist) = [];
    PointsYInt(pointslist) = [];
    % Save changed data to handle
    set(h.plotdataIBphi180,'xdata',PointsXIB);
    set(h.plotdataIBphi180,'ydata',PointsYIB);
    set(h.plotdataIntphi180,'xdata',PointsXInt);
    set(h.plotdataIntphi180,'ydata',PointsYInt);
    % Modify Params array
    if length(ia{1}) == 1
        h.ParamsToFit(1).Energy_Max{valueSlider}(pointslist) = [];
        h.ParamsToFit(1).FWHM{valueSlider}(pointslist) = [];
        h.ParamsToFit(1).IntegralWidth{valueSlider}(pointslist) = [];
        h.ParamsToFit(1).Intensity_Int{valueSlider}(pointslist) = [];
        h.ParamsToFit(1).LatticeSpacing{valueSlider}(pointslist) = [];
        h.ParamsToFit(1).LatticeSpacing_Delta{valueSlider}(pointslist) = [];
        h.ParamsToFit(1).Psi_Winkel{valueSlider}(pointslist) = [];
        h.ParamsToFit(1).Phi_Winkel{valueSlider}(pointslist) = [];
        h.ParamsToFit(1).LatticeSpacingInterpol{valueSlider}(pointslist) = [];
        h.ParamsToFit(1).LatticeSpacing_DeltaInterpol{valueSlider}(pointslist) = [];
    elseif length(ia{1}) == 2
        PhiInd = find(PhiWinkel{1}==180);
        if PhiInd == 2
            % Phi = 0°/180° or 90°/180°
%             assignin('base','ParamsToFitBefore',h.ParamsToFit)
            h.ParamsToFit(2).Energy_Max{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).FWHM{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).IntegralWidth{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).Intensity_Int{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).LatticeSpacing{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).LatticeSpacing_Delta{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).Psi_Winkel{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).Phi_Winkel{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).LatticeSpacingInterpol{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).LatticeSpacing_DeltaInterpol{valueSlider}(pointslist) = [];
%             assignin('base','ParamsToFitAfter',h.ParamsToFit)
        elseif PhiInd == 1
            % Phi = 180°/270°
            h.ParamsToFit(1).Energy_Max{valueSlider}(pointslist) = [];
            h.ParamsToFit(1).FWHM{valueSlider}(pointslist) = [];
            h.ParamsToFit(1).IntegralWidth{valueSlider}(pointslist) = [];
            h.ParamsToFit(1).Intensity_Int{valueSlider}(pointslist) = [];
            h.ParamsToFit(1).LatticeSpacing{valueSlider}(pointslist) = [];
            h.ParamsToFit(1).LatticeSpacing_Delta{valueSlider}(pointslist) = [];
            h.ParamsToFit(1).Psi_Winkel{valueSlider}(pointslist) = [];
            h.ParamsToFit(1).Phi_Winkel{valueSlider}(pointslist) = [];
            h.ParamsToFit(1).LatticeSpacingInterpol{valueSlider}(pointslist) = [];
            h.ParamsToFit(1).LatticeSpacing_DeltaInterpol{valueSlider}(pointslist) = [];
        end
    elseif length(ia{1}) == 3
        PhiInd = find(PhiWinkel{1}==180);
        if PhiInd == 3
            % Phi = 0°/90°/180°
            h.ParamsToFit(3).Energy_Max{valueSlider}(pointslist) = [];
            h.ParamsToFit(3).FWHM{valueSlider}(pointslist) = [];
            h.ParamsToFit(3).IntegralWidth{valueSlider}(pointslist) = [];
            h.ParamsToFit(3).Intensity_Int{valueSlider}(pointslist) = [];
            h.ParamsToFit(3).LatticeSpacing{valueSlider}(pointslist) = [];
            h.ParamsToFit(3).LatticeSpacing_Delta{valueSlider}(pointslist) = [];
            h.ParamsToFit(3).Psi_Winkel{valueSlider}(pointslist) = [];
            h.ParamsToFit(3).Phi_Winkel{valueSlider}(pointslist) = [];
            h.ParamsToFit(3).LatticeSpacingInterpol{valueSlider}(pointslist) = [];
            h.ParamsToFit(3).LatticeSpacing_DeltaInterpol{valueSlider}(pointslist) = [];
        elseif PhiInd == 2
            % Phi = 0°/180°/270° or Phi = 90°/180°/270°
            h.ParamsToFit(2).Energy_Max{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).FWHM{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).IntegralWidth{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).Intensity_Int{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).LatticeSpacing{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).LatticeSpacing_Delta{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).Psi_Winkel{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).Phi_Winkel{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).LatticeSpacingInterpol{valueSlider}(pointslist) = [];
            h.ParamsToFit(2).LatticeSpacing_DeltaInterpol{valueSlider}(pointslist) = [];
        end
    elseif length(ia{1}) == 4
        % Phi = 0°/90°/180°/270°
        h.ParamsToFit(3).Energy_Max{valueSlider}(pointslist) = [];
        h.ParamsToFit(3).FWHM{valueSlider}(pointslist) = [];
        h.ParamsToFit(3).IntegralWidth{valueSlider}(pointslist) = [];
        h.ParamsToFit(3).Intensity_Int{valueSlider}(pointslist) = [];
        h.ParamsToFit(3).LatticeSpacing{valueSlider}(pointslist) = [];
        h.ParamsToFit(3).LatticeSpacing_Delta{valueSlider}(pointslist) = [];
        h.ParamsToFit(3).Psi_Winkel{valueSlider}(pointslist) = [];
        h.ParamsToFit(3).Phi_Winkel{valueSlider}(pointslist) = [];
        h.ParamsToFit(3).LatticeSpacingInterpol{valueSlider}(pointslist) = [];
        h.ParamsToFit(3).LatticeSpacing_DeltaInterpol{valueSlider}(pointslist) = [];
    end
elseif CheckBoxesPhi(4) == 1
    % Phi = 270°
    % Load x and y data from IB and Int.Intensity plots
    PointsXIB = get(h.plotdataIBphi270,'xdata');
    PointsYIB = get(h.plotdataIBphi270,'ydata');
    PointsXInt = get(h.plotdataIntphi270,'xdata');
    PointsYInt = get(h.plotdataIntphi270,'ydata');
    % Delete points using index pointslist
    PointsXIB(pointslist) = [];
    PointsYIB(pointslist) = [];
    PointsXInt(pointslist) = [];
    PointsYInt(pointslist) = [];
    % Save changed data to handle
    set(h.plotdataIBphi270,'xdata',PointsXIB);
    set(h.plotdataIBphi270,'ydata',PointsYIB);
    set(h.plotdataIntphi270,'xdata',PointsXInt);
    set(h.plotdataIntphi270,'ydata',PointsYInt);
    % Modify Params array
    if length(ia{1}) == 1
        h.ParamsToFit(1).Energy_Max{valueSlider}(pointslist) = [];
        h.ParamsToFit(1).FWHM{valueSlider}(pointslist) = [];
        h.ParamsToFit(1).IntegralWidth{valueSlider}(pointslist) = [];
        h.ParamsToFit(1).Intensity_Int{valueSlider}(pointslist) = [];
        h.ParamsToFit(1).LatticeSpacing{valueSlider}(pointslist) = [];
        h.ParamsToFit(1).LatticeSpacing_Delta{valueSlider}(pointslist) = [];
        h.ParamsToFit(1).Psi_Winkel{valueSlider}(pointslist) = [];
        h.ParamsToFit(1).Phi_Winkel{valueSlider}(pointslist) = [];
        h.ParamsToFit(1).LatticeSpacingInterpol{valueSlider}(pointslist) = [];
        h.ParamsToFit(1).LatticeSpacing_DeltaInterpol{valueSlider}(pointslist) = [];
    elseif length(ia{1}) == 2
        h.ParamsToFit(2).Energy_Max{valueSlider}(pointslist) = [];
        h.ParamsToFit(2).FWHM{valueSlider}(pointslist) = [];
        h.ParamsToFit(2).IntegralWidth{valueSlider}(pointslist) = [];
        h.ParamsToFit(2).Intensity_Int{valueSlider}(pointslist) = [];
        h.ParamsToFit(2).LatticeSpacing{valueSlider}(pointslist) = [];
        h.ParamsToFit(2).LatticeSpacing_Delta{valueSlider}(pointslist) = [];
        h.ParamsToFit(2).Psi_Winkel{valueSlider}(pointslist) = [];
        h.ParamsToFit(2).Phi_Winkel{valueSlider}(pointslist) = [];
        h.ParamsToFit(2).LatticeSpacingInterpol{valueSlider}(pointslist) = [];
        h.ParamsToFit(2).LatticeSpacing_DeltaInterpol{valueSlider}(pointslist) = [];
    elseif length(ia{1}) == 3
        h.ParamsToFit(3).Energy_Max{valueSlider}(pointslist) = [];
        h.ParamsToFit(3).FWHM{valueSlider}(pointslist) = [];
        h.ParamsToFit(3).IntegralWidth{valueSlider}(pointslist) = [];
        h.ParamsToFit(3).Intensity_Int{valueSlider}(pointslist) = [];
        h.ParamsToFit(3).LatticeSpacing{valueSlider}(pointslist) = [];
        h.ParamsToFit(3).LatticeSpacing_Delta{valueSlider}(pointslist) = [];
        h.ParamsToFit(3).Psi_Winkel{valueSlider}(pointslist) = [];
        h.ParamsToFit(3).Phi_Winkel{valueSlider}(pointslist) = [];
        h.ParamsToFit(3).LatticeSpacingInterpol{valueSlider}(pointslist) = [];
        h.ParamsToFit(3).LatticeSpacing_DeltaInterpol{valueSlider}(pointslist) = [];    
    else
        h.ParamsToFit(4).Energy_Max{valueSlider}(pointslist) = [];
        h.ParamsToFit(4).FWHM{valueSlider}(pointslist) = [];
        h.ParamsToFit(4).IntegralWidth{valueSlider}(pointslist) = [];
        h.ParamsToFit(4).Intensity_Int{valueSlider}(pointslist) = [];
        h.ParamsToFit(4).LatticeSpacing{valueSlider}(pointslist) = [];
        h.ParamsToFit(4).LatticeSpacing_Delta{valueSlider}(pointslist) = [];
        h.ParamsToFit(4).Psi_Winkel{valueSlider}(pointslist) = [];
        h.ParamsToFit(4).Phi_Winkel{valueSlider}(pointslist) = [];
        h.ParamsToFit(4).LatticeSpacingInterpol{valueSlider}(pointslist) = [];
        h.ParamsToFit(4).LatticeSpacing_DeltaInterpol{valueSlider}(pointslist) = [];
    end
end

% Update original data with modified data.
if length(ia{1}) == 1
    h.Params = h.ParamsToFit;
end    

if length(ia{1}) ~= 1
    for j = 1:size(h.ParamsToFit,2)
        for k = 1:size(h.ParamsToFit(j).LatticeSpacing,2)
            h.PsiforInterpoltmp1{j,k} = h.ParamsToFit(j).Psi_Winkel{k};         
        end
    end
    
    for k = 1:size(h.ParamsToFit(j).LatticeSpacing,2)
        h.PsiforInterpoltmp2 = h.PsiforInterpoltmp1(:,k);
        h.PsiforInterpol{k} = unique(cell2mat(h.PsiforInterpoltmp2));
    end
else
    for k = 1:size(h.Params.LatticeSpacing,2)
        h.PsiforInterpol = h.Params.Psi_Winkel;
    end
end

% 
if length(ia{1}) ~= 1
    for j = 1:size(h.ParamsToFit,2)
        for k = 1:size(h.ParamsToFit(j).LatticeSpacing,2)
                h.ParamsToFit(j).LatticeSpacingInterpol{k} = interp1(h.ParamsToFit(j).Psi_Winkel{k},h.ParamsToFit(j).LatticeSpacing{k},h.PsiforInterpol{k},'linear','extrap');
                h.ParamsToFit(j).LatticeSpacing_DeltaInterpol{k} = interp1(h.ParamsToFit(j).Psi_Winkel{k},h.ParamsToFit(j).LatticeSpacing_Delta{k},h.PsiforInterpol{k},'linear','extrap');
        end
    end
%     assignin('base','ParamsToFitAfterInterpol',h.ParamsToFit)
    % Replace Params values with updated values
%     h.Params.Energy_Max = h.ParamsToFit.Energy_Max;
%     h.Params.FWHM = h.ParamsToFit.FWHM;
%     h.Params.IntegralWidth = h.ParamsToFit.IntegralWidth;
%     h.Params.Intensity_Int = h.ParamsToFit.Intensity_Int;
%     h.Params.LatticeSpacing = h.ParamsToFit.LatticeSpacing;
%     h.Params.LatticeSpacing_Delta = h.ParamsToFit.LatticeSpacing_Delta;
%     h.Params.Psi_Winkel = h.ParamsToFit.Psi_Winkel;
%     h.Params.Phi_Winkel = h.ParamsToFit.Phi_Winkel;
%     h.Params.LatticeSpacingInterpol = h.ParamsToFit.LatticeSpacingInterpol;
%     h.Params.LatticeSpacing_DeltaInterpol = h.ParamsToFit.LatticeSpacing_DeltaInterpol;
elseif length(ia{1}) == 1   
    for k = 1:size(h.Params.LatticeSpacing,2)
            h.Params.LatticeSpacingInterpol{k} = h.Params.LatticeSpacing{k};
            h.Params.LatticeSpacing_DeltaInterpol{k} = h.Params.LatticeSpacing_Delta{k};
    end
end

% Find indices of phi angles.
h.idxphi0 = find(PhiWinkel{1}==0);
h.idxphi90 = find(PhiWinkel{1}==90);
h.idxphi180 = find(PhiWinkel{1}==180);
h.idxphi270 = find(PhiWinkel{1}==270);
% assignin('base','Params_mod',h.Params)
% Create vectors with dspacings according to the number of phi angles used
% in the measurement
if ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
    % sigma11 || sigma22
    h.sin2psi.dphi0 = h.Params.LatticeSpacingInterpol;
    h.sin2psi.dphi90 = h.Params.LatticeSpacingInterpol;
    h.sin2psi.dphi180 = h.Params.LatticeSpacingInterpol;
    h.sin2psi.dphi270 = h.Params.LatticeSpacingInterpol;
    h.sin2psi.dphi0delta = h.Params.LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi90delta = h.Params.LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi180delta = h.Params.LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi270delta = h.Params.LatticeSpacing_DeltaInterpol;
elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
    % sigma11 || sigma22
    h.sin2psi.dphi0 = h.Params.LatticeSpacingInterpol;
    h.sin2psi.dphi90 = h.Params.LatticeSpacingInterpol;
    h.sin2psi.dphi180 = h.Params.LatticeSpacingInterpol;
    h.sin2psi.dphi270 = h.Params.LatticeSpacingInterpol;
    h.sin2psi.dphi0delta = h.Params.LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi90delta = h.Params.LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi180delta = h.Params.LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi270delta = h.Params.LatticeSpacing_DeltaInterpol;
elseif isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
    % sigma11 || sigma22
    h.sin2psi.dphi0 = h.Params.LatticeSpacingInterpol;
    h.sin2psi.dphi90 = h.Params.LatticeSpacingInterpol;
    h.sin2psi.dphi180 = h.Params.LatticeSpacingInterpol;
    h.sin2psi.dphi270 = h.Params.LatticeSpacingInterpol;
    h.sin2psi.dphi0delta = h.Params.LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi90delta = h.Params.LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi180delta = h.Params.LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi270delta = h.Params.LatticeSpacing_DeltaInterpol;  
elseif isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
    % sigma11 || sigma22
    h.sin2psi.dphi0 = h.Params.LatticeSpacingInterpol;
    h.sin2psi.dphi90 = h.Params.LatticeSpacingInterpol;
    h.sin2psi.dphi180 = h.Params.LatticeSpacingInterpol;
    h.sin2psi.dphi270 = h.Params.LatticeSpacingInterpol;
    h.sin2psi.dphi0delta = h.Params.LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi90delta = h.Params.LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi180delta = h.Params.LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi270delta = h.Params.LatticeSpacing_DeltaInterpol;     
elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
    % sigma11 + sigma22
    h.sin2psi.dphi0 = h.ParamsToFit(h.idxphi0).LatticeSpacingInterpol;
    h.sin2psi.dphi90 = h.ParamsToFit(h.idxphi90).LatticeSpacingInterpol;
    h.sin2psi.dphi180 = h.ParamsToFit(h.idxphi0).LatticeSpacingInterpol;
    h.sin2psi.dphi270 = h.ParamsToFit(h.idxphi90).LatticeSpacingInterpol;
    h.sin2psi.dphi0delta = h.ParamsToFit(h.idxphi0).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi90delta = h.ParamsToFit(h.idxphi90).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi180delta = h.ParamsToFit(h.idxphi0).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi270delta = h.ParamsToFit(h.idxphi90).LatticeSpacing_DeltaInterpol;
elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
    % sigma11 + sigma22
    h.sin2psi.dphi0 = h.ParamsToFit(h.idxphi180).LatticeSpacingInterpol;
    h.sin2psi.dphi90 = h.ParamsToFit(h.idxphi90).LatticeSpacingInterpol;
    h.sin2psi.dphi180 = h.ParamsToFit(h.idxphi180).LatticeSpacingInterpol;
    h.sin2psi.dphi270 = h.ParamsToFit(h.idxphi90).LatticeSpacingInterpol;
    h.sin2psi.dphi0delta = h.ParamsToFit(h.idxphi180).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi90delta = h.ParamsToFit(h.idxphi90).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi180delta = h.ParamsToFit(h.idxphi180).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi270delta = h.ParamsToFit(h.idxphi90).LatticeSpacing_DeltaInterpol;
elseif isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
    % sigma11 + sigma22
    h.sin2psi.dphi0 = h.ParamsToFit(h.idxphi180).LatticeSpacingInterpol;
    h.sin2psi.dphi90 = h.ParamsToFit(h.idxphi270).LatticeSpacingInterpol;
    h.sin2psi.dphi180 = h.ParamsToFit(h.idxphi180).LatticeSpacingInterpol;
    h.sin2psi.dphi270 = h.ParamsToFit(h.idxphi270).LatticeSpacingInterpol;
    h.sin2psi.dphi0delta = h.ParamsToFit(h.idxphi180).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi90delta = h.ParamsToFit(h.idxphi270).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi180delta = h.ParamsToFit(h.idxphi180).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi270delta = h.ParamsToFit(h.idxphi270).LatticeSpacing_DeltaInterpol;
elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
    % sigma11 + sigma22
    h.sin2psi.dphi0 = h.ParamsToFit(h.idxphi0).LatticeSpacingInterpol;
    h.sin2psi.dphi90 = h.ParamsToFit(h.idxphi270).LatticeSpacingInterpol;
    h.sin2psi.dphi180 = h.ParamsToFit(h.idxphi0).LatticeSpacingInterpol;
    h.sin2psi.dphi270 = h.ParamsToFit(h.idxphi270).LatticeSpacingInterpol;
    h.sin2psi.dphi0delta = h.ParamsToFit(h.idxphi0).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi90delta = h.ParamsToFit(h.idxphi270).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi180delta = h.ParamsToFit(h.idxphi0).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi270delta = h.ParamsToFit(h.idxphi270).LatticeSpacing_DeltaInterpol;
elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
    % sigma11 + sigma13
    h.sin2psi.dphi0 = h.ParamsToFit(h.idxphi0).LatticeSpacingInterpol;
    h.sin2psi.dphi90 = h.ParamsToFit(h.idxphi0).LatticeSpacingInterpol;
    h.sin2psi.dphi180 = h.ParamsToFit(h.idxphi180).LatticeSpacingInterpol;
    h.sin2psi.dphi270 = h.ParamsToFit(h.idxphi180).LatticeSpacingInterpol;
    h.sin2psi.dphi0delta = h.ParamsToFit(h.idxphi0).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi90delta = h.ParamsToFit(h.idxphi0).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi180delta = h.ParamsToFit(h.idxphi180).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi270delta = h.ParamsToFit(h.idxphi180).LatticeSpacing_DeltaInterpol;
elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
    % sigma22 + sigma23
    h.sin2psi.dphi0 = h.ParamsToFit(h.idxphi90).LatticeSpacingInterpol;
    h.sin2psi.dphi90 = h.ParamsToFit(h.idxphi90).LatticeSpacingInterpol;
    h.sin2psi.dphi180 = h.ParamsToFit(h.idxphi270).LatticeSpacingInterpol;
    h.sin2psi.dphi270 = h.ParamsToFit(h.idxphi270).LatticeSpacingInterpol;
    h.sin2psi.dphi0delta = h.ParamsToFit(h.idxphi90).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi90delta = h.ParamsToFit(h.idxphi90).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi180delta = h.ParamsToFit(h.idxphi270).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi270delta = h.ParamsToFit(h.idxphi270).LatticeSpacing_DeltaInterpol;
elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
    % sigma11 + sigma13 + sigma22
    h.sin2psi.dphi0 = h.ParamsToFit(h.idxphi0).LatticeSpacingInterpol;
    h.sin2psi.dphi90 = h.ParamsToFit(h.idxphi270).LatticeSpacingInterpol;
    h.sin2psi.dphi180 = h.ParamsToFit(h.idxphi180).LatticeSpacingInterpol;
    h.sin2psi.dphi270 = h.ParamsToFit(h.idxphi270).LatticeSpacingInterpol;
    h.sin2psi.dphi0delta = h.ParamsToFit(h.idxphi0).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi90delta = h.ParamsToFit(h.idxphi270).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi180delta = h.ParamsToFit(h.idxphi180).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi270delta = h.ParamsToFit(h.idxphi270).LatticeSpacing_DeltaInterpol;
elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
    % sigma11 + sigma13 + sigma22
    h.sin2psi.dphi0 = h.ParamsToFit(h.idxphi0).LatticeSpacingInterpol;
    h.sin2psi.dphi90 = h.ParamsToFit(h.idxphi90).LatticeSpacingInterpol;
    h.sin2psi.dphi180 = h.ParamsToFit(h.idxphi180).LatticeSpacingInterpol;
    h.sin2psi.dphi270 = h.ParamsToFit(h.idxphi90).LatticeSpacingInterpol;
    h.sin2psi.dphi0delta = h.ParamsToFit(h.idxphi0).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi90delta = h.ParamsToFit(h.idxphi90).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi180delta = h.ParamsToFit(h.idxphi180).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi270delta = h.ParamsToFit(h.idxphi90).LatticeSpacing_DeltaInterpol;
elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
    % sigma11 + sigma22 + sigma23
    h.sin2psi.dphi0 = h.ParamsToFit(h.idxphi0).LatticeSpacingInterpol;
    h.sin2psi.dphi90 = h.ParamsToFit(h.idxphi90).LatticeSpacingInterpol;
    h.sin2psi.dphi180 = h.ParamsToFit(h.idxphi0).LatticeSpacingInterpol;
    h.sin2psi.dphi270 = h.ParamsToFit(h.idxphi270).LatticeSpacingInterpol;
    h.sin2psi.dphi0delta = h.ParamsToFit(h.idxphi0).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi90delta = h.ParamsToFit(h.idxphi90).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi180delta = h.ParamsToFit(h.idxphi0).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi270delta = h.ParamsToFit(h.idxphi270).LatticeSpacing_DeltaInterpol;
elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
    % sigma11 + sigma22 + sigma23
    h.sin2psi.dphi0 = h.ParamsToFit(h.idxphi180).LatticeSpacingInterpol;
    h.sin2psi.dphi90 = h.ParamsToFit(h.idxphi90).LatticeSpacingInterpol;
    h.sin2psi.dphi180 = h.ParamsToFit(h.idxphi180).LatticeSpacingInterpol;
    h.sin2psi.dphi270 = h.ParamsToFit(h.idxphi270).LatticeSpacingInterpol;
    h.sin2psi.dphi0delta = h.ParamsToFit(h.idxphi180).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi90delta = h.ParamsToFit(h.idxphi90).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi180delta = h.ParamsToFit(h.idxphi180).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi270delta = h.ParamsToFit(h.idxphi270).LatticeSpacing_DeltaInterpol;
elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
    % sigma11 + sigma13 + sigma22 + sigma23
    h.sin2psi.dphi0 = h.ParamsToFit(h.idxphi0).LatticeSpacingInterpol;
    h.sin2psi.dphi90 = h.ParamsToFit(h.idxphi90).LatticeSpacingInterpol;
    h.sin2psi.dphi180 = h.ParamsToFit(h.idxphi180).LatticeSpacingInterpol;
    h.sin2psi.dphi270 = h.ParamsToFit(h.idxphi270).LatticeSpacingInterpol;
    h.sin2psi.dphi0delta = h.ParamsToFit(h.idxphi0).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi90delta = h.ParamsToFit(h.idxphi90).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi180delta = h.ParamsToFit(h.idxphi180).LatticeSpacing_DeltaInterpol;
    h.sin2psi.dphi270delta = h.ParamsToFit(h.idxphi270).LatticeSpacing_DeltaInterpol; 
end

if length(ia{1}) == 1
    for k = 1:size(h.sin2psi.dphi0,2)
        h.sin2psi.dphi0p180{k} = (h.sin2psi.dphi0{k} + h.sin2psi.dphi180{k})./2;
        h.sin2psi.dphi0m180{k} = (h.sin2psi.dphi0{k} - h.sin2psi.dphi180{k})./2;
        h.sin2psi.dphi90p270{k} = (h.sin2psi.dphi90{k} + h.sin2psi.dphi270{k})./2;
        h.sin2psi.dphi90m270{k} = (h.sin2psi.dphi90{k} - h.sin2psi.dphi270{k})./2;
        h.sin2psi.dphi0p180p90p270{k} = (h.sin2psi.dphi0{k} + h.sin2psi.dphi180{k} + h.sin2psi.dphi90{k} + h.sin2psi.dphi270{k})./4;
        h.sin2psi.dphi0p180m90p270{k} = ((h.sin2psi.dphi0{k} + h.sin2psi.dphi180{k}) - (h.sin2psi.dphi90{k} + h.sin2psi.dphi270{k}))./4;
        h.sin2psi.dphi0p180delta{k} = sqrt(h.sin2psi.dphi0delta{k}.^2 + h.sin2psi.dphi180delta{k}.^2);
        h.sin2psi.dphi0m180delta{k} = sqrt(h.sin2psi.dphi0delta{k}.^2 + h.sin2psi.dphi180delta{k}.^2);
        h.sin2psi.dphi90p270delta{k} = sqrt(h.sin2psi.dphi90delta{k}.^2 + h.sin2psi.dphi270delta{k}.^2);
        h.sin2psi.dphi90m270delta{k} = sqrt(h.sin2psi.dphi90delta{k}.^2 + h.sin2psi.dphi270delta{k}.^2);
        h.sin2psi.dphi0p180p90p270delta{k} = sqrt(h.sin2psi.dphi0delta{k}.^2 + h.sin2psi.dphi180delta{k}.^2 + h.sin2psi.dphi90delta{k}.^2 + h.sin2psi.dphi270delta{k}.^2);
        h.sin2psi.dphi0p180m90p270delta{k} = sqrt(h.sin2psi.dphi0delta{k}.^2 + h.sin2psi.dphi180delta{k}.^2 + h.sin2psi.dphi90delta{k}.^2 + h.sin2psi.dphi270delta{k}.^2);
    end
elseif length(ia{1}) ~= 1
    for k = 1:size(h.sin2psi.dphi0,2)
        h.sin2psi.dphi0p180{k} = (h.sin2psi.dphi0{k} + h.sin2psi.dphi180{k})./2;
        h.sin2psi.dphi0m180{k} = (h.sin2psi.dphi0{k} - h.sin2psi.dphi180{k})./2;
        h.sin2psi.dphi90p270{k} = (h.sin2psi.dphi90{k} + h.sin2psi.dphi270{k})./2;
        h.sin2psi.dphi90m270{k} = (h.sin2psi.dphi90{k} - h.sin2psi.dphi270{k})./2;
        h.sin2psi.dphi0p180p90p270{k} = (h.sin2psi.dphi0{k} + h.sin2psi.dphi180{k} + h.sin2psi.dphi90{k} + h.sin2psi.dphi270{k})./4;
        h.sin2psi.dphi0p180m90p270{k} = ((h.sin2psi.dphi0{k} + h.sin2psi.dphi180{k}) - (h.sin2psi.dphi90{k} + h.sin2psi.dphi270{k}))./4;
        h.sin2psi.dphi0p180delta{k} = sqrt(h.sin2psi.dphi0delta{k}.^2 + h.sin2psi.dphi180delta{k}.^2);
        h.sin2psi.dphi0m180delta{k} = sqrt(h.sin2psi.dphi0delta{k}.^2 + h.sin2psi.dphi180delta{k}.^2);
        h.sin2psi.dphi90p270delta{k} = sqrt(h.sin2psi.dphi90delta{k}.^2 + h.sin2psi.dphi270delta{k}.^2);
        h.sin2psi.dphi90m270delta{k} = sqrt(h.sin2psi.dphi90delta{k}.^2 + h.sin2psi.dphi270delta{k}.^2);
        h.sin2psi.dphi0p180p90p270delta{k} = sqrt(h.sin2psi.dphi0delta{k}.^2 + h.sin2psi.dphi180delta{k}.^2 + h.sin2psi.dphi90delta{k}.^2 + h.sin2psi.dphi270delta{k}.^2);
        h.sin2psi.dphi0p180m90p270delta{k} = sqrt(h.sin2psi.dphi0delta{k}.^2 + h.sin2psi.dphi180delta{k}.^2 + h.sin2psi.dphi90delta{k}.^2 + h.sin2psi.dphi270delta{k}.^2);
    end
end

% Prepare sin2psi data for regression
if length(ia{1}) == 1
    for k = 1:size(h.sin2psi.dphi0,2)
        h.sin2psi.dphi0p180sinquadratpsi{k} = [sind(h.PsiforInterpol{k}).^2,h.sin2psi.dphi0p180{k},h.sin2psi.dphi0p180delta{k}];
        h.sin2psi.dphi0m180sinquadratpsi{k} = [sind(h.PsiforInterpol{k}).^2,h.sin2psi.dphi0m180{k},h.sin2psi.dphi0m180delta{k}];
        h.sin2psi.dphi0m180sin2psi{k} = [sind(2.*h.PsiforInterpol{k}),h.sin2psi.dphi0m180{k},h.sin2psi.dphi0m180delta{k}];
        h.sin2psi.dphi90p270sinquadratpsi{k} = [sind(h.PsiforInterpol{k}).^2,h.sin2psi.dphi90p270{k},h.sin2psi.dphi90p270delta{k}];
        h.sin2psi.dphi90m270sinquadratpsi{k} = [sind(h.PsiforInterpol{k}).^2,h.sin2psi.dphi90m270{k},h.sin2psi.dphi90m270delta{k}];
        h.sin2psi.dphi90m270sin2psi{k} = [sind(2.*h.PsiforInterpol{k}),h.sin2psi.dphi90m270{k},h.sin2psi.dphi90m270delta{k}];
    end
elseif length(ia{1}) ~= 1
    for k = 1:size(h.sin2psi.dphi0,2)
        h.sin2psi.dphi0p180sinquadratpsi{k} = [sind(h.PsiforInterpol{k}).^2,h.sin2psi.dphi0p180{k},h.sin2psi.dphi0p180delta{k}];
        h.sin2psi.dphi0m180sinquadratpsi{k} = [sind(h.PsiforInterpol{k}).^2,h.sin2psi.dphi0m180{k},h.sin2psi.dphi0m180delta{k}];
        h.sin2psi.dphi0m180sin2psi{k} = [sind(2.*h.PsiforInterpol{k}),h.sin2psi.dphi0m180{k},h.sin2psi.dphi0m180delta{k}];
        h.sin2psi.dphi90p270sinquadratpsi{k} = [sind(h.PsiforInterpol{k}).^2,h.sin2psi.dphi90p270{k},h.sin2psi.dphi90p270delta{k}];
        h.sin2psi.dphi90m270sinquadratpsi{k} = [sind(h.PsiforInterpol{k}).^2,h.sin2psi.dphi90m270{k},h.sin2psi.dphi90m270delta{k}];
        h.sin2psi.dphi90m270sin2psi{k} = [sind(2.*h.PsiforInterpol{k}),h.sin2psi.dphi90m270{k},h.sin2psi.dphi90m270delta{k}];
    end
end

% Perform linear regeression
for k = 1:size(h.sin2psi.dphi0,2)
    h.sin2psi.dphi0p180sinquadratpsiregress{k} = fitlm(h.sin2psi.dphi0p180sinquadratpsi{k}(:,1),h.sin2psi.dphi0p180sinquadratpsi{k}(:,2),'Weight',1./h.sin2psi.dphi0p180sinquadratpsi{k}(:,3));
    h.sin2psi.dphi90p270sinquadratpsiregress{k} = fitlm(h.sin2psi.dphi90p270sinquadratpsi{k}(:,1),h.sin2psi.dphi90p270sinquadratpsi{k}(:,2),'Weight',1./h.sin2psi.dphi90p270sinquadratpsi{k}(:,3));
    funsigmashear = @(m,x)(m.*x);
    h.sin2psi.dphi0m180sin2psiregress{k} = fitnlm(h.sin2psi.dphi0m180sin2psi{k}(:,1),h.sin2psi.dphi0m180sin2psi{k}(:,2),funsigmashear,0,'Weights',1./h.sin2psi.dphi0m180sin2psi{k}(:,3));
    h.sin2psi.dphi90m270sin2psiregress{k} = fitnlm(h.sin2psi.dphi90m270sin2psi{k}(:,1),h.sin2psi.dphi90m270sin2psi{k}(:,2),funsigmashear,0,'Weights',1./h.sin2psi.dphi90m270sin2psi{k}(:,3));
end

% Calculate tau
if length(ia{1}) == 1
    % Calculate absorbtion coefficient for Emax values
    h.StressesMW.absorbcoeff = cell(1);
    for k = 1:size(h.Params.Energy_Max,2)
        h.StressesMW.absorbcoeff{k} = h.Sample.Materials(1).LAC(h.Params.Energy_Max{k});
    end
    % Calculate tau for Emax values
    h.StressesMW.temptau = cell(1);
    for k = 1:size(h.Params.Energy_Max,2)
        h.StressesMW.temptau{k} = (sind(h.Measurement(1).twotheta./2).*cosd(h.Params.Psi_Winkel{k}))./(2.*h.StressesMW.absorbcoeff{k}./10000);
    end
    % Calculate average <tau>
    for ii = 1:size(h.Params.Energy_Max,2)
        h.StressesMW.tau(ii) = (h.StressesMW.temptau{ii}(1)+h.StressesMW.temptau{ii}(end))/2;
        h.StressesMW.taupsizero(ii) = h.StressesMW.temptau{ii}(1);
    end
elseif length(ia{1}) ~= 1
    % Calculate absorbtion coefficient for Emax values
    for j = 1:length(ia{1})
        h.StressesMW(j).absorbcoeff = cell(1);
        for k = 1:size(h.ParamsToFit(j).Energy_Max,2)
            h.StressesMW(j).absorbcoeff{k} = h.Sample.Materials(1).LAC(h.ParamsToFit(j).Energy_Max{k});
        end
    end

    for j = 1:length(ia{1})
        % Calculate tau for Emax values
        % Calculate average <tau>
        h.StressesMW(j).temptau = cell(1);
        for k = 1:size(h.ParamsToFit(j).Energy_Max,2)
            h.StressesMW(j).temptau{k} = (sind(h.Measurement(1).twotheta./2).*cosd(h.ParamsToFit(j).Psi_Winkel{k}))./(2.*h.StressesMW(j).absorbcoeff{k}./10000);
            h.StressesMW(j).tau(k) = (h.StressesMW(j).temptau{k}(1)+h.StressesMW(j).temptau{k}(end))/2;
%             h.StressesMW(j).taupsizero(k) = h.StressesMW(j).temptau{k}(1);
            h.StressesMW(j).taupsizero(k) = (sind(h.Measurement(1).twotheta./2).*cosd(0))./(2.*h.StressesMW(j).absorbcoeff{k}(1)./10000);
        end
    end
end

% Calculate aveerage tau from all measured azimuths
for j = 1:size(h.StressesMW,2)
    h.sin2psi.tautmp(:,j) = h.StressesMW(j).tau;
    h.sin2psi.taupsizero(:,j) = h.StressesMW(j).taupsizero;
end

for k = 1:size(h.sin2psi.tautmp,1)
    h.sin2psi.taumean(k) = mean(h.sin2psi.tautmp(k,:));
    h.sin2psi.taupsizeromean(k) = mean(h.sin2psi.taupsizero(k,:));
end

% Load DEK data previously entered by user
DEKdatatmp = get(h.loadDEKtable,'data');
% Convert hkl to vector
for k = 1:length(DEKdatatmp(:,1))
    hklDEKtmp(k) = DEKdatatmp(k,1)*100 + DEKdatatmp(k,2)*10 + DEKdatatmp(k,3);
end

hklDEKtmp = hklDEKtmp';
% Set DEK values to Params structure
h.Params.DEK = [hklDEKtmp DEKdatatmp(:,4:5)];

% Calculate dzero
if length(ia{1}) == 1
    for k = 1:size(h.Params.LatticeSpacing,2)
        % Calculate dzero
        h.sin2psi.dzero(k) = interp1(h.PsiforInterpol{k},h.sin2psi.dphi0p180p90p270{k},asind(sqrt(-2.*h.Params.DEK(k,2)./h.Params.DEK(k,3))),'linear','extrap');
    end
elseif length(ia{1}) ~= 1    
    for k = 1:size(h.ParamsToFit(1).LatticeSpacingInterpol,2)
        % Calculate dzero
        h.sin2psi.dzero(k) = interp1(h.PsiforInterpol{k},h.sin2psi.dphi0p180p90p270{k},asind(sqrt(-2.*h.Params.DEK(k,2)./h.Params.DEK(k,3))),'linear','extrap');
    end
end

% Calculate sigma11 and sigma22
for k = 1:size(h.sin2psi.dphi0p180sinquadratpsi,2)
    h.sin2psi.dphi0p180sinquadratpsiregress{k} = fitlm(h.sin2psi.dphi0p180sinquadratpsi{k}(:,1),h.sin2psi.dphi0p180sinquadratpsi{k}(:,2),'Weight',1./h.sin2psi.dphi0p180sinquadratpsi{k}(:,3));
    h.sin2psi.dphi90p270sinquadratpsiregress{k} = fitlm(h.sin2psi.dphi90p270sinquadratpsi{k}(:,1),h.sin2psi.dphi90p270sinquadratpsi{k}(:,2),'Weight',1./h.sin2psi.dphi90p270sinquadratpsi{k}(:,3));
end

% Calculate sigma13 and sigma23
for k = 1:size(h.sin2psi.dphi0m180sin2psi,2)
	h.sin2psi.dphi0m180sin2psiregress{k} = fitnlm(h.sin2psi.dphi0m180sin2psi{k}(:,1),h.sin2psi.dphi0m180sin2psi{k}(:,2),funsigmashear,0,'Weights',1./h.sin2psi.dphi0m180sin2psi{k}(:,3));
	h.sin2psi.dphi90m270sin2psiregress{k} = fitnlm(h.sin2psi.dphi90m270sin2psi{k}(:,1),h.sin2psi.dphi90m270sin2psi{k}(:,2),funsigmashear,0,'Weights',1./h.sin2psi.dphi90m270sin2psi{k}(:,3));
end
% assignin('base','sin2psiMod',h.sin2psi)
% assignin('base','ParamsToFit',h.ParamsToFit)

% Create sigmatau list
for k = 1:size(h.sin2psi.dphi0p180sinquadratpsiregress,2)
    if ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
        % sigma11
        h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taupsizero(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taumean(k)];
    elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
        % sigma22
        h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taupsizero(k),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taumean(k)];
    elseif isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
        % sigma11
        h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taupsizero(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taumean(k)];
    elseif isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
        % sigma22
        h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taupsizero(k),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taumean(k)];      
    elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
        % sigma11, sigma22
        h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taupsizero(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taumean(k)];
    elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
        % sigma11, sigma22
        h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taupsizero(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taumean(k)];
    elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
        % sigma11, sigma22
        h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taupsizero(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taumean(k)];
    elseif isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
        % sigma11, sigma22
        h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taupsizero(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taumean(k)];                
    elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
        % sigma11, sigma13
        h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taupsizero(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi0m180sin2psiregress{k}.Coefficients.Estimate(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0m180sin2psiregress{k}.Coefficients.SE(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taumean(k)];
    elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
        % sigma22, sigma23
        h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taupsizero(k),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi90m270sin2psiregress{k}.Coefficients.Estimate(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90m270sin2psiregress{k}.Coefficients.SE(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taumean(k)]; 
    elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)	
        % sigma11, sigma22, sigma13
        h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taupsizero(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi0m180sin2psiregress{k}.Coefficients.Estimate(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0m180sin2psiregress{k}.Coefficients.SE(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taumean(k)];   
    elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)	
        % sigma11, sigma22, sigma13
        h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taupsizero(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi0m180sin2psiregress{k}.Coefficients.Estimate(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0m180sin2psiregress{k}.Coefficients.SE(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taumean(k)]; 
    elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
        % sigma11, sigma22, sigma23
        h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taupsizero(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi90m270sin2psiregress{k}.Coefficients.Estimate(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90m270sin2psiregress{k}.Coefficients.SE(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taumean(k)];
    elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)	
        % sigma11, sigma22, sigma23
        h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taupsizero(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi90m270sin2psiregress{k}.Coefficients.Estimate(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90m270sin2psiregress{k}.Coefficients.SE(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taumean(k)];  
    elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
        % sigma11, sigma22, sigma13, sigma23	
        h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taupsizero(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi0m180sin2psiregress{k}.Coefficients.Estimate(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0m180sin2psiregress{k}.Coefficients.SE(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
                        h.sin2psi.dphi90m270sin2psiregress{k}.Coefficients.Estimate(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90m270sin2psiregress{k}.Coefficients.SE(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taumean(k)];
    end
%     if ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
%         % sigma11
%         h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taumean(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taupsizero(k)];
%     elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
%         % sigma22
%         h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taumean(k),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taupsizero(k)];
%     elseif isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
%         % sigma11
%         h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taumean(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taupsizero(k)];
%     elseif isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
%         % sigma22
%         h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taumean(k),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taupsizero(k)];      
%     elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
%         % sigma11, sigma22
%         h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taumean(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taupsizero(k)];
%     elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
%         % sigma11, sigma22
%         h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taumean(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taupsizero(k)];
%     elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
%         % sigma11, sigma22
%         h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taumean(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taupsizero(k)];
%     elseif isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
%         % sigma11, sigma22
%         h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taumean(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taupsizero(k)];                
%     elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
%         % sigma11, sigma13
%         h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taumean(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi0m180sin2psiregress{k}.Coefficients.Estimate(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0m180sin2psiregress{k}.Coefficients.SE(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taupsizero(k)];
%     elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
%         % sigma22, sigma23
%         h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taumean(k),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi90m270sin2psiregress{k}.Coefficients.Estimate(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90m270sin2psiregress{k}.Coefficients.SE(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taupsizero(k)]; 
%     elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)	
%         % sigma11, sigma22, sigma13
%         h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taumean(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi0m180sin2psiregress{k}.Coefficients.Estimate(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0m180sin2psiregress{k}.Coefficients.SE(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taupsizero(k)];   
%     elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)	
%         % sigma11, sigma22, sigma13
%         h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taumean(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi0m180sin2psiregress{k}.Coefficients.Estimate(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0m180sin2psiregress{k}.Coefficients.SE(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taupsizero(k)]; 
%     elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
%         % sigma11, sigma22, sigma23
%         h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taumean(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi90m270sin2psiregress{k}.Coefficients.Estimate(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90m270sin2psiregress{k}.Coefficients.SE(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taupsizero(k)];
%     elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)	
%         % sigma11, sigma22, sigma23
%         h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taumean(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi90m270sin2psiregress{k}.Coefficients.Estimate(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90m270sin2psiregress{k}.Coefficients.SE(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taupsizero(k)];  
%     elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
%         % sigma11, sigma22, sigma13, sigma23	
%         h.sin2psi.sigmataulist(k,:) = [h.sin2psi.taumean(k),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.SE(2)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi0m180sin2psiregress{k}.Coefficients.Estimate(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi0m180sin2psiregress{k}.Coefficients.SE(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3), ...
%                         h.sin2psi.dphi90m270sin2psiregress{k}.Coefficients.Estimate(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.dphi90m270sin2psiregress{k}.Coefficients.SE(1)./h.sin2psi.dzero(k)./h.Params.DEK(k,3),h.sin2psi.taupsizero(k)];
%     end
end

% Calculate regression lines
sinpsisquare = linspace(0,1,51);
h.sinpsisquare = sinpsisquare;

for k = 1:size(h.sin2psi.dphi0p180sinquadratpsiregress,2)
    if ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
        % sigma11
        h.sin2psi.reglinephi0(:,k) = h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(1) + h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2).*sinpsisquare;
    elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
        % sigma22
        h.sin2psi.reglinephi90(:,k) = h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(1) + h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2).*sinpsisquare;
    elseif isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
        % sigma11
        h.sin2psi.reglinephi180(:,k) = h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(1) + h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2).*sinpsisquare;
    elseif isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
        % sigma22
        h.sin2psi.reglinephi270(:,k) = h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(1) + h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2).*sinpsisquare;    
    elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
        % sigma11, sigma22
        h.sin2psi.reglinephi0(:,k) = h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(1) + h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2).*sinpsisquare;
        h.sin2psi.reglinephi90(:,k) = h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(1) + h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2).*sinpsisquare;
    elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
        % sigma11, sigma22
        h.sin2psi.reglinephi0(:,k) = h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(1) + h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2).*sinpsisquare;
        h.sin2psi.reglinephi270(:,k) = h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(1) + h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2).*sinpsisquare;
    elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
        % sigma11, sigma22
        h.sin2psi.reglinephi180(:,k) = h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(1) + h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2).*sinpsisquare;
        h.sin2psi.reglinephi90(:,k) = h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(1) + h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2).*sinpsisquare;
    elseif isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
        % sigma11, sigma22
        h.sin2psi.reglinephi180(:,k) = h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(1) + h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2).*sinpsisquare;
        h.sin2psi.reglinephi270(:,k) = h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(1) + h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2).*sinpsisquare;     
    elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
        % sigma11, sigma13
        h.sin2psi.reglinephi0(:,k) = (h.Params.DEK(k,3).*(h.sin2psi.sigmataulist(k,2).*sinpsisquare + ...
                           h.sin2psi.sigmataulist(k,4).*2.*sqrt(sinpsisquare.*(1-sinpsisquare))) + ...
                           h.Params.DEK(k,2).*2.*(h.sin2psi.sigmataulist(k,2))).*h.sin2psi.dzero(k) + h.sin2psi.dzero(k);
        h.sin2psi.reglinephi180(:,k) = (h.Params.DEK(k,3).*(h.sin2psi.sigmataulist(k,2).*sinpsisquare - ...
                           h.sin2psi.sigmataulist(k,4).*2.*sqrt(sinpsisquare.*(1-sinpsisquare))) + ...
                           h.Params.DEK(k,2).*2.*(h.sin2psi.sigmataulist(k,2))).*h.sin2psi.dzero(k) + h.sin2psi.dzero(k);				   
    elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
        % sigma11, sigma22, sigma13
        h.sin2psi.reglinephi0(:,k) = (h.Params.DEK(k,3).*(h.sin2psi.sigmataulist(k,2).*sinpsisquare + ...
                           h.sin2psi.sigmataulist(k,6).*2.*sqrt(sinpsisquare.*(1-sinpsisquare))) + ...
                           h.Params.DEK(k,2).*(h.sin2psi.sigmataulist(k,2) + h.sin2psi.sigmataulist(k,4))).*h.sin2psi.dzero(k) + h.sin2psi.dzero(k);
        h.sin2psi.reglinephi90(:,k) = h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(1) + h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2).*sinpsisquare;				   
        h.sin2psi.reglinephi180(:,k) = (h.Params.DEK(k,3).*(h.sin2psi.sigmataulist(k,2).*sinpsisquare - ...
                           h.sin2psi.sigmataulist(k,6).*2.*sqrt(sinpsisquare.*(1-sinpsisquare))) + ...
                           h.Params.DEK(k,2).*(h.sin2psi.sigmataulist(k,2) + h.sin2psi.sigmataulist(k,4))).*h.sin2psi.dzero(k) + h.sin2psi.dzero(k);
    elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)	
        % sigma11, sigma22, sigma13
        h.sin2psi.reglinephi0(:,k) = (h.Params.DEK(k,3).*(h.sin2psi.sigmataulist(k,2).*sinpsisquare + ...
                           h.sin2psi.sigmataulist(k,6).*2.*sqrt(sinpsisquare.*(1-sinpsisquare))) + ...
                           h.Params.DEK(k,2).*(h.sin2psi.sigmataulist(k,2) + h.sin2psi.sigmataulist(k,4))).*h.sin2psi.dzero(k) + h.sin2psi.dzero(k);
        h.sin2psi.reglinephi180(:,k) = (h.Params.DEK(k,3).*(h.sin2psi.sigmataulist(k,2).*sinpsisquare - ...
                           h.sin2psi.sigmataulist(k,6).*2.*sqrt(sinpsisquare.*(1-sinpsisquare))) + ...
                           h.Params.DEK(k,2).*(h.sin2psi.sigmataulist(k,2) + h.sin2psi.sigmataulist(k,4))).*h.sin2psi.dzero(k) + h.sin2psi.dzero(k);
        h.sin2psi.reglinephi270(:,k) = h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(1) + h.sin2psi.dphi90p270sinquadratpsiregress{k}.Coefficients.Estimate(2).*sinpsisquare;
    elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
        % sigma22, sigma23
        h.sin2psi.reglinephi90(:,k) = (h.Params.DEK(k,3).*(h.sin2psi.sigmataulist(k,2).*sinpsisquare + ...
                           h.sin2psi.sigmataulist(k,4).*2.*sqrt(sinpsisquare.*(1-sinpsisquare))) + ...
                           h.Params.DEK(k,2).*2.*(h.sin2psi.sigmataulist(k,2))).*h.sin2psi.dzero(k) + h.sin2psi.dzero(k);
        h.sin2psi.reglinephi270(:,k) = (h.Params.DEK(k,3).*(h.sin2psi.sigmataulist(k,2).*sinpsisquare - ...
                           h.sin2psi.sigmataulist(k,4).*2.*sqrt(sinpsisquare.*(1-sinpsisquare))) + ...
                           h.Params.DEK(k,2).*2.*(h.sin2psi.sigmataulist(k,2))).*h.sin2psi.dzero(k) + h.sin2psi.dzero(k);
    elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
        % sigma11, sigma22, sigma23
        h.sin2psi.reglinephi0(:,k) = h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(1) + h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2).*sinpsisquare;
        h.sin2psi.reglinephi90(:,k) = (h.Params.DEK(k,3).*(h.sin2psi.sigmataulist(k,4).*sinpsisquare + ...
                           h.sin2psi.sigmataulist(k,6).*2.*sqrt(sinpsisquare.*(1-sinpsisquare))) + ...
                           h.Params.DEK(k,2).*(h.sin2psi.sigmataulist(k,2) + h.sin2psi.sigmataulist(k,4))).*h.sin2psi.dzero(k) + h.sin2psi.dzero(k);			   
        h.sin2psi.reglinephi270(:,k) = (h.Params.DEK(k,3).*(h.sin2psi.sigmataulist(k,4).*sinpsisquare - ...
                           h.sin2psi.sigmataulist(k,6).*2.*sqrt(sinpsisquare.*(1-sinpsisquare))) + ...
                           h.Params.DEK(k,2).*(h.sin2psi.sigmataulist(k,2) + h.sin2psi.sigmataulist(k,4))).*h.sin2psi.dzero(k) + h.sin2psi.dzero(k);
    elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)	
        % sigma11, sigma22, sigma23
        h.sin2psi.reglinephi90(:,k) = (h.Params.DEK(k,3).*(h.sin2psi.sigmataulist(k,4).*sinpsisquare - ...
                           h.sin2psi.sigmataulist(k,6).*2.*sqrt(sinpsisquare.*(1-sinpsisquare))) + ...
                           h.Params.DEK(k,2).*(h.sin2psi.sigmataulist(k,2) + h.sin2psi.sigmataulist(k,4))).*h.sin2psi.dzero(k) + h.sin2psi.dzero(k);
        h.sin2psi.reglinephi180(:,k) = h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(1) + h.sin2psi.dphi0p180sinquadratpsiregress{k}.Coefficients.Estimate(2).*sinpsisquare;
        h.sin2psi.reglinephi270(:,k) = (h.Params.DEK(k,3).*(h.sin2psi.sigmataulist(k,4).*sinpsisquare - ...
                           h.sin2psi.sigmataulist(k,6).*2.*sqrt(sinpsisquare.*(1-sinpsisquare))) + ...
                           h.Params.DEK(k,2).*(h.sin2psi.sigmataulist(k,2) + h.sin2psi.sigmataulist(k,4))).*h.sin2psi.dzero(k) + h.sin2psi.dzero(k);                   
    elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
        % sigma11, sigma22, sigma13, sigma23
        h.sin2psi.reglinephi0(:,k) = (h.Params.DEK(k,3).*(h.sin2psi.sigmataulist(k,2).*sinpsisquare + ...
                           h.sin2psi.sigmataulist(k,6).*2.*sqrt(sinpsisquare.*(1-sinpsisquare))) + ...
                           h.Params.DEK(k,2).*(h.sin2psi.sigmataulist(k,2) + h.sin2psi.sigmataulist(k,4))).*h.sin2psi.dzero(k) + h.sin2psi.dzero(k);
        h.sin2psi.reglinephi90(:,k) = (h.Params.DEK(k,3).*(h.sin2psi.sigmataulist(k,4).*sinpsisquare + ...
                           h.sin2psi.sigmataulist(k,8).*2.*sqrt(sinpsisquare.*(1-sinpsisquare))) + ...
                           h.Params.DEK(k,2).*(h.sin2psi.sigmataulist(k,2) + h.sin2psi.sigmataulist(k,4))).*h.sin2psi.dzero(k) + h.sin2psi.dzero(k);
        h.sin2psi.reglinephi180(:,k) = (h.Params.DEK(k,3).*(h.sin2psi.sigmataulist(k,2).*sinpsisquare - ...
                           h.sin2psi.sigmataulist(k,6).*2.*sqrt(sinpsisquare.*(1-sinpsisquare))) + ...
                           h.Params.DEK(k,2).*(h.sin2psi.sigmataulist(k,2) + h.sin2psi.sigmataulist(k,4))).*h.sin2psi.dzero(k) + h.sin2psi.dzero(k);
        h.sin2psi.reglinephi270(:,k) = (h.Params.DEK(k,3).*(h.sin2psi.sigmataulist(k,4).*sinpsisquare - ...
                           h.sin2psi.sigmataulist(k,8).*2.*sqrt(sinpsisquare.*(1-sinpsisquare))) + ...
                           h.Params.DEK(k,2).*(h.sin2psi.sigmataulist(k,2) + h.sin2psi.sigmataulist(k,4))).*h.sin2psi.dzero(k) + h.sin2psi.dzero(k);
    end
end


% Get peak hkl and sort acording to tau value of peak
if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    % Check whether peaks where deselected by the user  
    if isfield(h, 'idxkeepPeaks')
        idx = find(h.FitPeaksLogical(:,1) == 1);
        if length(idx) == length(h.idxkeepPeaks)
            FitPeaks = h.FitPeaksLogical(:,1);
        else
            % Load fit data from fit results table
            FitDatatmp = get(h.tablefitresults,'data');
            % Load energy positions
            EnergyPos = str2double(FitDatatmp(:,3));
            EPosToKeep = EnergyPos(h.idxkeepPeaks);
            EPosKeepCell = mat2cell(EPosToKeep,size(EPosToKeep,1),1);
            EPosKeepCell{1} = EPosKeepCell{1}';
            PeakstmpLogical = h.TPeaks.T.Peaks(:,5) > h.P.EnergyRange(1) & h.TPeaks.T.Peaks(:,5) < h.P.EnergyRange(2);
            EPosTheo = h.TPeaks.T.Peaks(PeakstmpLogical,5);
            [CompareFitPeaksLogical,~,~,~] = ComparePeaks(EPosKeepCell,EPosTheo);
            FitPeaks = CompareFitPeaksLogical;
            h.FitPeaksLogicalUser = CompareFitPeaksLogical;
        end
    else
        FitPeaks = h.FitPeaksLogical(:,1);
    end
    
    
%     idxkeep = getappdata(0,'idxkeepPeaks');   
%     if isempty(idxkeep)
%         FitPeaks = h.FitPeaksLogical(:,1);
% %         assignin('base','FitPeaks',FitPeaks)
%     else
%         idx = find(h.FitPeaksLogical(:,1) == 1);
%         if length(idx) == length(idxkeep)
%             FitPeaks = h.FitPeaksLogical(:,1);
%         else
%             % Load fit data from fit results table
%             FitDatatmp = get(h.tablefitresults,'data');
% %             assignin('base','FitDatatmp',FitDatatmp)
%             % Load energy positions
%             EnergyPos = str2double(FitDatatmp(:,3));
% %             assignin('base','EnergyPos',EnergyPos)
%             EPosToKeep = EnergyPos(idxkeep);
% %             assignin('base','EPosToKeep',EPosToKeep)
%             EPosKeepCell = mat2cell(EPosToKeep,size(EPosToKeep,1),1);
%             EPosKeepCell{1} = EPosKeepCell{1}';
% %             assignin('base','TPeaks',h.TPeaks.T.Peaks)
%             PeakstmpLogical = h.TPeaks.T.Peaks(:,5) > h.P.EnergyRange(1) & h.TPeaks.T.Peaks(:,5) < h.P.EnergyRange(2);
% %             assignin('base','PeakstmpLogical',PeakstmpLogical)
%             EPosTheo = h.TPeaks.T.Peaks(PeakstmpLogical,5);
% %             EPosTheo = h.TPeaks.T.Peaks(1:length(h.FitPeaksLogical),5);
% %             assignin('base','EPosTheo',EPosTheo)
%             
%             [CompareFitPeaksLogical,~,~,~] = ComparePeaks(EPosKeepCell,EPosTheo);
% %             assignin('base','CompareFitPeaksLogical',CompareFitPeaksLogical)
%             FitPeaks = CompareFitPeaksLogical;
%             h.FitPeaksLogicalUser = CompareFitPeaksLogical;
%         end
%     end
    
    if size(FitPeaks,1) == 1
        Peakstmp = h.TPeaks.T.Peaks;
        PeakstmpLogical = Peakstmp(:,5) > h.P.EnergyRange(1) & Peakstmp(:,5) < h.P.EnergyRange(2);
        h.PeaksforLabel = h.TPeaks.T.Peaks(PeakstmpLogical(:,1),1:5);
    else
        PeakstmpLogical = h.TPeaks.T.Peaks(:,5) > h.P.EnergyRange(1) & h.TPeaks.T.Peaks(:,5) < h.P.EnergyRange(2);
        PeaksforLabeltmp = h.TPeaks.T.Peaks(PeakstmpLogical(:,1),1:5);
        h.PeaksforLabel = PeaksforLabeltmp(FitPeaks(:,1),1:5);
    end
elseif strcmp(h.Diffsel,'LEDDI')
    if strcmp(h.Detsel,'Detector 1')
        % Check whether peaks where deselected by the user
        if isfield(h, 'idxkeepPeaks')
            idx = find(h.FitPeaksLogicalDet1(:,1) == 1);
            if length(idx) == length(h.idxkeepPeaks)
                FitPeaks = h.FitPeaksLogicalDet1(:,1);
            else
                % Load fit data from fit results table
                FitDatatmp = get(h.tablefitresults,'data');
                % Load energy positions
                EnergyPos = str2double(FitDatatmp(:,3));
                EPosToKeep = EnergyPos(h.idxkeepPeaks);
                EPosKeepCell = mat2cell(EPosToKeep,size(EPosToKeep,1),1);
                EPosKeepCell{1} = EPosKeepCell{1}';
                PeakstmpLogical = h.TPeaksDet1.T.Peaks(:,5) > h.P.EnergyRangeDet1(1) & h.TPeaksDet1.T.Peaks(:,5) < h.P.EnergyRangeDet1(2);
                EPosTheo = h.TPeaksDet1.T.Peaks(PeakstmpLogical,5);
                [CompareFitPeaksLogical,~,~,~] = ComparePeaks(EPosKeepCell,EPosTheo);
                FitPeaks = CompareFitPeaksLogical;
                h.FitPeaksLogicalDet1User = CompareFitPeaksLogical;
            end
        else
            FitPeaks = h.FitPeaksLogicalDet1(:,1);
        end
        
%         idxkeep = getappdata(0,'idxkeepPeaks');
%         
%         if isempty(idxkeep)
%             FitPeaks = h.FitPeaksLogicalDet1(:,1);
%         else
%             idx = find(h.FitPeaksLogicalDet1(:,1) == 1);
%             if length(idx) == length(idxkeep)
%                 FitPeaks = h.FitPeaksLogicalDet1(:,1);
%             else
%                 % Load fit data from fit results table
%                 FitDatatmp = get(h.tablefitresults,'data');
%                 % Load energy positions
%                 EnergyPos = str2double(FitDatatmp(:,3));
%                 EPosToKeep = EnergyPos(idxkeep);
%                 EPosKeepCell = mat2cell(EPosToKeep,size(EPosToKeep,1),1);
%                 EPosKeepCell{1} = EPosKeepCell{1}';
%                 PeakstmpLogical = h.TPeaksDet1.T.Peaks(:,5) > h.P.EnergyRangeDet1(1) & h.TPeaksDet1.T.Peaks(:,5) < h.P.EnergyRangeDet1(2);
%                 EPosTheo = h.TPeaksDet1.T.Peaks(PeakstmpLogical,5);
% %                 EPosTheo = h.TPeaks.T.Peaks(1:length(h.FitPeaksLogicalDet1),5);
% 
%                 [CompareFitPeaksLogical,~,~,~] = ComparePeaks(EPosKeepCell,EPosTheo);
%                 FitPeaks = CompareFitPeaksLogical;
%                 h.FitPeaksLogicalDet1User = CompareFitPeaksLogical;
%             end
%         end
        
        if size(FitPeaks,1) == 1
            Peakstmp = h.TPeaksDet1.T.Peaks;
            PeakstmpLogical = Peakstmp(:,5) > h.P.EnergyRangeDet1(1) & Peakstmp(:,5) < h.P.EnergyRangeDet1(2);
            h.PeaksforLabel = h.TPeaksDet1.T.Peaks(PeakstmpLogical(:,1),1:5);
        else
            PeakstmpLogical = h.TPeaksDet1.T.Peaks(:,5) > h.P.EnergyRangeDet1(1) & h.TPeaksDet1.T.Peaks(:,5) < h.P.EnergyRangeDet1(2);
            PeaksforLabeltmp = h.TPeaksDet1.T.Peaks(PeakstmpLogical(:,1),1:5);
            h.PeaksforLabel = PeaksforLabeltmp(FitPeaks(:,1),1:5);
        end
                
    elseif strcmp(h.Detsel,'Detector 2')
        % Check whether peaks where deselected by the user
        if isfield(h, 'idxkeepPeaks')
            idx = find(h.FitPeaksLogicalDet2(:,1) == 1);
            if length(idx) == length(h.idxkeepPeaks)
                FitPeaks = h.FitPeaksLogicalDet2(:,1);
            else
                % Load fit data from fit results table
                FitDatatmp = get(h.tablefitresults,'data');
                % Load energy positions
                EnergyPos = str2double(FitDatatmp(:,3));
                EPosToKeep = EnergyPos(h.idxkeepPeaks);
                EPosKeepCell = mat2cell(EPosToKeep,size(EPosToKeep,1),1);
                EPosKeepCell{1} = EPosKeepCell{1}';
                PeakstmpLogical = h.TPeaksDet2.T.Peaks(:,5) > h.P.EnergyRangeDet2(1) & h.TPeaksDet2.T.Peaks(:,5) < h.P.EnergyRangeDet2(2);
                EPosTheo = h.TPeaksDet2.T.Peaks(PeakstmpLogical,5);
                [CompareFitPeaksLogical,~,~,~] = ComparePeaks(EPosKeepCell,EPosTheo);
                FitPeaks = CompareFitPeaksLogical;
                h.FitPeaksLogicalDet2User = CompareFitPeaksLogical;
            end
        else
            FitPeaks = h.FitPeaksLogicalDet2(:,1);
        end
        
%         idxkeep = getappdata(0,'idxkeepPeaks');
%         
%         if isempty(idxkeep)
%             FitPeaks = h.FitPeaksLogicalDet2(:,1);
%         else
%             idx = find(h.FitPeaksLogicalDet2(:,1) == 1);
%             if length(idx) == length(idxkeep)
%                 FitPeaks = h.FitPeaksLogicalDet2(:,1);
%             else
%                 % Load fit data from fit results table
%                 FitDatatmp = get(h.tablefitresults,'data');
%                 % Load energy positions
%                 EnergyPos = str2double(FitDatatmp(:,3));
%                 EPosToKeep = EnergyPos(idxkeep);
%                 EPosKeepCell = mat2cell(EPosToKeep,size(EPosToKeep,1),1);
%                 EPosKeepCell{1} = EPosKeepCell{1}';
%                 PeakstmpLogical = h.TPeaksDet2.T.Peaks(:,5) > h.P.EnergyRangeDet2(1) & h.TPeaksDet2.T.Peaks(:,5) < h.P.EnergyRangeDet2(2);
%                 EPosTheo = h.TPeaksDet2.T.Peaks(PeakstmpLogical,5);
% %                 EPosTheo = h.TPeaks.T.Peaks(1:length(h.FitPeaksLogicalDet2),5);
% 
%                 [CompareFitPeaksLogical,~,~,~] = ComparePeaks(EPosKeepCell,EPosTheo);
%                 FitPeaks = CompareFitPeaksLogical;
%                 h.FitPeaksLogicalDet2User = CompareFitPeaksLogical;
%             end
%         end
        
        if size(FitPeaks,1) == 1
            Peakstmp = h.TPeaksDet2.T.Peaks;
            PeakstmpLogical = Peakstmp(:,5) > h.P.EnergyRangeDet2(1) & Peakstmp(:,5) < h.P.EnergyRangeDet2(2);
            h.PeaksforLabel = h.TPeaksDet2.T.Peaks(PeakstmpLogical(:,1),1:5);
        else
            PeakstmpLogical = h.TPeaksDet2.T.Peaks(:,5) > h.P.EnergyRangeDet2(1) & h.TPeaksDet2.T.Peaks(:,5) < h.P.EnergyRangeDet2(2);
            PeaksforLabeltmp = h.TPeaksDet2.T.Peaks(PeakstmpLogical(:,1),1:5);
            h.PeaksforLabel = PeaksforLabeltmp(FitPeaks(:,1),1:5);
        end

    end
end
% assignin('base','PeaksforLabel1',h.PeaksforLabel)
% Sort Colors according to energy positions of peaks
% Delete field if already present, in case of reloading stress data with
% different number of peaks
if isfield(h, 'ColorsUsed')
    h = rmfield(h,'ColorsUsed');
end
if isfield(h, 'ColorsUsedtmp')
    h = rmfield(h,'ColorsUsedtmp');
end
for k = 1:size(h.Params.LatticeSpacing,2)
    h.ColorsUsed{k} = h.Colors{k};
end
% Convert to integers
for k = 1:size(h.Params.LatticeSpacing,2)
    h.ColorsUsedtmp(k,:) = h.ColorsUsed{1,k}(:);
end

% Create array with tau, sigma, label and color data
StressPlotDatatmp = [h.sin2psi.sigmataulist h.PeaksforLabel h.ColorsUsedtmp];

% Sort array according to tau values
h.sin2psi.StressPlotDatatmpsorted = sortrows(StressPlotDatatmp, 1);
% Update hkl label order
h.PeaksforLabel = h.sin2psi.StressPlotDatatmpsorted(:,(size(h.sin2psi.sigmataulist,2)+1:size(h.sin2psi.sigmataulist,2)+4));
% Update color order if deleting data point caused a considerable shift of
% tau
h.ColorsUsedSorted = h.sin2psi.StressPlotDatatmpsorted(:,(size(h.sin2psi.sigmataulist,2)+6:size(h.sin2psi.sigmataulist,2)+8));
% Convert back to cell array
h.ColorsUsedSorted = num2cell(h.ColorsUsedSorted,2);
% Create hkl label for plot of d-spacings (sorted according to d-value)
Peaks = h.PeaksforLabel;
% Read hkl values from array
for ii = 1:size(Peaks,1)
	hkllabeltmp(ii,:) = mat2str(Peaks(ii,(1:3)));
end
% Remove '[' and ']' from character array
for ii = 1:size(hkllabeltmp,1)
    hkllabeltmp1(ii,:) = regexprep(hkllabeltmp(ii,:),'[','');
end

for ii = 1:size(hkllabeltmp,1)
    hkllabeltmp2(ii,:) = regexprep(hkllabeltmp1(ii,:),']','');
end
% Final output with hkl values
hkllabel = hkllabeltmp2;

h.hkllabel = cell(size(ia{1}));
h.hkllabel{valueSliderStress} = hkllabel;

% Set data for plot of d-spacings, regression line, IB and Intensity
if ~isempty(h.idxphi0)
    set(h.plotdatadspacingphi0,'xdata',sind(h.ParamsToFit(h.idxphi0).Psi_Winkel{valueSlider}).^2)
    set(h.plotdatadspacingphi0,'ydata',h.ParamsToFit(h.idxphi0).LatticeSpacing{valueSlider})
    set(h.plotdatadspacingphi0,'YNegativeDelta',h.ParamsToFit(h.idxphi0).LatticeSpacing_Delta{valueSlider})
    set(h.plotdatadspacingphi0,'YPositiveDelta',h.ParamsToFit(h.idxphi0).LatticeSpacing_Delta{valueSlider})
    set(h.plotreglinedspacingphi0,'xdata',h.sinpsisquare)
    set(h.plotreglinedspacingphi0,'ydata',h.sin2psi.reglinephi0(:,valueSlider))
    set(h.plotdataIBphi0,'xdata',sind(h.ParamsToFit(h.idxphi0).Psi_Winkel{valueSlider}).^2)
    set(h.plotdataIBphi0,'ydata',h.ParamsToFit(h.idxphi0).IntegralWidth{valueSlider})
    set(h.plotdataIntphi0,'xdata',sind(h.ParamsToFit(h.idxphi0).Psi_Winkel{valueSlider}).^2)
    set(h.plotdataIntphi0,'ydata',h.ParamsToFit(h.idxphi0).Intensity_Int{valueSlider})
end

if ~isempty(h.idxphi90)
    set(h.plotdatadspacingphi90,'xdata',sind(h.ParamsToFit(h.idxphi90).Psi_Winkel{valueSlider}).^2)
    set(h.plotdatadspacingphi90,'ydata',h.ParamsToFit(h.idxphi90).LatticeSpacing{valueSlider})
    set(h.plotdatadspacingphi90,'YNegativeDelta',h.ParamsToFit(h.idxphi90).LatticeSpacing_Delta{valueSlider})
    set(h.plotdatadspacingphi90,'YPositiveDelta',h.ParamsToFit(h.idxphi90).LatticeSpacing_Delta{valueSlider})
    set(h.plotreglinedspacingphi90,'xdata',h.sinpsisquare)
    set(h.plotreglinedspacingphi90,'ydata',h.sin2psi.reglinephi90(:,valueSlider))
    set(h.plotdataIBphi90,'xdata',sind(h.ParamsToFit(h.idxphi90).Psi_Winkel{valueSlider}).^2)
    set(h.plotdataIBphi90,'ydata',h.ParamsToFit(h.idxphi90).IntegralWidth{valueSlider})
    set(h.plotdataIntphi90,'xdata',sind(h.ParamsToFit(h.idxphi90).Psi_Winkel{valueSlider}).^2)
    set(h.plotdataIntphi90,'ydata',h.ParamsToFit(h.idxphi90).Intensity_Int{valueSlider})
end

if ~isempty(h.idxphi180)
    set(h.plotdatadspacingphi180,'xdata',sind(h.ParamsToFit(h.idxphi180).Psi_Winkel{valueSlider}).^2)
    set(h.plotdatadspacingphi180,'ydata',h.ParamsToFit(h.idxphi180).LatticeSpacing{valueSlider})
    set(h.plotdatadspacingphi180,'YNegativeDelta',h.ParamsToFit(h.idxphi180).LatticeSpacing_Delta{valueSlider})
    set(h.plotdatadspacingphi180,'YPositiveDelta',h.ParamsToFit(h.idxphi180).LatticeSpacing_Delta{valueSlider})
    set(h.plotreglinedspacingphi180,'xdata',h.sinpsisquare)
    set(h.plotreglinedspacingphi180,'ydata',h.sin2psi.reglinephi180(:,valueSlider))
    set(h.plotdataIBphi180,'xdata',sind(h.ParamsToFit(h.idxphi180).Psi_Winkel{valueSlider}).^2)
    set(h.plotdataIBphi180,'ydata',h.ParamsToFit(h.idxphi180).IntegralWidth{valueSlider})
    set(h.plotdataIntphi180,'xdata',sind(h.ParamsToFit(h.idxphi180).Psi_Winkel{valueSlider}).^2)
    set(h.plotdataIntphi180,'ydata',h.ParamsToFit(h.idxphi180).Intensity_Int{valueSlider})
end

if ~isempty(h.idxphi270)
    set(h.plotdatadspacingphi270,'xdata',sind(h.ParamsToFit(h.idxphi270).Psi_Winkel{valueSlider}).^2)
    set(h.plotdatadspacingphi270,'ydata',h.ParamsToFit(h.idxphi270).LatticeSpacing{valueSlider})
    set(h.plotdatadspacingphi270,'YNegativeDelta',h.ParamsToFit(h.idxphi270).LatticeSpacing_Delta{valueSlider})
    set(h.plotdatadspacingphi270,'YPositiveDelta',h.ParamsToFit(h.idxphi270).LatticeSpacing_Delta{valueSlider})
    set(h.plotreglinedspacingphi270,'xdata',h.sinpsisquare)
    set(h.plotreglinedspacingphi270,'ydata',h.sin2psi.reglinephi270(:,valueSlider))
    set(h.plotdataIBphi270,'xdata',sind(h.ParamsToFit(h.idxphi270).Psi_Winkel{valueSlider}).^2)
    set(h.plotdataIBphi270,'ydata',h.ParamsToFit(h.idxphi270).IntegralWidth{valueSlider})
    set(h.plotdataIntphi270,'xdata',sind(h.ParamsToFit(h.idxphi270).Psi_Winkel{valueSlider}).^2)
    set(h.plotdataIntphi270,'ydata',h.ParamsToFit(h.idxphi270).Intensity_Int{valueSlider})
end

% Set axes limits for lattice spacings
% Find min/max value
for k = 1:length(ia{1})
    dmin(:,k) = min(h.ParamsToFit(k).LatticeSpacing{valueSlider});
    dmax(:,k) = max(h.ParamsToFit(k).LatticeSpacing{valueSlider});
end
% Calculate limits
YLimd1 = [floor(min(dmin)*15000)/15000,ceil(max(dmax)*15000)/15000];
% YLimd1 = [floor(min(h.ParamsToFit(indphi).LatticeSpacing{valueSlider})*15000)/15000,ceil(max(h.ParamsToFit(indphi).LatticeSpacing{valueSlider})*15000)/15000];
YLimd2 = [YLimd1(1) - abs(diff(YLimd1))/2,YLimd1(2) + abs(diff(YLimd1))/2];
h.axesplotdspacing.YLim = [YLimd2(1) YLimd2(2)];
% assignin('base','hParamsToFit',h.ParamsToFit)
% Set axes limits for IB
for k = 1:length(ia{1})
    IBmin(:,k) = min(h.ParamsToFit(k).IntegralWidth{valueSlider});
    IBmax(:,k) = max(h.ParamsToFit(k).IntegralWidth{valueSlider});
end
YLimIB1 = [floor(min(IBmin)*10)/10,ceil(max(IBmax)*10)/10];
YLimIB2 = round((min(IBmin) - YLimIB1(1) + max(IBmax) - YLimIB1(2))/2,2);
% YLimIB1 = [floor(min(h.Params.IntegralWidth{valueSlider})*10)/10,ceil(max(h.Params.IntegralWidth{valueSlider})*10)/10];
% YLimIB2 = round((min(h.Params.IntegralWidth{valueSlider}) - YLimIB1(1) + max(h.Params.IntegralWidth{valueSlider}) - YLimIB1(2))/2,2);
YLimIB1 = YLimIB1 + YLimIB2;
h.axesplotIB.YLim = YLimIB1;

% Set axes limits for intensity
for k = 1:length(ia{1})
    Intmin(:,k) = min(h.ParamsToFit(k).Intensity_Int{valueSlider});
    Intmax(:,k) = max(h.ParamsToFit(k).Intensity_Int{valueSlider});
end

exponentIntLim = numel(num2str(ceil(max(Intmax))));
h.axesplotInt.YLim = [0,ceil(max(Intmax)*(10*10^(-exponentIntLim)))/(10*10^(-exponentIntLim))];

% Delete previous scatter plots in order to update the plot
delete(findobj(h.axesplotstressdata, 'type', 'scatter', 'visible', 'on'))
% Set stress data for stress plot
if length(ia{1}) == 1
    for k = 1:size(h.sin2psi.StressPlotDatatmpsorted,1)
        h.ScatterData(1).StressesPhi(:,k) = scatter(h.axesplotstressdata, h.sin2psi.StressPlotDatatmpsorted(k,1),h.sin2psi.StressPlotDatatmpsorted(k,2),200,'Marker','s','MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'LineWidth',1.5);
    end
elseif length(ia{1}) == 2
    for k = 1:size(h.sin2psi.StressPlotDatatmpsorted,1)
        h.ScatterData(1).StressesPhi(:,k) = scatter(h.axesplotstressdata, h.sin2psi.StressPlotDatatmpsorted(k,1),h.sin2psi.StressPlotDatatmpsorted(k,2),200,'Marker','s','MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'LineWidth',1.5);
        h.ScatterData(2).StressesPhi(:,k) = scatter(h.axesplotstressdata, h.sin2psi.StressPlotDatatmpsorted(k,1),h.sin2psi.StressPlotDatatmpsorted(k,4),200,'Marker','s','MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'LineWidth',1.5);
    end
elseif length(ia{1}) == 3
    for k = 1:size(h.sin2psi.StressPlotDatatmpsorted,1)
        h.ScatterData(1).StressesPhi(:,k) = scatter(h.axesplotstressdata, h.sin2psi.StressPlotDatatmpsorted(k,1),h.sin2psi.StressPlotDatatmpsorted(k,2),200,'Marker','s','MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'LineWidth',1.5);
        h.ScatterData(2).StressesPhi(:,k) = scatter(h.axesplotstressdata, h.sin2psi.StressPlotDatatmpsorted(k,1),h.sin2psi.StressPlotDatatmpsorted(k,4),200,'Marker','s','MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'LineWidth',1.5);
        h.ScatterData(3).StressesPhi(:,k) = scatter(h.axesplotstressdata, h.sin2psi.StressPlotDatatmpsorted(k,1),h.sin2psi.StressPlotDatatmpsorted(k,6),200,'Marker','s','MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'LineWidth',1.5);
    end
elseif length(ia{1}) == 4
    for k = 1:size(h.sin2psi.StressPlotDatatmpsorted,1)
        h.ScatterData(1).StressesPhi(:,k) = scatter(h.axesplotstressdata, h.sin2psi.StressPlotDatatmpsorted(k,1),h.sin2psi.StressPlotDatatmpsorted(k,2),200,'Marker','s','MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'LineWidth',1.5);
        h.ScatterData(2).StressesPhi(:,k) = scatter(h.axesplotstressdata, h.sin2psi.StressPlotDatatmpsorted(k,1),h.sin2psi.StressPlotDatatmpsorted(k,4),200,'Marker','s','MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'LineWidth',1.5);
        h.ScatterData(3).StressesPhi(:,k) = scatter(h.axesplotstressdata, h.sin2psi.StressPlotDatatmpsorted(k,1),h.sin2psi.StressPlotDatatmpsorted(k,6),200,'Marker','s','MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'LineWidth',1.5);
        h.ScatterData(4).StressesPhi(:,k) = scatter(h.axesplotstressdata, h.sin2psi.StressPlotDatatmpsorted(k,1),h.sin2psi.StressPlotDatatmpsorted(k,8),200,'Marker','s','MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'LineWidth',1.5);
    end
end
% Set scatter plot visibility off if not active
for j = 1:length(ia{1})
    if j ~= valueSliderStress
        for k = 1:size(h.sin2psi.StressPlotDatatmpsorted,1)
            h.ScatterData(j).StressesPhi(k).Visible = 'off';
        end
    else
        for k = 1:size(h.sin2psi.StressPlotDatatmpsorted,1)
            h.ScatterData(j).StressesPhi(k).Visible = 'on';
        end
    end
end

% Create label for stress plot
h.legstressdata = legend(h.axesplotstressdata,[h.ScatterData(valueSliderStress).StressesPhi],h.LabelForPlot);
% h.legstressdata = legend(h.axesplotstressdata,[h.ScatterData(valueSliderStress).StressesPhi],hkllabel);
h.legstressdata.FontSize = 15;
h.legstressdata.Location = 'best';
% Set plot properties
% --> YlimChanged = getappdata(0,'YlimChanged'); erstmal weggelassen
if valueSliderStress == 1
    % Set axis label
    if length(PhiWinkel{1}) == 2 && PhiWinkel{1}(1) == 90 && PhiWinkel{1}(2) == 270
        ylabel(h.axesplotstressdata,'<\sigma_{22} - \sigma_{33}> [MPa]')
    else
        ylabel(h.axesplotstressdata,'<\sigma_{11} - \sigma_{33}> [MPa]')  
    end
    
    h.legstressdata = legend(h.axesplotstressdata,[h.ScatterData(valueSliderStress).StressesPhi],h.LabelForPlot);
%     h.legstressdata = legend(h.axesplotstressdata,[h.ScatterData(valueSliderStress).StressesPhi],hkllabel);
    
    set(h.plotstressdata,{'xdata','visible'},{h.sin2psi.StressPlotDatatmpsorted(:,1),'on'})
    set(h.plotstressdata,{'ydata','visible'},{h.sin2psi.StressPlotDatatmpsorted(:,2),'on'})
    set(h.plotstressdata,{'YNegativeDelta','visible'},{h.sin2psi.StressPlotDatatmpsorted(:,3),'on'})
    set(h.plotstressdata,{'YPositiveDelta','visible'},{h.sin2psi.StressPlotDatatmpsorted(:,3),'on'})
    set(h.plotstressdata,'LineStyle', '--')
    set(h.plotstressdata,{'MarkerFaceColor','MarkerEdgeColor'}, {h.ColorsUsedSorted{k},h.ColorsUsedSorted{k}})
    % Set axis limits
        if size(h.sin2psi.StressPlotDatatmpsorted,1) == 1
            if isfield(h,'XlimChanged') && h.XlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.XLim = ([h.XlimMinnew(valueSliderStress) h.XlimMaxnew(valueSliderStress)]);
                if isfield(h,'XlimXTicknew') && h.XlimChanged(valueSliderStress) == 1
                    h.axesplotstressdata.XTick = h.XlimMinnew(valueSliderStress):h.XlimXTicknew(valueSliderStress):h.XlimMaxnew(valueSliderStress);
                end
            else
                h.axesplotstressdata.XLim = [0,(ceil(max(h.sin2psi.StressPlotDatatmpsorted(:,1))*0.1)/0.1 + (ceil(max(h.sin2psi.StressPlotDatatmpsorted(:,1))*0.1)/0.1)./2)];
            end
            
            if isfield(h,'YlimChanged') && h.YlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.YLim = ([h.YlimMinnew(valueSliderStress) h.YlimMaxnew(valueSliderStress)]);
                if isfield(h,'YlimYTicknew') && h.YlimChanged(valueSliderStress) == 1
                    h.axesplotstressdata.YTick = h.YlimMinnew(valueSliderStress):h.YlimYTicknew(valueSliderStress):h.YlimMaxnew(valueSliderStress);
                end
            else
                if min(h.sin2psi.StressPlotDatatmpsorted(:,2)) > 0
                    h.axesplotstressdata.YLim = [0,round(max(h.sin2psi.StressPlotDatatmpsorted(:,2))+max(h.sin2psi.StressPlotDatatmpsorted(:,2))*0.1,-1)];
                elseif min(h.sin2psi.StressPlotDatatmpsorted(:,2)) < 0
                    h.axesplotstressdata.YLim = [-1*abs(round(max(h.sin2psi.StressPlotDatatmpsorted(:,2))+max(h.sin2psi.StressPlotDatatmpsorted(:,2))*0.1)),0];
                end
            end
        else
            if isfield(h,'XlimChanged') && h.XlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.XLim = ([h.XlimMinnew(valueSliderStress) h.XlimMaxnew(valueSliderStress)]);
                if isfield(h,'XlimXTicknew') && h.XlimChanged(valueSliderStress) == 1
                    h.axesplotstressdata.XTick = h.XlimMinnew(valueSliderStress):h.XlimXTicknew(valueSliderStress):h.XlimMaxnew(valueSliderStress);
                end
            else
                h.axesplotstressdata.XLim = [0,(ceil(max(h.sin2psi.StressPlotDatatmpsorted(:,1))*0.1)/0.1)];
            end

            if isfield(h,'YlimChanged') && h.YlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.YLim = ([h.YlimMinnew(valueSliderStress) h.YlimMaxnew(valueSliderStress)]);
                if isfield(h,'YlimYTicknew') && h.YlimChanged(valueSliderStress) == 1
                    h.axesplotstressdata.YTick = h.YlimMinnew(valueSliderStress):h.YlimYTicknew(valueSliderStress):h.YlimMaxnew(valueSliderStress);
                end
            else
                YLimErr = [(min(h.sin2psi.StressPlotDatatmpsorted(:,2)) + max(h.sin2psi.StressPlotDatatmpsorted(:,3))) ...
                    (min(h.sin2psi.StressPlotDatatmpsorted(:,2)) - max(h.sin2psi.StressPlotDatatmpsorted(:,3))) ...
                    (max(h.sin2psi.StressPlotDatatmpsorted(:,2)) + max(h.sin2psi.StressPlotDatatmpsorted(:,3))) ...
                    (max(h.sin2psi.StressPlotDatatmpsorted(:,2)) - max(h.sin2psi.StressPlotDatatmpsorted(:,3)))];

                YLimtmp = [min(YLimErr) max(YLimErr)];

                YLimMinExpFactor = 1*10^(numel(num2str(abs(round(YLimtmp(1)))))-1);
                YLimMaxExpFactor = 1*10^(numel(num2str(abs(round(YLimtmp(2)))))-1);

                h.axesplotstressdata.YLim = [-(abs(floor(YLimtmp(1)/YLimMinExpFactor))*YLimMinExpFactor), ceil(YLimtmp(2)/YLimMaxExpFactor)*YLimMaxExpFactor];
            end
        end
        
elseif valueSliderStress == 2
    h.legstressdata = legend(h.axesplotstressdata,[h.ScatterData(valueSliderStress).StressesPhi],hkllabel);
    
    if length(PhiWinkel{1}) == 2 && PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 90
        ylabel(h.axesplotstressdata,'<\sigma_{22} - \sigma_{33}> [MPa]')
    elseif length(PhiWinkel{1}) == 2 && PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 180
        ylabel(h.axesplotstressdata,'<\sigma_{13}> [MPa]')
    elseif length(PhiWinkel{1}) == 2 && PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 270
        ylabel(h.axesplotstressdata,'<\sigma_{22} - \sigma_{33}> [MPa]')
    elseif length(PhiWinkel{1}) == 2 && PhiWinkel{1}(1) == 90 && PhiWinkel{1}(2) == 180
        ylabel(h.axesplotstressdata,'<\sigma_{22} - \sigma_{33}> [MPa]')
    elseif length(PhiWinkel{1}) == 2 && PhiWinkel{1}(1) == 90 && PhiWinkel{1}(2) == 270
        ylabel(h.axesplotstressdata,'<\sigma_{23}')
    elseif length(PhiWinkel{1}) == 2 && PhiWinkel{1}(1) == 180 && PhiWinkel{1}(2) == 270
        ylabel(h.axesplotstressdata,'<\sigma_{22} - \sigma_{33}> [MPa]')
    elseif length(PhiWinkel{1}) == 3 && PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 180 && PhiWinkel{1}(3) == 270
        ylabel(h.axesplotstressdata,'<\sigma_{22} - \sigma_{33}> [MPa]')
    elseif length(PhiWinkel{1}) == 3 && PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 90 && PhiWinkel{1}(3) == 270 
        ylabel(h.axesplotstressdata,'<\sigma_{22} - \sigma_{33}> [MPa]')    
    elseif length(PhiWinkel{1}) == 3 && PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 90 && PhiWinkel{1}(3) == 180 
        ylabel(h.axesplotstressdata,'<\sigma_{22} - \sigma_{33}> [MPa]')
    elseif length(PhiWinkel{1}) == 3 && PhiWinkel{1}(1) == 90 && PhiWinkel{1}(2) == 180 && PhiWinkel{1}(3) == 270 
        ylabel(h.axesplotstressdata,'<\sigma_{22} - \sigma_{33}> [MPa]')
    end
    
    set(h.plotstressdata,{'xdata','visible'},{h.sin2psi.StressPlotDatatmpsorted(:,1),'on'})
    set(h.plotstressdata,{'ydata','visible'},{h.sin2psi.StressPlotDatatmpsorted(:,4),'on'})
    set(h.plotstressdata,{'YNegativeDelta','visible'},{h.sin2psi.StressPlotDatatmpsorted(:,5),'on'})
    set(h.plotstressdata,{'YPositiveDelta','visible'},{h.sin2psi.StressPlotDatatmpsorted(:,5),'on'})
    set(h.plotstressdata,'LineStyle', '--')
    set(h.plotstressdata,{'MarkerFaceColor','MarkerEdgeColor'}, {h.ColorsUsedSorted{k},h.ColorsUsedSorted{k}})
    
        if size(h.sin2psi.StressPlotDatatmpsorted,1) == 1
            if isfield(h,'XlimChanged') && h.XlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.XLim = ([h.XlimMinnew(valueSliderStress) h.XlimMaxnew(valueSliderStress)]);
                if isfield(h,'XlimXTicknew') && h.XlimChanged(valueSliderStress) == 1
                    h.axesplotstressdata.XTick = h.XlimMinnew(valueSliderStress):h.XlimXTicknew(valueSliderStress):h.XlimMaxnew(valueSliderStress);
                end
            else
                h.axesplotstressdata.XLim = [0,(ceil(max(h.sin2psi.StressPlotDatatmpsorted(:,1))*0.1)/0.1 + (ceil(max(h.sin2psi.StressPlotDatatmpsorted(:,1))*0.1)/0.1)./2)];
            end
            if isfield(h,'YlimChanged') && h.YlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.YLim = ([h.YlimMinnew(valueSliderStress) h.YlimMaxnew(valueSliderStress)]);
                if isfield(h,'YlimYTicknew') && h.YlimChanged(valueSliderStress) == 1
                    h.axesplotstressdata.YTick = h.YlimMinnew(valueSliderStress):h.YlimYTicknew(valueSliderStress):h.YlimMaxnew(valueSliderStress);
                end
            else
                if min(h.sin2psi.StressPlotDatatmpsorted(:,4)) > 0
                    h.axesplotstressdata.YLim = [0,round(max(h.sin2psi.StressPlotDatatmpsorted(:,4))+max(h.sin2psi.StressPlotDatatmpsorted(:,4))*0.1,-1)];
                elseif min(h.sin2psi.StressPlotDatatmpsorted(:,4)) < 0
                    h.axesplotstressdata.YLim = [-1*abs(round(max(h.sin2psi.StressPlotDatatmpsorted(:,4))+max(h.sin2psi.StressPlotDatatmpsorted(:,4))*0.1)),0];
                end
            end
        else
            if isfield(h,'XlimChanged') && h.XlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.XLim = ([h.XlimMinnew(valueSliderStress) h.XlimMaxnew(valueSliderStress)]);
                if isfield(h,'XlimXTicknew') && h.XlimChanged(valueSliderStress) == 1
                    h.axesplotstressdata.XTick = h.XlimMinnew(valueSliderStress):h.XlimXTicknew(valueSliderStress):h.XlimMaxnew(valueSliderStress);
                end
            else
                h.axesplotstressdata.XLim = [0,(ceil(max(h.sin2psi.StressPlotDatatmpsorted(:,1))*0.1)/0.1)];

            end
            if isfield(h,'YlimChanged') && h.YlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.YLim = ([h.YlimMinnew(valueSliderStress) h.YlimMaxnew(valueSliderStress)]);
                if isfield(h,'YlimYTicknew') && h.YlimChanged(valueSliderStress) == 1
                    h.axesplotstressdata.YTick = h.YlimMinnew(valueSliderStress):h.YlimYTicknew(valueSliderStress):h.YlimMaxnew(valueSliderStress);
                end
            else
                YLimErr = [(min(h.sin2psi.StressPlotDatatmpsorted(:,4)) + max(h.sin2psi.StressPlotDatatmpsorted(:,5))) ...
                    (min(h.sin2psi.StressPlotDatatmpsorted(:,4)) - max(h.sin2psi.StressPlotDatatmpsorted(:,5))) ...
                    (max(h.sin2psi.StressPlotDatatmpsorted(:,4)) + max(h.sin2psi.StressPlotDatatmpsorted(:,5))) ...
                    (max(h.sin2psi.StressPlotDatatmpsorted(:,4)) - max(h.sin2psi.StressPlotDatatmpsorted(:,5)))];

                YLimtmp = [min(YLimErr) max(YLimErr)];

                YLimMinExpFactor = 1*10^(numel(num2str(abs(round(YLimtmp(1)))))-1);
                YLimMaxExpFactor = 1*10^(numel(num2str(abs(round(YLimtmp(2)))))-1);

                h.axesplotstressdata.YLim = [-(abs(floor(YLimtmp(1)/YLimMinExpFactor))*YLimMinExpFactor), ceil(YLimtmp(2)/YLimMaxExpFactor)*YLimMaxExpFactor];
            end
        end
elseif valueSliderStress == 3
    h.legstressdata = legend(h.axesplotstressdata,[h.ScatterData(valueSliderStress).StressesPhi],hkllabel);
    
    if length(PhiWinkel{1}) == 3 && PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 90 && PhiWinkel{1}(3) == 270 || length(PhiWinkel{1}) == 3 && PhiWinkel{1}(1) == 90 && PhiWinkel{1}(2) == 180 && PhiWinkel{1}(3) == 270
        ylabel(h.axesplotstressdata,'<\sigma_{23}> [MPa]')
    else
        ylabel(h.axesplotstressdata,'<\sigma_{13}> [MPa]')
    end
    
    set(h.plotstressdata,{'xdata','visible'},{h.sin2psi.StressPlotDatatmpsorted(:,1),'on'})
    set(h.plotstressdata,{'ydata','visible'},{h.sin2psi.StressPlotDatatmpsorted(:,6),'on'})
    set(h.plotstressdata,{'YNegativeDelta','visible'},{h.sin2psi.StressPlotDatatmpsorted(:,7),'on'})
    set(h.plotstressdata,{'YPositiveDelta','visible'},{h.sin2psi.StressPlotDatatmpsorted(:,7),'on'})
    set(h.plotstressdata,'LineStyle', '--')
    set(h.plotstressdata,{'MarkerFaceColor','MarkerEdgeColor'}, {h.ColorsUsedSorted{k},h.ColorsUsedSorted{k}})

        if size(h.sin2psi.StressPlotDatatmpsorted,1) == 1
            if isfield(h,'XlimChanged') && h.XlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.XLim = ([h.XlimMinnew(valueSliderStress) h.XlimMaxnew(valueSliderStress)]);
                if isfield(h,'XlimXTicknew') && h.XlimChanged(valueSliderStress) == 1
                    h.axesplotstressdata.XTick = h.XlimMinnew(valueSliderStress):h.XlimXTicknew(valueSliderStress):h.XlimMaxnew(valueSliderStress);
                end
            else
                h.axesplotstressdata.XLim = [0,(ceil(max(h.sin2psi.StressPlotDatatmpsorted(:,1))*0.1)/0.1 + (ceil(max(h.sin2psi.StressPlotDatatmpsorted(:,1))*0.1)/0.1)./2)];
            end
            if isfield(h,'YlimChanged') && h.YlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.YLim = ([h.YlimMinnew(valueSliderStress) h.YlimMaxnew(valueSliderStress)]);
                if isfield(h,'YlimYTicknew') && h.YlimChanged(valueSliderStress) == 1
                    h.axesplotstressdata.YTick = h.YlimMinnew(valueSliderStress):h.YlimYTicknew(valueSliderStress):h.YlimMaxnew(valueSliderStress);
                end
            else
                if min(h.sin2psi.StressPlotDatatmpsorted(:,6)) > 0
                    h.axesplotstressdata.YLim = [0,round(max(h.sin2psi.StressPlotDatatmpsorted(:,6))+max(h.sin2psi.StressPlotDatatmpsorted(:,6))*0.1,-1)];
                elseif min(h.sin2psi.StressPlotDatatmpsorted(:,6)) < 0
                    h.axesplotstressdata.YLim = [-1*abs(round(max(h.sin2psi.StressPlotDatatmpsorted(:,6))+max(h.sin2psi.StressPlotDatatmpsorted(:,6))*0.1)),0];
                end
            end
        else
            if isfield(h,'XlimChanged') && h.XlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.XLim = ([h.XlimMinnew(valueSliderStress) h.XlimMaxnew(valueSliderStress)]);
                if isfield(h,'XlimXTicknew') && h.XlimChanged(valueSliderStress) == 1
                    h.axesplotstressdata.XTick = h.XlimMinnew(valueSliderStress):h.XlimXTicknew(valueSliderStress):h.XlimMaxnew(valueSliderStress);
                end
            else
                h.axesplotstressdata.XLim = [0,(ceil(max(h.sin2psi.StressPlotDatatmpsorted(:,1))*0.1)/0.1)];
            end
            if isfield(h,'YlimChanged') && h.YlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.YLim = ([h.YlimMinnew(valueSliderStress) h.YlimMaxnew(valueSliderStress)]);
                if isfield(h,'YlimYTicknew') && h.YlimChanged(valueSliderStress) == 1
                    h.axesplotstressdata.YTick = h.YlimMinnew(valueSliderStress):h.YlimYTicknew(valueSliderStress):h.YlimMaxnew(valueSliderStress);
                end
            else
                YLimErr = [(min(h.sin2psi.StressPlotDatatmpsorted(:,6)) + max(h.sin2psi.StressPlotDatatmpsorted(:,7))) ...
                    (min(h.sin2psi.StressPlotDatatmpsorted(:,6)) - max(h.sin2psi.StressPlotDatatmpsorted(:,7))) ...
                    (max(h.sin2psi.StressPlotDatatmpsorted(:,6)) + max(h.sin2psi.StressPlotDatatmpsorted(:,7))) ...
                    (max(h.sin2psi.StressPlotDatatmpsorted(:,6)) - max(h.sin2psi.StressPlotDatatmpsorted(:,7)))];

                YLimtmp = [min(YLimErr) max(YLimErr)];

                YLimMinExpFactor = 1*10^(numel(num2str(abs(round(YLimtmp(1)))))-1);
                YLimMaxExpFactor = 1*10^(numel(num2str(abs(round(YLimtmp(2)))))-1);

                h.axesplotstressdata.YLim = [-(abs(floor(YLimtmp(1)/YLimMinExpFactor))*YLimMinExpFactor), ceil(YLimtmp(2)/YLimMaxExpFactor)*YLimMaxExpFactor];
            end
        end
elseif valueSliderStress == 4
    h.legstressdata = legend(h.axesplotstressdata,[h.ScatterData(valueSliderStress).StressesPhi],hkllabel);
    
    ylabel(h.axesplotstressdata,'<\sigma_{23}> [MPa]')
    
    set(h.plotstressdata,{'xdata','visible'},{h.sin2psi.StressPlotDatatmpsorted(:,1),'on'})
    set(h.plotstressdata,{'ydata','visible'},{h.sin2psi.StressPlotDatatmpsorted(:,8),'on'})
    set(h.plotstressdata,{'YNegativeDelta','visible'},{h.sin2psi.StressPlotDatatmpsorted(:,9),'on'})
    set(h.plotstressdata,{'YPositiveDelta','visible'},{h.sin2psi.StressPlotDatatmpsorted(:,9),'on'})
    set(h.plotstressdata,'LineStyle', '--')
    set(h.plotstressdata,{'MarkerFaceColor','MarkerEdgeColor'}, {h.ColorsUsedSorted{k},h.ColorsUsedSorted{k}})
    
        if size(h.sin2psi.StressPlotDatatmpsorted,1) == 1
            if isfield(h,'XlimChanged') && h.XlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.XLim = ([h.XlimMinnew(valueSliderStress) h.XlimMaxnew(valueSliderStress)]);
                if isfield(h,'XlimXTicknew') && h.XlimChanged(valueSliderStress) == 1
                    h.axesplotstressdata.XTick = h.XlimMinnew(valueSliderStress):h.XlimXTicknew(valueSliderStress):h.XlimMaxnew(valueSliderStress);
                end
            else
                h.axesplotstressdata.XLim = [0,(ceil(max(h.sin2psi.StressPlotDatatmpsorted(:,1))*0.1)/0.1 + (ceil(max(h.sin2psi.StressPlotDatatmpsorted(:,1))*0.1)/0.1)./2)];
            end
            if isfield(h,'YlimChanged') && h.YlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.YLim = ([h.YlimMinnew(valueSliderStress) h.YlimMaxnew(valueSliderStress)]);
                if isfield(h,'YlimYTicknew') && h.YlimChanged(valueSliderStress) == 1
                    h.axesplotstressdata.YTick = h.YlimMinnew(valueSliderStress):h.YlimYTicknew(valueSliderStress):h.YlimMaxnew(valueSliderStress);
                end
            else
                if min(h.sin2psi.StressPlotDatatmpsorted(:,8)) > 0
                    h.axesplotstressdata.YLim = [0,round(max(h.sin2psi.StressPlotDatatmpsorted(:,8))+max(h.sin2psi.StressPlotDatatmpsorted(:,8))*0.1,-1)];
                elseif min(h.sin2psi.StressPlotDatatmpsorted(:,8)) < 0
                    h.axesplotstressdata.YLim = [-1*abs(round(max(h.sin2psi.StressPlotDatatmpsorted(:,8))+max(h.sin2psi.StressPlotDatatmpsorted(:,8))*0.1)),0];
                end
            end
        else
            if isfield(h,'XlimChanged') && h.XlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.XLim = ([h.XlimMinnew(valueSliderStress) h.XlimMaxnew(valueSliderStress)]);
                if isfield(h,'XlimXTicknew') && h.XlimChanged(valueSliderStress) == 1
                    h.axesplotstressdata.XTick = h.XlimMinnew(valueSliderStress):h.XlimXTicknew(valueSliderStress):h.XlimMaxnew(valueSliderStress);
                end
            else
                h.axesplotstressdata.XLim = [0,(ceil(max(h.sin2psi.StressPlotDatatmpsorted(:,1))*0.1)/0.1)];
            end
            if isfield(h,'YlimChanged') && h.YlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.YLim = ([h.YlimMinnew(valueSliderStress) h.YlimMaxnew(valueSliderStress)]);
                if isfield(h,'YlimYTicknew') && h.YlimChanged(valueSliderStress) == 1
                    h.axesplotstressdata.YTick = h.YlimMinnew(valueSliderStress):h.YlimYTicknew(valueSliderStress):h.YlimMaxnew(valueSliderStress);
                end
            else
                YLimErr = [(min(h.sin2psi.StressPlotDatatmpsorted(:,8)) + max(h.sin2psi.StressPlotDatatmpsorted(:,9))) ...
                    (min(h.sin2psi.StressPlotDatatmpsorted(:,8)) - max(h.sin2psi.StressPlotDatatmpsorted(:,9))) ...
                    (max(h.sin2psi.StressPlotDatatmpsorted(:,8)) + max(h.sin2psi.StressPlotDatatmpsorted(:,9))) ...
                    (max(h.sin2psi.StressPlotDatatmpsorted(:,8)) - max(h.sin2psi.StressPlotDatatmpsorted(:,9)))];

                YLimtmp = [min(YLimErr) max(YLimErr)];

                YLimMinExpFactor = 1*10^(numel(num2str(abs(round(YLimtmp(1)))))-1);
                YLimMaxExpFactor = 1*10^(numel(num2str(abs(round(YLimtmp(2)))))-1);

                h.axesplotstressdata.YLim = [-(abs(floor(YLimtmp(1)/YLimMinExpFactor))*YLimMinExpFactor), ceil(YLimtmp(2)/YLimMaxExpFactor)*YLimMaxExpFactor];
            end
        end
end

% assignin('base','sin2psimod',h.sin2psi)
% assignin('base','Measurement',h.Measurement)
% assignin('base','Sample',h.Sample)
% assignin('base','sin2psimod',h.sin2psi)
% assignin('base','sinpsisquare',h.sinpsisquare)
% assignin('base','StressesMW',h.StressesMW)
% assignin('base','ParamsToFitMod',h.ParamsToFit)
guidata(hObj, h);

%% Export sin²psi plots button
function buttonexportplots(hObj, ~)
% Function to export plots of d-spacing, Emax, IB and Int.Int.
h = guidata(hObj);

% Function to make "Export" button blink in red during export process
col = get(hObj,'backg');  % Get the background color of the figure.
set(hObj,'str','Exporting','backg',[1 .6 .6]) % Change color of button. 
% The pause (or drawnow) is necessary to make button changes appear.
pause(.01)

% Create hkl label
Peaks = h.PeaksforLabel;
% assignin('base','PeaksforLabelexpplots',h.PeaksforLabel)
% Read hkl values from array
for ii = 1:size(Peaks,1)
	hkllabeltmp(ii,:) = mat2str(Peaks(ii,(1:3)));
end
% Remove '[' and ']' from character array
for ii = 1:size(hkllabeltmp,1)
    hkllabeltmp1(ii,:) = regexprep(hkllabeltmp(ii,:),'[','');
end

for ii = 1:size(hkllabeltmp,1)
    hkllabeltmp2(ii,:) = regexprep(hkllabeltmp1(ii,:),']','');
end
% Final output with hkl values
hkllabel = hkllabeltmp2;
label = hkllabel;

% Get phi angles
for k = 1:size(h.Params.Phi_Winkel,2)
	[PhiWinkel{k},ia{k},~] = unique(h.Params.Phi_Winkel{k});
end

% If number of phi angles has been changed after already plotting stress
% data, set back "h.plotdata" to only one entry, otherwise export of
% sin2psi plots fails
if isfield(h,'plotData') && size(h.plotData.Psi_Winkel,2) > length(ia{1})
    h.plotData.Psi_Winkel(2:end) = [];
    h.plotData.dataEmax(2:end) = [];
    h.plotData.dataIB(2:end) = [];
    h.plotData.dataIntensity_Int(2:end) = [];
    h.plotData.dataLatticeSpacing(2:end) = [];
    h.plotData.dataLatticeSpacing_Delta(2:end) = [];   
end

for j = 1:length(ia{1})
    h.plotData.Psi_Winkel{j} = h.ParamsToFit(j).Psi_Winkel;
    h.plotData.dataEmax{j} = h.ParamsToFit(j).Energy_Max;
    h.plotData.dataIB{j} = h.ParamsToFit(j).IntegralWidth;
    h.plotData.dataIntensity_Int{j} = h.ParamsToFit(j).Intensity_Int;
    h.plotData.dataLatticeSpacing{j} = h.ParamsToFit(j).LatticeSpacing;
    h.plotData.dataLatticeSpacing_Delta{j} = h.ParamsToFit(j).LatticeSpacing_Delta;
end

if ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
    h.plotData.dataRegLine{1} = h.sin2psi.reglinephi0;
elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
    h.plotData.dataRegLine{1} = h.sin2psi.reglinephi90;
elseif isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
    h.plotData.dataRegLine{1} = h.sin2psi.reglinephi180;
elseif isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
    h.plotData.dataRegLine{1} = h.sin2psi.reglinephi270;    
elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
    h.plotData.dataRegLine{1} = h.sin2psi.reglinephi0;
    h.plotData.dataRegLine{2} = h.sin2psi.reglinephi90;
elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
    h.plotData.dataRegLine{1} = h.sin2psi.reglinephi0;
    h.plotData.dataRegLine{2} = h.sin2psi.reglinephi180;
elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)	|| ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)	
    h.plotData.dataRegLine{1} = h.sin2psi.reglinephi0;
    h.plotData.dataRegLine{2} = h.sin2psi.reglinephi90;
    h.plotData.dataRegLine{3} = h.sin2psi.reglinephi180;
elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
    h.plotData.dataRegLine{1} = h.sin2psi.reglinephi90;
    h.plotData.dataRegLine{2} = h.sin2psi.reglinephi270;
elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)	|| ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)	
    h.plotData.dataRegLine{1} = h.sin2psi.reglinephi0;
    h.plotData.dataRegLine{2} = h.sin2psi.reglinephi90;
    h.plotData.dataRegLine{3} = h.sin2psi.reglinephi270;
elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
    h.plotData.dataRegLine{1} = h.sin2psi.reglinephi0;
    h.plotData.dataRegLine{2} = h.sin2psi.reglinephi90;
    h.plotData.dataRegLine{3} = h.sin2psi.reglinephi180;
    h.plotData.dataRegLine{4} = h.sin2psi.reglinephi270;
end

% Get min and max value of cell array of data for each phi angle
YlimdataEmaxtmp = h.plotData.dataEmax;
YlimdataEmaxtmp = [YlimdataEmaxtmp{:}];
YlimdataEmaxtmp = reshape(YlimdataEmaxtmp,size(YlimdataEmaxtmp,2)/length(ia{1}),length(ia{1}));
minYlimdataEmaxtmp = cellfun(@min, YlimdataEmaxtmp);
maxYlimdataEmaxtmp = cellfun(@max, YlimdataEmaxtmp);
for k = 1:size(h.plotData.dataEmax{1},2)
    maxYlimdataEmax(:,k) = max(maxYlimdataEmaxtmp(k,:));
    minYlimdataEmax(:,k) = min(minYlimdataEmaxtmp(k,:));
end
% assignin('base','maxYlimdataEmax',maxYlimdataEmax)
% assignin('base','minYlimdataEmax',minYlimdataEmax)
YlimdataIBtmp = h.plotData.dataIB;
YlimdataIBtmp = [YlimdataIBtmp{:}];
YlimdataIBtmp = reshape(YlimdataIBtmp,size(YlimdataIBtmp,2)/length(ia{1}),length(ia{1}));
minYlimdataIBtmp = cellfun(@min, YlimdataIBtmp);
maxYlimdataIBtmp = cellfun(@max, YlimdataIBtmp);
for k = 1:size(h.plotData.dataIB{1},2)
    maxYlimdataIB(:,k) = max(maxYlimdataIBtmp(k,:));
    minYlimdataIB(:,k) = min(minYlimdataIBtmp(k,:));
end

YlimdataInttmp = h.plotData.dataIntensity_Int;
YlimdataInttmp = [YlimdataInttmp{:}];
YlimdataInttmp = reshape(YlimdataInttmp,size(YlimdataInttmp,2)/length(ia{1}),length(ia{1}));
minYlimdataInttmp = cellfun(@min, YlimdataInttmp);
maxYlimdataInttmp = cellfun(@max, YlimdataInttmp);
for k = 1:size(h.plotData.dataIntensity_Int{1},2)
    maxYlimdataInt(:,k) = max(maxYlimdataInttmp(k,:));
    minYlimdataInt(:,k) = min(minYlimdataInttmp(k,:));
end

for k = 1:length(maxYlimdataInt)
    ExpInt(:,k) = numel(num2str(round(maxYlimdataInt(k))));
end

YlimdatadSpacingtmp = h.plotData.dataLatticeSpacing;
YlimdatadSpacingtmp = [YlimdatadSpacingtmp{:}];
YlimdatadSpacingtmp = reshape(YlimdatadSpacingtmp,size(YlimdatadSpacingtmp,2)/length(ia{1}),length(ia{1}));
minYlimdatadSpacingtmp = cellfun(@min, YlimdatadSpacingtmp);
maxYlimdatadSpacingtmp = cellfun(@max, YlimdatadSpacingtmp);
for k = 1:size(h.plotData.dataLatticeSpacing{1},2)
    maxYlimdatadSpacing(:,k) = max(maxYlimdatadSpacingtmp(k,:));
    minYlimdatadSpacing(:,k) = min(minYlimdatadSpacingtmp(k,:));
end

% assignin('base','hplotData',h.plotData)

% Create data for export to txt file
for k = 1:size(h.plotData.Psi_Winkel,2)
    for l = 1:size(h.plotData.Psi_Winkel{k},2)
        Datahkl.(['Phi',num2str(k)]).Psi_Winkel{l} = [h.plotData.Psi_Winkel{k}{l}];
        Datahkl.(['Phi',num2str(k)]).dataEmax{l} = [h.plotData.dataEmax{k}{l}];
        Datahkl.(['Phi',num2str(k)]).dataIB{l} = [h.plotData.dataIB{k}{l}];
        Datahkl.(['Phi',num2str(k)]).dataIntensity_Int{l} = [h.plotData.dataIntensity_Int{k}{l}];
        Datahkl.(['Phi',num2str(k)]).dataLatticeSpacing{l} = [h.plotData.dataLatticeSpacing{k}{l}];
        Datahkl.(['Phi',num2str(k)]).dataLatticeSpacing_Delta{l} = [h.plotData.dataLatticeSpacing_Delta{k}{l}];
        Datahkl.(['Phi',num2str(k)]).dataRegLine{l} = h.plotData.dataRegLine{k}(:,l);
    end
end

Datahkltmp = struct2cell(Datahkl);

for k = 1:size(Datahkltmp,1)
    for l = 1:size(Datahkltmp{k}.Psi_Winkel,2)
        DatahklPsi{l}{k} = [Datahkltmp{k}.Psi_Winkel{l}];
        DatahkldataEmax{l}{k} = [Datahkltmp{k}.dataEmax{l}];
        DatahkldataIB{l}{k} = [Datahkltmp{k}.dataIB{l}];
        DatahkldataIntensity_Int{l}{k} = [Datahkltmp{k}.dataIntensity_Int{l}];
        DatahkldataLatticeSpacing{l}{k} = [Datahkltmp{k}.dataLatticeSpacing{l}];
        DatahkldataLatticeSpacing_Delta{l}{k} = [Datahkltmp{k}.dataLatticeSpacing_Delta{l}];
        DatahkldataRegLine{l}{k} = [Datahkltmp{k}.dataRegLine{l}];
    end
end

for k = 1:size(DatahklPsi,2)
    dims(k) = max(max(cell2mat(cellfun(@(x)size(x), DatahklPsi{k}, 'uni', 0)')));
end

for k = 1:size(DatahklPsi,2)
%     dims = max(cell2mat(cellfun(@(x)size(x), DatahklPsi{k}, 'uni', 0)'));
    DatahklPsitmp{k} = cellfun(@(x)[x,nan(size(x,1),1-size(x,2));nan(dims(k)-size(x,1),1)], DatahklPsi{k},'uni', 0);
    DatahkldataEmaxtmp{k} = cellfun(@(x)[x,nan(size(x,1),1-size(x,2));nan(dims(k)-size(x,1),1)], DatahkldataEmax{k},'uni', 0);
    DatahkldataIBtmp{k} = cellfun(@(x)[x,nan(size(x,1),1-size(x,2));nan(dims(k)-size(x,1),1)], DatahkldataIB{k},'uni', 0);
    DatahkldataIntensity_Inttmp{k} = cellfun(@(x)[x,nan(size(x,1),1-size(x,2));nan(dims(k)-size(x,1),1)], DatahkldataIntensity_Int{k},'uni', 0);
    DatahkldataLatticeSpacingtmp{k} = cellfun(@(x)[x,nan(size(x,1),1-size(x,2));nan(dims(k)-size(x,1),1)], DatahkldataLatticeSpacing{k},'uni', 0);
    DatahkldataLatticeSpacing_Deltatmp{k} = cellfun(@(x)[x,nan(size(x,1),1-size(x,2));nan(dims(k)-size(x,1),1)], DatahkldataLatticeSpacing_Delta{k},'uni', 0);
    DatahkldataRegLinetmp{k} = cellfun(@(x)[x,nan(size(x,1),1-size(x,2));nan(dims(k)-size(x,1),1)], DatahkldataRegLine{k},'uni', 0);
end

% for k = 1:size(DatahklPsi,2)
% %     dims = max(cell2mat(cellfun(@(x)size(x), DatahklPsi{k}, 'uni', 0)'));
%     DatahklPsitmp{k} = cellfun(@(x)[x,nan(size(x,1),dims(2)-size(x,2));nan(dims(1)-size(x,1),dims(2))], DatahklPsi{k},'uni', 0);
%     DatahkldataEmaxtmp{k} = cellfun(@(x)[x,nan(size(x,1),dims(2)-size(x,2));nan(dims(1)-size(x,1),dims(2))], DatahkldataEmax{k},'uni', 0);
%     DatahkldataIBtmp{k} = cellfun(@(x)[x,nan(size(x,1),dims(2)-size(x,2));nan(dims(1)-size(x,1),dims(2))], DatahkldataIB{k},'uni', 0);
%     DatahkldataIntensity_Inttmp{k} = cellfun(@(x)[x,nan(size(x,1),dims(2)-size(x,2));nan(dims(1)-size(x,1),dims(2))], DatahkldataIntensity_Int{k},'uni', 0);
%     DatahkldataLatticeSpacingtmp{k} = cellfun(@(x)[x,nan(size(x,1),dims(2)-size(x,2));nan(dims(1)-size(x,1),dims(2))], DatahkldataLatticeSpacing{k},'uni', 0);
%     DatahkldataLatticeSpacing_Deltatmp{k} = cellfun(@(x)[x,nan(size(x,1),dims(2)-size(x,2));nan(dims(1)-size(x,1),dims(2))], DatahkldataLatticeSpacing_Delta{k},'uni', 0);
%     DatahkldataRegLinetmp{k} = cellfun(@(x)[x,nan(size(x,1),dims(2)-size(x,2));nan(dims(1)-size(x,1),dims(2))], DatahkldataRegLine{k},'uni', 0);
% end


% Create new folder in plot folder with name of measurement file
formatOut = 'ddmmyyyy';
d = datestr(now, formatOut);
% name = strtrim(h.Measurement(1).MeasurementSeries);
Folder = '\Plots\';

if ~isfield(h,'PathName')
    formatOut = 'ddmmyyyy';
    d = datestr(now, formatOut);
    name = strtrim(h.Measurement(1).MeasurementSeries);
    material = h.P.PopupValueMpd1;
    if strcmp(h.Diffsel,'LEDDI')
        h.PathName = [General.ProgramInfo.Path,'\Data\Results\LEDDI\',[name,'_',material,'_','added_plots','_',d]];
    elseif strcmp(h.Diffsel,'EDDI')
        h.PathName = [General.ProgramInfo.Path,'\Data\Results\EDDI\',[name,'_',material,'_','added_plots','_',d]];
    elseif strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
        h.PathName = [General.ProgramInfo.Path,'\Data\Results\MetalJet\',[name,'_',material,'_','added_plots','_',d]];    
    end
end

Path = fullfile(h.PathName,Folder);

if exist(Path,'dir') ~= 7
    mkdir(Path);
end

%% Energy vs sin2psi
Marker = {'s','o','d','p'};
for k = 1:size(h.plotData.dataEmax{1,1},2)
    figure
    fig = gcf;
    fig.PaperUnits = 'centimeters';
    fig.PaperPositionMode = 'manual';
    fig.PaperPosition = [0 0 18 12];
    ax = gca;
    ax.OuterPosition = [0 0 1.085 1.025];
    ax.TickDir = 'out';
    ax.YAxis.TickLabelFormat = '%,.3f';
    ax.Box = 'on';
    ax.XGrid = 'on';
    ax.YGrid = 'on';
    ax.GridLineStyle = '-';
    ax.GridColor = 'k';
    ax.GridAlpha = 0.3;
    ax.YLabel.String = 'Energy [keV]';
    ax.YLabel.FontSize = 24;
    ax.XLabel.String = 'sin²\psi';
    ax.XLabel.FontSize = 24;
    ax.LabelFontSizeMultiplier = 1.3;
    ax.LineWidth = 1.3;
    set(gca,'FontSize',18)
    hold on
    set(fig, 'Visible', 'off');
    % FaceColor of markers, order changes when measured under four azimuths
    if length(ia{1}) == 4
        FaceColor = {h.Colors{k},h.Colors2{k},h.Colors{k},h.Colors2{k}};
    else
        FaceColor = {h.Colors{k},h.Colors{k},h.Colors2{k},h.Colors2{k}};
    end
    
    for l = 1:length(ia{1})
        plot(sind(h.plotData.Psi_Winkel{1,l}{k}).^2,h.plotData.dataEmax{1,l}{k},'Linestyle','--','Color','k','Marker',Marker{l},'MarkerFaceColor',FaceColor{l},'MarkerEdgeColor','k','MarkerSize',12,'Clipping','off');
    end
    
    ax.XLim = [0 1];
    
    Ymin = floor(minYlimdataEmax(k)./0.05)*0.05;
    Ymax = ceil(maxYlimdataEmax(k)/0.05).*0.05;

    if abs(Ymin - minYlimdataEmax(k)) <= 0.0175
        Ymin = Ymin - 0.025;
    end

    if abs(Ymax - maxYlimdataEmax(k)) <= 0.0255
        Ymax = Ymax + 0.025;
    end
    
    if (Ymax - Ymin) <= 0.11
        ax.YLim = [floor(Ymin./0.01)*0.01 ceil(Ymax/0.01).*0.01];
        ax.YTick = ax.YLim(1):0.01:ax.YLim(2);
    elseif (Ymax - Ymin) > 0.11 && (Ymax - Ymin) <= 0.19
        ax.YLim = [floor(Ymin./0.025)*0.025 ceil(Ymax/0.025).*0.025];
        ax.YTick = ax.YLim(1):0.025:ax.YLim(2);
    elseif (Ymax - Ymin) > 0.19 && (Ymax - Ymin) <= 0.49
        ax.YLim = [floor(Ymin./0.05)*0.05 ceil(Ymax/0.05).*0.05];
        ax.YTick = ax.YLim(1):0.05:ax.YLim(2);
    elseif (Ymax - Ymin) > 0.5 && (Ymax - Ymin) <= 0.99
        ax.YLim = [floor(Ymin./0.1)*0.1 ceil(Ymax/0.1).*0.1];
        ax.YTick = ax.YLim(1):0.1:ax.YLim(2);
    elseif (Ymax - Ymin) >= 1
        ax.YLim = [floor(Ymin./0.25)*0.25 ceil(Ymax/0.25).*0.25];
        ax.YTick = ax.YLim(1):0.25:ax.YLim(2);    
    end
    
    % Create legend
    l = legend(h.LegLabelData);
    % Find best legend position
    legposcell = {'NorthWest','NorthEast','SouthWest','SouthEast'};
    % Loop through legend positions in order to get coordinates of all
    % possible corner positions
    for m = 1:4
        l.Location = legposcell{m};
        LegendPos(:,m) = l.Position;
    end
    
    for m = 1:size(h.plotData.Psi_Winkel,2)
        psiData{m} = h.plotData.Psi_Winkel{m}{k};
        dataEmax{m} = h.plotData.dataEmax{m}{k};
    end
    
    % Check if data intersects with legend box
    LegPosOpt = legendclash(ax,sind(cell2mat(psiData(:))).^2,cell2mat(dataEmax(:)),LegendPos);
    % Find index of zeros
    LegPosOptInd = find(LegPosOpt==0);
    
    if isempty(LegPosOptInd)
        l.Location = legposcell{1};
    else
        l.Location = legposcell{LegPosOptInd(1)};
    end
    
    % Set legend location and properties
%     l.Location = legposcell{LegPosOptInd(1)};
    l.FontSize = 10;
    l.LineWidth = 0.5;
    
    title(l,[label(k,:),' ','Reflex'],'FontSize',11,'FontWeight','normal')
    set(get(gca,'title'),'Units', 'Normalized', 'Position',[0.5 1.05]);
    FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_Energy_Line_','%d'],k);
    print(fig,[Path,FileName],'-painters','-dtiff','-r300')
end

% Export data Emax to txt file
if size(DatahklPsitmp{1},2) == 1
    for k = 1:size(DatahklPsitmp,2)
    
        FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_Energy_Line_','%d'],k);
        fid = fopen([[Path,'\'],FileName,'_',d,'.txt'],'w');

        fprintf(fid, [['sin2psi','   '],['Energy [keV]','(phi=',num2str(PhiWinkel{1}(1)),'°)    '],'\n']);

            % In case measurements where performed under four different phi angles
            for m = 1:size(DatahklPsitmp{k}{1},1)
                    str = sprintf('%.4f    %.4f\n',...
                    DatahklPsitmp{k}{1}(m),...
                    DatahkldataEmaxtmp{k}{1}(m));
                    str = regexprep(str, 'NaN', '  --  ');
                    fprintf(fid, '%s', str);
            end

        fclose(fid);

    end   
elseif size(DatahklPsitmp{1},2) == 2
    for k = 1:size(DatahklPsitmp,2)
        FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_Energy_Line_','%d'],k);

        fid = fopen([[Path,'\'],FileName,'_',d,'.txt'],'w');

        fprintf(fid, [['sin2psi','   '],['Energy [keV]','(phi=',num2str(PhiWinkel{1}(1)),'°)    '],...
            ['sin2psi','   '],['Energy [keV]','(phi=',num2str(PhiWinkel{1}(2)),'°)    '],'\n']);

            % In case measurements where performed under four different phi angles
            for m = 1:size(DatahklPsitmp{k}{1},1)
                    str = sprintf('%.4f    %.4f    %.4f    %.4f\n',...
                    sind(DatahklPsitmp{k}{1}(m)).^2,...
                    DatahkldataEmaxtmp{k}{1}(m),...
                    sind(DatahklPsitmp{k}{2}(m)).^2,...
                    DatahkldataEmaxtmp{k}{2}(m));
                    str = regexprep(str, 'NaN', '  --  ');
                    fprintf(fid, '%s', str);
            end

        fclose(fid);

    end
elseif size(DatahklPsitmp{1},2) == 3
    for k = 1:size(DatahklPsitmp,2)
        FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_Energy_Line_','%d'],k);

        fid = fopen([[Path,'\'],FileName,'_',d,'.txt'],'w');

        fprintf(fid, [['sin2psi','   '],['Energy [keV]','(phi=',num2str(PhiWinkel{1}(1)),'°)    '],...
            ['sin2psi','   '],['Energy [keV]','(phi=',num2str(PhiWinkel{1}(2)),'°)    '],...
            ['sin2psi','   '],['Energy [keV]','(phi=',num2str(PhiWinkel{1}(3)),'°)    '],'\n']);

            % In case measurements where performed under four different phi angles
            for m = 1:size(DatahklPsitmp{k}{1},1)
                    str = sprintf('%.4f    %.4f    %.4f    %.4f    %.4f    %.4f\n',...
                    sind(DatahklPsitmp{k}{1}(m)).^2,...
                    DatahkldataEmaxtmp{k}{1}(m),...
                    sind(DatahklPsitmp{k}{2}(m)).^2,...
                    DatahkldataEmaxtmp{k}{2}(m),...
                    sind(DatahklPsitmp{k}{3}(m)).^2,...
                    DatahkldataEmaxtmp{k}{3}(m));
                    str = regexprep(str, 'NaN', '  --  ');
                    fprintf(fid, '%s', str);
            end

        fclose(fid);

    end
elseif size(DatahklPsitmp{1},2) == 4
    for k = 1:size(DatahklPsitmp,2)
        FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_Energy_Line_','%d'],k);

        fid = fopen([[Path,'\'],FileName,'_',d,'.txt'],'w');

        fprintf(fid, [['sin2psi','   '],['Energy [keV]','(phi=',num2str(PhiWinkel{1}(1)),'°)    '],...
            ['sin2psi','   '],['Energy [keV]','(phi=',num2str(PhiWinkel{1}(2)),'°)    '],...
            ['sin2psi','   '],['Energy [keV]','(phi=',num2str(PhiWinkel{1}(3)),'°)    '],...
            ['sin2psi','   '],['Energy [keV]','(phi=',num2str(PhiWinkel{1}(4)),'°)    '],'\n']);

            % In case measurements where performed under four different phi angles
            for m = 1:size(DatahklPsitmp{k}{1},1)
                    str = sprintf('%.4f    %.4f     %.4f    %.4f    %.4f    %.4f    %.4f    %.4f\n',...
                    sind(DatahklPsitmp{k}{1}(m)).^2,...
                    DatahkldataEmaxtmp{k}{1}(m),...
                    sind(DatahklPsitmp{k}{2}(m)).^2,...
                    DatahkldataEmaxtmp{k}{2}(m),...
                    sind(DatahklPsitmp{k}{3}(m)).^2,...
                    DatahkldataEmaxtmp{k}{3}(m),...
                    sind(DatahklPsitmp{k}{4}(m)).^2,...
                    DatahkldataEmaxtmp{k}{4}(m));
                    str = regexprep(str, 'NaN', '  --  ');
                    fprintf(fid, '%s', str);
            end

        fclose(fid);

    end
end

%% IB vs sin2psi
for k = 1:size(h.plotData.dataIB{1,1},2)
    figure
    fig = gcf;
    fig.PaperUnits = 'centimeters';
    fig.PaperPosition = [0 0 18 12];
    ax = gca;
    ax.OuterPosition = [0 0 1.085 1.025];
    ax.TickDir = 'out';
    ax.Box = 'on';
    ax.XGrid = 'on';
    ax.YGrid = 'on';
    ax.GridLineStyle = '-';
    ax.GridColor = 'k';
    ax.GridAlpha = 0.3;
    ax.XLim = [0 1];
    
    Ymin = floor((minYlimdataIB(k))./0.05).*0.05;
    Ymax = ceil((maxYlimdataIB(k))/0.05).*0.05;
    
    if abs(Ymin - minYlimdataIB(k)) <= 0.01
        Ymin = Ymin - 0.025;
    end

    if abs(Ymax - maxYlimdataIB(k)) <= 0.01
        Ymax = Ymax + 0.025;
    end
    
    Ymin = floor((Ymin)./0.05).*0.05;
    Ymax = ceil((Ymax)/0.05).*0.05;
    
    ax.YLim = [Ymin, Ymax];
    
    if (Ymax - Ymin) <= 0.1
        ax.YTick = ax.YLim(1):0.01:ax.YLim(2);
        ax.YAxis.TickLabelFormat = '   %.2f ';
    elseif (Ymax - Ymin) > 0.1 && (Ymax - Ymin) < 0.25
        ax.YTick = ax.YLim(1):0.025:ax.YLim(2);
        ax.YAxis.TickLabelFormat = '  %.3f';
    elseif (Ymax - Ymin) >= 0.25 && (Ymax - Ymin) < 0.79
        ax.YTick = ax.YLim(1):0.05:ax.YLim(2);
        ax.YAxis.TickLabelFormat = '   %.2f ';
    elseif (Ymax - Ymin) >= 0.8 && (Ymax - Ymin) < 1.5
        ax.YTick = ax.YLim(1):0.1:ax.YLim(2);
        ax.YAxis.TickLabelFormat = '   %.2f ';
    elseif (Ymax - Ymin) >= 1.5
        ax.YTick = ax.YLim(1):0.25:ax.YLim(2);
        ax.YAxis.TickLabelFormat = '   %.2f ';
    end
    
    ax.YLabel.String = 'IB [keV]';
    ax.YLabel.FontSize = 24;
    ax.XLabel.String = 'sin²\psi';
    ax.XLabel.FontSize = 24;
    ax.LabelFontSizeMultiplier = 1.3;
    ax.LineWidth = 1.3;
%     assignin('base','ax',ax)
    set(gca,'FontSize',18)
    hold on
    set(fig, 'Visible', 'off');
    % FaceColor of markers, order changes when measured under four azimuths
    if length(ia{1}) == 4
        FaceColor = {h.Colors{k},h.Colors2{k},h.Colors{k},h.Colors2{k}};
    else
        FaceColor = {h.Colors{k},h.Colors{k},h.Colors2{k},h.Colors2{k}};
    end
    % Plot data
    for l = 1:length(ia{1})
        plot(sind(h.plotData.Psi_Winkel{1,l}{k}).^2,h.plotData.dataIB{1,l}{k},'Linestyle','--','Color','k','Marker',Marker{l},'MarkerFaceColor',FaceColor{l},'MarkerEdgeColor','k','MarkerSize',12,'Clipping','off');
    end
    % Create legend
    l = legend(h.LegLabelData);
    % Find best legend position
    legposcell = {'NorthWest','NorthEast','SouthWest','SouthEast'};
    % Loop through legend positions in order to get coordinates of all
    % possible corner positions
    for m = 1:4
        l.Location = legposcell{m};
        LegendPos(:,m) = l.Position;
    end
    
    for m = 1:size(h.plotData.Psi_Winkel,2)
        psiData{m} = h.plotData.Psi_Winkel{m}{k};
        dataIB{m} = h.plotData.dataIB{m}{k};
    end
    
    % Check if data intersects with legend box
    LegPosOpt = legendclash(ax,sind(cell2mat(psiData(:))).^2,cell2mat(dataIB(:)),LegendPos);
    % Find index of zeros
    LegPosOptInd = find(LegPosOpt==0);
    % Set legend location and properties
    if isempty(LegPosOptInd)
        l.Location = legposcell{1};
    else
        l.Location = legposcell{LegPosOptInd(1)};
    end
    l.FontSize = 10;
    l.LineWidth = 0.5;
    
    title(l,[label(k,:),' ','Reflex'],'FontSize',11,'FontWeight','normal')
    set(get(gca,'title'),'Units', 'Normalized', 'Position',[0.5 1.05]);
    FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_IB_Line_','%d'],k);
    print(fig,[Path,FileName],'-painters','-dtiff','-r300')
end

% Export data IB
if size(DatahklPsitmp{1},2) == 1
    for k = 1:size(DatahklPsitmp,2)
        FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_IB_Line_','%d'],k);
        fid = fopen([[Path,'\'],FileName,'_',d,'.txt'],'w');

        fprintf(fid, [['sin2psi','   '],['Integral Breadth [keV]','(phi=',num2str(PhiWinkel{1}(1)),'°)    '],'\n']);

            % In case measurements where performed under four different phi angles
            for m = 1:size(DatahklPsitmp{k}{1},1)
                    str = sprintf('%.4f    %.4f\n',...
                    sind(DatahklPsitmp{k}{1}(m)).^2,...
                    DatahkldataIBtmp{k}{1}(m));
                    str = regexprep(str, 'NaN', '  --  ');
                    fprintf(fid, '%s', str);
            end

        fclose(fid);

    end   
elseif size(DatahklPsitmp{1},2) == 2
    for k = 1:size(DatahklPsitmp,2)
        FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_IB_Line_','%d'],k);

        fid = fopen([[Path,'\'],FileName,'_',d,'.txt'],'w');

        fprintf(fid, [['sin2psi','   '],['Integral Breadth [keV]','(phi=',num2str(PhiWinkel{1}(1)),'°)    '],...
            ['sin2psi','   '],['Integral Breadth [keV]','(phi=',num2str(PhiWinkel{1}(2)),'°)    '],'\n']);

            % In case measurements where performed under four different phi angles
            for m = 1:size(DatahklPsitmp{k}{1},1)
                    str = sprintf('%.4f    %.4f    %.4f    %.4f\n',...
                    sind(DatahklPsitmp{k}{1}(m)).^2,...
                    DatahkldataIBtmp{k}{1}(m),...
                    sind(DatahklPsitmp{k}{2}(m)).^2,...
                    DatahkldataIBtmp{k}{2}(m));
                    str = regexprep(str, 'NaN', '  --  ');
                    fprintf(fid, '%s', str);
            end

        fclose(fid);

    end
elseif size(DatahklPsitmp{1},2) == 3
    for k = 1:size(DatahklPsitmp,2)
        FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_IB_Line_','%d'],k);

        fid = fopen([[Path,'\'],FileName,'_',d,'.txt'],'w');

        fprintf(fid, [['sin2psi','   '],['Integral Breadth [keV]','(phi=',num2str(PhiWinkel{1}(1)),'°)    '],...
            ['sin2psi','   '],['Integral Breadth [keV]','(phi=',num2str(PhiWinkel{1}(2)),'°)    '],...
            ['sin2psi','   '],['Integral Breadth [keV]','(phi=',num2str(PhiWinkel{1}(3)),'°)    '],'\n']);

            % In case measurements where performed under four different phi angles
            for m = 1:size(DatahklPsitmp{k}{1},1)
                    str = sprintf('%.4f    %.4f    %.4f    %.4f    %.4f    %.4f\n',...
                    sind(DatahklPsitmp{k}{1}(m)).^2,...
                    DatahkldataIBtmp{k}{1}(m),...
                    sind(DatahklPsitmp{k}{2}(m)).^2,...
                    DatahkldataIBtmp{k}{2}(m),...
                    sind(DatahklPsitmp{k}{3}(m)).^2,...
                    DatahkldataIBtmp{k}{3}(m));
                    str = regexprep(str, 'NaN', '  --  ');
                    fprintf(fid, '%s', str);
            end

        fclose(fid);

    end
elseif size(DatahklPsitmp{1},2) == 4
    for k = 1:size(DatahklPsitmp,2)
        FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_IB_Line_','%d'],k);

        fid = fopen([[Path,'\'],FileName,'_',d,'.txt'],'w');

        fprintf(fid, [['sin2psi','   '],['Integral Breadth [keV]','(phi=',num2str(PhiWinkel{1}(1)),'°)    '],...
            ['sin2psi','   '],['Integral Breadth [keV]','(phi=',num2str(PhiWinkel{1}(2)),'°)    '],...
            ['sin2psi','   '],['Integral Breadth [keV]','(phi=',num2str(PhiWinkel{1}(3)),'°)    '],...
            ['sin2psi','   '],['Integral Breadth [keV]','(phi=',num2str(PhiWinkel{1}(4)),'°)    '],'\n']);

            % In case measurements where performed under four different phi angles
            for m = 1:size(DatahklPsitmp{k}{1},1)
                    str = sprintf('%.4f    %.4f     %.4f    %.4f    %.4f    %.4f    %.4f    %.4f\n',...
                    sind(DatahklPsitmp{k}{1}(m)).^2,...
                    DatahkldataIBtmp{k}{1}(m),...
                    sind(DatahklPsitmp{k}{2}(m)).^2,...
                    DatahkldataIBtmp{k}{2}(m),...
                    sind(DatahklPsitmp{k}{3}(m)).^2,...
                    DatahkldataIBtmp{k}{3}(m),...
                    sind(DatahklPsitmp{k}{4}(m)).^2,...
                    DatahkldataIBtmp{k}{4}(m));
                    str = regexprep(str, 'NaN', '  --  ');
                    fprintf(fid, '%s', str);
            end

        fclose(fid);

    end
end

%% Int vs sin2psi
for k = 1:size(h.plotData.dataIntensity_Int{1,1},2)
    figure
    fig = gcf;
    fig.PaperUnits = 'centimeters';
    fig.PaperPosition = [0 0 18 12];
    ax = gca;
    ax.OuterPosition = [0 0 1.085 1.01];
    ax.TickDir = 'out';
    
    
    if numel(num2str(ceil(max(h.Params.Intensity_Int{k})/(10^(ExpInt(k)-1))).*(10^(ExpInt(k)-1)))) == 7
        ax.YAxis.Exponent = 4;
        ax.YAxis.TickLabelFormat = '    %4.f';
    elseif numel(num2str(ceil(max(h.Params.Intensity_Int{k})/(10^(ExpInt(k)-1))).*(10^(ExpInt(k)-1)))) == 6
        ax.YAxis.Exponent = 3;
        ax.YAxis.TickLabelFormat = '    %4.f';
    elseif numel(num2str(ceil(max(h.Params.Intensity_Int{k})/(10^(ExpInt(k)-1))).*(10^(ExpInt(k)-1)))) == 5
        ax.YAxis.Exponent = 2;
        ax.YAxis.TickLabelFormat = '    %4.f';
    elseif numel(num2str(ceil(max(h.Params.Intensity_Int{k})/(10^(ExpInt(k)-1))).*(10^(ExpInt(k)-1)))) == 4
        ax.YAxis.Exponent = 1;
        ax.YAxis.TickLabelFormat = '    %4.f';
    elseif numel(num2str(ceil(max(h.Params.Intensity_Int{k})/(10^(ExpInt(k)-1))).*(10^(ExpInt(k)-1)))) == 3
        ax.YAxis.Exponent = 0;
        ax.YAxis.TickLabelFormat = '     %3.f';
    elseif numel(num2str(ceil(max(h.Params.Intensity_Int{k})/(10^(ExpInt(k)-1))).*(10^(ExpInt(k)-1)))) == 2
        ax.YAxis.Exponent = 0;
        ax.YAxis.TickLabelFormat = '      %2.f';
    elseif numel(num2str(ceil(max(h.Params.Intensity_Int{k})/(10^(ExpInt(k)-1))).*(10^(ExpInt(k)-1)))) == 1
        ax.YAxis.Exponent = 0;
        ax.YAxis.TickLabelFormat = '       %1.f';
    end
    
    ax.Box = 'on';
    ax.XGrid = 'on';
    ax.YGrid = 'on';
    ax.GridLineStyle = '-';
    ax.GridColor = 'k';
    ax.GridAlpha = 0.3;
    ax.XLim = [0 1];
    ax.YLim = [0 ceil(maxYlimdataInt(k)/(10^(ExpInt(k)-1))).*(10^(ExpInt(k)-1))];
    ax.YLabel.String = 'Int.Intensity [cts]';
    ax.YLabel.FontSize = 24;
    ax.XLabel.String = 'sin²\psi';
    ax.XLabel.FontSize = 24;
    ax.LabelFontSizeMultiplier = 1.3;
    ax.LineWidth = 1.3;
    set(gca,'FontSize',18)
    hold on
    set(fig, 'Visible', 'off');
    % FaceColor of markers, order changes when measured under four azimuths
    if length(ia{1}) == 4
        FaceColor = {h.Colors{k},h.Colors2{k},h.Colors{k},h.Colors2{k}};
    else
        FaceColor = {h.Colors{k},h.Colors{k},h.Colors2{k},h.Colors2{k}};
    end
    
    for l = 1:length(ia{1})
        plot(sind(h.plotData.Psi_Winkel{1,l}{k}).^2,h.plotData.dataIntensity_Int{1,l}{k},'Linestyle','--','Color','k','Marker',Marker{l},'MarkerFaceColor',FaceColor{l},'MarkerEdgeColor','k','MarkerSize',12,'Clipping','off');
    end
    
    % Create legend
    l = legend(h.LegLabelData);
    % Find best legend position
    legposcell = {'NorthWest','NorthEast','SouthWest','SouthEast'};
    % Loop through legend positions in order to get coordinates of all
    % possible corner positions
    for m = 1:4
        l.Location = legposcell{m};
        LegendPos(:,m) = l.Position;
    end
    
    for m = 1:size(h.plotData.Psi_Winkel,2)
        psiData{m} = h.plotData.Psi_Winkel{m}{k};
        dataIntensity_Int{m} = h.plotData.dataIntensity_Int{m}{k};
    end
    
    % Check if data intersects with legend box
    LegPosOpt = legendclash(ax,sind(cell2mat(psiData(:))).^2,cell2mat(dataIntensity_Int(:)),LegendPos);
    % Find index of zeros
    LegPosOptInd = find(LegPosOpt==0);
    % Set legend location and properties
    if isempty(LegPosOptInd)
        l.Location = legposcell{1};
    else
        l.Location = legposcell{LegPosOptInd(1)};
    end
    l.FontSize = 10;
    l.LineWidth = 0.5;
    
    title(l,[label(k,:),' ','Reflex'],'FontSize',11,'FontWeight','normal')
    set(get(gca,'title'),'Units', 'Normalized', 'Position',[0.5 1.05]);
    FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_Int_Line_','%d'],k);
    print(fig,[Path,FileName],'-painters','-dtiff','-r300')
end

% Export data Int. Intensity
if size(DatahklPsitmp{1},2) == 1
    for k = 1:size(DatahklPsitmp,2)
        FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_Int_Line_','%d'],k);

        fid = fopen([[Path,'\'],FileName,'_',d,'.txt'],'w');

        fprintf(fid, [['sin2psi','   '],['Integrated Intensity [a.u.]','(phi=',num2str(PhiWinkel{1}(1)),'°)    '],'\n']);

            % In case measurements where performed under four different phi angles
            for m = 1:size(DatahklPsitmp{k}{1},1)
                    str = sprintf('%.4f    %d\n',...
                    sind(DatahklPsitmp{k}{1}(m)).^2,...
                    DatahkldataIntensity_Inttmp{k}{1}(m));
                    str = regexprep(str, 'NaN', '  --  ');
                    fprintf(fid, '%s', str);
            end

        fclose(fid);

    end   
elseif size(DatahklPsitmp{1},2) == 2
    for k = 1:size(DatahklPsitmp,2)
        FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_Int_Line_','%d'],k);

        fid = fopen([[Path,'\'],FileName,'_',d,'.txt'],'w');

        fprintf(fid, [['sin2psi','   '],['Integrated Intensity [a.u.]','(phi=',num2str(PhiWinkel{1}(1)),'°)    '],...
            ['sin2psi','   '],['Integrated Intensity [a.u.]','(phi=',num2str(PhiWinkel{1}(2)),'°)    '],'\n']);

            % In case measurements where performed under four different phi angles
            for m = 1:size(DatahklPsitmp{k}{1},1)
                    str = sprintf('%.4f    %d    %.4f    %d\n',...
                    sind(DatahklPsitmp{k}{1}(m)).^2,...
                    DatahkldataIntensity_Inttmp{k}{1}(m),...
                    sind(DatahklPsitmp{k}{2}(m)).^2,...
                    DatahkldataIntensity_Inttmp{k}{2}(m));
                    str = regexprep(str, 'NaN', '  --  ');
                    fprintf(fid, '%s', str);
            end

        fclose(fid);

    end
elseif size(DatahklPsitmp{1},2) == 3
    for k = 1:size(DatahklPsitmp,2)
        FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_Int_Line_','%d'],k);

        fid = fopen([[Path,'\'],FileName,'_',d,'.txt'],'w');

        fprintf(fid, [['sin2psi','   '],['Integrated Intensity [a.u.]','(phi=',num2str(PhiWinkel{1}(1)),'°)    '],...
            ['sin2psi','   '],['Integrated Intensity [a.u.]','(phi=',num2str(PhiWinkel{1}(2)),'°)    '],...
            ['sin2psi','   '],['Integrated Intensity [a.u.]','(phi=',num2str(PhiWinkel{1}(3)),'°)    '],'\n']);

            % In case measurements where performed under four different phi angles
            for m = 1:size(DatahklPsitmp{k}{1},1)
                    str = sprintf('%.4f    %d     %.4f    %d    %.4f    %d\n',...
                    sind(DatahklPsitmp{k}{1}(m)).^2,...
                    DatahkldataIntensity_Inttmp{k}{1}(m),...
                    sind(DatahklPsitmp{k}{2}(m)).^2,...
                    DatahkldataIntensity_Inttmp{k}{2}(m),...
                    sind(DatahklPsitmp{k}{3}(m)).^2,...
                    DatahkldataIntensity_Inttmp{k}{3}(m));
                    str = regexprep(str, 'NaN', '  --  ');
                    fprintf(fid, '%s', str);
            end

        fclose(fid);

    end
elseif size(DatahklPsitmp{1},2) == 4
    for k = 1:size(DatahklPsitmp,2)
        FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_Int_Line_','%d'],k);

        fid = fopen([[Path,'\'],FileName,'_',d,'.txt'],'w');

        fprintf(fid, [['sin2psi','   '],['Integrated Intensity [a.u.]','(phi=',num2str(PhiWinkel{1}(1)),'°)    '],...
            ['sin2psi','   '],['Integrated Intensity [a.u.]','(phi=',num2str(PhiWinkel{1}(2)),'°)    '],...
            ['sin2psi','   '],['Integrated Intensity [a.u.]','(phi=',num2str(PhiWinkel{1}(3)),'°)    '],...
            ['sin2psi','   '],['Integrated Intensity [a.u.]','(phi=',num2str(PhiWinkel{1}(4)),'°)    '],'\n']);

            % In case measurements where performed under four different phi angles
            for m = 1:size(DatahklPsitmp{k}{1},1)
                    str = sprintf('%.4f    %d     %.4f    %d    %.4f    %d    %.4f    %d\n',...
                    sind(DatahklPsitmp{k}{1}(m)).^2,...
                    DatahkldataIntensity_Inttmp{k}{1}(m),...
                    sind(DatahklPsitmp{k}{2}(m)).^2,...
                    DatahkldataIntensity_Inttmp{k}{2}(m),...
                    sind(DatahklPsitmp{k}{3}(m)).^2,...
                    DatahkldataIntensity_Inttmp{k}{3}(m),...
                    sind(DatahklPsitmp{k}{4}(m)).^2,...
                    DatahkldataIntensity_Inttmp{k}{4}(m));
                    str = regexprep(str, 'NaN', '  --  ');
                    fprintf(fid, '%s', str);
            end

        fclose(fid);

    end
end

%% d_vs_sin2psi
for k = 1:size(h.plotData.dataLatticeSpacing{1,1},2)
    figure
    fig = gcf;
    fig.PaperUnits = 'centimeters';
    fig.PaperPosition = [0 0 18 12];
    ax = gca;
    ax.OuterPosition = [0 0 1.085 1.025];
    ax.TickDir = 'out';
    ax.YAxis.TickLabelFormat = '%.4f';
    ax.Box = 'on';
    ax.XGrid = 'on';
    ax.YGrid = 'on';
    ax.GridLineStyle = '-';
    ax.GridColor = 'k';
    ax.GridAlpha = 0.3;
    ax.XLim = [0 1];
    % Set axes limits for lattice spacings
    % Find min/max value
    for m = 1:length(ia{1})
        dmin(:,m) = min(h.ParamsToFit(m).LatticeSpacing{k} - h.ParamsToFit(m).LatticeSpacing_Delta{k});
        dmax(:,m) = max(h.ParamsToFit(m).LatticeSpacing{k} + h.ParamsToFit(m).LatticeSpacing_Delta{k});
    end
    % Calculate limits
    % Round dmin and dmax values
    dmintmp = round(min(dmin),4);
    dmaxtmp = round(max(dmax),4);
    % Create Y limits
    YLimLow = dmintmp - 0.0001;
    YLimHigh = dmaxtmp + 0.0001;
    % Calculate difference
    Ylimdiff = YLimHigh - YLimLow;
    % Calculate Ytick marks
    if Ylimdiff >= 8e-4
        if mod(round((YLimHigh - YLimLow)*10000),2e-4*10000) >= 1
            if abs(YLimLow-min(dmin)) > abs(YLimHigh-max(dmax))
                YLimHigh = YLimHigh + 0.0001;
                if mod(round((YLimHigh - YLimLow)*10000),2e-4*10000) >= 1
                    YLimHigh = YLimHigh + 0.0001;
                end
                ax.YTick = 10*YLimLow:0.002:10*YLimHigh;
            elseif abs(YLimLow-min(dmin)) < abs(YLimHigh-max(dmax))
                YLimLow = YLimLow - 0.0001;
                if mod(round((YLimHigh - YLimLow)*10000),2e-4*10000) >= 1
                    YLimLow = YLimLow - 0.0001;
                end
                ax.YTick = 10*YLimLow:0.002:10*YLimHigh;
            end
        else
            ax.YTick = 10*YLimLow:0.002:10*YLimHigh;
        end
    elseif Ylimdiff < 8e-4 && Ylimdiff > 4e-4
        if mod(round((YLimHigh - YLimLow)*10000),2e-4*10000) >= 1
            if abs(YLimLow-min(dmin)) > abs(YLimHigh-max(dmax))
                YLimHigh = YLimHigh + 0.0001;
                ax.YTick = 10*YLimLow:0.001:10*YLimHigh;
            elseif abs(YLimLow-min(dmin)) < abs(YLimHigh-max(dmax))
                YLimLow = YLimLow - 0.0001;
                ax.YTick = 10*YLimLow:0.001:10*YLimHigh;
            end
        else
            ax.YTick = 10*YLimLow:0.001:10*YLimHigh;
        end
    elseif Ylimdiff <= 4e-4
        ax.YTick = 10*YLimLow:0.001:10*YLimHigh;  
    end

    ax.YLim = [10*YLimLow, 10*YLimHigh]; 
    ax.YLabel.String = ['d [',char(197),']'];
    ax.YLabel.FontSize = 24;
    ax.XLabel.String = 'sin²\psi';
    ax.XLabel.FontSize = 24;
    ax.LabelFontSizeMultiplier = 1.3;
    ax.LineWidth = 1.3;
    set(gca,'FontSize',18)
    hold on
    set(fig, 'Visible', 'off');
%     FaceColor = {h.Colors{k},h.Colors{k},'w','w'};
    
    % FaceColor of markers, order changes when measured under four azimuths
    if length(ia{1}) == 4
        FaceColor = {h.Colors{k},h.Colors2{k},h.Colors{k},h.Colors2{k}};
    else
        FaceColor = {h.Colors{k},h.Colors{k},h.Colors2{k},h.Colors2{k}};
    end

    if ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
        dplotphi0 = errorbar(ax,sind(h.plotData.Psi_Winkel{1,1}{k}).^2,10*h.plotData.dataLatticeSpacing{1,1}{k},10*h.plotData.dataLatticeSpacing_Delta{1,1}{k},'Linestyle','none','Color','k','Marker',Marker{1},'MarkerFaceColor',FaceColor{1},'MarkerEdgeColor','k','MarkerSize',12);
        reglineplotphi0 = line(ax,linspace(0,1,51),10.*h.plotData.dataRegLine{1,1}(:,k),'Color',h.Colors{k},'LineWidth',2);
        LegDatadspacing = [dplotphi0];
        LegLabelData = {'\phi = 0°'};
    elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
        dplotphi90 = errorbar(ax,sind(h.plotData.Psi_Winkel{1,1}{k}).^2,10*h.plotData.dataLatticeSpacing{1,1}{k},10*h.plotData.dataLatticeSpacing_Delta{1,1}{k},'Linestyle','none','Color','k','Marker',Marker{1},'MarkerFaceColor',FaceColor{1},'MarkerEdgeColor','k','MarkerSize',12);
        reglineplotphi90 = line(ax,linspace(0,1,51),10.*h.plotData.dataRegLine{1,1}(:,k),'Color',h.Colors{k},'LineWidth',2);
        LegDatadspacing = [dplotphi90];
        LegLabelData = {'\phi = 90°'};
    elseif isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
        dplotphi180 = errorbar(ax,sind(h.plotData.Psi_Winkel{1,1}{k}).^2,10*h.plotData.dataLatticeSpacing{1,1}{k},10*h.plotData.dataLatticeSpacing_Delta{1,1}{k},'Linestyle','none','Color','k','Marker',Marker{1},'MarkerFaceColor',FaceColor{1},'MarkerEdgeColor','k','MarkerSize',12);
        reglineplotphi180 = line(ax,linspace(0,1,51),10.*h.plotData.dataRegLine{1,1}(:,k),'Color',h.Colors{k},'LineWidth',2);
        LegDatadspacing = [dplotphi180];
        LegLabelData = {'\phi = 180°'};
    elseif isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
        dplotphi270 = errorbar(ax,sind(h.plotData.Psi_Winkel{1,1}{k}).^2,10*h.plotData.dataLatticeSpacing{1,1}{k},10*h.plotData.dataLatticeSpacing_Delta{1,1}{k},'Linestyle','none','Color','k','Marker',Marker{1},'MarkerFaceColor',FaceColor{1},'MarkerEdgeColor','k','MarkerSize',12);
        reglineplotphi270 = line(ax,linspace(0,1,51),10.*h.plotData.dataRegLine{1,1}(:,k),'Color',h.Colors{k},'LineWidth',2);
        LegDatadspacing = [dplotphi270];
        LegLabelData = {'\phi = 270°'};    
    elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
        dplotphi0 = errorbar(ax,sind(h.plotData.Psi_Winkel{1,1}{k}).^2,10*h.plotData.dataLatticeSpacing{1,1}{k},10*h.plotData.dataLatticeSpacing_Delta{1,1}{k},'Linestyle','none','Color','k','Marker',Marker{1},'MarkerFaceColor',FaceColor{1},'MarkerEdgeColor','k','MarkerSize',12);
        reglineplotphi0 = line(ax,linspace(0,1,51),10.*h.plotData.dataRegLine{1,1}(:,k),'Color',h.Colors{k},'LineWidth',2);
        dplotphi90 = errorbar(ax,sind(h.plotData.Psi_Winkel{1,2}{k}).^2,10*h.plotData.dataLatticeSpacing{1,2}{k},10*h.plotData.dataLatticeSpacing_Delta{1,2}{k},'Linestyle','none','Color','k','Marker',Marker{2},'MarkerFaceColor',FaceColor{2},'MarkerEdgeColor','k','MarkerSize',12);
        reglineplotphi90 = line(ax,linspace(0,1,51),10.*h.plotData.dataRegLine{1,2}(:,k),'Color',h.Colors{k},'LineWidth',2);
        LegDatadspacing = [dplotphi0 dplotphi90];
        LegLabelData = {'\phi = 0°','\phi = 90°'};
    elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
        dplotphi0 = errorbar(ax,sind(h.plotData.Psi_Winkel{1,1}{k}).^2,10*h.plotData.dataLatticeSpacing{1,1}{k},10*h.plotData.dataLatticeSpacing_Delta{1,1}{k},'Linestyle','none','Color','k','Marker',Marker{1},'MarkerFaceColor',FaceColor{1},'MarkerEdgeColor','k','MarkerSize',12);
        reglineplotphi0 = line(ax,linspace(0,1,51),10.*h.plotData.dataRegLine{1,1}(:,k),'Color',h.Colors{k},'LineWidth',2);
        dplotphi180 = errorbar(ax,sind(h.plotData.Psi_Winkel{1,2}{k}).^2,10*h.plotData.dataLatticeSpacing{1,2}{k},10*h.plotData.dataLatticeSpacing_Delta{1,2}{k},'Linestyle','none','Color','k','Marker',Marker{2},'MarkerFaceColor',FaceColor{2},'MarkerEdgeColor','k','MarkerSize',12);
        reglineplotphi180 = line(ax,linspace(0,1,51),10.*h.plotData.dataRegLine{1,2}(:,k),'Color',h.Colors{k},'LineWidth',2);
        LegDatadspacing = [dplotphi0 dplotphi180];
        LegLabelData = {'\phi = 0°','\phi = 180°'};
    elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
        dplotphi90 = errorbar(ax,sind(h.plotData.Psi_Winkel{1,1}{k}).^2,10*h.plotData.dataLatticeSpacing{1,1}{k},10*h.plotData.dataLatticeSpacing_Delta{1,1}{k},'Linestyle','none','Color','k','Marker',Marker{1},'MarkerFaceColor',FaceColor{1},'MarkerEdgeColor','k','MarkerSize',12);
        reglineplotphi90 = line(ax,linspace(0,1,51),10.*h.plotData.dataRegLine{1,1}(:,k),'Color',h.Colors{k},'LineWidth',2);
        dplotphi270 = errorbar(ax,sind(h.plotData.Psi_Winkel{1,2}{k}).^2,10*h.plotData.dataLatticeSpacing{1,2}{k},10*h.plotData.dataLatticeSpacing_Delta{1,2}{k},'Linestyle','none','Color','k','Marker',Marker{2},'MarkerFaceColor',FaceColor{2},'MarkerEdgeColor','k','MarkerSize',12);
        reglineplotphi270 = line(ax,linspace(0,1,51),10.*h.plotData.dataRegLine{1,2}(:,k),'Color',h.Colors{k},'LineWidth',2);
        LegDatadspacing = [dplotphi90 dplotphi270];
        LegLabelData = {'\phi = 90°','\phi = 270°'};	
    elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)	|| ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)	
        dplotphi0 = errorbar(ax,sind(h.plotData.Psi_Winkel{1,1}{k}).^2,10*h.plotData.dataLatticeSpacing{1,1}{k},10*h.plotData.dataLatticeSpacing_Delta{1,1}{k},'Linestyle','none','Color','k','Marker',Marker{1},'MarkerFaceColor',FaceColor{1},'MarkerEdgeColor','k','MarkerSize',12);
        reglineplotphi0 = line(ax,linspace(0,1,51),10.*h.plotData.dataRegLine{1,1}(:,k),'Color',h.Colors{k},'LineWidth',2);
        dplotphi90 = errorbar(ax,sind(h.plotData.Psi_Winkel{1,2}{k}).^2,10*h.plotData.dataLatticeSpacing{1,2}{k},10*h.plotData.dataLatticeSpacing_Delta{1,2}{k},'Linestyle','none','Color','k','Marker',Marker{2},'MarkerFaceColor',FaceColor{2},'MarkerEdgeColor','k','MarkerSize',12);
        reglineplotphi90 = line(ax,linspace(0,1,51),10.*h.plotData.dataRegLine{1,2}(:,k),'Color',h.Colors{k},'LineWidth',2);
        dplotphi180 = errorbar(ax,sind(h.plotData.Psi_Winkel{1,3}{k}).^2,10*h.plotData.dataLatticeSpacing{1,3}{k},10*h.plotData.dataLatticeSpacing_Delta{1,3}{k},'Linestyle','none','Color','k','Marker',Marker{3},'MarkerFaceColor',FaceColor{3},'MarkerEdgeColor','k','MarkerSize',12);
        reglineplotphi180 = line(ax,linspace(0,1,51),10.*h.plotData.dataRegLine{1,3}(:,k),'Color',h.Colors{k},'LineWidth',2);
        LegDatadspacing = [dplotphi0 dplotphi90 dplotphi180];
        LegLabelData = {'\phi = 0°','\phi = 90°','\phi = 180°'};	
    elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)	|| ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)	
        dplotphi0 = errorbar(ax,sind(h.plotData.Psi_Winkel{1,1}{k}).^2,10*h.plotData.dataLatticeSpacing{1,1}{k},10*h.plotData.dataLatticeSpacing_Delta{1,1}{k},'Linestyle','none','Color','k','Marker',Marker{1},'MarkerFaceColor',FaceColor{1},'MarkerEdgeColor','k','MarkerSize',12);
        reglineplotphi0 = line(ax,linspace(0,1,51),10.*h.plotData.dataRegLine{1,1}(:,k),'Color',h.Colors{k},'LineWidth',2);
        dplotphi90 = errorbar(ax,sind(h.plotData.Psi_Winkel{1,2}{k}).^2,10*h.plotData.dataLatticeSpacing{1,2}{k},10*h.plotData.dataLatticeSpacing_Delta{1,2}{k},'Linestyle','none','Color','k','Marker',Marker{2},'MarkerFaceColor',FaceColor{2},'MarkerEdgeColor','k','MarkerSize',12);
        reglineplotphi90 = line(ax,linspace(0,1,51),10.*h.plotData.dataRegLine{1,2}(:,k),'Color',h.Colors{k},'LineWidth',2);
        dplotphi270 = errorbar(ax,sind(h.plotData.Psi_Winkel{1,3}{k}).^2,10*h.plotData.dataLatticeSpacing{1,3}{k},10*h.plotData.dataLatticeSpacing_Delta{1,3}{k},'Linestyle','none','Color','k','Marker',Marker{3},'MarkerFaceColor',FaceColor{3},'MarkerEdgeColor','k','MarkerSize',12);
        reglineplotphi270 = line(ax,linspace(0,1,51),10.*h.plotData.dataRegLine{1,3}(:,k),'Color',h.Colors{k},'LineWidth',2);
        LegDatadspacing = [dplotphi0 dplotphi90 dplotphi270];
        LegLabelData = {'\phi = 0°','\phi = 90°','\phi = 270°'};
    elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
        dplotphi90 = errorbar(ax,sind(h.plotData.Psi_Winkel{1,1}{k}).^2,10*h.plotData.dataLatticeSpacing{1,1}{k},10*h.plotData.dataLatticeSpacing_Delta{1,1}{k},'Linestyle','none','Color','k','Marker',Marker{1},'MarkerFaceColor',FaceColor{1},'MarkerEdgeColor','k','MarkerSize',12);
        reglineplotphi90 = line(ax,linspace(0,1,51),10.*h.plotData.dataRegLine{1,1}(:,k),'Color',h.Colors{k},'LineWidth',2);
        dplotphi180 = errorbar(ax,sind(h.plotData.Psi_Winkel{1,2}{k}).^2,10*h.plotData.dataLatticeSpacing{1,2}{k},10*h.plotData.dataLatticeSpacing_Delta{1,2}{k},'Linestyle','none','Color','k','Marker',Marker{2},'MarkerFaceColor',FaceColor{2},'MarkerEdgeColor','k','MarkerSize',12);
        reglineplotphi180 = line(ax,linspace(0,1,51),10.*h.plotData.dataRegLine{1,2}(:,k),'Color',h.Colors{k},'LineWidth',2);
        dplotphi270 = errorbar(ax,sind(h.plotData.Psi_Winkel{1,3}{k}).^2,10*h.plotData.dataLatticeSpacing{1,3}{k},10*h.plotData.dataLatticeSpacing_Delta{1,3}{k},'Linestyle','none','Color','k','Marker',Marker{3},'MarkerFaceColor',FaceColor{3},'MarkerEdgeColor','k','MarkerSize',12);
        reglineplotphi270 = line(ax,linspace(0,1,51),10.*h.plotData.dataRegLine{1,3}(:,k),'Color',h.Colors{k},'LineWidth',2);
        LegDatadspacing = [dplotphi90 dplotphi180 dplotphi270];
        LegLabelData = {'\phi = 90°','\phi = 180°','\phi = 270°'};	
    elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
        dplotphi0 = errorbar(ax,sind(h.plotData.Psi_Winkel{1,1}{k}).^2,10*h.plotData.dataLatticeSpacing{1,1}{k},10*h.plotData.dataLatticeSpacing_Delta{1,1}{k},'Linestyle','none','Color','k','Marker',Marker{1},'MarkerFaceColor',FaceColor{1},'MarkerEdgeColor','k','MarkerSize',12);
        reglineplotphi0 = line(ax,linspace(0,1,51),10.*h.plotData.dataRegLine{1,1}(:,k),'Color',h.Colors{k},'LineWidth',2);
        dplotphi90 = errorbar(ax,sind(h.plotData.Psi_Winkel{1,2}{k}).^2,10*h.plotData.dataLatticeSpacing{1,2}{k},10*h.plotData.dataLatticeSpacing_Delta{1,2}{k},'Linestyle','none','Color','k','Marker',Marker{2},'MarkerFaceColor',FaceColor{2},'MarkerEdgeColor','k','MarkerSize',12);
        reglineplotphi90 = line(ax,linspace(0,1,51),10.*h.plotData.dataRegLine{1,2}(:,k),'Color',h.Colors{k},'LineWidth',2);
        dplotphi180 = errorbar(ax,sind(h.plotData.Psi_Winkel{1,3}{k}).^2,10*h.plotData.dataLatticeSpacing{1,3}{k},10*h.plotData.dataLatticeSpacing_Delta{1,3}{k},'Linestyle','none','Color','k','Marker',Marker{3},'MarkerFaceColor',FaceColor{3},'MarkerEdgeColor','k','MarkerSize',12);
        reglineplotphi180 = line(ax,linspace(0,1,51),10.*h.plotData.dataRegLine{1,3}(:,k),'Color',h.Colors{k},'LineWidth',2);
        dplotphi270 = errorbar(ax,sind(h.plotData.Psi_Winkel{1,4}{k}).^2,10*h.plotData.dataLatticeSpacing{1,4}{k},10*h.plotData.dataLatticeSpacing_Delta{1,4}{k},'Linestyle','none','Color','k','Marker',Marker{4},'MarkerFaceColor',FaceColor{4},'MarkerEdgeColor','k','MarkerSize',12);
        reglineplotphi270 = line(ax,linspace(0,1,51),10.*h.plotData.dataRegLine{1,4}(:,k),'Color',h.Colors{k},'LineWidth',2);
        LegDatadspacing = [dplotphi0 dplotphi90 dplotphi180 dplotphi270];
        LegLabelData = {'\phi = 0°','\phi = 90°','\phi = 180°','\phi = 270°'};
    end
    
    % Create legend
    l = legend(ax,LegDatadspacing,LegLabelData);
    % Find best legend position
    legposcell = {'NorthWest','NorthEast','SouthWest','SouthEast'};
    % Loop through legend positions in order to get coordinates of all
    % possible corner positions
    for m = 1:4
        l.Location = legposcell{m};
        LegendPos(:,m) = l.Position;
    end

    for m = 1:size(h.plotData.Psi_Winkel,2)
        psiData{m} = h.plotData.Psi_Winkel{m}{k};
        dataLatticeSpacing{m} = h.plotData.dataLatticeSpacing{m}{k};
    end

    % Check if data intersects with legend box
    LegPosOpt = legendclash(ax,sind(cell2mat(psiData(:))).^2,10.*cell2mat(dataLatticeSpacing(:)),LegendPos);
    % Find index of zeros
    LegPosOptInd = find(LegPosOpt==0);
    % Set legend location and properties
    if isempty(LegPosOptInd)
        l.Location = legposcell{1};
    else
        l.Location = legposcell{LegPosOptInd(1)};
    end
    l.FontSize = 10;
    l.LineWidth = 0.5;
    
    title(l,[label(k,:),' ','Reflex'],'FontSize',11,'FontWeight','normal')
    set(get(gca,'title'),'Units', 'Normalized', 'Position',[0.5 1.05]);
    FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_dspacing_Line_','%d'],k);
    print(fig,[Path,FileName],'-painters','-dtiff','-r300')
end

% Reset the button color
set(hObj,'str',['Export sin²',char(968),' ','plots'],'backg',col)  % Now reset the button features.

% Export data d-spacing to txt file
if size(DatahklPsitmp{1},2) == 1
    for k = 1:size(DatahklPsitmp,2)
        FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_dspacing_Line_','%d'],k);

        fid = fopen([[Path,'\'],FileName,'_',d,'.txt'],'w');

        fprintf(fid, [['sin2psi','   '],['d-spacing [A]','(phi=',num2str(PhiWinkel{1}(1)),'°)    '],['d-spacing error [A]','(phi=',num2str(PhiWinkel{1}(1)),'°)    '],'\n']);

            % In case measurements where performed under four different phi angles
            for m = 1:size(DatahklPsitmp{k}{1},1)
                    str = sprintf('%.4f  %.6f  %.6f\n',...
                    sind(DatahklPsitmp{k}{1}(m)).^2,...
                    DatahkldataLatticeSpacingtmp{k}{1}(m).*10,...
                    DatahkldataLatticeSpacing_Deltatmp{k}{1}(m).*10);
                    str = regexprep(str, 'NaN', '  --  ');
                    fprintf(fid, '%s', str);
            end

        fclose(fid);
        
        FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_dspacing_LR_Line_','%d'],k);
        fid = fopen([[Path,'\'],FileName,'_',d,'.txt'],'w');

        fprintf(fid, [['sin2psi','   '],['d-spacing Fit [A]','(phi=',num2str(PhiWinkel{1}(1)),'°)    '],'\n']);
        
        PsiPlottmp = linspace(0,1,51);
            % In case measurements where performed under four different phi angles
            for m = 1:size(DatahkldataRegLinetmp{k}{1},1)
                    str = sprintf('%.4f  %.6f\n',...
                    PsiPlottmp(m),...
                    DatahkldataRegLinetmp{k}{1}(m).*10);
                    str = regexprep(str, 'NaN', '  --  ');
                    fprintf(fid, '%s', str);
            end

        fclose(fid);

    end   
elseif size(DatahklPsitmp{1},2) == 2
    for k = 1:size(DatahklPsitmp,2)
        FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_dspacing_Line_','%d'],k);

        fid = fopen([[Path,'\'],FileName,'_',d,'.txt'],'w');

        fprintf(fid, [['sin2psi','   '],['d-spacing [A]','(phi=',num2str(PhiWinkel{1}(1)),'°)    '],['d-spacing error [A]','(phi=',num2str(PhiWinkel{1}(1)),'°)    '],...
            ['sin2psi','   '],['d-spacing [A]','(phi=',num2str(PhiWinkel{1}(2)),'°)    '],['d-spacing error [A]','(phi=',num2str(PhiWinkel{1}(2)),'°)    '],'\n']);

            % In case measurements where performed under four different phi angles
            for m = 1:size(DatahklPsitmp{k}{1},1)
                    str = sprintf('%.4f    %.6f    %.6f    %.4f    %.6f    %.6f\n',...
                    sind(DatahklPsitmp{k}{1}(m)).^2,...
                    DatahkldataLatticeSpacingtmp{k}{1}(m).*10,...
                    DatahkldataLatticeSpacing_Deltatmp{k}{1}(m).*10,...
                    sind(DatahklPsitmp{k}{2}(m)).^2,...
                    DatahkldataLatticeSpacingtmp{k}{2}(m).*10,...
                    DatahkldataLatticeSpacing_Deltatmp{k}{2}(m).*10);
                    str = regexprep(str, 'NaN', '  --  ');
                    fprintf(fid, '%s', str);
            end

        fclose(fid);
        
        FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_dspacing_Fit_Line_','%d'],k);
        fid = fopen([[Path,'\'],FileName,'_',d,'.txt'],'w');

        fprintf(fid, [['sin2psi','   '],['d-spacing Fit [A]','(phi=',num2str(PhiWinkel{1}(1)),'°)    '],...
            ['sin2psi','   '],['d-spacing Fit [A]','(phi=',num2str(PhiWinkel{1}(2)),'°)    '],'\n']);
        
        PsiPlottmp = linspace(0,1,51);
            % In case measurements where performed under four different phi angles
            for m = 1:size(DatahkldataRegLinetmp{k}{1},1)
                    str = sprintf('%.4f  %.6f  %.4f  %.6f\n',...
                    PsiPlottmp(m),...
                    DatahkldataRegLinetmp{k}{1}(m).*10,...
                    PsiPlottmp(m),...
                    DatahkldataRegLinetmp{k}{2}(m).*10);
                    str = regexprep(str, 'NaN', '  --  ');
                    fprintf(fid, '%s', str);
            end

        fclose(fid);

    end
elseif size(DatahklPsitmp{1},2) == 3
    for k = 1:size(DatahklPsitmp,2)
        FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_dspacing_Line_','%d'],k);

        fid = fopen([[Path,'\'],FileName,'_',d,'.txt'],'w');

        fprintf(fid, [['sin2psi','   '],['d-spacing [A]','(phi=',num2str(PhiWinkel{1}(1)),'°)    '],['d-spacing error [A]','(phi=',num2str(PhiWinkel{1}(1)),'°)    '],...
            ['sin2psi','   '],['d-spacing [A]','(phi=',num2str(PhiWinkel{1}(2)),'°)    '],['d-spacing error [A]','(phi=',num2str(PhiWinkel{1}(2)),'°)    '],...
            ['sin2psi','   '],['d-spacing [A]','(phi=',num2str(PhiWinkel{1}(3)),'°)    '],['d-spacing error [A]','(phi=',num2str(PhiWinkel{1}(3)),'°)    '],'\n']);

            % In case measurements where performed under four different phi angles
            for m = 1:size(DatahklPsitmp{k}{1},1)
                    str = sprintf('%.4f    %.6f    %.6f    %.4f    %.6f    %.6f    %.4f    %.6f    %.6f\n',...
                    sind(DatahklPsitmp{k}{1}(m)).^2,...
                    DatahkldataLatticeSpacingtmp{k}{1}(m).*10,...
                    DatahkldataLatticeSpacing_Deltatmp{k}{1}(m).*10,...
                    sind(DatahklPsitmp{k}{2}(m)).^2,...
                    DatahkldataLatticeSpacingtmp{k}{2}(m).*10,...
                    DatahkldataLatticeSpacing_Deltatmp{k}{2}(m).*10,...
                    sind(DatahklPsitmp{k}{3}(m)).^2,...
                    DatahkldataLatticeSpacingtmp{k}{3}(m).*10,...
                    DatahkldataLatticeSpacing_Deltatmp{k}{3}(m).*10);
                    str = regexprep(str, 'NaN', '  --  ');
                    fprintf(fid, '%s', str);
            end

        fclose(fid);
        
        FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_dspacing_Fit_Line_','%d'],k);
        fid = fopen([[Path,'\'],FileName,'_',d,'.txt'],'w');

        fprintf(fid, [['sin2psi','   '],['d-spacing Fit [A]','(phi=',num2str(PhiWinkel{1}(1)),'°)    '],...
            ['sin2psi','   '],['d-spacing Fit [A]','(phi=',num2str(PhiWinkel{1}(2)),'°)    '],...
            ['sin2psi','   '],['d-spacing Fit [A]','(phi=',num2str(PhiWinkel{1}(3)),'°)    '],'\n']);
        
        PsiPlottmp = linspace(0,1,51);
            % In case measurements where performed under four different phi angles
            for m = 1:size(DatahkldataRegLinetmp{k}{1},1)
                    str = sprintf('%.4f  %.6f  %.4f  %.6f  %.4f  %.6f\n',...
                    PsiPlottmp(m),...
                    DatahkldataRegLinetmp{k}{1}(m).*10,...
                    PsiPlottmp(m),...
                    DatahkldataRegLinetmp{k}{2}(m).*10,...
                    PsiPlottmp(m),...
                    DatahkldataRegLinetmp{k}{3}(m).*10);
                    str = regexprep(str, 'NaN', '  --  ');
                    fprintf(fid, '%s', str);
            end

        fclose(fid);

    end
elseif size(DatahklPsitmp{1},2) == 4
    for k = 1:size(DatahklPsitmp,2)
        FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_dspacing_Line_','%d'],k);

        fid = fopen([[Path,'\'],FileName,'_',d,'.txt'],'w');

        fprintf(fid, [['sin2psi','   '],['d-spacing [A]','(phi=',num2str(PhiWinkel{1}(1)),'°)    '],['d-spacing error [A]','(phi=',num2str(PhiWinkel{1}(1)),'°)    '],...
            ['sin2psi','   '],['d-spacing [A]','(phi=',num2str(PhiWinkel{1}(2)),'°)    '],['d-spacing error [A]','(phi=',num2str(PhiWinkel{1}(2)),'°)    '],...
            ['sin2psi','   '],['d-spacing [A]','(phi=',num2str(PhiWinkel{1}(3)),'°)    '],['d-spacing error [A]','(phi=',num2str(PhiWinkel{1}(3)),'°)    '],...
            ['sin2psi','   '],['d-spacing [A]','(phi=',num2str(PhiWinkel{1}(4)),'°)    '],['d-spacing error [A]','(phi=',num2str(PhiWinkel{1}(4)),'°)    '],'\n']);

            % In case measurements where performed under four different phi angles
            for m = 1:size(DatahklPsitmp{k}{1},1)
                    str = sprintf('%.4f    %.6f    %.6f     %.4f    %.6f    %.6f    %.4f    %.6f    %.6f    %.4f    %.6f    %.6f\n',...
                    sind(DatahklPsitmp{k}{1}(m)).^2,...
                    DatahkldataLatticeSpacingtmp{k}{1}(m).*10,...
                    DatahkldataLatticeSpacing_Deltatmp{k}{1}(m).*10,...
                    sind(DatahklPsitmp{k}{2}(m)).^2,...
                    DatahkldataLatticeSpacingtmp{k}{2}(m).*10,...
                    DatahkldataLatticeSpacing_Deltatmp{k}{2}(m).*10,...
                    sind(DatahklPsitmp{k}{3}(m)).^2,...
                    DatahkldataLatticeSpacingtmp{k}{3}(m).*10,...
                    DatahkldataLatticeSpacing_Deltatmp{k}{3}(m).*10,...
                    sind(DatahklPsitmp{k}{4}(m)).^2,...
                    DatahkldataLatticeSpacingtmp{k}{4}(m).*10,...
                    DatahkldataLatticeSpacing_Deltatmp{k}{4}(m).*10);
                    str = regexprep(str, 'NaN', '  --  ');
                    fprintf(fid, '%s', str);
            end

        fclose(fid);
        
        FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_dspacing_Fit_Line_','%d'],k);
        fid = fopen([[Path,'\'],FileName,'_',d,'.txt'],'w');

        fprintf(fid, [['sin2psi','   '],['d-spacing Fit [A]','(phi=',num2str(PhiWinkel{1}(1)),'°)    '],...
            ['sin2psi','   '],['d-spacing Fit [A]','(phi=',num2str(PhiWinkel{1}(2)),'°)    '],...
            ['sin2psi','   '],['d-spacing Fit [A]','(phi=',num2str(PhiWinkel{1}(3)),'°)    '],...
            ['sin2psi','   '],['d-spacing Fit [A]','(phi=',num2str(PhiWinkel{1}(4)),'°)    '],'\n']);
        
        PsiPlottmp = linspace(0,1,51);
            % In case measurements where performed under four different phi angles
            for m = 1:size(DatahkldataRegLinetmp{k}{1},1)
                    str = sprintf('%.4f  %.6f  %.4f  %.6f  %.4f  %.6f  %.4f  %.6f\n',...
                    PsiPlottmp(m),...
                    DatahkldataRegLinetmp{k}{1}(m).*10,...
                    PsiPlottmp(m),...
                    DatahkldataRegLinetmp{k}{2}(m).*10,...
                    PsiPlottmp(m),...
                    DatahkldataRegLinetmp{k}{3}(m).*10,...
                    PsiPlottmp(m),...
                    DatahkldataRegLinetmp{k}{4}(m).*10);
%                     str = regexprep(str, 'NaN', '  --  ');
                    fprintf(fid, '%s', str);
            end

        fclose(fid);

    end
end

guidata(hObj, h);

%% Export stress plots button
function buttoncreatetaufile(hObj, ~)
h = guidata(hObj);

% Get value from checkbox
% valuecheckboxTauData = get(h.checkboxTauData, 'Value');
% % Get slider value
% valueSliderStress = get(h.SliderPlotStressData, 'Value');
% Check if hkl values were selected by the user
if isfield(h, 'idxhklPeaktable')
    taudatatmp = h.sin2psi.taupsizeromean(:,h.idxhklPeaktable)';
else
    taudatatmp = h.sin2psi.taupsizeromean';
end

% Function to make "Fit" button blink in red during fitting process
col = get(hObj,'backg');  % Get the background color of the figure.
set(hObj,'str','Exporting','backg',[1 .6 .6]) % Change color of button. 
% The pause (or drawnow) is necessary to make button changes appear.
pause(.01)

% Get current stress data 
% taudata = [h.PeaksforLabel(:,1:3) h.sin2psi.sigmataulist];
if isfield(h, 'idxhklPeaktable')
    taudata = [h.PeaksforLabel(h.idxhklPeaktable,1:3) h.sin2psi.sigmataulist(h.idxhklPeaktable,:)];
    sigmataulist_tmp = h.sin2psi.sigmataulist(h.idxhklPeaktable,:);
    dzero_tmp = h.sin2psi.dzero(h.idxhklPeaktable);
else
    taudata = [h.PeaksforLabel(:,1:3) h.sin2psi.sigmataulist];
    sigmataulist_tmp = h.sin2psi.sigmataulist;
    dzero_tmp = h.sin2psi.dzero;
end

% Get phi angles
for k = 1:size(h.Params.Phi_Winkel,2)
	[PhiWinkel{k},ia{k},~] = unique(h.Params.Phi_Winkel{k});
end

if strcmp(h.Diffsel,'LEDDI')
    if strcmp(h.Detsel,'Detector 1')
        % Save taudata to file
        FileName = [strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_','Det1'];
    elseif strcmp(h.Detsel,'Detector 2')
        FileName = [strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_','Det2'];
    end
else
    % Save taudata to file
    FileName = [strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name];
end

formatOut = 'ddmmyyyy';
d = datestr(now, formatOut);
Folder = '\Psi_and_tau_File\';

if ~isfield(h,'PathName')
    name = strtrim(h.Measurement(1).MeasurementSeries);
    material = h.P.PopupValueMpd1;
    if strcmp(h.Diffsel,'LEDDI')
        h.PathName = [General.ProgramInfo.Path,'\Data\Results\LEDDI\',[name,'_',material,'_','added_plots','_',d]];
    elseif strcmp(h.Diffsel,'EDDI')
        h.PathName = [General.ProgramInfo.Path,'\Data\Results\EDDI\',[name,'_',material,'_','added_plots','_',d]];
    elseif strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
        h.PathName = [General.ProgramInfo.Path,'\Data\Results\MetalJet\',[name,'_',material,'_','added_plots','_',d]];    
    end
end
Path = fullfile(h.PathName,Folder);
        
if exist(Path,'dir') ~= 7
    mkdir(Path);
end

fid = fopen([[Path,'\'],FileName,'_',d,'.tau'],'w');

fprintf(fid,'Filename: %s.\n\n',strrep(h.Measurement(1).MeasurementSeries,' ',''));

fprintf(fid, ['2Theta [Degree]:', ' ', num2str(h.Measurement(1).twotheta),'\n']);
fprintf(fid, ['Measured azimuths [Degree]:', ' ', '{',strrep(strrep(num2str(PhiWinkel{1}'),'  ',','),',,',','),'}','\n\n']);
% Create table header, depending on the azimuths measured
fprintf(fid, ['hkl   ', 'd0[nm]'  ,'    tau0    ','Sigma11  ','Error  ','Sigma22  ','Error  ','Sigma13  ','Error  ','Sigma23  ','Error  ','\n']);

% Add table data
if size(taudata,2)-5 == 2
    for k = 1:size(taudata,1)
        if PhiWinkel{1}(1) == 0 || PhiWinkel{1}(1) == 180
            fprintf(fid,'%-5s %-9.5f %-7.2f %7d %6d %8s %6s %8s %6s %8s %6s\n',...
            strrep(num2str(taudata(k,1:3)),' ',''),...
            dzero_tmp(k),...
            taudatatmp(k,1),...
            round(taudata(k,5)),...
            round(taudata(k,6)),...
            '--',...
            '--',...
            '--',...
            '--',...
            '--',...
            '--');
        elseif PhiWinkel{1}(1) == 90 || PhiWinkel{1}(1) == 270
            fprintf(fid,'%-5s %-9.5f %-7.2f %7s %6s %8d %6d %8s %6s %8s %6s\n',...
            strrep(num2str(taudata(k,1:3)),' ',''),...
            dzero_tmp(k),...
            taudatatmp(k,1),...
            '--',...
            '--',...
            round(taudata(k,5)),...
            round(taudata(k,6)),...
            '--',...
            '--',...
            '--',...
            '--');
        end
    end
    ExportData{1,1} = [taudatatmp,sigmataulist_tmp(:,[2:3])]; 
elseif size(taudata,2)-5 == 4
    for k = 1:size(taudata,1)
        if PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 90
            fprintf(fid,'%-5s %-9.5f %-7.2f %7d %6d %8d %6d %8s %6s %8s %6s\n',...
            strrep(num2str(taudata(k,1:3)),' ',''),...
            dzero_tmp(k),...
            taudatatmp(k,1),...
            round(taudata(k,5)),...
            round(taudata(k,6)),...
            round(taudata(k,7)),...
            round(taudata(k,8)),...
            '--',...
            '--',...
            '--',...
            '--');
        elseif PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 180
            fprintf(fid,'%-5s %-9.5f %-7.2f %7d %6d %8s %6s %8d %6d %8s %6s\n',...
            strrep(num2str(taudata(k,1:3)),' ',''),...
            dzero_tmp(k),...
            taudatatmp(k,1),...
            round(taudata(k,5)),...
            round(taudata(k,6)),...
            '--',...
            '--',...
            round(taudata(k,7)),...
            round(taudata(k,8)),...
            '--',...
            '--');
        elseif PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 270
            fprintf(fid,'%-5s %-9.5f %-7.2f %7d %6d %8d %6d %8s %6s %8s %6s\n',...
            strrep(num2str(taudata(k,1:3)),' ',''),...
            dzero_tmp(k),...
            taudatatmp(k,1),...
            round(taudata(k,5)),...
            round(taudata(k,6)),...
            round(taudata(k,7)),...
            round(taudata(k,8)),...
            '--',...
            '--',...
            '--',...
            '--');
        elseif PhiWinkel{1}(1) == 90 && PhiWinkel{1}(2) == 180
            fprintf(fid,'%-5s %-9.5f %-7.2f %7d %6d %8d %6d %8s %6s %8s %6s\n',...
            strrep(num2str(taudata(k,1:3)),' ',''),...
            dzero_tmp(k),...
            taudatatmp(k,1),...
            round(taudata(k,5)),...
            round(taudata(k,6)),...
            round(taudata(k,7)),...
            round(taudata(k,8)),...
            '--',...
            '--',...
            '--',...
            '--');
        elseif PhiWinkel{1}(1) == 90 && PhiWinkel{1}(2) == 270
            fprintf(fid, ['hkl   ', 'd0[nm]'   ,' tau0    ','Sigma22  ','Error   ','Sigma23  ','Error   ','\n']);
            fprintf(fid,'%-5s %-9.5f %-7.2f %7d %6d %8s %6s %8d %6d %8s %6s\n',...
            strrep(num2str(taudata(k,1:3)),' ',''),...
            dzero_tmp(k),...
            taudatatmp(k,1),...
            '--',...
            '--',...
            round(taudata(k,5)),...
            round(taudata(k,6)),...
            '--',...
            '--',...
            round(taudata(k,7)),...
            round(taudata(k,8)));
        elseif PhiWinkel{1}(1) == 180 && PhiWinkel{1}(2) == 270
            fprintf(fid,'%-5s %-9.5f %-7.2f %7d %6d %8d %6d %8s %6s %8s %6s\n',...
            strrep(num2str(taudata(k,1:3)),' ',''),...
            dzero_tmp(k),...
            taudatatmp(k,1),...
            round(taudata(k,5)),...
            round(taudata(k,6)),...
            round(taudata(k,7)),...
            round(taudata(k,8)),...
            '--',...
            '--',...
            '--',...
            '--');
        end
    end
    ExportData{1,1} = [taudatatmp,sigmataulist_tmp(:,[2:3])];
    ExportData{1,2} = [taudatatmp,sigmataulist_tmp(:,[4:5])];
elseif size(taudata,2)-5 == 6
    for k = 1:size(taudata,1)
        if PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 90 && PhiWinkel{1}(3) == 180
            fprintf(fid,'%-5s %-9.5f %-7.2f %7d %6d %8d %6d %8d %6d %8s %6s\n',...
            strrep(num2str(taudata(k,1:3)),' ',''),...
            dzero_tmp(k),...
            taudatatmp(k,1),...
            round(taudata(k,5)),...
            round(taudata(k,6)),...
            round(taudata(k,7)),...
            round(taudata(k,8)),...
            round(taudata(k,9)),...
            round(taudata(k,10)),...
            '--',...
            '--');
        elseif PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 90 && PhiWinkel{1}(3) == 270
            fprintf(fid,'%-5s %-9.5f %-7.2f %7d %6d %8d %6d %8s %6s %8d %6d\n',...
            strrep(num2str(taudata(k,1:3)),' ',''),...
            dzero_tmp(k),...
            taudatatmp(k,1),...
            round(taudata(k,5)),...
            round(taudata(k,6)),...
            round(taudata(k,7)),...
            round(taudata(k,8)),...
            '--',...
            '--',...
            round(taudata(k,9)),...
            round(taudata(k,10)));
        elseif PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 180 && PhiWinkel{1}(3) == 270
            fprintf(fid,'%-5s %-9.5f %-7.2f %7d %6d %8d %6d %8d %6d %8s %6s\n',...
            strrep(num2str(taudata(k,1:3)),' ',''),...
            dzero_tmp(k),...
            taudatatmp(k,1),...
            round(taudata(k,5)),...
            round(taudata(k,6)),...
            round(taudata(k,7)),...
            round(taudata(k,8)),...
            round(taudata(k,9)),...
            round(taudata(k,10)),...
            '--',...
            '--');
        elseif PhiWinkel{1}(1) == 90 && PhiWinkel{1}(2) == 180 && PhiWinkel{1}(3) == 270
            fprintf(fid,'%-5s %-9.5f %-7.2f %7d %6d %8d %6d %8s %6s %8d %6d\n',...
            strrep(num2str(taudata(k,1:3)),' ',''),...
            dzero_tmp(k),...
            taudatatmp(k,1),...
            round(taudata(k,5)),...
            round(taudata(k,6)),...
            round(taudata(k,7)),...
            round(taudata(k,8)),...
            '--',...
            '--',...
            round(taudata(k,9)),...
            round(taudata(k,10)));
        end
        
    end
    ExportData{1,1} = [taudatatmp,sigmataulist_tmp(:,[2:3])];
    ExportData{1,2} = [taudatatmp,sigmataulist_tmp(:,[4:5])];
    ExportData{1,3} = [taudatatmp,sigmataulist_tmp(:,[6:7])];
elseif size(taudata,2)-5 == 8
    for k = 1:size(taudata,1)
        fprintf(fid,'%-5s %-9.5f %-7.2f %7d %6d %8d %6d %8d %6d %8d %6d\n',...
        strrep(num2str(taudata(k,1:3)),' ',''),...
        dzero_tmp(k),...
        taudatatmp(k,1),...
        round(taudata(k,5)),...
        round(taudata(k,6)),...
        round(taudata(k,7)),...
        round(taudata(k,8)),...
        round(taudata(k,9)),...
        round(taudata(k,10)),...
        round(taudata(k,11)),...
        round(taudata(k,12)));
    end
    ExportData{1,1} = [taudatatmp,sigmataulist_tmp(:,[2:3])];
    ExportData{1,2} = [taudatatmp,sigmataulist_tmp(:,[4:5])];
    ExportData{1,3} = [taudatatmp,sigmataulist_tmp(:,[6:7])];
    ExportData{1,4} = [taudatatmp,sigmataulist_tmp(:,[8:9])];
end

% assignin('base','taudatatmp',taudatatmp)
% assignin('base','hsigmataulist',h.sin2psi.sigmataulist)
% assignin('base','ExportData',ExportData)

fclose(fid);
%--------------------------------------------------------------------------
% Save data from tau file in case it should be loaded again
t.PeaksforLabel = h.PeaksforLabel;
t.sin2psi = h.sin2psi;
t.Params.Phi_Winkel = h.Params.Phi_Winkel;
t.taudata = taudata;
t.taudatatmp = taudatatmp;
t.Diffsel  = h.Diffsel;
t.Detsel  = h.Detsel;
t.Measurement  = h.Measurement(1);
t.P.PopupValueMpd1  = h.P.PopupValueMpd1;
t.ColorsUsedSorted = h.ColorsUsedSorted;
t.Sample.Materials.Name = h.Sample.Materials.Name;

save(fullfile(Path, [FileName,'_taudata_',d]), 't');
%--------------------------------------------------------------------------
% Create new folder in plot folder with name of measurement file
formatOut = 'ddmmyyyy';
d = datestr(now, formatOut);
% name = strtrim(h.Measurement(1).MeasurementSeries);
Folder = '\StressPlots\';
Path = fullfile(h.PathName,Folder);

if exist(Path,'dir') ~= 7
    mkdir(Path);
end

%% Create stress plots
for j = 1:(size(taudata,2)-5)/2
    figure

    fig = gcf;
    fig.PaperUnits = 'centimeters';
    fig.PaperPosition = [0 0 18 12];
    ax = gca;
    ax.OuterPosition = [0 0 1.085 1.025];

    set(fig, 'Visible', 'off');

    for k = 1:size(taudata,1)
        hkl(k,:) = strrep(num2str(taudata(k,1:3)),' ','');
    end

    for ii = length(ExportData{1,j}(:,2)):-1:1
        h.barplots = bar(ax, ExportData{1,j}(1:ii,2), 'FaceColor', h.Colors{ii});
        hold on;
    end

    h.barplots.BaseLine.LineWidth = 1.3;

    ax.XLim = ([0.25 length(ExportData{1,j}(:,2))+0.75]);
    ax.TickDir = 'in';
    labels = arrayfun(@(value) num2str(value,'%d'),round(ExportData{1,j}(:,3)),'UniformOutput',false);

    for k = 1:length(ExportData{1,j}(:,2))
        if ExportData{1,j}(k,2) < 0
            yPos(1,k) = -(max(abs(ExportData{1,j}(:,2)))/10)-5;
        else
            yPos(1,k) = 10;
        end
    end

    text((1:length(ExportData{1,j}(:,2))),yPos,labels,...
        'FontSize', 14,...
        'Color', 'k',...
        'EdgeColor', 'k',...
        'BackgroundColor', 'w',...
        'Margin', 2,...
        'HorizontalAlignment','center',...
        'VerticalAlignment','bottom');

    xlabel('Interference hkl','FontSize', 16)
    xl = get(gca,'XLabel');
    xlFontSize = get(xl,'FontSize');
    set(gca, 'xticklabel', hkl);
    xAX = get(gca,'XAxis');
    set(xAX, 'FontSize', 16)
    set(xl, 'FontSize', xlFontSize);

%     if length(PhiWinkel{1}) == 1
%         if PhiWinkel{1}(j) == 0 || PhiWinkel{1}(j) == 180
%             ylabel('<\sigma_{11} - \sigma_{33}> [MPa]','FontSize', 20)
%         elseif PhiWinkel{1}(j) == 90 || PhiWinkel{1}(j) == 270
%             ylabel('<\sigma_{22} - \sigma_{33}> [MPa]','FontSize', 20)
%         end
%     elseif length(PhiWinkel{1}) == 2
%         if PhiWinkel{1}(1) == 0
%             ylabel('<\sigma_{11} - \sigma_{33}> [MPa]','FontSize', 20)
%         elseif PhiWinkel{1}(j) == 90
%             ylabel('<\sigma_{22} - \sigma_{33}> [MPa]','FontSize', 20)
%         elseif PhiWinkel{1}(j) == 180
%             ylabel('<\sigma_{13} - \sigma_{33}> [MPa]','FontSize', 20)
%         elseif PhiWinkel{1}(j) == 270
%             ylabel('<\sigma_{23} - \sigma_{33}> [MPa]','FontSize', 20)
%         end
%     end
    
    if length(PhiWinkel{1}) == 1
        if PhiWinkel{1}(1) == 0 || PhiWinkel{1}(1) == 180
            ylabel('<\sigma_{11} - \sigma_{33}> [MPa]','FontSize', 20)
        elseif PhiWinkel{1}(1) == 90 || PhiWinkel{1}(1) == 270
            ylabel('<\sigma_{22} - \sigma_{33}> [MPa]','FontSize', 20)
        end
    elseif length(PhiWinkel{1}) == 2
        if j == 1
            if PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 90
                ylabel('<\sigma_{11} - \sigma_{33}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 180
                ylabel('<\sigma_{11} - \sigma_{33}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 270
                ylabel('<\sigma_{11} - \sigma_{33}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 90 && PhiWinkel{1}(2) == 180
                ylabel('<\sigma_{11} - \sigma_{33}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 90 && PhiWinkel{1}(2) == 270
                ylabel('<\sigma_{22} - \sigma_{33}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 180 && PhiWinkel{1}(2) == 270
                ylabel('<\sigma_{11} - \sigma_{33}> [MPa]','FontSize', 20)
            end
        elseif j == 2
            if PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 90
                ylabel('<\sigma_{22} - \sigma_{33}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 180
                ylabel('<\sigma_{13}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 270
                ylabel('<\sigma_{22} - \sigma_{33}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 90 && PhiWinkel{1}(2) == 180
                ylabel('<\sigma_{22} - \sigma_{33}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 90 && PhiWinkel{1}(2) == 270
                ylabel('<\sigma_{23}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 180 && PhiWinkel{1}(2) == 270
                ylabel('<\sigma_{22} - \sigma_{33}> [MPa]','FontSize', 20)
            end
        end
    elseif length(PhiWinkel{1}) == 3
        if j == 1
            if PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 90 && PhiWinkel{1}(3) == 180
                ylabel('<\sigma_{11} - \sigma_{33}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 90 && PhiWinkel{1}(3) == 270
                ylabel('<\sigma_{11} - \sigma_{33}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 180 && PhiWinkel{1}(3) == 270
                ylabel('<\sigma_{11} - \sigma_{33}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 90 && PhiWinkel{1}(2) == 180 && PhiWinkel{1}(3) == 270
                ylabel('<\sigma_{11} - \sigma_{33}> [MPa]','FontSize', 20)
            end
        elseif j == 2
            if PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 90 && PhiWinkel{1}(3) == 180
                ylabel('<\sigma_{22} - \sigma_{33}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 90 && PhiWinkel{1}(3) == 270
                ylabel('<\sigma_{22} - \sigma_{33}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 180 && PhiWinkel{1}(3) == 270
                ylabel('<\sigma_{22} - \sigma_{33}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 90 && PhiWinkel{1}(2) == 180 && PhiWinkel{1}(3) == 270
                ylabel('<\sigma_{22} - \sigma_{33}> [MPa]','FontSize', 20)
            end
        elseif j == 3
            if PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 90 && PhiWinkel{1}(3) == 180
                ylabel('<\sigma_{13}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 90 && PhiWinkel{1}(3) == 270
                ylabel('<\sigma_{23}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 180 && PhiWinkel{1}(3) == 270
                ylabel('<\sigma_{13}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 90 && PhiWinkel{1}(2) == 180 && PhiWinkel{1}(3) == 270
                ylabel('<\sigma_{23}> [MPa]','FontSize', 20)
            end
        end
    elseif length(PhiWinkel{1}) == 4
         if j == 1
            ylabel('<\sigma_{11} - \sigma_{33}> [MPa]','FontSize', 20)
        elseif j == 2
            ylabel('<\sigma_{22} - \sigma_{33}> [MPa]','FontSize', 20)
        elseif j == 3
            ylabel('<\sigma_{13}> [MPa]','FontSize', 20)
        elseif j == 4
            ylabel('<\sigma_{23}> [MPa]','FontSize', 20)
        end
    end

    yl = get(gca,'XLabel');
    ylFontSize = get(yl,'FontSize');
    yAX = get(gca,'YAxis');
    set(yAX, 'FontSize', 16)
    set(yl, 'FontSize', ylFontSize);
    set(gca, 'LineWidth', 1.3)

    title([strrep(strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',' '), ' ',h.Sample.Materials.Name])
    
    if strcmp(h.Diffsel,'LEDDI')
        if strcmp(h.Detsel,'Detector 1')
            % Save taudata to file
            FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_','Det1_stress_barplot_','%d'],j);
        elseif strcmp(h.Detsel,'Detector 2')
            FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_','Det2_stress_barplot_','%d'],j);
        end
    else
        % Save taudata to file
        FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_stress_barplot_','%d'],j);
    end
    
    print(fig,[Path,FileName],'-painters','-dtiff','-r300')

    figure
    fig = gcf;
    fig.PaperUnits = 'centimeters';
    fig.PaperPositionMode = 'auto';
    fig.PaperPosition = [0 0 18 12];
    ax = gca;
    ax.OuterPosition = [0 0 1.0625 1.025];
    ax.TickDir = 'in';
    ax.Box = 'on';
    ax.XGrid = 'on';
    ax.YGrid = 'on';
    ax.GridLineStyle = '-';
    ax.GridColor = 'k';
    ax.GridAlpha = 0.3;
    if isfield(h, 'XlimMaxnew')
        if h.XlimChanged(j) ~= 0
            ax.XLim = ([h.XlimMinnew(j) h.XlimMaxnew(j)]); 
            ax.XTick = h.XlimMinnew(j):h.XlimXTicknew(j):h.XlimMaxnew(j);
        end
    end
    if isfield(h, 'YlimMinnew')
        if h.YlimChanged(j) ~= 0
            ax.YLim = ([h.YlimMinnew(j) h.YlimMaxnew(j)]);
            ax.YTick = h.YlimMinnew(j):h.YlimYTicknew(j):h.YlimMaxnew(j);
        end
    end
    
%     if length(PhiWinkel{1}) == 1
%         ylabel('<\sigma_{11} - \sigma_{33}> [MPa]','FontSize', 20)
%     else
%         if PhiWinkel{1}(j) == 0
%             ylabel('<\sigma_{11} - \sigma_{33}> [MPa]','FontSize', 20)
%         elseif PhiWinkel{1}(j) == 90
%             ylabel('<\sigma_{22} - \sigma_{33}> [MPa]','FontSize', 20)
%         elseif PhiWinkel{1}(j) == 180
%             ylabel('<\sigma_{13} - \sigma_{33}> [MPa]','FontSize', 20)
%         elseif PhiWinkel{1}(j) == 270
%             ylabel('<\sigma_{23} - \sigma_{33}> [MPa]','FontSize', 20)
%         end
%     end
    
    if length(PhiWinkel{1}) == 1
        if PhiWinkel{1}(1) == 0 || PhiWinkel{1}(1) == 180
            ylabel('<\sigma_{11} - \sigma_{33}> [MPa]','FontSize', 20)
        elseif PhiWinkel{1}(1) == 90 || PhiWinkel{1}(1) == 270
            ylabel('<\sigma_{22} - \sigma_{33}> [MPa]','FontSize', 20)
        end
    elseif length(PhiWinkel{1}) == 2
        if j == 1
            if PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 90
                ylabel('<\sigma_{11} - \sigma_{33}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 180
                ylabel('<\sigma_{11} - \sigma_{33}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 270
                ylabel('<\sigma_{11} - \sigma_{33}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 90 && PhiWinkel{1}(2) == 180
                ylabel('<\sigma_{11} - \sigma_{33}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 90 && PhiWinkel{1}(2) == 270
                ylabel('<\sigma_{22} - \sigma_{33}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 180 && PhiWinkel{1}(2) == 270
                ylabel('<\sigma_{11} - \sigma_{33}> [MPa]','FontSize', 20)
            end
        elseif j == 2
            if PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 90
                ylabel('<\sigma_{22} - \sigma_{33}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 180
                ylabel('<\sigma_{13}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 270
                ylabel('<\sigma_{22} - \sigma_{33}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 90 && PhiWinkel{1}(2) == 180
                ylabel('<\sigma_{22} - \sigma_{33}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 90 && PhiWinkel{1}(2) == 270
                ylabel('<\sigma_{23}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 180 && PhiWinkel{1}(2) == 270
                ylabel('<\sigma_{22} - \sigma_{33}> [MPa]','FontSize', 20)
            end
        end
    elseif length(PhiWinkel{1}) == 3
        if j == 1
            if PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 90 && PhiWinkel{1}(3) == 180
                ylabel('<\sigma_{11} - \sigma_{33}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 90 && PhiWinkel{1}(3) == 270
                ylabel('<\sigma_{11} - \sigma_{33}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 180 && PhiWinkel{1}(3) == 270
                ylabel('<\sigma_{11} - \sigma_{33}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 90 && PhiWinkel{1}(2) == 180 && PhiWinkel{1}(3) == 270
                ylabel('<\sigma_{11} - \sigma_{33}> [MPa]','FontSize', 20)
            end
        elseif j == 2
            if PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 90 && PhiWinkel{1}(3) == 180
                ylabel('<\sigma_{22} - \sigma_{33}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 90 && PhiWinkel{1}(3) == 270
                ylabel('<\sigma_{22} - \sigma_{33}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 180 && PhiWinkel{1}(3) == 270
                ylabel('<\sigma_{22} - \sigma_{33}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 90 && PhiWinkel{1}(2) == 180 && PhiWinkel{1}(3) == 270
                ylabel('<\sigma_{22} - \sigma_{33}> [MPa]','FontSize', 20)
            end
        elseif j == 3
            if PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 90 && PhiWinkel{1}(3) == 180
                ylabel('<\sigma_{13}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 90 && PhiWinkel{1}(3) == 270
                ylabel('<\sigma_{23}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 180 && PhiWinkel{1}(3) == 270
                ylabel('<\sigma_{13}> [MPa]','FontSize', 20)
            elseif PhiWinkel{1}(1) == 90 && PhiWinkel{1}(2) == 180 && PhiWinkel{1}(3) == 270
                ylabel('<\sigma_{23}> [MPa]','FontSize', 20)
            end
        end
    elseif length(PhiWinkel{1}) == 4
         if j == 1
            ylabel('<\sigma_{11} - \sigma_{33}> [MPa]','FontSize', 20)
        elseif j == 2
            ylabel('<\sigma_{22} - \sigma_{33}> [MPa]','FontSize', 20)
        elseif j == 3
            ylabel('<\sigma_{13}> [MPa]','FontSize', 20)
        elseif j == 4
            ylabel('<\sigma_{23}> [MPa]','FontSize', 20)
        end
    end

    ax.YLabel.FontSize = 24;
%     if valuecheckboxTauData == 0
%         ax.XLabel.String = '<\tau> [µm]';
    ax.XLabel.String = '\tau_{0} [µm]';
%     else
%         ax.XLabel.String = '\tau_{0} [µm]';
%     end
    ax.XLabel.FontSize = 24;
    ax.LabelFontSizeMultiplier = 1.3;
    ax.LineWidth = 1.3;
    set(gca,'FontSize',18)
    hold on
    set(fig, 'Visible', 'off');
    
    x = ExportData{1,j}(:,1);
    y = ExportData{1,j}(:,2);
    err = ExportData{1,j}(:,3);

    errorbar(x,y,err,'Linestyle','--','Color','k','Marker','s','MarkerSize',1,'Clipping','off','Visible','on');

    for k=1:numel(h.ScatterData(1).StressesPhi)
        ScatterData(j).StressesPhi(:,k) = scatter(ExportData{1,j}(k,1),ExportData{1,j}(k,2),200,'Marker','s','MarkerFaceColor',h.Colors{k},'MarkerEdgeColor',h.Colors{k},'LineWidth',1.5);
    end

    label = CreateHKLlabel(h);

    if isfield(h, 'idxhklPeaktable')
        legstressdata = legend(ScatterData(j).StressesPhi,label(h.idxhklPeaktable,:));
    else
        legstressdata = legend(ScatterData(j).StressesPhi,label);
    end
    
%     legstressdata = legend(ScatterData(j).StressesPhi,label);
    
    legstressdata.FontSize = 12;
%     legstressdata.Location = 'northeast';
%     assignin('base','legstressdata',h.legstressdata)
    if h.legstressdata.Position(1) < 0.4 && h.legstressdata.Position(2) > 0.4
        legstressdata.Location = 'NorthWest';
    elseif h.legstressdata.Position(1) > 0.4 && h.legstressdata.Position(2) > 0.4
        legstressdata.Location = 'NorthEast';
    elseif h.legstressdata.Position(1) < 0.4 && h.legstressdata.Position(2) < 0.4
        legstressdata.Location = 'SouthWest';
    elseif h.legstressdata.Position(1) > 0.4 && h.legstressdata.Position(2) < 0.4
        legstressdata.Location = 'SouthEast';
    end
    
    title([strrep(strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',' '), ' ',h.Sample.Materials.Name],'Fontsize', 11)
%     if valuecheckboxTauData == 0
    if strcmp(h.Diffsel,'LEDDI')
        if strcmp(h.Detsel,'Detector 1')
            % Save taudata to file
            FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_','Det1_stressplot_','%d'],j);
        elseif strcmp(h.Detsel,'Detector 2')
            FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_','Det2_stressplot_','%d'],j);
        end
    else
        % Save taudata to file
        FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_stressplot_','%d'],j);
    end

%     else
%         if strcmp(h.Diffsel,'LEDDI')
%             if strcmp(h.Detsel,'Detector 1')
%                 % Save taudata to file
%                 FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_','Det1_stressplot_tauzero_','%d','_',d],j);
%             elseif strcmp(h.Detsel,'Detector 2')
%                 FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_','Det2_stressplot_tauzero_','%d','_',d],j);
%             end
%         else
%             % Save taudata to file
%             FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_stressplot_tauzero_','%d','_',d],j);
%         end
% 
%     end
    print(fig,[Path,FileName],'-painters','-dtiff','-r300')
    print(fig,[Path,FileName],'-painters','-djpeg','-r600')

end

% Reset the button color
set(hObj,'str','Export stress plots','backg',col)

guidata(hObj, h);

%% Averaging of multiple hkl reflexes
function buttonaveraging(hObj, ~)
% Callback for deleting the user input for DEK values
h = guidata(hObj);

[sin2psiinterpol,daverage,derraverage,regressline,sigmaaverage,sigmaerraverage] = sin2psiAveraging(h);

% sigmaaverage
% sigmaerraverage

guidata(hObj, h);

%% Export modified evaluation data
function buttonSaveModPsiFile(hObj, ~, handles)
% Callback for saving modified psi file
h = guidata(hObj);

% Get value of checkbox "fit data from both detectors"
FitBothDet = get(h.checkboxFitBothDetectors,'value');

if ~isfield(h,'PathName')
    formatOut = 'ddmmyyyy';
    d = datestr(now, formatOut);
    name = strtrim(h.Measurement(1).MeasurementSeries);
    material = h.P.PopupValueMpd1;
    if strcmp(h.Diffsel,'LEDDI')
        h.PathName = [General.ProgramInfo.Path,'\Data\Results\LEDDI\',[name,'_',material,'_','added_plots','_',d]];
    elseif strcmp(h.Diffsel,'EDDI')
        h.PathName = [General.ProgramInfo.Path,'\Data\Results\EDDI\',[name,'_',material,'_','added_plots','_',d]];
    elseif strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
        h.PathName = [General.ProgramInfo.Path,'\Data\Results\MetalJet\',[name,'_',material,'_','added_plots','_',d]];    
    end
end

Folder = '\Psi_and_tau_File\';
Path = fullfile(h.PathName,Folder);
        
if exist(Path,'dir') ~= 7
    mkdir(Path);
end

if strcmp(h.Diffsel,'LEDDI') %&& FitBothDet == 0
    if strcmp(h.Detsel,'Detector 1') 
        [FileName,PathName] = uiputfile('*.psi','Save Psi file',[Path,...
                          strtrim(h.Measurement(1).MeasurementSeries),'_',h.Sample.Materials.Name,'_','Det1_corr','_',datestr(now, 'ddmmyyyy')]);
    elseif strcmp(h.Detsel,'Detector 2')
        [FileName,PathName] = uiputfile('*.psi','Save Psi file',[Path,...
                          strtrim(h.Measurement(1).MeasurementSeries),'_',h.Sample.Materials.Name,'_','Det2_corr','_',datestr(now, 'ddmmyyyy')]);
    end
else
    [FileName,PathName] = uiputfile('*.psi','Save Psi file',[Path,...
                          strtrim(h.Measurement(1).MeasurementSeries),'_',h.Sample.Materials.Name,'_corr','_',datestr(now, 'ddmmyyyy')]);
end

% If user pressed cancel, abort saving process
if FileName==0
  % user pressed cancel
  return
end

PsiFileName = fullfile(PathName, FileName);

% Get PsiDataTmp from DiffractionLines data
if h.P.PopupValueFitFunc == 2 || h.P.PopupValueFitFunc == 4 || h.P.PopupValueFitFunc == 5 %PV-Func %Gauss %Lorentz
    if h.P.DiffractometerType == 1 % EDDI
            PsiDataTmp = EDDIPsiDataPVSaveMod(h.DiffractionLines);
        elseif h.P.DiffractometerType == 2 % LEDDI
            if strcmp(h.Detsel,'Detector 1')
                PsiDataTmp = LEDDIPsiDataPVSaveMod(h.DiffractionLinesDet1);
            elseif strcmp(h.Detsel,'Detector 2')
                PsiDataTmp = LEDDIPsiDataPVSaveMod(h.DiffractionLinesDet2);
            end
        elseif h.P.DiffractometerType == 3 % LIMAX-160
            PsiDataTmp = LIMAX160PsiDataPVSaveMod(h.DiffractionLines);
        elseif h.P.DiffractometerType == 4 % LIMAX-70
            PsiDataTmp = LIMAX70PsiDataPVSaveMod(h.DiffractionLines);    
    end
elseif h.P.PopupValueFitFunc == 3 %TCH-Func
    if h.P.DiffractometerType == 1 % EDDI
            PsiDataTmp = EDDIPsiDataTCHSaveMod(h.DiffractionLines);
        elseif h.P.DiffractometerType == 2 % LEDDI
            if strcmp(h.Detsel,'Detector 1')
                PsiDataTmp = LEDDIPsiDataTCHSaveMod(h.DiffractionLinesDet1);
            elseif strcmp(h.Detsel,'Detector 2')
                PsiDataTmp = LEDDIPsiDataTCHSaveMod(h.DiffractionLinesDet2);
            end
        elseif h.P.DiffractometerType == 3 % LIMAX-160
            PsiDataTmp = LIMAX160PsiDataTCHSaveMod(h.DiffractionLines);
        elseif h.P.DiffractometerType == 4 % LIMAX-70
            PsiDataTmp = LIMAX160PsiDataTCHSaveMod(h.DiffractionLines);    
    end
end
% assignin('base','PsiDataTmp',PsiDataTmp)
% Get original psi angles
Psi = PsiDataTmp.psi(:,1);
% Create Vector with original psi values
PsiOrg = unique(Psi);

% Find missing psi values in modified ParamsToFit
for k = 1:size(h.ParamsToFit,2)
	for l = 1:size(h.ParamsToFit(k).Psi_Winkel,2)
		DeleteIdx{k,l} = ismember(PsiOrg, h.ParamsToFit(k).Psi_Winkel{l}, 'rows');
	end
end
% Create logical to delete lines from PsiFileTableData
for k = 1:size(DeleteIdx,2)
	DeleteLogicaltmp(:,k) = cell2mat([DeleteIdx(:,k)]);
end
% Reshape logical
DeleteLogical = reshape(DeleteLogicaltmp,numel(DeleteLogicaltmp),1);
% Delete corresponding lines from PsiFileTableData
if strcmp(h.Diffsel,'LEDDI') && FitBothDet == 0
    if strcmp(h.Detsel,'Detector 1')
%         if size(h.PsiFileTableDataDet1,1) == size(DeleteLogical,1)
            PsiFileTableData = h.PsiFileTableDataDet1Bkp;
            PsiFileTableData(~DeleteLogical,:)=[];
%         else
%             PsiFileTableData = h.PsiFileTableDataDet1;
%         end
        % Set table data
        set(h.tablepsifile,'data',PsiFileTableData);
    elseif strcmp(h.Detsel,'Detector 2')
%         if size(h.PsiFileTableDataDet2,1) == size(DeleteLogical,1)
            PsiFileTableData = h.PsiFileTableDataDet2Bkp;
            PsiFileTableData(~DeleteLogical,:)=[];
%         else
%             PsiFileTableData = h.PsiFileTableDataDet2;
%         end
        % Set table data
        set(h.tablepsifile,'data',PsiFileTableData);
    end
elseif strcmp(h.Diffsel,'LEDDI') && FitBothDet == 1
    if strcmp(h.Detsel,'Detector 1')
%         if size(h.PsiFileTableDataDet1,1) == size(DeleteLogical,1)
            PsiFileTableData = h.PsiFileTableDataDet1Bkp;
            PsiFileTableData(~DeleteLogical,:)=[];
%         else
%             PsiFileTableData = h.PsiFileTableDataDet1;
%         end
        % Set table data
        set(h.tablepsifile,'data',PsiFileTableData);
    elseif strcmp(h.Detsel,'Detector 2')
%         if size(h.PsiFileTableDataDet2,1) == size(DeleteLogical,1)
            PsiFileTableData = h.PsiFileTableDataDet2Bkp;
            PsiFileTableData(~DeleteLogical,:)=[];
%         else
%             PsiFileTableData = h.PsiFileTableDataDet2;
%         end
        % Set table data
        set(h.tablepsifile,'data',PsiFileTableData);
    end
elseif strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
%     if size(h.PsiFileTableData,1) == size(DeleteLogical,1)
%         PsiFileTableData = h.PsiFileTableData;
%         PsiFileTableData(~DeleteLogical,:)=[];
%     else
%         PsiFileTableData = h.PsiFileTableData;
        PsiFileTableData = h.PsiFileTableDataBkp;
        PsiFileTableData(~DeleteLogical,:)=[];
%     end
%     assignin('base','PsiFileTableData',h.PsiFileTableData)
    % Set table data
    set(h.tablepsifile,'data',PsiFileTableData);
end

% Convert cell to array (datestr converts to NaN)
PsiFileData = str2double(PsiFileTableData);
if h.P.PopupValueFitFunc == 2 || h.P.PopupValueFitFunc == 4 || h.P.PopupValueFitFunc == 5 %PV-Func %Gauss %Lorentz
    % Convert date string to date number
    for i = 1:size(PsiFileTableData,1)
        date(:,i) = datenum(PsiFileTableData{i,22},'dd-mm-yyyy-HH-MM-SS');
    end
    % Transpose date data
    date = date';
    % Add date data column to DiffractionLines array
    PsiFileData(:,22) = date;
elseif h.P.PopupValueFitFunc == 3 %TCH-Func
   % Convert date string to date number
    for i = 1:size(PsiFileTableData,1)
        date(:,i) = datenum(PsiFileTableData{i,25},'dd-mm-yyyy-HH-MM-SS');
    end
    % Transpose date data
    date = date';
    % Add date data column to DiffractionLines array
    PsiFileData(:,25) = date; 
end

SaveToPsiFileNew(PsiFileData,PsiFileName,FileName,h.P.PopupValueFitFunc)

% Messagebox
msgbox('Corrected Psi file created.');

guidata(hObj, h);

function buttonSaveModEvalData(hObj, ~, handles)
% Callback for saving evaluation data
h = guidata(hObj);

% Get value of checkbox "fit data from both detectors"
FitBothDet = get(h.checkboxFitBothDetectors,'value');

% Get PsiDataTmp from DiffractionLines data
if h.P.PopupValueFitFunc == 2 || h.P.PopupValueFitFunc == 4 || h.P.PopupValueFitFunc == 5 %PV-Func %Gauss %Lorentz
    if h.P.DiffractometerType == 1 % EDDI
            PsiDataTmp = EDDIPsiDataPVSaveMod(h.DiffractionLines);
%             assignin('base','PsiDataTmp',PsiDataTmp)
        elseif h.P.DiffractometerType == 2 % LEDDI
            if strcmp(h.Detsel,'Detector 1')
                PsiDataTmp = LEDDIPsiDataPVSaveMod(h.DiffractionLinesDet1);
            elseif strcmp(h.Detsel,'Detector 2')
                PsiDataTmp = LEDDIPsiDataPVSaveMod(h.DiffractionLinesDet2);
            end
        elseif h.P.DiffractometerType == 3 % LIMAX-160
            PsiDataTmp = LIMAX160PsiDataPVSaveMod(h.DiffractionLines);
        elseif h.P.DiffractometerType == 4 % LIMAX-70
            PsiDataTmp = LIMAX70PsiDataPVSaveMod(h.DiffractionLines);
%             assignin('base','PsiDataTmp',PsiDataTmp)
    end
elseif h.P.PopupValueFitFunc == 3 %TCH-Func
    if h.P.DiffractometerType == 1 % EDDI
            PsiDataTmp = EDDIPsiDataTCHSaveMod(h.DiffractionLines);
        elseif h.P.DiffractometerType == 2 % LEDDI
            if strcmp(h.Detsel,'Detector 1')
                PsiDataTmp = LEDDIPsiDataTCHSaveMod(h.DiffractionLinesDet1);
            elseif strcmp(h.Detsel,'Detector 2')
                PsiDataTmp = LEDDIPsiDataTCHSaveMod(h.DiffractionLinesDet2);
            end
        elseif h.P.DiffractometerType == 3 % LIMAX-160
            PsiDataTmp = LIMAX160PsiDataTCHSaveMod(h.DiffractionLines);
        elseif h.P.DiffractometerType == 4 % LIMAX-70
            PsiDataTmp = LIMAX70PsiDataTCHSaveMod(h.DiffractionLines);    
    end
end

% Get original psi angles
Psi = PsiDataTmp.psi(:,1);
% Create Vector with original psi values
PsiOrg = unique(Psi);
% PsiOrg = cellfun(@str2double,PsiFileTableDatatmp(:,8));
% assignin('base','PsiFileTableData',h.PsiFileTableData)
% assignin('base','PsiFileTableDatatmp',PsiFileTableDatatmp)
% assignin('base','PsiDataTmp',PsiDataTmp)
% Find missing psi values in modified ParamsToFit
for k = 1:size(h.ParamsToFit,2)
	for l = 1:size(h.ParamsToFit(k).Psi_Winkel,2)
		DeleteIdx{k,l} = ismember(PsiOrg, h.ParamsToFit(k).Psi_Winkel{l}, 'rows');
	end
end
% Create logical to delete lines from PsiFileTableData
for k = 1:size(DeleteIdx,2)
	DeleteLogicaltmp(:,k) = cell2mat([DeleteIdx(:,k)]);
end
% Reshape logical
DeleteLogical = reshape(DeleteLogicaltmp,numel(DeleteLogicaltmp),1);
% assignin('base','DeleteLogical',DeleteLogical)
% Delete corresponding lines from PsiFileTableData
if strcmp(h.Diffsel,'LEDDI') && FitBothDet == 0
    if strcmp(h.Detsel,'Detector 1')
%         if size(h.PsiFileTableDataDet1,1) == size(DeleteLogical,1)
            PsiFileTableData = h.PsiFileTableDataDet1Bkp;
            PsiFileTableData(~DeleteLogical,:)=[];
%         else
%             PsiFileTableData = h.PsiFileTableDataDet1;
%         end
        % Set table data
        set(h.tablepsifile,'data',PsiFileTableData);
    elseif strcmp(h.Detsel,'Detector 2')
%         if size(h.PsiFileTableDataDet2,1) == size(DeleteLogical,1)
            PsiFileTableData = h.PsiFileTableDataDet2Bkp;
            PsiFileTableData(~DeleteLogical,:)=[];
%         else
%             PsiFileTableData = h.PsiFileTableDataDet2;
%         end
        % Set table data
        set(h.tablepsifile,'data',PsiFileTableData);
    end
elseif strcmp(h.Diffsel,'LEDDI') && FitBothDet == 1
    if strcmp(h.Detsel,'Detector 1')
%         if size(h.PsiFileTableDataDet1,1) == size(DeleteLogical,1)
            PsiFileTableData = h.PsiFileTableDataDet1Bkp;
            PsiFileTableData(~DeleteLogical,:)=[];
%         else
%             PsiFileTableData = h.PsiFileTableDataDet1;
%         end
        % Set table data
        set(h.tablepsifile,'data',PsiFileTableData);
    elseif strcmp(h.Detsel,'Detector 2')
%         if size(h.PsiFileTableDataDet2,1) == size(DeleteLogical,1)
            PsiFileTableData = h.PsiFileTableDataDet2Bkp;
            PsiFileTableData(~DeleteLogical,:)=[];
%         else
%             PsiFileTableData = h.PsiFileTableDataDet2;
%         end
        % Set table data
        set(h.tablepsifile,'data',PsiFileTableData);
    end
elseif strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
%     if size(h.PsiFileTableData,1) == size(DeleteLogical,1)
%         PsiFileTableData = h.PsiFileTableData;
%         PsiFileTableData(~DeleteLogical,:)=[];
%     else
%         PsiFileTableData = h.PsiFileTableData;
        PsiFileTableData = h.PsiFileTableDataBkp;
        PsiFileTableData(~DeleteLogical,:)=[];
%     end
%     assignin('base','PsiFileTableData',h.PsiFileTableData)
    % Set table data
    set(h.tablepsifile,'data',PsiFileTableData);
end

[filename, filepath] = uiputfile('*.mat','Save GUIData',[General.ProgramInfo.Path,'\Data\GUIData\',...
                      strtrim(h.Measurement(1).MeasurementSeries),'_',h.Sample.Materials.Name,'_corr','_',datestr(now, 'ddmmyyyy')]);

                  
% If user pressed cancel, abort saving process
if filename==0
  % user pressed cancel
  return
end
                  
% Create Sample fields
s.CreateSampleMat = get(h.editfieldelement1,'String');
s.CreateSampleMPD = get(h.popupmenumpd1,'Value');
s.CreateSampleMPDFileName = h.P.MPDFileName;
% Create Substrate fields
s.CreateSampleSubchkbx = get(h.checkboxsubstrate1,'Value');
s.CreateSampleSubMat = get(h.editfieldelement2,'String');
s.CreateSampleSubMPD = get(h.popupmenumpd2,'Value');
s.CreateSampleSubMPDFileName = h.P.SusbtrateMPDFileName;
% Create Load measurement fields
s.MeasFileName = get(h.selectfilename,'String');
s.MeasDiffTypeVal = get(h.popupmenudiff,'Value');
s.MeasDiffTypeName = h.Diffsel;
s.MeasScanMode = get(h.popupmenuscanmode,'Value');
s.MeasDTCorr = get(h.popupmenuDTCorr,'Value');
% Create Corrections fields
s.CorrWiggler = get(h.checkboxcorrections1,'Value');
s.CorrAbsorption = get(h.checkboxcorrections2,'Value');
s.CorrRingCurrent = get(h.checkboxcorrections3,'Value');
s.CorrMeasMode = get(h.popupmenumeasmode,'Value');
s.CorrSampleThickness = get(h.samplethickness,'String');
% Create Select Measurement fields
s.SelMeasDetLEDDIVal = get(h.popupmenuselectmeas1,'Value');
s.SelMeasDetLEDDIName = h.Detsel;

s.measmode = h.measmode;
s.Diffsel = h.Diffsel;
s.Detsel = h.Detsel;

if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    s.SelMeasE1 = h.P.EnergyRange(1);
    s.SelMeasE2 = h.P.EnergyRange(2);
    s.EnergyRange = h.EnergyRange;
elseif strcmp(h.Diffsel,'LEDDI')
    if isfield(h, 'EnergyRangeDet1')
        s.SelMeasE1Det1 = h.P.EnergyRangeDet1(1);
        s.SelMeasE2Det1 = h.P.EnergyRangeDet1(2);
        s.EnergyRangeDet1 = h.EnergyRangeDet1;
    end
    
    if isfield(h, 'EnergyRangeDet2')
        s.SelMeasE1Det2 = h.P.EnergyRangeDet2(1);
        s.SelMeasE2Det2 = h.P.EnergyRangeDet2(2);
        s.EnergyRangeDet2 = h.EnergyRangeDet2;
    end  
end
% Create Background correction fields
if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    s.PeakRegionsX = h.PeakRegionsX;
    s.PeakRegionsXdata = h.PeakRegionsXdata;
    s.PeakRegionsYdata = h.PeakRegionsYdata;
elseif strcmp(h.Diffsel,'LEDDI')
    if isfield(h, 'PeakRegionsXDet1')
        s.PeakRegionsXDet1 = h.PeakRegionsXDet1;
        s.PeakRegionsXdataDet1 = h.PeakRegionsXdataDet1;
        s.PeakRegionsYdataDet1 = h.PeakRegionsYdataDet1;
    end
    
    if isfield(h, 'PeakRegionsXDet2')
        s.PeakRegionsXDet2 = h.PeakRegionsXDet2;
        s.PeakRegionsXdataDet2 = h.PeakRegionsXdataDet2;
        s.PeakRegionsYdataDet2 = h.PeakRegionsYdataDet2;
    end
end
s.CheckBoxUseAllSpectra = get(h.checkboxBKG,'Value');
% Create Fitting fields
if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    s.TPeaks = h.TPeaks;
    s.Peaks = h.Peaks;
    s.Peakslb = h.Peakslb;
    s.Peaksub = h.Peaksub;
    s.xDataTmpCalc = h.xDataTmpCalc;
    s.FittedPeaks = h.FittedPeaks;
    s.FittedPeaksCalctmp =  h.FittedPeaksCalctmp;
    s.XFit = h.XFit;
    s.YFit = h.YFit;
    s.XPlot = h.XPlot;
    s.YPlot = h.YPlot;
    s.SE = h.SE;
    s.CI = h.CI;
elseif strcmp(h.Diffsel,'LEDDI')
    if isfield(h, 'PeaksDet1')
        s.TPeaksDet1 = h.TPeaksDet1;
        s.PeaksDet1 = h.PeaksDet1;
        s.Peakslb = h.Peakslb;
        s.Peaksub = h.Peaksub;
        s.xDataTmpCalcDet1 = h.xDataTmpCalcDet1;
        s.FittedPeaksDet1 = h.FittedPeaksDet1;
        s.FittedPeaksCalctmpDet1 =  h.FittedPeaksCalctmpDet1;
        s.XFitDet1 = h.XFitDet1;
        s.YFitDet1 = h.YFitDet1;
        s.XPlotDet1 = h.XPlotDet1;
        s.YPlotDet1 = h.YPlotDet1;
        s.SEDet1 = h.SEDet1;
        s.CIDet1 = h.CIDet1;
    end
    
    if isfield(h, 'PeaksDet2')
        s.TPeaksDet2 = h.TPeaksDet2;
        s.PeaksDet2 = h.PeaksDet2;
        s.Peakslb = h.Peakslb;
        s.Peaksub = h.Peaksub;
        s.xDataTmpCalcDet2 = h.xDataTmpCalcDet2;
        s.FittedPeaksDet2 = h.FittedPeaksDet2;
        s.FittedPeaksCalctmpDet2 =  h.FittedPeaksCalctmpDet2;
        s.XFitDet2 = h.XFitDet2;
        s.YFitDet2 = h.YFitDet2;
        s.XPlotDet2 = h.XPlotDet2;
        s.YPlotDet2 = h.YPlotDet2;
        s.SEDet2 = h.SEDet2;
        s.CIDet2 = h.CIDet2;
    end
end

s.PopupValueFitFunc = h.P.PopupValueFitFunc;
s.checkboxFitBothDetectors = get(h.checkboxFitBothDetectors,'Value');
s.checkboxexportfits = get(h.checkboxexportfits,'Value');
% Create fit results table field
s.tablefitresults = get(h.tablefitresults,'data');
% Create Psi File panel fields
s.checkboxcreatepsi1 = get(h.checkboxcreatepsi1,'Value');
s.editfieldcreatepsi1 = get(h.editfieldcreatepsi1,'String');
s.editfieldcreatepsi2 = get(h.editfieldcreatepsi2,'String');
s.editfieldcreatepsi3 = get(h.editfieldcreatepsi3,'String');
s.editfieldcreatepsi4 = get(h.editfieldcreatepsi4,'String');
s.editfieldcreatepsi5 = get(h.editfieldcreatepsi5,'String');
s.editfieldcreatepsi6 = get(h.editfieldcreatepsi6,'String');
s.editfieldcreatepsi7 = get(h.editfieldcreatepsi7,'String');
s.checkboxEditTableData = get(h.checkboxEditTableData,'Value');
s.MinVal = h.MinVal;
if isfield(h, 'idxSelectPeaktable')
    s.idxSelectPeaktable = h.idxSelectPeaktable;
end
if isfield(h, 'idxkeepPeaks')
    s.idxkeepPeaks = h.idxkeepPeaks;
end
s.DeleteLogical = DeleteLogical;

if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    s.DiffractionLines = h.DiffractionLines;
    if isfield(h,'FittedPeaksbkp')
        s.FittedPeaksbkp = h.FittedPeaksbkp;
    end
    PsiFileTableData = h.PsiFileTableDataBkp;
    PsiFileTableData(~DeleteLogical,:)=[];
    s.PsiFileTableData = PsiFileTableData;
    s.PsiFileTableDataBkp = h.PsiFileTableDataBkp;
    s.Psidata = h.Psidata;
elseif strcmp(h.Diffsel,'LEDDI')
    if isfield(h, 'PeaksDet1')
        s.DiffractionLinesDet1 = h.DiffractionLinesDet1;
        if isfield(h,'FittedPeaksDet1bkp')
            s.FittedPeaksbkpDet1 = h.FittedPeaksbkpDet1;
        end
        PsiFileTableData = h.PsiFileTableDataDet1Bkp;
        PsiFileTableData(~DeleteLogical,:)=[];
        s.PsiFileTableDataDet1 = PsiFileTableData;
        s.PsiFileTableDataDet1Bkp = h.PsiFileTableDataDet1Bkp;
        s.PsidataDet1 = h.PsidataDet1;
    end
    
    if isfield(h, 'PeaksDet2')
        s.DiffractionLinesDet2 = h.DiffractionLinesDet2;
        if isfield(h,'FittedPeaksDet2bkp')
            s.FittedPeaksbkpDet2 = h.FittedPeaksbkpDet2;
        end
        PsiFileTableData = h.PsiFileTableDataDet2Bkp;
        PsiFileTableData(~DeleteLogical,:)=[];
        s.PsiFileTableDataDet2 = PsiFileTableData;
        s.PsiFileTableDataDet2Bkp = h.PsiFileTableDataDet2Bkp;
        s.PsidataDet2 = h.PsidataDet2;
    end
end

% Create Theoretical peak pos fields
if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    s.tablephasehkl = h.tablephasehkl;
elseif strcmp(h.Diffsel,'LEDDI')
    if isfield(h, 'PeakRegionsXDet1')
        s.PeakRegionsXDet1 = h.PeakRegionsXDet1;
        s.tablephasehklDet1 = h.tablephasehkl;
    end
    
    if isfield(h, 'PeakRegionsXDet2')
        s.PeakRegionsXDet2 = h.PeakRegionsXDet2;
        s.tablephasehklDet2 = h.tablephasehkl;
    end
end

s.Measurement = h.Measurement;
% s.MeasurementBackup = h.MeasurementBackup;
s.DataTmp = h.DataTmp;
s.Sample = h.Sample;
s.Diffractometer = h.Diffractometer;
s.T = h.T;
s.P = h.P;
s.DataTmpBackup = h.DataTmpBackup;

% assignin('base','smod',s)

% Message box
msgbox('Fitting data saved.');

save(fullfile(filepath, filename), 's');

%% Options panel
function ClearGUIButton(hObj, ~)
% Callback for deleting user input 
h = guidata(hObj);

% Set and delete variables in GUI data
h.Sample = 0;
h.Measurement = 0;
h.MeasurementBackup = 0;
h.Substrate = 0;
h.Diffractometer = 0;
h.DataTmp = 0;
h.DataTmpBackup = 0;
h.T = 0;
h.P.SampleThickness = 0;
h.P.PopupValueMpd1 = 0;
h.P.PopupValueMpd2 = 0;
h.P.PopupValueMpd3 = 0;
h.P.PopupValueMpd4 = 0;
h.P.PopupValueMpd5 = 0;
h.P.PopupValueMpd6 = 0;
h.P.PopupValueFitFunc = 2;

% Set Create Sample fields
set(h.editfieldelement1,{'String','Enable'},{'Enter elemental formula', 'inactive'})
set(h.popupmenumpd1,{'Value','String'}, {1, h.MPDFileNameList})
set(h.checkboxsubstrate1,'Value', 0)
set(h.editfieldelement2,{'String','Enable'},{'Enter elemental formula', 'inactive'})
set(h.popupmenumpd2,{'Value','String'}, {1, h.MPDFileNameList})
% Set load Measurement file fields
set(h.selectfilename,'String','Select measurement file...')
set(h.popupmenudiff,'Value', 4)
set(h.popupmenuscanmode,'Value', 2)
set(h.popupmenuDTCorr,'Value', 17)
% Set corrections fields
set(h.checkboxcorrections1,'Value', 0)
set(h.checkboxcorrections2,'Value', 1)
set(h.checkboxcorrections3,'Value', 0)
set(h.popupmenumeasmode,'Value', 2)
set(h.samplethickness,'String','Sample thickness [mm]')
% Set plot window fields
set(h.Slider,{'Value','Min','Max'}, {1,0,1})
set(h.plotdata,{'xdata','ydata'},{0 0})
set(h.plotdataZoom,{'xdata','ydata'},{0 0})
set(h.plotdataZoomCH,{'xdata','ydata'},{0 0})
set(h.plotEtheo,{'xdata','ydata'},{0 0})
set(h.plotEtheoSub,{'xdata','ydata'},{0 0})
set(h.plotEtheoAdd1, {'xdata','ydata'},{0 0})
set(h.plotEtheoAdd2, {'xdata','ydata'},{0 0})
set(h.plotEtheoAdd3, {'xdata','ydata'},{0 0})
set(h.plotEtheoAdd4, {'xdata','ydata'},{0 0})
set(h.plotEtheoAdd5, {'xdata','ydata'},{0 0})
set(h.axesplotRawData.Title,'String','No measurement data loaded')
h.axesplotRawData.XLim = [0,100];
h.axesplotRawData.YLim = [0,1];
set(h.checkboxtheopeaks1,{'Value','Visible'}, {1,'off'})
set(h.checkboxshifttheopeaks1,{'Value','Visible'}, {0,'off'})
set(h.editshiftEtheo1,{'String','Visible'}, {'delta E','off'})
set(h.plusbuttonshiftEtheo1,'Visible', 'off')
set(h.minusbuttonshiftEtheo1,'Visible', 'off')
set(h.checkboxtheopeaks2,{'Value','Visible'}, {1,'off'})
set(h.checkboxshifttheopeaks2,{'Value','Visible'}, {0,'off'})
set(h.editshiftEtheo2,{'String','Visible'}, {'delta E','off'})
set(h.plusbuttonshiftEtheo2,'Visible', 'off')
set(h.minusbuttonshiftEtheo2,'Visible', 'off')
% Set Select Measurement fields
set(h.popupmenuselectmeas1,{'Value','Enable'}, {2,'off'})
set(h.editfieldselectmeas1,'String','')
set(h.editfieldselectmeas2,'String','')
set(h.editfieldselectmeas3,'String','')
set(h.editfieldselectmeas4,'String','Emin')
set(h.editfieldselectmeas5,'String','Emax')
set(h.checkboxselectmeas1,'Value',0)
set(h.checkboxselectmeas2,'Value',0)
% Set Background Correction fields
set(h.tablebkgdata,'data', [zeros(1,6);zeros(1,6)])
set(h.checkboxBKG,'Value', 0)
if isfield(h,'plotbkgpoints')
    set(h.plotbkgpoints,'Visible','off')
end
if isfield(h,'plotBKG')
    set(h.plotBKG,'Visible','off')
end
% Set Define Peak fields
set(h.tablepeakdata,'data', [zeros(1,6);0.3.*ones(1,6);0.3.*ones(1,6)])
set(h.checkboxexportfits,'Value', 1)
if isfield(h,'plotpeakpoints')
    set(h.plotpeakpoints,'Visible','off')
end
set(h.popupmenuFitFunc,'Value', 2)
set(h.checkboxFitBothDetectors,'Value', 0)
% Set Fit results fields
set(h.tablefitresults,'data', zeros(10,7))
% Set Create Psi File fields
set(h.checkboxcreatepsi1,'Value', 0)
set(h.editfieldcreatepsi1,'String','0.015')
set(h.editfieldcreatepsi2,'String','100')
set(h.editfieldcreatepsi3,'String','0.05')
set(h.editfieldcreatepsi4,'String','2')
set(h.editfieldcreatepsi5,'String','0.4')
set(h.editfieldcreatepsi6,'String','all')
set(h.editfieldcreatepsi6,'String','all')
set(h.checkboxEditTableData,'Value', 0)
set(h.tablepsifile,'data', zeros(13,23))
% Set theoretical peak positions table data
% set(h.tablephasehkl,'data', zeros(12,5))
set(h.tablephasehkl,'data',[num2cell(zeros(12,5)) num2cell(false(12,1))])
set(h.tablephasehkl,'BackgroundColor',ones(12,3))
set(h.tablephasehkl2,'data', zeros(10,5))
set(h.texteditfieldEtheo,'String','Enter elemental formula')
set(h.popupmenumpdEtheo,'Value',1)
% Set Stress analysis fields
set(h.checkboxphi0,'Value', 0)
set(h.checkboxphi90,'Value', 0)
set(h.checkboxphi180,'Value', 0)
set(h.checkboxphi270,'Value', 0)
set(h.SliderStressData,{'Value','Min','Max'}, {1,0,1})
% Set plot properties
h.axesplotdspacing.XLim = [0,1];
h.axesplotdspacing.YLim = [0,1];
h.legdspacing.Visible = 'off';
h.axesplotIB.XLim = [0,1];
h.axesplotIB.YLim = [0,1];
h.legIB.Visible = 'off';
h.axesplotInt.XLim = [0,1];
h.axesplotInt.YLim = [0,1];
h.legInt.Visible = 'off';

title(h.axesplotdspacing,'No measurement data loaded')
title(h.axesplotIB,'No measurement data loaded')
title(h.axesplotInt,'No measurement data loaded')
    
set(h.plotdatadspacingphi0,{'xdata','ydata','YNegativeDelta','YPositiveDelta','Visible'},{0,0,0,0,'off'})
set(h.plotreglinedspacingphi0,{'xdata','ydata','Visible'},{0,0,'off'})
set(h.plotdatadspacingphi90,{'xdata','ydata','YNegativeDelta','YPositiveDelta','Visible'},{0,0,0,0,'off'})
set(h.plotreglinedspacingphi90,{'xdata','ydata','Visible'},{0,0,'off'})
set(h.plotdatadspacingphi180,{'xdata','ydata','YNegativeDelta','YPositiveDelta','Visible'},{0,0,0,0,'off'})
set(h.plotreglinedspacingphi180,{'xdata','ydata','Visible'},{0,0,'off'})
set(h.plotdatadspacingphi270,{'xdata','ydata','YNegativeDelta','YPositiveDelta','Visible'},{0,0,0,0,'off'})
set(h.plotreglinedspacingphi270,{'xdata','ydata','Visible'},{0,0,'off'})

if isfield(h,'plotfits')
    set(h.plotfits,{'xdata','ydata','Visible'},{0,0,'off'})
    set(h.plotfitresidual,{'xdata','ydata','Visible'},{0,0,'off'})
end

set(h.plotdataIBphi0,{'xdata','ydata','Visible'},{0,0,'off'})
set(h.plotdataIBphi90,{'xdata','ydata','Visible'},{0,0,'off'})
set(h.plotdataIBphi180,{'xdata','ydata','Visible'},{0,0,'off'})
set(h.plotdataIBphi270,{'xdata','ydata','Visible'},{0,0,'off'})

set(h.plotdataIntphi0,{'xdata','ydata','Visible'},{0,0,'off'})
set(h.plotdataIntphi90,{'xdata','ydata','Visible'},{0,0,'off'})
set(h.plotdataIntphi180,{'xdata','ydata','Visible'},{0,0,'off'})
set(h.plotdataIntphi270,{'xdata','ydata','Visible'},{0,0,'off'})

set(h.SliderPlotStressData,{'Value','Min','Max'}, {1,0,1})
set(h.plotstressdata,{'xdata','ydata','YNegativeDelta','YPositiveDelta','Visible'},{0,0,0,0,'off'})
delete(findobj(h.axesplotstressdata, 'type', 'scatter', 'visible', 'on'))
h.legstressdata.Visible = 'off';
h.axesplotstressdata.XLim = [0,1];
h.axesplotstressdata.YLim = [0,1];
title(h.axesplotstressdata,'No measurement data loaded')

set(h.SliderFitData,{'Value','Min','Max'}, {1,0,1})
set(h.plotrawdata1,{'xdata','ydata','Visible'},{0,0,'off'})
set(h.plotfitdata1,{'xdata','ydata','Visible'},{0,0,'off'})
set(h.plotresiualdata1,{'xdata','ydata','Visible'},{0,0,'off'})
title(h.axesplotfitdata,'No measurement data loaded')

if isfield(h,'ptext')
    delete(h.ptext)
end

% Set default values for calibration panel
d = zeros(7,5);
set(h.tablecalibangEpos1,'data',d)
set(h.texteditfieldcalibangEpos1,'String','Lattice parameter')
set(h.texteditfieldcalibangEpos2,'String','twotheta')
set(h.texteditfieldcalibangEpos3,'String','deltaE')
set(h.checkboxcalibangEpos1,'value',1)
set(h.checkboxcalibangEpos2,'value',1)
set(h.checkboxcalibangEpos3,'value',1)

% Set plot properties
xlabel(h.axesplotfitdata1,'Choose Data')
ylabel(h.axesplotfitdata1,'Choose Data')
title(h.axesplotfitdata1,{'No measurement data loaded';'   '})
h.axesplotfitdata1.XLim = [0,1];
h.axesplotfitdata1.YLim = [0,1];
h.axesplotfitdata1.YTickMode = 'auto';
h.axesplotfitdata1.YAxis.TickLabelFormat = ' %.1f ';
set(h.popupmenuXData1,'Value',1)
set(h.popupmenuYData1,'Value',1)
set(h.plotwindowfitdata1checkboxphi0,{'Value','Enable'},{0,'on'})
set(h.plotwindowfitdata1checkboxphi90,{'Value','Enable'},{0,'on'})
set(h.plotwindowfitdata1checkboxphi180,{'Value','Enable'},{0,'on'})
set(h.plotwindowfitdata1checkboxphi270,{'Value','Enable'},{0,'on'})

% Set plot properties
xlabel(h.axesplotfitdata2,'Choose Data')
ylabel(h.axesplotfitdata2,'Choose Data')
title(h.axesplotfitdata2,{'No measurement data loaded';'   '})
h.axesplotfitdata2.XLim = [0,1];
h.axesplotfitdata2.YLim = [0,1];
h.axesplotfitdata2.YTickMode = 'auto';
h.axesplotfitdata2.YAxis.TickLabelFormat = ' %.1f ';
set(h.popupmenuXData2,'Value',1)
set(h.popupmenuYData2,'Value',1)
set(h.plotwindowfitdata2checkboxphi0,{'Value','Enable'},{0,'on'})
set(h.plotwindowfitdata2checkboxphi90,{'Value','Enable'},{0,'on'})
set(h.plotwindowfitdata2checkboxphi180,{'Value','Enable'},{0,'on'})
set(h.plotwindowfitdata2checkboxphi270,{'Value','Enable'},{0,'on'})

% Set plot properties
xlabel(h.axesplotfitdata3,'Choose Data')
ylabel(h.axesplotfitdata3,'Choose Data')
title(h.axesplotfitdata3,{'No measurement data loaded';'   '})
h.axesplotfitdata3.XLim = [0,1];
h.axesplotfitdata3.YLim = [0,1];
h.axesplotfitdata3.YTickMode = 'auto';
h.axesplotfitdata3.YAxis.TickLabelFormat = ' %.1f ';
set(h.popupmenuXData3,'Value',1)
set(h.popupmenuYData3,'Value',1)
set(h.plotwindowfitdata3checkboxphi0,{'Value','Enable'},{0,'on'})
set(h.plotwindowfitdata3checkboxphi90,{'Value','Enable'},{0,'on'})
set(h.plotwindowfitdata3checkboxphi180,{'Value','Enable'},{0,'on'})
set(h.plotwindowfitdata3checkboxphi270,{'Value','Enable'},{0,'on'})

% Set plot properties
xlabel(h.axesplotfitdata4,'Choose Data')
ylabel(h.axesplotfitdata4,'Choose Data')
title(h.axesplotfitdata4,{'No measurement data loaded';'   '})
h.axesplotfitdata4.XLim = [0,1];
h.axesplotfitdata4.YLim = [0,1];
h.axesplotfitdata4.YTickMode = 'auto';
h.axesplotfitdata4.YAxis.TickLabelFormat = ' %.1f ';
set(h.popupmenuXData4,'Value',1)
set(h.popupmenuYData4,'Value',1)
set(h.plotwindowfitdata4checkboxphi0,{'Value','Enable'},{0,'on'})
set(h.plotwindowfitdata4checkboxphi90,{'Value','Enable'},{0,'on'})
set(h.plotwindowfitdata4checkboxphi180,{'Value','Enable'},{0,'on'})
set(h.plotwindowfitdata4checkboxphi270,{'Value','Enable'},{0,'on'})

% Set plots invisible 
set(h.fitdata1plotphi0,{'Visible'},{'off'})
set(h.fitdata1plotphi90,{'Visible'},{'off'})
set(h.fitdata1plotphi180,{'Visible'},{'off'})
set(h.fitdata1plotphi270,{'Visible'},{'off'})
set(h.fitdata1ploterrphi0,{'Visible'},{'off'})
set(h.fitdata1ploterrphi90,{'Visible'},{'off'})
set(h.fitdata1ploterrphi180,{'Visible'},{'off'})
set(h.fitdata1ploterrphi270,{'Visible'},{'off'})

set(h.fitdata2plotphi0,{'Visible'},{'off'})
set(h.fitdata2plotphi90,{'Visible'},{'off'})
set(h.fitdata2plotphi180,{'Visible'},{'off'})
set(h.fitdata2plotphi270,{'Visible'},{'off'})
set(h.fitdata2ploterrphi0,{'Visible'},{'off'})
set(h.fitdata2ploterrphi90,{'Visible'},{'off'})
set(h.fitdata2ploterrphi180,{'Visible'},{'off'})
set(h.fitdata2ploterrphi270,{'Visible'},{'off'})

set(h.fitdata3plotphi0,{'Visible'},{'off'})
set(h.fitdata3plotphi90,{'Visible'},{'off'})
set(h.fitdata3plotphi180,{'Visible'},{'off'})
set(h.fitdata3plotphi270,{'Visible'},{'off'})
set(h.fitdata3ploterrphi0,{'Visible'},{'off'})
set(h.fitdata3ploterrphi90,{'Visible'},{'off'})
set(h.fitdata3ploterrphi180,{'Visible'},{'off'})
set(h.fitdata3ploterrphi270,{'Visible'},{'off'})

set(h.fitdata4plotphi0,{'Visible'},{'off'})
set(h.fitdata4plotphi90,{'Visible'},{'off'})
set(h.fitdata4plotphi180,{'Visible'},{'off'})
set(h.fitdata4plotphi270,{'Visible'},{'off'})
set(h.fitdata4ploterrphi0,{'Visible'},{'off'})
set(h.fitdata4ploterrphi90,{'Visible'},{'off'})
set(h.fitdata4ploterrphi180,{'Visible'},{'off'})
set(h.fitdata4ploterrphi270,{'Visible'},{'off'})

% Set legend off
if isfield(h,'legendplotfitdata1')
    set(h.legendplotfitdata1,'Visible','off')
end
if isfield(h,'legendplotfitdata2')
    set(h.legendplotfitdata2,'Visible','off')
end
if isfield(h,'legendplotfitdata3')
    set(h.legendplotfitdata3,'Visible','off')
end
if isfield(h,'legendplotfitdata4')
    set(h.legendplotfitdata4,'Visible','off')
end


% Remove all fields from structure not needed
% tokeep = {'myfig';'TabGroup';'Tabs';'MPDFileNameList';'FluorCellArray';'ElementsString';'Tolerance';'Colors';'T';'Sample';'Measurement';'Substrate';'Diffractometer';'DataTmp';'P';'creatsamplepanel';'textelement1';'editfieldelement1';'textmpd1';'popupmenumpd1';'checkboxsubstrate1';'editfieldelement2';'textmpd2';'popupmenumpd2';'okbutton1';'loadmeasurementpanel';'selectfilename';'openbutton1';'popupmenudiff';'popupmenuscanmode';'popupmenuDTCorr';'correctionspanel';'textcorr1';'checkboxcorrections1';'checkboxcorrections2';'checkboxcorrections3';'textcorr2';'popupmenumeasmode';'samplethickness';'checkboxcorrectionsExportData';'plotpanel';'Slider';'axesplotRawData';'plotdata';'plotEtheo';'plotEtheoAdd1';'plotEtheoAdd2';'plotEtheoAdd3';'plotEtheoAdd4';'plotEtheoAdd5';'plotEtheoSub';'plotFluorAdd1';'axesplotRawDataZoom';'plotdataZoom';'plotdataZoomCH';'checkboxtheopeaks1';'checkboxshifttheopeaks1';'editshiftEtheo1';'plusbuttonshiftEtheo1';'minusbuttonshiftEtheo1';'checkboxtheopeaks2';'checkboxshifttheopeaks2';'editshiftEtheo2';'plusbuttonshiftEtheo2';'minusbuttonshiftEtheo2';'checkboxplotall';'buttonexchangespectra';'selectmeasurementpanel';'textselectmeas1';'popupmenuselectmeas1';'textselectmeas2';'editfieldselectmeas1';'textselectmeas3';'editfieldselectmeas2';'textselectmeas4';'editfieldselectmeas3';'textselectmeas5';'editfieldselectmeas4';'textselectmeas6';'editfieldselectmeas5';'checkboxselectmeas1';'textselectmeas7';'textselectmeas8';'editfieldselectmeas6';'textselectmeas9';'checkboxselectmeas2';'okbuttonselectmeas1';'undobuttonselectmeas1';'backgroundpanel';'textbkg1';'buttonselectbkg1';'buttonselectbkg2';'buttonselectbkg3';'buttonselectbkg7';'buttonselectbkg4';'buttonselectbkg5';'buttonselectbkg6';'buttonselectbkg8';'textbkg2';'tablebkgdata';'checkboxBKG';'fittingpanel';'textpeak1';'buttonselectpeak1';'buttonselectpeak2';'buttonselectpeak3';'buttonselectpeak4';'checkboxexportfits';'textFitFunc';'popupmenuFitFunc';'checkboxFitBothDetectors';'textpeak2';'textpeak3';'textpeak4';'tablepeakdata';'fitresultspanel';'tablefitresults';'createpsifilepanel';'checkboxcreatepsi1';'textcreatepsi2';'editfieldcreatepsi1';'textcreatepsi3';'editfieldcreatepsi2';'textcreatepsi4';'editfieldcreatepsi3';'textcreatepsi5';'editfieldcreatepsi4';'textcreatepsi6';'editfieldcreatepsi5';'textcreatepsi7';'editfieldcreatepsi6';'textcreatepsi8';'editfieldcreatepsi7';'buttoncreatepsi1';'buttoncreatepsi3';'checkboxEditTableData';'tablepsifile';'optionspanel';'buttonoptions1';'buttonoptions2';'buttonoptions3';'buttonoptions4';'calibangEpospanel';'TabGroupCalib';'TabCalib';'textcalibangEpos1';'buttoncalibangEpos1';'buttoncalibangEpos2';'buttoncalibangEpos3';'textcalibangEpos2';'tablecalibangEpos1';'textcalibangEpos3';'texteditfieldcalibangEpos1';'textcalibangEpos4';'texteditfieldcalibangEpos2';'checkboxcalibangEpos1';'textcalibangEpos5';'texteditfieldcalibangEpos3';'checkboxcalibangEpos2';'checkboxcalibangEpos3';'textcalibangEpos6';'buttoncalibangEpos4';'buttoncalibangEpos5';'checkboxcorrEpos1';'tablehklpanel';'texthkltable1';'tablephasehkl';'texthkltable2';'tablephasehkl2';'textelementEtheo';'texteditfieldEtheo';'textmpdEtheo';'popupmenumpdEtheo';'buttonShowEtheoPeaks';'buttonHideEtheoPeaks';'textelementLine';'textelementFluorescence';'textdataFluorescence';'popupmenudataFluorescence';'buttonShowFluorescencePeaks';'buttonHideFluorescencePeaks';'buttonloadDEK1';'buttonloadstressdata1';'textazimuth';'checkboxphi0';'checkboxphi90';'checkboxphi180';'checkboxphi270';'buttonmodifystressdata1';'buttonexportplots1';'buttonexportplots2';'buttonSaveModPsiFile';'buttonSaveModEvalData';'SliderStressData';'Colors2';'axesplotdspacing';'axesplotIB';'axesplotInt';'plotdatadspacingphi0';'plotreglinedspacingphi0';'plotdatadspacingphi90';'plotreglinedspacingphi90';'plotdatadspacingphi180';'plotreglinedspacingphi180';'plotdatadspacingphi270';'plotreglinedspacingphi270';'plotdataIBphi0';'plotdataIBphi90';'plotdataIBphi180';'plotdataIBphi270';'plotdataIntphi0';'plotdataIntphi90';'plotdataIntphi180';'plotdataIntphi270';'plotstresspanel';'SliderPlotStressData';'axesplotstressdata';'plotstressdata';'fitdatapanel';'SliderFitData';'axesplotfitdata';'plotrawdata1';'plotfitdata1';'plotresiualdata1';'modstressXlimbutton';'Xlimfig';'XlimMaxname';'XlimMaxname1';'editXlimMin';'XlimMinname';'XlimMinname1';'editXlimMax';'XlimTickname';'XlimTickname1';'editXlimTick';'AcceptXEditButton';'CancelXEditButton';'modstressYlimbutton';'Ylimfig';'YlimMaxname';'YlimMaxname1';'editYlimMax';'YlimMinname';'YlimMinname1';'editYlimMin';'YlimTickname';'YlimTickname1';'editYlimTick';'AcceptYEditButton';'CancelYEditButton';'figDEKtable';'panelDEKtable';'buttonDEKtable1';'buttonDEKtable2';'buttonDEKtable3';'buttonDEKtable4';'loadDEKtable';'figSelectPeaktable';'panelSelectPeaktable';'buttonSelectPeaktable1';'buttonSelectPeaktable2';'SelectPeaktable';'plotwindowfitdata1';'Sliderplotwindowfitdata1';'axesplotfitdata1';'fitdata1plotphi0';'fitdata1plotphi90';'fitdata1plotphi180';'fitdata1plotphi270';'fitdata1ploterrphi0';'fitdata1ploterrphi90';'fitdata1ploterrphi180';'fitdata1ploterrphi270';'TextPlotData1';'TextXData1';'popupmenuXData1';'TextYData1';'popupmenuYData1';'buttonExportFitData1';'buttonClearFitData1';'TextPhiData1';'plotwindowfitdata1checkboxphi0';'plotwindowfitdata1checkboxphi90';'plotwindowfitdata1checkboxphi180';'plotwindowfitdata1checkboxphi270';'plotwindowfitdata2';'Sliderplotwindowfitdata2';'axesplotfitdata2';'fitdata2plotphi0';'fitdata2plotphi90';'fitdata2plotphi180';'fitdata2plotphi270';'fitdata2ploterrphi0';'fitdata2ploterrphi90';'fitdata2ploterrphi180';'fitdata2ploterrphi270';'TextPlotData2';'TextXData2';'popupmenuXData2';'TextYData2';'popupmenuYData2';'buttonExportFitData2';'buttonClearFitData2';'TextPhiData2';'plotwindowfitdata2checkboxphi0';'plotwindowfitdata2checkboxphi90';'plotwindowfitdata2checkboxphi180';'plotwindowfitdata2checkboxphi270';'plotwindowfitdata3';'Sliderplotwindowfitdata3';'axesplotfitdata3';'fitdata3plotphi0';'fitdata3plotphi90';'fitdata3plotphi180';'fitdata3plotphi270';'fitdata3ploterrphi0';'fitdata3ploterrphi90';'fitdata3ploterrphi180';'fitdata3ploterrphi270';'TextPlotData3';'TextXData3';'popupmenuXData3';'TextYData3';'popupmenuYData3';'buttonExportFitData3';'buttonClearFitData3';'TextPhiData3';'plotwindowfitdata3checkboxphi0';'plotwindowfitdata3checkboxphi90';'plotwindowfitdata3checkboxphi180';'plotwindowfitdata3checkboxphi270';'plotwindowfitdata4';'Sliderplotwindowfitdata4';'axesplotfitdata4';'fitdata4plotphi0';'fitdata4plotphi90';'fitdata4plotphi180';'fitdata4plotphi270';'fitdata4ploterrphi0';'fitdata4ploterrphi90';'fitdata4ploterrphi180';'fitdata4ploterrphi270';'TextPlotData4';'TextXData4';'popupmenuXData4';'TextYData4';'popupmenuYData4';'buttonExportFitData4';'buttonClearFitData4';'TextPhiData4';'plotwindowfitdata4checkboxphi0';'plotwindowfitdata4checkboxphi90';'plotwindowfitdata4checkboxphi180';'plotwindowfitdata4checkboxphi270'};
tokeep = {'myfig';'TabGroup';'Tabs';'MPDFileNameList';'FluorCellArray';'ElementsString';'Tolerance';'Colors';'T';'Sample';'Measurement';'Substrate';'Diffractometer';'DataTmp';'P';'creatsamplepanel';'textelement1';'editfieldelement1';'textmpd1';'popupmenumpd1';'checkboxsubstrate1';'editfieldelement2';'textmpd2';'popupmenumpd2';'okbutton1';'loadmeasurementpanel';'selectfilename';'openbutton1';'popupmenudiff';'popupmenuscanmode';'popupmenuDTCorr';'correctionspanel';'textcorr1';'checkboxcorrections1';'checkboxcorrections2';'checkboxcorrections3';'textcorr2';'popupmenumeasmode';'samplethickness';'checkboxcorrectionsExportData';'plotpanel';'Slider';'axesplotRawData';'plotdata';'plotEtheo';'plotEtheoAdd1';'plotEtheoAdd2';'plotEtheoAdd3';'plotEtheoAdd4';'plotEtheoAdd5';'plotEtheoSub';'plotFluorAdd1';'axesplotRawDataZoom';'plotdataZoom';'plotdataZoomCH';'checkboxtheopeaks1';'checkboxshifttheopeaks1';'editshiftEtheo1';'plusbuttonshiftEtheo1';'minusbuttonshiftEtheo1';'checkboxtheopeaks2';'checkboxshifttheopeaks2';'editshiftEtheo2';'plusbuttonshiftEtheo2';'minusbuttonshiftEtheo2';'checkboxplotall';'buttonexchangespectra';'selectmeasurementpanel';'textselectmeas1';'popupmenuselectmeas1';'textselectmeas2';'editfieldselectmeas1';'textselectmeas3';'editfieldselectmeas2';'textselectmeas4';'editfieldselectmeas3';'textselectmeas5';'editfieldselectmeas4';'textselectmeas6';'editfieldselectmeas5';'checkboxselectmeas1';'textselectmeas7';'textselectmeas8';'editfieldselectmeas6';'textselectmeas9';'checkboxselectmeas2';'okbuttonselectmeas1';'undobuttonselectmeas1';'backgroundpanel';'textbkg1';'buttonselectbkg1';'buttonselectbkg2';'buttonselectbkg3';'buttonselectbkg7';'buttonselectbkg4';'buttonselectbkg5';'buttonselectbkg6';'buttonselectbkg8';'textbkg2';'tablebkgdata';'checkboxBKG';'fittingpanel';'textpeak1';'buttonselectpeak1';'buttonselectpeak2';'buttonselectpeak3';'buttonselectpeak4';'checkboxexportfits';'textFitFunc';'popupmenuFitFunc';'checkboxFitBothDetectors';'textpeak2';'textpeak3';'textpeak4';'textpeak5';'tablepeakdata';'fitresultspanel';'tablefitresults';'createpsifilepanel';'checkboxcreatepsi1';'textcreatepsi2';'editfieldcreatepsi1';'textcreatepsi3';'editfieldcreatepsi2';'textcreatepsi4';'editfieldcreatepsi3';'textcreatepsi5';'editfieldcreatepsi4';'textcreatepsi6';'editfieldcreatepsi5';'textcreatepsi7';'editfieldcreatepsi6';'textcreatepsi8';'editfieldcreatepsi7';'buttoncreatepsi1';'buttoncreatepsi2';'buttoncreatepsi3';'checkboxEditTableData';'tablepsifile';'optionspanel';'buttonoptions1';'buttonoptions2';'buttonoptions3';'buttonoptions4';'calibangEpospanel';'TabGroupCalib';'TabCalib';'textcalibangEpos1';'buttoncalibangEpos1';'buttoncalibangEpos2';'buttoncalibangEpos3';'textcalibangEpos2';'tablecalibangEpos1';'textcalibangEpos3';'texteditfieldcalibangEpos1';'textcalibangEpos4';'texteditfieldcalibangEpos2';'checkboxcalibangEpos1';'textcalibangEpos5';'texteditfieldcalibangEpos3';'checkboxcalibangEpos2';'checkboxcalibangEpos3';'textcalibangEpos6';'buttoncalibangEpos4';'buttoncalibangEpos5';'textfield1';'textfield2';'textfield3';'textfield4';'textfield5';'textfieldpwparam1';'texteditfieldpwparam1';'textfieldpwparam2';'texteditfieldpwparam2';'textfieldpwparam3';'texteditfieldpwparam3';'textfieldpwparam4';'texteditfieldpwparam4';'textfieldpwparam5';'texteditfieldpwparam5';'buttonPWCorrEpos';'buttonPWCorrUndo';'tablehklpanel';'texthkltable1';'tablephasehkl';'texthkltable2';'tablephasehkl2';'textelementEtheo';'texteditfieldEtheo';'textmpdEtheo';'popupmenumpdEtheo';'buttonShowEtheoPeaks';'buttonHideEtheoPeaks';'textelementLine';'textelementFluorescence';'textdataFluorescence';'popupmenudataFluorescence';'buttonShowFluorescencePeaks';'buttonHideFluorescencePeaks';'buttonloadDEK1';'buttonloadstressdata1';'textazimuth';'checkboxphi0';'checkboxphi90';'checkboxphi180';'checkboxphi270';'buttonmodifystressdata1';'buttonexportplots1';'buttonexportplots2';'buttonSaveModPsiFile';'buttonSaveModEvalData';'SliderStressData';'Colors2';'axesplotdspacing';'axesplotIB';'axesplotInt';'plotdatadspacingphi0';'plotreglinedspacingphi0';'plotdatadspacingphi90';'plotreglinedspacingphi90';'plotdatadspacingphi180';'plotreglinedspacingphi180';'plotdatadspacingphi270';'plotreglinedspacingphi270';'plotdataIBphi0';'plotdataIBphi90';'plotdataIBphi180';'plotdataIBphi270';'plotdataIntphi0';'plotdataIntphi90';'plotdataIntphi180';'plotdataIntphi270';'plotstresspanel';'SliderPlotStressData';'axesplotstressdata';'plotstressdata';'fitdatapanel';'SliderFitData';'axesplotfitdata';'plotrawdata1';'plotfitdata1';'plotresiualdata1';'modstressXlimbutton';'Xlimfig';'XlimMaxname';'XlimMaxname1';'editXlimMin';'XlimMinname';'XlimMinname1';'editXlimMax';'XlimTickname';'XlimTickname1';'editXlimTick';'AcceptXEditButton';'CancelXEditButton';'modstressYlimbutton';'Ylimfig';'YlimMaxname';'YlimMaxname1';'editYlimMax';'YlimMinname';'YlimMinname1';'editYlimMin';'YlimTickname';'YlimTickname1';'editYlimTick';'AcceptYEditButton';'CancelYEditButton';'loadtaudatabutton';'fighklstressplottable';'selecthklvaluesbutton';'panelhklstressplottable';'buttonhklstressplottable1';'buttonhklstressplottable2';'Selecthkltable';'figDEKtable';'panelDEKtable';'buttonDEKtable1';'buttonDEKtable2';'buttonDEKtable3';'buttonDEKtable4';'loadDEKtable';'figSelectPeaktable';'panelSelectPeaktable';'buttonSelectPeaktable1';'buttonSelectPeaktable2';'SelectPeaktable';'plotwindowfitdata1';'Sliderplotwindowfitdata1';'axesplotfitdata1';'fitdata1plotphi0';'fitdata1plotphi90';'fitdata1plotphi180';'fitdata1plotphi270';'fitdata1ploterrphi0';'fitdata1ploterrphi90';'fitdata1ploterrphi180';'fitdata1ploterrphi270';'TextPlotData1';'TextXData1';'popupmenuXData1';'TextYData1';'popupmenuYData1';'buttonExportFitData1';'buttonClearFitData1';'TextPhiData1';'plotwindowfitdata1checkboxphi0';'plotwindowfitdata1checkboxphi90';'plotwindowfitdata1checkboxphi180';'plotwindowfitdata1checkboxphi270';'plotwindowfitdata2';'Sliderplotwindowfitdata2';'axesplotfitdata2';'fitdata2plotphi0';'fitdata2plotphi90';'fitdata2plotphi180';'fitdata2plotphi270';'fitdata2ploterrphi0';'fitdata2ploterrphi90';'fitdata2ploterrphi180';'fitdata2ploterrphi270';'TextPlotData2';'TextXData2';'popupmenuXData2';'TextYData2';'popupmenuYData2';'buttonExportFitData2';'buttonClearFitData2';'TextPhiData2';'plotwindowfitdata2checkboxphi0';'plotwindowfitdata2checkboxphi90';'plotwindowfitdata2checkboxphi180';'plotwindowfitdata2checkboxphi270';'plotwindowfitdata3';'Sliderplotwindowfitdata3';'axesplotfitdata3';'fitdata3plotphi0';'fitdata3plotphi90';'fitdata3plotphi180';'fitdata3plotphi270';'fitdata3ploterrphi0';'fitdata3ploterrphi90';'fitdata3ploterrphi180';'fitdata3ploterrphi270';'TextPlotData3';'TextXData3';'popupmenuXData3';'TextYData3';'popupmenuYData3';'buttonExportFitData3';'buttonClearFitData3';'TextPhiData3';'plotwindowfitdata3checkboxphi0';'plotwindowfitdata3checkboxphi90';'plotwindowfitdata3checkboxphi180';'plotwindowfitdata3checkboxphi270';'plotwindowfitdata4';'Sliderplotwindowfitdata4';'axesplotfitdata4';'fitdata4plotphi0';'fitdata4plotphi90';'fitdata4plotphi180';'fitdata4plotphi270';'fitdata4ploterrphi0';'fitdata4ploterrphi90';'fitdata4ploterrphi180';'fitdata4ploterrphi270';'TextPlotData4';'TextXData4';'popupmenuXData4';'TextYData4';'popupmenuYData4';'buttonExportFitData4';'buttonClearFitData4';'TextPhiData4';'plotwindowfitdata4checkboxphi0';'plotwindowfitdata4checkboxphi90';'plotwindowfitdata4checkboxphi180';'plotwindowfitdata4checkboxphi270';'uplotoptionspanel';'buttonloaduplotdata1';'tableuplotdspacing';'textsamplethickness';'editsamplethickness';'textuserdzero';'userdzerocheckbox';'textdzerozgradient';'dzerozgradientcheckbox';'textsdzeropoly1';'editdzeropoly1';'textsdzeropoly2';'editdzeropoly2';'textsdzeropoly3';'editdzeropoly3';'textsdzeropoly4';'textsdzeropoly5';'textsin2psirange';'textsin2psirange1';'editsin2psirange1';'textsin2psirange2';'editsin2psirange2';'textfilter1';'filteruplotdatacheckbox';'textfilter2';'textfilter1sigma11';'editfilter1sigma11';'textfilter2sigma11';'textfilter3sigma11';'editfilter2sigma11';'textfilter4sigma11';'textfilter1sigma13';'editfilter1sigma13';'textfilter2sigma13';'textfilter3sigma13';'editfilter2sigma13';'textfilter4sigma13';'textfilter1sigma22';'editfilter1sigma22';'textfilter2sigma22';'textfilter3sigma22';'editfilter2sigma22';'textfilter4sigma22';'textfilter1sigma23';'editfilter1sigma23';'textfilter2sigma23';'textfilter3sigma23';'editfilter2sigma23';'textfilter4sigma23';'uplotplotfitscheckbox';'textplotfits1';'textplotfits11';'textplotfits12';'textplotfits13';'textdegreepoly1';'editdegree1';'dampingcheckbox1';'textdamping1';'textplotfits21';'textplotfits22';'textplotfits23';'textdegreepoly2';'editdegree2';'dampingcheckbox2';'textdamping2';'textplotfits31';'textplotfits32';'textplotfits33';'textdegreepoly3';'editdegree3';'dampingcheckbox3';'textdamping3';'textplotfits41';'textplotfits42';'textplotfits43';'textdegreepoly4';'editdegree4';'dampingcheckbox4';'textdamping4';'ShowCIboundscheckbox';'buttonplotuplotdata';'buttonplotdsin2psi';'exportrecalcdcheckbox';'textexportrecalcd';'buttonclearuplotdata';'buttonexportuplotdata';'uplotplotpanel';'axesuplotdatasigma11';'uplotdatasigma11';'ChangeAxLimcheckbox1';'textXlimmin1';'editXlimmin1';'textXlimmax1';'editXlimmax1';'textXlimtick1';'editXlimtick1';'textYlimmin1';'editYlimmin1';'textYlimmax1';'editYlimmax1';'textYlimtick1';'editYlimtick1';'axesuplotdatasigma13';'uplotdatasigma13';'ChangeAxLimcheckbox2';'textXlimmin2';'editXlimmin2';'textXlimmax2';'editXlimmax2';'textXlimtick2';'editXlimtick2';'textYlimmin2';'editYlimmin2';'textYlimmax2';'editYlimmax2';'textYlimtick2';'editYlimtick2';'axesuplotdatasigma22';'uplotdatasigma22';'ChangeAxLimcheckbox3';'textXlimmin3';'editXlimmin3';'textXlimmax3';'editXlimmax3';'textXlimtick3';'editXlimtick3';'textYlimmin3';'editYlimmin3';'textYlimmax3';'editYlimmax3';'textYlimtick3';'editYlimtick3';'axesuplotdatasigma23';'uplotdatasigma23';'ChangeAxLimcheckbox4';'textXlimmin4';'editXlimmin4';'textXlimmax4';'editXlimmax4';'textXlimtick4';'editXlimtick4';'textYlimmin4';'editYlimmin4';'textYlimmax4';'editYlimmax4';'textYlimtick4';'editYlimtick4'}; %'PhaseAnalysisLoadDataPanel';'LoadMeasDataQAText1';'LoadMeasDataQA';'openbuttonQA1';'okbuttonQA1';'popupmenudiffQA';'popupmenuscanmodeQA';'popupmenuDTCorrQA';'SelectMeasDataQAText1';'SelectMeasDataQAText2';'PopupMenuSelectDetQA';'SelectMeasDataQAText3';'SelectMeasDataQAedit1';'SelectMeasDataQAText4';'SelectMeasDataQAedit2';'SelectPeaksQAText1';'SelectBKGbuttonQA';'SelectPeaksbuttonQA';'FitPeaksbuttonQA';'ClearDatabuttonQA';'tablepeaksQA';'CheckFluorPosQAText1';'CheckFluorPosQAText2';'tableFluorQA';'CheckFluorPeaksbuttonQA';'LoadMeasDataQAText2';'openPeriodicTablebutton';'SelectedElementsQAedit1';'SelectElementsQAText1';'SelectedElementsQAedit2';'SelectElementsQAText2';'SelectedElementsQAedit3';'StartPeakMatchbutton';'PhaseAnalysisPlotDataPanel';'SliderQA';'axesplotMeasDataQA';'plotdataQA';'PhaseAnalysisResultTablePanel';'tableresultsSAMQA';'AddFluorLinesTablePanel';'orderFluorElements';'AddFluorLinestable'};

f = fieldnames(h);
toRemove = f(~ismember(f,tokeep));
h = rmfield(h,toRemove);

% set(h.checkboxTauData,'Value', 0)

set(h.loadDEKtable,'data', zeros(20,5))
d = zeros(8,1);
idxdata = d(:)>0;
set(h.SelectPeaktable,'data', [num2cell(d) num2cell(idxdata)])

guidata(hObj, h);

function SaveGUIDataButton(hObj, ~, ~)
% Callback for saving evaluation data
h = guidata(hObj);

% Material
material = h.P.PopupValueMpd1;

[filename, filepath] = uiputfile('*.mat','Save GUIData',[General.ProgramInfo.Path,'\Data\GUIData\',...
                      strtrim(h.Measurement(1).MeasurementSeries),'_',material,'_',datestr(now, 'ddmmyyyy')]);

% If user pressed cancel, abort saving process
if filename==0
  % user pressed cancel
  return
end
                  
% Create Sample fields
s.CreateSampleMat = get(h.editfieldelement1,'String');
s.CreateSampleMPD = get(h.popupmenumpd1,'Value');
s.CreateSampleMPDFileName = h.P.MPDFileName;
% Create Substrate fields
s.CreateSampleSubchkbx = get(h.checkboxsubstrate1,'Value');
s.CreateSampleSubMat = get(h.editfieldelement2,'String');
s.CreateSampleSubMPD = get(h.popupmenumpd2,'Value');
s.CreateSampleSubMPDFileName = h.P.SusbtrateMPDFileName;
% Create Load measurement fields
s.MeasFileName = get(h.selectfilename,'String');
s.MeasDiffTypeVal = get(h.popupmenudiff,'Value');
s.MeasDiffTypeName = h.Diffsel;
s.MeasScanMode = get(h.popupmenuscanmode,'Value');
s.MeasDTCorr = get(h.popupmenuDTCorr,'Value');
% Create Corrections fields
s.CorrWiggler = get(h.checkboxcorrections1,'Value');
s.CorrAbsorption = get(h.checkboxcorrections2,'Value');
s.CorrRingCurrent = get(h.checkboxcorrections3,'Value');
s.CorrMeasMode = get(h.popupmenumeasmode,'Value');
s.CorrSampleThickness = get(h.samplethickness,'String');
% Create Select Measurement fields
s.SelMeasDetLEDDIVal = get(h.popupmenuselectmeas1,'Value');
s.SelMeasDetLEDDIName = h.Detsel;

s.measmode = h.measmode;
s.Diffsel = h.Diffsel;
s.Detsel = h.Detsel;

if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    s.SelMeasE1 = h.P.EnergyRange(1);
    s.SelMeasE2 = h.P.EnergyRange(2);
    s.EnergyRange = h.EnergyRange;
elseif strcmp(h.Diffsel,'LEDDI')
    if isfield(h, 'EnergyRangeDet1')
        s.SelMeasE1Det1 = h.P.EnergyRangeDet1(1);
        s.SelMeasE2Det1 = h.P.EnergyRangeDet1(2);
        s.EnergyRangeDet1 = h.EnergyRangeDet1;
    end
    
    if isfield(h, 'EnergyRangeDet2')
        s.SelMeasE1Det2 = h.P.EnergyRangeDet2(1);
        s.SelMeasE2Det2 = h.P.EnergyRangeDet2(2);
        s.EnergyRangeDet2 = h.EnergyRangeDet2;
    end  
end
% Create Background correction fields
if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    s.PeakRegionsX = h.PeakRegionsX;
    s.PeakRegionsXdata = h.PeakRegionsXdata;
    s.PeakRegionsYdata = h.PeakRegionsYdata;
elseif strcmp(h.Diffsel,'LEDDI')
    if isfield(h, 'PeakRegionsXDet1')
        s.PeakRegionsXDet1 = h.PeakRegionsXDet1;
        s.PeakRegionsXdataDet1 = h.PeakRegionsXdataDet1;
        s.PeakRegionsYdataDet1 = h.PeakRegionsYdataDet1;
    end
    
    if isfield(h, 'PeakRegionsXDet2')
        s.PeakRegionsXDet2 = h.PeakRegionsXDet2;
        s.PeakRegionsXdataDet2 = h.PeakRegionsXdataDet2;
        s.PeakRegionsYdataDet2 = h.PeakRegionsYdataDet2;
    end
end
s.CheckBoxUseAllSpectra = get(h.checkboxBKG,'Value');
% Create Fitting fields
if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    s.TPeaks = h.TPeaks;
    s.Peaks = h.Peaks;
    s.Peakslb = h.Peakslb;
    s.Peaksub = h.Peaksub;
    s.xDataTmpCalc = h.xDataTmpCalc;
    s.FittedPeaks = h.FittedPeaks;
    s.FittedPeaksCalctmp =  h.FittedPeaksCalctmp;
    s.XFit = h.XFit;
    s.YFit = h.YFit;
    s.XPlot = h.XPlot;
    s.YPlot = h.YPlot;
    s.SE = h.SE;
    s.CI = h.CI;
elseif strcmp(h.Diffsel,'LEDDI')
    if isfield(h, 'PeaksDet1')
        s.TPeaksDet1 = h.TPeaksDet1;
        s.PeaksDet1 = h.PeaksDet1;
        s.Peakslb = h.Peakslb;
        s.Peaksub = h.Peaksub;
        s.xDataTmpCalcDet1 = h.xDataTmpCalcDet1;
        s.FittedPeaksDet1 = h.FittedPeaksDet1;
        s.FittedPeaksCalctmpDet1 =  h.FittedPeaksCalctmpDet1;
        s.XFitDet1 = h.XFitDet1;
        s.YFitDet1 = h.YFitDet1;
        s.XPlotDet1 = h.XPlotDet1;
        s.YPlotDet1 = h.YPlotDet1;
        s.SEDet1 = h.SEDet1;
        s.CIDet1 = h.CIDet1;
    end
    
    if isfield(h, 'PeaksDet2')
        s.TPeaksDet2 = h.TPeaksDet2;
        s.PeaksDet2 = h.PeaksDet2;
        s.Peakslb = h.Peakslb;
        s.Peaksub = h.Peaksub;
        s.xDataTmpCalcDet2 = h.xDataTmpCalcDet2;
        s.FittedPeaksDet2 = h.FittedPeaksDet2;
        s.FittedPeaksCalctmpDet2 =  h.FittedPeaksCalctmpDet2;
        s.XFitDet2 = h.XFitDet2;
        s.YFitDet2 = h.YFitDet2;
        s.XPlotDet2 = h.XPlotDet2;
        s.YPlotDet2 = h.YPlotDet2;
        s.SEDet2 = h.SEDet2;
        s.CIDet2 = h.CIDet2;
    end
end

s.PopupValueFitFunc = h.P.PopupValueFitFunc;
s.checkboxFitBothDetectors = get(h.checkboxFitBothDetectors,'Value');
s.checkboxexportfits = get(h.checkboxexportfits,'Value');
% Create fit results table field
s.tablefitresults = get(h.tablefitresults,'data');
% Create Psi File panel fields
s.checkboxcreatepsi1 = get(h.checkboxcreatepsi1,'Value');
s.editfieldcreatepsi1 = get(h.editfieldcreatepsi1,'String');
s.editfieldcreatepsi2 = get(h.editfieldcreatepsi2,'String');
s.editfieldcreatepsi3 = get(h.editfieldcreatepsi3,'String');
s.editfieldcreatepsi4 = get(h.editfieldcreatepsi4,'String');
s.editfieldcreatepsi5 = get(h.editfieldcreatepsi5,'String');
s.editfieldcreatepsi6 = get(h.editfieldcreatepsi6,'String');
s.editfieldcreatepsi7 = get(h.editfieldcreatepsi7,'String');
s.checkboxEditTableData = get(h.checkboxEditTableData,'Value');
% if isfield(h, 'MinVal')
% If Background and peak file is loaded, MinVal is not created. Get MinVal
% from somewhere else?
s.MinVal = h.MinVal;
% end

if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    s.DiffractionLines = h.DiffractionLines;
    if isfield(h,'FittedPeaksbkp')
        s.FittedPeaksbkp = h.FittedPeaksbkp;
    end
    s.PsiFileTableData = h.PsiFileTableData;
    s.PsiFileTableDataBkp = h.PsiFileTableDataBkp;
    s.Psidata = h.Psidata;
elseif strcmp(h.Diffsel,'LEDDI')
    if isfield(h, 'PeaksDet1')
        s.DiffractionLinesDet1 = h.DiffractionLinesDet1;
        if isfield(h,'FittedPeaksDet1bkp')
            s.FittedPeaksbkpDet1 = h.FittedPeaksbkpDet1;
        end
        s.PsiFileTableDataDet1 = h.PsiFileTableDataDet1;
        s.PsiFileTableDataDet1Bkp = h.PsiFileTableDataDet1Bkp;
        s.PsidataDet1 = h.PsidataDet1;
    end
    
    if isfield(h, 'PeaksDet2')
        s.DiffractionLinesDet2 = h.DiffractionLinesDet2;
        if isfield(h,'FittedPeaksDet2bkp')
            s.FittedPeaksbkpDet2 = h.FittedPeaksbkpDet2;
        end
        s.PsiFileTableDataDet2 = h.PsiFileTableDataDet2;
        s.PsiFileTableDataDet2Bkp = h.PsiFileTableDataDet2Bkp;
        s.PsidataDet2 = h.PsidataDet2;
    end
end

% Create Theoretical peak pos fields
if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    s.tablephasehkl = h.tablephasehkl;
elseif strcmp(h.Diffsel,'LEDDI')
    if isfield(h, 'PeakRegionsXDet1')
        s.PeakRegionsXDet1 = h.PeakRegionsXDet1;
        s.tablephasehklDet1 = h.tablephasehkl;
    end
    
    if isfield(h, 'PeakRegionsXDet2')
        s.PeakRegionsXDet2 = h.PeakRegionsXDet2;
        s.tablephasehklDet2 = h.tablephasehkl;
    end
end

s.Measurement = h.Measurement;
s.MeasurementBackup = h.MeasurementBackup;
s.DataTmp = h.DataTmp;
s.Sample = h.Sample;
s.Diffractometer = h.Diffractometer;
s.T = h.T;
s.P = h.P;
s.DataTmpBackup = h.DataTmpBackup;
% s.VersionNumber = 1.0;

% assignin('base','sorg',s)

% Message box
msgbox('Fitting data saved.');

save(fullfile(filepath, filename), 's');

function LoadGUIDataButton(hObj, ~, ~)
% % Load evaluation data
h = guidata(hObj);
% Get slider value
valueSlider = round(get(h.Slider, 'Value'));
% Load evaluation file
[baseFileName, folder] = uigetfile('*.mat','Load evaluation file',[General.ProgramInfo.Path,'/Data/GUIData/']);

% If user pressed cancel, abort saving process
if baseFileName == 0
  % user pressed cancel
  return
end

EvaluationFileName = fullfile(folder, baseFileName);
load(EvaluationFileName);

% Set main data
h.Measurement = s.Measurement;
h.DataTmp = s.DataTmp;
h.DataTmpBackup = s.DataTmpBackup;
h.Sample = s.Sample;
h.Diffractometer = s.Diffractometer;
h.T = s.T;
h.P = s.P;

h.P.ElementalFormula = s.CreateSampleMat;
h.P.MPDFileName = s.CreateSampleMPDFileName;
h.P.ShowSubstratePeaks = s.CreateSampleSubchkbx;
h.P.SubstrateFormula = s.CreateSampleSubMat;
h.P.SusbtrateMPDFileName = s.CreateSampleSubMPDFileName;
h.P.PopupValueFitFunc = s.PopupValueFitFunc;

h.measmode = s.measmode;
h.Diffsel = s.Diffsel;
h.Detsel = s.Detsel;

% Set slider parameters
if strcmp(s.MeasDiffTypeName,'EDDI') || strcmp(s.MeasDiffTypeName,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    if length(s.Measurement) == 1
        set(h.Slider,'Min',0);
        set(h.Slider,'Max',length(s.Measurement));
        set(h.Slider,'SliderStep',[1 1]);
    else
        set(h.Slider,'Min',1);
        set(h.Slider,'Max',length(s.Measurement));
        set(h.Slider,'SliderStep',[1/(length(s.Measurement)-1) 1/(length(s.Measurement)-1)]);
    end
elseif strcmp(s.MeasDiffTypeName,'LEDDI')
    if length(s.Measurement) == 2
        set(h.Slider,'Min',0);
        set(h.Slider,'Max',length(s.Measurement)/2);
        set(h.Slider,'SliderStep',[1 1]);
    else
        set(h.Slider,'Min',1);
        set(h.Slider,'Max',length(s.Measurement)/2);
        set(h.Slider,'SliderStep',[1/((length(s.Measurement)/2)-1) 1/((length(s.Measurement)/2)-1)]);
    end
end

% Set Sample fields
set(h.editfieldelement1,'String',s.CreateSampleMat);
set(h.popupmenumpd1,'Value',s.CreateSampleMPD);
% Set Substrate fields
set(h.checkboxsubstrate1,'Value',s.CreateSampleSubchkbx);
set(h.editfieldelement2,'String',s.CreateSampleSubMat);
set(h.popupmenumpd2,'Value',s.CreateSampleSubMPD);
% Set Load measurement fields
set(h.selectfilename,'String',s.MeasFileName);
set(h.popupmenudiff,'Value',s.MeasDiffTypeVal);
set(h.popupmenuscanmode,'Value',s.MeasScanMode);
set(h.popupmenuDTCorr,'Value',s.MeasDTCorr);
% Set Corrections fields
set(h.checkboxcorrections1,'Value',s.CorrWiggler);
set(h.checkboxcorrections2,'Value',s.CorrAbsorption);
set(h.checkboxcorrections3,'Value',s.CorrRingCurrent);
set(h.popupmenumeasmode,'Value',s.CorrMeasMode);
set(h.samplethickness,'String',s.CorrSampleThickness);
% Set Select Measurement fields
if strcmp(s.MeasDiffTypeName,'EDDI') || strcmp(s.MeasDiffTypeName,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    set(h.popupmenuselectmeas1,{'Value','Enable'}, {2,'off'})
elseif strcmp(s.MeasDiffTypeName,'LEDDI')
    set(h.popupmenuselectmeas1,{'Value','Enable'},{s.SelMeasDetLEDDIVal,'on'});
end

% Set Background correction fields
set(h.checkboxFitBothDetectors, 'Value', s.checkboxFitBothDetectors);
set(h.checkboxexportfits, 'Value', s.checkboxexportfits);

if strcmp(s.MeasDiffTypeName,'EDDI') || strcmp(s.MeasDiffTypeName,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    set(h.editfieldselectmeas1,'String',num2str(length(s.Measurement)));
    set(h.editfieldselectmeas2,'String',num2str(1));
    set(h.editfieldselectmeas3,'String',num2str(length(s.Measurement)));
    set(h.editfieldselectmeas4,'String',num2str(s.SelMeasE1))
    set(h.editfieldselectmeas5,'String',num2str(s.SelMeasE2))
    h.Peaks = s.Peaks;
    h.Peakslb = s.Peakslb;
    h.Peaksub = s.Peaksub;
%     set(h.tablepeakdata,'data',h.Peaks{valueSlider})
    set(h.tablepeakdata,'data',[h.Peaks{valueSlider};h.Peakslb{valueSlider};h.Peaksub{valueSlider}])
    set(h.tablebkgdata,'data',s.PeakRegionsX{valueSlider})
    h.PeakRegionsX = s.PeakRegionsX;
    h.PeakRegionsXdata = s.PeakRegionsXdata;
    h.PeakRegionsYdata = s.PeakRegionsYdata;
elseif strcmp(s.MeasDiffTypeName,'LEDDI')
    if isfield(s, 'PeakRegionsXDet1')
        set(h.editfieldselectmeas1,'String',num2str(length(s.Measurement)/2));
        set(h.editfieldselectmeas2,'String',num2str(1));
        set(h.editfieldselectmeas3,'String',num2str(length(s.Measurement)/2));
        if isfield(s, 'EnergyRangeDet1')
            set(h.editfieldselectmeas4,'String',num2str(s.SelMeasE1Det1))
            set(h.editfieldselectmeas5,'String',num2str(s.SelMeasE2Det1))
        end
        h.PeaksDet1 = s.PeaksDet1;
        h.Peakslb = s.Peakslb;
        h.Peaksub = s.Peaksub;
        set(h.tablepeakdata,'data',[h.PeaksDet1{valueSlider};h.Peakslb{valueSlider};h.Peaksub{valueSlider}])
        if strcmp(s.SelMeasDetLEDDIName,'Detector 1')
            set(h.tablebkgdata,'data',s.PeakRegionsXDet1{valueSlider})
        end
        h.PeakRegionsXDet1 = s.PeakRegionsXDet1;
        h.PeakRegionsXdataDet1 = s.PeakRegionsXdataDet1;
        h.PeakRegionsYdataDet1 = s.PeakRegionsYdataDet1;
    end
    
    if isfield(s, 'PeakRegionsXDet2')
        set(h.editfieldselectmeas1,'String',num2str(length(s.Measurement)/2));
        set(h.editfieldselectmeas2,'String',num2str(1));
        set(h.editfieldselectmeas3,'String',num2str(length(s.Measurement)/2));
        if isfield(s, 'EnergyRangeDet2')
            set(h.editfieldselectmeas4,'String',num2str(s.SelMeasE1Det2))
            set(h.editfieldselectmeas5,'String',num2str(s.SelMeasE2Det2))
        end
        h.PeaksDet2 = s.PeaksDet2;
        h.Peakslb = s.Peakslb;
        h.Peaksub = s.Peaksub;
        set(h.tablepeakdata,'data',[h.PeaksDet2{valueSlider};h.Peakslb{valueSlider};h.Peaksub{valueSlider}])
        if strcmp(s.SelMeasDetLEDDIName,'Detector 2')
            set(h.tablebkgdata,'data',s.PeakRegionsXDet2{valueSlider})
        end
        h.PeakRegionsXDet2 = s.PeakRegionsXDet2;
        h.PeakRegionsXdataDet2 = s.PeakRegionsXdataDet2;
        h.PeakRegionsYdataDet2 = s.PeakRegionsYdataDet2;
    end
end

% Set plot data in order for the slider to work
if strcmp(s.MeasDiffTypeName,'LEDDI')
    if strcmp(s.SelMeasDetLEDDIName,'Detector 1')
        Slidersteps = 2:2:length(h.Measurement);
        % Interpolate RawData to get YData for PeakRegions
        h.DataInterpPeaksDet1 = interp1(h.DataTmp{Slidersteps(valueSlider)}(:,1),h.DataTmp{Slidersteps(valueSlider)}(:,2),h.PeaksDet1{valueSlider});
        h.plotpeakpoints = plot(h.axesplotRawData,h.PeaksDet1{valueSlider},h.DataInterpPeaksDet1,'d','Color','r','MarkerFaceColor','r','MarkerSize',5,'Visible','off');
        % Set plot of bkg points visible off
        h.plotbkgpoints = plot(h.axesplotRawData,[h.PeakRegionsXdataDet1{valueSlider,:}],[h.PeakRegionsYdataDet1{valueSlider,:}],'o','Color','r','MarkerFaceColor','r','MarkerSize',5,'Tag','plotbkgpoints','Visible','off');
    elseif strcmp(s.SelMeasDetLEDDIName,'Detector 2')
        Slidersteps = 1:2:length(h.Measurement);
        % Interpolate RawData to get YData for PeakRegions
        h.DataInterpPeaksDet2 = interp1(h.DataTmp{Slidersteps(valueSlider)}(:,1),h.DataTmp{Slidersteps(valueSlider)}(:,2),h.PeaksDet2{valueSlider});
        h.plotpeakpoints = plot(h.axesplotRawData,h.PeaksDet2{valueSlider},h.DataInterpPeaksDet2,'d','Color','r','MarkerFaceColor','r','MarkerSize',5,'Visible','off');
        % Set plot of bkg points visible off
        h.plotbkgpoints = plot(h.axesplotRawData,[h.PeakRegionsXdataDet2{valueSlider,:}],[h.PeakRegionsYdataDet2{valueSlider,:}],'o','Color','r','MarkerFaceColor','r','MarkerSize',5,'Tag','plotbkgpoints','Visible','off');
    end
else
    h.DataInterpPeaks = interp1(h.DataTmp{valueSlider}(:,1),h.DataTmp{valueSlider}(:,2),h.Peaks{valueSlider});
    h.plotpeakpoints = plot(h.axesplotRawData,h.Peaks{valueSlider},h.DataInterpPeaks,'d','Color','r','MarkerFaceColor','r','MarkerSize',5,'Visible','off');
    h.plotbkgpoints = plot(h.axesplotRawData,[h.PeakRegionsXdata{valueSlider,:}],[h.PeakRegionsYdata{valueSlider,:}],'o','Color','r','MarkerFaceColor','r','MarkerSize',5,'Tag','plotbkgpoints','Visible','off');
end

% Set plot data for plot window
if strcmp(s.MeasDiffTypeName,'EDDI') || strcmp(s.MeasDiffTypeName,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    h.P.EnergyRange(1) = s.SelMeasE1;
    h.P.EnergyRange(2) = s.SelMeasE2;
    h.EnergyRange = s.EnergyRange;
    set(h.axesplotRawData.Title,'String',['Measurement data for ', s.Measurement(1).Name])
    set(h.plotdata,'xdata',s.DataTmp{valueSlider}(:,1))
    set(h.plotdata,'ydata',s.DataTmp{valueSlider}(:,2))
    set(h.plotdataZoom,{'xdata','ydata'},{s.DataTmp{valueSlider}(:,1) s.DataTmp{valueSlider}(:,2)})
    set(h.plotdataZoomCH,{'xdata','ydata'},{0 0})
    h.axesplotRawData.XLim = h.P.EnergyRange;
    h.axesplotRawData.YLim =[-Inf round(max(h.DataTmp{valueSlider}(:,2)),-1)];
    % Set peak properties (Pos, Int etc.) of theoretical peaks
    h.TPeaks = s.TPeaks;
    a = h.TPeaks.T.Etheo > h.P.EnergyRange(1) & h.TPeaks.T.Etheo < h.P.EnergyRange(2);
    h.FitPeaksLogicalErange = a;
%     EtheoLimit = h.TPeaks.T.Etheo(a);
%     X1Limit = h.TPeaks.T.X1(a,:);
    X3Limit = h.TPeaks.T.X3((1:(3*find(a, 1, 'last')-1)),:);
    Y3Limit = h.TPeaks.T.Y3((1:(3*find(a, 1, 'last')-1)),:);
    set(h.plotEtheo,'xdata',X3Limit(:,valueSlider))
    set(h.plotEtheo,'ydata',Y3Limit(:,valueSlider).*(max(h.DataTmp{valueSlider}(:,2))/max(Y3Limit(:,valueSlider))))
    % Set data for table with hkl, d-spacing and E[keV] values
%     set(h.tablephasehkl,'data',h.TPeaks.T.Peaks(a,:))
    % Compare user defined peaks and theoretical peak positons and
    % mark the respective peaks in the phase data table 
    PeaksTheo = h.TPeaks.T.Peaks(:,5);
    PeaksTheo = PeaksTheo.*h.FitPeaksLogicalErange;
    PeaksTheo(PeaksTheo==0) = [];
    TableBkgColor = [1 0.6 0.6];
    TableBkgColorArray = repmat(TableBkgColor,size(PeaksTheo,1),1);
    [CompareFitPeaksLogical,MinVal,IndVal,PeakHit] = ComparePeaks(s.Peaks,PeaksTheo);
    h.MinVal = MinVal;
    h.FitPeaksLogical = CompareFitPeaksLogical;
    CompareFitPeaksLogical = double(CompareFitPeaksLogical);
    h.IndVal = IndVal;
    % Repmat of logical vector in order to match size of T.Peaks array
    TableBkgColorArray = TableBkgColorArray.*CompareFitPeaksLogical;
    TableBkgColorArray(TableBkgColorArray==0) = 1;
    h.TableBkgColorArray = TableBkgColorArray;
    set(h.tablephasehkl,'BackgroundColor',TableBkgColorArray)
    set(h.tablephasehkl,'data',get(s.tablephasehkl,'data'))
    
elseif strcmp(s.MeasDiffTypeName,'LEDDI')
    if isfield(s, 'EnergyRangeDet1')
        h.P.EnergyRangeDet1(1) = s.SelMeasE1Det1;
        h.P.EnergyRangeDet1(2) = s.SelMeasE2Det1;
        h.EnergyRangeDet1 = s.EnergyRangeDet1;
        Slidersteps = 2:2:length(h.Measurement);
        % Set measurement title
        set(h.axesplotRawData.Title,'String',['Measurement Data for ', s.Measurement(Slidersteps(valueSlider)).Name])
        % Set plot data
        set(h.plotdata,'xdata',s.DataTmp{Slidersteps(valueSlider)}(:,1))
        set(h.plotdata,'ydata',s.DataTmp{Slidersteps(valueSlider)}(:,2))
        set(h.plotdataZoom,{'xdata','ydata'},{s.DataTmp{Slidersteps(valueSlider)}(:,1) s.DataTmp{Slidersteps(valueSlider)}(:,2)})
        set(h.plotdataZoomCH,{'xdata','ydata'},{0 0})
        h.axesplotRawData.XLim = h.P.EnergyRangeDet1;
        h.axesplotRawData.YLim =[-Inf round(max(h.DataTmp{Slidersteps(valueSlider)}(:,2)),-1)];
        % Set peak properties (Pos, Int etc.) of theoretical peaks
        h.TPeaksDet1 = s.TPeaksDet1;
        a = h.TPeaksDet1.T.Etheo > h.P.EnergyRangeDet1(1) & h.TPeaksDet1.T.Etheo < h.P.EnergyRangeDet1(2);
        h.FitPeaksLogicalErangeDet1 = a;
%         assignin('base','a',a)
%         assignin('base','TPeaks',h.TPeaksDet1.T.Peaks)
%         EtheoLimit = h.TPeaksDet1.T.Etheo(a);
%         X1Limit = h.TPeaksDet1.T.X1(a,:);
        X3Limit = h.TPeaksDet1.T.X3((1:(3*find(a, 1, 'last')-1)),:);
%         Y3Limit = h.TPeaksDet1.T.Y3((1:(3*find(a, 1, 'last')-1)),:);
%         if strcmp(s.SelMeasDetLEDDIName,'Detector 1')
            set(h.plotEtheo,'xdata',X3Limit(:,1))
            % Set table data for theoretical peak positions
%             set(h.tablephasehkl,'data',[num2cell(h.TPeaksDet1.T.Peaks(a,:)) num2cell(true(size(h.TPeaksDet1.T.Peaks(a,:),1)))])
%         end
        % Compare user defined peaks and theoretical peak positons and
        % mark the respective peaks in the phase data table
        PeaksTheo = h.TPeaksDet1.T.Peaks(:,5);
        PeaksTheo = PeaksTheo.*h.FitPeaksLogicalErangeDet1;
        PeaksTheo(PeaksTheo==0) = [];
        TableBkgColor = [1 0.6 0.6];
        TableBkgColorArrayDet1 = repmat(TableBkgColor,size(PeaksTheo,1),1);
        [CompareFitPeaksLogical,MinVal,IndVal,PeakHit] = ComparePeaks(s.PeaksDet1,PeaksTheo);
        h.MinVal = MinVal;
        h.FitPeaksLogicalDet1 = CompareFitPeaksLogical;
        CompareFitPeaksLogical = double(CompareFitPeaksLogical);
        h.IndValDet1 = IndVal;
        % Repmat of logical vector in order to match size of T.Peaks array
        TableBkgColorArrayDet1 = TableBkgColorArrayDet1.*CompareFitPeaksLogical;
        TableBkgColorArrayDet1(TableBkgColorArrayDet1==0) = 1;
        h.TableBkgColorArrayDet1 = TableBkgColorArrayDet1; 
        set(h.tablephasehkl,'BackgroundColor',h.TableBkgColorArrayDet1)
        set(h.tablephasehkl,'data',get(s.tablephasehklDet1,'data'))
    end
    
    if isfield(s, 'EnergyRangeDet2')
        h.P.EnergyRangeDet2(1) = s.SelMeasE1Det2;
        h.P.EnergyRangeDet2(2) = s.SelMeasE2Det2;
        h.EnergyRangeDet2 = s.EnergyRangeDet2;
        Slidersteps = 1:2:length(h.Measurement);
        % Set measurement title
        set(h.axesplotRawData.Title,'String',['Measurement Data for ', s.Measurement(Slidersteps(valueSlider)).Name])
        % Set plot data
        set(h.plotdata,'xdata',s.DataTmp{Slidersteps(valueSlider)}(:,1))
        set(h.plotdata,'ydata',s.DataTmp{Slidersteps(valueSlider)}(:,2))
        set(h.plotdataZoom,{'xdata','ydata'},{s.DataTmp{Slidersteps(valueSlider)}(:,1) s.DataTmp{Slidersteps(valueSlider)}(:,2)})
        set(h.plotdataZoomCH,{'xdata','ydata'},{0 0})
        h.axesplotRawData.XLim = h.P.EnergyRangeDet2;
        h.axesplotRawData.YLim =[-Inf round(max(h.DataTmp{Slidersteps(valueSlider)}(:,2)),-1)];
        % Set peak properties (Pos, Int etc.) of theoretical peaks
        h.TPeaksDet2 = s.TPeaksDet2;
        a = h.TPeaksDet2.T.Etheo > h.P.EnergyRangeDet2(1) & h.TPeaksDet2.T.Etheo < h.P.EnergyRangeDet2(2);
        h.FitPeaksLogicalErangeDet2 = a;
%         EtheoLimit = h.TPeaksDet2.T.Etheo(a);
%         X1Limit = h.TPeaksDet2.T.X1(a,:);
        X3Limit = h.TPeaksDet2.T.X3((1:(3*find(a, 1, 'last')-1)),:);
%         Y3Limit = h.TPeaksDet2.T.Y3((1:(3*find(a, 1, 'last')-1)),:);
%         if strcmp(s.SelMeasDetLEDDIName,'Detector 2')
            set(h.plotEtheo,'xdata',X3Limit(:,1))
            % Set table data for theoretical peak positions
%             set(h.tablephasehkl,'data',[num2cell(h.TPeaksDet2.T.Peaks(a,:)) num2cell(true(size(h.TPeaksDet2.T.Peaks(a,:),1)))])
%         end
        % Compare user defined peaks and theoretical peak positons and
        % mark the respective peaks in the phase data table 
        PeaksTheo = h.TPeaksDet2.T.Peaks(:,5);
        PeaksTheo = PeaksTheo.*h.FitPeaksLogicalErangeDet2;
        PeaksTheo(PeaksTheo==0) = [];
        TableBkgColor = [1 0.6 0.6];
        TableBkgColorArrayDet2 = repmat(TableBkgColor,size(PeaksTheo,1),1);
        [CompareFitPeaksLogical,MinVal,IndVal,PeakHit] = ComparePeaks(s.PeaksDet2,PeaksTheo);
        h.MinVal = MinVal;
        h.FitPeaksLogicalDet2 = CompareFitPeaksLogical;
        CompareFitPeaksLogical = double(CompareFitPeaksLogical);
        h.IndValDet2 = IndVal;
        % Repmat of logical vector in order to match size of T.Peaks array
        TableBkgColorArrayDet2 = TableBkgColorArrayDet2.*CompareFitPeaksLogical;
        TableBkgColorArrayDet2(TableBkgColorArrayDet2==0) = 1;
        h.TableBkgColorArrayDet2 = TableBkgColorArrayDet2;
        set(h.tablephasehkl,'BackgroundColor',h.TableBkgColorArrayDet2)
        set(h.tablephasehkl,'data',get(s.tablephasehklDet2,'data'))
    end
end

% Set fitted plot data for plot of fitted peaks
if strcmp(s.MeasDiffTypeName,'EDDI') || strcmp(s.MeasDiffTypeName,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    h.DiffractionLines = s.DiffractionLines;
    h.xDataTmpCalc = s.xDataTmpCalc;
    if isfield(s,'FittedPeaksbkp')
        h.FittedPeaks = s.FittedPeaksbkp;
    else
        h.FittedPeaks = s.FittedPeaks;
    end
    h.SE = s.SE;
    h.CI = s.CI;
    h.FittedPeaksCalctmp = s.FittedPeaksCalctmp;
    h.XFit = s.XFit;
    h.YFit = s.YFit;
    h.XPlot = s.XPlot;
    h.YPlot = s.YPlot;
    FittedPeaksCalctmp = s.FittedPeaksCalctmp;
    XFit = s.XFit;
    YFit = s.YFit;
    XPlot = s.XPlot;
    YPlot = s.YPlot;   
elseif strcmp(s.MeasDiffTypeName,'LEDDI')
    if isfield(s,'FittedPeaksDet1')
        h.DiffractionLinesDet1 = s.DiffractionLinesDet1;
        h.xDataTmpCalcDet1 = s.xDataTmpCalcDet1;
        if isfield(s,'FittedPeaksbkpDet1')
            h.FittedPeaksDet1 = s.FittedPeaksbkpDet1;
        else
            h.FittedPeaksDet1 = s.FittedPeaksDet1;
        end
        h.SEDet1 = s.SEDet1;
        h.CIDet1 = s.CIDet1;
        h.FittedPeaksCalctmpDet1 = s.FittedPeaksCalctmpDet1;
        h.XFitDet1 = s.XFitDet1;
        h.YFitDet1 = s.YFitDet1;
        h.XPlotDet1 = s.XPlotDet1;
        h.YPlotDet1 = s.YPlotDet1;
        if strcmp(s.SelMeasDetLEDDIName,'Detector 1')
            FittedPeaksCalctmp = s.FittedPeaksCalctmpDet1;
            XFit = s.XFitDet1;
            YFit = s.YFitDet1;
            XPlot = s.XPlotDet1;
            YPlot = s.YPlotDet1;
        end
    end
    if isfield(s,'FittedPeaksDet2')
        h.DiffractionLinesDet2 = s.DiffractionLinesDet2;
        h.xDataTmpCalcDet2 = s.xDataTmpCalcDet2;
        if isfield(s,'FittedPeaksbkpDet2')
            h.FittedPeaksDet2 = s.FittedPeaksbkpDet2;
        else
            h.FittedPeaksDet2 = s.FittedPeaksDet2;
        end
        h.SEDet2 = s.SEDet2;
        h.CIDet2 = s.CIDet2;
        h.FittedPeaksCalctmpDet2 = s.FittedPeaksCalctmpDet2;
        h.XFitDet2 = s.XFitDet2;
        h.YFitDet2 = s.YFitDet2;
        h.XPlotDet2 = s.XPlotDet2;
        h.YPlotDet2 = s.YPlotDet2;
        if strcmp(s.SelMeasDetLEDDIName,'Detector 2')
            FittedPeaksCalctmp = s.FittedPeaksCalctmpDet2;
            XFit = s.XFitDet2;
            YFit = s.YFitDet2;
            XPlot = s.XPlotDet2;
            YPlot = s.YPlotDet2;
        end
    end
end

% Add plots of fitted peaks to axes
h.plotfits = plot(h.axesplotRawData, XPlot, YPlot,'Color','red','LineWidth',1.5);
h.plotfitresidual = plot(h.axesplotRawData,XFit,(YFit - interp1(XPlot,YPlot,XFit)) - (max(YFit) /4),'Color','k','LineWidth',0.5);
% Change YLim
if strcmp(s.MeasDiffTypeName,'EDDI') || strcmp(s.MeasDiffTypeName,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    h.axesplotRawData.YLim =[-Inf round(max(h.DataTmp{valueSlider}(:,2)),-1)];
elseif strcmp(s.MeasDiffTypeName,'LEDDI')
    if strcmp(s.SelMeasDetLEDDIName,'Detector 1')
        Slidersteps = 2:2:length(h.Measurement);
        h.axesplotRawData.YLim =[-Inf round(max(h.DataTmp{Slidersteps(valueSlider)}(:,2)),-1)];
    elseif strcmp(s.SelMeasDetLEDDIName,'Detector 2')
        Slidersteps = 1:2:length(h.Measurement);
        h.axesplotRawData.YLim =[-Inf round(max(h.DataTmp{Slidersteps(valueSlider)}(:,2)),-1)];
    end
end

% Set fit results table data
if h.P.PopupValueFitFunc == 2 %PV-Func
set(h.tablefitresults,'data',[FittedPeaksCalctmp{1,valueSlider}(:,7), FittedPeaksCalctmp{1,valueSlider}(:,1),...
    FittedPeaksCalctmp{1,valueSlider}(:,2),FittedPeaksCalctmp{1,valueSlider}(:,3),...
    FittedPeaksCalctmp{1,valueSlider}(:,5),FittedPeaksCalctmp{1,valueSlider}(:,6),...
    FittedPeaksCalctmp{1,valueSlider}(:,4)])
elseif h.P.PopupValueFitFunc == 3 %TCH-Func
    set(h.tablefitresults,'data',[FittedPeaksCalctmp{1,valueSlider}(:,1), FittedPeaksCalctmp{1,valueSlider}(:,9),...
    FittedPeaksCalctmp{1,valueSlider}(:,2),FittedPeaksCalctmp{1,valueSlider}(:,3),...
    FittedPeaksCalctmp{1,valueSlider}(:,4),FittedPeaksCalctmp{1,valueSlider}(:,5),...
    FittedPeaksCalctmp{1,valueSlider}(:,6),FittedPeaksCalctmp{1,valueSlider}(:,7),...
    FittedPeaksCalctmp{1,valueSlider}(:,8)])
elseif h.P.PopupValueFitFunc == 4 || h.P.PopupValueFitFunc == 5 %PV-Func
set(h.tablefitresults,'data',[FittedPeaksCalctmp{1,valueSlider}(:,6), FittedPeaksCalctmp{1,valueSlider}(:,1),...
    FittedPeaksCalctmp{1,valueSlider}(:,2),FittedPeaksCalctmp{1,valueSlider}(:,3),...
    FittedPeaksCalctmp{1,valueSlider}(:,4),FittedPeaksCalctmp{1,valueSlider}(:,5)])
end

% Set theoretical Peak Pos table title
set(h.texthkltable1,'String',[get(h.texthkltable1,'String') ' - ' h.P.PopupValueMpd1])
% Set Psi File panel fields
set(h.checkboxcreatepsi1,'Value',s.checkboxcreatepsi1);
set(h.editfieldcreatepsi1,'String',s.editfieldcreatepsi1);
set(h.editfieldcreatepsi2,'String',s.editfieldcreatepsi2);
set(h.editfieldcreatepsi3,'String',s.editfieldcreatepsi3);
set(h.editfieldcreatepsi4,'String',s.editfieldcreatepsi4);
set(h.editfieldcreatepsi5,'String',s.editfieldcreatepsi5);
set(h.editfieldcreatepsi6,'String',s.editfieldcreatepsi6);
set(h.editfieldcreatepsi7,'String',s.editfieldcreatepsi7);
set(h.checkboxEditTableData,'Value',s.checkboxEditTableData);
if ~isfield(h, 'MinVal')
    h.MinVal = s.MinVal;
end
% Set psi file table data as originally saved
if strcmp(s.MeasDiffTypeName,'EDDI') || strcmp(s.MeasDiffTypeName,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    h.Psidata = s.Psidata;
    h.PsiFileTableData = s.PsiFileTableData;
    h.PsiFileTableDataBkp = s.PsiFileTableDataBkp;
    set(h.tablepsifile,'data',s.PsiFileTableData);
elseif strcmp(s.MeasDiffTypeName,'LEDDI')
    if strcmp(s.SelMeasDetLEDDIName,'Detector 1')
        h.PsidataDet1 = s.PsidataDet1;
        h.PsiFileTableDataDet1 = s.PsiFileTableDataDet1;
        h.PsiFileTableDataDet1Bkp = s.PsiFileTableDataDet1Bkp;
        set(h.tablepsifile,'data',s.PsiFileTableDataDet1);
    elseif strcmp(s.SelMeasDetLEDDIName,'Detector 2')
        h.PsidataDet2 = s.PsidataDet2;
        h.PsiFileTableDataDet2 = s.PsiFileTableDataDet2;
        h.PsiFileTableDataDet2Bkp = s.PsiFileTableDataDet2Bkp;
        set(h.tablepsifile,'data',s.PsiFileTableDataDet2);
    end
end

if isfield(s, 'idxSelectPeaktable')
    h.idxSelectPeaktable = s.idxSelectPeaktable;
end

if isfield(s, 'idxkeepPeaks')
    h.idxkeepPeaks = s.idxkeepPeaks;
end

guidata(hObj, h);

function NewFileButton(hObj, ~)
% Callback for deleting user input 
h = guidata(hObj);

% Set and delete variables in GUI data
h.Measurement = 0;
h.MeasurementBackup = 0;
h.DataTmp = 0;
h.DataTmpBackup = 0;
h.P.SampleThickness = 0;
% h.P.PopupValueMpd1 = 0;
% h.P.PopupValueMpd2 = 0;
% h.P.PopupValueMpd3 = 0;
% h.P.PopupValueMpd4 = 0;
% h.P.PopupValueMpd5 = 0;
% h.P.PopupValueMpd6 = 0;
h.P.PopupValueFitFunc = 2;

% Set Load measurement File fields
set(h.selectfilename,'String','Select measurement file...')
% Set plot window fields
set(h.Slider,{'Value','Min','Max'}, {1,0,1})
set(h.plotdata,{'xdata','ydata'},{0 0})
set(h.plotdataZoom,{'xdata','ydata'},{0 0})
set(h.plotdataZoomCH,{'xdata','ydata'},{0 0})
set(h.plotEtheo,{'xdata','ydata'},{0 0})
set(h.plotEtheoSub,{'xdata','ydata'},{0 0})
set(h.plotEtheoAdd1, {'xdata','ydata'},{0 0})
set(h.plotEtheoAdd2, {'xdata','ydata'},{0 0})
set(h.plotEtheoAdd3, {'xdata','ydata'},{0 0})
set(h.plotEtheoAdd4, {'xdata','ydata'},{0 0})
set(h.plotEtheoAdd5, {'xdata','ydata'},{0 0})
set(h.axesplotRawData.Title,'String','No measurement data loaded')
h.axesplotRawData.XLim = [0,100];
h.axesplotRawData.YLim = [0,1];
% children = get(h.axesplotdspacing, 'children');
% delete(children)
% assignin('base','axesplotdspacingnewfile',h.axesplotdspacing)
set(h.checkboxtheopeaks1,{'Value','Visible'}, {1,'off'})
set(h.checkboxshifttheopeaks1,{'Value','Visible'}, {0,'off'})
set(h.editshiftEtheo1,{'String','Visible'}, {'delta E','off'})
set(h.plusbuttonshiftEtheo1,'Visible', 'off')
set(h.minusbuttonshiftEtheo1,'Visible', 'off')
set(h.checkboxtheopeaks2,{'Value','Visible'}, {1,'off'})
set(h.checkboxshifttheopeaks2,{'Value','Visible'}, {0,'off'})
set(h.editshiftEtheo2,{'String','Visible'}, {'delta E','off'})
set(h.plusbuttonshiftEtheo2,'Visible', 'off')
set(h.minusbuttonshiftEtheo2,'Visible', 'off')
% Set Select Measurement fields
if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    set(h.popupmenuselectmeas1,{'Value','Enable'}, {2,'off'})
end
set(h.editfieldselectmeas1,'String','')
set(h.editfieldselectmeas2,'String','')
set(h.editfieldselectmeas3,'String','')
set(h.checkboxselectmeas1,'Value',0)
set(h.checkboxselectmeas2,'Value',0)
% Set Background Correction fields
set(h.tablebkgdata,'data', [zeros(1,6);zeros(1,6)])
set(h.checkboxBKG,'Value', 0)
% Set Define Peak fields
set(h.tablepeakdata,'data', zeros(1,6))
set(h.checkboxexportfits,'Value', 1)
set(h.popupmenuFitFunc,'Value', 2)
set(h.checkboxFitBothDetectors,'Value', 0)
% Set Fit results fields
set(h.tablefitresults,'data', zeros(10,7))
% Set Create Psi File fields
set(h.checkboxcreatepsi1,'Value', 0)
set(h.editfieldcreatepsi1,'String','0.015')
set(h.editfieldcreatepsi2,'String','100')
set(h.editfieldcreatepsi3,'String','0.05')
set(h.editfieldcreatepsi4,'String','2')
set(h.editfieldcreatepsi5,'String','0.4')
set(h.editfieldcreatepsi6,'String','0')
set(h.checkboxEditTableData,'Value', 0)
set(h.tablepsifile,'data', zeros(13,23))
% Set theoretical peak positions table data
set(h.tablephasehkl,'data',[num2cell(zeros(12,5)) num2cell(false(12,1))])
set(h.tablephasehkl,'BackgroundColor',ones(12,3))
set(h.tablephasehkl2,'data', zeros(10,5))
set(h.texteditfieldEtheo,'String','Enter elemental formula')
set(h.popupmenumpdEtheo,'Value',1)
% Set Stress analysis fields
set(h.checkboxphi0,'Value', 0)
set(h.checkboxphi90,'Value', 0)
set(h.checkboxphi180,'Value', 0)
set(h.checkboxphi270,'Value', 0)
set(h.SliderStressData,{'Value','Min','Max'}, {1,0,1})
% Set plot properties
h.axesplotdspacing.XLim = [0,1];
h.axesplotdspacing.YLim = [0,1];
h.legdspacing.Visible = 'off';
h.axesplotIB.XLim = [0,1];
h.axesplotIB.YLim = [0,1];
h.legIB.Visible = 'off';
h.axesplotInt.XLim = [0,1];
h.axesplotInt.YLim = [0,1];
h.legInt.Visible = 'off';

title(h.axesplotdspacing,'No measurement data loaded')
title(h.axesplotIB,'No measurement data loaded')
title(h.axesplotInt,'No measurement data loaded')
    
set(h.plotdatadspacingphi0,{'xdata','ydata','YNegativeDelta','YPositiveDelta','Visible'},{0,0,0,0,'off'})
set(h.plotreglinedspacingphi0,{'xdata','ydata','Visible'},{0,0,'off'})
set(h.plotdatadspacingphi90,{'xdata','ydata','YNegativeDelta','YPositiveDelta','Visible'},{0,0,0,0,'off'})
set(h.plotreglinedspacingphi90,{'xdata','ydata','Visible'},{0,0,'off'})
set(h.plotdatadspacingphi180,{'xdata','ydata','YNegativeDelta','YPositiveDelta','Visible'},{0,0,0,0,'off'})
set(h.plotreglinedspacingphi180,{'xdata','ydata','Visible'},{0,0,'off'})
set(h.plotdatadspacingphi270,{'xdata','ydata','YNegativeDelta','YPositiveDelta','Visible'},{0,0,0,0,'off'})
set(h.plotreglinedspacingphi270,{'xdata','ydata','Visible'},{0,0,'off'})

if isfield(h,'plotfits')
    set(h.plotfits,{'xdata','ydata','Visible'},{0,0,'off'})
    set(h.plotfitresidual,{'xdata','ydata','Visible'},{0,0,'off'})
end

set(h.plotdataIBphi0,{'xdata','ydata','Visible'},{0,0,'off'})
set(h.plotdataIBphi90,{'xdata','ydata','Visible'},{0,0,'off'})
set(h.plotdataIBphi180,{'xdata','ydata','Visible'},{0,0,'off'})
set(h.plotdataIBphi270,{'xdata','ydata','Visible'},{0,0,'off'})

set(h.plotdataIntphi0,{'xdata','ydata','Visible'},{0,0,'off'})
set(h.plotdataIntphi90,{'xdata','ydata','Visible'},{0,0,'off'})
set(h.plotdataIntphi180,{'xdata','ydata','Visible'},{0,0,'off'})
set(h.plotdataIntphi270,{'xdata','ydata','Visible'},{0,0,'off'})

set(h.SliderPlotStressData,{'Value','Min','Max'}, {1,0,1})
set(h.plotstressdata,{'xdata','ydata','YNegativeDelta','YPositiveDelta','Visible'},{0,0,0,0,'off'})
delete(findobj(h.axesplotstressdata, 'type', 'scatter', 'visible', 'on'))
h.legstressdata.Visible = 'off';
h.axesplotstressdata.XLim = [0,1];
h.axesplotstressdata.YLim = [0,1];
title(h.axesplotstressdata,'No measurement data loaded')

set(h.SliderFitData,{'Value','Min','Max'}, {1,0,1})
set(h.plotrawdata1,{'xdata','ydata','Visible'},{0,0,'off'})
set(h.plotfitdata1,{'xdata','ydata','Visible'},{0,0,'off'})
set(h.plotresiualdata1,{'xdata','ydata','Visible'},{0,0,'off'})
title(h.axesplotfitdata,'No measurement data loaded')

if isfield(h,'ptext')
    delete(h.ptext)
end

% Set default values for calibration panel
d = zeros(7,5);
set(h.tablecalibangEpos1,'data',d)
set(h.texteditfieldcalibangEpos1,'String','Lattice parameter')
set(h.texteditfieldcalibangEpos2,'String','twotheta')
set(h.texteditfieldcalibangEpos3,'String','deltaE')
set(h.checkboxcalibangEpos1,'value',1)
set(h.checkboxcalibangEpos2,'value',1)
set(h.checkboxcalibangEpos3,'value',1)


% Set plot properties
xlabel(h.axesplotfitdata1,'Choose Data')
ylabel(h.axesplotfitdata1,'Choose Data')
title(h.axesplotfitdata1,{'No measurement data loaded';'   '})
h.axesplotfitdata1.XLim = [0,1];
h.axesplotfitdata1.YLim = [0,1];
h.axesplotfitdata1.YTickMode = 'auto';
h.axesplotfitdata1.YAxis.TickLabelFormat = ' %.1f ';
set(h.popupmenuXData1,'Value',1)
set(h.popupmenuYData1,'Value',1)
set(h.plotwindowfitdata1checkboxphi0,{'Value','Enable'},{0,'on'})
set(h.plotwindowfitdata1checkboxphi90,{'Value','Enable'},{0,'on'})
set(h.plotwindowfitdata1checkboxphi180,{'Value','Enable'},{0,'on'})
set(h.plotwindowfitdata1checkboxphi270,{'Value','Enable'},{0,'on'})

% Set plot properties
xlabel(h.axesplotfitdata2,'Choose Data')
ylabel(h.axesplotfitdata2,'Choose Data')
title(h.axesplotfitdata2,{'No measurement data loaded';'   '})
h.axesplotfitdata2.XLim = [0,1];
h.axesplotfitdata2.YLim = [0,1];
h.axesplotfitdata2.YTickMode = 'auto';
h.axesplotfitdata2.YAxis.TickLabelFormat = ' %.1f ';
set(h.popupmenuXData2,'Value',1)
set(h.popupmenuYData2,'Value',1)
set(h.plotwindowfitdata2checkboxphi0,{'Value','Enable'},{0,'on'})
set(h.plotwindowfitdata2checkboxphi90,{'Value','Enable'},{0,'on'})
set(h.plotwindowfitdata2checkboxphi180,{'Value','Enable'},{0,'on'})
set(h.plotwindowfitdata2checkboxphi270,{'Value','Enable'},{0,'on'})

% Set plot properties
xlabel(h.axesplotfitdata3,'Choose Data')
ylabel(h.axesplotfitdata3,'Choose Data')
title(h.axesplotfitdata3,{'No measurement data loaded';'   '})
h.axesplotfitdata3.XLim = [0,1];
h.axesplotfitdata3.YLim = [0,1];
h.axesplotfitdata3.YTickMode = 'auto';
h.axesplotfitdata3.YAxis.TickLabelFormat = ' %.1f ';
set(h.popupmenuXData3,'Value',1)
set(h.popupmenuYData3,'Value',1)
set(h.plotwindowfitdata3checkboxphi0,{'Value','Enable'},{0,'on'})
set(h.plotwindowfitdata3checkboxphi90,{'Value','Enable'},{0,'on'})
set(h.plotwindowfitdata3checkboxphi180,{'Value','Enable'},{0,'on'})
set(h.plotwindowfitdata3checkboxphi270,{'Value','Enable'},{0,'on'})

% Set plot properties
xlabel(h.axesplotfitdata4,'Choose Data')
ylabel(h.axesplotfitdata4,'Choose Data')
title(h.axesplotfitdata4,{'No measurement data loaded';'   '})
h.axesplotfitdata4.XLim = [0,1];
h.axesplotfitdata4.YLim = [0,1];
h.axesplotfitdata4.YTickMode = 'auto';
h.axesplotfitdata4.YAxis.TickLabelFormat = ' %.1f ';
set(h.popupmenuXData4,'Value',1)
set(h.popupmenuYData4,'Value',1)
set(h.plotwindowfitdata4checkboxphi0,{'Value','Enable'},{0,'on'})
set(h.plotwindowfitdata4checkboxphi90,{'Value','Enable'},{0,'on'})
set(h.plotwindowfitdata4checkboxphi180,{'Value','Enable'},{0,'on'})
set(h.plotwindowfitdata4checkboxphi270,{'Value','Enable'},{0,'on'})

% Clear data from plot    
set(h.fitdata1plotphi0,{'Visible'},{'off'})
set(h.fitdata1plotphi90,{'Visible'},{'off'})
set(h.fitdata1plotphi180,{'Visible'},{'off'})
set(h.fitdata1plotphi270,{'Visible'},{'off'})
set(h.fitdata1ploterrphi0,{'Visible'},{'off'})
set(h.fitdata1ploterrphi90,{'Visible'},{'off'})
set(h.fitdata1ploterrphi180,{'Visible'},{'off'})
set(h.fitdata1ploterrphi270,{'Visible'},{'off'})

set(h.fitdata2plotphi0,{'Visible'},{'off'})
set(h.fitdata2plotphi90,{'Visible'},{'off'})
set(h.fitdata2plotphi180,{'Visible'},{'off'})
set(h.fitdata2plotphi270,{'Visible'},{'off'})
set(h.fitdata2ploterrphi0,{'Visible'},{'off'})
set(h.fitdata2ploterrphi90,{'Visible'},{'off'})
set(h.fitdata2ploterrphi180,{'Visible'},{'off'})
set(h.fitdata2ploterrphi270,{'Visible'},{'off'})

set(h.fitdata3plotphi0,{'Visible'},{'off'})
set(h.fitdata3plotphi90,{'Visible'},{'off'})
set(h.fitdata3plotphi180,{'Visible'},{'off'})
set(h.fitdata3plotphi270,{'Visible'},{'off'})
set(h.fitdata3ploterrphi0,{'Visible'},{'off'})
set(h.fitdata3ploterrphi90,{'Visible'},{'off'})
set(h.fitdata3ploterrphi180,{'Visible'},{'off'})
set(h.fitdata3ploterrphi270,{'Visible'},{'off'})

set(h.fitdata4plotphi0,{'Visible'},{'off'})
set(h.fitdata4plotphi90,{'Visible'},{'off'})
set(h.fitdata4plotphi180,{'Visible'},{'off'})
set(h.fitdata4plotphi270,{'Visible'},{'off'})
set(h.fitdata4ploterrphi0,{'Visible'},{'off'})
set(h.fitdata4ploterrphi90,{'Visible'},{'off'})
set(h.fitdata4ploterrphi180,{'Visible'},{'off'})
set(h.fitdata4ploterrphi270,{'Visible'},{'off'})

% Set legend off
if isfield(h,'legendplotfitdata1')
    set(h.legendplotfitdata1,'Visible','off')
end
if isfield(h,'legendplotfitdata2')
    set(h.legendplotfitdata2,'Visible','off')
end
if isfield(h,'legendplotfitdata3')
    set(h.legendplotfitdata3,'Visible','off')
end
if isfield(h,'legendplotfitdata4')
    set(h.legendplotfitdata4,'Visible','off')
end

% Remove all fields from structure not needed
% tokeep = {'myfig';'TabGroup';'Tabs';'MPDFileNameList';'FluorCellArray';'ElementsString';'Tolerance';'Colors';'T';'Sample';'Measurement';'Substrate';'Diffractometer';'DataTmp';'P';'creatsamplepanel';'textelement1';'editfieldelement1';'textmpd1';'popupmenumpd1';'checkboxsubstrate1';'editfieldelement2';'textmpd2';'popupmenumpd2';'okbutton1';'loadmeasurementpanel';'selectfilename';'openbutton1';'popupmenudiff';'popupmenuscanmode';'popupmenuDTCorr';'correctionspanel';'textcorr1';'checkboxcorrections1';'checkboxcorrections2';'checkboxcorrections3';'textcorr2';'popupmenumeasmode';'samplethickness';'checkboxcorrectionsExportData';'plotpanel';'Slider';'axesplotRawData';'plotdata';'plotEtheo';'plotEtheoAdd1';'plotEtheoAdd2';'plotEtheoAdd3';'plotEtheoAdd4';'plotEtheoAdd5';'plotEtheoSub';'plotFluorAdd1';'axesplotRawDataZoom';'plotdataZoom';'plotdataZoomCH';'checkboxtheopeaks1';'checkboxshifttheopeaks1';'editshiftEtheo1';'plusbuttonshiftEtheo1';'minusbuttonshiftEtheo1';'checkboxtheopeaks2';'checkboxshifttheopeaks2';'editshiftEtheo2';'plusbuttonshiftEtheo2';'minusbuttonshiftEtheo2';'checkboxplotall';'buttonexchangespectra';'selectmeasurementpanel';'textselectmeas1';'popupmenuselectmeas1';'textselectmeas2';'editfieldselectmeas1';'textselectmeas3';'editfieldselectmeas2';'textselectmeas4';'editfieldselectmeas3';'textselectmeas5';'editfieldselectmeas4';'textselectmeas6';'editfieldselectmeas5';'checkboxselectmeas1';'textselectmeas7';'textselectmeas8';'editfieldselectmeas6';'textselectmeas9';'checkboxselectmeas2';'okbuttonselectmeas1';'undobuttonselectmeas1';'backgroundpanel';'textbkg1';'buttonselectbkg1';'buttonselectbkg2';'buttonselectbkg3';'buttonselectbkg7';'buttonselectbkg4';'buttonselectbkg5';'buttonselectbkg6';'buttonselectbkg8';'textbkg2';'tablebkgdata';'checkboxBKG';'fittingpanel';'textpeak1';'buttonselectpeak1';'buttonselectpeak2';'buttonselectpeak3';'buttonselectpeak4';'checkboxexportfits';'textFitFunc';'popupmenuFitFunc';'checkboxFitBothDetectors';'textpeak2';'textpeak3';'textpeak4';'tablepeakdata';'fitresultspanel';'tablefitresults';'createpsifilepanel';'checkboxcreatepsi1';'textcreatepsi2';'editfieldcreatepsi1';'textcreatepsi3';'editfieldcreatepsi2';'textcreatepsi4';'editfieldcreatepsi3';'textcreatepsi5';'editfieldcreatepsi4';'textcreatepsi6';'editfieldcreatepsi5';'textcreatepsi7';'editfieldcreatepsi6';'textcreatepsi8';'editfieldcreatepsi7';'buttoncreatepsi1';'buttoncreatepsi3';'checkboxEditTableData';'tablepsifile';'optionspanel';'buttonoptions1';'buttonoptions2';'buttonoptions3';'buttonoptions4';'calibangEpospanel';'TabGroupCalib';'TabCalib';'textcalibangEpos1';'buttoncalibangEpos1';'buttoncalibangEpos2';'buttoncalibangEpos3';'textcalibangEpos2';'tablecalibangEpos1';'textcalibangEpos3';'texteditfieldcalibangEpos1';'textcalibangEpos4';'texteditfieldcalibangEpos2';'checkboxcalibangEpos1';'textcalibangEpos5';'texteditfieldcalibangEpos3';'checkboxcalibangEpos2';'checkboxcalibangEpos3';'textcalibangEpos6';'buttoncalibangEpos4';'buttoncalibangEpos5';'checkboxcorrEpos1';'tablehklpanel';'texthkltable1';'tablephasehkl';'texthkltable2';'tablephasehkl2';'textelementEtheo';'texteditfieldEtheo';'textmpdEtheo';'popupmenumpdEtheo';'buttonShowEtheoPeaks';'buttonHideEtheoPeaks';'textelementLine';'textelementFluorescence';'textdataFluorescence';'popupmenudataFluorescence';'buttonShowFluorescencePeaks';'buttonHideFluorescencePeaks';'buttonloadDEK1';'buttonloadstressdata1';'textazimuth';'checkboxphi0';'checkboxphi90';'checkboxphi180';'checkboxphi270';'buttonmodifystressdata1';'buttonexportplots1';'buttonexportplots2';'buttonSaveModPsiFile';'buttonSaveModEvalData';'SliderStressData';'Colors2';'axesplotdspacing';'axesplotIB';'axesplotInt';'plotdatadspacingphi0';'plotreglinedspacingphi0';'plotdatadspacingphi90';'plotreglinedspacingphi90';'plotdatadspacingphi180';'plotreglinedspacingphi180';'plotdatadspacingphi270';'plotreglinedspacingphi270';'plotdataIBphi0';'plotdataIBphi90';'plotdataIBphi180';'plotdataIBphi270';'plotdataIntphi0';'plotdataIntphi90';'plotdataIntphi180';'plotdataIntphi270';'plotstresspanel';'SliderPlotStressData';'axesplotstressdata';'plotstressdata';'fitdatapanel';'SliderFitData';'axesplotfitdata';'plotrawdata1';'plotfitdata1';'plotresiualdata1';'modstressXlimbutton';'Xlimfig';'XlimMaxname';'XlimMaxname1';'editXlimMin';'XlimMinname';'XlimMinname1';'editXlimMax';'XlimTickname';'XlimTickname1';'editXlimTick';'AcceptXEditButton';'CancelXEditButton';'modstressYlimbutton';'Ylimfig';'YlimMaxname';'YlimMaxname1';'editYlimMax';'YlimMinname';'YlimMinname1';'editYlimMin';'YlimTickname';'YlimTickname1';'editYlimTick';'AcceptYEditButton';'CancelYEditButton';'figDEKtable';'panelDEKtable';'buttonDEKtable1';'buttonDEKtable2';'buttonDEKtable3';'buttonDEKtable4';'loadDEKtable';'figSelectPeaktable';'panelSelectPeaktable';'buttonSelectPeaktable1';'buttonSelectPeaktable2';'SelectPeaktable';'plotwindowfitdata1';'Sliderplotwindowfitdata1';'axesplotfitdata1';'fitdata1plotphi0';'fitdata1plotphi90';'fitdata1plotphi180';'fitdata1plotphi270';'fitdata1ploterrphi0';'fitdata1ploterrphi90';'fitdata1ploterrphi180';'fitdata1ploterrphi270';'TextPlotData1';'TextXData1';'popupmenuXData1';'TextYData1';'popupmenuYData1';'buttonExportFitData1';'buttonClearFitData1';'TextPhiData1';'plotwindowfitdata1checkboxphi0';'plotwindowfitdata1checkboxphi90';'plotwindowfitdata1checkboxphi180';'plotwindowfitdata1checkboxphi270';'plotwindowfitdata2';'Sliderplotwindowfitdata2';'axesplotfitdata2';'fitdata2plotphi0';'fitdata2plotphi90';'fitdata2plotphi180';'fitdata2plotphi270';'fitdata2ploterrphi0';'fitdata2ploterrphi90';'fitdata2ploterrphi180';'fitdata2ploterrphi270';'TextPlotData2';'TextXData2';'popupmenuXData2';'TextYData2';'popupmenuYData2';'buttonExportFitData2';'buttonClearFitData2';'TextPhiData2';'plotwindowfitdata2checkboxphi0';'plotwindowfitdata2checkboxphi90';'plotwindowfitdata2checkboxphi180';'plotwindowfitdata2checkboxphi270';'plotwindowfitdata3';'Sliderplotwindowfitdata3';'axesplotfitdata3';'fitdata3plotphi0';'fitdata3plotphi90';'fitdata3plotphi180';'fitdata3plotphi270';'fitdata3ploterrphi0';'fitdata3ploterrphi90';'fitdata3ploterrphi180';'fitdata3ploterrphi270';'TextPlotData3';'TextXData3';'popupmenuXData3';'TextYData3';'popupmenuYData3';'buttonExportFitData3';'buttonClearFitData3';'TextPhiData3';'plotwindowfitdata3checkboxphi0';'plotwindowfitdata3checkboxphi90';'plotwindowfitdata3checkboxphi180';'plotwindowfitdata3checkboxphi270';'plotwindowfitdata4';'Sliderplotwindowfitdata4';'axesplotfitdata4';'fitdata4plotphi0';'fitdata4plotphi90';'fitdata4plotphi180';'fitdata4plotphi270';'fitdata4ploterrphi0';'fitdata4ploterrphi90';'fitdata4ploterrphi180';'fitdata4ploterrphi270';'TextPlotData4';'TextXData4';'popupmenuXData4';'TextYData4';'popupmenuYData4';'buttonExportFitData4';'buttonClearFitData4';'TextPhiData4';'plotwindowfitdata4checkboxphi0';'plotwindowfitdata4checkboxphi90';'plotwindowfitdata4checkboxphi180';'plotwindowfitdata4checkboxphi270'};
tokeep = {'myfig';'TabGroup';'Tabs';'MPDFileNameList';'FluorCellArray';'ElementsString';'Tolerance';'Colors';'T';'Sample';'Measurement';'Substrate';'Diffractometer';'DataTmp';'P';'creatsamplepanel';'textelement1';'editfieldelement1';'textmpd1';'popupmenumpd1';'checkboxsubstrate1';'editfieldelement2';'textmpd2';'popupmenumpd2';'okbutton1';'loadmeasurementpanel';'selectfilename';'openbutton1';'popupmenudiff';'popupmenuscanmode';'popupmenuDTCorr';'correctionspanel';'textcorr1';'checkboxcorrections1';'checkboxcorrections2';'checkboxcorrections3';'textcorr2';'popupmenumeasmode';'samplethickness';'checkboxcorrectionsExportData';'plotpanel';'Slider';'axesplotRawData';'plotdata';'plotEtheo';'plotEtheoAdd1';'plotEtheoAdd2';'plotEtheoAdd3';'plotEtheoAdd4';'plotEtheoAdd5';'plotEtheoSub';'plotFluorAdd1';'axesplotRawDataZoom';'plotdataZoom';'plotdataZoomCH';'checkboxtheopeaks1';'checkboxshifttheopeaks1';'editshiftEtheo1';'plusbuttonshiftEtheo1';'minusbuttonshiftEtheo1';'checkboxtheopeaks2';'checkboxshifttheopeaks2';'editshiftEtheo2';'plusbuttonshiftEtheo2';'minusbuttonshiftEtheo2';'checkboxplotall';'buttonexchangespectra';'selectmeasurementpanel';'textselectmeas1';'popupmenuselectmeas1';'textselectmeas2';'editfieldselectmeas1';'textselectmeas3';'editfieldselectmeas2';'textselectmeas4';'editfieldselectmeas3';'textselectmeas5';'editfieldselectmeas4';'textselectmeas6';'editfieldselectmeas5';'checkboxselectmeas1';'textselectmeas7';'textselectmeas8';'editfieldselectmeas6';'textselectmeas9';'checkboxselectmeas2';'okbuttonselectmeas1';'undobuttonselectmeas1';'backgroundpanel';'textbkg1';'buttonselectbkg1';'buttonselectbkg2';'buttonselectbkg3';'buttonselectbkg7';'buttonselectbkg4';'buttonselectbkg5';'buttonselectbkg6';'buttonselectbkg8';'textbkg2';'tablebkgdata';'checkboxBKG';'fittingpanel';'textpeak1';'buttonselectpeak1';'buttonselectpeak2';'buttonselectpeak3';'buttonselectpeak4';'checkboxexportfits';'textFitFunc';'popupmenuFitFunc';'checkboxFitBothDetectors';'textpeak2';'textpeak3';'textpeak4';'textpeak5';'tablepeakdata';'fitresultspanel';'tablefitresults';'createpsifilepanel';'checkboxcreatepsi1';'textcreatepsi2';'editfieldcreatepsi1';'textcreatepsi3';'editfieldcreatepsi2';'textcreatepsi4';'editfieldcreatepsi3';'textcreatepsi5';'editfieldcreatepsi4';'textcreatepsi6';'editfieldcreatepsi5';'textcreatepsi7';'editfieldcreatepsi6';'textcreatepsi8';'editfieldcreatepsi7';'buttoncreatepsi1';'buttoncreatepsi2';'buttoncreatepsi3';'checkboxEditTableData';'tablepsifile';'optionspanel';'buttonoptions1';'buttonoptions2';'buttonoptions3';'buttonoptions4';'calibangEpospanel';'TabGroupCalib';'TabCalib';'textcalibangEpos1';'buttoncalibangEpos1';'buttoncalibangEpos2';'buttoncalibangEpos3';'textcalibangEpos2';'tablecalibangEpos1';'textcalibangEpos3';'texteditfieldcalibangEpos1';'textcalibangEpos4';'texteditfieldcalibangEpos2';'checkboxcalibangEpos1';'textcalibangEpos5';'texteditfieldcalibangEpos3';'checkboxcalibangEpos2';'checkboxcalibangEpos3';'textcalibangEpos6';'buttoncalibangEpos4';'buttoncalibangEpos5';'textfield1';'textfield2';'textfield3';'textfield4';'textfield5';'textfieldpwparam1';'texteditfieldpwparam1';'textfieldpwparam2';'texteditfieldpwparam2';'textfieldpwparam3';'texteditfieldpwparam3';'textfieldpwparam4';'texteditfieldpwparam4';'textfieldpwparam5';'texteditfieldpwparam5';'buttonPWCorrEpos';'buttonPWCorrUndo';'tablehklpanel';'texthkltable1';'tablephasehkl';'texthkltable2';'tablephasehkl2';'textelementEtheo';'texteditfieldEtheo';'textmpdEtheo';'popupmenumpdEtheo';'buttonShowEtheoPeaks';'buttonHideEtheoPeaks';'textelementLine';'textelementFluorescence';'textdataFluorescence';'popupmenudataFluorescence';'buttonShowFluorescencePeaks';'buttonHideFluorescencePeaks';'buttonloadDEK1';'buttonloadstressdata1';'textazimuth';'checkboxphi0';'checkboxphi90';'checkboxphi180';'checkboxphi270';'buttonmodifystressdata1';'buttonexportplots1';'buttonexportplots2';'buttonSaveModPsiFile';'buttonSaveModEvalData';'SliderStressData';'Colors2';'axesplotdspacing';'axesplotIB';'axesplotInt';'plotdatadspacingphi0';'plotreglinedspacingphi0';'plotdatadspacingphi90';'plotreglinedspacingphi90';'plotdatadspacingphi180';'plotreglinedspacingphi180';'plotdatadspacingphi270';'plotreglinedspacingphi270';'plotdataIBphi0';'plotdataIBphi90';'plotdataIBphi180';'plotdataIBphi270';'plotdataIntphi0';'plotdataIntphi90';'plotdataIntphi180';'plotdataIntphi270';'plotstresspanel';'SliderPlotStressData';'axesplotstressdata';'plotstressdata';'fitdatapanel';'SliderFitData';'axesplotfitdata';'plotrawdata1';'plotfitdata1';'plotresiualdata1';'modstressXlimbutton';'Xlimfig';'XlimMaxname';'XlimMaxname1';'editXlimMin';'XlimMinname';'XlimMinname1';'editXlimMax';'XlimTickname';'XlimTickname1';'editXlimTick';'AcceptXEditButton';'CancelXEditButton';'modstressYlimbutton';'Ylimfig';'YlimMaxname';'YlimMaxname1';'editYlimMax';'YlimMinname';'YlimMinname1';'editYlimMin';'YlimTickname';'YlimTickname1';'editYlimTick';'AcceptYEditButton';'CancelYEditButton';'loadtaudatabutton';'fighklstressplottable';'selecthklvaluesbutton';'panelhklstressplottable';'buttonhklstressplottable1';'buttonhklstressplottable2';'Selecthkltable';'figDEKtable';'panelDEKtable';'buttonDEKtable1';'buttonDEKtable2';'buttonDEKtable3';'buttonDEKtable4';'loadDEKtable';'figSelectPeaktable';'panelSelectPeaktable';'buttonSelectPeaktable1';'buttonSelectPeaktable2';'SelectPeaktable';'plotwindowfitdata1';'Sliderplotwindowfitdata1';'axesplotfitdata1';'fitdata1plotphi0';'fitdata1plotphi90';'fitdata1plotphi180';'fitdata1plotphi270';'fitdata1ploterrphi0';'fitdata1ploterrphi90';'fitdata1ploterrphi180';'fitdata1ploterrphi270';'TextPlotData1';'TextXData1';'popupmenuXData1';'TextYData1';'popupmenuYData1';'buttonExportFitData1';'buttonClearFitData1';'TextPhiData1';'plotwindowfitdata1checkboxphi0';'plotwindowfitdata1checkboxphi90';'plotwindowfitdata1checkboxphi180';'plotwindowfitdata1checkboxphi270';'plotwindowfitdata2';'Sliderplotwindowfitdata2';'axesplotfitdata2';'fitdata2plotphi0';'fitdata2plotphi90';'fitdata2plotphi180';'fitdata2plotphi270';'fitdata2ploterrphi0';'fitdata2ploterrphi90';'fitdata2ploterrphi180';'fitdata2ploterrphi270';'TextPlotData2';'TextXData2';'popupmenuXData2';'TextYData2';'popupmenuYData2';'buttonExportFitData2';'buttonClearFitData2';'TextPhiData2';'plotwindowfitdata2checkboxphi0';'plotwindowfitdata2checkboxphi90';'plotwindowfitdata2checkboxphi180';'plotwindowfitdata2checkboxphi270';'plotwindowfitdata3';'Sliderplotwindowfitdata3';'axesplotfitdata3';'fitdata3plotphi0';'fitdata3plotphi90';'fitdata3plotphi180';'fitdata3plotphi270';'fitdata3ploterrphi0';'fitdata3ploterrphi90';'fitdata3ploterrphi180';'fitdata3ploterrphi270';'TextPlotData3';'TextXData3';'popupmenuXData3';'TextYData3';'popupmenuYData3';'buttonExportFitData3';'buttonClearFitData3';'TextPhiData3';'plotwindowfitdata3checkboxphi0';'plotwindowfitdata3checkboxphi90';'plotwindowfitdata3checkboxphi180';'plotwindowfitdata3checkboxphi270';'plotwindowfitdata4';'Sliderplotwindowfitdata4';'axesplotfitdata4';'fitdata4plotphi0';'fitdata4plotphi90';'fitdata4plotphi180';'fitdata4plotphi270';'fitdata4ploterrphi0';'fitdata4ploterrphi90';'fitdata4ploterrphi180';'fitdata4ploterrphi270';'TextPlotData4';'TextXData4';'popupmenuXData4';'TextYData4';'popupmenuYData4';'buttonExportFitData4';'buttonClearFitData4';'TextPhiData4';'plotwindowfitdata4checkboxphi0';'plotwindowfitdata4checkboxphi90';'plotwindowfitdata4checkboxphi180';'plotwindowfitdata4checkboxphi270';'uplotoptionspanel';'buttonloaduplotdata1';'tableuplotdspacing';'textsamplethickness';'editsamplethickness';'textuserdzero';'userdzerocheckbox';'textdzerozgradient';'dzerozgradientcheckbox';'textsdzeropoly1';'editdzeropoly1';'textsdzeropoly2';'editdzeropoly2';'textsdzeropoly3';'editdzeropoly3';'textsdzeropoly4';'textsdzeropoly5';'textsin2psirange';'textsin2psirange1';'editsin2psirange1';'textsin2psirange2';'editsin2psirange2';'textfilter1';'filteruplotdatacheckbox';'textfilter2';'textfilter1sigma11';'editfilter1sigma11';'textfilter2sigma11';'textfilter3sigma11';'editfilter2sigma11';'textfilter4sigma11';'textfilter1sigma13';'editfilter1sigma13';'textfilter2sigma13';'textfilter3sigma13';'editfilter2sigma13';'textfilter4sigma13';'textfilter1sigma22';'editfilter1sigma22';'textfilter2sigma22';'textfilter3sigma22';'editfilter2sigma22';'textfilter4sigma22';'textfilter1sigma23';'editfilter1sigma23';'textfilter2sigma23';'textfilter3sigma23';'editfilter2sigma23';'textfilter4sigma23';'uplotplotfitscheckbox';'textplotfits1';'textplotfits11';'textplotfits12';'textplotfits13';'textdegreepoly1';'editdegree1';'dampingcheckbox1';'textdamping1';'textplotfits21';'textplotfits22';'textplotfits23';'textdegreepoly2';'editdegree2';'dampingcheckbox2';'textdamping2';'textplotfits31';'textplotfits32';'textplotfits33';'textdegreepoly3';'editdegree3';'dampingcheckbox3';'textdamping3';'textplotfits41';'textplotfits42';'textplotfits43';'textdegreepoly4';'editdegree4';'dampingcheckbox4';'textdamping4';'ShowCIboundscheckbox';'buttonplotuplotdata';'buttonplotdsin2psi';'exportrecalcdcheckbox';'textexportrecalcd';'buttonclearuplotdata';'buttonexportuplotdata';'uplotplotpanel';'axesuplotdatasigma11';'uplotdatasigma11';'ChangeAxLimcheckbox1';'textXlimmin1';'editXlimmin1';'textXlimmax1';'editXlimmax1';'textXlimtick1';'editXlimtick1';'textYlimmin1';'editYlimmin1';'textYlimmax1';'editYlimmax1';'textYlimtick1';'editYlimtick1';'axesuplotdatasigma13';'uplotdatasigma13';'ChangeAxLimcheckbox2';'textXlimmin2';'editXlimmin2';'textXlimmax2';'editXlimmax2';'textXlimtick2';'editXlimtick2';'textYlimmin2';'editYlimmin2';'textYlimmax2';'editYlimmax2';'textYlimtick2';'editYlimtick2';'axesuplotdatasigma22';'uplotdatasigma22';'ChangeAxLimcheckbox3';'textXlimmin3';'editXlimmin3';'textXlimmax3';'editXlimmax3';'textXlimtick3';'editXlimtick3';'textYlimmin3';'editYlimmin3';'textYlimmax3';'editYlimmax3';'textYlimtick3';'editYlimtick3';'axesuplotdatasigma23';'uplotdatasigma23';'ChangeAxLimcheckbox4';'textXlimmin4';'editXlimmin4';'textXlimmax4';'editXlimmax4';'textXlimtick4';'editXlimtick4';'textYlimmin4';'editYlimmin4';'textYlimmax4';'editYlimmax4';'textYlimtick4';'editYlimtick4'}; %'PhaseAnalysisLoadDataPanel';'LoadMeasDataQAText1';'LoadMeasDataQA';'openbuttonQA1';'okbuttonQA1';'popupmenudiffQA';'popupmenuscanmodeQA';'popupmenuDTCorrQA';'SelectMeasDataQAText1';'SelectMeasDataQAText2';'PopupMenuSelectDetQA';'SelectMeasDataQAText3';'SelectMeasDataQAedit1';'SelectMeasDataQAText4';'SelectMeasDataQAedit2';'SelectPeaksQAText1';'SelectBKGbuttonQA';'SelectPeaksbuttonQA';'FitPeaksbuttonQA';'ClearDatabuttonQA';'tablepeaksQA';'CheckFluorPosQAText1';'CheckFluorPosQAText2';'tableFluorQA';'CheckFluorPeaksbuttonQA';'LoadMeasDataQAText2';'openPeriodicTablebutton';'SelectedElementsQAedit1';'SelectElementsQAText1';'SelectedElementsQAedit2';'SelectElementsQAText2';'SelectedElementsQAedit3';'StartPeakMatchbutton';'PhaseAnalysisPlotDataPanel';'SliderQA';'axesplotMeasDataQA';'plotdataQA';'PhaseAnalysisResultTablePanel';'tableresultsSAMQA';'AddFluorLinesTablePanel';'orderFluorElements';'AddFluorLinestable'};
f = fieldnames(h);
toRemove = f(~ismember(f,tokeep));
h = rmfield(h,toRemove);

% set(h.checkboxTauData,'Value', 0)

set(h.loadDEKtable,'data', zeros(20,5))
d = zeros(8,1);
idxdata = d(:)>0;
set(h.SelectPeaktable,'data', [num2cell(d) num2cell(idxdata)])
% assignin('base','axesplotdspacingnewfile',h.axesplotdspacing)
if size(h.axesplotdspacing.Children,1) == 9
    delete(h.axesplotdspacing.Children(1))
end
% assignin('base','axesplotdspacingnewfilemod',h.axesplotdspacing)

guidata(hObj, h);

% Slider callbacks Tab(1)
function SliderCallbackPlotRawData(hObj, ~)
% This callback handles the changes when the slider button is pushed.
h = guidata(hObj);
% Get slider value
value = get(hObj, 'Value');
value = round(value);

Detstr = get(h.popupmenuselectmeas1,'String');
Detval = get(h.popupmenuselectmeas1,'Value');
Detsel = Detstr{Detval};
h.Detsel = Detsel;

% Set plot data and plot ranges/limits for different diffractometers
if strcmp(h.Diffsel,'LEDDI')
    % If LEDDI has been used for the measurement
    if strcmp(h.Detsel,'Detector 1')
        % In order to analyze the data measured with Det1, the following
        % Slidersteps have to be used
        Slidersteps = 2:2:length(h.Measurement);
        % Set plot data according to the current slider value
        set(h.plotdata,'xdata',h.DataTmp{Slidersteps(value)}(:,1))
        set(h.plotdata,'ydata',h.DataTmp{Slidersteps(value)}(:,2))
        set(h.plotdataZoom,'xdata',h.DataTmp{Slidersteps(value)}(:,1))
        set(h.plotdataZoom,'ydata',h.DataTmp{Slidersteps(value)}(:,2))
        % Set XLim of plot and define YLim for theoretical peak positions,
        % depending on whether an energy range has been selected by the
        % user or not
        if isfield(h, 'EnergyRangeDet1')
            h.axesplotRawData.XLim = h.P.EnergyRangeDet1;
            a = h.TPeaksDet1.T.Etheo > h.P.EnergyRangeDet1(1) & h.TPeaksDet1.T.Etheo < h.P.EnergyRangeDet1(2);
            EtheoLimit = h.TPeaksDet1.T.Etheo(a);
            Y3Limit = h.TPeaksDet1.T.Y3((1:(3*length(EtheoLimit)-1)),:);
            set(h.plotEtheo,'ydata',Y3Limit(:,value).*(max(h.DataTmp{Slidersteps(value)}(:,2))/max(Y3Limit(:,value))))
        else             
            a = h.TPeaksDet1.T.Etheo < h.TPeaksDet1.T.EMax;
            EtheoLimit = h.TPeaksDet1.T.Etheo(a);
            h.axesplotRawData.XLim = [0, 60];
            Y3Limit = h.TPeaks.T.Y3((1:(3*length(EtheoLimit)-1)),:);
            set(h.plotEtheo,'ydata',Y3Limit(:,Slidersteps(value)).*(max(h.DataTmp{Slidersteps(value)}(:,2))/max(Y3Limit(:,Slidersteps(value)))))
        end
        % Set Ylim of the plot and the theoretical peak positions
        h.axesplotRawData.YLim =[-Inf round(max(h.DataTmp{Slidersteps(value)}(:,2)),-1)];
        % Set title according to current slider value
        set(h.axesplotRawData.Title,'String',['Measurement Data for ', h.Measurement(Slidersteps(value)).Name])
    elseif strcmp(h.Detsel,'Detector 2')
        % In order to analyze the data measured with Det2, the following
        % Slidersteps have to be used
        Slidersteps = 1:2:length(h.Measurement);   
        % Set plot data according to the current slider value
        set(h.plotdata,'xdata',h.DataTmp{Slidersteps(value)}(:,1))
        set(h.plotdata,'ydata',h.DataTmp{Slidersteps(value)}(:,2))
        set(h.plotdataZoom,'xdata',h.DataTmp{Slidersteps(value)}(:,1))
        set(h.plotdataZoom,'ydata',h.DataTmp{Slidersteps(value)}(:,2))
        % Set XLim of plot and define YLim for theoretical peak positions,
        % depending on whether an energy range has been selected by the
        % user or not
        if isfield(h, 'EnergyRangeDet2')
            h.axesplotRawData.XLim = h.P.EnergyRangeDet2;
            a = h.TPeaksDet2.T.Etheo > h.P.EnergyRangeDet2(1) & h.TPeaksDet2.T.Etheo < h.P.EnergyRangeDet2(2);
            EtheoLimit = h.TPeaksDet2.T.Etheo(a);
            Y3Limit = h.TPeaksDet2.T.Y3((1:(3*length(EtheoLimit)-1)),:);
            set(h.plotEtheo,'ydata',Y3Limit(:,value).*(max(h.DataTmp{Slidersteps(value)}(:,2))/max(Y3Limit(:,value))))
        else
            h.TPeaksDet2 = TheoreticalPeakPositions(h.Measurement(Slidersteps),h.DataTmp(Slidersteps));
            a = h.TPeaksDet2.T.Etheo < h.TPeaksDet2.T.EMax;
            EtheoLimit = h.TPeaksDet2.T.Etheo(a);
            h.axesplotRawData.XLim = [0, 60];
            Y3Limit = h.TPeaks.T.Y3((1:(3*length(EtheoLimit)-1)),:);
            set(h.plotEtheo,'ydata',Y3Limit(:,Slidersteps(value)).*(max(h.DataTmp{Slidersteps(value)}(:,2))/max(Y3Limit(:,value))))
        end
        % Set Ylim of the plot and the theoretical peak positions
        h.axesplotRawData.YLim =[-Inf round(max(h.DataTmp{Slidersteps(value)}(:,2)),-1)];
        % Set title according to current slider value
        set(h.axesplotRawData.Title,'String',['Measurement Data for ', h.Measurement(Slidersteps(value)).Name])
    end
else
    % Calculate max. ydata of theoretical line positions of sample
    h.TPeaks = TheoreticalPeakPositions(h.Measurement,h.DataTmp);
    if isfield(h,'EnergyRange')
        a = h.P.EnergyRange(1) < h.TPeaks.T.Etheo & h.TPeaks.T.Etheo < h.TPeaks.T.EMax;
    else
        a = h.TPeaks.T.Etheo < h.TPeaks.T.EMax;
    end
    h.FitPeaksLogicalErange = a;
%     EtheoLimit = h.TPeaks.T.Etheo(a);
    if h.checkboxplotall == 1
        if strcmp(h.Diffsel,'LEDDI')
        % If LEDDI has been used for the measurement
            if strcmp(h.Detsel,'Detector 1')
                Slidersteps = 2:2:length(h.Measurement);
                % Set plot data
                set(h.plotdata,'xdata',h.DataTmp{Slidersteps(value)}(:,1))
                set(h.plotdata,'ydata',h.DataTmp{Slidersteps(value)}(:,2))
                set(h.plotdataZoom,'xdata',h.DataTmp{Slidersteps(value)}(:,1))
                set(h.plotdataZoom,'ydata',h.DataTmp{Slidersteps(value)}(:,2))
                uistack(h.plotdata,'top');
            elseif strcmp(h.Detsel,'Detector 2')
                Slidersteps = 1:2:length(h.Measurement);
                % Set plot data
                set(h.plotdata,'xdata',h.DataTmp{Slidersteps(value)}(:,1))
                set(h.plotdata,'ydata',h.DataTmp{Slidersteps(value)}(:,2))
                set(h.plotdataZoom,'xdata',h.DataTmp{Slidersteps(value)}(:,1))
                set(h.plotdataZoom,'ydata',h.DataTmp{Slidersteps(value)}(:,2))
                uistack(h.plotdata,'top');
            end
        else
            % Set plot data
            set(h.plotdata,'xdata',h.DataTmp{1}(:,1))
            set(h.plotdata,'ydata',h.DataTmp{valueSlider}(:,2))

            uistack(h.plotdata,'top');
        end
    else
        % If EDDI or MetalJet has been used for the measurement
        % Set plot data according to the current slider value
        set(h.plotdata,'xdata',h.DataTmp{value}(:,1))
        set(h.plotdata,'ydata',h.DataTmp{value}(:,2))
        set(h.plotdataZoom,'xdata',h.DataTmp{value}(:,1))
        set(h.plotdataZoom,'ydata',h.DataTmp{value}(:,2))
        % Define and set YLim for theoretical peak positions
        Y3Limit = h.TPeaks.T.Y3((1:(3*find(a, 1, 'last')-1)),:);
        set(h.plotEtheo,'ydata',Y3Limit(:,value).*(max(h.DataTmp{1,value}(:,2))/max(Y3Limit(:,value))))
        % Set title according to current slider value
        set(h.axesplotRawData.Title,'String',['Measurement Data for ', h.Measurement(round(value)).Name])
    end
end

% Set ydata for backgroundpoints according to current slider value
if isfield(h, 'plotbkgpoints')
    if strcmp(h.Diffsel,'LEDDI')
    % If LEDDI has been used for the measurement
        if strcmp(h.Detsel,'Detector 1')
            if isfield(h, 'PeakRegionsXDet1')
                % Set background table data according to current slider value
                set(h.tablebkgdata,'data',h.PeakRegionsXDet1{value})
                % Set plot data for BKG points according to current slider value
                set(h.plotbkgpoints,'XData',[h.PeakRegionsXdataDet1{value,:}])
                set(h.plotbkgpoints,'YData',[h.PeakRegionsYdataDet1{value,:}])
            end
        elseif strcmp(h.Detsel,'Detector 2')
            if isfield(h, 'PeakRegionsXDet2')
                % Set background table data according to current slider value
                set(h.tablebkgdata,'data',h.PeakRegionsXDet2{value})
                % Set plot data for BKG points according to current slider value
                set(h.plotbkgpoints,'XData',[h.PeakRegionsXdataDet2{value,:}])
                set(h.plotbkgpoints,'YData',[h.PeakRegionsYdataDet2{value,:}])
            end
        end
    else
        % Set background table data according to current slider value
        set(h.tablebkgdata,'data',h.PeakRegionsX{value})
        % Set plot data for BKG points according to current slider value
        set(h.plotbkgpoints,'XData',[h.PeakRegionsXdata{value,:}])
        set(h.plotbkgpoints,'YData',[h.PeakRegionsYdata{value,:}])
    end
end

% Set ydata for peak positions according to current slider value
if isfield(h, 'plotpeakpoints')
    if strcmp(h.Diffsel,'LEDDI')
    % If LEDDI has been used for the measurement
        if strcmp(h.Detsel,'Detector 1')
            if isfield(h, 'DataInterpPeaksDet1')
                Slidersteps = 2:2:length(h.Measurement);
                % Interpolate RawData to get YData for PeakRegions
                h.DataInterpPeaksDet1 = interp1(h.DataTmp{Slidersteps(value)}(:,1),h.DataTmp{Slidersteps(value)}(:,2),h.PeaksDet1{value});
                % Set plot data according to current slider value
                set(h.plotpeakpoints,'XData',h.PeaksDet1{value})
                set(h.plotpeakpoints,'YData',h.DataInterpPeaksDet1)
                % Set peak table data according to current slider value
                set(h.tablepeakdata,'data',[h.PeaksDet1{value};h.Peakslb{value};h.Peaksub{value}])
%                 TablePeakData = get(h.tablepeakdata,'data');
%                 TablePeakData(2,:) = h.Peakslb{value};
%                 TablePeakData(3,:) = h.Peaksub{value};
%                 set(h.tablepeakdata,'data',TablePeakData)
            end
        elseif strcmp(h.Detsel,'Detector 2')
            if isfield(h, 'DataInterpPeaksDet2')
                Slidersteps = 1:2:length(h.Measurement);
                % Interpolate RawData to get YData for PeakRegions
                h.DataInterpPeaksDet2 = interp1(h.DataTmp{Slidersteps(value)}(:,1),h.DataTmp{Slidersteps(value)}(:,2),h.PeaksDet2{value});
                % Set plot data according to current slider value
                set(h.plotpeakpoints,'XData',h.PeaksDet2{value})
                set(h.plotpeakpoints,'YData',h.DataInterpPeaksDet2)
                % Set peak table data according to current slider value
                set(h.tablepeakdata,'data',[h.PeaksDet2{value};h.Peakslb{value};h.Peaksub{value}])
%                 TablePeakData = get(h.tablepeakdata,'data');
%                 TablePeakData(2,:) = h.Peakslb{value};
%                 TablePeakData(3,:) = h.Peaksub{value};
%                 set(h.tablepeakdata,'data',TablePeakData)
            end
        end
    else
        % Calcualte data positions for user defined peak positions
        h.DataInterpPeakSlider = interp1(h.DataTmp{value}(:,1),h.DataTmp{value}(:,2),h.Peaks{value});
        % Set plot data according to current slider value
        set(h.plotpeakpoints,'XData',h.Peaks{value})
        set(h.plotpeakpoints,'YData',h.DataInterpPeakSlider)
        % Set peak table data according to current slider value
        set(h.tablepeakdata,'data',[h.Peaks{value};h.Peakslb{value};h.Peaksub{value}])
%         TablePeakData = get(h.tablepeakdata,'data');
%         TablePeakData(2,:) = h.Peakslb{value};
%         TablePeakData(3,:) = h.Peaksub{value};
%         set(h.tablepeakdata,'data',TablePeakData)
    end
end

% Show proposed background correction according to current slider value
if isfield(h, 'plotBKG')
    if strcmp(h.Diffsel,'LEDDI')
    % If LEDDI has been used for the measurement
        if strcmp(h.Detsel,'Detector 1')
            if isfield(h, 'DataTmpToAcceptDet1')
                % Set plot data according to current slider value
                set(h.plotBKG,'xdata',h.DataTmpToAcceptDet1{value}(:,1))
                set(h.plotBKG,'ydata',h.DataTmpToAcceptDet1{value}(:,2))
            end
        elseif strcmp(h.Detsel,'Detector 2')
            if isfield(h, 'DataTmpToAcceptDet2')
                % Set plot data according to current slider value
                set(h.plotBKG,'xdata',h.DataTmpToAcceptDet2{value}(:,1))
                set(h.plotBKG,'ydata',h.DataTmpToAcceptDet2{value}(:,2))
            end
        end
    else
        % Set plot data according to current slider value
        set(h.plotBKG,'xdata',h.DataTmpToAccept{value}(:,1))
        set(h.plotBKG,'ydata',h.DataTmpToAccept{value}(:,2))
    end
end

% Set Ylim for fitted background data according to current slider value
if isfield(h, 'DataTmpBackgroundCorrData')
    h.axesplotRawData.YLim =[-Inf round(max(h.DataTmp{value}(:,2)),-1)];
end

% Set data of fitted plots according to current slider value
if isfield(h, 'FittedPeaks') 
    % Set RawData for current slider value
    XFit = h.DataTmp{value}(:, 1);
    YFit = h.DataTmp{value}(:, 2);
    % Set Fit-Data for current slider value
    XPlot = XFit(1):0.001:XFit(end);
    YPlot = zeros(size(XPlot));
    % Calculate fitted profile using Fitted PeakData for current slider
    % value
    for d = 1:size(h.FittedPeaks{value}, 1)
        if h.P.PopupValueFitFunc == 2 %PV-Func
            SinglePlot = Tools.Science.Math.FF_PseudoVoigt(XPlot, ...
                h.FittedPeaks{value}(d, 1), h.FittedPeaks{value}(d, 2), h.FittedPeaks{value}(d, 3),h.FittedPeaks{value}(d, 4));
        elseif h.P.PopupValueFitFunc == 3 %TCH-Func
            SinglePlot = Tools.Science.Math.FF_TCH(XPlot, ...
                h.FittedPeaks{value}(d, 1), h.FittedPeaks{value}(d, 2), h.FittedPeaks{value}(d, 3),h.FittedPeaks{value}(d, 4));
        elseif h.P.PopupValueFitFunc == 4 %Gauss-Func
            SinglePlot = Tools.Science.Math.FF_Gauss(XPlot, ...
                h.FittedPeaks{value}(d, 1), h.FittedPeaks{value}(d, 2), h.FittedPeaks{value}(d, 3));
        elseif h.P.PopupValueFitFunc == 5 %Lorentz-Func
            SinglePlot = Tools.Science.Math.FF_Lorentz(XPlot, ...
                h.FittedPeaks{value}(d, 1), h.FittedPeaks{value}(d, 2), h.FittedPeaks{value}(d, 3)); 
        end
            YPlot = YPlot + SinglePlot;
    end
    % Add plots of fitted peaks and residual to axes according to current 
    % slider value
    set(h.plotfits,'xdata',XPlot)
    set(h.plotfits,'ydata',YPlot)
    % Set data of plot residual according to current slider value
    set(h.plotfitresidual,'xdata',XFit)
    YDataResidual = (YFit - interp1(XPlot,YPlot,XFit)) - (max(YFit) /4);
    set(h.plotfitresidual,'ydata', YDataResidual)
    % Set Ylim according to current slider value
    h.axesplotRawData.YLim = [-Inf round(max(h.DataTmp{value}(:,2)),-1)];
end

if strcmp(h.Diffsel,'LEDDI')
    if strcmp(h.Detsel,'Detector 1')
        if isfield(h, 'FittedPeaksDet1')
            Slidersteps = 2:2:length(h.Measurement);
            % Set RawData for current slider value
            XFit = h.DataTmp{Slidersteps(value)}(:, 1);
            YFit = h.DataTmp{Slidersteps(value)}(:, 2);
            % Set Fit-Data for current slider value
            XPlot = XFit(1):0.001:XFit(end);
            YPlot = zeros(size(XPlot));
            % Calculate fitted profile using Fitted PeakData for current slider
            % value
            for d = 1:size(h.FittedPeaksDet1{value}, 1)
                if h.P.PopupValueFitFunc == 2 %PV-Func
                    SinglePlot = Tools.Science.Math.FF_PseudoVoigt(XPlot, ...
                        h.FittedPeaksDet1{value}(d, 1), h.FittedPeaksDet1{value}(d, 2), h.FittedPeaksDet1{value}(d, 3),h.FittedPeaksDet1{value}(d, 4));
                elseif h.P.PopupValueFitFunc == 3 %TCH-Func
                    SinglePlot = Tools.Science.Math.FF_TCH(XPlot, ...
                        h.FittedPeaksDet1{value}(d, 1), h.FittedPeaksDet1{value}(d, 2), h.FittedPeaksDet1{value}(d, 3),h.FittedPeaksDet1{value}(d, 4));
                elseif h.P.PopupValueFitFunc == 4 %Gauss-Func
                    SinglePlot = Tools.Science.Math.FF_Gauss(XPlot, ...
                        h.FittedPeaksDet1{value}(d, 1), h.FittedPeaksDet1{value}(d, 2), h.FittedPeaksDet1{value}(d, 3));
                elseif h.P.PopupValueFitFunc == 5 %Lorentz-Func
                    SinglePlot = Tools.Science.Math.FF_Lorentz(XPlot, ...
                        h.FittedPeaksDet1{value}(d, 1), h.FittedPeaksDet1{value}(d, 2), h.FittedPeaksDet1{value}(d, 3));
                end
                    YPlot = YPlot + SinglePlot;
            end
            % Add plots of fitted peaks and residual to axes according to current 
            % slider value
            set(h.plotfits,'xdata',XPlot)
            set(h.plotfits,'ydata',YPlot)
            % Set data of plot residual according to current slider value
            set(h.plotfitresidual,'xdata',XFit)
            YDataResidual = (YFit - interp1(XPlot,YPlot,XFit)) - (max(YFit) /4);
            set(h.plotfitresidual,'ydata', YDataResidual)
            % Set Ylim according to current slider value
            h.axesplotRawData.YLim = [-Inf round(max(h.DataTmp{Slidersteps(value)}(:,2)),-1)];
            if h.P.PopupValueFitFunc == 2 %PV-Func
                set(h.tablefitresults,'data',[h.FittedPeaksCalctmpDet1{1,value}(:,7), h.FittedPeaksCalctmpDet1{1,value}(:,1),...
                    h.FittedPeaksCalctmpDet1{1,value}(:,2),h.FittedPeaksCalctmpDet1{1,value}(:,3),...
                    h.FittedPeaksCalctmpDet1{1,value}(:,5),h.FittedPeaksCalctmpDet1{1,value}(:,6),...
                    h.FittedPeaksCalctmpDet1{1,value}(:,4)])
            elseif h.P.PopupValueFitFunc == 3 %TCH-Func
                set(h.tablefitresults,'data',[h.FittedPeaksCalctmpDet1{1,value}(:,1), h.FittedPeaksCalctmpDet1{1,value}(:,9),...
                    h.FittedPeaksCalctmpDet1{1,value}(:,2),h.FittedPeaksCalctmpDet1{1,value}(:,3),...
                    h.FittedPeaksCalctmpDet1{1,value}(:,4),h.FittedPeaksCalctmpDet1{1,value}(:,5),...
                    h.FittedPeaksCalctmpDet1{1,value}(:,6),h.FittedPeaksCalctmpDet1{1,value}(:,7),...
                    h.FittedPeaksCalctmpDet1{1,value}(:,8)])
            end
        end
    elseif strcmp(h.Detsel,'Detector 2')
        if isfield(h, 'FittedPeaksDet2')
            Slidersteps = 1:2:length(h.Measurement);
            % Set RawData for current slider value
            XFit = h.DataTmp{Slidersteps(value)}(:, 1);
            YFit = h.DataTmp{Slidersteps(value)}(:, 2);
            % Set Fit-Data for current slider value
            XPlot = XFit(1):0.001:XFit(end);
            YPlot = zeros(size(XPlot));
            % Calculate fitted profile using Fitted PeakData for current slider
            % value
            for d = 1:size(h.FittedPeaksDet2{value}, 1)
                if h.P.PopupValueFitFunc == 2 %PV-Func
                    SinglePlot = Tools.Science.Math.FF_PseudoVoigt(XPlot, ...
                        h.FittedPeaksDet2{value}(d, 1), h.FittedPeaksDet2{value}(d, 2), h.FittedPeaksDet2{value}(d, 3),h.FittedPeaksDet2{value}(d, 4));
                elseif h.P.PopupValueFitFunc == 3 %TCH-Func
                    SinglePlot = Tools.Science.Math.FF_TCH(XPlot, ...
                        h.FittedPeaksDet2{value}(d, 1), h.FittedPeaksDet2{value}(d, 2), h.FittedPeaksDet2{value}(d, 3),h.FittedPeaksDet2{value}(d, 4));
                elseif h.P.PopupValueFitFunc == 4 %Gauss-Func
                    SinglePlot = Tools.Science.Math.FF_Gauss(XPlot, ...
                        h.FittedPeaksDet2{value}(d, 1), h.FittedPeaksDet2{value}(d, 2), h.FittedPeaksDet2{value}(d, 3));
                elseif h.P.PopupValueFitFunc == 5 %Lorentz-Func
                    SinglePlot = Tools.Science.Math.FF_Lorentz(XPlot, ...
                        h.FittedPeaksDet2{value}(d, 1), h.FittedPeaksDet2{value}(d, 2), h.FittedPeaksDet2{value}(d, 3));
                end
                    YPlot = YPlot + SinglePlot;
            end
            % Add plots of fitted peaks and residual to axes according to current 
            % slider value
            set(h.plotfits,'xdata',XPlot)
            set(h.plotfits,'ydata',YPlot)
            % Set data of plot residual according to current slider value
            set(h.plotfitresidual,'xdata',XFit)
            YDataResidual = (YFit - interp1(XPlot,YPlot,XFit)) - (max(YFit) /4);
            set(h.plotfitresidual,'ydata', YDataResidual)
            % Set Ylim according to current slider value
            h.axesplotRawData.YLim = [-Inf round(max(h.DataTmp{Slidersteps(value)}(:,2)),-1)];
            if h.P.PopupValueFitFunc == 2 %PV-Func
                set(h.tablefitresults,'data',[h.FittedPeaksCalctmpDet2{1,value}(:,7), h.FittedPeaksCalctmpDet2{1,value}(:,1),...
                    h.FittedPeaksCalctmpDet2{1,value}(:,2),h.FittedPeaksCalctmpDet2{1,value}(:,3),...
                    h.FittedPeaksCalctmpDet2{1,value}(:,5),h.FittedPeaksCalctmpDet2{1,value}(:,6),...
                    h.FittedPeaksCalctmpDet2{1,value}(:,4)])
            elseif h.P.PopupValueFitFunc == 3 %TCH-Func
                set(h.tablefitresults,'data',[h.FittedPeaksCalctmpDet2{1,value}(:,1), h.FittedPeaksCalctmpDet2{1,value}(:,9),...
                    h.FittedPeaksCalctmpDet2{1,value}(:,2),h.FittedPeaksCalctmpDet2{1,value}(:,3),...
                    h.FittedPeaksCalctmpDet2{1,value}(:,4),h.FittedPeaksCalctmpDet2{1,value}(:,5),...
                    h.FittedPeaksCalctmpDet2{1,value}(:,6),h.FittedPeaksCalctmpDet2{1,value}(:,7),...
                    h.FittedPeaksCalctmpDet2{1,value}(:,8)])
            end
        end
    end
end

% Calculate max. ydata of theoretical line positions of substrate
if h.P.ShowSubstratePeaks == 1
    b = h.TPeaks.S.Etheo < h.TPeaks.S.EMax;
    SEtheoLimit = h.TPeaks.S.Etheo(b);
end

if isfield(h, 'PeaksTheoAdd')
    Y3LimitAdd1 = h.PeaksTheoAdd.T.Y3((1:(3*length(h.EtheoLimitPeaksAdd1)-1)),:);
    if strcmp(h.Diffsel,'LEDDI')
        set(h.plotEtheoAdd1,'ydata',Y3LimitAdd1(:,Slidersteps(value)).*(max(h.DataTmp{1,Slidersteps(value)}(:,2))/max(Y3LimitAdd1(:,Slidersteps(value)))))
    else
        set(h.plotEtheoAdd1,'ydata',Y3LimitAdd1(:,value).*(max(h.DataTmp{1,value}(:,2))/max(Y3LimitAdd1(:,value))))
    end
end

if isfield(h, 'FluorPos')
    % Create array with y values for the fluorescence line plot.
    if strcmp(h.Diffsel,'LEDDI')
    % If LEDDI has been used for the measurement
        if strcmp(h.Detsel,'Detector 1')
            Slidersteps = 2:2:length(h.Measurement);
            y_tmp = repmat([0 max(h.DataTmp{Slidersteps(value)}(:,2)) nan],1,size(h.FluorPos1,1))';
            y_tmp(size(h.FluorPos1,1)*size(h.FluorPos1,2),:) = [];
            % Set plot data for additional theoretical line positions
            set(h.plotFluorAdd1,'ydata',y_tmp)
        elseif strcmp(h.Detsel,'Detector 2')
            Slidersteps = 1:2:length(h.Measurement);
            y_tmp = repmat([0 max(h.DataTmp{Slidersteps(value)}(:,2)) nan],1,size(h.FluorPos1,1))';
            y_tmp(size(h.FluorPos1,1)*size(h.FluorPos1,2),:) = [];
            % Set plot data for additional theoretical line positions
            set(h.plotFluorAdd1,'ydata',y_tmp)
        end
    else
        y_tmp = repmat([0 max(h.DataTmp{value}(:,2)) nan],1,size(h.FluorPos1,1))';
        y_tmp(size(h.FluorPos1,1)*size(h.FluorPos1,2),:) = [];
        % Set plot data for additional theoretical line positions
        set(h.plotFluorAdd1,'ydata',y_tmp)
    end
end


if h.P.ShowSubstratePeaks == 1
    SY3Limit = h.TPeaks.S.Y3((1:(3*length(SEtheoLimit)-1)),:);
    set(h.plotEtheoSub,'ydata',SY3Limit(:,value).*(max(h.DataTmp{1,value}(:,2))/max(SY3Limit(:,value))))
end
% Set data for fit results table
if isfield(h, 'FittedPeaks')
    if h.P.PopupValueFitFunc == 2 %PV-Func
        set(h.tablefitresults,'data',[h.FittedPeaksCalctmp{1,value}(:,7), h.FittedPeaksCalctmp{1,value}(:,1),...
            h.FittedPeaksCalctmp{1,value}(:,2),h.FittedPeaksCalctmp{1,value}(:,3),...
            h.FittedPeaksCalctmp{1,value}(:,5),h.FittedPeaksCalctmp{1,value}(:,6),...
            h.FittedPeaksCalctmp{1,value}(:,4)])
    elseif h.P.PopupValueFitFunc == 3 %TCH-Func
        set(h.tablefitresults,'data',[h.FittedPeaksCalctmp{1,value}(:,1), h.FittedPeaksCalctmp{1,value}(:,9),...
            h.FittedPeaksCalctmp{1,value}(:,2),h.FittedPeaksCalctmp{1,value}(:,3),...
            h.FittedPeaksCalctmp{1,value}(:,4),h.FittedPeaksCalctmp{1,value}(:,5),...
            h.FittedPeaksCalctmp{1,value}(:,6),h.FittedPeaksCalctmp{1,value}(:,7),...
            h.FittedPeaksCalctmp{1,value}(:,8)])
    elseif h.P.PopupValueFitFunc == 4 %Gauss-Func
        set(h.tablefitresults,'data',[h.FittedPeaksCalctmp{1,value}(:,6), h.FittedPeaksCalctmp{1,value}(:,1),...
            h.FittedPeaksCalctmp{1,value}(:,2),h.FittedPeaksCalctmp{1,value}(:,3),...
            h.FittedPeaksCalctmp{1,value}(:,4),h.FittedPeaksCalctmp{1,value}(:,5)])
    elseif h.P.PopupValueFitFunc == 5 %Lorentz-Func
        set(h.tablefitresults,'data',[h.FittedPeaksCalctmp{1,value}(:,6), h.FittedPeaksCalctmp{1,value}(:,1),...
            h.FittedPeaksCalctmp{1,value}(:,2),h.FittedPeaksCalctmp{1,value}(:,3),...
            h.FittedPeaksCalctmp{1,value}(:,4),h.FittedPeaksCalctmp{1,value}(:,5)])
    end
end

guidata(hObj, h);

% Slider callbacks Tab(2)
function SliderCallbackStressData(hObj, ~)
h = guidata(hObj);
% Get slider value
valueSlider = get(hObj, 'Value');
% Create label
label = CreateHKLlabel(h);

DEKdatatmp = get(h.loadDEKtable,'data');
% assignin('base','DEKdatatmp',DEKdatatmp)
% assignin('base','sin2psi',h.sin2psi)
% assignin('base','ParamsToFit',h.ParamsToFit)
if isfield(h,'StressDatamodified') && ~isempty(h.StressDatamodified{valueSlider})
    % Set plot data and properties
    set(h.plotdatadspacing,'xdata',sind(h.plotdspacingXData{valueSlider}).^2)
    set(h.plotdatadspacing,'ydata',h.plotdspacingYData{valueSlider})
    set(h.plotdatadspacing,'YNegativeDelta',h.plotdspacingYdeltaData{valueSlider})
    set(h.plotdatadspacing,'YPositiveDelta',h.plotdspacingYdeltaData{valueSlider})
    %
    YLimd1 = [floor(min(h.plotdspacingYData{valueSlider})*15000)/15000,ceil(max(h.plotdspacingYData{valueSlider})*15000)/15000];
    YLimd2 = [YLimd1(1) - abs(diff(YLimd1))/2,YLimd1(2) + abs(diff(YLimd1))/2];
    h.axesplotdspacing.YLim = [YLimd2(1) YLimd2(2)];
    %
    set(h.plotreglinedspacing,'xdata',linspace(0,1,11))
    set(h.plotreglinedspacing,'ydata',h.plotregline{valueSlider})
    %
    set(h.plotdataIB,'xdata',sind(h.plotdspacingXData{valueSlider}).^2)
    set(h.plotdataIB,'ydata',h.plotIBYData{valueSlider})
    %
    YLim1 = [floor(min(h.plotIBYData{valueSlider})*10)/10,ceil(max(h.plotIBYData{valueSlider})*10)/10];
    YLim2 = (min(h.plotIBYData{valueSlider}) - YLim1(1) + max(h.plotIBYData{valueSlider}) - YLim1(2))/2;
    YLim1 = YLim1+YLim2;
    h.axesplotIB.YLim = YLim1;
    %
    set(h.plotdataInt,'xdata',sind(h.plotdspacingXData{valueSlider}).^2)
    set(h.plotdataInt,'ydata',h.plotIntYData{valueSlider})
    exponentIntLim = numel(num2str(ceil(max(h.plotIntYData{valueSlider}))));
    h.axesplotInt.YLim = [0,round(ceil(max(h.plotIntYData{valueSlider})*(10*10^(-exponentIntLim)))/(10*10^(-exponentIntLim)),-2)];

    %%
    set(h.plotdatadspacing, {'Color','MarkerFaceColor','MarkerEdgeColor'}, {'k',h.Colors{valueSlider},'k'});
    set(h.plotreglinedspacing, {'Color'}, {'k'});
    set(h.plotdataIB, {'Color','MarkerFaceColor','MarkerEdgeColor'}, {'k',h.Colors{valueSlider},'k'});
    set(h.plotdataInt, {'Color','MarkerFaceColor','MarkerEdgeColor'}, {'k',h.Colors{valueSlider},'k'});

    title(h.axesplotdspacing,['Stress data for ',  strrep(h.Measurement(valueSlider).Name,'Scan','Peak')])
    title(h.axesplotIB,['IB data for ', strrep(h.Measurement(valueSlider).Name,'Scan','Peak')])
    title(h.axesplotInt,['Integrated Int. data for ',  strrep(h.Measurement(valueSlider).Name,'Scan','Peak')])
    legdspacing = legend(h.axesplotdspacing,label(valueSlider,:));
    legdspacing.FontSize = 15;
else
    % Set plot data
    if ~isempty(h.idxphi0)
        set(h.plotdatadspacingphi0,'xdata',sind(h.ParamsToFit(h.idxphi0).Psi_Winkel{valueSlider}).^2)
        set(h.plotdatadspacingphi0,'ydata',h.ParamsToFit(h.idxphi0).LatticeSpacing{valueSlider})
        set(h.plotdatadspacingphi0,'YNegativeDelta',h.ParamsToFit(h.idxphi0).LatticeSpacing_Delta{valueSlider})
        set(h.plotdatadspacingphi0,'YPositiveDelta',h.ParamsToFit(h.idxphi0).LatticeSpacing_Delta{valueSlider})
        set(h.plotreglinedspacingphi0,'xdata',h.sinpsisquare)
        set(h.plotreglinedspacingphi0,'ydata',h.sin2psi.reglinephi0(:,valueSlider))
        set(h.plotdataIBphi0,'xdata',sind(h.ParamsToFit(h.idxphi0).Psi_Winkel{valueSlider}).^2)
        set(h.plotdataIBphi0,'ydata',h.ParamsToFit(h.idxphi0).IntegralWidth{valueSlider})
        set(h.plotdataIntphi0,'xdata',sind(h.ParamsToFit(h.idxphi0).Psi_Winkel{valueSlider}).^2)
        set(h.plotdataIntphi0,'ydata',h.ParamsToFit(h.idxphi0).Intensity_Int{valueSlider})     
    end

    if ~isempty(h.idxphi90)
        set(h.plotdatadspacingphi90,'xdata',sind(h.ParamsToFit(h.idxphi90).Psi_Winkel{valueSlider}).^2)
        set(h.plotdatadspacingphi90,'ydata',h.ParamsToFit(h.idxphi90).LatticeSpacing{valueSlider})
        set(h.plotdatadspacingphi90,'YNegativeDelta',h.ParamsToFit(h.idxphi90).LatticeSpacing_Delta{valueSlider})
        set(h.plotdatadspacingphi90,'YPositiveDelta',h.ParamsToFit(h.idxphi90).LatticeSpacing_Delta{valueSlider})
        set(h.plotreglinedspacingphi90,'xdata',h.sinpsisquare)
        set(h.plotreglinedspacingphi90,'ydata',h.sin2psi.reglinephi90(:,valueSlider))
        set(h.plotdataIBphi90,'xdata',sind(h.ParamsToFit(h.idxphi90).Psi_Winkel{valueSlider}).^2)
        set(h.plotdataIBphi90,'ydata',h.ParamsToFit(h.idxphi90).IntegralWidth{valueSlider})
        set(h.plotdataIntphi90,'xdata',sind(h.ParamsToFit(h.idxphi90).Psi_Winkel{valueSlider}).^2)
        set(h.plotdataIntphi90,'ydata',h.ParamsToFit(h.idxphi90).Intensity_Int{valueSlider})
    end

    if ~isempty(h.idxphi180)
        set(h.plotdatadspacingphi180,'xdata',sind(h.ParamsToFit(h.idxphi180).Psi_Winkel{valueSlider}).^2)
        set(h.plotdatadspacingphi180,'ydata',h.ParamsToFit(h.idxphi180).LatticeSpacing{valueSlider})
        set(h.plotdatadspacingphi180,'YNegativeDelta',h.ParamsToFit(h.idxphi180).LatticeSpacing_Delta{valueSlider})
        set(h.plotdatadspacingphi180,'YPositiveDelta',h.ParamsToFit(h.idxphi180).LatticeSpacing_Delta{valueSlider})
        set(h.plotreglinedspacingphi180,'xdata',h.sinpsisquare)
        set(h.plotreglinedspacingphi180,'ydata',h.sin2psi.reglinephi180(:,valueSlider))
        set(h.plotdataIBphi180,'xdata',sind(h.ParamsToFit(h.idxphi180).Psi_Winkel{valueSlider}).^2)
        set(h.plotdataIBphi180,'ydata',h.ParamsToFit(h.idxphi180).IntegralWidth{valueSlider})
        set(h.plotdataIntphi180,'xdata',sind(h.ParamsToFit(h.idxphi180).Psi_Winkel{valueSlider}).^2)
        set(h.plotdataIntphi180,'ydata',h.ParamsToFit(h.idxphi180).Intensity_Int{valueSlider})
    end

    if ~isempty(h.idxphi270)
        set(h.plotdatadspacingphi270,'xdata',sind(h.ParamsToFit(h.idxphi270).Psi_Winkel{valueSlider}).^2)
        set(h.plotdatadspacingphi270,'ydata',h.ParamsToFit(h.idxphi270).LatticeSpacing{valueSlider})
        set(h.plotdatadspacingphi270,'YNegativeDelta',h.ParamsToFit(h.idxphi270).LatticeSpacing_Delta{valueSlider})
        set(h.plotdatadspacingphi270,'YPositiveDelta',h.ParamsToFit(h.idxphi270).LatticeSpacing_Delta{valueSlider})
        set(h.plotreglinedspacingphi270,'xdata',h.sinpsisquare)
        set(h.plotreglinedspacingphi270,'ydata',h.sin2psi.reglinephi270(:,valueSlider))
        set(h.plotdataIBphi270,'xdata',sind(h.ParamsToFit(h.idxphi270).Psi_Winkel{valueSlider}).^2)
        set(h.plotdataIBphi270,'ydata',h.ParamsToFit(h.idxphi270).IntegralWidth{valueSlider})
        set(h.plotdataIntphi270,'xdata',sind(h.ParamsToFit(h.idxphi270).Psi_Winkel{valueSlider}).^2)
        set(h.plotdataIntphi270,'ydata',h.ParamsToFit(h.idxphi270).Intensity_Int{valueSlider})
    end
    
    % Set plot properties
    if ~isempty(h.idxphi0)
        set(h.plotdatadspacingphi0, {'Color','MarkerFaceColor','MarkerEdgeColor'}, {'k',h.Colors{valueSlider},'k'});
        set(h.plotreglinedspacingphi0, {'Color'}, {h.Colors{valueSlider}});
        set(h.plotdataIBphi0, {'Color','MarkerFaceColor','MarkerEdgeColor'}, {'k',h.Colors{valueSlider},'k'});
        set(h.plotdataIntphi0, {'Color','MarkerFaceColor','MarkerEdgeColor'}, {'k',h.Colors{valueSlider},'k'});
    end

    if ~isempty(h.idxphi90)
        set(h.plotdatadspacingphi90, {'Color','MarkerFaceColor','MarkerEdgeColor'}, {'k',h.Colors{valueSlider},'k'});
        set(h.plotreglinedspacingphi90, {'Color'}, {h.Colors{valueSlider}});
        set(h.plotdataIBphi90, {'Color','MarkerFaceColor','MarkerEdgeColor'}, {'k',h.Colors{valueSlider},'k'});
        set(h.plotdataIntphi90, {'Color','MarkerFaceColor','MarkerEdgeColor'}, {'k',h.Colors{valueSlider},'k'});
    end

    if ~isempty(h.idxphi180)
        set(h.plotdatadspacingphi180, {'Color','MarkerFaceColor','MarkerEdgeColor'}, {'k',h.Colors{valueSlider},'k'});
        set(h.plotreglinedspacingphi180, {'Color'}, {h.Colors{valueSlider}});
        set(h.plotdataIBphi180, {'Color','MarkerFaceColor','MarkerEdgeColor'}, {'k',h.Colors{valueSlider},'k'});
        set(h.plotdataIntphi180, {'Color','MarkerFaceColor','MarkerEdgeColor'}, {'k',h.Colors{valueSlider},'k'});
    end

    if ~isempty(h.idxphi270)
        set(h.plotdatadspacingphi270, {'Color','MarkerFaceColor','MarkerEdgeColor'}, {'k',h.Colors{valueSlider},'k'});
        set(h.plotreglinedspacingphi270, {'Color'}, {h.Colors{valueSlider}});
        set(h.plotdataIBphi270, {'Color','MarkerFaceColor','MarkerEdgeColor'}, {'k',h.Colors{valueSlider},'k'});
        set(h.plotdataIntphi270, {'Color','MarkerFaceColor','MarkerEdgeColor'}, {'k',h.Colors{valueSlider},'k'});
    end
    
    % Set plot limits

    for k = 1:size(h.Params.Phi_Winkel,2)
        [PhiWinkel{k},ia{k},~] = unique(h.Params.Phi_Winkel{k});
    end
    % Find min/max value
    for k = 1:length(ia{1})
        dmin(:,k) = min(h.ParamsToFit(k).LatticeSpacing{valueSlider});
        dmax(:,k) = max(h.ParamsToFit(k).LatticeSpacing{valueSlider});
    end
    % Calculate limits
    YLimd1 = [floor(min(dmin)*15000)/15000,ceil(max(dmax)*15000)/15000];
    YLimd2 = [YLimd1(1) - abs(diff(YLimd1))/2,YLimd1(2) + abs(diff(YLimd1))/2];
    h.axesplotdspacing.YLim = [YLimd2(1) YLimd2(2)];

    % Set axes limits for IB
    for k = 1:length(ia{1})
        IBmin(:,k) = min(h.ParamsToFit(k).IntegralWidth{valueSlider});
        IBmax(:,k) = max(h.ParamsToFit(k).IntegralWidth{valueSlider});
    end
    YLimIB1 = [floor(min(IBmin)*10)/10,ceil(max(IBmax)*10)/10];
    YLimIB2 = round((min(IBmin) - YLimIB1(1) + max(IBmax) - YLimIB1(2))/2,2);
    YLimIB1 = YLimIB1 + YLimIB2;
    h.axesplotIB.YLim = YLimIB1;

    % Set axes limits for intensity
    for k = 1:length(ia{1})
        Intmin(:,k) = min(h.ParamsToFit(k).Intensity_Int{valueSlider});
        Intmax(:,k) = max(h.ParamsToFit(k).Intensity_Int{valueSlider});
    end
    
    exponentIntLim = numel(num2str(ceil(max(Intmax))));
    h.axesplotInt.YLim = [0,ceil(max(Intmax)*(10*10^(-exponentIntLim)))/(10*10^(-exponentIntLim))];
    
    % Set plot titles
    title(h.axesplotdspacing,['Stress data for Peak', ' ', num2str(valueSlider)])
    title(h.axesplotIB,['IB data for Peak', ' ', num2str(valueSlider)])
    title(h.axesplotInt,['Integrated Int. data for Peak', ' ', num2str(valueSlider)])
    
    % Legend for plot of d-spacings
    h.legdspacing = legend(h.axesplotdspacing,h.LegDatadspacing,h.LegLabelData);
    title(h.legdspacing,label(valueSlider,:))
    % Create legend for plot of IB and Int.Intensity, depending on phi
    if ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270) ...
            || isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270) ...
            || isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270) ...
            || isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
        h.legIB = legend(h.axesplotIB,h.LegDataIB,h.LegLabelData);
        h.legInt = legend(h.axesplotInt,h.LegDataInt,h.LegLabelData);
    else
        h.legIB = legend(h.axesplotIB,h.LegLabelData);
        h.legInt = legend(h.axesplotInt,h.LegLabelData);
    end
    % Title for plot of IB and intensity
    title(h.legIB,label(valueSlider,:))
    title(h.legInt,label(valueSlider,:))
    
    % Set Xlim for plot
    h.axesplotfitdata.XLim = [round(h.Params.Energy_Max{valueSlider}(1),2)-1.5,round(h.Params.Energy_Max{valueSlider}(1),2)+1.5];

    % Set Ylim for plot of fitted data
    % Find index of Emax in DataTmp
    if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
        % Find index of Emax in DataTmp
        idxEmax = find(round(h.DataTmp{1}(:,1),1) == round(h.FittedPeaks{1}(valueSlider,2),1));
        YMax  = max(h.DataTmp{1}((idxEmax(5)-25:idxEmax(5)+25),2));
    elseif strcmp(h.Diffsel,'LEDDI')
        if strcmp(h.Detsel,'Detector 1')
            Slidersteps = 2:2:length(h.Measurement);
            % Find index of Emax in DataTmp
            idxEmax = find(round(h.DataTmp{Slidersteps(1)}(:,1),1) == round(h.FittedPeaksDet1{1}(valueSlider,2),1));
            % Find Ymax in the range +/- 25 channels of idxEmax 
            YMax  = max(h.DataTmp{Slidersteps(1)}((idxEmax(5)-25:idxEmax(5)+25),2));
        elseif strcmp(h.Detsel,'Detector 2')
            Slidersteps = 1:2:length(h.Measurement);
            % Find index of Emax in DataTmp
            idxEmax = find(round(h.DataTmp{Slidersteps(1)}(:,1),1) == round(h.FittedPeaksDet2{1}(valueSlider,2),1));
            % Find Ymax in the range +/- 25 channels of idxEmax 
            YMax  = max(h.DataTmp{Slidersteps(1)}((idxEmax(5)-25:idxEmax(5)+25),2));
        end
    end
    
    ExpPlot = numel(num2str(round(YMax,-1)));
    h.axesplotfitdata.YLim = [0 round(YMax/(1*10^(ExpPlot-2))).*1*10^(ExpPlot-2)];

end

% Reset slider from Fitdata window
set(h.SliderFitData,'Value',1);

if isfield(h,'ptext')
    delete(h.ptext)
end

if numel(num2str(round(h.Params.Psi_Winkel{valueSlider}(1),2))) == 1
    h.ptext = text(h.axesplotfitdata,0.903,0.92,['\psi =',' ', num2str(round(h.Params.Psi_Winkel{valueSlider}(1),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');
elseif numel(num2str(round(h.Params.Psi_Winkel{valueSlider}(1),2))) == 2
    h.ptext = text(h.axesplotfitdata,0.89,0.92,['\psi =',' ', num2str(round(h.Params.Psi_Winkel{valueSlider}(1),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');
elseif numel(num2str(round(h.Params.Psi_Winkel{valueSlider}(1),2))) == 3
    h.ptext = text(h.axesplotfitdata,0.879,0.92,['\psi =',' ', num2str(round(h.Params.Psi_Winkel{valueSlider}(1),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');
elseif numel(num2str(round(h.Params.Psi_Winkel{valueSlider}(1),2))) == 4
    h.ptext = text(h.axesplotfitdata,0.869,0.92,['\psi =',' ', num2str(round(h.Params.Psi_Winkel{valueSlider}(1),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');       
elseif numel(num2str(round(h.Params.Psi_Winkel{valueSlider}(1),2))) == 5
    h.ptext = text(h.axesplotfitdata,0.859,0.92,['\psi =',' ', num2str(round(h.Params.Psi_Winkel{valueSlider}(1),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');
elseif numel(num2str(round(h.Params.Psi_Winkel{valueSlider}(1),2))) == 6
    h.ptext = text(h.axesplotfitdata,0.859,0.92,['\psi =',' ', num2str(round(h.Params.Psi_Winkel{valueSlider}(1),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');    
end

h.axesplotfitdata.YLim = [0 round(YMax/(1*10^(ExpPlot-2))).*1*10^(ExpPlot-2)];

guidata(hObj, h);

function SliderCallbackPlotStressData(hObj, ~)
h = guidata(hObj);
% Get slider value
valueSliderStress = get(hObj, 'Value');
% Create label for stress plot
% label = CreateHKLlabel(h);
% Create hkl label for plot of d-spacings
if isfield(h,'hkllabel')
    if ~isempty(h.hkllabel{valueSliderStress})
        label = h.hkllabel{valueSliderStress};
    else
        label = CreateHKLlabel(h);
        h.label = label;
    end
else
    label = CreateHKLlabel(h);
    h.label = label;
end

if isfield(h, 'idxhklPeaktable')
    StressPlotDatatmpsorted_tmp = h.sin2psi.StressPlotDatatmpsorted(h.idxhklPeaktable,:);
    label = label(h.idxhklPeaktable,:);
else
    StressPlotDatatmpsorted_tmp = h.sin2psi.StressPlotDatatmpsorted;
end

% assignin('base','XlimChanged',h.XlimChanged)
% Check number of phi angles
for k = 1:size(h.Params.Phi_Winkel,2)
	[PhiWinkel{k},ia{k},~] = unique(h.Params.Phi_Winkel{k});
end

% Set plot properties depending on the slider value
if valueSliderStress == 1
    h.legstressdata = legend(h.axesplotstressdata,[h.ScatterData(valueSliderStress).StressesPhi],label);
       
    if length(PhiWinkel{1}) == 2 && PhiWinkel{1}(1) == 90 && PhiWinkel{1}(2) == 270
        ylabel(h.axesplotstressdata,'<\sigma_{22} - \sigma_{33}> [MPa]')
    else
        ylabel(h.axesplotstressdata,'<\sigma_{11} - \sigma_{33}> [MPa]')  
    end
    
    % Set plot data and visibility
    set(h.plotstressdata,{'xdata','visible'},{StressPlotDatatmpsorted_tmp(:,1),'on'})
    set(h.plotstressdata,{'ydata','visible'},{StressPlotDatatmpsorted_tmp(:,2),'on'})
    set(h.plotstressdata,{'YNegativeDelta','visible'},{StressPlotDatatmpsorted_tmp(:,3),'on'})
    set(h.plotstressdata,{'YPositiveDelta','visible'},{StressPlotDatatmpsorted_tmp(:,3),'on'})
    set(h.plotstressdata,'LineStyle', '--')
    % Set axis limits
        % If only one peak has been analyzed
        if size(StressPlotDatatmpsorted_tmp,1) == 1
            % Set XLim, depending on whether it has been changed manually
            % by the user or not
            if isfield(h,'XlimChanged') && h.XlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.XLim = ([h.XlimMinnew(valueSliderStress) h.XlimMaxnew(valueSliderStress)]);  
            else
                h.axesplotstressdata.XLim = [0,(ceil(max(StressPlotDatatmpsorted_tmp(:,1))*0.1)/0.1 + (ceil(max(StressPlotDatatmpsorted_tmp(:,1))*0.1)/0.1)./2)];
            end
            % Set xtick, depending on whether it has been changed manually
            % by the user or not
            if isfield(h,'XlimXTicknew') && h.XlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.XTick = h.XlimMinnew(valueSliderStress):h.XlimXTicknew(valueSliderStress):h.XlimMaxnew(valueSliderStress);
            elseif isfield(h,'XlimXTicknew') && h.XlimChanged(valueSliderStress) == 0
                xticks(h.axesplotstressdata,'auto')    
            end
            % Set ytick, depending on whether it has been changed manually
            % by the user or not
            if isfield(h,'YlimYTicknew') && h.YlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.YTick = h.YlimMinnew(valueSliderStress):h.YlimYTicknew(valueSliderStress):h.YlimMaxnew(valueSliderStress);
            elseif isfield(h,'YlimYTicknew') && h.YlimChanged(valueSliderStress) == 0
                yticks(h.axesplotstressdata,'auto')
            end
            % Set YLim, depending on whether it has been changed manually
            % by the user or not
            if isfield(h,'YlimChanged') && h.YlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.YLim = ([h.YlimMinnew(valueSliderStress) h.YlimMaxnew(valueSliderStress)]);
            else
                YLimErr = [(min(StressPlotDatatmpsorted_tmp(:,2)) + max(StressPlotDatatmpsorted_tmp(:,3))) ...
                    (min(StressPlotDatatmpsorted_tmp(:,2)) - max(StressPlotDatatmpsorted_tmp(:,3))) ...
                    (max(StressPlotDatatmpsorted_tmp(:,2)) + max(StressPlotDatatmpsorted_tmp(:,3))) ...
                    (max(StressPlotDatatmpsorted_tmp(:,2)) - max(StressPlotDatatmpsorted_tmp(:,3)))];

                YLimtmp = [min(YLimErr) max(YLimErr)];

                YLimMinExpFactor = 1*10^(numel(num2str(abs(round(YLimtmp(1)))))-1);
                YLimMaxExpFactor = 1*10^(numel(num2str(abs(round(YLimtmp(2)))))-1);

                h.axesplotstressdata.YLim = [-(abs(floor(YLimtmp(1)/YLimMinExpFactor))*YLimMinExpFactor), ceil(YLimtmp(2)/YLimMaxExpFactor)*YLimMaxExpFactor];
            end
        % If more than one peak has been analyzed    
        else
            if isfield(h,'XlimChanged') && h.XlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.XLim = ([h.XlimMinnew(valueSliderStress) h.XlimMaxnew(valueSliderStress)]);
            else
                h.axesplotstressdata.XLim = [0,(ceil(max(StressPlotDatatmpsorted_tmp(:,1))*0.1)/0.1)];
            end
            if isfield(h,'XlimXTicknew') && h.XlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.XTick = h.XlimMinnew(valueSliderStress):h.XlimXTicknew(valueSliderStress):h.XlimMaxnew(valueSliderStress);
            elseif isfield(h,'XlimXTicknew') && h.XlimChanged(valueSliderStress) == 0
                xticks(h.axesplotstressdata,'auto')    
            end
            if isfield(h,'YlimYTicknew')&& h.YlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.YTick = h.YlimMinnew(valueSliderStress):h.YlimYTicknew(valueSliderStress):h.YlimMaxnew(valueSliderStress);
            elseif isfield(h,'YlimYTicknew') && h.YlimChanged(valueSliderStress) == 0
                yticks(h.axesplotstressdata,'auto')
            end
            if isfield(h,'YlimChanged') && h.YlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.YLim = ([h.YlimMinnew(valueSliderStress) h.YlimMaxnew(valueSliderStress)]);
            else
                YLimErr = [(min(StressPlotDatatmpsorted_tmp(:,2)) + max(StressPlotDatatmpsorted_tmp(:,3))) ...
                    (min(StressPlotDatatmpsorted_tmp(:,2)) - max(StressPlotDatatmpsorted_tmp(:,3))) ...
                    (max(StressPlotDatatmpsorted_tmp(:,2)) + max(StressPlotDatatmpsorted_tmp(:,3))) ...
                    (max(StressPlotDatatmpsorted_tmp(:,2)) - max(StressPlotDatatmpsorted_tmp(:,3)))];

                YLimtmp = [min(YLimErr) max(YLimErr)];

                YLimMinExpFactor = 1*10^(numel(num2str(abs(round(YLimtmp(1)))))-1);
                YLimMaxExpFactor = 1*10^(numel(num2str(abs(round(YLimtmp(2)))))-1);

                h.axesplotstressdata.YLim = [-(abs(floor(YLimtmp(1)/YLimMinExpFactor))*YLimMinExpFactor), ceil(YLimtmp(2)/YLimMaxExpFactor)*YLimMaxExpFactor];
            end
        end
elseif valueSliderStress == 2
    h.legstressdata = legend(h.axesplotstressdata,[h.ScatterData(valueSliderStress).StressesPhi],label);
    
    if length(PhiWinkel{1}) == 2 && PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 90
        ylabel(h.axesplotstressdata,'<\sigma_{22} - \sigma_{33}> [MPa]')
    elseif length(PhiWinkel{1}) == 2 && PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 180
        ylabel(h.axesplotstressdata,'<\sigma_{13}> [MPa]')
    elseif length(PhiWinkel{1}) == 2 && PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 270
        ylabel(h.axesplotstressdata,'<\sigma_{22} - \sigma_{33}> [MPa]')
    elseif length(PhiWinkel{1}) == 2 && PhiWinkel{1}(1) == 90 && PhiWinkel{1}(2) == 180
        ylabel(h.axesplotstressdata,'<\sigma_{22} - \sigma_{33}> [MPa]')
    elseif length(PhiWinkel{1}) == 2 && PhiWinkel{1}(1) == 90 && PhiWinkel{1}(2) == 270
        ylabel(h.axesplotstressdata,'<\sigma_{23}')
    elseif length(PhiWinkel{1}) == 2 && PhiWinkel{1}(1) == 180 && PhiWinkel{1}(2) == 270
        ylabel(h.axesplotstressdata,'<\sigma_{22} - \sigma_{33}> [MPa]')
    elseif length(PhiWinkel{1}) == 3 && PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 180 && PhiWinkel{1}(3) == 270
        ylabel(h.axesplotstressdata,'<\sigma_{22} - \sigma_{33}> [MPa]')
    elseif length(PhiWinkel{1}) == 3 && PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 90 && PhiWinkel{1}(3) == 270 
        ylabel(h.axesplotstressdata,'<\sigma_{22} - \sigma_{33}> [MPa]')    
    elseif length(PhiWinkel{1}) == 3 && PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 90 && PhiWinkel{1}(3) == 180 
        ylabel(h.axesplotstressdata,'<\sigma_{22} - \sigma_{33}> [MPa]')
    elseif length(PhiWinkel{1}) == 3 && PhiWinkel{1}(1) == 90 && PhiWinkel{1}(2) == 180 && PhiWinkel{1}(3) == 270 
        ylabel(h.axesplotstressdata,'<\sigma_{22} - \sigma_{33}> [MPa]')
    elseif length(PhiWinkel{1}) == 4
        ylabel(h.axesplotstressdata,'<\sigma_{22} - \sigma_{33}> [MPa]')    
    end
    
    set(h.plotstressdata,{'xdata','visible'},{StressPlotDatatmpsorted_tmp(:,1),'on'})
    set(h.plotstressdata,{'ydata','visible'},{StressPlotDatatmpsorted_tmp(:,4),'on'})
    set(h.plotstressdata,{'YNegativeDelta','visible'},{StressPlotDatatmpsorted_tmp(:,5),'on'})
    set(h.plotstressdata,{'YPositiveDelta','visible'},{StressPlotDatatmpsorted_tmp(:,5),'on'})
    set(h.plotstressdata,'LineStyle', '--')
        if size(StressPlotDatatmpsorted_tmp,1) == 1
            if isfield(h,'XlimChanged') && h.XlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.XLim = ([h.XlimMinnew(valueSliderStress) h.XlimMaxnew(valueSliderStress)]);
            else
                h.axesplotstressdata.XLim = [0,(ceil(max(StressPlotDatatmpsorted_tmp(:,1))*0.1)/0.1 + (ceil(max(StressPlotDatatmpsorted_tmp(:,1))*0.1)/0.1)./2)];
            end
            if isfield(h,'XlimXTicknew') && h.XlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.XTick = h.XlimMinnew(valueSliderStress):h.XlimXTicknew(valueSliderStress):h.XlimMaxnew(valueSliderStress);
            elseif isfield(h,'XlimXTicknew') && h.XlimChanged(valueSliderStress) == 0
                xticks(h.axesplotstressdata,'auto')    
            end
            if isfield(h,'YlimYTicknew') && h.YlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.YTick = h.YlimMinnew(valueSliderStress):h.YlimYTicknew(valueSliderStress):h.YlimMaxnew(valueSliderStress);
            elseif isfield(h,'YlimYTicknew') && h.YlimChanged(valueSliderStress) == 0
                yticks(h.axesplotstressdata,'auto')
            end
            if isfield(h,'YlimChanged') && h.YlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.YLim = ([h.YlimMinnew(valueSliderStress) h.YlimMaxnew(valueSliderStress)]);
            else
                YLimErr = [(min(StressPlotDatatmpsorted_tmp(:,4)) + max(StressPlotDatatmpsorted_tmp(:,5))) ...
                (min(StressPlotDatatmpsorted_tmp(:,4)) - max(StressPlotDatatmpsorted_tmp(:,5))) ...
                (max(StressPlotDatatmpsorted_tmp(:,4)) + max(StressPlotDatatmpsorted_tmp(:,5))) ...
                (max(StressPlotDatatmpsorted_tmp(:,4)) - max(StressPlotDatatmpsorted_tmp(:,5)))];

                YLimtmp = [min(YLimErr) max(YLimErr)];

                YLimMinExpFactor = 1*10^(numel(num2str(abs(round(YLimtmp(1)))))-1);
                YLimMaxExpFactor = 1*10^(numel(num2str(abs(round(YLimtmp(2)))))-1);

                h.axesplotstressdata.YLim = [-(abs(floor(YLimtmp(1)/YLimMinExpFactor))*YLimMinExpFactor), ceil(YLimtmp(2)/YLimMaxExpFactor)*YLimMaxExpFactor];
            end
        else
            if isfield(h,'XlimChanged') && h.XlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.XLim = ([h.XlimMinnew(valueSliderStress) h.XlimMaxnew(valueSliderStress)]);
            else
                h.axesplotstressdata.XLim = [0,(ceil(max(StressPlotDatatmpsorted_tmp(:,1))*0.1)/0.1)];
            end
            if isfield(h,'XlimXTicknew') && h.XlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.XTick = h.XlimMinnew(valueSliderStress):h.XlimXTicknew(valueSliderStress):h.XlimMaxnew(valueSliderStress);
            elseif isfield(h,'XlimXTicknew') && h.XlimChanged(valueSliderStress) == 0
                xticks(h.axesplotstressdata,'auto')    
            end
            if isfield(h,'YlimYTicknew') && h.YlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.YTick = h.YlimMinnew(valueSliderStress):h.YlimYTicknew(valueSliderStress):h.YlimMaxnew(valueSliderStress);
            elseif isfield(h,'YlimYTicknew') && h.YlimChanged(valueSliderStress) == 0
                yticks(h.axesplotstressdata,'auto')    
            end
            if isfield(h,'YlimChanged') && h.YlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.YLim = ([h.YlimMinnew(valueSliderStress) h.YlimMaxnew(valueSliderStress)]);
            else
                YLimErr = [(min(StressPlotDatatmpsorted_tmp(:,4)) + max(StressPlotDatatmpsorted_tmp(:,5))) ...
                    (min(StressPlotDatatmpsorted_tmp(:,4)) - max(StressPlotDatatmpsorted_tmp(:,5))) ...
                    (max(StressPlotDatatmpsorted_tmp(:,4)) + max(StressPlotDatatmpsorted_tmp(:,5))) ...
                    (max(StressPlotDatatmpsorted_tmp(:,4)) - max(StressPlotDatatmpsorted_tmp(:,5)))];

                YLimtmp = [min(YLimErr) max(YLimErr)];

                YLimMinExpFactor = 1*10^(numel(num2str(abs(round(YLimtmp(1)))))-1);
                YLimMaxExpFactor = 1*10^(numel(num2str(abs(round(YLimtmp(2)))))-1);

                h.axesplotstressdata.YLim = [-(abs(floor(YLimtmp(1)/YLimMinExpFactor))*YLimMinExpFactor), ceil(YLimtmp(2)/YLimMaxExpFactor)*YLimMaxExpFactor];
            end
        end
elseif valueSliderStress == 3
    h.legstressdata = legend(h.axesplotstressdata,[h.ScatterData(valueSliderStress).StressesPhi],label);
    
    if length(PhiWinkel{1}) == 3 && PhiWinkel{1}(1) == 0 && PhiWinkel{1}(2) == 90 && PhiWinkel{1}(3) == 270 || length(PhiWinkel{1}) == 3 && PhiWinkel{1}(1) == 90 && PhiWinkel{1}(2) == 180 && PhiWinkel{1}(3) == 270
        ylabel(h.axesplotstressdata,'<\sigma_{23}> [MPa]')
    else
        ylabel(h.axesplotstressdata,'<\sigma_{13}> [MPa]')
    end
    
    set(h.plotstressdata,{'xdata','visible'},{StressPlotDatatmpsorted_tmp(:,1),'on'})
    set(h.plotstressdata,{'ydata','visible'},{StressPlotDatatmpsorted_tmp(:,6),'on'})
    set(h.plotstressdata,{'YNegativeDelta','visible'},{StressPlotDatatmpsorted_tmp(:,7),'on'})
    set(h.plotstressdata,{'YPositiveDelta','visible'},{StressPlotDatatmpsorted_tmp(:,7),'on'})
    set(h.plotstressdata,'LineStyle', '--')
        if size(StressPlotDatatmpsorted_tmp,1) == 1
            if isfield(h,'XlimChanged') && h.XlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.XLim = ([h.XlimMinnew(valueSliderStress) h.XlimMaxnew(valueSliderStress)]);
            else
                h.axesplotstressdata.XLim = [0,(ceil(max(StressPlotDatatmpsorted_tmp(:,1))*0.1)/0.1 + (ceil(max(StressPlotDatatmpsorted_tmp(:,1))*0.1)/0.1)./2)];
            end
            if isfield(h,'XlimXTicknew') && h.XlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.XTick = h.XlimMinnew(valueSliderStress):h.XlimXTicknew(valueSliderStress):h.XlimMaxnew(valueSliderStress);
            elseif isfield(h,'XlimXTicknew') && h.XlimChanged(valueSliderStress) == 0
                xticks(h.axesplotstressdata,'auto')    
            end
            if isfield(h,'YlimYTicknew') && h.YlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.YTick = h.YlimMinnew(valueSliderStress):h.YlimYTicknew(valueSliderStress):h.YlimMaxnew(valueSliderStress);
            elseif isfield(h,'YlimYTicknew') && h.YlimChanged(valueSliderStress) == 0
                yticks(h.axesplotstressdata,'auto')    
            end
            if isfield(h,'YlimChanged') && h.YlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.YLim = ([h.YlimMinnew(valueSliderStress) h.YlimMaxnew(valueSliderStress)]);
            else
                YLimErr = [(min(StressPlotDatatmpsorted_tmp(:,6)) + max(StressPlotDatatmpsorted_tmp(:,7))) ...
                    (min(StressPlotDatatmpsorted_tmp(:,6)) - max(StressPlotDatatmpsorted_tmp(:,7))) ...
                    (max(StressPlotDatatmpsorted_tmp(:,6)) + max(StressPlotDatatmpsorted_tmp(:,7))) ...
                    (max(StressPlotDatatmpsorted_tmp(:,6)) - max(StressPlotDatatmpsorted_tmp(:,7)))];

                YLimtmp = [min(YLimErr) max(YLimErr)];

                YLimMinExpFactor = 1*10^(numel(num2str(abs(round(YLimtmp(1)))))-1);
                YLimMaxExpFactor = 1*10^(numel(num2str(abs(round(YLimtmp(2)))))-1);

                h.axesplotstressdata.YLim = [-(abs(floor(YLimtmp(1)/YLimMinExpFactor))*YLimMinExpFactor), ceil(YLimtmp(2)/YLimMaxExpFactor)*YLimMaxExpFactor];
            end
        else
            if isfield(h,'XlimChanged') && h.XlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.XLim = ([h.XlimMinnew(valueSliderStress) h.XlimMaxnew(valueSliderStress)]);
            else
                h.axesplotstressdata.XLim = [0,(ceil(max(StressPlotDatatmpsorted_tmp(:,1))*0.1)/0.1)];
            end
            if isfield(h,'XlimXTicknew') && h.XlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.XTick = h.XlimMinnew(valueSliderStress):h.XlimXTicknew(valueSliderStress):h.XlimMaxnew(valueSliderStress);
            elseif isfield(h,'XlimXTicknew') && h.XlimChanged(valueSliderStress) == 0
                xticks(h.axesplotstressdata,'auto')    
            end
            if isfield(h,'YlimYTicknew') && h.YlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.YTick = h.YlimMinnew(valueSliderStress):h.YlimYTicknew(valueSliderStress):h.YlimMaxnew(valueSliderStress);
            elseif isfield(h,'YlimYTicknew') && h.YlimChanged(valueSliderStress) == 0
                yticks(h.axesplotstressdata,'auto')    
            end
            if isfield(h,'YlimChanged') && h.YlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.YLim = ([h.YlimMinnew(valueSliderStress) h.YlimMaxnew(valueSliderStress)]);
            else
                YLimErr = [(min(StressPlotDatatmpsorted_tmp(:,6)) + max(StressPlotDatatmpsorted_tmp(:,7))) ...
                    (min(StressPlotDatatmpsorted_tmp(:,6)) - max(StressPlotDatatmpsorted_tmp(:,7))) ...
                    (max(StressPlotDatatmpsorted_tmp(:,6)) + max(StressPlotDatatmpsorted_tmp(:,7))) ...
                    (max(StressPlotDatatmpsorted_tmp(:,6)) - max(StressPlotDatatmpsorted_tmp(:,7)))];

                YLimtmp = [min(YLimErr) max(YLimErr)];

                YLimMinExpFactor = 1*10^(numel(num2str(abs(round(YLimtmp(1)))))-1);
                YLimMaxExpFactor = 1*10^(numel(num2str(abs(round(YLimtmp(2)))))-1);

                h.axesplotstressdata.YLim = [-(abs(floor(YLimtmp(1)/YLimMinExpFactor))*YLimMinExpFactor), ceil(YLimtmp(2)/YLimMaxExpFactor)*YLimMaxExpFactor];
            end
        end
elseif valueSliderStress == 4
    h.legstressdata = legend(h.axesplotstressdata,[h.ScatterData(valueSliderStress).StressesPhi],label);
    
    ylabel(h.axesplotstressdata,'<\sigma_{23}> [MPa]')
    
    set(h.plotstressdata,{'xdata','visible'},{StressPlotDatatmpsorted_tmp(:,1),'on'})
    set(h.plotstressdata,{'ydata','visible'},{StressPlotDatatmpsorted_tmp(:,8),'on'})
    set(h.plotstressdata,{'YNegativeDelta','visible'},{StressPlotDatatmpsorted_tmp(:,9),'on'})
    set(h.plotstressdata,{'YPositiveDelta','visible'},{StressPlotDatatmpsorted_tmp(:,9),'on'})
    set(h.plotstressdata,'LineStyle', '--')
        if size(StressPlotDatatmpsorted_tmp,1) == 1
            if isfield(h,'XlimChanged') && h.XlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.XLim = ([h.XlimMinnew(valueSliderStress) h.XlimMaxnew(valueSliderStress)]);
            else
                h.axesplotstressdata.XLim = [0,(ceil(max(StressPlotDatatmpsorted_tmp(:,1))*0.1)/0.1 + (ceil(max(StressPlotDatatmpsorted_tmp(:,1))*0.1)/0.1)./2)];
            end
            if isfield(h,'XlimXTicknew') && h.XlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.XTick = h.XlimMinnew(valueSliderStress):h.XlimXTicknew(valueSliderStress):h.XlimMaxnew(valueSliderStress);
            elseif isfield(h,'XlimXTicknew') && h.XlimChanged(valueSliderStress) == 0
                xticks(h.axesplotstressdata,'auto')    
            end
            if isfield(h,'YlimYTicknew') && h.YlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.YTick = h.YlimMinnew(valueSliderStress):h.YlimYTicknew(valueSliderStress):h.YlimMaxnew(valueSliderStress);
            elseif isfield(h,'YlimYTicknew') && h.YlimChanged(valueSliderStress) == 0
                yticks(h.axesplotstressdata,'auto')    
            end
            if isfield(h,'YlimChanged') && h.YlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.YLim = ([h.YlimMinnew(valueSliderStress) h.YlimMaxnew(valueSliderStress)]);
            else               
                YLimErr = [(min(StressPlotDatatmpsorted_tmp(:,8)) + max(StressPlotDatatmpsorted_tmp(:,9))) ...
                    (min(StressPlotDatatmpsorted_tmp(:,8)) - max(StressPlotDatatmpsorted_tmp(:,9))) ...
                    (max(StressPlotDatatmpsorted_tmp(:,8)) + max(StressPlotDatatmpsorted_tmp(:,9))) ...
                    (max(StressPlotDatatmpsorted_tmp(:,8)) - max(StressPlotDatatmpsorted_tmp(:,9)))];

                YLimtmp = [min(YLimErr) max(YLimErr)];

                YLimMinExpFactor = 1*10^(numel(num2str(abs(round(YLimtmp(1)))))-1);
                YLimMaxExpFactor = 1*10^(numel(num2str(abs(round(YLimtmp(2)))))-1);

                h.axesplotstressdata.YLim = [-(abs(floor(YLimtmp(1)/YLimMinExpFactor))*YLimMinExpFactor), ceil(YLimtmp(2)/YLimMaxExpFactor)*YLimMaxExpFactor];
            end
        else
            if isfield(h,'XlimChanged') && h.XlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.XLim = ([h.XlimMinnew(valueSliderStress) h.XlimMaxnew(valueSliderStress)]);
            else
                h.axesplotstressdata.XLim = [0,(ceil(max(StressPlotDatatmpsorted_tmp(:,1))*0.1)/0.1)];
            end
            if isfield(h,'XlimXTicknew') && h.XlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.XTick = h.XlimMinnew(valueSliderStress):h.XlimXTicknew(valueSliderStress):h.XlimMaxnew(valueSliderStress);
            elseif isfield(h,'XlimXTicknew') && h.XlimChanged(valueSliderStress) == 0
                xticks(h.axesplotstressdata,'auto')    
            end
            if isfield(h,'YlimYTicknew') && h.YlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.YTick = h.YlimMinnew(valueSliderStress):h.YlimYTicknew(valueSliderStress):h.YlimMaxnew(valueSliderStress);
            elseif isfield(h,'YlimYTicknew') && h.YlimChanged(valueSliderStress) == 0
                yticks(h.axesplotstressdata,'auto')    
            end
            if isfield(h,'YlimChanged') && h.YlimChanged(valueSliderStress) == 1
                h.axesplotstressdata.YLim = ([h.YlimMinnew(valueSliderStress) h.YlimMaxnew(valueSliderStress)]);
            else               
                YLimErr = [(min(StressPlotDatatmpsorted_tmp(:,8)) + max(StressPlotDatatmpsorted_tmp(:,9))) ...
                    (min(StressPlotDatatmpsorted_tmp(:,8)) - max(StressPlotDatatmpsorted_tmp(:,9))) ...
                    (max(StressPlotDatatmpsorted_tmp(:,8)) + max(StressPlotDatatmpsorted_tmp(:,9))) ...
                    (max(StressPlotDatatmpsorted_tmp(:,8)) - max(StressPlotDatatmpsorted_tmp(:,9)))];

                YLimtmp = [min(YLimErr) max(YLimErr)];

                YLimMinExpFactor = 1*10^(numel(num2str(abs(round(YLimtmp(1)))))-1);
                YLimMaxExpFactor = 1*10^(numel(num2str(abs(round(YLimtmp(2)))))-1);

                h.axesplotstressdata.YLim = [-(abs(floor(YLimtmp(1)/YLimMinExpFactor))*YLimMinExpFactor), ceil(YLimtmp(2)/YLimMaxExpFactor)*YLimMaxExpFactor];
            end
        end
end


for j = 1:length(ia{1})
    if j ~= valueSliderStress
        for k = 1:size(StressPlotDatatmpsorted_tmp,1)
            h.ScatterData(j).StressesPhi(k).Visible = 'off';
        end
    else
        for k = 1:size(StressPlotDatatmpsorted_tmp,1)
            h.ScatterData(j).StressesPhi(k).Visible = 'on';
        end
    end
end

guidata(hObj, h);

function SliderCallbackFitData(hObj, ~)
h = guidata(hObj);
% Get slider value
valueSlider = get(hObj, 'Value');
% Get slider value from fit data plot
valueSliderStressData = get(h.SliderStressData, 'Value');

% Set Slider options according to number of data points (updated values).
% Get checkbox values
CheckBoxesPhi = [get(h.checkboxphi0,'Value'),get(h.checkboxphi90,'Value'),get(h.checkboxphi180,'Value'),get(h.checkboxphi270,'Value')];
ChboxInd = find(CheckBoxesPhi == 1);
% Get phi angles of current measurement
for k = 1:size(h.ParamsToFit,2)
   PhiWinkel(k) =  h.ParamsToFit(k).Phi_Winkel{1}(1);
end
% Set slider properties
if length(ChboxInd) ~= 1
    set(h.SliderFitData,'Min',1);
    set(h.SliderFitData,'Max',length(h.ParamsToFit(1).Psi_Winkel{valueSliderStressData}));
    set(h.SliderFitData,'SliderStep',[1/(length(h.ParamsToFit(1).Psi_Winkel{valueSliderStressData})-1) 1/(length(h.ParamsToFit(1).Psi_Winkel{valueSliderStressData})-1)]);
%     assignin('base','SliderFitData',h.SliderFitData)
else
    if CheckBoxesPhi(1) == 1
        set(h.SliderFitData,'Min',1);
        set(h.SliderFitData,'Max',length(h.ParamsToFit(find(PhiWinkel==0)).Psi_Winkel{valueSliderStressData}));
        set(h.SliderFitData,'SliderStep',[1/(length(h.ParamsToFit(find(PhiWinkel==0)).Psi_Winkel{valueSliderStressData})-1) 1/(length(h.ParamsToFit(find(PhiWinkel==0)).Psi_Winkel{valueSliderStressData})-1)]);
    elseif CheckBoxesPhi(2) == 1
        set(h.SliderFitData,'Min',1);
        set(h.SliderFitData,'Max',length(h.ParamsToFit(find(PhiWinkel==90)).Psi_Winkel{valueSliderStressData}));
        set(h.SliderFitData,'SliderStep',[1/(length(h.ParamsToFit(find(PhiWinkel==90)).Psi_Winkel{valueSliderStressData})-1) 1/(length(h.ParamsToFit(find(PhiWinkel==90)).Psi_Winkel{valueSliderStressData})-1)]);
    elseif CheckBoxesPhi(3) == 1
        set(h.SliderFitData,'Min',1);
        set(h.SliderFitData,'Max',length(h.ParamsToFit(find(PhiWinkel==180)).Psi_Winkel{valueSliderStressData}));
        set(h.SliderFitData,'SliderStep',[1/(length(h.ParamsToFit(find(PhiWinkel==180)).Psi_Winkel{valueSliderStressData})-1) 1/(length(h.ParamsToFit(find(PhiWinkel==180)).Psi_Winkel{valueSliderStressData})-1)]);
    elseif CheckBoxesPhi(4) == 1
        set(h.SliderFitData,'Min',1);
        set(h.SliderFitData,'Max',length(h.ParamsToFit(find(PhiWinkel==270)).Psi_Winkel{valueSliderStressData}));
        set(h.SliderFitData,'SliderStep',[1/(length(h.ParamsToFit(find(PhiWinkel==270)).Psi_Winkel{valueSliderStressData})-1) 1/(length(h.ParamsToFit(find(PhiWinkel==270)).Psi_Winkel{valueSliderStressData})-1)]);
    end
end

if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    % In order to plot the correct spectra in cases where measurements for
    % multiple phi angles were conducted, get initial phi and psi angles from 
    % all measurements.
    for k = 1:size(h.Measurement,2)
        PhiWinkelMeas(k,:) = h.Measurement(k).SCSAngles.phi;
        PsiWinkelMeas(k,:) = h.Measurement(k).SCSAngles.psi;
    end
    % Get unique phi and psi angles of measurements
    NumberPhiAngles = unique(PhiWinkelMeas);
    NumberPsiAngles = unique(PsiWinkelMeas);
    % Get indices for each phi angle of the measurements. Those are used to 
    % find the correct spectra to be plotted.
    for k = 1:length(NumberPhiAngles)
        PhiIndexMeas(:,k) = find(PhiWinkelMeas == NumberPhiAngles(k));
    end
%     assignin('base','NumberPsiAngles',NumberPsiAngles)
    % Compare psi angles of current peak hkl with psi angles of measured
    % spectra and get correct indices of measured spectra.
    if length(ChboxInd) ~= 1
        idxPsi = ismember(NumberPsiAngles, h.ParamsToFit(1).Psi_Winkel{valueSliderStressData}, 'rows');
        MeasIndex = PhiIndexMeas(idxPsi,1);
    else
        if CheckBoxesPhi(1) == 1
            idxPsi = ismember(NumberPsiAngles, h.ParamsToFit(find(PhiWinkel==0)).Psi_Winkel{valueSliderStressData}, 'rows');
            MeasIndex = PhiIndexMeas(idxPsi,(find(NumberPhiAngles==0)));
        elseif CheckBoxesPhi(2) == 1
            idxPsi = ismember(NumberPsiAngles, h.ParamsToFit(find(PhiWinkel==90)).Psi_Winkel{valueSliderStressData}, 'rows');
            MeasIndex = PhiIndexMeas(idxPsi,(find(NumberPhiAngles==90)));
        elseif CheckBoxesPhi(3) == 1    
            idxPsi = ismember(NumberPsiAngles, h.ParamsToFit(find(PhiWinkel==180)).Psi_Winkel{valueSliderStressData}, 'rows');
            MeasIndex = PhiIndexMeas(idxPsi,(find(NumberPhiAngles==180)));
        elseif CheckBoxesPhi(4) == 1    
            idxPsi = ismember(NumberPsiAngles, h.ParamsToFit(find(PhiWinkel==270)).Psi_Winkel{valueSliderStressData}, 'rows');
            MeasIndex = PhiIndexMeas(idxPsi,(find(NumberPhiAngles==270)));
        end
    end
    % Set plot data and properties
    set(h.plotrawdata1,{'xdata','Visible'},{h.DataTmp{MeasIndex(valueSlider)}(:,1),'on'})
    set(h.plotrawdata1,{'ydata','Visible'},{h.DataTmp{MeasIndex(valueSlider)}(:,2),'on'})

    % Set data of fitted plots according to current slider value
    % RawData for current slider value
    XFit = h.DataTmp{MeasIndex(valueSlider)}(:, 1);
    YFit = h.DataTmp{MeasIndex(valueSlider)}(:, 2);
    % Fit-Data for current slider value
    XPlot = XFit(1):0.001:XFit(end);
    YPlot = zeros(size(XPlot));
    % Calculate fitted profile using Fitted PeakData for current slider value
    for d = 1:size(h.FittedPeaks{MeasIndex(valueSlider)}, 1)
        if h.P.PopupValueFitFunc == 2 %PV-Func
            SinglePlot = Tools.Science.Math.FF_PseudoVoigt(XPlot, ...
                h.FittedPeaks{MeasIndex(valueSlider)}(d, 1), h.FittedPeaks{MeasIndex(valueSlider)}(d, 2), h.FittedPeaks{MeasIndex(valueSlider)}(d, 3),h.FittedPeaks{MeasIndex(valueSlider)}(d, 4));
        elseif h.P.PopupValueFitFunc == 3 %TCH-Func
            SinglePlot = Tools.Science.Math.FF_TCH(XPlot, ...
                h.FittedPeaks{MeasIndex(valueSlider)}(d, 1), h.FittedPeaks{MeasIndex(valueSlider)}(d, 2), h.FittedPeaks{MeasIndex(valueSlider)}(d, 3),h.FittedPeaks{MeasIndex(valueSlider)}(d, 4));
        elseif h.P.PopupValueFitFunc == 4 %Gauss-Func
            SinglePlot = Tools.Science.Math.FF_Gauss(XPlot, ...
                h.FittedPeaks{MeasIndex(valueSlider)}(d, 1), h.FittedPeaks{MeasIndex(valueSlider)}(d, 2), h.FittedPeaks{MeasIndex(valueSlider)}(d, 3));
        elseif h.P.PopupValueFitFunc == 5 %Lorentz-Func
            SinglePlot = Tools.Science.Math.FF_Lorentz(XPlot, ...
                h.FittedPeaks{MeasIndex(valueSlider)}(d, 1), h.FittedPeaks{MeasIndex(valueSlider)}(d, 2), h.FittedPeaks{MeasIndex(valueSlider)}(d, 3));
        end
%             SinglePlot = Tools.Science.Math.FF_PseudoVoigt(XPlot, ...
%                 h.FittedPeaks{MeasIndex(valueSlider)}(d, 1), h.FittedPeaks{MeasIndex(valueSlider)}(d, 2), h.FittedPeaks{MeasIndex(valueSlider)}(d, 3),h.FittedPeaks{MeasIndex(valueSlider)}(d, 4));
        YPlot = YPlot + SinglePlot;
    end
    % Set plot properties
    set(h.axesplotfitdata.Title,'String',['Fitted peaks for ', h.Measurement(MeasIndex(valueSlider)).Name])
    % Set Ylim for plot
    % Find index of Emax in DataTmp
    idxEmax = find(round(h.DataTmp{MeasIndex(valueSlider)}(:,1),1) == round(h.FittedPeaks{MeasIndex(valueSlider)}(valueSliderStressData,2),1));
    % Find Ymax in the range +/- 25 channels of idxEmax 
    YMax  = max(h.DataTmp{MeasIndex(valueSlider)}((idxEmax(5)-25:idxEmax(5)+25),2));
    % Get numel of Ymax
    ExpPlot = numel(num2str(round(YMax,-1)));
elseif strcmp(h.Diffsel,'LEDDI')
    if strcmp(h.Detsel,'Detector 1')
        Slidersteps = 2:2:length(h.Measurement);
        % In order to plot the correct spectra in cases where measurements for
        % multiple phi angles were conducted, get initial phi and psi angles from 
        % all measurements.
        for k = 1:length(Slidersteps)
            PhiWinkelMeas(k,:) = h.Measurement(Slidersteps(k)).SCSAngles.phi;
            PsiWinkelMeas(k,:) = h.Measurement(Slidersteps(k)).SCSAngles.psi;
        end
        % Get unique phi and psi angles of measurements
        NumberPhiAngles = unique(PhiWinkelMeas);
        NumberPsiAngles = unique(PsiWinkelMeas);
        % Get indices for each phi angle of the measurements. Those are used to 
        % find the correct spectra to be plotted.
        for k = 1:length(NumberPhiAngles)
            PhiIndexMeas(:,k) = find(PhiWinkelMeas == NumberPhiAngles(k));
        end
        % Compare psi angles of current peak hkl with psi angles of measured
        % spectra and get correct indices of measured spectra.
        if length(ChboxInd) ~= 1
            idxPsi = ismember(NumberPsiAngles, h.ParamsToFit(1).Psi_Winkel{valueSliderStressData}, 'rows');
            MeasIndex = PhiIndexMeas(idxPsi,1);
        else
            if CheckBoxesPhi(1) == 1
                idxPsi = ismember(NumberPsiAngles, h.ParamsToFit(find(PhiWinkel==0)).Psi_Winkel{valueSliderStressData}, 'rows');
                MeasIndex = PhiIndexMeas(idxPsi,(find(NumberPhiAngles==0)));
            elseif CheckBoxesPhi(2) == 1
                idxPsi = ismember(NumberPsiAngles, h.ParamsToFit(find(PhiWinkel==90)).Psi_Winkel{valueSliderStressData}, 'rows');
                MeasIndex = PhiIndexMeas(idxPsi,(find(NumberPhiAngles==90)));
            elseif CheckBoxesPhi(3) == 1    
                idxPsi = ismember(NumberPsiAngles, h.ParamsToFit(find(PhiWinkel==180)).Psi_Winkel{valueSliderStressData}, 'rows');
                MeasIndex = PhiIndexMeas(idxPsi,(find(NumberPhiAngles==180)));
            elseif CheckBoxesPhi(4) == 1    
                idxPsi = ismember(NumberPsiAngles, h.ParamsToFit(find(PhiWinkel==270)).Psi_Winkel{valueSliderStressData}, 'rows');
                MeasIndex = PhiIndexMeas(idxPsi,(find(NumberPhiAngles==270)));
            end
        end
        
        %Set plot data and properties
        set(h.plotrawdata1,{'xdata','Visible'},{h.DataTmp{Slidersteps(MeasIndex(valueSlider))}(:,1),'on'})
        set(h.plotrawdata1,{'ydata','Visible'},{h.DataTmp{Slidersteps(MeasIndex(valueSlider))}(:,2),'on'})

        % Set data of fitted plots according to current slider value
        % RawData for current slider value
        XFit = h.DataTmp{Slidersteps(MeasIndex(valueSlider))}(:, 1);
        YFit = h.DataTmp{Slidersteps(MeasIndex(valueSlider))}(:, 2);
        % Fit-Data for current slider value
        XPlot = XFit(1):0.001:XFit(end);
        YPlot = zeros(size(XPlot));
        % Calculate fitted profile using Fitted PeakData for current slider value
        for d = 1:size(h.FittedPeaksDet1{MeasIndex(valueSlider)}, 1)
            if h.P.PopupValueFitFunc == 2 %PV-Func
                SinglePlot = Tools.Science.Math.FF_PseudoVoigt(XPlot, ...
                h.FittedPeaksDet1{MeasIndex(valueSlider)}(d, 1), h.FittedPeaksDet1{MeasIndex(valueSlider)}(d, 2), h.FittedPeaksDet1{MeasIndex(valueSlider)}(d, 3),h.FittedPeaksDet1{MeasIndex(valueSlider)}(d, 4));
            elseif h.P.PopupValueFitFunc == 3 %TCH-Func
                SinglePlot = Tools.Science.Math.FF_TCH(XPlot, ...
                h.FittedPeaksDet1{MeasIndex(valueSlider)}(d, 1), h.FittedPeaksDet1{MeasIndex(valueSlider)}(d, 2), h.FittedPeaksDet1{MeasIndex(valueSlider)}(d, 3),h.FittedPeaksDet1{MeasIndex(valueSlider)}(d, 4));
            elseif h.P.PopupValueFitFunc == 4 %Gauss-Func
                SinglePlot = Tools.Science.Math.FF_Gauss(XPlot, ...
                h.FittedPeaksDet1{MeasIndex(valueSlider)}(d, 1), h.FittedPeaksDet1{MeasIndex(valueSlider)}(d, 2), h.FittedPeaksDet1{MeasIndex(valueSlider)}(d, 3));
            elseif h.P.PopupValueFitFunc == 5 %Lorentz-Func
                SinglePlot = Tools.Science.Math.FF_Lorentz(XPlot, ...
                h.FittedPeaksDet1{MeasIndex(valueSlider)}(d, 1), h.FittedPeaksDet1{MeasIndex(valueSlider)}(d, 2), h.FittedPeaksDet1{MeasIndex(valueSlider)}(d, 3));
            end
%             SinglePlot = Tools.Science.Math.FF_PseudoVoigt(XPlot, ...
%                 h.FittedPeaksDet1{MeasIndex(valueSlider)}(d, 1), h.FittedPeaksDet1{MeasIndex(valueSlider)}(d, 2), h.FittedPeaksDet1{MeasIndex(valueSlider)}(d, 3),h.FittedPeaksDet1{MeasIndex(valueSlider)}(d, 4));
            YPlot = YPlot + SinglePlot;
        end
        % Set plot properties
        set(h.axesplotfitdata.Title,'String',['Fitted peaks for ', h.Measurement(Slidersteps(MeasIndex(valueSlider))).Name])
        % Set Ylim for plot
        % Find index of Emax in DataTmp
        idxEmax = find(round(h.DataTmp{Slidersteps(MeasIndex(valueSlider))}(:,1),1) == round(h.FittedPeaksDet1{MeasIndex(valueSlider)}(valueSliderStressData,2),1));
        % Find Ymax in the range +/- 25 channels of idxEmax 
        YMax  = max(h.DataTmp{Slidersteps(MeasIndex(valueSlider))}((idxEmax(5)-25:idxEmax(5)+25),2));
        % Get numel of Ymax
        ExpPlot = numel(num2str(round(YMax,-1)));
    elseif strcmp(h.Detsel,'Detector 2')
        Slidersteps = 1:2:length(h.Measurement);
        % In order to plot the correct spectra in cases where measurements for
        % multiple phi angles were conducted, get initial phi and psi angles from 
        % all measurements.
        for k = 1:length(Slidersteps)
            PhiWinkelMeas(k,:) = h.Measurement(Slidersteps(k)).SCSAngles.phi;
            PsiWinkelMeas(k,:) = h.Measurement(Slidersteps(k)).SCSAngles.psi;
        end
        % Get unique phi and psi angles of measurements
        NumberPhiAngles = unique(PhiWinkelMeas);
        NumberPsiAngles = unique(PsiWinkelMeas);
        % Get indices for each phi angle of the measurements. Those are used to 
        % find the correct spectra to be plotted.
        for k = 1:length(NumberPhiAngles)
            PhiIndexMeas(:,k) = find(PhiWinkelMeas == NumberPhiAngles(k));
        end
        % Compare psi angles of current peak hkl with psi angles of measured
        % spectra and get correct indices of measured spectra.
        if length(ChboxInd) ~= 1
            idxPsi = ismember(NumberPsiAngles, h.ParamsToFit(1).Psi_Winkel{valueSliderStressData}, 'rows');
            MeasIndex = PhiIndexMeas(idxPsi,1);
        else
            if CheckBoxesPhi(1) == 1
                idxPsi = ismember(NumberPsiAngles, h.ParamsToFit(find(PhiWinkel==0)).Psi_Winkel{valueSliderStressData}, 'rows');
                MeasIndex = PhiIndexMeas(idxPsi,(find(NumberPhiAngles==0)));
            elseif CheckBoxesPhi(2) == 1
                idxPsi = ismember(NumberPsiAngles, h.ParamsToFit(find(PhiWinkel==90)).Psi_Winkel{valueSliderStressData}, 'rows');
                MeasIndex = PhiIndexMeas(idxPsi,(find(NumberPhiAngles==90)));
            elseif CheckBoxesPhi(3) == 1    
                idxPsi = ismember(NumberPsiAngles, h.ParamsToFit(find(PhiWinkel==180)).Psi_Winkel{valueSliderStressData}, 'rows');
                MeasIndex = PhiIndexMeas(idxPsi,(find(NumberPhiAngles==180)));
            elseif CheckBoxesPhi(4) == 1    
                idxPsi = ismember(NumberPsiAngles, h.ParamsToFit(find(PhiWinkel==270)).Psi_Winkel{valueSliderStressData}, 'rows');
                MeasIndex = PhiIndexMeas(idxPsi,(find(NumberPhiAngles==270)));
            end
        end
        %Set plot data and properties
        set(h.plotrawdata1,{'xdata','Visible'},{h.DataTmp{Slidersteps(MeasIndex(valueSlider))}(:,1),'on'})
        set(h.plotrawdata1,{'ydata','Visible'},{h.DataTmp{Slidersteps(MeasIndex(valueSlider))}(:,2),'on'})

        % Set data of fitted plots according to current slider value
        % RawData for current slider value
        XFit = h.DataTmp{Slidersteps(MeasIndex(valueSlider))}(:, 1);
        YFit = h.DataTmp{Slidersteps(MeasIndex(valueSlider))}(:, 2);
        % Fit-Data for current slider value
        XPlot = XFit(1):0.001:XFit(end);
        YPlot = zeros(size(XPlot));
        % Calculate fitted profile using Fitted PeakData for current slider value
        for d = 1:size(h.FittedPeaksDet2{MeasIndex(valueSlider)}, 1)
            if h.P.PopupValueFitFunc == 2 %PV-Func
                SinglePlot = Tools.Science.Math.FF_PseudoVoigt(XPlot, ...
                h.FittedPeaksDet2{MeasIndex(valueSlider)}(d, 1), h.FittedPeaksDet2{MeasIndex(valueSlider)}(d, 2), h.FittedPeaksDet2{MeasIndex(valueSlider)}(d, 3),h.FittedPeaksDet2{MeasIndex(valueSlider)}(d, 4));
            elseif h.P.PopupValueFitFunc == 3 %TCH-Func
                SinglePlot = Tools.Science.Math.FF_TCH(XPlot, ...
                h.FittedPeaksDet2{MeasIndex(valueSlider)}(d, 1), h.FittedPeaksDet2{MeasIndex(valueSlider)}(d, 2), h.FittedPeaksDet2{MeasIndex(valueSlider)}(d, 3),h.FittedPeaksDet2{MeasIndex(valueSlider)}(d, 4));
            elseif h.P.PopupValueFitFunc == 4 %Gauss-Func
                SinglePlot = Tools.Science.Math.FF_Gauss(XPlot, ...
                h.FittedPeaksDet2{MeasIndex(valueSlider)}(d, 1), h.FittedPeaksDet2{MeasIndex(valueSlider)}(d, 2), h.FittedPeaksDet2{MeasIndex(valueSlider)}(d, 3));
            elseif h.P.PopupValueFitFunc == 5 %Lorentz-Func
                SinglePlot = Tools.Science.Math.FF_Lorentz(XPlot, ...
                h.FittedPeaksDet2{MeasIndex(valueSlider)}(d, 1), h.FittedPeaksDet2{MeasIndex(valueSlider)}(d, 2), h.FittedPeaksDet2{MeasIndex(valueSlider)}(d, 3));
            end
%             SinglePlot = Tools.Science.Math.FF_PseudoVoigt(XPlot, ...
%                 h.FittedPeaksDet2{MeasIndex(valueSlider)}(d, 1), h.FittedPeaksDet2{MeasIndex(valueSlider)}(d, 2), h.FittedPeaksDet2{MeasIndex(valueSlider)}(d, 3),h.FittedPeaksDet2{MeasIndex(valueSlider)}(d, 4));
            YPlot = YPlot + SinglePlot;
        end
        % Set plot properties
        set(h.axesplotfitdata.Title,'String',['Fitted peaks for ', h.Measurement(Slidersteps(MeasIndex(valueSlider))).Name])
        % Set Ylim for plot
        % Find index of Emax in DataTmp
        idxEmax = find(round(h.DataTmp{Slidersteps(MeasIndex(valueSlider))}(:,1),1) == round(h.FittedPeaksDet2{MeasIndex(valueSlider)}(valueSliderStressData,2),1));
        % Find Ymax in the range +/- 25 channels of idxEmax 
        YMax  = max(h.DataTmp{Slidersteps(MeasIndex(valueSlider))}((idxEmax(5)-25:idxEmax(5)+25),2));
        % Get numel of Ymax
        ExpPlot = numel(num2str(round(YMax,-1)));
    end
end

% Add plots of fitted peaks to axes for current slider value
set(h.plotfitdata1,'xdata',XPlot)
set(h.plotfitdata1,'ydata',YPlot)
set(h.plotresiualdata1,'xdata',XFit)

% Set ydata of plot residual
% set(h.plotresiualdata1,'ydata',(YFit - interp1(XPlot,YPlot,XFit)) - (max(YFit) .* 0.5.*(scalevalue)))
YFitPlotdata = (YFit - interp1(XPlot,YPlot,XFit)) - abs(round(max(YPlot)) + round(min(YPlot)))/2;
set(h.plotresiualdata1,'ydata',YFitPlotdata)
set(h.plotresiualdata1,'visible','off')

h.axesplotfitdata.XLim = [round(h.Params.Energy_Max{valueSliderStressData}(1),2)-1.5,round(h.Params.Energy_Max{valueSliderStressData}(1),2)+1.5];
h.axesplotfitdata.YLim = [0 round(YMax/(1*10^(ExpPlot-2))).*1*10^(ExpPlot-2)];

% Create text element with value of psi angle
% Delete current text element and replace with new one when slider is
% pushed
if isfield(h,'ptext')
    delete(h.ptext)
end

if length(ChboxInd) ~= 1
    if numel(num2str(round(h.ParamsToFit(1).Psi_Winkel{valueSliderStressData}(valueSlider),2))) == 1
        h.ptext = text(h.axesplotfitdata,0.903,0.92,['\psi =',' ', num2str(round(h.ParamsToFit(1).Psi_Winkel{valueSliderStressData}(valueSlider),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');
    elseif numel(num2str(round(h.ParamsToFit(1).Psi_Winkel{valueSliderStressData}(valueSlider),2))) == 2
        h.ptext = text(h.axesplotfitdata,0.89,0.92,['\psi =',' ', num2str(round(h.ParamsToFit(1).Psi_Winkel{valueSliderStressData}(valueSlider),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');
    elseif numel(num2str(round(h.ParamsToFit(1).Psi_Winkel{valueSliderStressData}(valueSlider),2))) == 3
        h.ptext = text(h.axesplotfitdata,0.879,0.92,['\psi =',' ', num2str(round(h.ParamsToFit(1).Psi_Winkel{valueSliderStressData}(valueSlider),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');
    elseif numel(num2str(round(h.ParamsToFit(1).Psi_Winkel{valueSliderStressData}(valueSlider),2))) == 4
        h.ptext = text(h.axesplotfitdata,0.869,0.92,['\psi =',' ', num2str(round(h.ParamsToFit(1).Psi_Winkel{valueSliderStressData}(valueSlider),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');       
    elseif numel(num2str(round(h.ParamsToFit(1).Psi_Winkel{valueSliderStressData}(valueSlider),2))) == 5
        h.ptext = text(h.axesplotfitdata,0.859,0.92,['\psi =',' ', num2str(round(h.ParamsToFit(1).Psi_Winkel{valueSliderStressData}(valueSlider),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');
    elseif numel(num2str(round(h.ParamsToFit(1).Psi_Winkel{valueSliderStressData}(valueSlider),2))) == 6
        h.ptext = text(h.axesplotfitdata,0.859,0.92,['\psi =',' ', num2str(round(h.ParamsToFit(1).Psi_Winkel{valueSliderStressData}(valueSlider),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');    
    end
else
    if CheckBoxesPhi(1) == 1
        if numel(num2str(round(h.ParamsToFit(find(PhiWinkel==0)).Psi_Winkel{valueSliderStressData}(valueSlider),2))) == 1
            h.ptext = text(h.axesplotfitdata,0.903,0.92,['\psi =',' ', num2str(round(h.ParamsToFit(find(PhiWinkel==0)).Psi_Winkel{valueSliderStressData}(valueSlider),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');
        elseif numel(num2str(round(h.ParamsToFit(find(PhiWinkel==0)).Psi_Winkel{valueSliderStressData}(valueSlider),2))) == 2
            h.ptext = text(h.axesplotfitdata,0.89,0.92,['\psi =',' ', num2str(round(h.ParamsToFit(find(PhiWinkel==0)).Psi_Winkel{valueSliderStressData}(valueSlider),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');
        elseif numel(num2str(round(h.ParamsToFit(find(PhiWinkel==0)).Psi_Winkel{valueSliderStressData}(valueSlider),2))) == 3
            h.ptext = text(h.axesplotfitdata,0.879,0.92,['\psi =',' ', num2str(round(h.ParamsToFit(find(PhiWinkel==0)).Psi_Winkel{valueSliderStressData}(valueSlider),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');
        elseif numel(num2str(round(h.ParamsToFit(find(PhiWinkel==0)).Psi_Winkel{valueSliderStressData}(valueSlider),2))) == 4
            h.ptext = text(h.axesplotfitdata,0.869,0.92,['\psi =',' ', num2str(round(h.ParamsToFit(find(PhiWinkel==0)).Psi_Winkel{valueSliderStressData}(valueSlider),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');       
        elseif numel(num2str(round(h.ParamsToFit(find(PhiWinkel==0)).Psi_Winkel{valueSliderStressData}(valueSlider),2))) == 5
            h.ptext = text(h.axesplotfitdata,0.859,0.92,['\psi =',' ', num2str(round(h.ParamsToFit(find(PhiWinkel==0)).Psi_Winkel{valueSliderStressData}(valueSlider),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');
        elseif numel(num2str(round(h.ParamsToFit(find(PhiWinkel==0)).Psi_Winkel{valueSliderStressData}(valueSlider),2))) == 6
            h.ptext = text(h.axesplotfitdata,0.859,0.92,['\psi =',' ', num2str(round(h.ParamsToFit(find(PhiWinkel==0)).Psi_Winkel{valueSliderStressData}(valueSlider),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');    
        end
    elseif CheckBoxesPhi(2) == 1
        if numel(num2str(round(h.ParamsToFit(find(PhiWinkel==90)).Psi_Winkel{valueSliderStressData}(valueSlider),2))) == 1
            h.ptext = text(h.axesplotfitdata,0.903,0.92,['\psi =',' ', num2str(round(h.ParamsToFit(find(PhiWinkel==90)).Psi_Winkel{valueSliderStressData}(valueSlider),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');
        elseif numel(num2str(round(h.ParamsToFit(find(PhiWinkel==90)).Psi_Winkel{valueSliderStressData}(valueSlider),2))) == 2
            h.ptext = text(h.axesplotfitdata,0.89,0.92,['\psi =',' ', num2str(round(h.ParamsToFit(find(PhiWinkel==90)).Psi_Winkel{valueSliderStressData}(valueSlider),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');
        elseif numel(num2str(round(h.ParamsToFit(find(PhiWinkel==90)).Psi_Winkel{valueSliderStressData}(valueSlider),2))) == 3
            h.ptext = text(h.axesplotfitdata,0.879,0.92,['\psi =',' ', num2str(round(h.ParamsToFit(find(PhiWinkel==90)).Psi_Winkel{valueSliderStressData}(valueSlider),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');
        elseif numel(num2str(round(h.ParamsToFit(find(PhiWinkel==90)).Psi_Winkel{valueSliderStressData}(valueSlider),2))) == 4
            h.ptext = text(h.axesplotfitdata,0.869,0.92,['\psi =',' ', num2str(round(h.ParamsToFit(find(PhiWinkel==90)).Psi_Winkel{valueSliderStressData}(valueSlider),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');       
        elseif numel(num2str(round(h.ParamsToFit(find(PhiWinkel==90)).Psi_Winkel{valueSliderStressData}(valueSlider),2))) == 5
            h.ptext = text(h.axesplotfitdata,0.859,0.92,['\psi =',' ', num2str(round(h.ParamsToFit(find(PhiWinkel==90)).Psi_Winkel{valueSliderStressData}(valueSlider),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');
        elseif numel(num2str(round(h.ParamsToFit(find(PhiWinkel==90)).Psi_Winkel{valueSliderStressData}(valueSlider),2))) == 6
            h.ptext = text(h.axesplotfitdata,0.859,0.92,['\psi =',' ', num2str(round(h.ParamsToFit(find(PhiWinkel==90)).Psi_Winkel{valueSliderStressData}(valueSlider),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');    
        end
    elseif CheckBoxesPhi(3) == 1
        if numel(num2str(round(h.ParamsToFit(find(PhiWinkel==180)).Psi_Winkel{valueSliderStressData}(valueSlider),2))) == 1
            h.ptext = text(h.axesplotfitdata,0.903,0.92,['\psi =',' ', num2str(round(h.ParamsToFit(find(PhiWinkel==180)).Psi_Winkel{valueSliderStressData}(valueSlider),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');
        elseif numel(num2str(round(h.ParamsToFit(find(PhiWinkel==180)).Psi_Winkel{valueSliderStressData}(valueSlider),2))) == 2
            h.ptext = text(h.axesplotfitdata,0.89,0.92,['\psi =',' ', num2str(round(h.ParamsToFit(find(PhiWinkel==180)).Psi_Winkel{valueSliderStressData}(valueSlider),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');
        elseif numel(num2str(round(h.ParamsToFit(find(PhiWinkel==180)).Psi_Winkel{valueSliderStressData}(valueSlider),2))) == 3
            h.ptext = text(h.axesplotfitdata,0.879,0.92,['\psi =',' ', num2str(round(h.ParamsToFit(find(PhiWinkel==180)).Psi_Winkel{valueSliderStressData}(valueSlider),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');
        elseif numel(num2str(round(h.ParamsToFit(find(PhiWinkel==180)).Psi_Winkel{valueSliderStressData}(valueSlider),2))) == 4
            h.ptext = text(h.axesplotfitdata,0.869,0.92,['\psi =',' ', num2str(round(h.ParamsToFit(find(PhiWinkel==180)).Psi_Winkel{valueSliderStressData}(valueSlider),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');       
        elseif numel(num2str(round(h.ParamsToFit(find(PhiWinkel==180)).Psi_Winkel{valueSliderStressData}(valueSlider),2))) == 5
            h.ptext = text(h.axesplotfitdata,0.859,0.92,['\psi =',' ', num2str(round(h.ParamsToFit(find(PhiWinkel==180)).Psi_Winkel{valueSliderStressData}(valueSlider),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');
        elseif numel(num2str(round(h.ParamsToFit(find(PhiWinkel==180)).Psi_Winkel{valueSliderStressData}(valueSlider),2))) == 6
            h.ptext = text(h.axesplotfitdata,0.859,0.92,['\psi =',' ', num2str(round(h.ParamsToFit(find(PhiWinkel==180)).Psi_Winkel{valueSliderStressData}(valueSlider),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');    
        end
    elseif CheckBoxesPhi(4) == 1
        if numel(num2str(round(h.ParamsToFit(find(PhiWinkel==270)).Psi_Winkel{valueSliderStressData}(valueSlider),2))) == 1
            h.ptext = text(h.axesplotfitdata,0.903,0.92,['\psi =',' ', num2str(round(h.ParamsToFit(find(PhiWinkel==270)).Psi_Winkel{valueSliderStressData}(valueSlider),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');
        elseif numel(num2str(round(h.ParamsToFit(find(PhiWinkel==270)).Psi_Winkel{valueSliderStressData}(valueSlider),2))) == 2
            h.ptext = text(h.axesplotfitdata,0.89,0.92,['\psi =',' ', num2str(round(h.ParamsToFit(find(PhiWinkel==270)).Psi_Winkel{valueSliderStressData}(valueSlider),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');
        elseif numel(num2str(round(h.ParamsToFit(find(PhiWinkel==270)).Psi_Winkel{valueSliderStressData}(valueSlider),2))) == 3
            h.ptext = text(h.axesplotfitdata,0.879,0.92,['\psi =',' ', num2str(round(h.ParamsToFit(find(PhiWinkel==270)).Psi_Winkel{valueSliderStressData}(valueSlider),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');
        elseif numel(num2str(round(h.ParamsToFit(find(PhiWinkel==270)).Psi_Winkel{valueSliderStressData}(valueSlider),2))) == 4
            h.ptext = text(h.axesplotfitdata,0.869,0.92,['\psi =',' ', num2str(round(h.ParamsToFit(find(PhiWinkel==270)).Psi_Winkel{valueSliderStressData}(valueSlider),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');       
        elseif numel(num2str(round(h.ParamsToFit(find(PhiWinkel==270)).Psi_Winkel{valueSliderStressData}(valueSlider),2))) == 5
            h.ptext = text(h.axesplotfitdata,0.859,0.92,['\psi =',' ', num2str(round(h.ParamsToFit(find(PhiWinkel==270)).Psi_Winkel{valueSliderStressData}(valueSlider),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');
        elseif numel(num2str(round(h.ParamsToFit(find(PhiWinkel==270)).Psi_Winkel{valueSliderStressData}(valueSlider),2))) == 6
            h.ptext = text(h.axesplotfitdata,0.859,0.92,['\psi =',' ', num2str(round(h.ParamsToFit(find(PhiWinkel==270)).Psi_Winkel{valueSliderStressData}(valueSlider),2)), char(176)],'Units','normalized','FontSize', 12, 'EdgeColor', 'k', 'BackgroundColor','w');    
        end
    end
end

guidata(hObj, h);

% Various callbacks 
function clearbuttondown(hObj,~)
set(hObj, 'String','','Enable','on');
uicontrol(hObj);

function my_Figclosereq(hObj, ~, ~)
h = guidata(hObj);
set(hObj, 'Visible', 'off')
% set(h.figDEKtable, 'Visible', 'off')
guidata(hObj, h);

function my_Figclosereq2(hObj, ~, ~)
h = guidata(hObj);
% set(h.figSelectPeaktable, 'Visible', 'off')
set(hObj, 'Visible', 'off')
guidata(hObj, h);

function checkboxEditTableData(hObj, ~, ~)
h = guidata(hObj);

if (get(hObj,'Value')) == 0
    set(h.tablepsifile,'CellSelectionCallback',{@PsiFileTableData_CellEditCallback2});
elseif (get(hObj,'Value')) == 1
    set(h.tablepsifile,'CellSelectionCallback',{@PsiFileTableData_CellEditCallback1});
end
 
guidata(hObj, h);

% Load additional theoretical peak positions
function okbuttonloadEtheo(hObj,~)
% Callback for "Load Measurement" ok pushbutton
h = guidata(hObj);

% Get MPD filename and elemental formulae
h.P.MPDFileName = h.P.PopupLoadMPDEtheo;
h.P.ElementalFormula = get(h.texteditfieldEtheo,'string');

MPDFileName = h.P.MPDFileName; 
ElementalFormula = h.P.ElementalFormula;
% Create sample object in order to use sample functions
h.P.Material = Sample.Material();
h.P.Material.ElementalFormula = ElementalFormula;
h.P.Material.GetElementsFromFormula();
% Import and read the mpd file.
h.P.MaterialInfo = h.P.Material.LoadFromMpdFile(MPDFileName);
% Assign the respective property of the material.
h.P.Material.MaterialDensity = h.P.MaterialInfo.MaterialDensity;
h.P.Material.LatticeParameter = h.P.MaterialInfo.LatticeParameter;
h.P.Material.CrystalStructure = h.P.MaterialInfo.CrystalStructure;
h.P.Material.MolecularWeight = h.P.MaterialInfo.MolecularWeight;
h.P.Material.HKLdspacing = h.P.MaterialInfo.HKLdspacing;
h.P.Material.Name = MPDFileName;
% Default value for maximum energy.
if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    if isfield(h, 'P.EnergyRange')
        h.P.Material.EnergyMax = h.P.EnergyRange(2);
    else
        h.P.Material.EnergyMax = 133;
    end
elseif strcmp(h.Diffsel,'LEDDI')
    if strcmp(h.Detsel,'Detector 1')
        if isfield(h, 'P.EnergyRangeDet1')
            h.P.Material.EnergyMax = h.P.EnergyRangeDet1(2);
        else
            h.P.Material.EnergyMax = 60;
        end
    elseif strcmp(h.Detsel,'Detector 2')
        if isfield(h, 'P.EnergyRangeDet2')
            h.P.Material.EnergyMax = h.P.EnergyRangeDet2(2);
        else
            h.P.Material.EnergyMax = 60;
        end
    end
end

% Properties needed from measurement object
if strcmp(h.Diffsel,'LEDDI')
    h.P.LengthMeas = length(h.Measurement)/2;
else
    h.P.LengthMeas = length(h.Measurement);
end
h.P.twotheta = h.Measurement(1).twotheta;
% a = h.P.twotheta;
% a
% Calculate theoretical peak positions
h.PeaksTheoAdd = TheoreticalPeakPositionsAdd(h.P.Material,h.P.LengthMeas,h.P.twotheta,h.DataTmp);
a = h.PeaksTheoAdd.T.Etheo < h.PeaksTheoAdd.T.EMax;
h.EtheoLimitPeaksAdd1 = h.PeaksTheoAdd.T.Etheo(a);
X1Limit = h.PeaksTheoAdd.T.X1(a,:);
X3Limit = h.PeaksTheoAdd.T.X3((1:(3*length(h.EtheoLimitPeaksAdd1)-1)),:);
Y3Limit = h.PeaksTheoAdd.T.Y3((1:(3*length(h.EtheoLimitPeaksAdd1)-1)),:);
% assignin('base','Y3Limit',Y3Limit)
% assignin('base','X3Limit',X3Limit)
% Set plot data for additional theoretical line positions
set(h.plotEtheoAdd1,'xdata',X3Limit(:,1))
% Check selected column for Y3Limit
set(h.plotEtheoAdd1,'ydata',Y3Limit(:,2))
set(h.plotEtheoAdd1,'visible','on')

guidata(hObj, h);

function buttonhideEtheo(hObj, ~)
h = guidata(hObj);

set(h.plotEtheoAdd1,'visible','off')

guidata(hObj, h);

function LoadMPDMenu(hObj,~)
% Callback for "pop up menu" in create sample panel
h = guidata(hObj);
% Determine the selected data set.
str = get(hObj, 'String');
val = get(hObj, 'Value');
h.P.PopupLoadMPDEtheo = str{val};

guidata(hObj,h);

% Load additional theoretical fluorescence peak positions
function okbuttonloadFluorescence(hObj,~)
% Callback for "Load Measurement" ok pushbutton
h = guidata(hObj);
% Get slider value from raw data
slidervalue = get(h.Slider, 'Value');

% Default value for maximum energy.
if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    if isfield(h, 'P.EnergyRange')
        h.P.Material.EnergyMax = h.P.EnergyRange(2);
    else
        h.P.Material.EnergyMax = 133;
    end
elseif strcmp(h.Diffsel,'LEDDI')
    if strcmp(h.Detsel,'Detector 1')
        if isfield(h, 'P.EnergyRangeDet1')
            h.P.Material.EnergyMax = h.P.EnergyRangeDet1(2);
        else
            h.P.Material.EnergyMax = 60;
        end
    elseif strcmp(h.Detsel,'Detector 2')
        if isfield(h, 'P.EnergyRangeDet2')
            h.P.Material.EnergyMax = h.P.EnergyRangeDet2(2);
        else
            h.P.Material.EnergyMax = 60;
        end
    end
end

% Read selected element for which the fluorescence lines should be plotted.
Element = h.P.PopupLoadElement;
% Load fluorescence data.
FluorElements = h.FluorCellArray;
% Find index of the selected element.
IndexFE = strfind(FluorElements{1,2}, Element);
Index = find(not(cellfun('isempty', IndexFE)));
% Selected fluorescence lines to plot, column names are:
% No.;Element;Ka1;Ka2;Kb1;La1;La2;Lb1;Lb2;Lg1
Ka1 = FluorElements{1,3}(Index);
Ka2 = FluorElements{1,4}(Index);
Kb1 = FluorElements{1,5}(Index);
% Not yet included
La1 = FluorElements{1,6}(Index);
La2 = FluorElements{1,7}(Index);
Lb1 = FluorElements{1,8}(Index);
Lb2 = FluorElements{1,9}(Index);
Lg1 = FluorElements{1,10}(Index);
% Prepare data for line plot.
EMax = h.P.Material.EnergyMax;
% Save fluorescence lines into temporary vector.
k_tmp = [Ka1 Ka2 Kb1 La1 La2 Lb1 Lb2 Lg1];
h.FluorPos = k_tmp;
% Check if E(k_tmp) < EMax and save into array.
for k = 1:8
    if k_tmp(k) < EMax
        k_tmp1(k,:) = [k_tmp(k) k_tmp(k) nan];
    end
end

% Reshape array in order to plot as line plot.
k_tmp2 = reshape(k_tmp1',size(k_tmp1,1)*size(k_tmp1,2),1);
k_tmp2(size(k_tmp1,1)*size(k_tmp1,2),:) = [];
h.FluorPos1 = k_tmp1;
h.FluorPos2 = k_tmp2;

% Create array with y values for the fluorescence line plot.
if strcmp(h.Diffsel,'LEDDI')
    % If LEDDI has been used for the measurement
        if strcmp(h.Detsel,'Detector 1')
            Slidersteps = 2:2:length(h.Measurement);
            y_tmp = repmat([0 max(h.DataTmp{Slidersteps(slidervalue)}(:,2)) nan],1,size(k_tmp1,1))';
            y_tmp(size(k_tmp1,1)*size(k_tmp1,2),:) = [];
        elseif strcmp(h.Detsel,'Detector 2')
            Slidersteps = 1:2:length(h.Measurement);
            y_tmp = repmat([0 max(h.DataTmp{Slidersteps(slidervalue)}(:,2)) nan],1,size(k_tmp1,1))';
            y_tmp(size(k_tmp1,1)*size(k_tmp1,2),:) = [];
        end
else
	y_tmp = repmat([0 max(h.DataTmp{1}(:,2)) nan],1,size(k_tmp1,1))';
    y_tmp(size(k_tmp1,1)*size(k_tmp1,2),:) = [];
end

% Set plot data for additional theoretical line positions
set(h.plotFluorAdd1,'xdata',k_tmp2)
set(h.plotFluorAdd1,'ydata',y_tmp)
set(h.plotFluorAdd1,'visible','on')

guidata(hObj, h);

function buttonhideFluorescence(hObj,~)
% Callback for "Load Measurement" ok pushbutton
h = guidata(hObj);

% Set plot data for additional theoretical line positions
set(h.plotFluorAdd1,'visible','off')

guidata(hObj, h);

function LoadElementMenu(hObj,~)
% Callback for "pop up menu" in create sample panel
h = guidata(hObj);
% Determine the selected data set.
str = get(hObj, 'String');
val = get(hObj, 'Value');
h.P.PopupLoadElement = str{val};

guidata(hObj,h);

% Callbacks for twotheta and energy calibration
function startcalib(hObj,~)
% Callback for starting calibration
h = guidata(hObj);
% Get lattice parameter from measurement
latticeparam = 10*h.Measurement(1).Sample.Materials.LatticeParameter;
% Set lattice parameter to edit field
set(h.texteditfieldcalibangEpos1,'String',num2str(latticeparam));
% Get hkl, hkl² and EPos values
hklphasedata = get(h.tablephasehkl,'data');
if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    % Use FitPeaksLogical to filter peaks that are actually fitted
    hklphasedata = hklphasedata(h.FitPeaksLogical(:,1),:);
    % Only keep peaks selected by the user (discard e.g. dummy peaks)
    if isfield(h, 'idxkeepPeaks')
        FittedPeaks{1} = h.FittedPeaks{1}(h.idxkeepPeaks,:);
        tabledata = [cell2mat(hklphasedata(1:size(FittedPeaks{1},1),1:3)) (cell2mat(hklphasedata(1:size(FittedPeaks{1},1),1)).^2 + cell2mat(hklphasedata(1:size(FittedPeaks{1},1),2)).^2 + cell2mat(hklphasedata(1:size(FittedPeaks{1},1),3)).^2) FittedPeaks{1}(:,2)];
    else
        tabledata = [cell2mat(hklphasedata(1:size(h.FittedPeaks{1},1),1:3)) (cell2mat(hklphasedata(1:size(h.FittedPeaks{1},1),1)).^2 + cell2mat(hklphasedata(1:size(h.FittedPeaks{1},1),2)).^2 + cell2mat(hklphasedata(1:size(h.FittedPeaks{1},1),3)).^2) h.FittedPeaks{1}(:,2)];
    end
elseif strcmp(h.Diffsel,'LEDDI')
    if strcmp(h.Detsel,'Detector 1')
        % Use FitPeaksLogical to filter peaks that are actually fitted
        hklphasedata = hklphasedata(h.FitPeaksLogicalDet1(:,1),:);
        % Only keep peaks selected by the user (discard e.g. dummy peaks)
        if isfield(h, 'idxkeepPeaks')
            FittedPeaks{1} = h.FittedPeaksDet1{1}(h.idxkeepPeaks,:);
            tabledata = [cell2mat(hklphasedata(1:size(FittedPeaks{1},1),1:3)) (cell2mat(hklphasedata(1:size(FittedPeaks{1},1),1)).^2 + cell2mat(hklphasedata(1:size(FittedPeaks{1},1),2)).^2 + cell2mat(hklphasedata(1:size(FittedPeaks{1},1),3)).^2) FittedPeaks{1}(:,2)];
        else
            tabledata = [cell2mat(hklphasedata(1:size(h.FittedPeaksDet1{1},1),1:3)) (cell2mat(hklphasedata(1:size(h.FittedPeaksDet1{1},1),1)).^2 + cell2mat(hklphasedata(1:size(h.FittedPeaksDet1{1},1),2)).^2 + cell2mat(hklphasedata(1:size(h.FittedPeaksDet1{1},1),3)).^2) h.FittedPeaksDet1{1}(:,2)];
        end
    elseif strcmp(h.Detsel,'Detector 2')
        % Use FitPeaksLogical to filter peaks that are actually fitted
        hklphasedata = hklphasedata(h.FitPeaksLogicalDet2(:,1),:);
        % Only keep peaks selected by the user (discard e.g. dummy peaks)
        if isfield(h, 'idxkeepPeaks')
            FittedPeaks{1} = h.FittedPeaksDet2{1}(h.idxkeepPeaks,:);
            tabledata = [cell2mat(hklphasedata(1:size(FittedPeaks{1},1),1:3)) (cell2mat(hklphasedata(1:size(FittedPeaks{1},1),1)).^2 + cell2mat(hklphasedata(1:size(FittedPeaks{1},1),2)).^2 + cell2mat(hklphasedata(1:size(FittedPeaks{1},1),3)).^2) FittedPeaks{1}(:,2)];
        else
            tabledata = [cell2mat(hklphasedata(1:size(h.FittedPeaksDet2{1},1),1:3)) (cell2mat(hklphasedata(1:size(h.FittedPeaksDet2{1},1),1)).^2 + cell2mat(hklphasedata(1:size(h.FittedPeaksDet2{1},1),2)).^2 + cell2mat(hklphasedata(1:size(h.FittedPeaksDet2{1},1),3)).^2) h.FittedPeaksDet2{1}(:,2)];
        end
    end
end

% Set calibration table data
set(h.tablecalibangEpos1,'data',tabledata)
% Do calibration
xplot = 6.199./latticeparam.*sqrt(tabledata(:,4));
yplot = tabledata(:,5);
Calib = fitlm(xplot,yplot,'linear');
FitCoeffs = table2array(Calib.Coefficients);
deltaEoffset = FitCoeffs(1,1);
h.deltaEoffset = deltaEoffset;
twothetareal = 2.*asind(1./FitCoeffs(2,1));
h.twothetareal = twothetareal;
set(h.texteditfieldcalibangEpos2,'String',num2str(round(h.twothetareal*1000)/1000));
set(h.texteditfieldcalibangEpos3,'String',num2str(round(deltaEoffset*1000)/1000));

guidata(hObj,h);

function savecalib(hObj,~)
% Callback for saveing calib data
h = guidata(hObj);
% Get lattice parameter from edit field
calibdata.latticeparam = str2double(get(h.texteditfieldcalibangEpos1,'String'));
% Get calibration table data
calibdata.calibtabdata = get(h.tablecalibangEpos1,'data');
% Get twotheta true and deltaE offset
if isnan(str2double(get(h.texteditfieldcalibangEpos3,'String')))
    calibdata.deltaEoffset = 0;
else
    calibdata.deltaEoffset = str2double(get(h.texteditfieldcalibangEpos3,'String'));
end
if isnan(str2double(get(h.texteditfieldcalibangEpos2,'String')))
    calibdata.twothetareal = 0;
else
    calibdata.twothetareal = str2double(get(h.texteditfieldcalibangEpos2,'String'));
end
% Save calibdata to guidata
h.calibdata = calibdata;
% Create folder and save calib data to file
Folder = '\CalibrationData\';

if ~isfield(h,'PathName')
    formatOut = 'ddmmyyyy';
    d = datestr(now, formatOut);
    name = strtrim(h.Measurement(1).MeasurementSeries);
    material = h.P.PopupValueMpd1;
    if strcmp(h.Diffsel,'LEDDI')
        h.PathName = [General.ProgramInfo.Path,'\Data\Results\LEDDI\',[name,'_',material,'_','added_plots','_',d]];
    elseif strcmp(h.Diffsel,'EDDI')
        h.PathName = [General.ProgramInfo.Path,'\Data\Results\EDDI\',[name,'_',material,'_','added_plots','_',d]];
    elseif strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
        h.PathName = [General.ProgramInfo.Path,'\Data\Results\MetalJet\',[name,'_',material,'_','added_plots','_',d]];    
    end
end

Path = fullfile(h.PathName,Folder);

formatOut = 'ddmmyyyy';
d = datestr(now, formatOut);

if exist(Path,'dir') ~= 7
    mkdir(Path);
end

uisave({'calibdata'},[Path, [strtrim(h.Measurement(1).MeasurementSeries),'_calibdata_',d]]);

% Message box
msgbox('Calibration data saved')

guidata(hObj,h);

function loadcalib(hObj,~)
% Callback for loading calib data
h = guidata(hObj);
% Load calib data
Folder = '\CalibrationData\';
if ~isfield(h,'PathName')
    Path = [General.ProgramInfo.Path,'\Data\Results\'];
else
    Path = fullfile([h.PathName,Folder]);
end
[baseFileName, folder] = uigetfile('*.mat','Load calibration data',Path);
calibdata = fullfile(folder, baseFileName);
load(calibdata);

% Get lattice parameter from calib data
latticeparam = calibdata.latticeparam;
% Set lattice parameter to edit field
set(h.texteditfieldcalibangEpos1,'String',num2str(latticeparam));
% Get tabledata
tabledata = calibdata.calibtabdata;
% Set calibration table data
set(h.tablecalibangEpos1,'data',tabledata)
% Get twotheta and deltaE values
deltaEoffset = calibdata.deltaEoffset;
twothetareal = calibdata.twothetareal;
h.deltaEoffset = deltaEoffset;
h.twothetareal = twothetareal;
% Set values to GUI
set(h.texteditfieldcalibangEpos2,'String',num2str(twothetareal));
set(h.texteditfieldcalibangEpos3,'String',num2str(deltaEoffset));

guidata(hObj,h);

function clearcalib(hObj,~)
% Callback for clearing calib data
h = guidata(hObj);

% Clear calibration data
set(h.tablecalibangEpos1,'data',zeros(5,5))
set(h.texteditfieldcalibangEpos1,'String','Lattice parameter');
set(h.texteditfieldcalibangEpos2,'String','twotheta');
set(h.texteditfieldcalibangEpos3,'String','deltaE');

guidata(hObj,h);

function applycalib(hObj,~)
% Callback for applying calib data to fit data
h = guidata(hObj);

% Get values from checkboxes
chkboxtth = get(h.checkboxcalibangEpos1,'value');
chkboxdeltaE = get(h.checkboxcalibangEpos2,'value');
chkboxcorrEtheo = get(h.checkboxcalibangEpos3,'value');

if chkboxcorrEtheo == 0
    % Correct the fitted peak positions and the psi file
    if strcmp(h.Diffsel,'LEDDI')
        if strcmp(h.Detsel,'Detector 1')
            % Get energy and twotheta values from psi file table data
            for k = 1:size(h.PsiFileTableDataDet1,1)
                EPostmp(k,:) = str2double(h.PsiFileTableDataDet1{k,2});
            end
            % Correct EPos with deltaE offset
            EPoscorr = EPostmp - h.deltaEoffset;
            % Update PsiFileTableData
            if chkboxdeltaE == 1
                for k = 1:size(h.PsiFileTableDataDet1,1)
                    h.PsiFileTableDataDet1{k,2} = num2str(EPoscorr(k));
                end
            end

            if chkboxtth == 1
                for k = 1:size(h.PsiFileTableDataDet1,1)
                    h.PsiFileTableDataDet1{k,6} = num2str(h.twothetareal);
                end
            end
            % Set table data
            set(h.tablepsifile,'data',h.PsiFileTableDataDet1);
        elseif strcmp(h.Detsel,'Detector 2')
            % Get energy and twotheta values from psi file table data
            for k = 1:size(h.PsiFileTableDataDet2,1)
                EPostmp(k,:) = str2double(h.PsiFileTableDataDet2{k,2});
            end
            % Correct EPos with deltaE offset
            EPoscorr = EPostmp - h.deltaEoffset;
            % Update PsiFileTableData
            if chkboxdeltaE == 1
                for k = 1:size(h.PsiFileTableDataDet2,1)
                    h.PsiFileTableDataDet2{k,2} = num2str(EPoscorr(k));
                end
            end

            if chkboxtth == 1
                for k = 1:size(h.PsiFileTableDataDet2,1)
                    h.PsiFileTableDataDet2{k,6} = num2str(h.twothetareal);
                end
            end
            % Set table data
            set(h.tablepsifile,'data',h.PsiFileTableDataDet2);
        end
    elseif strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
        % Get energy and twotheta values from psi file table data
        for k = 1:size(h.PsiFileTableData,1)
            EPostmp(k,:) = str2double(h.PsiFileTableData{k,2});
        end
        % Correct EPos with deltaE offset
        EPoscorr = EPostmp - h.deltaEoffset;
        % Update PsiFileTableData
        if chkboxdeltaE == 1
            for k = 1:size(h.PsiFileTableData,1)
                h.PsiFileTableData{k,2} = num2str(EPoscorr(k));
            end
        end

        if chkboxtth == 1
            for k = 1:size(h.PsiFileTableData,1)
                h.PsiFileTableData{k,6} = num2str(round(h.twothetareal*1000)/1000);
            end
        end
        % Set table data
        set(h.tablepsifile,'data',h.PsiFileTableData);
    end
elseif chkboxcorrEtheo == 1
    % Change twotheta of current measurement using twotheta true
    h.twothetareal = str2double(get(h.texteditfieldcalibangEpos2,'String'));
    h.twothetabackup = h.Measurement(1).twotheta;
    for k = 1:length(h.Measurement)
       h.Measurement(k).twotheta = round(h.twothetareal*1000)/1000;
    end
    % Get theoretical peak positions
    if strcmp(h.Diffsel,'LEDDI')
        if strcmp(h.Detsel,'Detector 1')
            Slidersteps = 2:2:length(h.Measurement);
            if isfield(h, 'EnergyRangeDet1')
                h.TPeaksDet1 = TheoreticalPeakPositions(h.Measurement(Slidersteps),h.DataTmp(Slidersteps));
                a = h.TPeaksDet1.T.Etheo > h.P.EnergyRangeDet1(1) & h.TPeaksDet1.T.Etheo < h.P.EnergyRangeDet1(2);
%                 EtheoLimit = h.TPeaksDet1.T.Etheo(a);
            else
                h.TPeaksDet1 = TheoreticalPeakPositions(h.Measurement(Slidersteps),h.DataTmp(Slidersteps));
                a = h.TPeaksDet1.T.Etheo < h.TPeaksDet1.T.EMax;
%                 EtheoLimit = h.TPeaksDet1.T.Etheo(a);
            end
        elseif strcmp(h.Detsel,'Detector 2')
            Slidersteps = 1:2:length(h.Measurement);
            if isfield(h, 'EnergyRangeDet2')
                h.TPeaksDet2 = TheoreticalPeakPositions(h.Measurement(Slidersteps),h.DataTmp(Slidersteps));
                a = h.TPeaksDet2.T.Etheo > h.P.EnergyRangeDet2(1) & h.TPeaksDet2.T.Etheo < h.P.EnergyRangeDet2(2);
%                 EtheoLimit = h.TPeaksDet2.T.Etheo(a);
            else
                h.TPeaksDet2 = TheoreticalPeakPositions(h.Measurement(Slidersteps),h.DataTmp(Slidersteps));
                a = h.TPeaksDet2.T.Etheo < h.TPeaksDet2.T.EMax;
%                 EtheoLimit = h.TPeaksDet2.T.Etheo(a);
            end
        end
    else
        if isfield(h,'EnergyRange')
            h.TPeaks = TheoreticalPeakPositions(h.Measurement,h.DataTmp);
            a = h.P.EnergyRange(1) < h.TPeaks.T.Etheo & h.TPeaks.T.Etheo < h.TPeaks.T.EMax;
%             EtheoLimit = h.TPeaks.T.Etheo(a);
        else
            h.TPeaks = TheoreticalPeakPositions(h.Measurement,h.DataTmp);
            a = h.TPeaks.T.Etheo < h.TPeaks.T.EMax;
%             EtheoLimit = h.TPeaks.T.Etheo(a);
        end
    end
    
    if strcmp(h.Diffsel,'LEDDI')
        if strcmp(h.Detsel,'Detector 1')
%             X1Limit = h.TPeaksDet1.T.X1(a,:);
            X3Limit = h.TPeaksDet1.T.X3((1:(3*find(a, 1, 'last')-1)),:);
            Y3Limit = h.TPeaksDet1.T.Y3((1:(3*find(a, 1, 'last')-1)),:);
        elseif strcmp(h.Detsel,'Detector 2')
%             X1Limit = h.TPeaksDet2.T.X1(a,:);
            X3Limit = h.TPeaksDet2.T.X3((1:(3*find(a, 1, 'last')-1)),:);
            Y3Limit = h.TPeaksDet2.T.Y3((1:(3*find(a, 1, 'last')-1)),:);
        end
    else
%         X1Limit = h.TPeaks.T.X1(a,:);
        X3Limit = h.TPeaks.T.X3((1:(3*find(a, 1, 'last')-1)),:);
        Y3Limit = h.TPeaks.T.Y3((1:(3*find(a, 1, 'last')-1)),:);
    end
    
    if h.P.ShowSubstratePeaks == 1
        b = h.TPeaks.S.Etheo < h.TPeaks.S.EMax;
        SEtheoLimit = h.TPeaks.S.Etheo(b);
%         SX1Limit = h.TPeaks.S.X1(b,:);
        SX3Limit = h.TPeaks.S.X3((1:(3*length(SEtheoLimit)-1)),:);
        SY3Limit = h.TPeaks.S.Y3((1:(3*length(SEtheoLimit)-1)),:);
    end
    % Set plot data for theoretical line positions
    set(h.plotEtheo,'xdata',X3Limit(:,1))
    set(h.plotEtheo,'ydata',Y3Limit(:,2))
    if h.P.ShowSubstratePeaks == 1
        set(h.plotEtheoSub,'xdata',SX3Limit(:,1))
        set(h.plotEtheoSub,'ydata',SY3Limit(:,1))
    end

    % Set data for table with hkl, d-spacing and E[keV] values
    if strcmp(h.Diffsel,'LEDDI')
        if strcmp(h.Detsel,'Detector 1')
            set(h.tablephasehkl,'data',[num2cell(h.TPeaksDet1.T.Peaks(a,:)) num2cell(false(size(h.TPeaksDet1.T.Peaks(a,:),1),1))])
        elseif strcmp(h.Detsel,'Detector 2')
            set(h.tablephasehkl,'data',[num2cell(h.TPeaksDet2.T.Peaks(a,:)) num2cell(false(size(h.TPeaksDet2.T.Peaks(a,:),1),1))])
        end
    else
        set(h.tablephasehkl,'data',[num2cell(h.TPeaks.T.Peaks(a,:)) num2cell(false(size(num2cell(h.TPeaks.T.Peaks(a,:)),1),1))])
    end
    
    if h.P.ShowSubstratePeaks == 1
        set(h.tablephasehkl2,'data',h.TPeaks.S.Peaks(b,:))
    end
%     % Reset two theta
%     for k = 1:length(h.Measurement)
%        h.Measurement(k).twotheta = round(h.twothetabackup*1000)/1000;
%     end

% b = h.Measurement(1).twotheta;
% b
end

guidata(hObj,h);

function startPWCorrEpos(hObj,~)
% Callback to load fit data
h = guidata(hObj);
% Create backup of FittedPeaks
if ~isfield(h,'FittedPeaksBackupPWCorr')
    h.FittedPeaksBackupPWCorr = h.FittedPeaks;
end
% Get params for polynomial
a0 = str2double(get(h.texteditfieldpwparam1,'string'));
a1 = str2double(get(h.texteditfieldpwparam2,'string'));
a2 = str2double(get(h.texteditfieldpwparam3,'string'));
a3 = str2double(get(h.texteditfieldpwparam4,'string'));
a4 = str2double(get(h.texteditfieldpwparam5,'string'));
% Calculate deltaE
deltaE = zeros(1,1);
for k = 1:length(h.Measurement)
        deltaE(k) = a0 + a1.*sind(h.Measurement(k).SCSAngles.psi) + ...
            a2.*sind(h.Measurement(k).SCSAngles.psi).^2 + ...
            a3.*sind(h.Measurement(k).SCSAngles.psi).^3 + ...
            a4.*sind(h.Measurement(k).SCSAngles.psi).^4;
end

% Correct energy positions
for k = 1:length(h.Measurement)
    h.FittedPeaks{k}(:,2) = h.FittedPeaks{k}(:,2) - deltaE(k);
end
h.PWcorrcheck = 1;
% Save updated FittedPeaks
guidata(hObj,h);
% Create psi file with corrected energy positions
h = buttoncreatepsi1(h.buttoncreatepsi1);
h.PWcorrcheck = 0;
% Update guidata
guidata(hObj,h);

function startPWCorrUndo(hObj,~)
% Callback to load fit data
h = guidata(hObj);
% Create backup of FittedPeaks
h.FittedPeaks = h.FittedPeaksBackupPWCorr;
% Save updated FittedPeaks
guidata(hObj,h);
% Create psi file with corrected energy positions
h = buttoncreatepsi1(h.buttoncreatepsi1);
% Update guidata
guidata(hObj,h);

function hkllabel = CreateHKLlabel(h)
% Function used to create array with hkl values
% Ttmp = evalin('base','TPeaks');
% FittedPeaks = evalin('base','FittedPeaks');
% Load fitted peak data and search theoretical positions
% FitPeaks = ismembertol(h.TPeaks.T.Peaks(:,5),h.FittedPeaks{1,1}(:,2),0.01);
% % Repmat of logical vector in order to match size of T.Peaks array
% FitPeaksLogical = repmat(FitPeaks,1,size(h.TPeaks.T.Peaks,2));
% % Reduce T.Peaks array according to the actual peaks fitted
% % Creat temporary file Peakstmp
% Peakstmp = h.TPeaks.T.Peaks;
% % Reduce Peakstmp using the logical 'FitPeaksLogical', results in vector
% Peakstmp = Peakstmp(FitPeaksLogical);
% % Reshape vector into array
% Peaks = reshape(Peakstmp,[length(FitPeaks)-length(find(FitPeaks==0)),size(h.TPeaks.T.Peaks,2)]);

Peaks = h.PeaksforLabel;
Peaks = sortrows(Peaks,4,'descend');

% Read hkl values from array
for ii = 1:size(Peaks,1)
	hkllabeltmp(ii,:) = mat2str(Peaks(ii,(1:3)));
end
% Remove '[' and ']' from character array
for ii = 1:size(hkllabeltmp,1)
    hkllabeltmp1(ii,:) = regexprep(hkllabeltmp(ii,:),'[','');
end

for ii = 1:size(hkllabeltmp,1)
    hkllabeltmp2(ii,:) = regexprep(hkllabeltmp1(ii,:),']','');
end
% Final output with hkl values
hkllabel = hkllabeltmp2;

% Callbacks for theoretical peak positions
function ShowHidePeaksCallback(hObj, eventdata)
h = guidata(hObj);

value = get(hObj, 'Value');

if value == 1
    set(h.plotEtheo,'visible','on')
else
    set(h.plotEtheo,'visible','off')
end

guidata(hObj, h);

function ShowHideSubPeaksCallback(hObj, eventdata)
h = guidata(hObj);

value = get(hObj, 'Value');

if value == 1
    set(h.plotEtheoSub,'visible','on')
else
    set(h.plotEtheoSub,'visible','off')
end

guidata(hObj, h);

function ShiftEtheoCallback(hObj, eventdata)
h = guidata(hObj);

value = get(hObj, 'Value');

if value == 1
    set(h.editshiftEtheo1,'Enable','on')
else
    set(h.editshiftEtheo1,'Enable','off')
end

guidata(hObj, h);

function ShiftEtheosubCallback(hObj, eventdata)
h = guidata(hObj);

value = get(hObj, 'Value');

if value == 1
    set(h.editshiftEtheo2,'Enable','on')
else
    set(h.editshiftEtheo2,'Enable','off')
end

guidata(hObj, h);

function plusbuttonshiftEtheo1(hObj, eventdata)
h = guidata(hObj);

deltaEshift = get(h.editshiftEtheo1, 'String');
deltaEshift = str2double(deltaEshift);

XdataEtheo = get(h.plotEtheo,'xdata');
XdataEtheo = XdataEtheo + deltaEshift;

set(h.plotEtheo,'xdata',XdataEtheo)

guidata(hObj, h);

function minusbuttonshiftEtheo1(hObj, eventdata)
h = guidata(hObj);

deltaEshift = get(h.editshiftEtheo1, 'String');
deltaEshift = str2double(deltaEshift);

XdataEtheo = get(h.plotEtheo,'xdata');
XdataEtheo = XdataEtheo - deltaEshift;

set(h.plotEtheo,'xdata',XdataEtheo)

guidata(hObj, h);

function plusbuttonshiftEtheosub2(hObj, eventdata)
h = guidata(hObj);

deltaEshift = get(h.editshiftEtheo2, 'String');
deltaEshift = str2double(deltaEshift);

XdataEtheo = get(h.plotEtheoSub,'xdata');
XdataEtheo = XdataEtheo + deltaEshift;

set(h.plotEtheoSub,'xdata',XdataEtheo)

guidata(hObj, h);

function minusbuttonshiftEtheosub2(hObj, eventdata)
h = guidata(hObj);

deltaEshift = get(h.editshiftEtheo2, 'String');
deltaEshift = str2double(deltaEshift);

XdataEtheo = get(h.plotEtheoSub,'xdata');
XdataEtheo = XdataEtheo - deltaEshift;

set(h.plotEtheoSub,'xdata',XdataEtheo)

guidata(hObj, h);

function buttonexchangespectra(hObj, eventdata)
h = guidata(hObj);

% Select folder where spectra to be exchanged are located 
folder_name = uigetdir;
Files = dir(fullfile(folder_name,'*.int'));

if isempty(Files)
    Files = dir(fullfile(folder_name,'*.dat'));
end

% Import data
for i = 1:length(Files)
    fid = fopen([fullfile(folder_name,Files(i).name)]);
    IntData(i).data = textscan(fid,'%f%f%f', 'headerlines', 25);
    fclose(fid);
end

% Exchange data
for i = 1:length(Files)
    h.Measurement(i).Name = Files(i).name;
    h.Measurement(i).EDSpectrum = [IntData(i).data{2} IntData(i).data{3}];
    h.DataTmp{i} = [IntData(i).data{2} IntData(i).data{3}];
end

set(h.axesplotRawData.Title,'String',['Measurement data for ', h.Measurement(1).Name])
set(h.plotdata,'xdata',h.DataTmp{1}(:,1))
set(h.plotdata,'ydata',h.DataTmp{1}(:,2))

set(h.editfieldselectmeas3,'String',num2str(length(Files)))

guidata(hObj, h);

% Callbacks for choosing phi angle for stress data modification
function ClickPhi0Callback(hObj, eventdata)
h = guidata(hObj);

value = get(hObj, 'Value');

if value == 1
    set(h.plotdatadspacingphi0,'visible','on')
    set(h.plotreglinedspacingphi0,'visible','on')
    set(h.plotdataIBphi0,'visible','on')
    set(h.plotdataIntphi0,'visible','on')
else
    set(h.plotdatadspacingphi0,'visible','off')
    set(h.plotreglinedspacingphi0,'visible','off')
    set(h.plotdataIBphi0,'visible','off')
    set(h.plotdataIntphi0,'visible','off')
end

guidata(hObj, h);

function ClickPhi90Callback(hObj, eventdata)
h = guidata(hObj);

value = get(hObj, 'Value');

if value == 1
    set(h.plotdatadspacingphi90,'visible','on')
    set(h.plotreglinedspacingphi90,'visible','on')
    set(h.plotdataIBphi90,'visible','on')
    set(h.plotdataIntphi90,'visible','on')
else
    set(h.plotdatadspacingphi90,'visible','off')
    set(h.plotreglinedspacingphi90,'visible','off')
    set(h.plotdataIBphi90,'visible','off')
    set(h.plotdataIntphi90,'visible','off')
end

guidata(hObj, h);

function ClickPhi180Callback(hObj, eventdata)
h = guidata(hObj);

value = get(hObj, 'Value');

if value == 1
    set(h.plotdatadspacingphi180,'visible','on')
    set(h.plotreglinedspacingphi180,'visible','on')
    set(h.plotdataIBphi180,'visible','on')
    set(h.plotdataIntphi180,'visible','on')
else
    set(h.plotdatadspacingphi180,'visible','off')
    set(h.plotreglinedspacingphi180,'visible','off')
    set(h.plotdataIBphi180,'visible','off')
    set(h.plotdataIntphi180,'visible','off')
end

guidata(hObj, h);

function ClickPhi270Callback(hObj, eventdata)
h = guidata(hObj);

value = get(hObj, 'Value');

if value == 1
    set(h.plotdatadspacingphi270,'visible','on')
    set(h.plotreglinedspacingphi270,'visible','on')
    set(h.plotdataIBphi270,'visible','on')
    set(h.plotdataIntphi270,'visible','on')
else
    set(h.plotdatadspacingphi270,'visible','off')
    set(h.plotreglinedspacingphi270,'visible','off')
    set(h.plotdataIBphi270,'visible','off')
    set(h.plotdataIntphi270,'visible','off')
end

guidata(hObj, h);

% Callback for changing Y-lim of stress plot
function modstressYlim(hObj, callbackdata, handles)
% Function used to modify the Y-scale of the stress data plotted in the 
% stresspanelplot
h = guidata(hObj);
% Set Figure visible.
set(h.Ylimfig, 'Visible', 'on');
% Load Y-axes limits
axesYlim = h.axesplotstressdata.YLim;
axesYTick = h.axesplotstressdata.YTick;
% Set new Y limits
set(h.editYlimMax, 'String', num2str(axesYlim(2)));
set(h.editYlimMin, 'String', num2str(axesYlim(1)));
set(h.editYlimTick, 'String', num2str(axesYTick(2)-axesYTick(1)));

if ~isfield(h,'YlimChanged')
    h.YlimChanged = zeros(1,h.SliderPlotStressData.Max);
    h.YlimMinnew = zeros(1,h.SliderPlotStressData.Max);
    h.YlimMaxnew = zeros(1,h.SliderPlotStressData.Max);
    h.YlimYTicknew = zeros(1,h.SliderPlotStressData.Max);
end

guidata(hObj, h);

function acceptYlimEdit(hObj, callbackdata, handles)
% Callback for 'Accept' pushbutton
h = findobj('Tag','MainGUI');
h1data = guidata(h);
% Get current slider value
valueSliderStress = get(h1data.SliderPlotStressData, 'Value');
% Get current Y-limits from edit boxes
YlimMinnew = str2double(h1data.editYlimMin.String);
YlimMaxnew = str2double(h1data.editYlimMax.String);
YlimTicknew = str2double(h1data.editYlimTick.String);
% Set new limits
h1data.axesplotstressdata.YLim = ([YlimMinnew YlimMaxnew]);
h1data.axesplotstressdata.YTick = YlimMinnew:YlimTicknew:YlimMaxnew;
% Set Y limits for current slider value
h1data.YlimMinnew(valueSliderStress) = YlimMinnew;
h1data.YlimMaxnew(valueSliderStress) = YlimMaxnew;
h1data.YlimYTicknew(valueSliderStress) = YlimTicknew;
h1data.YlimChanged(valueSliderStress) = 1;
% Close window
set(h1data.Ylimfig, 'Visible', 'off');

guidata(h, h1data);

function cancelYlimEdit(hObj, callbackdata, handles)
% Callback for 'Cancel' pushbutton
h = findobj('Tag','MainGUI');
h1data = guidata(h);
% h = handles;
% Close window
set(h1data.Ylimfig, 'Visible', 'off');

guidata(hObj, h1data);

% Callback for changing X-lim of stress plot
function modstressXlim(hObj, callbackdata, handles)
% Function used to modify the X-scale of the stress data plotted in the 
% stresspanelplot
h = guidata(hObj);
% Set Figure visible.
set(h.Xlimfig, 'Visible', 'on');
% Load Y-axes limits
axesXlim = h.axesplotstressdata.XLim;
axesXTick = h.axesplotstressdata.XTick;
% Set new Y limits
set(h.editXlimMax, 'String', num2str(axesXlim(2)));
set(h.editXlimMin, 'String', num2str(axesXlim(1)));
set(h.editXlimTick, 'String', num2str(axesXTick(2)-axesXTick(1)));

if ~isfield(h,'XlimChanged')
    h.XlimChanged = zeros(1,h.SliderPlotStressData.Max);
    h.XlimMinnew = zeros(1,h.SliderPlotStressData.Max);
    h.XlimMaxnew = zeros(1,h.SliderPlotStressData.Max);
    h.XlimXTicknew = zeros(1,h.SliderPlotStressData.Max);
end
% assignin('base','XlimChanged1',h.XlimChanged)
guidata(hObj, h);

function acceptXlimEdit(hObj, callbackdata, handles)
% Callback for 'Accept' pushbutton
h = findobj('Tag','MainGUI');
h1data = guidata(h);
% Get current slider value
valueSliderStress = get(h1data.SliderPlotStressData, 'Value');
% Get current Y-limits from edit boxes
XlimMinnew = str2double(h1data.editXlimMin.String);
XlimMaxnew = str2double(h1data.editXlimMax.String);
XlimTicknew = str2double(h1data.editXlimTick.String);
% Set new limits
h1data.axesplotstressdata.XLim = ([XlimMinnew XlimMaxnew]);
h1data.axesplotstressdata.XTick = XlimMinnew:XlimTicknew:XlimMaxnew;
% Set Y limits for current slider value
h1data.XlimMinnew(valueSliderStress) = XlimMinnew;
h1data.XlimMaxnew(valueSliderStress) = XlimMaxnew;
h1data.XlimXTicknew(valueSliderStress) = XlimTicknew;
h1data.XlimChanged(valueSliderStress) = 1;
% Close window
set(h1data.Xlimfig, 'Visible', 'off');

guidata(h, h1data);

function cancelXlimEdit(hObj, callbackdata, handles)
% Callback for 'Cancel' pushbutton
h = findobj('Tag','MainGUI');
h1data = guidata(h);
% h = handles;
% Close window
set(h1data.Xlimfig, 'Visible', 'off');

guidata(hObj, h1data);

% Callback for loading tau data
function loadtaudata(hObj, callbackdata, handles)
% Function used to modify the X-scale of the stress data plotted in the 
% stresspanelplot
h = guidata(hObj);

% Load tau data file
[baseFileName, folder] = uigetfile('*.mat','Load tau data file',[General.ProgramInfo.Path,'/Data/Results/']);

% If user pressed cancel, abort saving process
if baseFileName == 0
  % user pressed cancel
  return
end

TauDataFileName = fullfile(folder, baseFileName);
load(TauDataFileName);

h.taudataloaded = true;
h.PeaksforLabel = t.PeaksforLabel;
h.sin2psi = t.sin2psi;
h.Params.Phi_Winkel = t.Params.Phi_Winkel;
h.taudata = t.taudata;
h.taudatatmp = t.taudatatmp;
h.Diffsel  = t.Diffsel;
h.Detsel  = t.Detsel;
h.Measurement  = t.Measurement(1);
h.P.PopupValueMpd1  = t.P.PopupValueMpd1;
h.ColorsUsedSorted = t.ColorsUsedSorted;

% Create sample
h.P.ElementalFormula = 'Au1';
h.P.MPDFileName = h.P.PopupValueMpd1;
h.P.ShowSubstratePeaks = 0;
h.P.SubstrateFormula = 'Au1';
h.P.SusbtrateMPDFileName = 'Empty';
% Set FileName to string and ExPath to UserData of Edit-Field
[Sample,T] = CreateSampleGUI(h.P);
h.T = T;
h.Sample = Sample;

h.Sample.Materials.Name = t.Sample.Materials.Name;

% If measured under more than one phi angle, rearrange data
for k = 1:size(h.Params.Phi_Winkel,2)
	[PhiWinkel{k},ia{k},~] = unique(h.Params.Phi_Winkel{k});
end

% SliderStressData needs to be adjusted according to the number of phi
% angles. For now it is set to one.
% Get slider value
set(h.SliderPlotStressData, 'Value', 1);
valueSliderStress = get(h.SliderPlotStressData, 'Value');

% Change slider parameters according to number of stress components
if length(ia{1}) == 1
    set(h.SliderPlotStressData,'Min',0);
    set(h.SliderPlotStressData,'Max',length(ia{1}));
    set(h.SliderPlotStressData,'SliderStep',[1 1]);
else
    set(h.SliderPlotStressData,'Min',1);
    set(h.SliderPlotStressData,'Max',length(ia{1}));
    set(h.SliderPlotStressData,'SliderStep',[1/(length(ia{1})-1) 1/(length(ia{1})-1)]);
end
% Delete field if already present, in case of reloading stress data with
% different number of peaks, set scatter plots "visible" to "off"
if isfield(h, 'ScatterData')
    delete(findobj(h.axesplotstressdata, 'type', 'scatter', 'visible', 'on'))
    h = rmfield(h,'ScatterData');
end

if isfield(h, 'ScatterData')
	for j = 1:length(ia{1})
		for k = 1:size(h.ScatterData(j).StressesPhi,2)
			h.ScatterData(j).StressesPhi(k).Visible = 'off';
		end
	end	
end
% assignin('base','StressPlotDatatmpsorted',h.sin2psi.StressPlotDatatmpsorted)
% Set stress data for stress plot
if length(ia{1}) == 1
    for k = 1:size(h.sin2psi.StressPlotDatatmpsorted,1)
        h.ScatterData(1).StressesPhi(:,k) = scatter(h.axesplotstressdata, h.sin2psi.StressPlotDatatmpsorted(k,1),h.sin2psi.StressPlotDatatmpsorted(k,2),200,'Marker','s','MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'LineWidth',1.5);
    end
elseif length(ia{1}) == 2
    for k = 1:size(h.sin2psi.StressPlotDatatmpsorted,1)
        h.ScatterData(1).StressesPhi(:,k) = scatter(h.axesplotstressdata, h.sin2psi.StressPlotDatatmpsorted(k,1),h.sin2psi.StressPlotDatatmpsorted(k,2),200,'Marker','s','MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'LineWidth',1.5);
        h.ScatterData(2).StressesPhi(:,k) = scatter(h.axesplotstressdata, h.sin2psi.StressPlotDatatmpsorted(k,1),h.sin2psi.StressPlotDatatmpsorted(k,4),200,'Marker','s','MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'LineWidth',1.5);
    end
elseif length(ia{1}) == 3
    for k = 1:size(h.sin2psi.StressPlotDatatmpsorted,1)
        h.ScatterData(1).StressesPhi(:,k) = scatter(h.axesplotstressdata, h.sin2psi.StressPlotDatatmpsorted(k,1),h.sin2psi.StressPlotDatatmpsorted(k,2),200,'Marker','s','MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'LineWidth',1.5);
        h.ScatterData(2).StressesPhi(:,k) = scatter(h.axesplotstressdata, h.sin2psi.StressPlotDatatmpsorted(k,1),h.sin2psi.StressPlotDatatmpsorted(k,4),200,'Marker','s','MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'LineWidth',1.5);
        h.ScatterData(3).StressesPhi(:,k) = scatter(h.axesplotstressdata, h.sin2psi.StressPlotDatatmpsorted(k,1),h.sin2psi.StressPlotDatatmpsorted(k,6),200,'Marker','s','MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'LineWidth',1.5);
    end
elseif length(ia{1}) == 4
    for k = 1:size(h.sin2psi.StressPlotDatatmpsorted,1)
        h.ScatterData(1).StressesPhi(:,k) = scatter(h.axesplotstressdata, h.sin2psi.StressPlotDatatmpsorted(k,1),h.sin2psi.StressPlotDatatmpsorted(k,2),200,'Marker','s','MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'LineWidth',1.5);
        h.ScatterData(2).StressesPhi(:,k) = scatter(h.axesplotstressdata, h.sin2psi.StressPlotDatatmpsorted(k,1),h.sin2psi.StressPlotDatatmpsorted(k,4),200,'Marker','s','MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'LineWidth',1.5);
        h.ScatterData(3).StressesPhi(:,k) = scatter(h.axesplotstressdata, h.sin2psi.StressPlotDatatmpsorted(k,1),h.sin2psi.StressPlotDatatmpsorted(k,6),200,'Marker','s','MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'LineWidth',1.5);
        h.ScatterData(4).StressesPhi(:,k) = scatter(h.axesplotstressdata, h.sin2psi.StressPlotDatatmpsorted(k,1),h.sin2psi.StressPlotDatatmpsorted(k,8),200,'Marker','s','MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'LineWidth',1.5);
    end
end

% Set scatter plot visibility off if not active
for j = 1:length(ia{1})
    if j ~= valueSliderStress
        for k = 1:size(h.sin2psi.StressPlotDatatmpsorted,1)
            h.ScatterData(j).StressesPhi(k).Visible = 'off';
        end
    else
        for k = 1:size(h.sin2psi.StressPlotDatatmpsorted,1)
            h.ScatterData(j).StressesPhi(k).Visible = 'on';
        end
    end
end

% Create label for stress plot
Peaks = h.PeaksforLabel;
% Read hkl values from array
for ii = 1:size(Peaks,1)
	hkllabeltmp(ii,:) = mat2str(Peaks(ii,(1:3)));
end
% Remove '[' and ']' from character array
for ii = 1:size(hkllabeltmp,1)
    hkllabeltmp1(ii,:) = regexprep(hkllabeltmp(ii,:),'[','');
end

for ii = 1:size(hkllabeltmp,1)
    hkllabeltmp2(ii,:) = regexprep(hkllabeltmp1(ii,:),']','');
end
% Final output with hkl values
hkllabel = hkllabeltmp2;
h.LabelForPlot = hkllabel;

% Create legend for stress plot
h.legstressdata = legend(h.axesplotstressdata, [h.ScatterData(valueSliderStress).StressesPhi], hkllabel);
h.legstressdata.Visible = 'on';
h.legstressdata.FontSize = 15;
h.legstressdata.Location = 'northeast';
% Set plot properties
set(h.plotstressdata,{'xdata','visible'},{h.sin2psi.StressPlotDatatmpsorted(:,1),'on'})
set(h.plotstressdata,{'ydata','visible'},{h.sin2psi.StressPlotDatatmpsorted(:,2),'on'})
set(h.plotstressdata,{'YNegativeDelta','visible'},{h.sin2psi.StressPlotDatatmpsorted(:,3),'on'})
set(h.plotstressdata,{'YPositiveDelta','visible'},{h.sin2psi.StressPlotDatatmpsorted(:,3),'on'})
set(h.plotstressdata,'LineStyle', '--')
% Set axis label
if valueSliderStress == 1
    % Set axis label
    if length(PhiWinkel{1}) == 2 && PhiWinkel{1}(1) == 90 && PhiWinkel{1}(2) == 270
        ylabel(h.axesplotstressdata,'<\sigma_{22} - \sigma_{33}> [MPa]')
    else
        ylabel(h.axesplotstressdata,'<\sigma_{11} - \sigma_{33}> [MPa]')  
    end
end
% Set axis limits
if size(h.sin2psi.StressPlotDatatmpsorted,1) == 1
    h.axesplotstressdata.XLim = [0,(ceil(max(h.sin2psi.StressPlotDatatmpsorted(:,1))*0.1)/0.1 + (ceil(max(h.sin2psi.StressPlotDatatmpsorted(:,1))*0.1)/0.1)./2)];
    if min(h.sin2psi.StressPlotDatatmpsorted(:,2)) > 0
        h.axesplotstressdata.YLim = [0,round(max(h.sin2psi.StressPlotDatatmpsorted(:,2))+max(h.sin2psi.StressPlotDatatmpsorted(:,3))*0.1,-1)];
    elseif min(h.sin2psi.StressPlotDatatmpsorted(:,2)) < 0
        h.axesplotstressdata.YLim = [-1*abs(round(max(h.sin2psi.StressPlotDatatmpsorted(:,2))+max(h.sin2psi.StressPlotDatatmpsorted(:,3))*0.1)),0];
    end
%     assignin('base','sin2psi',h.sin2psi)
else
    h.axesplotstressdata.XLim = [0,(ceil(max(h.sin2psi.StressPlotDatatmpsorted(:,1))*0.1)/0.1)];
    YLimErr = [(min(h.sin2psi.StressPlotDatatmpsorted(:,2)) + max(h.sin2psi.StressPlotDatatmpsorted(:,3))) ...
        (min(h.sin2psi.StressPlotDatatmpsorted(:,2)) - max(h.sin2psi.StressPlotDatatmpsorted(:,3))) ...
        (max(h.sin2psi.StressPlotDatatmpsorted(:,2)) + max(h.sin2psi.StressPlotDatatmpsorted(:,3))) ...
        (max(h.sin2psi.StressPlotDatatmpsorted(:,2)) - max(h.sin2psi.StressPlotDatatmpsorted(:,3)))];

    YLimtmp = [min(YLimErr) max(YLimErr)];

    YLimMinExpFactor = 1*10^(numel(num2str(abs(round(YLimtmp(1)))))-1);
    YLimMaxExpFactor = 1*10^(numel(num2str(abs(round(YLimtmp(2)))))-1);

    h.axesplotstressdata.YLim = [-(abs(floor(YLimtmp(1)/YLimMinExpFactor))*YLimMinExpFactor), ceil(YLimtmp(2)/YLimMaxExpFactor)*YLimMaxExpFactor];
end
xticks(h.axesplotstressdata,'auto')
yticks(h.axesplotstressdata,'auto')
% Set title
title(h.axesplotstressdata,['Residual stress data for ',strrep(h.Measurement(1).MeasurementSeries,' ','')], 'HorizontalAlignment', 'center', 'Interpreter', 'none')

guidata(hObj, h);

% Callback for selecting hkl values for stress plot
function buttonselecthkltable(hObj, ~)
% Function to load DEK data.
h = guidata(hObj);
% Load hkl values from DEK table. If DEKtable is empty, use PeaksforLabel
% variable.
DEKdatatmp = get(h.loadDEKtable,'data');

if all(DEKdatatmp(:,1)==0)
    hkl_h = h.PeaksforLabel(:,1);
    hkl_k = h.PeaksforLabel(:,2);
    hkl_l = h.PeaksforLabel(:,3);
else
    hkl_h = DEKdatatmp(:,1);
    hkl_k = DEKdatatmp(:,2);
    hkl_l = DEKdatatmp(:,3);
end
% If hkl values were already selected, use the resulting index vector
if isfield(h, 'idxhklPeaktable')
    set(h.Selecthkltable,'data',[num2cell(hkl_h) num2cell(hkl_k) num2cell(hkl_l) num2cell(h.idxhklPeaktable)])
else
    set(h.Selecthkltable,'data',[num2cell(hkl_h) num2cell(hkl_k) num2cell(hkl_l) num2cell(true(size(hkl_h,1),1))])
end

% Set figure visible
set(h.fighklstressplottable,'Visible','on')

guidata(hObj, h);

function celleditcallbackSelecthkltable(hObj, ~, handles)
% Callback for uitable to select peaks to be used in analysis 
h = handles;

h.Selecthkltable = get(hObj,'data');
h.idxhklPeaktable = cell2mat(h.Selecthkltable(:,4));

guidata(hObj, h);

function buttonhklstressplottableok(hObj, ~, handles)
% Callback for saving selected peaks
% k is thre guidata from the new figure. In order to get the guidata from
% the mainGUI, use the Tag to get it.
h = findobj('Tag','MainGUI');
h1data = guidata(h);
handles1 = guidata(hObj);
% Change lists with stress data according to the hkl values selected by the
% user.
if ~isfield(handles1, 'idxhklPeaktable')
    handles1.idxhklPeaktable = true(size(h1data.sin2psi.StressPlotDatatmpsorted,1),1);
end

StressPlotDatatmpsorted_tmp = h1data.sin2psi.StressPlotDatatmpsorted(handles1.idxhklPeaktable,:);

% Save index variable of selected hkl peaks
h1data.idxhklPeaktable = handles1.idxhklPeaktable;

for k = 1:size(h1data.Params.Phi_Winkel,2)
	[PhiWinkel{k},ia{k},~] = unique(h1data.Params.Phi_Winkel{k});
end

% Delete field if already present, in case of reloading stress data with
% different number of peaks, set scatter plots "visible" to "off"
if isfield(h1data, 'ScatterData')
    delete(findobj(h1data.axesplotstressdata, 'type', 'scatter', 'visible', 'on'))
    h1data = rmfield(h1data,'ScatterData');
end

if isfield(h1data, 'ScatterData')
	for j = 1:length(ia{1})
		for k = 1:size(h1data.ScatterData(j).StressesPhi,2)
			h1data.ScatterData(j).StressesPhi(k).Visible = 'off';
		end
	end	
end

% Get slider value
set(h1data.SliderPlotStressData, 'Value', 1);
valueSliderStress = get(h1data.SliderPlotStressData, 'Value');

% assignin('base','StressPlotDatatmpsorted',h.sin2psi.StressPlotDatatmpsorted)
% Set stress data for stress plot
if length(ia{1}) == 1
    for k = 1:size(StressPlotDatatmpsorted_tmp,1)
        h1data.ScatterData(1).StressesPhi(:,k) = scatter(h1data.axesplotstressdata, StressPlotDatatmpsorted_tmp(k,1),StressPlotDatatmpsorted_tmp(k,2),200,'Marker','s','MarkerFaceColor',h1data.ColorsUsedSorted{k},'MarkerEdgeColor',h1data.ColorsUsedSorted{k},'LineWidth',1.5);
    end
elseif length(ia{1}) == 2
    for k = 1:size(StressPlotDatatmpsorted_tmp,1)
        h1data.ScatterData(1).StressesPhi(:,k) = scatter(h1data.axesplotstressdata, StressPlotDatatmpsorted_tmp(k,1),StressPlotDatatmpsorted_tmp(k,2),200,'Marker','s','MarkerFaceColor',h1data.ColorsUsedSorted{k},'MarkerEdgeColor',h1data.ColorsUsedSorted{k},'LineWidth',1.5);
        h1data.ScatterData(2).StressesPhi(:,k) = scatter(h1data.axesplotstressdata, StressPlotDatatmpsorted_tmp(k,1),StressPlotDatatmpsorted_tmp(k,4),200,'Marker','s','MarkerFaceColor',h1data.ColorsUsedSorted{k},'MarkerEdgeColor',h1data.ColorsUsedSorted{k},'LineWidth',1.5);
    end
elseif length(ia{1}) == 3
    for k = 1:size(StressPlotDatatmpsorted_tmp,1)
        h1data.ScatterData(1).StressesPhi(:,k) = scatter(h1data.axesplotstressdata, StressPlotDatatmpsorted_tmp(k,1),StressPlotDatatmpsorted_tmp(k,2),200,'Marker','s','MarkerFaceColor',h1data.ColorsUsedSorted{k},'MarkerEdgeColor',h1data.ColorsUsedSorted{k},'LineWidth',1.5);
        h1data.ScatterData(2).StressesPhi(:,k) = scatter(h1data.axesplotstressdata, StressPlotDatatmpsorted_tmp(k,1),StressPlotDatatmpsorted_tmp(k,4),200,'Marker','s','MarkerFaceColor',h1data.ColorsUsedSorted{k},'MarkerEdgeColor',h1data.ColorsUsedSorted{k},'LineWidth',1.5);
        h1data.ScatterData(3).StressesPhi(:,k) = scatter(h1data.axesplotstressdata, StressPlotDatatmpsorted_tmp(k,1),StressPlotDatatmpsorted_tmp(k,6),200,'Marker','s','MarkerFaceColor',h1data.ColorsUsedSorted{k},'MarkerEdgeColor',h1data.ColorsUsedSorted{k},'LineWidth',1.5);
    end
elseif length(ia{1}) == 4
    for k = 1:size(StressPlotDatatmpsorted_tmp,1)
        h1data.ScatterData(1).StressesPhi(:,k) = scatter(h1data.axesplotstressdata, StressPlotDatatmpsorted_tmp(k,1),StressPlotDatatmpsorted_tmp(k,2),200,'Marker','s','MarkerFaceColor',h1data.ColorsUsedSorted{k},'MarkerEdgeColor',h1data.ColorsUsedSorted{k},'LineWidth',1.5);
        h1data.ScatterData(2).StressesPhi(:,k) = scatter(h1data.axesplotstressdata, StressPlotDatatmpsorted_tmp(k,1),StressPlotDatatmpsorted_tmp(k,4),200,'Marker','s','MarkerFaceColor',h1data.ColorsUsedSorted{k},'MarkerEdgeColor',h1data.ColorsUsedSorted{k},'LineWidth',1.5);
        h1data.ScatterData(3).StressesPhi(:,k) = scatter(h1data.axesplotstressdata, StressPlotDatatmpsorted_tmp(k,1),StressPlotDatatmpsorted_tmp(k,6),200,'Marker','s','MarkerFaceColor',h1data.ColorsUsedSorted{k},'MarkerEdgeColor',h1data.ColorsUsedSorted{k},'LineWidth',1.5);
        h1data.ScatterData(4).StressesPhi(:,k) = scatter(h1data.axesplotstressdata, StressPlotDatatmpsorted_tmp(k,1),StressPlotDatatmpsorted_tmp(k,8),200,'Marker','s','MarkerFaceColor',h1data.ColorsUsedSorted{k},'MarkerEdgeColor',h1data.ColorsUsedSorted{k},'LineWidth',1.5);
    end
end

% Set scatter plot visibility off if not active
for j = 1:length(ia{1})
    if j ~= valueSliderStress
        for k = 1:size(StressPlotDatatmpsorted_tmp,1)
            h1data.ScatterData(j).StressesPhi(k).Visible = 'off';
        end
    else
        for k = 1:size(StressPlotDatatmpsorted_tmp,1)
            h1data.ScatterData(j).StressesPhi(k).Visible = 'on';
        end
    end
end

% Create label for stress plot
Peaks = h1data.PeaksforLabel(handles1.idxhklPeaktable,:);
% Read hkl values from array
for ii = 1:size(Peaks,1)
	hkllabeltmp(ii,:) = mat2str(Peaks(ii,(1:3)));
end
% Remove '[' and ']' from character array
for ii = 1:size(hkllabeltmp,1)
    hkllabeltmp1(ii,:) = regexprep(hkllabeltmp(ii,:),'[','');
end

for ii = 1:size(hkllabeltmp,1)
    hkllabeltmp2(ii,:) = regexprep(hkllabeltmp1(ii,:),']','');
end
% Final output with hkl values
hkllabel = hkllabeltmp2;
h1data.LabelForPlot = hkllabel;

% Create legend for stress plot
h1data.legstressdata = legend(h1data.axesplotstressdata, [h1data.ScatterData(valueSliderStress).StressesPhi], hkllabel);
h1data.legstressdata.Visible = 'on';
h1data.legstressdata.FontSize = 15;
h1data.legstressdata.Location = 'northeast';
% Set plot properties
set(h1data.plotstressdata,{'xdata','visible'},{StressPlotDatatmpsorted_tmp(:,1),'on'})
set(h1data.plotstressdata,{'ydata','visible'},{StressPlotDatatmpsorted_tmp(:,2),'on'})
set(h1data.plotstressdata,{'YNegativeDelta','visible'},{StressPlotDatatmpsorted_tmp(:,3),'on'})
set(h1data.plotstressdata,{'YPositiveDelta','visible'},{StressPlotDatatmpsorted_tmp(:,3),'on'})
set(h1data.plotstressdata,'LineStyle', '--')
% Set axis label
if valueSliderStress == 1
    % Set axis label
    if length(PhiWinkel{1}) == 2 && PhiWinkel{1}(1) == 90 && PhiWinkel{1}(2) == 270
        ylabel(h1data.axesplotstressdata,'<\sigma_{22} - \sigma_{33}> [MPa]')
    else
        ylabel(h1data.axesplotstressdata,'<\sigma_{11} - \sigma_{33}> [MPa]')  
    end
end
% Set axis limits
if size(StressPlotDatatmpsorted_tmp,1) == 1
    h1data.axesplotstressdata.XLim = [0,(ceil(max(StressPlotDatatmpsorted_tmp(:,1))*0.1)/0.1 + (ceil(max(StressPlotDatatmpsorted_tmp(:,1))*0.1)/0.1)./2)];
    if min(StressPlotDatatmpsorted_tmp(:,2)) > 0
        h1data.axesplotstressdata.YLim = [0,round(max(StressPlotDatatmpsorted_tmp(:,2))+max(StressPlotDatatmpsorted_tmp(:,3))*0.1,-1)];
    elseif min(StressPlotDatatmpsorted_tmp(:,2)) < 0
        h1data.axesplotstressdata.YLim = [-1*abs(round(max(StressPlotDatatmpsorted_tmp(:,2))+max(StressPlotDatatmpsorted_tmp(:,3))*0.1)),0];
    end
%     assignin('base','sin2psi',h1data.sin2psi)
else
    h1data.axesplotstressdata.XLim = [0,(ceil(max(StressPlotDatatmpsorted_tmp(:,1))*0.1)/0.1)];
    YLimErr = [(min(StressPlotDatatmpsorted_tmp(:,2)) + max(StressPlotDatatmpsorted_tmp(:,3))) ...
        (min(StressPlotDatatmpsorted_tmp(:,2)) - max(StressPlotDatatmpsorted_tmp(:,3))) ...
        (max(StressPlotDatatmpsorted_tmp(:,2)) + max(StressPlotDatatmpsorted_tmp(:,3))) ...
        (max(StressPlotDatatmpsorted_tmp(:,2)) - max(StressPlotDatatmpsorted_tmp(:,3)))];

    YLimtmp = [min(YLimErr) max(YLimErr)];

    YLimMinExpFactor = 1*10^(numel(num2str(abs(round(YLimtmp(1)))))-1);
    YLimMaxExpFactor = 1*10^(numel(num2str(abs(round(YLimtmp(2)))))-1);

    h1data.axesplotstressdata.YLim = [-(abs(floor(YLimtmp(1)/YLimMinExpFactor))*YLimMinExpFactor), ceil(YLimtmp(2)/YLimMaxExpFactor)*YLimMaxExpFactor];
end
xticks(h1data.axesplotstressdata,'auto')
yticks(h1data.axesplotstressdata,'auto')
% Set title
title(h1data.axesplotstressdata,['Residual stress data for ',strrep(h1data.Measurement(1).MeasurementSeries,' ','')], 'HorizontalAlignment', 'center', 'Interpreter', 'none')


% Set figure visible off
set(h1data.fighklstressplottable, 'Visible', 'off')

guidata(h, h1data); 

%% Callbacks for plot fit data tab

% Callback for plotting fitted data from plot window 1
function CallbackpopupmenuXData1(hObj, callbackdata, handles)
% Function used to modify the X-scale of the stress data plotted in the 
% stresspanelplot
h = guidata(hObj);
% Get String from popupmenu
Str = get(hObj, 'String');
Val = get(hObj, 'Value');
XDataStr = Str{Val};
% Get slider value
valueSlider = round(get(h.Sliderplotwindowfitdata1, 'Value'));

h = CallbackpopupmenuXData(h, '1', XDataStr, valueSlider);

guidata(hObj, h);

function CallbackpopupmenuYData1(hObj, callbackdata, handles)
% Function used to modify the X-scale of the stress data plotted in the 
% stresspanelplot
h = guidata(hObj);
% Get String from popupmenu
Str = get(hObj, 'String');
Val = get(hObj, 'Value');
YDataStr = Str{Val};
Str = get(h.popupmenuXData1, 'String');
Val = get(h.popupmenuXData1, 'Value');
XDataStr = Str{Val};

% Get slider value
valueSlider = round(get(h.Sliderplotwindowfitdata1, 'Value'));

h = CallbackpopupmenuYData(h, '1', YDataStr, valueSlider);

guidata(hObj, h);

function SliderCallbackPlotfitdata1(hObj, callbackdata, handles)
% Function used to modify the X-scale of the stress data plotted in the 
% stresspanelplot
h = guidata(hObj);
% Get slider value
valueSlider = get(hObj, 'Value');
% Get String from popupmenu
Str = get(h.popupmenuXData1, 'String');
Val = get(h.popupmenuXData1, 'Value');
XDataStr = Str{Val};
% Get String from popupmenu
Str = get(h.popupmenuYData1, 'String');
Val = get(h.popupmenuYData1, 'Value');
YDataStr = Str{Val};

h = SliderCallbackPlotfitdata(h, '1', XDataStr, YDataStr, valueSlider);

guidata(hObj, h);

function buttonClearFitData1(hObj, callbackdata, handles)
% Function used to modify the X-scale of the stress data plotted in the 
% stresspanelplot
h = guidata(hObj);

% Get slider value
valueSlider = round(get(h.Sliderplotwindowfitdata1, 'Value'));

h = buttonClearFitData(h, '1', valueSlider);

guidata(hObj, h);

function buttonExportFitData1(hObj, callbackdata, handles)
% Function used to export plot data selected by the user
h = guidata(hObj);

% Function to make "Export" button blink in red during export process
col = get(hObj,'backg');  % Get the background color of the figure.
set(hObj,'str','Exporting','backg',[1 .6 .6]) % Change color of button. 
% The pause (or drawnow) is necessary to make button changes appear.
pause(.01)

% Get String from popupmenu
Str = get(h.popupmenuXData1, 'String');
Val = get(h.popupmenuXData1, 'Value');
XDataStr = Str{Val};
% Get String from popupmenu
Str = get(h.popupmenuYData1, 'String');
Val = get(h.popupmenuYData1, 'Value');
YDataStr = Str{Val};

% Create new folder in plot folder with name of measurement file

h = buttonExportFitData(h, '1', XDataStr, YDataStr);

% Reset the button color
set(hObj,'str','Export plots','backg',col)  % Now reset the button features.

guidata(hObj, h);

function Callbackplotwindowfitdata1checkboxphi0(hObj, callbackdata)
% Callback for checkbox phi = 0
h = guidata(hObj);

value = get(hObj, 'Value');

% Get String from popupmenu
Str = get(h.popupmenuYData1, 'String');
Val = get(h.popupmenuYData1, 'Value');
YDataStr = Str{Val};

h = CallbackPlotwindowCheckboxPhi(h, '1', '0', value, YDataStr);

guidata(hObj, h);

function Callbackplotwindowfitdata1checkboxphi90(hObj, callbackdata)
% Callback for checkbox phi = 90
h = guidata(hObj);

value = get(hObj, 'Value');

% Get String from popupmenu
Str = get(h.popupmenuYData1, 'String');
Val = get(h.popupmenuYData1, 'Value');
YDataStr = Str{Val};

h = CallbackPlotwindowCheckboxPhi(h, '1', '90', value, YDataStr);

guidata(hObj, h);

function Callbackplotwindowfitdata1checkboxphi180(hObj, callbackdata)
% Callback for checkbox phi = 180
h = guidata(hObj);

value = get(hObj, 'Value');

% Get String from popupmenu
Str = get(h.popupmenuYData1, 'String');
Val = get(h.popupmenuYData1, 'Value');
YDataStr = Str{Val};

h = CallbackPlotwindowCheckboxPhi(h, '1', '180', value, YDataStr);

guidata(hObj, h);

function Callbackplotwindowfitdata1checkboxphi270(hObj, callbackdata)
% Callback for checkbox phi = 270
h = guidata(hObj);

value = get(hObj, 'Value');

% Get String from popupmenu
Str = get(h.popupmenuYData1, 'String');
Val = get(h.popupmenuYData1, 'Value');
YDataStr = Str{Val};

h = CallbackPlotwindowCheckboxPhi(h, '1', '270', value, YDataStr);

guidata(hObj, h);

% Callback for plotting fitted data from plot window 2
function CallbackpopupmenuXData2(hObj, callbackdata, handles)
% Function used to modify the X-scale of the stress data plotted in the 
% stresspanelplot
h = guidata(hObj);
% Get String from popupmenu
Str = get(hObj, 'String');
Val = get(hObj, 'Value');
XDataStr = Str{Val};
% Get slider value
valueSlider = round(get(h.Sliderplotwindowfitdata2, 'Value'));

h = CallbackpopupmenuXData(h, '2', XDataStr, valueSlider);

guidata(hObj, h);

function CallbackpopupmenuYData2(hObj, callbackdata, handles)
% Function used to modify the X-scale of the stress data plotted in the 
% stresspanelplot
h = guidata(hObj);
% Get String from popupmenu
Str = get(hObj, 'String');
Val = get(hObj, 'Value');
YDataStr = Str{Val};
Str = get(h.popupmenuXData2, 'String');
Val = get(h.popupmenuXData2, 'Value');
XDataStr = Str{Val};

% Get slider value
valueSlider = round(get(h.Sliderplotwindowfitdata2, 'Value'));

h = CallbackpopupmenuYData(h, '2', YDataStr, valueSlider);

guidata(hObj, h);

function SliderCallbackPlotfitdata2(hObj, callbackdata, handles)
% Function used to modify the X-scale of the stress data plotted in the 
% stresspanelplot
h = guidata(hObj);
% Get slider value
valueSlider = get(hObj, 'Value');
% Get String from popupmenu
Str = get(h.popupmenuXData2, 'String');
Val = get(h.popupmenuXData2, 'Value');
XDataStr = Str{Val};
% Get String from popupmenu
Str = get(h.popupmenuYData2, 'String');
Val = get(h.popupmenuYData2, 'Value');
YDataStr = Str{Val};

h = SliderCallbackPlotfitdata(h, '2', XDataStr, YDataStr, valueSlider);

guidata(hObj, h);

function buttonClearFitData2(hObj, callbackdata, handles)
% Function used to modify the X-scale of the stress data plotted in the 
% stresspanelplot
h = guidata(hObj);

% Get slider value
valueSlider = round(get(h.Sliderplotwindowfitdata2, 'Value'));

h = buttonClearFitData(h, '2', valueSlider);

guidata(hObj, h);

function buttonExportFitData2(hObj, callbackdata, handles)
% Function used to export plot data selected by the user
h = guidata(hObj);

% Function to make "Export" button blink in red during export process
col = get(hObj,'backg');  % Get the background color of the figure.
set(hObj,'str','Exporting','backg',[1 .6 .6]) % Change color of button. 
% The pause (or drawnow) is necessary to make button changes appear.
pause(.01)

% Get String from popupmenu
Str = get(h.popupmenuXData2, 'String');
Val = get(h.popupmenuXData2, 'Value');
XDataStr = Str{Val};
% Get String from popupmenu
Str = get(h.popupmenuYData2, 'String');
Val = get(h.popupmenuYData2, 'Value');
YDataStr = Str{Val};

% Create new folder in plot folder with name of measurement file

h = buttonExportFitData(h, '2', XDataStr, YDataStr);

% Reset the button color
set(hObj,'str','Export plots','backg',col)  % Now reset the button features.

guidata(hObj, h);

function Callbackplotwindowfitdata2checkboxphi0(hObj, callbackdata)
% Callback for checkbox phi = 0
h = guidata(hObj);

value = get(hObj, 'Value');

% Get String from popupmenu
Str = get(h.popupmenuYData2, 'String');
Val = get(h.popupmenuYData2, 'Value');
YDataStr = Str{Val};

h = CallbackPlotwindowCheckboxPhi(h, '2', '0', value, YDataStr);

guidata(hObj, h);

function Callbackplotwindowfitdata2checkboxphi90(hObj, callbackdata)
% Callback for checkbox phi = 90
h = guidata(hObj);

value = get(hObj, 'Value');

% Get String from popupmenu
Str = get(h.popupmenuYData2, 'String');
Val = get(h.popupmenuYData2, 'Value');
YDataStr = Str{Val};

h = CallbackPlotwindowCheckboxPhi(h, '2', '90', value, YDataStr);

guidata(hObj, h);

function Callbackplotwindowfitdata2checkboxphi180(hObj, callbackdata)
% Callback for checkbox phi = 180
h = guidata(hObj);

value = get(hObj, 'Value');

% Get String from popupmenu
Str = get(h.popupmenuYData2, 'String');
Val = get(h.popupmenuYData2, 'Value');
YDataStr = Str{Val};

h = CallbackPlotwindowCheckboxPhi(h, '2', '180', value, YDataStr);

guidata(hObj, h);

function Callbackplotwindowfitdata2checkboxphi270(hObj, callbackdata)
% Callback for checkbox phi = 270
h = guidata(hObj);

value = get(hObj, 'Value');

% Get String from popupmenu
Str = get(h.popupmenuYData2, 'String');
Val = get(h.popupmenuYData2, 'Value');
YDataStr = Str{Val};

h = CallbackPlotwindowCheckboxPhi(h, '2', '270', value, YDataStr);

guidata(hObj, h);

% Callback for plotting fitted data from plot window 3
function CallbackpopupmenuXData3(hObj, callbackdata, handles)
% Function used to modify the X-scale of the stress data plotted in the 
% stresspanelplot
h = guidata(hObj);
% Get String from popupmenu
Str = get(hObj, 'String');
Val = get(hObj, 'Value');
XDataStr = Str{Val};
% Get slider value
valueSlider = round(get(h.Sliderplotwindowfitdata3, 'Value'));

h = CallbackpopupmenuXData(h, '3', XDataStr, valueSlider);

guidata(hObj, h);

function CallbackpopupmenuYData3(hObj, callbackdata, handles)
% Function used to modify the X-scale of the stress data plotted in the 
% stresspanelplot
h = guidata(hObj);
% Get String from popupmenu
Str = get(hObj, 'String');
Val = get(hObj, 'Value');
YDataStr = Str{Val};
Str = get(h.popupmenuXData3, 'String');
Val = get(h.popupmenuXData3, 'Value');
XDataStr = Str{Val};

% Get slider value
valueSlider = round(get(h.Sliderplotwindowfitdata3, 'Value'));

h = CallbackpopupmenuYData(h, '3', YDataStr, valueSlider);

guidata(hObj, h);

function SliderCallbackPlotfitdata3(hObj, callbackdata, handles)
% Function used to modify the X-scale of the stress data plotted in the 
% stresspanelplot
h = guidata(hObj);
% Get slider value
valueSlider = get(hObj, 'Value');
% Get String from popupmenu
Str = get(h.popupmenuXData3, 'String');
Val = get(h.popupmenuXData3, 'Value');
XDataStr = Str{Val};
% Get String from popupmenu
Str = get(h.popupmenuYData3, 'String');
Val = get(h.popupmenuYData3, 'Value');
YDataStr = Str{Val};

h = SliderCallbackPlotfitdata(h, '3', XDataStr, YDataStr, valueSlider);

guidata(hObj, h);

function buttonClearFitData3(hObj, callbackdata, handles)
% Function used to modify the X-scale of the stress data plotted in the 
% stresspanelplot
h = guidata(hObj);

% Get slider value
valueSlider = round(get(h.Sliderplotwindowfitdata3, 'Value'));

h = buttonClearFitData(h, '3', valueSlider);

guidata(hObj, h);

function buttonExportFitData3(hObj, callbackdata, handles)
% Function used to export plot data selected by the user
h = guidata(hObj);

% Function to make "Export" button blink in red during export process
col = get(hObj,'backg');  % Get the background color of the figure.
set(hObj,'str','Exporting','backg',[1 .6 .6]) % Change color of button. 
% The pause (or drawnow) is necessary to make button changes appear.
pause(.01)

% Get String from popupmenu
Str = get(h.popupmenuXData3, 'String');
Val = get(h.popupmenuXData3, 'Value');
XDataStr = Str{Val};
% Get String from popupmenu
Str = get(h.popupmenuYData3, 'String');
Val = get(h.popupmenuYData3, 'Value');
YDataStr = Str{Val};

% Create new folder in plot folder with name of measurement file
h = buttonExportFitData(h, '3', XDataStr, YDataStr);

% Reset the button color
set(hObj,'str','Export plots','backg',col)  % Now reset the button features.

guidata(hObj, h);

function Callbackplotwindowfitdata3checkboxphi0(hObj, callbackdata)
% Callback for checkbox phi = 0
h = guidata(hObj);

value = get(hObj, 'Value');

% Get String from popupmenu
Str = get(h.popupmenuYData3, 'String');
Val = get(h.popupmenuYData3, 'Value');
YDataStr = Str{Val};

h = CallbackPlotwindowCheckboxPhi(h, '3', '0', value, YDataStr);

guidata(hObj, h);

function Callbackplotwindowfitdata3checkboxphi90(hObj, callbackdata)
% Callback for checkbox phi = 90
h = guidata(hObj);

value = get(hObj, 'Value');

% Get String from popupmenu
Str = get(h.popupmenuYData3, 'String');
Val = get(h.popupmenuYData3, 'Value');
YDataStr = Str{Val};

h = CallbackPlotwindowCheckboxPhi(h, '3', '90', value, YDataStr);

guidata(hObj, h);

function Callbackplotwindowfitdata3checkboxphi180(hObj, callbackdata)
% Callback for checkbox phi = 180
h = guidata(hObj);

value = get(hObj, 'Value');

% Get String from popupmenu
Str = get(h.popupmenuYData3, 'String');
Val = get(h.popupmenuYData3, 'Value');
YDataStr = Str{Val};

h = CallbackPlotwindowCheckboxPhi(h, '3', '180', value, YDataStr);

guidata(hObj, h);

function Callbackplotwindowfitdata3checkboxphi270(hObj, callbackdata)
% Callback for checkbox phi = 270
h = guidata(hObj);

value = get(hObj, 'Value');

% Get String from popupmenu
Str = get(h.popupmenuYData3, 'String');
Val = get(h.popupmenuYData3, 'Value');
YDataStr = Str{Val};

h = CallbackPlotwindowCheckboxPhi(h, '3', '270', value, YDataStr);

guidata(hObj, h);

% Callback for plotting fitted data from plot window 4
function CallbackpopupmenuXData4(hObj, callbackdata, handles)
% Function used to modify the X-scale of the stress data plotted in the 
% stresspanelplot
h = guidata(hObj);
% Get String from popupmenu
Str = get(hObj, 'String');
Val = get(hObj, 'Value');
XDataStr = Str{Val};
% Get slider value
valueSlider = round(get(h.Sliderplotwindowfitdata4, 'Value'));

h = CallbackpopupmenuXData(h, '4', XDataStr, valueSlider);

guidata(hObj, h);

function CallbackpopupmenuYData4(hObj, callbackdata, handles)
% Function used to modify the X-scale of the stress data plotted in the 
% stresspanelplot
h = guidata(hObj);
% Get String from popupmenu
Str = get(hObj, 'String');
Val = get(hObj, 'Value');
YDataStr = Str{Val};
Str = get(h.popupmenuXData4, 'String');
Val = get(h.popupmenuXData4, 'Value');
XDataStr = Str{Val};

% Get slider value
valueSlider = round(get(h.Sliderplotwindowfitdata4, 'Value'));

h = CallbackpopupmenuYData(h, '4', YDataStr, valueSlider);

guidata(hObj, h);

function SliderCallbackPlotfitdata4(hObj, callbackdata, handles)
% Function used to modify the X-scale of the stress data plotted in the 
% stresspanelplot
h = guidata(hObj);
% Get slider value
valueSlider = get(hObj, 'Value');
% Get String from popupmenu
Str = get(h.popupmenuXData4, 'String');
Val = get(h.popupmenuXData4, 'Value');
XDataStr = Str{Val};
% Get String from popupmenu
Str = get(h.popupmenuYData4, 'String');
Val = get(h.popupmenuYData4, 'Value');
YDataStr = Str{Val};

h = SliderCallbackPlotfitdata(h, '4', XDataStr, YDataStr, valueSlider);

guidata(hObj, h);

function buttonClearFitData4(hObj, callbackdata, handles)
% Function used to modify the X-scale of the stress data plotted in the 
% stresspanelplot
h = guidata(hObj);

% Get slider value
valueSlider = round(get(h.Sliderplotwindowfitdata4, 'Value'));

h = buttonClearFitData(h, '4', valueSlider);

guidata(hObj, h);

function buttonExportFitData4(hObj, callbackdata, handles)
% Function used to export plot data selected by the user
h = guidata(hObj);

% Function to make "Export" button blink in red during export process
col = get(hObj,'backg');  % Get the background color of the figure.
set(hObj,'str','Exporting','backg',[1 .6 .6]) % Change color of button. 
% The pause (or drawnow) is necessary to make button changes appear.
pause(.01)

% Get String from popupmenu
Str = get(h.popupmenuXData4, 'String');
Val = get(h.popupmenuXData4, 'Value');
XDataStr = Str{Val};
% Get String from popupmenu
Str = get(h.popupmenuYData4, 'String');
Val = get(h.popupmenuYData4, 'Value');
YDataStr = Str{Val};

% Create new folder in plot folder with name of measurement file
h = buttonExportFitData(h, '4', XDataStr, YDataStr);

% Reset the button color
set(hObj,'str','Export plots','backg',col)  % Now reset the button features.

guidata(hObj, h);

function Callbackplotwindowfitdata4checkboxphi0(hObj, callbackdata)
% Callback for checkbox phi = 0
h = guidata(hObj);

value = get(hObj, 'Value');

% Get String from popupmenu
Str = get(h.popupmenuYData4, 'String');
Val = get(h.popupmenuYData4, 'Value');
YDataStr = Str{Val};

h = CallbackPlotwindowCheckboxPhi(h, '4', '0', value, YDataStr);

guidata(hObj, h);

function Callbackplotwindowfitdata4checkboxphi90(hObj, callbackdata)
% Callback for checkbox phi = 90
h = guidata(hObj);

value = get(hObj, 'Value');

% Get String from popupmenu
Str = get(h.popupmenuYData4, 'String');
Val = get(h.popupmenuYData4, 'Value');
YDataStr = Str{Val};

h = CallbackPlotwindowCheckboxPhi(h, '4', '90', value, YDataStr);

guidata(hObj, h);

function Callbackplotwindowfitdata4checkboxphi180(hObj, callbackdata)
% Callback for checkbox phi = 180
h = guidata(hObj);

value = get(hObj, 'Value');

% Get String from popupmenu
Str = get(h.popupmenuYData4, 'String');
Val = get(h.popupmenuYData4, 'Value');
YDataStr = Str{Val};

h = CallbackPlotwindowCheckboxPhi(h, '4', '180', value, YDataStr);

guidata(hObj, h);

function Callbackplotwindowfitdata4checkboxphi270(hObj, callbackdata)
% Callback for checkbox phi = 270
h = guidata(hObj);

value = get(hObj, 'Value');

% Get String from popupmenu
Str = get(h.popupmenuYData4, 'String');
Val = get(h.popupmenuYData4, 'Value');
YDataStr = Str{Val};

h = CallbackPlotwindowCheckboxPhi(h, '4', '270', value, YDataStr);

guidata(hObj, h);

%% Callbacks for universal plot tab
function buttonloaduplotdata1(hObj,~)
% Callback for "Load data" pushbutton in universal plot tab
h = guidata(hObj);

% Get hkl incides from tablephasehkl
hkldata = get(h.tablephasehkl,'data');
% assignin('base','FitPeaksLogical',h.FitPeaksLogical)
% Only use hkl from fitted peaks
if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    hklindices = cell2mat(hkldata(h.FitPeaksLogical(:,1),1:3));
elseif strcmp(h.Diffsel,'LEDDI')
    if strcmp(h.Detsel,'Detector 1')
        hklindices = cell2mat(hkldata(h.FitPeaksLogicalDet1(:,1),1:3));
    elseif strcmp(h.Detsel,'Detector 2')
        hklindices = cell2mat(hkldata(h.FitPeaksLogicalDet2(:,1),1:3));
    end
end

hklindices = hklindices(h.KeepPeaksDEKLogical(:,1),1:3);

% Get d0 values from fit and create copy as dzerouser
h.dzerofit = h.sin2psi.dzero';
% assignin('base','dzerofit',h.dzerofit)
h.dzerouser = h.dzerofit;
% Set table data
set(h.tableuplotdspacing,'data',[num2cell(hklindices) num2cell(h.dzerofit) num2cell(h.dzerouser) num2cell(true(size(h.dzerofit,1),1))])

% assignin('base','sin2psi',h.sin2psi)
% assignin('base','ParamsToFit',h.ParamsToFit)

guidata(hObj, h);

function celleditcallbacktableuplotdspacing(hObj, ~)
% Callback for Uplottabledata
h = guidata(hObj);
% Get data from hkl table 
Uplottabledata = get(hObj,'data');
% Get user defined d0 values
h.dzerouser = cell2mat(Uplottabledata(:,5));
% Get user defined peaks to be used for the analysis
h.userpeaksuplot = cell2mat(Uplottabledata(:,6));

guidata(hObj, h);

function buttonplotuplotdata(hObj,~)
% Callback for plot uplot data pushbutton
h = guidata(hObj);

% Function to make "Fit" button blink in red during fitting process
col = get(hObj,'backg');  % Get the background color of the figure.
set(hObj,'str','Loading','backg',[1 .6 .6]) % Change color of button. 
% The pause (or drawnow) is necessary to make button changes appear.
pause(.01)

% Get value from dzero checkbox
h.dzerovauleschkbx = get(h.userdzerocheckbox,'Value');

% Get indices of user selected peaks
if ~isfield(h,'userpeaksuplot')
    Uplottabledata = get(h.tableuplotdspacing,'data');
    % Get user defined d0 values
    h.dzerouser = cell2mat(Uplottabledata(:,5));
    % Get user defined peaks to be used for the analysis
    h.userpeaksuplot = cell2mat(Uplottabledata(:,6));
end

indkeeppeaks = find(h.userpeaksuplot==1);

h.UPlot = UniversalPlotCalc(h);
h.UPlotBackup = h.UPlot;
% assignin('base','UPlot',h.UPlot)

% Delete current plot if data is updated
if isfield(h,'sigma11uplotdata')
    oldplots = findobj(h.axesuplotdatasigma11,'type','ErrorBar');
    delete(oldplots)
end

if isfield(h,'sigma22uplotdata')
    oldplots = findobj(h.axesuplotdatasigma22,'type','ErrorBar');
    delete(oldplots)
end

if isfield(h,'sigma13uplotdata')
    oldplots = findobj(h.axesuplotdatasigma13,'type','ErrorBar');
    delete(oldplots)
end

if isfield(h,'sigma23uplotdata')
    oldplots = findobj(h.axesuplotdatasigma23,'type','ErrorBar');
    delete(oldplots)
end

% Delete old plots
oldplotssigma11 = findobj(h.axesuplotdatasigma11,'type','Line');

if ~isempty(oldplotssigma11)
    delete(oldplotssigma11)
end

oldplotssigma22 = findobj(h.axesuplotdatasigma22,'type','Line');

if ~isempty(oldplotssigma22)
    delete(oldplotssigma22)
end

oldplotssigma13 = findobj(h.axesuplotdatasigma13,'type','Line');

if ~isempty(oldplotssigma13)
    delete(oldplotssigma13)
end

oldplotssigma23 = findobj(h.axesuplotdatasigma23,'type','Line');

if ~isempty(oldplotssigma23)
    delete(oldplotssigma23)
end

% Filter universal plot data
if get(h.filteruplotdatacheckbox,'Value') == 1
    h.UPlot = UPlotDataFilter(h);
else
    % Repmat tau for deleting Inf and large error values for each stress
    % component
    tautmp = repmat(h.UPlot.TauCalc.tau,4,1);
    for k = 1:size(indkeeppeaks,1)
        sinsquarepsi{k} = h.sin2psi.dphi0p180sinquadratpsi{indkeeppeaks(k)}(:,1);
    end
    sin2psitmp = repmat(sinsquarepsi,4,1);
    
    h.UPlot.TauCalc.tau = tautmp;
    h.UPlot.sin2psi = sin2psitmp;
end

% Choose sin²psi range
minsin2psi = str2double(get(h.editsin2psirange1,'String'));
maxsin2psi = str2double(get(h.editsin2psirange2,'String'));

% Find values in user defined range
for k = 1:4
    for l = 1:size(h.UPlot.sin2psi,2)
        sin2psirange{k,l} = find(h.UPlot.sin2psi{k,l} >= minsin2psi & h.UPlot.sin2psi{k,l} <= maxsin2psi);
    end
end
% Save sin2psi range to guidata
h.sin2psirange = sin2psirange;

%% Sigma11
if ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270) || ...
    isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
    isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270) || ...
    isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
    isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)

    h.tausigma11tmp = cell(1);
    h.sigma11tmp = cell(1);
    h.sigma11deltatmp = cell(1);
    
    for k = 1:size(h.UPlot.TauCalc.tau,2)
        h.tausigma11tmp{1,k} = h.UPlot.TauCalc.tau{1,k}(sin2psirange{1,k});
        % Get stress data for sigma11
        h.sigma11tmp{k} = h.UPlot.sigma11{k}(sin2psirange{1,k});
        h.sigma11deltatmp{k} = h.UPlot.sigma11delta{k}(sin2psirange{1,k});
    end

    if get(h.uplotplotfitscheckbox,'value') == 1    
        % Prepare fit data
        FitDatasigma11tmp = [[h.tausigma11tmp{1,:}];cell2mat(h.sigma11tmp);cell2mat(h.sigma11deltatmp)]';
        h.FitDatasigma11 = sortrows(FitDatasigma11tmp,1);   
        
        % Get user selected fit function and start parameter
        [h.funcsigma11,h.funczsigma11,FitParams] = UPlotFitFunctions(h,h.FitDatasigma11,1);
        % Fit stress data, showing 95% Confidence limits
        opts = statset('MaxIter',400,'TolFun',1e-10,'TolX',1e-8);
        [h.Paramssigma11,Rsigma11,Jsigma11,CovBsigma11] = nlinfit(h.FitDatasigma11(:,1),h.FitDatasigma11(:,2),h.funcsigma11,FitParams,opts,'Weights',1./h.FitDatasigma11(:,3));
%         [h.Ypredsigma11,deltasigma11] = nlpredci(h.funcsigma11,h.FitDatasigma11(:,1),h.Paramssigma11,Rsigma11,'Jacobian',Jsigma11);
%         [h.Ypredsigma11z,deltasigma11z] = nlpredci(h.funczsigma11,h.FitDatasigma11(:,1),h.Paramssigma11,Rsigma11,'Jacobian',Jsigma11);

        [h.Ypredsigma11,deltasigma11] = nlpredci(h.funcsigma11,linspace(0.001,100,1001),h.Paramssigma11,Rsigma11,'Jacobian',Jsigma11);
        [h.Ypredsigma11z,deltasigma11z] = nlpredci(h.funczsigma11,linspace(0.001,100,1001),h.Paramssigma11,Rsigma11,'Jacobian',Jsigma11);
    end
    h.deltasigma11 = deltasigma11;
    % Plot stress distributions of different stress compontens
    h.sigma11uplotdata = 0;
    for k = 1:size(h.UPlot.TauCalc.tau,2)
        h.sigma11uplotdata(k) = errorbar(h.axesuplotdatasigma11, h.UPlot.TauCalc.tau{1,k}(sin2psirange{1,k}), h.UPlot.sigma11{k}(sin2psirange{1,k}), h.UPlot.sigma11delta{k}(sin2psirange{1,k}),'Linestyle','none','Color','k','Marker','s','MarkerSize',14,'MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'Clipping','off');
        hold(h.axesuplotdatasigma11,'on')
    end

    % Set plot properties
    grid(h.axesuplotdatasigma11,'on')
    xlim(h.axesuplotdatasigma11,'auto')
    ylim(h.axesuplotdatasigma11,'auto')
    xticks(h.axesuplotdatasigma11,'auto')
    yticks(h.axesuplotdatasigma11,'auto')

    set(h.editXlimmin1,'String',num2str(h.axesuplotdatasigma11.XLim(1)))
    set(h.editXlimmax1,'String',num2str(h.axesuplotdatasigma11.XLim(2)))
    set(h.editXlimtick1,'String',num2str(h.axesuplotdatasigma11.XTick(2)-h.axesuplotdatasigma11.XTick(1)))

    set(h.editYlimmin1,'String',num2str(h.axesuplotdatasigma11.YLim(1)))
    set(h.editYlimmax1,'String',num2str(h.axesuplotdatasigma11.YLim(2)))
    set(h.editYlimtick1,'String',num2str(h.axesuplotdatasigma11.YTick(2)-h.axesuplotdatasigma11.YTick(1)))

    xlabel(h.axesuplotdatasigma11,'z, \tau [µm]')
    ylabel(h.axesuplotdatasigma11,'\sigma_{11} [MPa]')
    title(h.axesuplotdatasigma11,[[char(963),char(8321),char(8321)],' Universal plot data for ',strrep(h.Measurement(1).MeasurementSeries,' ','')], 'HorizontalAlignment', 'center', 'Interpreter', 'none')
    
    if get(h.uplotplotfitscheckbox,'value') == 1
        % Delete old plots
        oldplotssigma11 = findobj(h.axesuplotdatasigma11,'type','Line');
        delete(oldplotssigma11)
        % Plot sigma tau
%         h.plotsigma11tau = plot(h.axesuplotdatasigma11, h.FitDatasigma11(:,1), h.Ypredsigma11,'r-','Linewidth',2);
%         h.plotsigma11tauCI = plot(h.axesuplotdatasigma11,h.FitDatasigma11(:,1), [h.Ypredsigma11+deltasigma11, h.Ypredsigma11-deltasigma11],'r:','Linewidth',2,'Visible','off');
%         % Plot sigma z
%         h.plotsigma11z = plot(h.axesuplotdatasigma11, h.FitDatasigma11(:,1), h.Ypredsigma11z,'k-','Linewidth',2);
%         assignin('base','Ypredsigma11',h.Ypredsigma11)
%         assignin('base','deltasigma11',deltasigma11)
        h.plotsigma11tau = plot(h.axesuplotdatasigma11, linspace(0.001,100,1001), h.Ypredsigma11,'r-','Linewidth',2);
        h.plotsigma11tauCI = plot(h.axesuplotdatasigma11,linspace(0.001,100,1001), [h.Ypredsigma11+deltasigma11; h.Ypredsigma11-deltasigma11],'r:','Linewidth',2,'Visible','off');
        % Plot sigma z
        h.plotsigma11z = plot(h.axesuplotdatasigma11, linspace(0,100,1001), h.Ypredsigma11z,'k-','Linewidth',2);
        
        % Set axes limits
        xlim(h.axesuplotdatasigma11,'auto')
        ylim(h.axesuplotdatasigma11,'auto')
        xticks(h.axesuplotdatasigma11,'auto')
        yticks(h.axesuplotdatasigma11,'auto')
    end

    % Set axes legend
    % Create hkl label
    labeltmp = CreateHKLlabel(h);
    for k = 1:size(labeltmp,1)
        label{:,k} = labeltmp(k,:);
    end
    
    indkeeppeaks = find(h.userpeaksuplot==1);

    % Create legends
    if get(h.uplotplotfitscheckbox,'value') == 0
        legend(h.axesuplotdatasigma11,[h.sigma11uplotdata],label(indkeeppeaks),'FontSize',12);
    else
        legend(h.axesuplotdatasigma11,[h.sigma11uplotdata,h.plotsigma11tau,h.plotsigma11z],[label(indkeeppeaks),'\sigma_{11}(\tau)','\sigma_{11}(z)'],'FontSize',12);
    end
end

%% Sigma22
if isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270) || ...
    isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
    isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270) || ...
    isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
    isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
    isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
    
    h.tausigma22tmp = cell(1);
    h.sigma22tmp = cell(1);
    h.sigma22deltatmp = cell(1);

        for k = 1:size(h.UPlot.TauCalc.tau,2)
            h.tausigma22tmp{1,k} = h.UPlot.TauCalc.tau{2,k}(sin2psirange{2,k});
            % Get stress data for sigma22
            h.sigma22tmp{k} = h.UPlot.sigma22{k}(sin2psirange{2,k});
            h.sigma22deltatmp{k} = h.UPlot.sigma22delta{k}(sin2psirange{2,k});
        end
        
    if get(h.uplotplotfitscheckbox,'value') == 1    
        % Prepare fit data
        FitDatasigma22tmp = [[h.tausigma22tmp{1,:}];cell2mat(h.sigma22tmp);cell2mat(h.sigma22deltatmp)]';
        h.FitDatasigma22 = sortrows(FitDatasigma22tmp,1);

        % Get user selected fit function and start parameter
        [h.funcsigma22,h.funczsigma22,FitParams] = UPlotFitFunctions(h,h.FitDatasigma22,2);

        % Fit stress data, showing 95% Confidence limits
        opts = statset('MaxIter',400,'TolFun',1e-10,'TolX',1e-8);
        [h.Paramssigma22,Rsigma22,Jsigma22,CovBsigma22] = nlinfit(h.FitDatasigma22(:,1),h.FitDatasigma22(:,2),h.funcsigma22,FitParams,opts,'Weights',1./h.FitDatasigma22(:,3));
        [h.Ypredsigma22,deltasigma22] = nlpredci(h.funcsigma22,h.FitDatasigma22(:,1),h.Paramssigma22,Rsigma22,'Jacobian',Jsigma22);
        [h.Ypredsigma22z,deltasigma22z] = nlpredci(h.funczsigma22,h.FitDatasigma22(:,1),h.Paramssigma22,Rsigma22,'Jacobian',Jsigma22);
    end
    
    h.sigma22uplotdata = 0;
    
    for k = 1:size(h.UPlot.TauCalc.tau,2)
        h.sigma22uplotdata(k) = errorbar(h.axesuplotdatasigma22, h.UPlot.TauCalc.tau{2,k}(sin2psirange{2,k}), h.UPlot.sigma22{k}(sin2psirange{2,k}), h.UPlot.sigma22delta{k}(sin2psirange{2,k}),'Linestyle','none','Color','k','Marker','s','MarkerSize',14,'MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'Clipping','off');
        hold(h.axesuplotdatasigma22,'on')
    end
    % Set plot properties
    grid(h.axesuplotdatasigma22,'on')
    xlim(h.axesuplotdatasigma22,'auto')
    ylim(h.axesuplotdatasigma22,'auto')
    xticks(h.axesuplotdatasigma22,'auto')
    yticks(h.axesuplotdatasigma22,'auto')

    set(h.editXlimmin3,'String',num2str(h.axesuplotdatasigma22.XLim(1)))
    set(h.editXlimmax3,'String',num2str(h.axesuplotdatasigma22.XLim(2)))
    set(h.editXlimtick3,'String',num2str(h.axesuplotdatasigma22.XTick(2)-h.axesuplotdatasigma22.XTick(1)))

    set(h.editYlimmin3,'String',num2str(h.axesuplotdatasigma22.YLim(1)))
    set(h.editYlimmax3,'String',num2str(h.axesuplotdatasigma22.YLim(2)))
    set(h.editYlimtick3,'String',num2str(h.axesuplotdatasigma22.YTick(2)-h.axesuplotdatasigma22.YTick(1)))

    xlabel(h.axesuplotdatasigma22,'z, \tau [µm]')
    ylabel(h.axesuplotdatasigma22,'\sigma_{22} [MPa]')
    title(h.axesuplotdatasigma22,[[char(963),char(8322),char(8322)],' Universal plot data for ',strrep(h.Measurement(1).MeasurementSeries,' ','')], 'HorizontalAlignment', 'center', 'Interpreter', 'none')

    if get(h.uplotplotfitscheckbox,'value') == 1
        % Delete old plots
        oldplotssigma22 = findobj(h.axesuplotdatasigma22,'type','Line');
        delete(oldplotssigma22)
        % Plot sigma tau
        h.plotsigma22tau = plot(h.axesuplotdatasigma22, h.FitDatasigma22(:,1), h.Ypredsigma22,'r-','Linewidth',2);
        h.plotsigma22tauCI = plot(h.axesuplotdatasigma22, h.FitDatasigma22(:,1), [h.Ypredsigma22+deltasigma22, h.Ypredsigma22-deltasigma22],'r:','Linewidth',2,'Visible','off');
        % Plot sigma z
        h.plotsigma22z = plot(h.axesuplotdatasigma22, h.FitDatasigma22(:,1), h.Ypredsigma22z,'k-','Linewidth',2);
        % Set axes limits
        xlim(h.axesuplotdatasigma22,'auto')
        ylim(h.axesuplotdatasigma22,'auto')
        xticks(h.axesuplotdatasigma22,'auto')
        yticks(h.axesuplotdatasigma22,'auto')
    end

    % Set axes legend
    % Create hkl label
    labeltmp = CreateHKLlabel(h);
    for k = 1:size(labeltmp,1)
        label{:,k} = labeltmp(k,:);
    end
    
    indkeeppeaks = find(h.userpeaksuplot==1);
    
    % Create legends
    if get(h.uplotplotfitscheckbox,'value') == 0
        legend(h.axesuplotdatasigma22,[h.sigma22uplotdata],label(indkeeppeaks),'FontSize',12);
    else
        legend(h.axesuplotdatasigma22,[h.sigma22uplotdata,h.plotsigma22tau,h.plotsigma22z],[label(indkeeppeaks),'\sigma_{22}(\tau)','\sigma_{22}(z)'],'FontSize',12);
    end
end

%% Sigma13
if ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)

    h.tausigma13tmp = cell(1);
    h.sigma13tmp = cell(1);
    h.sigma13deltatmp = cell(1);

        for k = 1:size(h.UPlot.TauCalc.tau,2)
            h.tausigma13tmp{1,k} = h.UPlot.TauCalc.tau{3,k}(sin2psirange{3,k});
            % Get stress data for sigma13
            h.sigma13tmp{k} = h.UPlot.sigma13{k}(sin2psirange{3,k});
            h.sigma13deltatmp{k} = h.UPlot.sigma13delta{k}(sin2psirange{3,k});
        end
    if get(h.uplotplotfitscheckbox,'value') == 1    
        % Prepare fit data
        FitDatasigma13tmp = [[h.tausigma13tmp{1,:}];cell2mat(h.sigma13tmp);cell2mat(h.sigma13deltatmp)]';
        h.FitDatasigma13 = sortrows(FitDatasigma13tmp,1);

        % Get user selected fit function and start parameter
        [h.funcsigma13,h.funczsigma13,FitParams] = UPlotFitFunctions(h,h.FitDatasigma13,3);
        % Fit stress data, showing 95% Confidence limits
        opts = statset('MaxIter',400,'TolFun',1e-10,'TolX',1e-8);
        [h.Paramssigma13,Rsigma13,Jsigma13,CovBsigma13] = nlinfit(h.FitDatasigma13(:,1),h.FitDatasigma13(:,2),h.funcsigma13,FitParams,opts,'Weights',1./h.FitDatasigma13(:,3));
        [h.Ypredsigma13,deltasigma13] = nlpredci(h.funcsigma13,h.FitDatasigma13(:,1),h.Paramssigma13,Rsigma13,'Jacobian',Jsigma13);
        [h.Ypredsigma13z,deltasigma13z] = nlpredci(h.funczsigma13,h.FitDatasigma13(:,1),h.Paramssigma13,Rsigma13,'Jacobian',Jsigma13);
    end
    
    h.sigma13uplotdata = 0;
    
    for k = 1:size(h.UPlot.TauCalc.tau,2)
        h.sigma13uplotdata(k) = errorbar(h.axesuplotdatasigma13, h.UPlot.TauCalc.tau{3,k}(sin2psirange{3,k}), h.UPlot.sigma13{k}(sin2psirange{3,k}), h.UPlot.sigma13delta{k}(sin2psirange{3,k}),'Linestyle','none','Color','k','Marker','s','MarkerSize',14,'MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'Clipping','off');
        hold(h.axesuplotdatasigma13,'on')
    end
    % Set plot properties
    grid(h.axesuplotdatasigma13,'on')
    xlim(h.axesuplotdatasigma13,'auto')
    ylim(h.axesuplotdatasigma13,'auto')
    xticks(h.axesuplotdatasigma13,'auto')
    yticks(h.axesuplotdatasigma13,'auto')

    set(h.editXlimmin2,'String',num2str(h.axesuplotdatasigma13.XLim(1)))
    set(h.editXlimmax2,'String',num2str(h.axesuplotdatasigma13.XLim(2)))
    set(h.editXlimtick2,'String',num2str(h.axesuplotdatasigma13.XTick(2)-h.axesuplotdatasigma13.XTick(1)))

    set(h.editYlimmin2,'String',num2str(h.axesuplotdatasigma13.YLim(1)))
    set(h.editYlimmax2,'String',num2str(h.axesuplotdatasigma13.YLim(2)))
    set(h.editYlimtick2,'String',num2str(h.axesuplotdatasigma13.YTick(2)-h.axesuplotdatasigma13.YTick(1)))

    xlabel(h.axesuplotdatasigma13,'z, \tau [µm]')
    ylabel(h.axesuplotdatasigma13,'\sigma_{13} [MPa]')
    title(h.axesuplotdatasigma13,[[char(963),char(8321),char(8323)],' Universal plot data for ',strrep(h.Measurement(1).MeasurementSeries,' ','')], 'HorizontalAlignment', 'center', 'Interpreter', 'none')

    if get(h.uplotplotfitscheckbox,'value') == 1
        % Delete old plots
        oldplotssigma13 = findobj(h.axesuplotdatasigma13,'type','Line');
        delete(oldplotssigma13)
        % Plot sigma tau
        h.plotsigma13tau = plot(h.axesuplotdatasigma13, h.FitDatasigma13(:,1), h.Ypredsigma13,'r-','Linewidth',2);
        h.plotsigma13tauCI = plot(h.axesuplotdatasigma13, h.FitDatasigma13(:,1), [h.Ypredsigma13+deltasigma13, h.Ypredsigma13-deltasigma13],'r:','Linewidth',2,'Visible','off');
        % Plot sigma z
        h.plotsigma13z = plot(h.axesuplotdatasigma13, h.FitDatasigma13(:,1), h.Ypredsigma13z,'k-','Linewidth',2);

        % Set axes limits
        xlim(h.axesuplotdatasigma13,'auto')
        ylim(h.axesuplotdatasigma13,'auto')
        xticks(h.axesuplotdatasigma13,'auto')
        yticks(h.axesuplotdatasigma13,'auto')
    end

    % Set axes legend
    % Create hkl label
    labeltmp = CreateHKLlabel(h);
    for k = 1:size(labeltmp,1)
        label{:,k} = labeltmp(k,:);
    end
    
    indkeeppeaks = find(h.userpeaksuplot==1);
    
    % Create legends
    if get(h.uplotplotfitscheckbox,'value') == 0
        legend(h.axesuplotdatasigma13,[h.sigma13uplotdata],label(indkeeppeaks),'FontSize',12);
    else
        legend(h.axesuplotdatasigma13,[h.sigma13uplotdata,h.plotsigma13tau,h.plotsigma13z],[label(indkeeppeaks),'\sigma_{13}(\tau)','\sigma_{13}(z)'],'FontSize',12);
    end
end

%% Sigma23
if isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
    isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)

    h.tausigma23tmp = cell(1);
    h.sigma23tmp = cell(1);
    h.sigma23deltatmp = cell(1);

        for k = 1:size(h.UPlot.TauCalc.tau,2)
            h.tausigma23tmp{1,k} = h.UPlot.TauCalc.tau{4,k}(sin2psirange{4,k});
            h.sigma23tmp{k} = h.UPlot.sigma23{k}(sin2psirange{4,k});
            h.sigma23deltatmp{k} = h.UPlot.sigma23delta{k}(sin2psirange{4,k});
        end
        % Prepare fit data
    if get(h.uplotplotfitscheckbox,'value') == 1
        FitDatasigma23tmp = [[h.tausigma23tmp{1,:}];cell2mat(h.sigma23tmp);cell2mat(h.sigma23deltatmp)]';
        h.FitDatasigma23 = sortrows(FitDatasigma23tmp,1);

        % Get user selected fit function and start parameter
        [h.funcsigma23,h.funczsigma23,FitParams] = UPlotFitFunctions(h,h.FitDatasigma23,4);

        % Fit stress data, showing 95% Confidence limits
        opts = statset('MaxIter',400,'TolFun',1e-10,'TolX',1e-8);
        [h.Paramssigma23,Rsigma23,Jsigma23,CovBsigma23] = nlinfit(h.FitDatasigma23(:,1),h.FitDatasigma23(:,2),h.funcsigma23,FitParams,opts,'Weights',1./h.FitDatasigma23(:,3));
        [h.Ypredsigma23,deltasigma23] = nlpredci(h.funcsigma23,h.FitDatasigma23(:,1),h.Paramssigma23,Rsigma23,'Jacobian',Jsigma23);
        [h.Ypredsigma23z,deltasigma23z] = nlpredci(h.funczsigma23,h.FitDatasigma23(:,1),h.Paramssigma23,Rsigma23,'Jacobian',Jsigma23);
    end
    
    h.sigma23uplotdata = 0;
    
    for k = 1:size(h.UPlot.TauCalc.tau,2)
        h.sigma23uplotdata(k) = errorbar(h.axesuplotdatasigma23, h.UPlot.TauCalc.tau{4,k}(sin2psirange{4,k}), h.UPlot.sigma23{k}(sin2psirange{4,k}), h.UPlot.sigma23delta{k}(sin2psirange{4,k}),'Linestyle','none','Color','k','Marker','s','MarkerSize',14,'MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'Clipping','off');
        hold(h.axesuplotdatasigma23,'on')
    end
    % Set plot properties
    grid(h.axesuplotdatasigma23,'on')
    xlim(h.axesuplotdatasigma23,'auto')
    ylim(h.axesuplotdatasigma23,'auto')
    xticks(h.axesuplotdatasigma23,'auto')
    yticks(h.axesuplotdatasigma23,'auto')

    set(h.editXlimmin4,'String',num2str(h.axesuplotdatasigma22.XLim(1)))
    set(h.editXlimmax4,'String',num2str(h.axesuplotdatasigma23.XLim(2)))
    set(h.editXlimtick4,'String',num2str(h.axesuplotdatasigma23.XTick(2)-h.axesuplotdatasigma23.XTick(1)))

    set(h.editYlimmin4,'String',num2str(h.axesuplotdatasigma23.YLim(1)))
    set(h.editYlimmax4,'String',num2str(h.axesuplotdatasigma23.YLim(2)))
    set(h.editYlimtick4,'String',num2str(h.axesuplotdatasigma23.YTick(2)-h.axesuplotdatasigma23.YTick(1)))

    xlabel(h.axesuplotdatasigma23,'z, \tau [µm]')
    ylabel(h.axesuplotdatasigma23,'\sigma_{23} [MPa]')
    title(h.axesuplotdatasigma23,[[char(963),char(8322),char(8323)],' Universal plot data for ',strrep(h.Measurement(1).MeasurementSeries,' ','')], 'HorizontalAlignment', 'center', 'Interpreter', 'none')

    if get(h.uplotplotfitscheckbox,'value') == 1
        % Delete old plots
        oldplotssigma23 = findobj(h.axesuplotdatasigma23,'type','Line');
        delete(oldplotssigma23)
        % Plot sigma tau
        h.plotsigma23tau = plot(h.axesuplotdatasigma23, h.FitDatasigma23(:,1), h.Ypredsigma23,'r-','Linewidth',2);
        h.plotsigma23tauCI = plot(h.axesuplotdatasigma23, h.FitDatasigma23(:,1), [h.Ypredsigma23+deltasigma23, h.Ypredsigma23-deltasigma23],'r:','Linewidth',2,'Visible','off');
        % Plot sigma z
        h.plotsigma23z = plot(h.axesuplotdatasigma23, h.FitDatasigma23(:,1), h.Ypredsigma23z,'k-','Linewidth',2);

        % Set axes limits
        xlim(h.axesuplotdatasigma23,'auto')
        ylim(h.axesuplotdatasigma23,'auto')
        xticks(h.axesuplotdatasigma23,'auto')
        yticks(h.axesuplotdatasigma23,'auto')
    end

    % Set axes legend
    % Create hkl label
    labeltmp = CreateHKLlabel(h);
    for k = 1:size(labeltmp,1)
        label{:,k} = labeltmp(k,:);
    end
    
    indkeeppeaks = find(h.userpeaksuplot==1);
    
    % Create legends
    if get(h.uplotplotfitscheckbox,'value') == 0
        legend(h.axesuplotdatasigma23,[h.sigma23uplotdata],label(indkeeppeaks),'FontSize',12);
    else
        legend(h.axesuplotdatasigma23,[h.sigma23uplotdata,h.plotsigma23tau,h.plotsigma23z],[label(indkeeppeaks),'\sigma_{23}(\tau)','\sigma_{23}(z)'],'FontSize',12);
    end
end

% Reset the button color
set(hObj,'str','Plot data','backg',col)  % Now reset the button features.

guidata(hObj, h);

function ShowCIboundscheckbox(hObj,~)
% Show or hide 95% confidence bounds
h = guidata(hObj);

value = get(h.ShowCIboundscheckbox,'Value');

if isfield(h,'plotsigma11tauCI')
    if value == 1
        set(h.plotsigma11tauCI,'Visible','on')
    else
        set(h.plotsigma11tauCI,'Visible','off')
    end
end

if isfield(h,'plotsigma22tauCI')
    if value == 1
        set(h.plotsigma22tauCI,'Visible','on')
    else
        set(h.plotsigma22tauCI,'Visible','off')
    end
end

if isfield(h,'plotsigma13tauCI')
    if value == 1
        set(h.plotsigma13tauCI,'Visible','on')
    else
        set(h.plotsigma13tauCI,'Visible','off')
    end
end

if isfield(h,'plotsigma23tauCI')
    if value == 1
        set(h.plotsigma23tauCI,'Visible','on')
    else
        set(h.plotsigma23tauCI,'Visible','off')
    end
end

guidata(hObj, h);

function callbackeditXlimmin(hObj,~)
% Change plot limits
h = guidata(hObj);

Xmin = str2double(get(hObj,'String'));

if strcmp(get(hObj,'tag'),get(h.editXlimmin1,'tag'))
    h.axesuplotdatasigma11.XLim(1) = Xmin;
    h.axesuplotdatasigma11.XTick = h.axesuplotdatasigma11.XLim(1):str2double(get(h.editXlimtick1,'String')):h.axesuplotdatasigma11.XLim(2);
elseif strcmp(get(hObj,'tag'),get(h.editXlimmin2,'tag'))
    h.axesuplotdatasigma13.XLim(1) = Xmin;
    h.axesuplotdatasigma13.XTick = h.axesuplotdatasigma13.XLim(1):str2double(get(h.editXlimtick2,'String')):h.axesuplotdatasigma13.XLim(2);
elseif strcmp(get(hObj,'tag'),get(h.editXlimmin3,'tag'))
    h.axesuplotdatasigma22.XLim(1) = Xmin;
    h.axesuplotdatasigma22.XTick = h.axesuplotdatasigma22.XLim(1):str2double(get(h.editXlimtick3,'String')):h.axesuplotdatasigma22.XLim(2);
elseif strcmp(get(hObj,'tag'),get(h.editXlimmin4,'tag'))
    h.axesuplotdatasigma23.XLim(1) = Xmin;
    h.axesuplotdatasigma23.XTick = h.axesuplotdatasigma23.XLim(1):str2double(get(h.editXlimtick4,'String')):h.axesuplotdatasigma23.XLim(2);
end

guidata(hObj, h);

function callbackeditXlimmax(hObj,~)
% Change plot limits
h = guidata(hObj);

Xmax = str2double(get(hObj,'String'));

if strcmp(get(hObj,'tag'),get(h.editXlimmax1,'tag'))
    h.axesuplotdatasigma11.XLim(2) = Xmax;
    h.axesuplotdatasigma11.XTick = h.axesuplotdatasigma11.XLim(1):str2double(get(h.editXlimtick1,'String')):h.axesuplotdatasigma11.XLim(2);
elseif strcmp(get(hObj,'tag'),get(h.editXlimmax2,'tag'))
    h.axesuplotdatasigma13.XLim(2) = Xmax;
    h.axesuplotdatasigma13.XTick = h.axesuplotdatasigma13.XLim(1):str2double(get(h.editXlimtick2,'String')):h.axesuplotdatasigma13.XLim(2);
elseif strcmp(get(hObj,'tag'),get(h.editXlimmax3,'tag'))
    h.axesuplotdatasigma22.XLim(2) = Xmax;
    h.axesuplotdatasigma22.XTick = h.axesuplotdatasigma22.XLim(1):str2double(get(h.editXlimtick3,'String')):h.axesuplotdatasigma22.XLim(2);
elseif strcmp(get(hObj,'tag'),get(h.editXlimmax4,'tag'))
    h.axesuplotdatasigma23.XLim(2) = Xmax;
    h.axesuplotdatasigma23.XTick = h.axesuplotdatasigma23.XLim(1):str2double(get(h.editXlimtick4,'String')):h.axesuplotdatasigma23.XLim(2);
end

guidata(hObj, h);

function callbackeditXlimtick(hObj,~)
% Change plot limits
h = guidata(hObj);

Xtick = str2double(get(hObj,'String'));

if strcmp(get(hObj,'tag'),get(h.editXlimtick1,'tag'))
    h.axesuplotdatasigma11.XTick = h.axesuplotdatasigma11.XLim(1):Xtick:h.axesuplotdatasigma11.XLim(2);
elseif strcmp(get(hObj,'tag'),get(h.editXlimtick2,'tag'))
    h.axesuplotdatasigma13.XTick = h.axesuplotdatasigma13.XLim(1):Xtick:h.axesuplotdatasigma13.XLim(2);
elseif strcmp(get(hObj,'tag'),get(h.editXlimtick3,'tag'))
    h.axesuplotdatasigma22.XTick = h.axesuplotdatasigma22.XLim(1):Xtick:h.axesuplotdatasigma22.XLim(2);
elseif strcmp(get(hObj,'tag'),get(h.editXlimtick4,'tag'))
    h.axesuplotdatasigma23.XTick = h.axesuplotdatasigma23.XLim(1):Xtick:h.axesuplotdatasigma23.XLim(2);
end

guidata(hObj, h);

function callbackeditYlimmin(hObj,~)
% Change plot limits
h = guidata(hObj);

Ymin = str2double(get(hObj,'String'));

if strcmp(get(hObj,'tag'),get(h.editYlimmin1,'tag'))
    h.axesuplotdatasigma11.YLim(1) = Ymin;
    h.axesuplotdatasigma11.YTick = h.axesuplotdatasigma11.YLim(1):str2double(get(h.editYlimtick1,'String')):h.axesuplotdatasigma11.YLim(2);
elseif strcmp(get(hObj,'tag'),get(h.editYlimmin2,'tag'))
    h.axesuplotdatasigma13.YLim(1) = Ymin;
    h.axesuplotdatasigma13.YTick = h.axesuplotdatasigma13.YLim(1):str2double(get(h.editYlimtick2,'String')):h.axesuplotdatasigma13.YLim(2);
elseif strcmp(get(hObj,'tag'),get(h.editYlimmin3,'tag'))
    h.axesuplotdatasigma22.YLim(1) = Ymin;
    h.axesuplotdatasigma22.YTick = h.axesuplotdatasigma22.YLim(1):str2double(get(h.editYlimtick3,'String')):h.axesuplotdatasigma22.YLim(2);
elseif strcmp(get(hObj,'tag'),get(h.editYlimmin4,'tag'))
    h.axesuplotdatasigma23.YLim(1) = Ymin;
    h.axesuplotdatasigma23.YTick = h.axesuplotdatasigma23.YLim(1):str2double(get(h.editYlimtick4,'String')):h.axesuplotdatasigma23.YLim(2);
end

guidata(hObj, h);

function callbackeditYlimmax(hObj,~)
% Change plot limits
h = guidata(hObj);

Ymax = str2double(get(hObj,'String'));

if strcmp(get(hObj,'tag'),get(h.editYlimmax1,'tag'))
    h.axesuplotdatasigma11.YLim(2) = Ymax;
    h.axesuplotdatasigma11.YTick = h.axesuplotdatasigma11.YLim(1):str2double(get(h.editYlimtick1,'String')):h.axesuplotdatasigma11.YLim(2);
elseif strcmp(get(hObj,'tag'),get(h.editYlimmax2,'tag'))
    h.axesuplotdatasigma13.YLim(2) = Ymax;
    h.axesuplotdatasigma13.YTick = h.axesuplotdatasigma13.YLim(1):str2double(get(h.editYlimtick2,'String')):h.axesuplotdatasigma13.YLim(2);
elseif strcmp(get(hObj,'tag'),get(h.editYlimmax3,'tag'))
    h.axesuplotdatasigma22.YLim(2) = Ymax;
    h.axesuplotdatasigma22.YTick = h.axesuplotdatasigma22.YLim(1):str2double(get(h.editYlimtick3,'String')):h.axesuplotdatasigma22.YLim(2);
elseif strcmp(get(hObj,'tag'),get(h.editYlimmax4,'tag'))
    h.axesuplotdatasigma23.YLim(2) = Ymax;
    h.axesuplotdatasigma23.YTick = h.axesuplotdatasigma23.YLim(1):str2double(get(h.editYlimtick4,'String')):h.axesuplotdatasigma23.YLim(2);
end

guidata(hObj, h);

function callbackeditYlimtick(hObj,~)
% Change plot limits
h = guidata(hObj);

Ytick = str2double(get(hObj,'String'));

if strcmp(get(hObj,'tag'),get(h.editYlimtick1,'tag'))
    h.axesuplotdatasigma11.YTick = h.axesuplotdatasigma11.YLim(1):Ytick:h.axesuplotdatasigma11.YLim(2);
elseif strcmp(get(hObj,'tag'),get(h.editYlimtick2,'tag'))
    h.axesuplotdatasigma13.YTick = h.axesuplotdatasigma13.YLim(1):Ytick:h.axesuplotdatasigma13.YLim(2);
elseif strcmp(get(hObj,'tag'),get(h.editYlimtick3,'tag'))
    h.axesuplotdatasigma22.YTick = h.axesuplotdatasigma22.YLim(1):Ytick:h.axesuplotdatasigma22.YLim(2);
elseif strcmp(get(hObj,'tag'),get(h.editYlimtick4,'tag'))
    h.axesuplotdatasigma23.YTick = h.axesuplotdatasigma23.YLim(1):Ytick:h.axesuplotdatasigma23.YLim(2);
end

guidata(hObj, h);

function ChangeAxLimcheckbox(hObj,~)
% Show options to change axes limits
h = guidata(hObj);

if get(hObj,'Value') == 0
    if strcmp(get(hObj,'tag'),get(h.ChangeAxLimcheckbox1,'tag'))
        set([h.textXlimmin1;h.editXlimmin1;h.textXlimmax1;h.editXlimmax1;h.textXlimtick1;h.editXlimtick1;h.textYlimmin1;h.editYlimmin1;h.textYlimmax1;h.editYlimmax1;h.textYlimtick1;h.editYlimtick1],{'Visible'},{'off'});
    elseif strcmp(get(hObj,'tag'),get(h.ChangeAxLimcheckbox2,'tag'))
        set([h.textXlimmin2;h.editXlimmin2;h.textXlimmax2;h.editXlimmax2;h.textXlimtick2;h.editXlimtick2;h.textYlimmin2;h.editYlimmin2;h.textYlimmax2;h.editYlimmax2;h.textYlimtick2;h.editYlimtick2],{'Visible'},{'off'});
    elseif strcmp(get(hObj,'tag'),get(h.ChangeAxLimcheckbox3,'tag'))
        set([h.textXlimmin3;h.editXlimmin3;h.textXlimmax3;h.editXlimmax3;h.textXlimtick3;h.editXlimtick3;h.textYlimmin3;h.editYlimmin3;h.textYlimmax3;h.editYlimmax3;h.textYlimtick3;h.editYlimtick3],{'Visible'},{'off'});
    elseif strcmp(get(hObj,'tag'),get(h.ChangeAxLimcheckbox4,'tag'))
        set([h.textXlimmin4;h.editXlimmin4;h.textXlimmax4;h.editXlimmax4;h.textXlimtick4;h.editXlimtick4;h.textYlimmin4;h.editYlimmin4;h.textYlimmax4;h.editYlimmax4;h.textYlimtick4;h.editYlimtick4],{'Visible'},{'off'});
    end
elseif get(hObj,'Value') == 1
    if strcmp(get(hObj,'tag'),get(h.ChangeAxLimcheckbox1,'tag'))
        set([h.textXlimmin1;h.editXlimmin1;h.textXlimmax1;h.editXlimmax1;h.textXlimtick1;h.editXlimtick1;h.textYlimmin1;h.editYlimmin1;h.textYlimmax1;h.editYlimmax1;h.textYlimtick1;h.editYlimtick1],{'Visible'},{'on'});
    elseif strcmp(get(hObj,'tag'),get(h.ChangeAxLimcheckbox2,'tag'))
        set([h.textXlimmin2;h.editXlimmin2;h.textXlimmax2;h.editXlimmax2;h.textXlimtick2;h.editXlimtick2;h.textYlimmin2;h.editYlimmin2;h.textYlimmax2;h.editYlimmax2;h.textYlimtick2;h.editYlimtick2],{'Visible'},{'on'});
    elseif strcmp(get(hObj,'tag'),get(h.ChangeAxLimcheckbox3,'tag'))
        set([h.textXlimmin3;h.editXlimmin3;h.textXlimmax3;h.editXlimmax3;h.textXlimtick3;h.editXlimtick3;h.textYlimmin3;h.editYlimmin3;h.textYlimmax3;h.editYlimmax3;h.textYlimtick3;h.editYlimtick3],{'Visible'},{'on'});
    elseif strcmp(get(hObj,'tag'),get(h.ChangeAxLimcheckbox4,'tag'))
        set([h.textXlimmin4;h.editXlimmin4;h.textXlimmax4;h.editXlimmax4;h.textXlimtick4;h.editXlimtick4;h.textYlimmin4;h.editYlimmin4;h.textYlimmax4;h.editYlimmax4;h.textYlimtick4;h.editYlimtick4],{'Visible'},{'on'});
    end
end

guidata(hObj, h);

function buttonclearuplotdata(hObj,~)
% Show options to change axes limits
h = guidata(hObj);

% Clear table data
set(h.tableuplotdspacing,'data',[num2cell(zeros(8,3)) num2cell(zeros(8,1)) num2cell(zeros(8,1)) num2cell(true(size(zeros(8,1),1),1))])

% Delete old plots
oldplotssigma11 = findobj(h.axesuplotdatasigma11,'type','ErrorBar');
delete(oldplotssigma11)
oldplotssigma11 = findobj(h.axesuplotdatasigma11,'type','Line');
delete(oldplotssigma11)
oldplotssigma22 = findobj(h.axesuplotdatasigma22,'type','ErrorBar');
delete(oldplotssigma22)
oldplotssigma22 = findobj(h.axesuplotdatasigma22,'type','Line');
delete(oldplotssigma22)
oldplotssigma13 = findobj(h.axesuplotdatasigma13,'type','ErrorBar');
delete(oldplotssigma13)
oldplotssigma13 = findobj(h.axesuplotdatasigma13,'type','Line');
delete(oldplotssigma13)
oldplotssigma23 = findobj(h.axesuplotdatasigma23,'type','ErrorBar');
delete(oldplotssigma23)
oldplotssigma23 = findobj(h.axesuplotdatasigma23,'type','Line');
delete(oldplotssigma23)

% Set axes limits and ticks
xlim(h.axesuplotdatasigma11,'auto')
ylim(h.axesuplotdatasigma11,'auto')
xticks(h.axesuplotdatasigma11,'auto')
yticks(h.axesuplotdatasigma11,'auto')
legend(h.axesuplotdatasigma11,'off')
title(h.axesuplotdatasigma11,{'No measurement data loaded';'     '})

xlim(h.axesuplotdatasigma22,'auto')
ylim(h.axesuplotdatasigma22,'auto')
xticks(h.axesuplotdatasigma22,'auto')
yticks(h.axesuplotdatasigma22,'auto')
legend(h.axesuplotdatasigma22,'off')
title(h.axesuplotdatasigma22,{'No measurement data loaded';'     '})

xlim(h.axesuplotdatasigma13,'auto')
ylim(h.axesuplotdatasigma13,'auto')
xticks(h.axesuplotdatasigma13,'auto')
yticks(h.axesuplotdatasigma13,'auto')
legend(h.axesuplotdatasigma13,'off')
title(h.axesuplotdatasigma13,{'No measurement data loaded';'     '})

xlim(h.axesuplotdatasigma23,'auto')
ylim(h.axesuplotdatasigma23,'auto')
xticks(h.axesuplotdatasigma23,'auto')
yticks(h.axesuplotdatasigma23,'auto')
legend(h.axesuplotdatasigma23,'off')
title(h.axesuplotdatasigma23,{'No measurement data loaded';'     '})

guidata(hObj, h);

function buttonexportuplotdata(hObj,~)
% Export plots and plot data
h = guidata(hObj);

% Get indices of user selected peaks
indkeeppeaks = find(h.userpeaksuplot==1);

% Function to make "Fit" button blink in red during fitting process
col = get(hObj,'backg');  % Get the background color of the figure.
set(hObj,'str','Exporting','backg',[1 .6 .6]) % Change color of button. 
% The pause (or drawnow) is necessary to make button changes appear.
pause(.01)

% Create folder and filename
if strcmp(h.Diffsel,'LEDDI')
    if strcmp(h.Detsel,'Detector 1')
        % Save taudata to file
        FileName = [strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_','Det1'];
    elseif strcmp(h.Detsel,'Detector 2')
        FileName = [strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_','Det2'];
    end
else
    % Save taudata to file
    FileName = [strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name];
end

formatOut = 'ddmmyyyy';
d = datestr(now, formatOut);
% Folder = '\Psi_and_tau_File\';
Folder = '\Plots\UPlot\';

if ~isfield(h,'PathName')
    name = strtrim(h.Measurement(1).MeasurementSeries);
    material = h.P.PopupValueMpd1;
    if strcmp(h.Diffsel,'LEDDI')
        h.PathName = [General.ProgramInfo.Path,'\Data\Results\LEDDI\',[name,'_',material,'_','added_plots','_',d]];
    elseif strcmp(h.Diffsel,'EDDI')
        h.PathName = [General.ProgramInfo.Path,'\Data\Results\EDDI\',[name,'_',material,'_','added_plots','_',d]];
    elseif strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
        h.PathName = [General.ProgramInfo.Path,'\Data\Results\MetalJet\',[name,'_',material,'_','added_plots','_',d]];    
    end
end

Path = fullfile(h.PathName,Folder);
% Path1 = fullfile(h.PathName,Folder1);
        
if exist(Path,'dir') ~= 7
    mkdir(Path);
end

% if exist(Path1,'dir') ~= 7
%     mkdir(Path1);
% end

% Create hkl label
labeltmp = CreateHKLlabel(h);
for k = 1:size(labeltmp,1)
    label{:,k} = labeltmp(k,:);
end
label = label(indkeeppeaks);
% Create file header
for k = 1:size(label,2)
    hkllabelemp1{k} = [['tau','   '],['sigma11(',strrep(label{k},' ', ''),')','    '],['deltasigma11(',strrep(label{k},' ', ''),')','    ']];
    hkllabelemp2{k} = [['tau','   '],['sigma22(',strrep(label{k},' ', ''),')','    '],['deltasigma22(',strrep(label{k},' ', ''),')','    ']];
    hkllabelemp3{k} = [['tau','   '],['sigma13(',strrep(label{k},' ', ''),')','    '],['deltasigma13(',strrep(label{k},' ', ''),')','    ']];
    hkllabelemp4{k} = [['tau','   '],['sigma23(',strrep(label{k},' ', ''),')','    '],['deltasigma23(',strrep(label{k},' ', ''),')','    ']];
end

hkllabel1 = join(hkllabelemp1);
hkllabel2 = join(hkllabelemp2);
hkllabel3 = join(hkllabelemp3);
hkllabel4 = join(hkllabelemp4);

% File format
format = '%.4f    %.6f    %.6f    ';

% File format sigma(tau) and sigma(z)
format1 = '%.4f    %.4f    %.4f';

% Create export data
%% Sigma11
if ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270) || ...
    isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
    isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270) || ...
    isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
    isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
    % Create data for export
    dimssigma11 = max(cell2mat(cellfun(@(x)size(x), h.sigma11tmp, 'uni', 0)'));
    tausigma11export = cellfun(@(x)[x,nan(size(x,1),dimssigma11(1,2)-size(x,2));nan(dimssigma11(1,1)-size(x,1),dimssigma11(1,2))], h.tausigma11tmp(1,:),'uni', 0);
    sigma11export = cellfun(@(x)[x,nan(size(x,1),dimssigma11(1,2)-size(x,2));nan(dimssigma11(1,1)-size(x,1),dimssigma11(1,2))], h.sigma11tmp(1,:),'uni', 0);
    sigma11deltaexport = cellfun(@(x)[x,nan(size(x,1),dimssigma11(1,2)-size(x,2));nan(dimssigma11(1,1)-size(x,1),dimssigma11(1,2))], h.sigma11deltatmp(1,:),'uni', 0);
    % Create matrix for export
    for k = 1:size(tausigma11export,2)
        ExportMatrixsigma11tmp{k} = [tausigma11export{k}; sigma11export{k}; sigma11deltaexport{k}]';
    end
    ExportMatrixsigma11 = cell2mat(ExportMatrixsigma11tmp);
    x = linspace(0.001,100,1001)';
    % Write data to file
    fid = fopen([[Path,'\'],FileName,'_',d,'_','sigma11','.upl'],'w');

    fprintf(fid,'Filename: %s.\n\n',strrep(h.Measurement(1).MeasurementSeries,' ',''));
    fprintf(fid, ['2Theta [Degree]:', ' ', num2str(h.Measurement(1).twotheta),'\n\n']);

    % Print file header
    fprintf(fid, [hkllabel1{1},'\n']);

    % Print data
    for m = 1:size(tausigma11export{1},2)
        str = sprintf([repmat(format,1,size(label,2)),'\n'],...
        ExportMatrixsigma11(m,:));
        str = regexprep(str, 'NaN', '  --  ');
        fprintf(fid, '%s', str);
    end
    % Close file
    fclose(fid);
    % Save data from fittet depth distributions
    if get(h.uplotplotfitscheckbox,'value') == 1
%         [func,funcz,~] = UPlotFitFunctions(h,h.FitDatasigma11,1);
        % Write data to file
        fid = fopen([[Path,'\'],FileName,'_',d,'_','sigma11_tau_z','.upl'],'w');

        fprintf(fid,'Filename: %s.\n\n',strrep(h.Measurement(1).MeasurementSeries,' ',''));
        fprintf(fid, ['2Theta [Degree]:', ' ', num2str(h.Measurement(1).twotheta),'\n\n']);
        fprintf(fid,['Fit function tau: ',strrep(func2str(h.funcsigma11),'@(a,x)',''),'\n\n']);
        fprintf(fid,['Fit function z: ',strrep(func2str(h.funczsigma11),'@(a,x)',''),'\n\n']);
        fprintf(fid,['Fit parameter: \n',num2str(h.Paramssigma11,'%3.4f\n'),'\n\n']);
        
        % Print file header
        fprintf(fid, ['tau,z [µm] ', 'sigma11(tau) ','sigma11(z) ','\n']);

        % Print data
%         for m = 1:size(h.FitDatasigma11,1)
%             str = sprintf([format1,'\n'],...
%             h.FitDatasigma11(m,1),...
%             h.Ypredsigma11(m,1),...
%             h.Ypredsigma11z(m,1));
%             str = regexprep(str, 'NaN', '  --  ');
%             fprintf(fid, '%s', str);
%         end
        assignin('base','Ypredsigma11',h.Ypredsigma11)
        assignin('base','Ypredsigma11z',h.Ypredsigma11z)
        assignin('base','x',x)
        % Print data
        for m = 1:size(x,1)
            str = sprintf([format1,'\n'],...
            x(m,1)',...
            h.Ypredsigma11(1,m),...
            h.Ypredsigma11z(1,m));
            str = regexprep(str, 'NaN', '  --  ');
            fprintf(fid, '%s', str);
        end
        
        fclose(fid);
    end
    
    % Export plot
    figure
    fig = gcf;
    fig.PaperUnits = 'centimeters';
    fig.PaperPositionMode = 'auto';
    fig.PaperPosition = [0 0 18 12];
    ax = gca;
    ax.OuterPosition = [0 0 1.0725 1.025];
    ax.TickDir = 'in';
    ax.Box = 'on';
    ax.XGrid = 'on';
    ax.YGrid = 'on';
    ax.GridLineStyle = '-';
    ax.GridColor = 'k';
    ax.GridAlpha = 0.3;

    ax.XLim = h.axesuplotdatasigma11.XLim; 
    ax.XTick = h.axesuplotdatasigma11.XLim(1):(h.axesuplotdatasigma11.XTick(2)-h.axesuplotdatasigma11.XTick(1)):h.axesuplotdatasigma11.XLim(2);
    
    ax.YLim = h.axesuplotdatasigma11.YLim; 
    ax.YTick = h.axesuplotdatasigma11.YLim(1):(h.axesuplotdatasigma11.YTick(2)-h.axesuplotdatasigma11.YTick(1)):h.axesuplotdatasigma11.YLim(2);

    ylabel('\sigma_{11} [MPa]','FontSize', 20)
    ax.YLabel.FontSize = 24;

    ax.XLabel.String = '<\tau,z> [µm]';
    ax.XLabel.FontSize = 24;
    ax.LabelFontSizeMultiplier = 1.3;
    ax.LineWidth = 1.3;

    set(gca,'FontSize',18)
    hold on
    set(fig, 'Visible', 'off');

    % Plot stress distributions of different stress components
    for k = 1:size(h.UPlot.TauCalc.tau,2)
        sigma11uplotdata(k) = errorbar(h.UPlot.TauCalc.tau{1,k}(h.sin2psirange{1,k}), h.UPlot.sigma11{k}(h.sin2psirange{1,k}), h.UPlot.sigma11delta{k}(h.sin2psirange{1,k}),'Linestyle','none','Color','k','Marker','s','MarkerSize',14,'MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'Clipping','off');
        hold on
    end
    
%     if get(h.uplotplotfitscheckbox,'value') == 1
%         plotsigma11tau = plot(h.FitDatasigma11(:,1), h.Ypredsigma11,'r-','Linewidth',2);
%         hold on
%         plotsigma11z = plot(h.FitDatasigma11(:,1), h.Ypredsigma11z,'k-','Linewidth',2);
%     end
    
    
    if get(h.uplotplotfitscheckbox,'value') == 1
        plotsigma11tau = plot(linspace(0.001,100,1001), h.Ypredsigma11,'r-','Linewidth',2);
        hold on
        plotsigma11z = plot(linspace(0.001,100,1001), h.Ypredsigma11z,'k-','Linewidth',2);
        hold on
        plotsigma11confint = plot(linspace(0.001,100,1001), [h.Ypredsigma11+h.deltasigma11; h.Ypredsigma11-h.deltasigma11],'r:','Linewidth',2);
    end
    
    
    
%     % Create label for legend
%     labeltmp = CreateHKLlabel(h);
%     for k = 1:size(labeltmp,1)
%         label{:,k} = labeltmp(k,:);
%     end
    
    % Distinguish between export of raw data only and fitted data
    if get(h.uplotplotfitscheckbox,'value') == 0
        legstressdata = legend(sigma11uplotdata,label,'FontSize',12);
    else
        legstressdata = legend([sigma11uplotdata,plotsigma11tau,plotsigma11z],[label,'\sigma_{11}(\tau)','\sigma_{11}(z)'],'FontSize',12);
    end

    legstressdata.FontSize = 12;
    % Find best position for legend
    if h.legstressdata.Position(1) < 0.4 && h.legstressdata.Position(2) > 0.4
        legstressdata.Location = 'NorthWest';
    elseif h.legstressdata.Position(1) > 0.4 && h.legstressdata.Position(2) > 0.4
        legstressdata.Location = 'NorthEast';
    elseif h.legstressdata.Position(1) < 0.4 && h.legstressdata.Position(2) < 0.4
        legstressdata.Location = 'SouthWest';
    elseif h.legstressdata.Position(1) > 0.4 && h.legstressdata.Position(2) < 0.4
        legstressdata.Location = 'SouthEast';
    end
    % Set figure title
    title(['UPlot ',strrep(strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',' '), ' ',h.Sample.Materials.Name],'Fontsize', 11)
    if strcmp(h.Diffsel,'LEDDI')
        if strcmp(h.Detsel,'Detector 1')
            % Save data to file
            FileNameUP = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_','Det1_UPlot_sigma11','%d','_',d]);
        elseif strcmp(h.Detsel,'Detector 2')
            FileNameUP = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_','Det2_UPlot_sigma11','%d','_',d]);
        end
    else
        % Save data to file
        FileNameUP = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_UPlot_sigma11','%d','_',d]);
    end
    print(fig,[Path,FileNameUP],'-painters','-dtiff','-r300')
    
end

%% Sigma22
if isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270) || ...
    isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
    isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270) || ...
    isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
    isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
    isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)

    dimssigma22 = max(cell2mat(cellfun(@(x)size(x), h.sigma22tmp, 'uni', 0)'));
    tausigma22export = cellfun(@(x)[x,nan(size(x,1),dimssigma22(1,2)-size(x,2));nan(dimssigma22(1,1)-size(x,1),dimssigma22(1,2))], h.tausigma22tmp(1,:),'uni', 0);
    sigma22export = cellfun(@(x)[x,nan(size(x,1),dimssigma22(1,2)-size(x,2));nan(dimssigma22(1,1)-size(x,1),dimssigma22(1,2))], h.sigma22tmp(1,:),'uni', 0);
    sigma22deltaexport = cellfun(@(x)[x,nan(size(x,1),dimssigma22(1,2)-size(x,2));nan(dimssigma22(1,1)-size(x,1),dimssigma22(1,2))], h.sigma22deltatmp(1,:),'uni', 0);

    for k = 1:size(tausigma22export,2)
        ExportMatrixsigma22tmp{k} = [tausigma22export{k}; sigma22export{k}; sigma22deltaexport{k}]';
    end
    ExportMatrixsigma22 = cell2mat(ExportMatrixsigma22tmp);

    % Write data to file
    fid = fopen([[Path,'\'],FileName,'_',d,'_','sigma22','.upl'],'w');

    fprintf(fid,'Filename: %s.\n\n',strrep(h.Measurement(1).MeasurementSeries,' ',''));
    fprintf(fid, ['2Theta [Degree]:', ' ', num2str(h.Measurement(1).twotheta),'\n\n']);

    % Print file header
    fprintf(fid, [hkllabel2{1},'\n']);

    % Print data
    for m = 1:size(tausigma22export{1},2)
        str = sprintf([repmat(format,1,size(label,2)),'\n'],...
        ExportMatrixsigma22(m,:));
        str = regexprep(str, 'NaN', '  --  ');
        fprintf(fid, '%s', str);
    end

    fclose(fid);
    
    if get(h.uplotplotfitscheckbox,'value') == 1
%         [func,funcz,~] = UPlotFitFunctions(h,h.FitDatasigma22,2);
        % Write data to file
        fid = fopen([[Path,'\'],FileName,'_',d,'_','sigma22_tau_z','.upl'],'w');

        fprintf(fid,'Filename: %s.\n\n',strrep(h.Measurement(1).MeasurementSeries,' ',''));
        fprintf(fid, ['2Theta [Degree]:', ' ', num2str(h.Measurement(1).twotheta),'\n\n']);
        fprintf(fid,['Fit function tau: ',strrep(func2str(h.funcsigma22),'@(a,x)',''),'\n\n']);
        fprintf(fid,['Fit function z: ',strrep(func2str(h.funczsigma22),'@(a,x)',''),'\n\n']);
        fprintf(fid,['Fit parameter: \n',num2str(h.Paramssigma22,'%3.4f\n'),'\n\n']);
        
        % Print file header
        fprintf(fid, ['tau,z [µm] ', 'sigma22(tau) ','sigma22(z) ','\n']);

        % Print data
        for m = 1:size(h.FitDatasigma11,1)
            str = sprintf([format1,'\n'],...
            h.FitDatasigma22(m,1),...
            h.Ypredsigma22(m,1),...
            h.Ypredsigma22z(m,1));
            str = regexprep(str, 'NaN', '  --  ');
            fprintf(fid, '%s', str);
        end
        
        fclose(fid);
    end
    
    % Export plot
    figure
    fig = gcf;
    fig.PaperUnits = 'centimeters';
    fig.PaperPositionMode = 'auto';
    fig.PaperPosition = [0 0 18 12];
    ax = gca;
    ax.OuterPosition = [0 0 1.0725 1.025];
    ax.TickDir = 'in';
    ax.Box = 'on';
    ax.XGrid = 'on';
    ax.YGrid = 'on';
    ax.GridLineStyle = '-';
    ax.GridColor = 'k';
    ax.GridAlpha = 0.3;

    ax.XLim = h.axesuplotdatasigma22.XLim; 
    ax.XTick = h.axesuplotdatasigma22.XLim(1):(h.axesuplotdatasigma22.XTick(2)-h.axesuplotdatasigma22.XTick(1)):h.axesuplotdatasigma22.XLim(2);
    
    ax.YLim = h.axesuplotdatasigma22.YLim; 
    ax.YTick = h.axesuplotdatasigma22.YLim(1):(h.axesuplotdatasigma22.YTick(2)-h.axesuplotdatasigma22.YTick(1)):h.axesuplotdatasigma22.YLim(2);

    ylabel('\sigma_{22} [MPa]','FontSize', 20)
    ax.YLabel.FontSize = 24;

    ax.XLabel.String = '<\tau,z> [µm]';
    ax.XLabel.FontSize = 24;
    ax.LabelFontSizeMultiplier = 1.3;
    ax.LineWidth = 1.3;

    set(gca,'FontSize',18)
    hold on
    set(fig, 'Visible', 'off');

    % Plot stress distributions of different stress compontens
    for k = 1:size(h.UPlot.TauCalc.tau,2)
        sigma22uplotdata(k) = errorbar(h.UPlot.TauCalc.tau{2,k}(h.sin2psirange{2,k}), h.UPlot.sigma22{k}(h.sin2psirange{2,k}), h.UPlot.sigma22delta{k}(h.sin2psirange{2,k}),'Linestyle','none','Color','k','Marker','s','MarkerSize',14,'MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'Clipping','off');
        hold on
    end
    if get(h.uplotplotfitscheckbox,'value') == 1
        plotsigma22tau = plot(h.FitDatasigma22(:,1), h.Ypredsigma22,'r-','Linewidth',2);
        hold on
        plotsigma22z = plot(h.FitDatasigma22(:,1), h.Ypredsigma22z,'k-','Linewidth',2);
    end
%     labeltmp = CreateHKLlabel(h);
%     for k = 1:size(labeltmp,1)
%         label{:,k} = labeltmp(k,:);
%     end
    
    if get(h.uplotplotfitscheckbox,'value') == 0
        legstressdata = legend(sigma22uplotdata,label,'FontSize',12);
    else
        legstressdata = legend([sigma22uplotdata,plotsigma22tau,plotsigma22z],[label,'\sigma_{22}(\tau)','\sigma_{22}(z)'],'FontSize',12);
    end

    legstressdata.FontSize = 12;

    if h.legstressdata.Position(1) < 0.4 && h.legstressdata.Position(2) > 0.4
        legstressdata.Location = 'NorthWest';
    elseif h.legstressdata.Position(1) > 0.4 && h.legstressdata.Position(2) > 0.4
        legstressdata.Location = 'NorthEast';
    elseif h.legstressdata.Position(1) < 0.4 && h.legstressdata.Position(2) < 0.4
        legstressdata.Location = 'SouthWest';
    elseif h.legstressdata.Position(1) > 0.4 && h.legstressdata.Position(2) < 0.4
        legstressdata.Location = 'SouthEast';
    end

    title(['UPlot ',strrep(strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',' '), ' ',h.Sample.Materials.Name],'Fontsize', 11)
    if strcmp(h.Diffsel,'LEDDI')
        if strcmp(h.Detsel,'Detector 1')
            % Save taudata to file
            FileNameUP = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_','Det1_UPlot_sigma22','%d','_',d]);
        elseif strcmp(h.Detsel,'Detector 2')
            FileNameUP = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_','Det2_UPlot_sigma22','%d','_',d]);
        end
    else
        % Save taudata to file
        FileNameUP = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_UPlot_sigma22','%d','_',d]);
    end
    print(fig,[Path,FileNameUP],'-painters','-dtiff','-r300')
end   
    
 %% Sigma13
if ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)  

    dimssigma13 = max(cell2mat(cellfun(@(x)size(x), h.sigma13tmp, 'uni', 0)'));
    tausigma13export = cellfun(@(x)[x,nan(size(x,1),dimssigma13(1,2)-size(x,2));nan(dimssigma13(1,1)-size(x,1),dimssigma13(1,2))], h.tausigma13tmp(1,:),'uni', 0);
    sigma13export = cellfun(@(x)[x,nan(size(x,1),dimssigma13(1,2)-size(x,2));nan(dimssigma13(1,1)-size(x,1),dimssigma13(1,2))], h.sigma13tmp(1,:),'uni', 0);
    sigma13deltaexport = cellfun(@(x)[x,nan(size(x,1),dimssigma13(1,2)-size(x,2));nan(dimssigma13(1,1)-size(x,1),dimssigma13(1,2))], h.sigma13deltatmp(1,:),'uni', 0);

    for k = 1:size(tausigma13export,2)
        ExportMatrixsigma13tmp{k} = [tausigma13export{k}; sigma13export{k}; sigma13deltaexport{k}]';
    end
    ExportMatrixsigma13 = cell2mat(ExportMatrixsigma13tmp);
    
    % Write data to file
    fid = fopen([[Path,'\'],FileName,'_',d,'_','sigma13','.upl'],'w');

    fprintf(fid,'Filename: %s.\n\n',strrep(h.Measurement(1).MeasurementSeries,' ',''));
    fprintf(fid, ['2Theta [Degree]:', ' ', num2str(h.Measurement(1).twotheta),'\n\n']);

    % Print file header
    fprintf(fid, [hkllabel3{1},'\n']);

    % Print data
    for m = 1:size(tausigma13export{1},2)
        str = sprintf([repmat(format,1,size(label,2)),'\n'],...
        ExportMatrixsigma13(m,:));
        str = regexprep(str, 'NaN', '  --  ');
        fprintf(fid, '%s', str);
    end

    fclose(fid);
    
    if get(h.uplotplotfitscheckbox,'value') == 1
%         [func,funcz,~] = UPlotFitFunctions(h,h.FitDatasigma13,3);
        % Write data to file
        fid = fopen([[Path,'\'],FileName,'_',d,'_','sigma13_tau_z','.upl'],'w');

        fprintf(fid,'Filename: %s.\n\n',strrep(h.Measurement(1).MeasurementSeries,' ',''));
        fprintf(fid, ['2Theta [Degree]:', ' ', num2str(h.Measurement(1).twotheta),'\n\n']);
        fprintf(fid,['Fit function tau: ',strrep(func2str(h.funcsigma13),'@(a,x)',''),'\n\n']);
        fprintf(fid,['Fit function z: ',strrep(func2str(h.funczsigma13),'@(a,x)',''),'\n\n']);
        fprintf(fid,['Fit parameter: \n',num2str(h.Paramssigma13,'%3.4f\n'),'\n\n']);

        % Print file header
        fprintf(fid, ['tau,z [µm]   ', 'sigma13(tau) ','sigma13(z) ','\n']);

        % Print data
        for m = 1:size(h.FitDatasigma13,1)
            str = sprintf([format1,'\n'],...
            h.FitDatasigma13(m,1),...
            h.Ypredsigma13(m,1),...
            h.Ypredsigma13z(m,1));
            str = regexprep(str, 'NaN', '  --  ');
            fprintf(fid, '%s', str);
        end
        
        fclose(fid);
    end
    
    % Export plot
    figure
    fig = gcf;
    fig.PaperUnits = 'centimeters';
    fig.PaperPositionMode = 'auto';
    fig.PaperPosition = [0 0 18 12];
    ax = gca;
    ax.OuterPosition = [0 0 1.0725 1.025];
    ax.TickDir = 'in';
    ax.Box = 'on';
    ax.XGrid = 'on';
    ax.YGrid = 'on';
    ax.GridLineStyle = '-';
    ax.GridColor = 'k';
    ax.GridAlpha = 0.3;

    ax.XLim = h.axesuplotdatasigma13.XLim; 
    ax.XTick = h.axesuplotdatasigma13.XLim(1):(h.axesuplotdatasigma13.XTick(2)-h.axesuplotdatasigma13.XTick(1)):h.axesuplotdatasigma13.XLim(2);
    
    ax.YLim = h.axesuplotdatasigma13.YLim; 
    ax.YTick = h.axesuplotdatasigma13.YLim(1):(h.axesuplotdatasigma13.YTick(2)-h.axesuplotdatasigma13.YTick(1)):h.axesuplotdatasigma13.YLim(2);

    ylabel('\sigma_{13} [MPa]','FontSize', 20)
    ax.YLabel.FontSize = 24;

    ax.XLabel.String = '<\tau,z> [µm]';
    ax.XLabel.FontSize = 24;
    ax.LabelFontSizeMultiplier = 1.3;
    ax.LineWidth = 1.3;

    set(gca,'FontSize',18)
    hold on
    set(fig, 'Visible', 'off');

    % Plot stress distributions of different stress compontens
    for k = 1:size(h.UPlot.TauCalc.tau,2)
        sigma13uplotdata(k) = errorbar(h.UPlot.TauCalc.tau{3,k}(h.sin2psirange{3,k}), h.UPlot.sigma13{k}(h.sin2psirange{3,k}), h.UPlot.sigma13delta{k}(h.sin2psirange{3,k}),'Linestyle','none','Color','k','Marker','s','MarkerSize',14,'MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'Clipping','off');
        hold on
    end
    
    if get(h.uplotplotfitscheckbox,'value') == 1
        plotsigma13tau = plot(h.FitDatasigma13(:,1), h.Ypredsigma13,'r-','Linewidth',2);
        hold on
        plotsigma13z = plot(h.FitDatasigma13(:,1), h.Ypredsigma13z,'k-','Linewidth',2);
    end
    
%     labeltmp = CreateHKLlabel(h);
%     for k = 1:size(labeltmp,1)
%         label{:,k} = labeltmp(k,:);
%     end

    if get(h.uplotplotfitscheckbox,'value') == 0
        legstressdata = legend(sigma13uplotdata,label,'FontSize',12);
    else
        legstressdata = legend([sigma13uplotdata,plotsigma13tau,plotsigma13z],[label,'\sigma_{13}(\tau)','\sigma_{13}(z)'],'FontSize',12);
    end

    legstressdata.FontSize = 12;

    if h.legstressdata.Position(1) < 0.4 && h.legstressdata.Position(2) > 0.4
        legstressdata.Location = 'NorthWest';
    elseif h.legstressdata.Position(1) > 0.4 && h.legstressdata.Position(2) > 0.4
        legstressdata.Location = 'NorthEast';
    elseif h.legstressdata.Position(1) < 0.4 && h.legstressdata.Position(2) < 0.4
        legstressdata.Location = 'SouthWest';
    elseif h.legstressdata.Position(1) > 0.4 && h.legstressdata.Position(2) < 0.4
        legstressdata.Location = 'SouthEast';
    end

    title(['UPlot ',strrep(strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',' '), ' ',h.Sample.Materials.Name],'Fontsize', 11)
    if strcmp(h.Diffsel,'LEDDI')
        if strcmp(h.Detsel,'Detector 1')
            % Save taudata to file
            FileNameUP = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_','Det1_UPlot_sigma13','%d','_',d]);
        elseif strcmp(h.Detsel,'Detector 2')
            FileNameUP = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_','Det2_UPlot_sigma13','%d','_',d]);
        end
    else
        % Save taudata to file
        FileNameUP = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_UPlot_sigma13','%d','_',d]);
    end
    print(fig,[Path,FileNameUP],'-painters','-dtiff','-r300')
end

%% Sigma23
if isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
    isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
    ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)

    dimssigma23 = max(cell2mat(cellfun(@(x)size(x), h.sigma23tmp, 'uni', 0)'));
    tausigma23export = cellfun(@(x)[x,nan(size(x,1),dimssigma23(1,2)-size(x,2));nan(dimssigma23(1,1)-size(x,1),dimssigma23(1,2))], h.tausigma23tmp(1,:),'uni', 0);
    sigma23export = cellfun(@(x)[x,nan(size(x,1),dimssigma23(1,2)-size(x,2));nan(dimssigma23(1,1)-size(x,1),dimssigma23(1,2))], h.sigma23tmp(1,:),'uni', 0);
    sigma23deltaexport = cellfun(@(x)[x,nan(size(x,1),dimssigma23(1,2)-size(x,2));nan(dimssigma23(1,1)-size(x,1),dimssigma23(1,2))], h.sigma23deltatmp(1,:),'uni', 0);

    for k = 1:size(tausigma23export,2)
        ExportMatrixsigma23tmp{k} = [tausigma23export{k}; sigma23export{k}; sigma23deltaexport{k}]';
    end
    ExportMatrixsigma23 = cell2mat(ExportMatrixsigma23tmp);
    
    % Write data to file
    fid = fopen([[Path,'\'],FileName,'_',d,'_','sigma23','.upl'],'w');

    fprintf(fid,'Filename: %s.\n\n',strrep(h.Measurement(1).MeasurementSeries,' ',''));
    fprintf(fid, ['2Theta [Degree]:', ' ', num2str(h.Measurement(1).twotheta),'\n\n']);

    % Print file header
    fprintf(fid, [hkllabel4{1},'\n']);

    % Print data
    for m = 1:size(tausigma23export{1},2)
        str = sprintf([repmat(format,1,size(label,2)),'\n'],...
        ExportMatrixsigma23(m,:));
        str = regexprep(str, 'NaN', '  --  ');
        fprintf(fid, '%s', str);
    end

    fclose(fid);
    
    if get(h.uplotplotfitscheckbox,'value') == 1
%         [func,funcz,~] = UPlotFitFunctions(h,h.FitDatasigma23,4);
        % Write data to file
        fid = fopen([[Path,'\'],FileName,'_',d,'_','sigma23_tau_z','.upl'],'w');

        fprintf(fid,'Filename: %s.\n\n',strrep(h.Measurement(1).MeasurementSeries,' ',''));
        fprintf(fid, ['2Theta [Degree]:', ' ', num2str(h.Measurement(1).twotheta),'\n\n']);
        fprintf(fid,['Fit function tau: ',strrep(func2str(h.funcsigma23),'@(a,x)',''),'\n\n']);
        fprintf(fid,['Fit function z: ',strrep(func2str(h.funczsigma23),'@(a,x)',''),'\n\n']);
        fprintf(fid,['Fit parameter: \n',num2str(h.Paramssigma23,'%3.4f\n'),'\n\n']);
        
        % Print file header
        fprintf(fid, ['tau,z [µm]   ', 'sigma23(tau) ','sigma23(z) ','\n']);

        % Print data
        for m = 1:size(h.FitDatasigma23,1)
            str = sprintf([format1,'\n'],...
            h.FitDatasigma23(m,1),...
            h.Ypredsigma23(m,1),...
            h.Ypredsigma23z(m,1));
            str = regexprep(str, 'NaN', '  --  ');
            fprintf(fid, '%s', str);
        end
        
        fclose(fid);
    end
    
    % Export plot
    figure
    fig = gcf;
    fig.PaperUnits = 'centimeters';
    fig.PaperPositionMode = 'auto';
    fig.PaperPosition = [0 0 18 12];
    ax = gca;
    ax.OuterPosition = [0 0 1.0725 1.025];
    ax.TickDir = 'in';
    ax.Box = 'on';
    ax.XGrid = 'on';
    ax.YGrid = 'on';
    ax.GridLineStyle = '-';
    ax.GridColor = 'k';
    ax.GridAlpha = 0.3;

    ax.XLim = h.axesuplotdatasigma23.XLim; 
    ax.XTick = h.axesuplotdatasigma23.XLim(1):(h.axesuplotdatasigma23.XTick(2)-h.axesuplotdatasigma23.XTick(1)):h.axesuplotdatasigma23.XLim(2);
    
    ax.YLim = h.axesuplotdatasigma23.YLim; 
    ax.YTick = h.axesuplotdatasigma23.YLim(1):(h.axesuplotdatasigma23.YTick(2)-h.axesuplotdatasigma23.YTick(1)):h.axesuplotdatasigma23.YLim(2);

    ylabel('\sigma_{23} [MPa]','FontSize', 20)
    ax.YLabel.FontSize = 24;

    ax.XLabel.String = '<\tau,z> [µm]';
    ax.XLabel.FontSize = 24;
    ax.LabelFontSizeMultiplier = 1.3;
    ax.LineWidth = 1.3;

    set(gca,'FontSize',18)
    hold on
    set(fig, 'Visible', 'off');

    % Plot stress distributions of different stress compontens
    for k = 1:size(h.UPlot.TauCalc.tau,2)
        sigma23uplotdata(k) = errorbar(h.UPlot.TauCalc.tau{4,k}(h.sin2psirange{4,k}), h.UPlot.sigma23{k}(h.sin2psirange{4,k}), h.UPlot.sigma23delta{k}(h.sin2psirange{4,k}),'Linestyle','none','Color','k','Marker','s','MarkerSize',14,'MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor',h.ColorsUsedSorted{k},'Clipping','off');
        hold on
    end
    
    if get(h.uplotplotfitscheckbox,'value') == 1
        plotsigma23tau = plot(h.FitDatasigma23(:,1), h.Ypredsigma23,'r-','Linewidth',2);
        hold on
        plotsigma23z = plot(h.FitDatasigma23(:,1), h.Ypredsigma23z,'k-','Linewidth',2);
    end
    
%     labeltmp = CreateHKLlabel(h);
%     for k = 1:size(labeltmp,1)
%         label{:,k} = labeltmp(k,:);
%     end

    if get(h.uplotplotfitscheckbox,'value') == 0
        legstressdata = legend(sigma23uplotdata,label,'FontSize',12);
    else
        legstressdata = legend([sigma23uplotdata,plotsigma23tau,plotsigma23z],[label,'\sigma_{23}(\tau)','\sigma_{23}(z)'],'FontSize',12);
    end

    legstressdata.FontSize = 12;

    if h.legstressdata.Position(1) < 0.4 && h.legstressdata.Position(2) > 0.4
        legstressdata.Location = 'NorthWest';
    elseif h.legstressdata.Position(1) > 0.4 && h.legstressdata.Position(2) > 0.4
        legstressdata.Location = 'NorthEast';
    elseif h.legstressdata.Position(1) < 0.4 && h.legstressdata.Position(2) < 0.4
        legstressdata.Location = 'SouthWest';
    elseif h.legstressdata.Position(1) > 0.4 && h.legstressdata.Position(2) < 0.4
        legstressdata.Location = 'SouthEast';
    end

    title(['UPlot ',strrep(strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',' '), ' ',h.Sample.Materials.Name],'Fontsize', 11)
    if strcmp(h.Diffsel,'LEDDI')
        if strcmp(h.Detsel,'Detector 1')
            % Save taudata to file
            FileNameUP = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_','Det1_UPlot_sigma23','%d','_',d]);
        elseif strcmp(h.Detsel,'Detector 2')
            FileNameUP = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_','Det2_UPlot_sigma23','%d','_',d]);
        end
    else
        % Save taudata to file
        FileNameUP = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_UPlot_sigma23','%d','_',d]);
    end
    print(fig,[Path,FileNameUP],'-painters','-dtiff','-r300')
end

% Reset the button color
set(hObj,'str','Export data','backg',col)  % Now reset the button features.

guidata(hObj, h);

function buttonplotdsin2psi(hObj,~)
% Callback for "Load data" pushbutton in universal plot tab
h = guidata(hObj);

% Get indices of user defined peaks
indkeeppeaks = find(h.userpeaksuplot==1);
% assignin('base','sin2psi',h.sin2psi)
if get(h.uplotplotfitscheckbox,'value') == 0
    warndlg('Please fit data first.','Warning')
else
    DEKdatatmp = get(h.loadDEKtable,'data');
    % assignin('base','tauplot',h.UPlot.TauCalc.tau)
    % assignin('base','sin2psiplot',h.UPlot.sin2psi)
    % assignin('base','DEKdatatmp',DEKdatatmp)
    if ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270) || ...
        isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270) || ...
        ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270) || ...
        ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270) || ...
        ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
        isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270) || ...
        isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
        ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270) || ...
        ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
        ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
        isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
        ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
        for k = 1:size(indkeeppeaks,1)
            drecalcphi0{k} = (DEKdatatmp(indkeeppeaks(k),5).*(h.funcsigma11(h.Paramssigma11,h.UPlot.TauCalc.tauorg{k}').*(sind((0:1:89)).^2)'+h.funcsigma13(h.Paramssigma13,h.UPlot.TauCalc.tauorg{k}').*2.*sqrt((sind((0:1:89)).^2)'.*(1-(sind((0:1:89)).^2)'))) + ...
                DEKdatatmp(indkeeppeaks(k),4).*(h.funcsigma11(h.Paramssigma11,h.UPlot.TauCalc.tauorg{k}')+h.funcsigma22(h.Paramssigma22,h.UPlot.TauCalc.tauorg{k}'))).*h.dzerofit(k)+h.dzerofit(k);
        end
    end

    if isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270) || ...
        isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
        ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270) || ...
        ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
        isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270) || ...
        isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
        isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
        ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270) || ...
        ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
        ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
        isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
        ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
        for k = 1:size(indkeeppeaks,1)
            drecalcphi90{k} = (DEKdatatmp(indkeeppeaks(k),5).*(h.funcsigma22(h.Paramssigma22,h.UPlot.TauCalc.tauorg{k}').*(sind((0:1:89)).^2)'+h.funcsigma23(h.Paramssigma23,h.UPlot.TauCalc.tauorg{k}').*2.*sqrt((sind((0:1:89)).^2)'.*(1-(sind((0:1:89)).^2)'))) + ...
                DEKdatatmp(indkeeppeaks(k),4).*(h.funcsigma11(h.Paramssigma11,h.UPlot.TauCalc.tauorg{k}')+h.funcsigma22(h.Paramssigma22,h.UPlot.TauCalc.tauorg{k}'))).*h.dzerofit(k)+h.dzerofit(k);
        end
    end

    if ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270) || ...
        ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270) || ...
        ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
        ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
        for k = 1:size(indkeeppeaks,1)
            drecalcphi180{k} = (DEKdatatmp(indkeeppeaks(k),5).*(h.funcsigma11(h.Paramssigma11,h.UPlot.TauCalc.tauorg{k}').*(sind((0:1:89)).^2)'-h.funcsigma13(h.Paramssigma13,h.UPlot.TauCalc.tauorg{k}').*2.*sqrt((sind((0:1:89)).^2)'.*(1-(sind((0:1:89)).^2)'))) + ...
                DEKdatatmp(indkeeppeaks(k),4).*(h.funcsigma11(h.Paramssigma11,h.UPlot.TauCalc.tauorg{k}')+h.funcsigma22(h.Paramssigma22,h.UPlot.TauCalc.tauorg{k}'))).*h.dzerofit(k)+h.dzerofit(k);
        end
    end

    if isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
        ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
        isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270) || ...
        ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
        for k = 1:size(indkeeppeaks,1)
            drecalcphi270{k} = (DEKdatatmp(indkeeppeaks(k),5).*(h.funcsigma22(h.Paramssigma22,h.UPlot.TauCalc.tauorg{k}').*(sind((0:1:89)).^2)'-h.funcsigma23(h.Paramssigma23,h.UPlot.TauCalc.tauorg{k}').*2.*sqrt((sind((0:1:89)).^2)'.*(1-(sind((0:1:89)).^2)'))) + ...
                DEKdatatmp(indkeeppeaks(k),4).*(h.funcsigma11(h.Paramssigma11,h.UPlot.TauCalc.tauorg{k}')+h.funcsigma22(h.Paramssigma22,h.UPlot.TauCalc.tauorg{k}'))).*h.dzerofit(k)+h.dzerofit(k);
        end
    end
    
    % Plot Results
    if size(indkeeppeaks,1) <= 9
        figure('Name','d-sin²psi distributions','NumberTitle','off','Menubar','none','Toolbar','none','Units','normalized','Position', [0.25 0.25 0.5 0.6]);
    else
        figure('Name','d-sin²psi distributions','NumberTitle','off','Menubar','none','Toolbar','none','Units','normalized','Position', [0.1 0.1 0.8 0.8]);
    end

    for k = 1:size(indkeeppeaks,1)
        if size(indkeeppeaks,1) <= 9
            subplot(3,3,k);
            ax = subplot(3,3,k);
            ax.Position(3) = ax.Position(3)+0.05;
            ax.Position(4) = ax.Position(4)+0.025;
            % Change position of subplots in order to fit the figure
            if k == 1 || k == 4 || k == 7
                ax.Position(1) = ax.Position(1)-0.06;
            end
            if k == 2 || k == 5 || k == 8
                ax.Position(1) = ax.Position(1)-0.015;    
            end
            if k == 3 || k == 6 || k == 9
                ax.Position(1) = ax.Position(1)+0.03;
            end
            if k == 1 || k == 2 || k == 3
                ax.Position(2) = ax.Position(2)+0.01;
            end
            if k == 4 || k == 5 || k == 6
                ax.Position(2) = ax.Position(2)-0.02;
            end
            if k == 7 || k == 8 || k == 9
                ax.Position(2) = ax.Position(2)-0.05;
            end
        else
            subplot(4,4,k);
            ax = subplot(4,4,k);
            ax.Position(3) = ax.Position(3)+0.05;
            ax.Position(4) = ax.Position(4)+0.025;
%             % Change position of subplots in order to fit the figure
            if k == 1 || k == 5 || k == 9 || k == 13
                ax.Position(1) = ax.Position(1)-0.09;
            end
            if k == 2 || k == 6 || k == 10 || k == 14
                ax.Position(1) = ax.Position(1)-0.05;    
            end
            if k == 3 || k == 7 || k == 11 || k == 15
                ax.Position(1) = ax.Position(1)-0.005;
            end
            if k == 4 || k == 8 || k == 12 || k == 16
                ax.Position(1) = ax.Position(1)+0.04;
            end
            if k == 1 || k == 2 || k == 3 || k == 4
                ax.Position(2) = ax.Position(2)+0.02;
            end
            if k == 5 || k == 6 || k == 7 || k == 8
                ax.Position(2) = ax.Position(2)-0.01;
            end
            if k == 9 || k == 10 || k == 11 || k == 12
                ax.Position(2) = ax.Position(2)-0.04;
            end
            if k == 13 || k == 14 || k == 15 || k == 16
                ax.Position(2) = ax.Position(2)-0.07;
            end
        end
        % Create plots
        if size(h.ParamsToFit,2) == 1
            % Phi = 0 or 90 or 180 or 270
            if ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
                drecalcphi = drecalcphi0;
            elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
                drecalcphi = drecalcphi90;
            elseif isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
                drecalcphi = drecalcphi180;    
            elseif isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
                drecalcphi = drecalcphi270;        
            end

            recalcdspacing(:,k) = plot(sind(h.ParamsToFit(1).Psi_Winkel{1,k}).^2,h.ParamsToFit(1).LatticeSpacing{1,k},'s',...
                (sind((0:1:89)).^2)',drecalcphi{k},'-','MarkerSize',9,'LineWidth',1.25,'Color',h.ColorsUsedSorted{k},'MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor','k','Clipping','off');

        elseif size(h.ParamsToFit,2) == 2
            % Phi = 0/90 or 0/180 or 0/270 or 90/180 or 90/270 or 180/270
            if ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
                drecalcphi1 = drecalcphi0;
                drecalcphi2 = drecalcphi90;
            elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
                drecalcphi1 = drecalcphi0;
                drecalcphi2 = drecalcphi180;
            elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
                drecalcphi1 = drecalcphi0;
                drecalcphi2 = drecalcphi270;    
            elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
                drecalcphi1 = drecalcphi90;
                drecalcphi2 = drecalcphi180;
            elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
                drecalcphi1 = drecalcphi90;
                drecalcphi2 = drecalcphi270; 
            elseif isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
                drecalcphi1 = drecalcphi180;
                drecalcphi2 = drecalcphi270;     
            end

            recalcdspacing(:,k) = plot(sind(h.ParamsToFit(1).Psi_Winkel{1,k}).^2,h.ParamsToFit(1).LatticeSpacing{1,k},'s',...
                sind(h.ParamsToFit(2).Psi_Winkel{1,k}).^2,h.ParamsToFit(2).LatticeSpacing{1,k},'o',...
                (sind((0:1:89)).^2)',drecalcphi1{k},'-',(sind((0:1:89)).^2)',drecalcphi2{k},'-','MarkerSize',9,'LineWidth',1.25,'Color',h.ColorsUsedSorted{k},'MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor','k','Clipping','off');

        elseif size(h.ParamsToFit,2) == 3
            % Phi = 0/90/180 or 0/180/270 or 0/90/270 or 90/180/270
            if ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
                drecalcphi1 = drecalcphi0;
                drecalcphi2 = drecalcphi90;
                drecalcphi3 = drecalcphi180;
            elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
                drecalcphi1 = drecalcphi0;
                drecalcphi2 = drecalcphi90;
                drecalcphi3 = drecalcphi270;
            elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
                drecalcphi1 = drecalcphi0;
                drecalcphi2 = drecalcphi180;
                drecalcphi3 = drecalcphi270;
            elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
                drecalcphi1 = drecalcphi90;
                drecalcphi2 = drecalcphi180;
                drecalcphi3 = drecalcphi270; 
            end

            recalcdspacing(:,k) = plot(sind(h.ParamsToFit(1).Psi_Winkel{1,k}).^2,h.ParamsToFit(1).LatticeSpacing{1,k},'s',...
                sind(h.ParamsToFit(2).Psi_Winkel{1,k}).^2,h.ParamsToFit(2).LatticeSpacing{1,k},'o',...
                sind(h.ParamsToFit(3).Psi_Winkel{1,k}).^2,h.ParamsToFit(3).LatticeSpacing{1,k},'d',...
                (sind((0:1:89)).^2)',drecalcphi1{k},'-',(sind((0:1:89)).^2)',drecalcphi2{k},'-',(sind((0:1:89)).^2)',drecalcphi3{k},'-','MarkerSize',9,'LineWidth',1.25,'Color',h.ColorsUsedSorted{k},'MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor','k','Clipping','off');

        elseif size(h.ParamsToFit,2) == 4
            % Phi = 0/90/180/270
            recalcdspacing(:,k) = plot(sind(h.ParamsToFit(1).Psi_Winkel{1,k}).^2,h.ParamsToFit(1).LatticeSpacing{1,k},'s',...
                sind(h.ParamsToFit(2).Psi_Winkel{1,k}).^2,h.ParamsToFit(2).LatticeSpacing{1,k},'o',...
                sind(h.ParamsToFit(3).Psi_Winkel{1,k}).^2,h.ParamsToFit(3).LatticeSpacing{1,k},'d',...
                sind(h.ParamsToFit(4).Psi_Winkel{1,k}).^2,h.ParamsToFit(4).LatticeSpacing{1,k},'p',...
                (sind((0:1:89)).^2)',drecalcphi0{k},'-',(sind((0:1:89)).^2)',drecalcphi90{k},'-',(sind((0:1:89)).^2)',drecalcphi180{k},'-',(sind((0:1:89)).^2)',drecalcphi270{k},'-','MarkerSize',9,'LineWidth',1.25,'Color',h.ColorsUsedSorted{k},'MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor','k','Clipping','off');
        end
        % Plot properties
        xlabel('sin^{2}\psi')
        ylabel('d [nm]')
        grid('on')
        xlim('auto')
        [YLim,YTick] = Ylimdspacing(h,k);
        ax.YLim = [YLim(1)/10, YLim(2)/10];
        ax.YTick = YTick./10;
        title(['d(',strrep(num2str(DEKdatatmp(k,1:3)),' ',''),') vs. sin^{2}\psi'])
        if size(h.ParamsToFit,2) == 1
            legend(['\phi = ',num2str(h.ParamsToFit(1).Phi_Winkel{1}(1)),'°'])
        elseif size(h.ParamsToFit,2) == 2
            legend(['\phi = ',num2str(h.ParamsToFit(1).Phi_Winkel{1}(1)),'°'],['\phi = ',num2str(h.ParamsToFit(2).Phi_Winkel{1}(1)),'°'])
        elseif size(h.ParamsToFit,2) == 3
            legend(['\phi = ',num2str(h.ParamsToFit(1).Phi_Winkel{1}(1)),'°'],['\phi = ',num2str(h.ParamsToFit(2).Phi_Winkel{1}(1)),'°'],['\phi = ',num2str(h.ParamsToFit(3).Phi_Winkel{1}(1)),'°'])
        elseif size(h.ParamsToFit,2) == 4
            legend('\phi = 0°','\phi = 90°','\phi = 180°','\phi = 270°')
        end
    end

    if get(h.exportrecalcdcheckbox,'value') == 1

        for k = 1:size(h.Params.Phi_Winkel,2)
            [PhiWinkel{k},ia{k},~] = unique(h.Params.Phi_Winkel{k});
        end

        for k = 1:size(indkeeppeaks,1)
            figure
            fig = gcf;
            fig.PaperUnits = 'centimeters';
            fig.PaperPosition = [0 0 18 12];
            ax = gca;
            ax.OuterPosition = [0 0 1.085 1.025];
            ax.TickDir = 'out';
            ax.YAxis.TickLabelFormat = '%.4f';
            ax.Box = 'on';
            ax.XGrid = 'on';
            ax.YGrid = 'on';
            ax.GridLineStyle = '-';
            ax.GridColor = 'k';
            ax.GridAlpha = 0.3;
            ax.XLim = [0 1];
            % Set axes limits for lattice spacings
            [YLim,YTick] = Ylimdspacing(h,k);
            ax.YLim = [YLim(1), YLim(2)];
            ax.YTick = YTick;
            ax.YLabel.String = ['d [',char(197),']'];
            ax.YLabel.FontSize = 24;
            ax.XLabel.String = 'sin²\psi';
            ax.XLabel.FontSize = 24;
            ax.LabelFontSizeMultiplier = 1.3;
            ax.LineWidth = 1.3;
            set(gca,'FontSize',18)
            hold on
            set(fig, 'Visible', 'off');

            % FaceColor of markers, order changes when measured under four azimuths
            if length(ia{1}) == 4
                FaceColor = {h.Colors{k},h.Colors2{k},h.Colors{k},h.Colors2{k}};
            else
                FaceColor = {h.Colors{k},h.Colors{k},h.Colors2{k},h.Colors2{k}};
            end
            if size(h.ParamsToFit,2) == 1
                % Phi = 0 or 90 or 180 or 270
                if ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
                    drecalcphi = drecalcphi0;
                elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
                    drecalcphi = drecalcphi90;
                elseif isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
                    drecalcphi = drecalcphi180;    
                elseif isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
                    drecalcphi = drecalcphi270;        
                end

                recalcdspacing(:,k) = plot(sind(h.ParamsToFit(1).Psi_Winkel{1,k}).^2,10.*h.ParamsToFit(1).LatticeSpacing{1,k},'s',...
                    (sind((0:1:89)).^2)',10.*drecalcphi{k},'-','MarkerSize',9,'LineWidth',1,'Color',h.ColorsUsedSorted{k},'MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor','k','Clipping','off');

            elseif size(h.ParamsToFit,2) == 2
                % Phi = 0/90 or 0/180 or 0/270 or 90/180 or 90/270 or 180/270
                if ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && isempty(h.idxphi270)
                    drecalcphi1 = drecalcphi0;
                    drecalcphi2 = drecalcphi90;
                elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
                    drecalcphi1 = drecalcphi0;
                    drecalcphi2 = drecalcphi180;
                elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
                    drecalcphi1 = drecalcphi0;
                    drecalcphi2 = drecalcphi270;    
                elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
                    drecalcphi1 = drecalcphi90;
                    drecalcphi2 = drecalcphi180;
                elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
                    drecalcphi1 = drecalcphi90;
                    drecalcphi2 = drecalcphi270; 
                elseif isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
                    drecalcphi1 = drecalcphi180;
                    drecalcphi2 = drecalcphi270;     
                end

                recalcdspacing(:,k) = plot(sind(h.ParamsToFit(1).Psi_Winkel{1,k}).^2,10.*h.ParamsToFit(1).LatticeSpacing{1,k},'s',...
                    sind(h.ParamsToFit(2).Psi_Winkel{1,k}).^2,10.*h.ParamsToFit(2).LatticeSpacing{1,k},'o',...
                    (sind((0:1:89)).^2)',10.*drecalcphi1{k},'-',(sind((0:1:89)).^2)',10.*drecalcphi2{k},'-','MarkerSize',9,'LineWidth',1,'Color',h.ColorsUsedSorted{k},'MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor','k','Clipping','off');

            elseif size(h.ParamsToFit,2) == 3
                % Phi = 0/90/180 or 0/180/270 or 0/90/270 or 90/180/270
                if ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && isempty(h.idxphi270)
                    drecalcphi1 = drecalcphi0;
                    drecalcphi2 = drecalcphi90;
                    drecalcphi3 = drecalcphi180;
                elseif ~isempty(h.idxphi0) && ~isempty(h.idxphi90) && isempty(h.idxphi180) && ~isempty(h.idxphi270)
                    drecalcphi1 = drecalcphi0;
                    drecalcphi2 = drecalcphi90;
                    drecalcphi3 = drecalcphi270;
                elseif ~isempty(h.idxphi0) && isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
                    drecalcphi1 = drecalcphi0;
                    drecalcphi2 = drecalcphi180;
                    drecalcphi3 = drecalcphi270;
                elseif isempty(h.idxphi0) && ~isempty(h.idxphi90) && ~isempty(h.idxphi180) && ~isempty(h.idxphi270)
                    drecalcphi1 = drecalcphi90;
                    drecalcphi2 = drecalcphi180;
                    drecalcphi3 = drecalcphi270; 
                end

                recalcdspacing(:,k) = plot(sind(h.ParamsToFit(1).Psi_Winkel{1,k}).^2,10.*h.ParamsToFit(1).LatticeSpacing{1,k},'s',...
                    sind(h.ParamsToFit(2).Psi_Winkel{1,k}).^2,10.*h.ParamsToFit(2).LatticeSpacing{1,k},'o',...
                    sind(h.ParamsToFit(3).Psi_Winkel{1,k}).^2,10.*h.ParamsToFit(3).LatticeSpacing{1,k},'d',...
                    (sind((0:1:89)).^2)',10.*drecalcphi1{k},'-',(sind((0:1:89)).^2)',10.*drecalcphi2{k},'-',(sind((0:1:89)).^2)',10.*drecalcphi3{k},'-','MarkerSize',9,'LineWidth',1,'Color',h.ColorsUsedSorted{k},'MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor','k','Clipping','off');

            elseif size(h.ParamsToFit,2) == 4
                % Phi = 0/90/180/270
                recalcdspacing(:,k) = plot(sind(h.ParamsToFit(1).Psi_Winkel{1,k}).^2,10.*h.ParamsToFit(1).LatticeSpacing{1,k},'s',...
                    sind(h.ParamsToFit(2).Psi_Winkel{1,k}).^2,10.*h.ParamsToFit(2).LatticeSpacing{1,k},'o',...
                    sind(h.ParamsToFit(3).Psi_Winkel{1,k}).^2,10.*h.ParamsToFit(3).LatticeSpacing{1,k},'d',...
                    sind(h.ParamsToFit(4).Psi_Winkel{1,k}).^2,10.*h.ParamsToFit(4).LatticeSpacing{1,k},'p',...
                    (sind((0:1:89)).^2)',10.*drecalcphi0{k},'-',(sind((0:1:89)).^2)',10.*drecalcphi90{k},'-',(sind((0:1:89)).^2)',10.*drecalcphi180{k},'-',(sind((0:1:89)).^2)',10.*drecalcphi270{k},'-','MarkerSize',9,'LineWidth',1,'Color',h.ColorsUsedSorted{k},'MarkerFaceColor',h.ColorsUsedSorted{k},'MarkerEdgeColor','k','Clipping','off');
            end

            if size(h.ParamsToFit,2) == 1
                l = legend(['\phi = ',num2str(h.ParamsToFit(1).Phi_Winkel{1}(1)),'°']);
            elseif size(h.ParamsToFit,2) == 2
                l = legend(['\phi = ',num2str(h.ParamsToFit(1).Phi_Winkel{1}(1)),'°'],['\phi = ',num2str(h.ParamsToFit(2).Phi_Winkel{1}(1)),'°']);
            elseif size(h.ParamsToFit,2) == 3
                l = legend(['\phi = ',num2str(h.ParamsToFit(1).Phi_Winkel{1}(1)),'°'],['\phi = ',num2str(h.ParamsToFit(2).Phi_Winkel{1}(1)),'°'],['\phi = ',num2str(h.ParamsToFit(3).Phi_Winkel{1}(1)),'°']);
            elseif size(h.ParamsToFit,2) == 4
                l = legend('\phi = 0°','\phi = 90°','\phi = 180°','\phi = 270°');
            end
            % Set title for legend
            title(l,[strrep(num2str(DEKdatatmp(k,1:3)),' ',''),' ','Reflex'],'FontSize',11,'FontWeight','normal')
            set(get(gca,'title'),'Units', 'Normalized', 'Position',[0.5 1.05]);
            % Find best legend position
            legposcell = {'NorthWest','NorthEast','SouthWest','SouthEast'};
            % Loop through legend positions in order to get coordinates of all
            % possible corner positions
            for m = 1:4
                l.Location = legposcell{m};
                LegendPos(:,m) = l.Position;
            end

            for m = 1:size(h.ParamsToFit,2)
                psiData{m} = h.ParamsToFit(m).Psi_Winkel{k};
                dataLatticeSpacing{m} = h.ParamsToFit(m).LatticeSpacing{k};
            end

            % Check if data intersects with legend box
            LegPosOpt = legendclash(ax,sind(cell2mat(psiData(:))).^2,10.*cell2mat(dataLatticeSpacing(:)),LegendPos);
            % Find index of zeros
            LegPosOptInd = find(LegPosOpt==0);
            % Set legend location and properties
            if isempty(LegPosOptInd)
                l.Location = legposcell{1};
            else
                l.Location = legposcell{LegPosOptInd(1)};
            end
            l.FontSize = 10;
            l.LineWidth = 0.5;

            formatOut = 'ddmmyyyy';
            d = datestr(now, formatOut);
            Folder = '\Plots\UPlot\';

            if ~isfield(h,'PathName')
                name = strtrim(h.Measurement(1).MeasurementSeries);
                material = h.P.PopupValueMpd1;
                if strcmp(h.Diffsel,'LEDDI')
                    h.PathName = [General.ProgramInfo.Path,'\Data\Results\LEDDI\',[name,'_',material,'_','added_plots','_',d]];
                elseif strcmp(h.Diffsel,'EDDI')
                    h.PathName = [General.ProgramInfo.Path,'\Data\Results\EDDI\',[name,'_',material,'_','added_plots','_',d]];
                elseif strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
                    h.PathName = [General.ProgramInfo.Path,'\Data\Results\MetalJet\',[name,'_',material,'_','added_plots','_',d]];    
                end
            end

            Path = fullfile(h.PathName,Folder);

            if exist(Path,'dir') ~= 7
                mkdir(Path);
            end

            FileName = sprintf([strrep(h.Measurement(1).MeasurementSeries,' ',''),'_',h.Sample.Materials.Name,'_UPlot_d-spacing_','%d'],k);
            print(fig,[Path,FileName],'-painters','-dtiff','-r300')
        end
    end
end

guidata(hObj, h);

%% Qualitative phase analysis callbacks
function OpenFileCallbackQA(hObj,~)
% Callback for "Open File" pushbutton
h = guidata(hObj);

% Open file dialog box - Folder may have to be changed manually
[FileName,FilePath]  = uigetfile('*.*','Load measurement file',[General.ProgramInfo.Path,'\Data\Measurements\']);

if FileName == 0
  % user pressed cancel
  return
end

ExPath = fullfile(FilePath, FileName);
% Set FileName to string and ExPath to UserData of Edit-Field
set(h.LoadMeasDataQA,'string',FileName)
set(h.LoadMeasDataQA,'UserData',ExPath)

guidata(hObj, h);

function okbuttonloadmeasurementQA(hObj,~)
% Callback for "Load Measurement" ok pushbutton
h = guidata(hObj);

% Create virtaul sample
h.P.ElementalFormula = 'Au1';
h.P.MPDFileName = 'Au';
h.P.ShowSubstratePeaks = false;
h.P.SubstrateFormula = 'Au1';
h.P.SusbtrateMPDFileName = 'Au';
% Set FileName to string and ExPath to UserData of Edit-Field
[Sample,T] = CreateSampleGUI(h.P);
h.T = T;
h.Sample = Sample;

% Get measurement mode
measstr = get(h.popupmenuscanmodeQA,'string');
measval = get(h.popupmenuscanmodeQA,'value');
measmode = measstr{measval};
h.measmode = measmode;
% Get diffractometer name
Diffstr = get(h.popupmenudiffQA,'String');
Diffval = get(h.popupmenudiffQA,'Value');
Diffsel = Diffstr{Diffval};
h.Diffsel = Diffsel;
% Get detector from LEDDI measurements
Detstr = get(h.popupmenuselectmeas1,'String');
Detval = get(h.popupmenuselectmeas1,'Value');
Detsel = Detstr{Detval};
h.DetselQA = Detsel;

% Function to make "Fit" button blink in red during fitting process
col = get(hObj,'backg');  % Get the background color of the figure.
set(hObj,'str','Loading','backg',[1 .6 .6]) % Change color of button. 
% The pause (or drawnow) is necessary to make button changes appear.
pause(.01)

if strcmp(get(h.LoadMeasDataQA,'string'),'Select measurement file...')
    errordlg('No measurement selected','Warning');
else
    % Get parameters for the SpecFileConversionGUI script
    h.P.SpecFileName = get(h.LoadMeasDataQA,'string');
    h.P.DiffractometerType = get(h.popupmenudiffQA,'value') - 1;  % -1 since the first value is for info
    h.P.LoadFromSpecFile = get(h.popupmenuscanmodeQA,'value') - 1;    % -1 since the first value is for info
    calib = get(h.popupmenuDTCorr,'string');
    h.P.Calibration = calib{get(h.popupmenuDTCorrQA,'value')};
    % Run "SpecFileConversionGUI" script
    [meas,~,DataTmp,~,Diffractometer,P,T] = SpecFileConversionGUI(h.P,h.Sample,h.T);
    % IF LEDDI measurements were conducted using only one detector
    if strcmp(h.Diffsel,'LEDDI')
        set(h.PopupMenuSelectDetQA,'Enable','on')
        if meas(1).NumberOfDetectors == 1
            meas = reshape(repmat(meas,2,1),size(meas,2)*2,[]);
            meas = meas';
            DataTmp = reshape(repmat(DataTmp,2,1),size(DataTmp,2)*2,[]);
            DataTmp = DataTmp';
        end
    end

    % Change Emax according to diffractometer
    if strcmp(h.Diffsel,'LEDDI')
        
        for k = 1:length(meas)
            meas(k).Sample.Materials.EnergyMax = 60;
        end
    end
    % Set output to variables
    h.Measurement = meas;
    h.MeasurementBackup = meas;
%     h.MeasurementRawData = meas.Clone;
    h.Diffractometer = Diffractometer;
    h.DataTmp = DataTmp;
    h.DataTmpBackup = DataTmp;
    h.RawData = DataTmp;
    h.P = P;
    h.T = T;

    % Change slider parameters according to size of meas
    if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
        if length(meas) == 1
            set(h.SliderQA,'Min',1);
            set(h.SliderQA,'Max',length(meas));
            set(h.SliderQA,'SliderStep',[1 1]);
            set(h.SliderQA,'Visible','off');
        else
            set(h.SliderQA,'Min',1);
            set(h.SliderQA,'Max',length(meas));
            set(h.SliderQA,'SliderStep',[1/(length(meas)-1) 1/(length(meas)-1)]);
        end
    elseif strcmp(h.Diffsel,'LEDDI')
        if length(meas) == 2
            set(h.SliderQA,'Min',1);
            set(h.SliderQA,'Max',length(meas));
            set(h.SliderQA,'SliderStep',[1 1]);
            set(h.SliderQA,'Visible','off');
        else
            set(h.SliderQA,'Min',1);
            set(h.SliderQA,'Max',length(meas)/2);
            set(h.SliderQA,'SliderStep',[1/((length(meas)/2)-1) 1/((length(meas)/2)-1)]);
        end
    end
    
    % Set plot data and parameters
    if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
        set(h.plotdataQA,'xdata',DataTmp{1}(:,1))
        set(h.plotdataQA,'ydata',DataTmp{1}(:,2))
        set(h.axesplotMeasDataQA.Title,'String',['Measurement data for ', meas(1).Name])
    elseif strcmp(h.Diffsel,'LEDDI')
        if strcmp(h.DetselQA,'Detector 1')
            set(h.plotdataQA,'xdata',DataTmp{2}(:,1))
            set(h.plotdataQA,'ydata',DataTmp{2}(:,2))
            set(h.axesplotMeasDataQA.Title,'String',['Measurement data for ', meas(2).Name])
        elseif strcmp(h.DetselQA,'Detector 2')
            set(h.plotdataQA,'xdata',DataTmp{1}(:,1))
            set(h.plotdataQA,'ydata',DataTmp{1}(:,2))
            set(h.axesplotMeasDataQA.Title,'String',['Measurement data for ', meas(1).Name])
        end 
    end
    
    % Set initial parameters for panel "Select Measurements"
    if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
        h.axesplotMeasDataQA.XLim = [0, 120];
        h.axesplotMeasDataQA.YLim = [0, ceil(max(DataTmp{1}(:,2))/10)*10];
    elseif strcmp(h.Diffsel,'LEDDI')
        h.axesplotMeasDataQA.XLim = [0, 60];
        h.axesplotMeasDataQA.YLim = [0, Inf];
    end
end

% Reset the button color
set(hObj,'str','Ok','backg',col)  % Now reset the button features.

% Messagebox
msgbox('Measurement file loaded.');

guidata(hObj, h);

function SliderCallbackPlotDataQA(hObj, ~)
% This callback handles the changes when the slider button is pushed.
h = guidata(hObj);
% Get slider value
value = get(hObj, 'Value');
value = round(value);

% Set plot data and plot ranges/limits for different diffractometers
if strcmp(h.Diffsel,'LEDDI')
    % If LEDDI has been used for the measurement
    if strcmp(h.DetselQA,'Detector 1')
        % In order to analyze the data measured with Det1, the following
        % Slidersteps have to be used
        Slidersteps = 2:2:length(h.Measurement);
        % Set plot data according to the current slider value
        set(h.plotdataQA,'xdata',h.DataTmp{Slidersteps(value)}(:,1))
        set(h.plotdataQA,'ydata',h.DataTmp{Slidersteps(value)}(:,2))
        % Set axes limits
        if isfield(h, 'XminnewQA') && ~isfield(h, 'XmaxnewQA')
            h.axesplotMeasDataQA.XLim = [h.XminnewQA, 60];
            h.axesplotMeasDataQA.YLim =[-Inf ceil(max(h.DataTmp{Slidersteps(value)}(h.XLimMinInd:end,2))/10)*10];
        elseif isfield(h, 'XmaxnewQA') && ~isfield(h, 'XminnewQA')
            h.axesplotMeasDataQA.XLim = [0, h.XmaxnewQA];
            h.axesplotMeasDataQA.YLim =[-Inf ceil(max(h.DataTmp{Slidersteps(value)}(1:h.XLimMaxInd,2))/10)*10];
        elseif isfield(h, 'XminnewQA') && isfield(h, 'XmaxnewQA')
            h.axesplotMeasDataQA.XLim = [h.XminnewQA, h.XmaxnewQA];
            h.axesplotMeasDataQA.YLim =[-Inf ceil(max(h.DataTmp{Slidersteps(value)}(h.XLimMinInd:h.XLimMaxInd,2))/10)*10];
        else
            h.axesplotMeasDataQA.XLim = [0, 60];
            h.axesplotMeasDataQA.YLim =[-Inf ceil(max(h.DataTmp{Slidersteps(value)}(:,2))/10)*10];
        end
        % Set title according to current slider value
        set(h.axesplotMeasDataQA.Title,'String',['Measurement Data for ', h.Measurement(Slidersteps(value)).Name])
    elseif strcmp(h.DetselQA,'Detector 2')
        % In order to analyze the data measured with Det2, the following
        % Slidersteps have to be used
        Slidersteps = 1:2:length(h.Measurement);   
        % Set plot data according to the current slider value
        set(h.plotdataQA,'xdata',h.DataTmp{Slidersteps(value)}(:,1))
        set(h.plotdataQA,'ydata',h.DataTmp{Slidersteps(value)}(:,2))
        % Set axes limits
        if isfield(h, 'XminnewQA') && ~isfield(h, 'XmaxnewQA')
            h.axesplotMeasDataQA.XLim = [h.XminnewQA, 60];
            h.axesplotMeasDataQA.YLim =[-Inf ceil(max(h.DataTmp{Slidersteps(value)}(h.XLimMinInd:end,2))/10)*10];
        elseif isfield(h, 'XmaxnewQA') && ~isfield(h, 'XminnewQA')
            h.axesplotMeasDataQA.XLim = [0, h.XmaxnewQA];
            h.axesplotMeasDataQA.YLim =[-Inf ceil(max(h.DataTmp{Slidersteps(value)}(1:h.XLimMaxInd,2))/10)*10];
        elseif isfield(h, 'XminnewQA') && isfield(h, 'XmaxnewQA')
            h.axesplotMeasDataQA.XLim = [h.XminnewQA, h.XmaxnewQA];
            h.axesplotMeasDataQA.YLim =[-Inf ceil(max(h.DataTmp{Slidersteps(value)}(h.XLimMinInd:h.XLimMaxInd,2))/10)*10];
        else
            h.axesplotMeasDataQA.XLim = [0, 60];
            h.axesplotMeasDataQA.YLim =[-Inf ceil(max(h.DataTmp{Slidersteps(value)}(:,2))/10)*10];
        end
        % Set title according to current slider value
        set(h.axesplotMeasDataQA.Title,'String',['Measurement Data for ', h.Measurement(Slidersteps(value)).Name])
    end
else
    if h.checkboxplotall == 1
        if strcmp(h.Diffsel,'LEDDI')
        % If LEDDI has been used for the measurement
            if strcmp(h.DetselQA,'Detector 1')
                Slidersteps = 2:2:length(h.Measurement);
                % Set plot data
                set(h.plotdataQA,'xdata',h.DataTmp{Slidersteps(value)}(:,1))
                set(h.plotdataQA,'ydata',h.DataTmp{Slidersteps(value)}(:,2))
                uistack(h.plotdataQA,'top');
            elseif strcmp(h.DetselQA,'Detector 2')
                Slidersteps = 1:2:length(h.Measurement);
                % Set plot data
                set(h.plotdataQA,'xdata',h.DataTmp{Slidersteps(value)}(:,1))
                set(h.plotdataQA,'ydata',h.DataTmp{Slidersteps(value)}(:,2))
                uistack(h.plotdataQA,'top');
            end
        else
            % Set plot data
            set(h.plotdataQA,'xdata',h.DataTmp{1}(:,1))
            set(h.plotdataQA,'ydata',h.DataTmp{valueSlider}(:,2))
            % Set axes limits
            if isfield(h, 'XminnewQA') && ~isfield(h, 'XmaxnewQA')
                h.axesplotMeasDataQA.XLim = [h.XminnewQA, 120];
                h.axesplotMeasDataQA.YLim =[-Inf ceil(max(h.DataTmp{value}(h.XLimMinInd:end,2))/10)*10];
            elseif isfield(h, 'XmaxnewQA') && ~isfield(h, 'XminnewQA')
                h.axesplotMeasDataQA.XLim = [0, h.XmaxnewQA];
                h.axesplotMeasDataQA.YLim =[-Inf ceil(max(h.DataTmp{value}(1:h.XLimMaxInd,2))/10)*10];
            elseif isfield(h, 'XminnewQA') && isfield(h, 'XmaxnewQA')
                h.axesplotMeasDataQA.XLim = [h.XminnewQA, h.XmaxnewQA];
                h.axesplotMeasDataQA.YLim =[-Inf ceil(max(h.DataTmp{value}(h.XLimMinInd:h.XLimMaxInd,2))/10)*10];
            else
                h.axesplotMeasDataQA.XLim = [0, 120];
                h.axesplotMeasDataQA.YLim =[-Inf ceil(max(h.DataTmp{value}(:,2))/10)*10];
            end
            uistack(h.plotdataQA,'top');
        end
    else
        % If EDDI or MetalJet has been used for the measurement
        % Set plot data according to the current slider value
        set(h.plotdataQA,'xdata',h.DataTmp{value}(:,1))
        set(h.plotdataQA,'ydata',h.DataTmp{value}(:,2))
        % Set axes limits
        if isfield(h, 'XminnewQA') && ~isfield(h, 'XmaxnewQA')
            h.axesplotMeasDataQA.XLim = [h.XminnewQA, 120];
            h.axesplotMeasDataQA.YLim =[-Inf ceil(max(h.DataTmp{value}(h.XLimMinInd:end,2))/10)*10];
        elseif isfield(h, 'XmaxnewQA') && ~isfield(h, 'XminnewQA')
            h.axesplotMeasDataQA.XLim = [0, h.XmaxnewQA];
            h.axesplotMeasDataQA.YLim =[-Inf ceil(max(h.DataTmp{value}(1:h.XLimMaxInd,2))/10)*10];
        elseif isfield(h, 'XminnewQA') && isfield(h, 'XmaxnewQA')
            h.axesplotMeasDataQA.XLim = [h.XminnewQA, h.XmaxnewQA];
            h.axesplotMeasDataQA.YLim =[-Inf ceil(max(h.DataTmp{value}(h.XLimMinInd:h.XLimMaxInd,2))/10)*10];
        else
            h.axesplotMeasDataQA.XLim = [0, 120];
            h.axesplotMeasDataQA.YLim =[-Inf ceil(max(h.DataTmp{value}(:,2))/10)*10];
        end
        % Set title according to current slider value
        set(h.axesplotMeasDataQA.Title,'String',['Measurement Data for ', h.Measurement(round(value)).Name])
    end
end

guidata(hObj, h);

function SelectDetectorCallbackQA(hObj,~)
% Callback for "Select detector menu" in select measurement panel that
% allows to switch between data of the two detectors
h = guidata(hObj);
% Get slider value
valueSlider = round(get(h.SliderQA, 'Value'));
% Determine the selected detector
val = get(hObj, 'Value');
h.DetectorLEDDIselected = val;

% If detector 1 has been selected
if h.DetectorLEDDIselected == 2
    % Set slider properties
    if length(h.Measurement)/2 == 1
        set(h.SliderQA,'Min',0);
        set(h.SliderQA,'Max',1);
        set(h.SliderQA,'SliderStep',[1 1]);
    else
        set(h.SliderQA,'Min',1);
        set(h.SliderQA,'Max',length(h.Measurement)/2);
        set(h.SliderQA,'SliderStep',[1/((length(h.Measurement)/2)-1) 1/((length(h.Measurement)/2)-1)]);
    end
    Slidersteps = 2:2:length(h.Measurement);
    % Set plot data
    set(h.plotdataQA,'xdata',h.DataTmp{Slidersteps(valueSlider)}(:,1))
    set(h.plotdataQA,'ydata',h.DataTmp{Slidersteps(valueSlider)}(:,2))
    % Set XLim and YLim, depending whether an energy range has been defined
    % by the user
    if isfield(h, 'EnergyRangeDet1')
        h.axesplotMeasDataQA.XLim = h.EnergyRangeDet1;
    else
        h.axesplotMeasDataQA.XLim = [ceil(min(h.DataTmp{Slidersteps(valueSlider)}(:,1))) 60];
    end
    h.axesplotMeasDataQA.YLim =[-Inf round(max(h.DataTmp{Slidersteps(valueSlider)}(:,2)),-1)];
    % Set measurement title
    set(h.axesplotMeasDataQA.Title,'String',['Measurement Data for ', h.Measurement(Slidersteps(valueSlider)).Name])

% If detector 2 has been selected
elseif h.DetectorLEDDIselected == 3
    % Set slider properties
    if length(h.Measurement)/2 == 1
        set(h.SliderQA,'Min',0);
        set(h.SliderQA,'Max',1);
        set(h.SliderQA,'SliderStep',[1 1]);
    else
        set(h.SliderQA,'Min',1);
        set(h.SliderQA,'Max',length(h.Measurement)/2);
        set(h.SliderQA,'SliderStep',[1/((length(h.Measurement)/2)-1) 1/((length(h.Measurement)/2)-1)]);
    end
    Slidersteps = 1:2:length(h.Measurement);
    % Set plot data
    set(h.plotdataQA,'xdata',h.DataTmp{Slidersteps(valueSlider)}(:,1))
    set(h.plotdataQA,'ydata',h.DataTmp{Slidersteps(valueSlider)}(:,2))
    % Set XLim and YLim, depending whether an energy range has been defined
    % by the user
    if isfield(h, 'EnergyRangeDet2')
        h.axesplotMeasDataQA.XLim = h.EnergyRangeDet2;
    else
        h.axesplotMeasDataQA.XLim = [ceil(min(h.DataTmp{Slidersteps(valueSlider)}(:,1))) 60];
    end
    h.axesplotMeasDataQA.YLim =[-Inf round(max(h.DataTmp{Slidersteps(valueSlider)}(:,2)),-1)];
    % Set measurement title
    set(h.axesplotMeasDataQA.Title,'String',['Measurement Data for ', h.Measurement(Slidersteps(valueSlider)).Name])
end

guidata(hObj,h);

function SelectEminQA(hObj,~)
% Change plot limits
h = guidata(hObj);
% Get slider value
value = get(h.SliderQA,'Value');

Xmin = str2double(get(hObj,'String'));
h.axesplotMeasDataQA.XLim(1) = Xmin;
h.XminnewQA = Xmin;
% YLim also needs to be recalculated
% Find index of new Xmin
if strcmp(h.Diffsel,'LEDDI')
    if strcmp(h.DetselQA,'Detector 1')
        Slidersteps = 2:2:length(h.Measurement);
        h.XLimMinInd = Tools.Data.DataSetOperations.FindNearestIndex(h.DataTmp{Slidersteps(value)}(:,1),Xmin);
        h.axesplotMeasDataQA.YLim =[-Inf ceil(max(h.DataTmp{Slidersteps(value)}(h.XLimMinInd:end,2))/10)*10];
    elseif strcmp(h.DetselQA,'Detector 2')
        Slidersteps = 1:2:length(h.Measurement);
        h.XLimMinInd = Tools.Data.DataSetOperations.FindNearestIndex(h.DataTmp{Slidersteps(value)}(:,1),Xmin);
        h.axesplotMeasDataQA.YLim =[-Inf ceil(max(h.DataTmp{Slidersteps(value)}(h.XLimMinInd:end,2))/10)*10];
    end            
else
    h.XLimMinInd = Tools.Data.DataSetOperations.FindNearestIndex(h.DataTmp{value}(:,1),Xmin);
    h.axesplotMeasDataQA.YLim =[-Inf ceil(max(h.DataTmp{value}(h.XLimMinInd:end,2))/10)*10];
end

guidata(hObj, h);

function SelectEmaxQA(hObj,~)
% Change plot limits
h = guidata(hObj);
% Get slider value
value = get(h.SliderQA,'Value');

Xmax = str2double(get(hObj,'String'));
h.axesplotMeasDataQA.XLim(2) = Xmax;
h.XmaxnewQA = Xmax;
% YLim also needs to be recalculated
% Find index of new Xmax
if strcmp(h.Diffsel,'LEDDI')
    if strcmp(h.DetselQA,'Detector 1')
        Slidersteps = 2:2:length(h.Measurement);
        h.XLimMaxInd = Tools.Data.DataSetOperations.FindNearestIndex(h.DataTmp{Slidersteps(value)}(:,1),Xmax);
        h.axesplotMeasDataQA.YLim =[-Inf ceil(max(h.DataTmp{Slidersteps(value)}(h.XLimMinInd:h.XLimMaxInd,2))/10)*10];
    elseif strcmp(h.DetselQA,'Detector 2')
        Slidersteps = 1:2:length(h.Measurement);
        h.XLimMaxInd = Tools.Data.DataSetOperations.FindNearestIndex(h.DataTmp{Slidersteps(value)}(:,1),Xmax);
        h.axesplotMeasDataQA.YLim =[-Inf ceil(max(h.DataTmp{Slidersteps(value)}(h.XLimMinInd:h.XLimMaxInd,2))/10)*10];
    end 
else
    h.XLimMaxInd = Tools.Data.DataSetOperations.FindNearestIndex(h.DataTmp{value}(:,1),Xmax);
    h.axesplotMeasDataQA.YLim =[-Inf ceil(max(h.DataTmp{value}(h.XLimMinInd:h.XLimMaxInd,2))/10)*10];
end
guidata(hObj, h);

function buttonselectbkgQA(hObj, ~)
% Callback for "Define Background" button in background panel
h = guidata(hObj);
% Get slider value
valueSlider = round(get(h.SliderQA, 'Value'));

% Disable slider
set(h.SliderQA, 'enable', 'off')

if strcmp(h.Diffsel,'LEDDI')
    if strcmp(h.DetselQA,'Detector 1')
        Slidersteps = 2:2:length(h.Measurement);
    elseif strcmp(h.DetselQA,'Detector 2')
        Slidersteps = 1:2:length(h.Measurement);
    end
else
    Slidersteps = 1:length(h.Measurement);
end

% Messagebox
k = msgbox('Set a marker left and right of each peak. Confirm by Enter.');
% Wait for user to press ok
uiwait(k);
% Show explanatory text for definitioin of background points
h.textbkg = text('Units','normalized','Position',[0.3 0.95 0],...
    'BackgroundColor',[1 1 1],'EdgeColor', [0 0 0], ...
    'String','Push \textbf{enter} to resume | \textbf{return} to undo',...
    'interpreter','latex','FontSize', 16);

% Get points selected from user
[HT.x,~] = getpts(h.axesplotMeasDataQA);

% Set explanatory text visible off
set(h.textbkg,'Visible','off')

% Find closest point to user selected point
indexUSP = Tools.Data.DataSetOperations.FindNearestIndex(h.DataTmp{Slidersteps(valueSlider)}(:,1),HT.x);

if strcmp(h.Diffsel,'LEDDI')
    % Get x and y data in the range of +/- 5 channels of user selected bkg point
    xBKG = cell(1,1);
    yBKG = cell(1,1);
    for l = 1:size(h.DataTmp,2)/2
        for k = 1:length(indexUSP)
            indexBKG(:,k) = (indexUSP(k)-5):(indexUSP(k)+5);
            xBKG{l,k} = h.DataTmp{Slidersteps(l)}((indexUSP(k)-5):(indexUSP(k)+5),1);
            yBKG{l,k} = h.DataTmp{Slidersteps(l)}((indexUSP(k)-5):(indexUSP(k)+5),2);
        end
    end

    % Find min of yBKG
    indexYmin = cell(1);
    for l = 1:size(h.DataTmp,2)/2
        for k = 1:length(indexUSP)
            if all(yBKG{l,k} == 0)
                indexYmin{l,k} = 4;
            else
                indexYmin{l,k} = find(min(yBKG{l,k}(yBKG{l,k}>0)) == yBKG{l,k});
            end
        end
    end

    % Find and delete duplicate entries
    for l = 1:size(h.DataTmp,2)/2
        for k = 1:length(indexUSP)
            if length(indexYmin{l,k}) ~= 1
                indexYmin{l,k} = indexYmin{l,k}(1);
            end
        end
    end

    % Get index of Ymin
    indexYminDataTmp = cell(size(h.DataTmp,2)/2,length(indexUSP));
    for l = 1:size(h.DataTmp,2)/2
        for k = 1:length(indexUSP)
            indexYminDataTmp{l,k} = indexBKG(indexYmin{l,k},k); 
        end
    end
    % Get x and y data for Ymin and create PeakRegions data X and Y
    h.PeakRegionsXdata = cell(size(h.DataTmp,2)/2,length(indexUSP));
    h.PeakRegionsYdata = cell(size(h.DataTmp,2)/2,length(indexUSP));
    for l = 1:size(h.DataTmp,2)/2
        for k = 1:length(indexUSP)
            h.PeakRegionsXdata{l,k} = h.DataTmp{Slidersteps(l)}(indexYminDataTmp{l,k},1);
            h.PeakRegionsYdata{l,k} = h.DataTmp{Slidersteps(l)}(indexYminDataTmp{l,k},2);
        end
    end

    % Create PeakregionsX data
    h.PeakRegionsX = cell(size(h.DataTmp,2)/2,1);
    for l = 1:size(h.DataTmp,2)/2
        h.PeakRegionsX{l} = reshape([h.PeakRegionsXdata{l,:}],2,size([h.PeakRegionsXdata{l,:}],2)/2);
    end
else
    % Get x and y data in the range of +/- 5 channels of user selected bkg point
    xBKG = cell(1,1);
    yBKG = cell(1,1);
    for l = 1:size(h.DataTmp,2)
        for k = 1:length(indexUSP)
            indexBKG(:,k) = (indexUSP(k)-5):(indexUSP(k)+5);
            xBKG{l,k} = h.DataTmp{l}((indexUSP(k)-5):(indexUSP(k)+5),1);
            yBKG{l,k} = h.DataTmp{l}((indexUSP(k)-5):(indexUSP(k)+5),2);
        end
    end
    % Find min of yBKG
    indexYmin = cell(1);
    for l = 1:size(h.DataTmp,2)
        for k = 1:length(indexUSP)
            if all(yBKG{l,k} == 0)
                indexYmin{l,k} = 4;
            else
                indexYmin{l,k} = find(min(yBKG{l,k}(yBKG{l,k}>0)) == yBKG{l,k});
            end
        end
    end

    % Find and delete duplicate entries
    for l = 1:size(h.DataTmp,2)
        for k = 1:length(indexUSP)
            if length(indexYmin{l,k}) ~= 1
                indexYmin{l,k} = indexYmin{l,k}(1);
            end
        end
    end

    % Get index of Ymin
    indexYminDataTmp = cell(1);
    for l = 1:size(h.DataTmp,2)
        for k = 1:length(indexUSP)
            indexYminDataTmp{l,k} = indexBKG(indexYmin{l,k},k); 
        end
    end
    % Get x and y data for Ymin and create PeakRegions data X and Y
    for l = 1:size(h.DataTmp,2)
        for k = 1:length(indexUSP)
            h.PeakRegionsXdata{l,k} = h.DataTmp{l}(indexYminDataTmp{l,k},1);
            h.PeakRegionsYdata{l,k} = h.DataTmp{l}(indexYminDataTmp{l,k},2);
        end
    end

    % Create PeakregionsX data
    for l = 1:size(h.DataTmp,2)
        h.PeakRegionsX{l} = reshape([h.PeakRegionsXdata{l,:}],2,size([h.PeakRegionsXdata{l,:}],2)/2);
    end
end

% Correct background
if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    [Measurement,DataTmp,~] = BackgroundReductionGUI(h.Measurement,h.DataTmp,h.PeakRegionsX);
    h.DataTmp = DataTmp;
    h.Measurement = Measurement;
elseif strcmp(h.Diffsel,'LEDDI') 
    if strcmp(h.DetselQA,'Detector 1')
        Slidersteps = 2:2:length(h.Measurement);
        [Measurement,DataTmp,~] = BackgroundReductionGUI(h.Measurement(Slidersteps),h.DataTmp(Slidersteps),h.PeakRegionsX);
        h.DataTmp = DataTmp;
        h.Measurement = Measurement;
    elseif strcmp(h.DetselQA,'Detector 2')
        Slidersteps = 1:2:length(h.Measurement);
        [Measurement,DataTmp,~] = BackgroundReductionGUI(h.Measurement(Slidersteps),h.DataTmp(Slidersteps),h.PeakRegionsX);
        h.DataTmp = DataTmp;
        h.Measurement = Measurement;
    end
end
% assignin('base','DataTmpBkg',DataTmp)
% assignin('base','MeasurementBkg',Measurement)
% Show corrected background and wait for user decision whether to accept
% the corrected background or redo it
hold(h.axesplotMeasDataQA,'on')
h.plotdataCorrQA = plot(h.axesplotMeasDataQA,DataTmp{valueSlider}(h.XLimMinInd:h.XLimMaxInd,1),DataTmp{valueSlider}(h.XLimMinInd:h.XLimMaxInd,2),'Color', 'red');

answer = questdlg('Accept background correction?', ...
	'Background correction', ...
	'Yes','Redo','Yes');
% Handle response
switch answer
    case 'Yes'
        % Set plot data and parameters
%         if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160')
            set(h.plotdataQA,'xdata',DataTmp{valueSlider}(h.XLimMinInd:h.XLimMaxInd,1))
            set(h.plotdataQA,'ydata',DataTmp{valueSlider}(h.XLimMinInd:h.XLimMaxInd,2))
            set(h.axesplotMeasDataQA.Title,'String',['Measurement data for ', Measurement(valueSlider).Name])
            delete(h.plotdataCorrQA)
%         elseif strcmp(h.Diffsel,'LEDDI')
%             if strcmp(h.DetselQA,'Detector 1')
%                 set(h.plotdataQA,'xdata',DataTmp{1}(h.XLimMinInd:h.XLimMaxInd,1))
%                 set(h.plotdataQA,'ydata',DataTmp{1}(h.XLimMinInd:h.XLimMaxInd,2))
%                 set(h.axesplotMeasDataQA.Title,'String',['Measurement data for ', Measurement(1).Name])
%                 delete(h.plotdataCorrQA)
%             elseif strcmp(h.DetselQA,'Detector 2')
%                 set(h.plotdataQA,'xdata',DataTmp{1}(h.XLimMinInd:h.XLimMaxInd,1))
%                 set(h.plotdataQA,'ydata',DataTmp{1}(h.XLimMinInd:h.XLimMaxInd,2))
%                 set(h.axesplotMeasDataQA.Title,'String',['Measurement data for ', Measurement(1).Name])
%                 delete(h.plotdataCorrQA)
%             end 
%         end
    case 'Redo'
        delete(h.plotdataCorrQA)
        return
end


% assignin('base','DataTmpBackup',h.DataTmpBackup)
% assignin('base','DataTmp',h.DataTmp)

guidata(hObj, h);

function buttonselectpeaksQA(hObj, ~)
% Callback for "Define Peaks" button in fit panel
h = guidata(hObj);

% Messagebox
k = msgbox('Please add the peaks you want to fit. Confirm by Enter.');
% Wait for user to press ok
uiwait(k);
% Show explanatory text for definitioin of background points
h.textbkg = text('Units','normalized','Position',[0.3 0.95 0],...
    'BackgroundColor',[1 1 1],'EdgeColor', [0 0 0], ...
    'String','Push \textbf{enter} to resume | \textbf{return} to undo',...
    'interpreter','latex','FontSize', 16);

% Get slider value
valueSlider = round(get(h.SliderQA, 'Value'));

% Get points selected from user
[HT.x,~] = getpts(h.axesplotMeasDataQA);
% assignin('base','HTx',HT.x)
if strcmp(h.Diffsel,'LEDDI')
    % Set peak data
    for l = 1:size(h.DataTmp,2)/2
        h.PeaksQA{l} = HT.x';
        h.PeaksQAlb{l} = 0.3*ones(size(HT.x,1));
        h.PeaksQAub{l} = 0.3*ones(size(HT.x,1));
    end
else
    % Set peak data
    for l = 1:size(h.DataTmp,2)
        h.PeaksQA{l} = HT.x';
        h.PeaksQAlb{l} = 0.3*ones(size(HT.x,1));
        h.PeaksQAub{l} = 0.3*ones(size(HT.x,1));
    end
end

% Set explanatory text visible off
set(h.textbkg,'Visible','off')

% Set table data
if strcmp(h.Diffsel,'LEDDI')
    if strcmp(h.DetselQA,'Detector 1')
        Slidersteps = 2:2:length(h.Measurement);
        % Calculate d-spacing and add 2theta to table
        dspacingQA = (0.6199./sind(h.Measurement(1).twotheta/2)).*1./h.PeaksQA{valueSlider};
        set(h.tablepeaksQA,'data',[num2cell(h.PeaksQA{valueSlider}'), num2cell(dspacingQA'), num2cell(h.Measurement(valueSlider).twotheta.*ones(size(h.PeaksQA{valueSlider},2),1)), num2cell(logical(ones(size(h.PeaksQA{valueSlider},2),1)))])
        % Interpolate RawData to get YData for PeakRegions
        DataInterpPeaks = interp1(h.DataTmp{Slidersteps(valueSlider)}(:,1),h.DataTmp{Slidersteps(valueSlider)}(:,2),h.PeaksQA{valueSlider});
        % Plot of peak positions
        hold(h.axesplotMeasDataQA,'on')
        h.plotpeakpoints = plot(h.axesplotMeasDataQA,h.PeaksQA{valueSlider},DataInterpPeaks,'d','Color','r','MarkerFaceColor','r','MarkerSize',5,'Visible','on');
    elseif strcmp(h.DetselQA,'Detector 2')
        Slidersteps = 1:2:length(h.Measurement);
        % Calculate d-spacing and add 2theta to table
        dspacingQA = (0.6199./sind(h.Measurement(1).twotheta/2)).*1./h.PeaksQA{valueSlider};
        set(h.tablepeaksQA,'data',[num2cell(h.PeaksQA{valueSlider}'), num2cell(dspacingQA'), num2cell(h.Measurement(valueSlider).twotheta.*ones(size(h.PeaksQA{valueSlider},2),1)), num2cell(logical(ones(size(h.PeaksQA{valueSlider},2),1)))])
        % Interpolate RawData to get YData for PeakRegions
        DataInterpPeaks = interp1(h.DataTmp{Slidersteps(valueSlider)}(:,1),h.DataTmp{Slidersteps(valueSlider)}(:,2),h.PeaksQA{valueSlider});
        % Plot of peak positions
        hold(h.axesplotMeasDataQA,'on')
        h.plotpeakpoints = plot(h.axesplotMeasDataQA,h.PeaksQA{valueSlider},DataInterpPeaks,'d','Color','r','MarkerFaceColor','r','MarkerSize',5,'Visible','on');
    end
else
    % Calculate d-spacing and add 2theta to table
    dspacingQA = (0.6199./sind(h.Measurement(1).twotheta/2)).*1./h.PeaksQA{valueSlider};
    set(h.tablepeaksQA,'data',[num2cell(h.PeaksQA{valueSlider}'), num2cell(dspacingQA'), num2cell(h.Measurement(valueSlider).twotheta.*ones(size(h.PeaksQA{valueSlider},2),1)), num2cell(logical(ones(size(h.PeaksQA{valueSlider},2),1)))])
    % Interpolate RawData to get YData for PeakRegions
    DataInterpPeaks = interp1(h.DataTmp{valueSlider}(:,1),h.DataTmp{valueSlider}(:,2),h.PeaksQA{valueSlider});
    % Plot of peak positions
    hold(h.axesplotMeasDataQA,'on')
    h.plotpeakpoints = plot(h.axesplotMeasDataQA,h.PeaksQA{valueSlider},DataInterpPeaks,'d','Color','r','MarkerFaceColor','r','MarkerSize',5,'Visible','on');
    
end
% Messagebox
msgbox('Peak positions created.');

guidata(hObj, h);

function buttonfitpeaksQA(hObj, ~)
% Callback for "Fit" button in fit panel
h = guidata(hObj);

% Function to make "Fit" button blink in red during fitting process
col = get(hObj,'backg');  % Get the background color of the figure.
set(hObj,'str','Fitting','backg',[1 .6 .6]) % Change color of button. 
% The pause (or drawnow) is necessary to make button changes appear.
pause(.01)
% Get slider value
valueSlider = round(get(h.SliderQA, 'Value'));
% Run FittingGUI function in order to fit the user defined peaks. Depending
% on the diffractometer used, different cases need to be considered
if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    % Run fit script
    [Measurement,DataTmp,FittedPeaks,CI,SE] = FittingGUIQA(h.Measurement,h.DataTmp,h.PeakRegionsX,h.PeaksQA,h.PeaksQAlb,h.PeaksQAub,2,valueSlider);
    % Set and update handle variables
    h.Measurement = Measurement;
    h.DataTmp = DataTmp;
    h.FittedPeaks = FittedPeaks;
    % Find nan in SE and CI and replace with zero
    idx = cellfun(@isnan, SE,'UniformOutput',false);
    for k = 1:length(SE)
        SE{1,k}(idx{1,k}) = 0;
        CI{1,k}(idx{1,k}) = 0;
    end
    % Set handle data
    h.SE = SE;
    h.CI = CI;
elseif strcmp(h.Diffsel,'LEDDI')
    if strcmp(h.DetselQA,'Detector 1')
        % Consider the following spectra
%         Slidersteps = 2:2:length(h.Measurement);
        % Run fit script
        [Measurement,DataTmp,FittedPeaks,CI,SE] = FittingGUIQA(h.Measurement,h.DataTmp,h.PeakRegionsX,h.PeaksQA,h.PeaksQAlb,h.PeaksQAub,2);
        % Update Measurement and Datatmp
        h.DataTmp = DataTmp;
        h.Measurement = Measurement;
        % Create handle for fitted peak data
        h.FittedPeaksDet1 = FittedPeaks;
        % Find nan in SE and replace with zero
        idx = cellfun(@isnan, SE,'UniformOutput',false);
        for k = 1:length(SE)
            SE{1,k}(idx{1,k}) = 0;
            CI{1,k}(idx{1,k}) = 0;
        end
        h.CIDet1 = CI;
        h.SEDet1 = SE;
    elseif strcmp(h.DetselQA,'Detector 2')
        Slidersteps = 1:2:length(h.Measurement);
        [Measurement,DataTmp,FittedPeaks,CI,SE] = FittingGUIQA(h.Measurement(Slidersteps),h.DataTmp(Slidersteps),h.PeakRegionsX,h.PeaksQA,h.PeaksQAlb,h.PeaksQAub,2);
        % Update Measurement and Datatmp
        h.DataTmp = DataTmp;
        h.Measurement = Measurement;
        % Create handle for fitted peak data
        h.FittedPeaksDet2 = FittedPeaks;
        % Find nan in SE and replace with zero
        idx = cellfun(@isnan, SE,'UniformOutput',false);
        for k = 1:length(SE)
            SE{1,k}(idx{1,k}) = 0;
            CI{1,k}(idx{1,k}) = 0;
        end
        h.CIDet2 = CI;
        h.SEDet2 = SE;
    end
end

% Reset the button color
set(hObj,'str','Fit','backg',col)  % Now reset the button features.

% Prepare plot of fitted data
set(h.plotpeakpoints,'Visible','off')

% assignin('base','FittedPeaks',FittedPeaks)

% Prepare data for plotting fit results
if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    DataTmpCalc = DataTmp;
    FittedPeaksCalc = FittedPeaks;
elseif strcmp(h.Diffsel,'LEDDI')
    if strcmp(h.DetselQA,'Detector 1')
        Slidersteps = 2:2:length(h.Measurement);
        DataTmpCalc = h.DataTmp(Slidersteps);
        FittedPeaksCalc = h.FittedPeaksDet1;
    elseif strcmp(h.DetselQA,'Detector 2')
        Slidersteps = 1:2:length(h.Measurement);
        DataTmpCalc = h.DataTmp(Slidersteps);
        FittedPeaksCalc = h.FittedPeaksDet2;
    end
end
% assignin('base','DataTmpCalc',DataTmpCalc)
% Create handle with peaks to be analyzed
h.PeaksToAnalyze = FittedPeaks{1}(:,2);

% Prepare plots of fitted peaks
XFit = DataTmpCalc{valueSlider}(:, 1);
% YFit = DataTmpCalc{valueSlider}(:, 2);  
% Fit-Data
XPlot = XFit(1):0.001:XFit(end);
YPlot = zeros(size(XPlot));
% Calculate fitted profile using Fitted PeakData
for d = 1:size(FittedPeaksCalc{1}, 1)
    SinglePlot = Tools.Science.Math.FF_PseudoVoigt(XPlot, ...
        FittedPeaksCalc{1}(d, 1), FittedPeaksCalc{1}(d, 2), FittedPeaksCalc{1}(d, 3),FittedPeaksCalc{1}(d, 4));
    YPlot = YPlot + SinglePlot;
end

% Add plots of fitted peaks to axes
hold(h.axesplotMeasDataQA,'on')
h.plotfits = plot(h.axesplotMeasDataQA, XPlot, YPlot,'Color','red','LineWidth',1.5);

% Change YLim
h.axesplotMeasDataQA.YLim =[-Inf ceil(max(DataTmpCalc{valueSlider}(h.XLimMinInd:h.XLimMaxInd,2))/10)*10];

% Set table data
% Calculate d-spacing and add 2theta to table
h.dspacingQA = (0.6199./sind(h.Measurement(1).twotheta/2)).*1./FittedPeaks{1}(:,2);
set(h.tablepeaksQA,'data',[num2cell(FittedPeaks{1}(:,2)), num2cell(h.dspacingQA), num2cell(h.Measurement(valueSlider).twotheta.*ones(size(FittedPeaks{1},1),1)), num2cell(logical(ones(size(FittedPeaks{1},1),1)))])

% Messagebox
msgbox('Fitting completed.');

guidata(hObj, h);

function buttonclearpeaksQA(hObj, ~)
% Callback for "Define Peaks" button in fit panel
h = guidata(hObj);

d = zeros(10,3);
idxdata = d(:,1)>0;

set(h.tablepeaksQA,'data',[num2cell(d), num2cell(idxdata)])

if isfield(h,'plotpeakpoints')
    delete(h.plotpeakpoints)
end

if isfield(h,'plotfits')
    delete(h.plotfits)
end

% Enable slider
set(h.SliderQA, 'enable', 'on')
set(h.SliderQA, 'Value',1)

if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
    h.DataTmp = h.DataTmpBackup;
    h.Measurement = h.MeasurementBackup;
    set(h.plotdataQA,'xdata',h.DataTmpBackup{1}(h.XLimMinInd:h.XLimMaxInd,1))
    set(h.plotdataQA,'ydata',h.DataTmpBackup{1}(h.XLimMinInd:h.XLimMaxInd,2))
    set(h.axesplotMeasDataQA.Title,'String',['Measurement data for ', h.MeasurementBackup(1).Name])
elseif strcmp(h.Diffsel,'LEDDI')
    h.DataTmp = h.DataTmpBackup;
    h.Measurement = h.MeasurementBackup;
    if strcmp(h.DetselQA,'Detector 1')
        Slidersteps = 2:2:length(h.Measurement);
        set(h.plotdataQA,'xdata',h.DataTmpBackup{Slidersteps(1)}(h.XLimMinInd:h.XLimMaxInd,1))
        set(h.plotdataQA,'ydata',h.DataTmpBackup{Slidersteps(1)}(h.XLimMinInd:h.XLimMaxInd,2))
        set(h.axesplotMeasDataQA.Title,'String',['Measurement data for ', h.MeasurementBackup(Slidersteps(1)).Name])
    elseif strcmp(h.DetselQA,'Detector 2')
        Slidersteps = 1:2:length(h.Measurement);
        set(h.plotdataQA,'xdata',h.DataTmpBackup{Slidersteps(1)}(h.XLimMinInd:h.XLimMaxInd,1))
        set(h.plotdataQA,'ydata',h.DataTmpBackup{Slidersteps(1)}(h.XLimMinInd:h.XLimMaxInd,2))
        set(h.axesplotMeasDataQA.Title,'String',['Measurement data for ', h.MeasurementBackup(Slidersteps(1)).Name])
    end 
end

guidata(hObj, h);

function celleditcallbacktablePeakTableQA(hObj, ~)
% Callback for Uplottabledata
h = guidata(hObj);

% Get data from peak table 
PeaktabledataQA = get(hObj,'data');
Peaks = h.PeaksToAnalyze;
% Get user selected peaks
h.PeaksToAnalyzeUserSel = Peaks(cell2mat(PeaktabledataQA(:,4)));

guidata(hObj, h);

function buttonCheckFluorPeaksQA(hObj, ~)
% Callback for Uplottabledata
h = guidata(hObj);

% Callback for matching user peak positions with fluorescence lines
% Compare peak positions with fluorescence line positions
FluorEPos = cell2mat(h.FluorCellArray(:,3:10));
% Search fluor positions for user defined peaks with tolerance of 0.1 keV
% assignin('base','FluorEPos',FluorEPos)
ind = ismembertol(FluorEPos(:),h.PeaksToAnalyze,0.1,'DataScale', 1);
% assignin('base','PeaksToAnalyze',h.PeaksToAnalyze)
% for k = 1:size(FluorEPos,1)
%     ind{k} = Tools.Data.DataSetOperations.FindNearestIndex(nonzeros(FluorEPos(k,:)),h.PeaksToAnalyze);
% end

% Get matched E positions
EPosMatch = FluorEPos(ind);
% assignin('base','EPosMatch',EPosMatch)
% Find corresponding elements to EPosMatch
h.LogIndQA = ismember(FluorEPos,EPosMatch);
% assignin('base','FluorEPos',FluorEPos)
% Counter
cnt = 1;
% Loop for getting element names
for k = 1:8
    tmp = h.FluorCellArray{2}(h.LogIndQA(:,k));
    if ~isempty(tmp)
        FluorElement{cnt} = tmp;
        cnt = cnt + 1;
    end
end
% Rearrange cell array
FluorElement = vertcat(FluorElement{:});
FluorElement = unique(FluorElement,'stable');
% Prepare plot data
indElement = find(sum(h.LogIndQA,2)~=0);

for k = 1:length(indElement)
    Ka1 = h.FluorCellArray{1,3}(indElement(k));
    Ka2 = h.FluorCellArray{1,4}(indElement(k));
    Kb1 = h.FluorCellArray{1,5}(indElement(k));
    % Not yet included
    La1 = h.FluorCellArray{1,6}(indElement(k));
    La2 = h.FluorCellArray{1,7}(indElement(k));
    Lb1 = h.FluorCellArray{1,8}(indElement(k));
    Lb2 = h.FluorCellArray{1,9}(indElement(k));
    Lg1 = h.FluorCellArray{1,10}(indElement(k));
    % Prepare data for line plot.
    % Save fluorescence lines into temporary vector.
    k_tmp = [Ka1 Ka2 Kb1 La1 La2 Lb1 Lb2 Lg1];
    for m = 1:size(k_tmp,2)
        if k_tmp(m) > str2double(get(h.SelectMeasDataQAedit1,'String')) && k_tmp(m) < str2double(get(h.SelectMeasDataQAedit2,'String'))
            k_tmp1(:,m) = [k_tmp(m) k_tmp(m) nan];
        end
    end
	k_tmp1(:, ~any(k_tmp1,1)) = [];
    k_tmp2 = reshape(k_tmp1,size(k_tmp1,1)*size(k_tmp1,2),1);
    k_tmp2(size(k_tmp1,1)*size(k_tmp1,2),:) = [];
    
    y_tmp = repmat([0 h.axesplotMeasDataQA.YLim(2) nan],1,size(k_tmp1,2))';
    y_tmp(size(k_tmp1,1)*size(k_tmp1,2),:) = [];
    xdata{k} = k_tmp2;
    ydata{k} = y_tmp;
    clear k_tmp1
end

% Get element names
for k = 1:length(indElement)
    Element(:,k) = h.FluorCellArray{1,2}(indElement(k));
end

Colors = [h.Colors h.Colors];

for k = 1:length(FluorElement)
    h.plotfluorlines(k) = line(h.axesplotMeasDataQA, xdata{k}, ydata{k},'Color', Colors{k},'LineStyle','-','LineWidth',2,'Visible','off', 'Clipping', 'on');
end

% Set table data
set(h.tableFluorQA,'data',[Element', num2cell(logical(zeros(size(Element,2),1)))])

guidata(hObj, h);

function celleditcallbacktableCheckFluorQA(hObj, ~)
% Callback for Uplottabledata
h = guidata(hObj);

% Get data from fluorescence table 
FluortabledataQA = get(hObj,'data');
% Get index of fluorescence line that should be plotted
indToPlot = cell2mat(FluortabledataQA(:,2));
% Get plot handle
LinePlotHandle = h.plotfluorlines;
% Create background color array
TableBkgColorArray = ones(size(LinePlotHandle,2),3);
%Prepare colors for plot
if size(indToPlot,1) > size(h.Colors2,2)
    ColorsPlot = repmat(h.Colors2,1,ceil(size(indToPlot,1)/size(h.Colors2,2)));
else
    ColorsPlot = h.Colors2;
end
% Change visibility of plots and background color of table
for k = 1:size(LinePlotHandle,2)
    if indToPlot(k) == 1
        set(LinePlotHandle(k),'Visible','on')
        TableBkgColorArray(k,:) = ColorsPlot{k};
        set(h.tableFluorQA,'BackgroundColor',TableBkgColorArray)
    else
        set(LinePlotHandle(k),'Visible','off')
        TableBkgColorArray(k,:) = [1 1 1];
        set(h.tableFluorQA,'BackgroundColor',TableBkgColorArray)
    end
end

guidata(hObj, h);

function OpenPeriodicTableCallback(hObj, ~)
% Callback for Uplottabledata
h = guidata(hObj);
% assignin('base','dspacingQA',h.dspacingQA)
% Open figure for the user to select the elements of the investigated
% material
h.UserSelElements = periodic_table;

% Show selected elements in edit field
set(h.SelectedElementsQAedit1,'String',strjoin(h.UserSelElements,','))

guidata(hObj, h);

function StartPeakMatchCallback(hObj, ~)
% Callback for Uplottabledata
h = guidata(hObj);
% Function to make "Fit" button blink in red during fitting process
col = get(hObj,'backg');  % Get the background color of the figure.
set(hObj,'str','Peaks are matched','backg',[1 .6 .6]) % Change color of button. 
% The pause (or drawnow) is necessary to make button changes appear.
pause(.01)

% Count variable
cnt = 1;
% Number of elements selected by the user
% numElements = numel(UserSelElements);
% Number of elements selected by the user that should match at least
numElements = str2double(get(h.SelectedElementsQAedit2,'String'));

maxnumElements = str2double(get(h.SelectedElementsQAedit3,'String'));
% Load Data base for search and match. Peformed only once at the beginning.
if ~isfield(h,'DBPDF')  
    disp('PCPDF Database is being loaded...this takes some time.')
    h.DBPDF = load(fullfile('Data','PCPDFdatabase','PCPDFDataBaseSorted.mat'));
end

% Function used to scan the database (db).
for g = 1:numel(h.DBPDF.PDFDataBasesorted)
    % Get lattice spacings of db entry "g"
    reflex_db = h.DBPDF.PDFDataBasesorted(g).dSpacing;
    % Get elemental formula of db entry "g"
    elements_db = strsplit(char(regexprep(regexprep(h.DBPDF.PDFDataBasesorted(g).ElementSymbol, '\(|)|!', ''), '[+-]?\d+\.?\d*', '')));    
    % Split elements into cell array
    NumElements_db = numel(elements_db);
    % Compare user selected elements with db
    for k = 1:numel(h.UserSelElements)
        match(:,k) = strcmp(elements_db,h.UserSelElements{k}); 
    end
    CheckElements = sum(match,2);
    % Check whether the number of elements and the elements match the ones
    % from the current pdf file "g". Write it to the results file.
    if nnz(CheckElements) >= numElements && NumElements_db <= maxnumElements
        if size(unique(reflex_db),1) > 1
            if abs(max(reflex_db) - max(10.*h.dspacingQA)) <= 2
                % added "10" to the vector to be compared in order to get a
                % hit if the first d-spacing from the database is smaller
                % than the first d-spacing from the measured data
                % General problem: if the value of the database is smaller
                % than the value from the comparison, it won't show a hit.
                Hit = Tools.Data.DataSetOperations.FindNearestIndex([10;unique(reflex_db,'stable')],10.*h.dspacingQA);
                Hit = Hit-1;
                if ~all(isnan(Hit))
                    Hit = Hit(~isnan(Hit));
                    IndexHit{cnt,1} = unique(Hit);
                    IndexHit{cnt,2} = g;
                    IndexHit{cnt,3} = h.DBPDF.PDFDataBasesorted(g).ElementSymbol;
                    IndexHit{cnt,4} = h.DBPDF.PDFDataBasesorted(g).ElementName;
                    IndexHit{cnt,5} = h.DBPDF.PDFDataBasesorted(g).dSpacing;
                    IndexHit{cnt,6} = h.DBPDF.PDFDataBasesorted(g).spaceGroupSymbol;
                    IndexHit{cnt,7} = h.DBPDF.PDFDataBasesorted(g).spaceGroupNumber;
                    IndexHit{cnt,8} = 10.*h.dspacingQA;
                    cnt = cnt + 1;
                end       
            end
        end
    end
    clear match
end

% tic
% for g = 1:numel(h.DBPDF.PDFDataBasesorted)
%     % Get lattice spacings of db entry "g"
%     reflex_db = h.DBPDF.PDFDataBasesorted(g).dSpacing;
%     % Get elemental formula of db entry "g"
%     elements_db_tmp1 = h.DBPDF.PDFDataBasesorted(g).ElementSymbol;
%     % Delete non alphabetic characters and numbers from  elemental formula
%     elements_db_tmp2 = regexprep(elements_db_tmp1, '\(|)|!', '');
%     elements_db = regexprep(elements_db_tmp2, '[+-]?\d+\.?\d*', '');
%     % Split elements into cell array
%     NumElements_db = numel(strsplit(char(elements_db),' '));
%     % Compare user selected elements with db
%     for k = 1:numel(h.UserSelElements)
%         match(:,k) = strcmp(strsplit(char(elements_db)),h.UserSelElements{k}); 
%     end
%     CheckElements = sum(match,2);
%     % Check whether the number of elements and the elements match the ones
%     % from the current pdf file "g". Write it to the results file.
%     if nnz(CheckElements) >= numElements && NumElements_db <= maxnumElements
%         if size(unique(reflex_db),1) > 1
%             if abs(max(reflex_db) - max(10.*h.dspacingQA)) <= 2
%                 Hit = Tools.Data.DataSetOperations.FindNearestIndex(unique(reflex_db),10.*h.dspacingQA);
%                 if ~all(isnan(Hit))
%                     Hit = Hit(~isnan(Hit));
%                     IndexHit{cnt,1} = Hit;
%                     IndexHit{cnt,2} = g;
%                     IndexHit{cnt,3} = h.DBPDF.PDFDataBasesorted(g).ElementSymbol;
%                     IndexHit{cnt,4} = h.DBPDF.PDFDataBasesorted(g).ElementName;
%                     IndexHit{cnt,5} = h.DBPDF.PDFDataBasesorted(g).dSpacing;
%                     IndexHit{cnt,6} = h.DBPDF.PDFDataBasesorted(g).spaceGroupSymbol;
%                     IndexHit{cnt,7} = h.DBPDF.PDFDataBasesorted(g).spaceGroupNumber;
%                     IndexHit{cnt,8} = 10.*h.dspacingQA;
%                     cnt = cnt + 1;
%                 end       
%             end
%         end
%     end
%     clear match
% end
% toc
% exist IndexHit
% if exist(h,'')
h.IndexHit = IndexHit;
assignin('base','IndexHit',IndexHit)
% Reset the button color
set(hObj,'str','Start peak matching','backg',col)  % Now reset the button features.

% Prepare data for table
for k = 1:size(IndexHit,1)
    l.Matches{k} = length(IndexHit{k,1});
    l.PDF{k} = IndexHit{k,2};
    l.Formula(:,k) = IndexHit{k,3};
    l.Name(:,k) = regexprep(IndexHit{k,4}, '.P', '', 'lineanchors');
    if isempty(IndexHit{k,6})
       l.SpaceGroupName{k} =  'NaN';
    else
        l.SpaceGroupName(:,k) = IndexHit{k,6};        
    end
    l.SpaceGroupNo{k} = IndexHit{k,7};
    l.dspacing{k} = strjoin(arrayfun(@(x) num2str(x),IndexHit{k,5}/10,'UniformOutput',false),',');
end

% Sort table data according to number of matches
lneu = l;
lneu.Matches = l.Matches';
lneu.PDF = l.PDF';
lneu.Formula = l.Formula';
lneu.Name = l.Name';
lneu.SpaceGroupName = l.SpaceGroupName';
lneu.SpaceGroupNo = l.SpaceGroupNo';
lneu.dspacing = l.dspacing';

lsorttmp = struct2table(lneu);
[lsorttmp1, idx] = sortrows(lsorttmp, 1, 'descend');
lsorttmp2 = table2array(lsorttmp1);

lsort.Matches = lsorttmp2(:,1)';
lsort.PDF = lsorttmp2(:,2)';
lsort.Formula = lsorttmp2(:,3)';
lsort.Name = lsorttmp2(:,4)';
lsort.SpaceGroupName = lsorttmp2(:,5)';
lsort.SpaceGroupNo = lsorttmp2(:,6)';
lsort.dspacing = lsorttmp2(:,7)';

% Rearrange IndexHit
IndexHit = IndexHit(idx,:);

% Prepare data for plotting
for k = 1:length(logical(zeros(size(IndexHit,1),1)))
    for i = 1:size(IndexHit{k,5},1)
        EPosLinetmp(:,i) = [(6.199./sind(h.Measurement(1).twotheta/2)).*(1./(IndexHit{k,5}(i))) (6.199./sind(h.Measurement(1).twotheta/2)).*(1./(IndexHit{k,5}(i))) nan];
    end

    EPosLinetmp1 = reshape(EPosLinetmp,size(EPosLinetmp,1)*size(EPosLinetmp,2),1);
    EPosLinetmp1(size(EPosLinetmp,1)*size(EPosLinetmp,2),:) = [];

    y_tmp = repmat([0 h.axesplotMeasDataQA.YLim(2) nan],1,size(EPosLinetmp,2))';
    y_tmp(size(EPosLinetmp,1)*size(EPosLinetmp,2),:) = [];
    
    xdata{k} = EPosLinetmp1;
    ydata{k} = y_tmp;
    clear EPosLinetmp
end

% Prepare plots
% Get correct colors array
if size(IndexHit,1) > size(h.Colors2,2)
    ColorsPlot = repmat(h.Colors,1,ceil(size(IndexHit,1)/size(h.Colors,2)));
else
    ColorsPlot = h.Colors;
end

% ColorsPlot = repmat(h.Colors,1,ceil(size(IndexHit,1)/size(h.Colors,2)));

for k = 1:length(logical(zeros(size(IndexHit,1),1)))
    h.plotEtheolines(k) = line(h.axesplotMeasDataQA, xdata{k}, ydata{k},'LineStyle', '-', 'LineWidth', 2 ,'Color', ColorsPlot{k}, 'Visible', 'off', 'Clipping', 'on');
end

% Set table data
set(h.tableresultsSAMQA,'data',[num2cell(logical(zeros(size(IndexHit,1),1))), lsort.Matches', lsort.PDF', lsort.Formula', lsort.Name', lsort.SpaceGroupName', lsort.SpaceGroupNo', lsort.dspacing'])

guidata(hObj, h);

function celleditcallbacktableresultsSAMQA(hObj, ~)
% Callback for Uplottabledata
h = guidata(hObj);
% assignin('base','dspacingQA',h.dspacingQA)
% Get data from fluorescence table 
PlotPDFdataQA = get(hObj,'data');

% Switch plots visibility on/off as selected by the user
plotselect = cell2mat(PlotPDFdataQA(:,1));

% Create background color array
TableBkgColorArray = ones(size(h.plotEtheolines,2),3);
%Prepare colors for plot
if size(plotselect,1) > size(h.Colors2,2)
    ColorsTable = repmat(h.Colors2,1,ceil(size(plotselect,1)/size(h.Colors2,2)));
else
    ColorsTable = h.Colors2;
end

for k = 1:length(plotselect)
    if plotselect(k) == 0
        set(h.plotEtheolines(k),'Visible', 'off')
        TableBkgColorArray(k,:) = [1 1 1];
        set(h.tableresultsSAMQA,'BackgroundColor',TableBkgColorArray)
    else
        set(h.plotEtheolines(k),'Visible', 'on')
        TableBkgColorArray(k,:) = ColorsTable{k};
        set(h.tableresultsSAMQA,'BackgroundColor',TableBkgColorArray)
    end
end

guidata(hObj, h);

function celleditcallbackAddFluorLines(hObj, ~)
% Callback for Uplottabledata
h = guidata(hObj);
% assignin('base','dspacingQA',h.dspacingQA)
% Get data from fluorescence table 
FluorData = get(hObj,'data');
% assignin('base','FluorData',FluorData)

% Get index of cells where string is not 'Select element'
idx1 = find(strcmp(FluorData, 'Select element'));
idx2 = find(~ismember(9:16,idx1)==1);
[str, orderFluorElements] = sort(h.FluorCellArray{2}(:));

if idx2 ~= 0
    for k = 1:length(idx2)
        Elements(k) = orderFluorElements(find(strcmp(str,FluorData{idx2(k),2})==1));
    end

    for k = 1:length(Elements)
        Ka1 = h.FluorCellArray{1,3}(Elements(k));
        Ka2 = h.FluorCellArray{1,4}(Elements(k));
        Kb1 = h.FluorCellArray{1,5}(Elements(k));
        % Not yet included
        La1 = h.FluorCellArray{1,6}(Elements(k));
        La2 = h.FluorCellArray{1,7}(Elements(k));
        Lb1 = h.FluorCellArray{1,8}(Elements(k));
        Lb2 = h.FluorCellArray{1,9}(Elements(k));
        Lg1 = h.FluorCellArray{1,10}(Elements(k));
        % Prepare data for line plot.
        % Save fluorescence lines into temporary vector.
        k_tmp = [Ka1 Ka2 Kb1 La1 La2 Lb1 Lb2 Lg1];
        for m = 1:size(k_tmp,2)
    %         if k_tmp(m) > str2double(get(h.SelectMeasDataQAedit1,'String')) && k_tmp(m) < str2double(get(h.SelectMeasDataQAedit2,'String'))
            if k_tmp(m) > 0 && k_tmp(m) < 120
                k_tmp1(:,m) = [k_tmp(m) k_tmp(m) nan];
            end
        end
        k_tmp1(:, ~any(k_tmp1,1)) = [];
        k_tmp2 = reshape(k_tmp1,size(k_tmp1,1)*size(k_tmp1,2),1);
        k_tmp2(size(k_tmp1,1)*size(k_tmp1,2),:) = [];

        y_tmp = repmat([0 h.axesplotMeasDataQA.YLim(2) nan],1,size(k_tmp1,2))';
        y_tmp(size(k_tmp1,1)*size(k_tmp1,2),:) = [];
        xdata{k} = k_tmp2;
        ydata{k} = y_tmp;
        clear k_tmp1
    end

    if isfield(h,'plotaddfluorlines')
        for k = 1:8
            set(h.plotaddfluorlines(k),'Visible', 'off')
        end
    end

    for k = 1:8
        if FluorData{k,1} == 0
            h.plotaddfluorlines(k) = line(h.axesplotMeasDataQA, 0, 0,'Color', 'w','LineStyle','-','LineWidth',2,'Visible','off', 'Clipping', 'on');
        else
            h.plotaddfluorlines(k) = line(h.axesplotMeasDataQA, xdata{k}, ydata{k},'Color', h.Colors{k},'LineStyle','-','LineWidth',2,'Visible','off', 'Clipping', 'on');
        end
    end

    for k = 1:8
        if FluorData{k,1} == 0
            set(h.plotaddfluorlines(k),'Visible', 'off')
            TableBkgColorArray(k,:) = [1 1 1];
            set(h.AddFluorLinestable,'BackgroundColor',TableBkgColorArray)
        else
            set(h.plotaddfluorlines(k),'Visible', 'on')
            TableBkgColorArray(k,:) = h.Colors2{k};
            set(h.AddFluorLinestable,'BackgroundColor',TableBkgColorArray)
        end
    end
end

guidata(hObj, h);

%% Rietveld analysis callbacks
% 
% function okbuttoncreatesampleRV(hObj,~)
% % Callback for "Open File" pushbutton
% h = guidata(hObj);
% 
% if strcmp(get(h.editfieldelementRV1,'string'),'Enter elemental formula')
%     errordlg('Please enter formula','Warning');
% else
%     h.P.ElementalFormula = get(h.editfieldelementRV1,'string');
%     h.P.MPDFileName = h.P.PopupValueMpd1;
%     h.P.ShowSubstratePeaks = 0;
%     h.P.SubstrateFormula = get(h.editfieldelement2,'string');
%     h.P.SusbtrateMPDFileName = h.P.PopupValueMpd2;
%     % Set FileName to string and ExPath to UserData of Edit-Field
%     [Sample,T] = CreateSampleGUI(h.P);
%     h.T = T;
%     h.Sample = Sample;
%     
%     msgbox({'Sample Created'});
% end
% % assignin('base','Sample',h.Sample)
% guidata(hObj, h);
% 
% function OpenFileCallbackRV(hObj,~)
% % Callback for "Open File" pushbutton
% h = guidata(hObj);
% 
% % Open file dialog box - Folder may have to be changed manually
% [FileName,FilePath]  = uigetfile('*.*','Load measurement file',[General.ProgramInfo.Path,'\Data\Measurements\']);
% 
% if FileName == 0
%   % user pressed cancel
%   return
% end
% 
% ExPath = fullfile(FilePath, FileName);
% % Set FileName to string and ExPath to UserData of Edit-Field
% set(h.selectfilenameRV,'string',FileName)
% set(h.selectfilenameRV,'UserData',ExPath)
% 
% guidata(hObj, h);
% 
% function okbuttonloadmeasurementRV(hObj,~)
% % Callback for "Load Measurement" ok pushbutton
% h = guidata(hObj);
% 
% % Get measurement mode
% measstr = get(h.popupmenuscanmodeRV,'string');
% measval = get(h.popupmenuscanmodeRV,'value');
% measmode = measstr{measval};
% h.measmode = measmode;
% % Get diffractometer name
% Diffstr = get(h.popupmenudiffRV,'String');
% Diffval = get(h.popupmenudiffRV,'Value');
% Diffsel = Diffstr{Diffval};
% h.Diffsel = Diffsel;
% % Get detector from LEDDI measurements
% Detstr = get(h.popupmenuselectmeas1,'String');
% Detval = get(h.popupmenuselectmeas1,'Value');
% Detsel = Detstr{Detval};
% h.DetselRV = Detsel;
% 
% % Function to make "Fit" button blink in red during fitting process
% col = get(hObj,'backg');  % Get the background color of the figure.
% set(hObj,'str','Loading','backg',[1 .6 .6]) % Change color of button. 
% % The pause (or drawnow) is necessary to make button changes appear.
% pause(.01)
% 
% if strcmp(get(h.selectfilenameRV,'string'),'Select measurement file...')
%     errordlg('No measurement selected','Warning');
% else
%     % Get parameters for the SpecFileConversionGUI script
%     h.P.SpecFileName = get(h.selectfilenameRV,'string');
%     h.P.DiffractometerType = get(h.popupmenudiffRV,'value') - 1;  % -1 since the first value is for info
%     h.P.LoadFromSpecFile = get(h.popupmenuscanmodeRV,'value') - 1;    % -1 since the first value is for info
%     calib = get(h.popupmenuDTCorr,'string');
%     h.P.Calibration = calib{get(h.popupmenuDTCorrRV,'value')};
%     % Run "SpecFileConversionGUI" script
%     [meas,~,DataTmp,~,Diffractometer,P,T] = SpecFileConversionGUI(h.P,h.Sample,h.T);
%     % IF LEDDI measurements were conducted using only one detector
%     if strcmp(h.Diffsel,'LEDDI')
%         set(h.PopupMenuSelectDetRV,'Enable','on')
%         if meas(1).NumberOfDetectors == 1
%             meas = reshape(repmat(meas,2,1),size(meas,2)*2,[]);
%             meas = meas';
%             DataTmp = reshape(repmat(DataTmp,2,1),size(DataTmp,2)*2,[]);
%             DataTmp = DataTmp';
%         end
%     end
% 
%     % Change Emax according to diffractometer
%     if strcmp(h.Diffsel,'LEDDI')
%         
%         for k = 1:length(meas)
%             meas(k).Sample.Materials.EnergyMax = 60;
%         end
%     end
%     % Set output to variables
%     h.Measurement = meas;
%     h.MeasurementBackup = meas;
% %     h.MeasurementRawData = meas.Clone;
%     h.Diffractometer = Diffractometer;
%     h.DataTmp = DataTmp;
%     h.DataTmpBackup = DataTmp;
%     h.RawData = DataTmp;
%     h.P = P;
%     h.T = T;
% 
%      % Get theoretical peak positions
%     h.TPeaks = TheoreticalPeakPositions(meas,DataTmp);
%     if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
%         a = h.TPeaks.T.Etheo < h.TPeaks.T.EMax;
%         assignin('base','TPeaks',h.TPeaks)
%         assignin('base','a',a)
%         EtheoLimit = h.TPeaks.T.Etheo(a);
% %         X1Limit = h.TPeaks.T.X1(a,:);
%         X3Limit = h.TPeaks.T.X3((1:(3*length(EtheoLimit)-1)),:);
%         Y3Limit = h.TPeaks.T.Y3((1:(3*length(EtheoLimit)-1)),:);
%         % Calculate multiplicity
%         Multiplicity = zeros(size(a,1));
%         if strcmp(h.TPeaks.T.cs,'bcc') || strcmp(h.TPeaks.T.cs,'fcc')
%             hkl = h.TPeaks.T.hkl_sort(:,1:3);
%             for k = 1:size(hkl,1)
%                 if hkl(k,1) == 0 && hkl(k,2) == 0 && hkl(k,3) ~= 0 || ...
%                         hkl(k,1) == 0 && hkl(k,2) ~= 0 && hkl(k,3) == 0 || ...
%                         hkl(k,1) ~= 0 && hkl(k,2) == 0 && hkl(k,3) == 0
%                     Multiplicity(:,k) = 6;
%                 elseif hkl(k,1) == 0 && hkl(k,2) == hkl(k,3) || ...
%                         hkl(k,2) == 0 && hkl(k,1) == hkl(k,3) || ...
%                         hkl(k,3) == 0 && hkl(k,1) == hkl(k,2)
%                     Multiplicity(:,k) = 12;
%                 elseif hkl(k,1) == hkl(k,2) && hkl(k,2) == hkl(k,3) && hkl(k,1) == hkl(k,3)
%                     Multiplicity(:,k) = 8;
%                 elseif hkl(k,1) == 0 && hkl(k,2) ~= hkl(k,3) || ...
%                         hkl(k,2) == 0 && hkl(k,1) ~= hkl(k,3) || ...
%                         hkl(k,3) == 0 && hkl(k,1) ~= hkl(k,2)
%                     Multiplicity(:,k) = 24;
%                 elseif hkl(k,1) ~= hkl(k,2) && hkl(k,1) ~= hkl(k,3) && hkl(k,2) == hkl(k,3) || ...
%                         hkl(k,1) == hkl(k,3) && hkl(k,1) ~= hkl(k,2) && hkl(k,2) ~= hkl(k,3) || ...
%                         hkl(k,1) == hkl(k,2) && hkl(k,3) ~= hkl(k,1) && hkl(k,3) ~= hkl(k,2)
%                     Multiplicity(:,k) = 24;
%                 else
%                     Multiplicity(:,k) = 48;
%                 end
%             end
%             h.Multiplicity = Multiplicity';
%         end
%             
%         % Set data for table with hkl, d-spacing and E[keV] values
%         set(h.tablephasehklRV,'data',[num2cell(h.TPeaks.T.Peaks(a,1:3)) num2cell(h.Multiplicity(a)) num2cell(h.TPeaks.T.Peaks(a,4:5)) num2cell(false(size(num2cell(h.TPeaks.T.Peaks(a,:)),1),1))])
%     elseif strcmp(h.Diffsel,'LEDDI')
%         if strcmp(h.Detsel,'Detector 1')
%             Slidersteps = 2:2:length(h.Measurement);
%             h.TPeaksDet1 = TheoreticalPeakPositions(h.Measurement(Slidersteps),h.DataTmp(Slidersteps));
%             a = h.TPeaksDet1.T.Etheo < 60;
%             EtheoLimit = h.TPeaksDet1.T.Etheo(a);
% %             X1Limit = h.TPeaksDet1.T.X1(a,:);
%             X3Limit = h.TPeaksDet1.T.X3((1:(3*length(EtheoLimit)-1)),:);
%             Y3Limit = h.TPeaksDet1.T.Y3((1:(3*length(EtheoLimit)-1)),:);
%             % Set data for table with hkl, d-spacing and E[keV] values
% %             set(h.tablephasehkl,'data',h.TPeaksDet1.T.Peaks(a,:))
%             % Calculate multiplicity
%             Multiplicity = zeros(size(a,1));
%             if strcmp(h.TPeaks.T.cs,'bcc') || strcmp(h.TPeaks.T.cs,'fcc')
%                 hkl = h.TPeaks.T.hkl_sort(:,1:3);
%                 for k = 1:size(hkl,1)
%                     if hkl(k,1) == 0 && hkl(k,2) == 0 && hkl(k,3) ~= 0 || ...
%                             hkl(k,1) == 0 && hkl(k,2) ~= 0 && hkl(k,3) == 0 || ...
%                             hkl(k,1) ~= 0 && hkl(k,2) == 0 && hkl(k,3) == 0
%                         Multiplicity(:,k) = 6;
%                     elseif hkl(k,1) == 0 && hkl(k,2) == hkl(k,3) || ...
%                             hkl(k,2) == 0 && hkl(k,1) == hkl(k,3) || ...
%                             hkl(k,3) == 0 && hkl(k,1) == hkl(k,2)
%                         Multiplicity(:,k) = 12;
%                     elseif hkl(k,1) == hkl(k,2) && hkl(k,2) == hkl(k,3) && hkl(k,1) == hkl(k,3)
%                         Multiplicity(:,k) = 8;
%                     elseif hkl(k,1) == 0 && hkl(k,2) ~= hkl(k,3) || ...
%                             hkl(k,2) == 0 && hkl(k,1) ~= hkl(k,3) || ...
%                             hkl(k,3) == 0 && hkl(k,1) ~= hkl(k,2)
%                         Multiplicity(:,k) = 24;
%                     elseif hkl(k,1) ~= hkl(k,2) && hkl(k,1) ~= hkl(k,3) && hkl(k,2) == hkl(k,3) || ...
%                             hkl(k,1) == hkl(k,3) && hkl(k,1) ~= hkl(k,2) && hkl(k,2) ~= hkl(k,3) || ...
%                             hkl(k,1) == hkl(k,2) && hkl(k,3) ~= hkl(k,1) && hkl(k,3) ~= hkl(k,2)
%                         Multiplicity(:,k) = 24;
%                     else
%                         Multiplicity(:,k) = 48;
%                     end
%                 end
%                 h.Multiplicity = Multiplicity';
%             end
%             set(h.tablephasehklRV,'data',[num2cell(h.TPeaksDet1.T.Peaks(a,1:3)) num2cell(h.Multiplicity(a)) num2cell(h.TPeaksDet1.T.Peaks(a,4:5)) num2cell(false(size(h.TPeaksDet1.T.Peaks(a,:),1),1))])
%         elseif strcmp(h.Detsel,'Detector 2')
%             Slidersteps = 1:2:length(h.Measurement);
%             h.TPeaksDet2 = TheoreticalPeakPositions(h.Measurement(Slidersteps),h.DataTmp(Slidersteps));
%             a = h.TPeaksDet2.T.Etheo < 60;
%             EtheoLimit = h.TPeaksDet2.T.Etheo(a);
%             X3Limit = h.TPeaksDet2.T.X3((1:(3*length(EtheoLimit)-1)),:);
%             Y3Limit = h.TPeaksDet2.T.Y3((1:(3*length(EtheoLimit)-1)),:);
%             % Set data for table with hkl, d-spacing and E[keV] values
%             % Calculate multiplicity
%             Multiplicity = zeros(size(a,1));
%             if strcmp(h.TPeaks.T.cs,'bcc') || strcmp(h.TPeaks.T.cs,'fcc')
%                 hkl = h.TPeaks.T.hkl_sort(:,1:3);
%                 for k = 1:size(hkl,1)
%                     if hkl(k,1) == 0 && hkl(k,2) == 0 && hkl(k,3) ~= 0 || ...
%                             hkl(k,1) == 0 && hkl(k,2) ~= 0 && hkl(k,3) == 0 || ...
%                             hkl(k,1) ~= 0 && hkl(k,2) == 0 && hkl(k,3) == 0
%                         Multiplicity(:,k) = 6;
%                     elseif hkl(k,1) == 0 && hkl(k,2) == hkl(k,3) || ...
%                             hkl(k,2) == 0 && hkl(k,1) == hkl(k,3) || ...
%                             hkl(k,3) == 0 && hkl(k,1) == hkl(k,2)
%                         Multiplicity(:,k) = 12;
%                     elseif hkl(k,1) == hkl(k,2) && hkl(k,2) == hkl(k,3) && hkl(k,1) == hkl(k,3)
%                         Multiplicity(:,k) = 8;
%                     elseif hkl(k,1) == 0 && hkl(k,2) ~= hkl(k,3) || ...
%                             hkl(k,2) == 0 && hkl(k,1) ~= hkl(k,3) || ...
%                             hkl(k,3) == 0 && hkl(k,1) ~= hkl(k,2)
%                         Multiplicity(:,k) = 24;
%                     elseif hkl(k,1) ~= hkl(k,2) && hkl(k,1) ~= hkl(k,3) && hkl(k,2) == hkl(k,3) || ...
%                             hkl(k,1) == hkl(k,3) && hkl(k,1) ~= hkl(k,2) && hkl(k,2) ~= hkl(k,3) || ...
%                             hkl(k,1) == hkl(k,2) && hkl(k,3) ~= hkl(k,1) && hkl(k,3) ~= hkl(k,2)
%                         Multiplicity(:,k) = 24;
%                     else
%                         Multiplicity(:,k) = 48;
%                     end
%                 end
%                 h.Multiplicity = Multiplicity';
%             end
%             set(h.tablephasehklRV,'data',[num2cell(h.TPeaksDet2.T.Peaks(a,1:3)) num2cell(h.Multiplicity(a)) num2cell(h.TPeaksDet2.T.Peaks(a,4:5)) num2cell(false(size(h.TPeaksDet2.T.Peaks(a,:),1),1))])
%         end
%     end
%     % Set plot data for theoretical line positions
%     if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
%         set(h.plotEtheoRV,'xdata',X3Limit(:,1))
%         set(h.plotEtheoRV,'ydata',Y3Limit(:,1))
%     elseif strcmp(h.Diffsel,'LEDDI')
%         % Distinguish between Det1 and Det2
%         if strcmp(h.DetselRV,'Detector 1')
%             Slidersteps = 2:2:length(h.Measurement);
%             set(h.plotEtheoRV,'xdata',X3Limit(:,Slidersteps(1)))
%             set(h.plotEtheoRV,'ydata',Y3Limit(:,Slidersteps(1)))
%         elseif strcmp(h.DetselRV,'Detector 2')
%             Slidersteps = 1:2:length(h.Measurement);
%             set(h.plotEtheoRV,'xdata',X3Limit(:,Slidersteps(1)))
%             set(h.plotEtheoRV,'ydata',Y3Limit(:,Slidersteps(1)))    
%         end
%     end
%     set(h.plotEtheoRV,'Visible','on')
%     
% 
%     % Change slider parameters according to size of meas
%     if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
%         if length(meas) == 1
%             set(h.SliderRV,'Min',1);
%             set(h.SliderRV,'Max',length(meas));
%             set(h.SliderRV,'SliderStep',[1 1]);
%             set(h.SliderRV,'Visible','off');
%         else
%             set(h.SliderRV,'Min',1);
%             set(h.SliderRV,'Max',length(meas));
%             set(h.SliderRV,'SliderStep',[1/(length(meas)-1) 1/(length(meas)-1)]);
%         end
%     elseif strcmp(h.Diffsel,'LEDDI')
%         if length(meas) == 2
%             set(h.SliderRV,'Min',1);
%             set(h.SliderRV,'Max',length(meas));
%             set(h.SliderRV,'SliderStep',[1 1]);
%             set(h.SliderRV,'Visible','off');
%         else
%             set(h.SliderRV,'Min',1);
%             set(h.SliderRV,'Max',length(meas)/2);
%             set(h.SliderRV,'SliderStep',[1/((length(meas)/2)-1) 1/((length(meas)/2)-1)]);
%         end
%     end
%     
%     % Set plot data and parameters
%     if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
%         set(h.plotdataRV,'xdata',DataTmp{1}(:,1))
%         set(h.plotdataRV,'ydata',DataTmp{1}(:,2))
%         set(h.axesplotMeasDataRV.Title,'String',['Measurement data for ', meas(1).Name])
%     elseif strcmp(h.Diffsel,'LEDDI')
%         if strcmp(h.DetselRV,'Detector 1')
%             set(h.plotdataRV,'xdata',DataTmp{2}(:,1))
%             set(h.plotdataRV,'ydata',DataTmp{2}(:,2))
%             set(h.axesplotMeasDataRV.Title,'String',['Measurement data for ', meas(2).Name])
%         elseif strcmp(h.DetselRV,'Detector 2')
%             set(h.plotdataRV,'xdata',DataTmp{1}(:,1))
%             set(h.plotdataRV,'ydata',DataTmp{1}(:,2))
%             set(h.axesplotMeasDataRV.Title,'String',['Measurement data for ', meas(1).Name])
%         end 
%     end
%     
%     % Set initial parameters for panel "Select Measurements"
%     if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
%         h.axesplotMeasDataRV.XLim = [0, 120];
%         h.axesplotMeasDataRV.YLim = [0, ceil(max(DataTmp{1}(:,2))/10)*10];
%     elseif strcmp(h.Diffsel,'LEDDI')
%         h.axesplotMeasDataRV.XLim = [0, 60];
%         h.axesplotMeasDataRV.YLim = [0, Inf];
%     end
% end
% 
% % Reset the button color
% set(hObj,'str','Ok','backg',col)  % Now reset the button features.
% 
% assignin('base','meas',meas)
% 
% % Messagebox
% msgbox('Measurement file loaded.');
% 
% guidata(hObj, h);
% 
% function SliderCallbackPlotDataRV(hObj, ~)
% % This callback handles the changes when the slider button is pushed.
% h = guidata(hObj);
% % Get slider value
% value = get(hObj, 'Value');
% value = round(value);
% 
% % Set plot data and plot ranges/limits for different diffractometers
% if strcmp(h.Diffsel,'LEDDI')
%     % If LEDDI has been used for the measurement
%     if strcmp(h.DetselRV,'Detector 1')
%         % In order to analyze the data measured with Det1, the following
%         % Slidersteps have to be used
%         Slidersteps = 2:2:length(h.Measurement);
%         % Set plot data according to the current slider value
%         set(h.plotdataRV,'xdata',h.DataTmp{Slidersteps(value)}(:,1))
%         set(h.plotdataRV,'ydata',h.DataTmp{Slidersteps(value)}(:,2))
%         % Set axes limits
%         if isfield(h, 'XminnewRV') && ~isfield(h, 'XmaxnewRV')
%             h.axesplotMeasDataRV.XLim = [h.XminnewRV, 60];
%             h.axesplotMeasDataRV.YLim =[-Inf ceil(max(h.DataTmp{Slidersteps(value)}(h.XLimMinIndRV:end,2))/10)*10];
%         elseif isfield(h, 'XmaxnewRV') && ~isfield(h, 'XminnewRV')
%             h.axesplotMeasDataRV.XLim = [0, h.XmaxnewRV];
%             h.axesplotMeasDataRV.YLim =[-Inf ceil(max(h.DataTmp{Slidersteps(value)}(1:h.XLimMaxIndRV,2))/10)*10];
%         elseif isfield(h, 'XminnewRV') && isfield(h, 'XmaxnewRV')
%             h.axesplotMeasDataRV.XLim = [h.XminnewRV, h.XmaxnewRV];
%             h.axesplotMeasDataRV.YLim =[-Inf ceil(max(h.DataTmp{Slidersteps(value)}(h.XLimMinIndRV:h.XLimMaxIndRV,2))/10)*10];
%         else
%             h.axesplotMeasDataRV.XLim = [0, 60];
%             h.axesplotMeasDataRV.YLim =[-Inf ceil(max(h.DataTmp{Slidersteps(value)}(:,2))/10)*10];
%         end
%         % Set title according to current slider value
%         set(h.axesplotMeasDataRV.Title,'String',['Measurement Data for ', h.Measurement(Slidersteps(value)).Name])
%     elseif strcmp(h.DetselRV,'Detector 2')
%         % In order to analyze the data measured with Det2, the following
%         % Slidersteps have to be used
%         Slidersteps = 1:2:length(h.Measurement);   
%         % Set plot data according to the current slider value
%         set(h.plotdataRV,'xdata',h.DataTmp{Slidersteps(value)}(:,1))
%         set(h.plotdataRV,'ydata',h.DataTmp{Slidersteps(value)}(:,2))
%         % Set axes limits
%         if isfield(h, 'XminnewRV') && ~isfield(h, 'XmaxnewRV')
%             h.axesplotMeasDataRV.XLim = [h.XminnewRV, 60];
%             h.axesplotMeasDataRV.YLim =[-Inf ceil(max(h.DataTmp{Slidersteps(value)}(h.XLimMinIndRV:end,2))/10)*10];
%         elseif isfield(h, 'XmaxnewRV') && ~isfield(h, 'XminnewRV')
%             h.axesplotMeasDataRV.XLim = [0, h.XmaxnewRV];
%             h.axesplotMeasDataRV.YLim =[-Inf ceil(max(h.DataTmp{Slidersteps(value)}(1:h.XLimMaxIndRV,2))/10)*10];
%         elseif isfield(h, 'XminnewRV') && isfield(h, 'XmaxnewRV')
%             h.axesplotMeasDataRV.XLim = [h.XminnewRV, h.XmaxnewRV];
%             h.axesplotMeasDataRV.YLim =[-Inf ceil(max(h.DataTmp{Slidersteps(value)}(h.XLimMinIndRV:h.XLimMaxIndRV,2))/10)*10];
%         else
%             h.axesplotMeasDataRV.XLim = [0, 60];
%             h.axesplotMeasDataRV.YLim =[-Inf ceil(max(h.DataTmp{Slidersteps(value)}(:,2))/10)*10];
%         end
%         % Set title according to current slider value
%         set(h.axesplotMeasDataRV.Title,'String',['Measurement Data for ', h.Measurement(Slidersteps(value)).Name])
%     end
% else
%     if h.checkboxplotall == 1
%         if strcmp(h.Diffsel,'LEDDI')
%         % If LEDDI has been used for the measurement
%             if strcmp(h.DetselRV,'Detector 1')
%                 Slidersteps = 2:2:length(h.Measurement);
%                 % Set plot data
%                 set(h.plotdataRV,'xdata',h.DataTmp{Slidersteps(value)}(:,1))
%                 set(h.plotdataRV,'ydata',h.DataTmp{Slidersteps(value)}(:,2))
%                 uistack(h.plotdataRV,'top');
%             elseif strcmp(h.DetselRV,'Detector 2')
%                 Slidersteps = 1:2:length(h.Measurement);
%                 % Set plot data
%                 set(h.plotdataRV,'xdata',h.DataTmp{Slidersteps(value)}(:,1))
%                 set(h.plotdataRV,'ydata',h.DataTmp{Slidersteps(value)}(:,2))
%                 uistack(h.plotdataRV,'top');
%             end
%         else
%             % Set plot data
%             set(h.plotdataRV,'xdata',h.DataTmp{1}(:,1))
%             set(h.plotdataRV,'ydata',h.DataTmp{valueSlider}(:,2))
%             % Set axes limits
%             if isfield(h, 'XminnewRV') && ~isfield(h, 'XmaxnewRV')
%                 h.axesplotMeasDataRV.XLim = [h.XminnewRV, 120];
%                 h.axesplotMeasDataRV.YLim =[-Inf ceil(max(h.DataTmp{value}(h.XLimMinIndRV:end,2))/10)*10];
%             elseif isfield(h, 'XmaxnewRV') && ~isfield(h, 'XminnewRV')
%                 h.axesplotMeasDataRV.XLim = [0, h.XmaxnewRV];
%                 h.axesplotMeasDataRV.YLim =[-Inf ceil(max(h.DataTmp{value}(1:h.XLimMaxIndRV,2))/10)*10];
%             elseif isfield(h, 'XminnewRV') && isfield(h, 'XmaxnewRV')
%                 h.axesplotMeasDataRV.XLim = [h.XminnewRV, h.XmaxnewRV];
%                 h.axesplotMeasDataRV.YLim =[-Inf ceil(max(h.DataTmp{value}(h.XLimMinIndRV:h.XLimMaxIndRV,2))/10)*10];
%             else
%                 h.axesplotMeasDataRV.XLim = [0, 120];
%                 h.axesplotMeasDataRV.YLim =[-Inf ceil(max(h.DataTmp{value}(:,2))/10)*10];
%             end
%             uistack(h.plotdataRV,'top');
%         end
%     else
%         % If EDDI or MetalJet has been used for the measurement
%         % Set plot data according to the current slider value
%         set(h.plotdataRV,'xdata',h.DataTmp{value}(:,1))
%         set(h.plotdataRV,'ydata',h.DataTmp{value}(:,2))
%         % Set axes limits
%         if isfield(h, 'XminnewRV') && ~isfield(h, 'XmaxnewRV')
%             h.axesplotMeasDataRV.XLim = [h.XminnewRV, 120];
%             h.axesplotMeasDataRV.YLim =[-Inf ceil(max(h.DataTmp{value}(h.XLimMinIndRV:end,2))/10)*10];
%         elseif isfield(h, 'XmaxnewRV') && ~isfield(h, 'XminnewRV')
%             h.axesplotMeasDataRV.XLim = [0, h.XmaxnewRV];
%             h.axesplotMeasDataRV.YLim =[-Inf ceil(max(h.DataTmp{value}(1:h.XLimMaxIndRV,2))/10)*10];
%         elseif isfield(h, 'XminnewRV') && isfield(h, 'XmaxnewRV')
%             h.axesplotMeasDataRV.XLim = [h.XminnewRV, h.XmaxnewRV];
%             h.axesplotMeasDataRV.YLim =[-Inf ceil(max(h.DataTmp{value}(h.XLimMinIndRV:h.XLimMaxIndRV,2))/10)*10];
%         else
%             h.axesplotMeasDataRV.XLim = [0, 120];
%             h.axesplotMeasDataRV.YLim =[-Inf ceil(max(h.DataTmp{value}(:,2))/10)*10];
%         end
%         % Set title according to current slider value
%         set(h.axesplotMeasDataRV.Title,'String',['Measurement Data for ', h.Measurement(round(value)).Name])
%     end
% end
% 
% guidata(hObj, h);
% 
% function SelectEminRV(hObj,~)
% % Change plot limits
% h = guidata(hObj);
% % Get slider value
% value = get(h.SliderRV,'Value');
% 
% Xmin = str2double(get(hObj,'String'));
% h.axesplotMeasDataRV.XLim(1) = Xmin;
% h.XminnewRV = Xmin;
% % YLim also needs to be recalculated
% % Find index of new Xmin
% if strcmp(h.Diffsel,'LEDDI')
%     if strcmp(h.DetselRV,'Detector 1')
%         Slidersteps = 2:2:length(h.Measurement);
%         h.XLimMinIndRV = Tools.Data.DataSetOperations.FindNearestIndex(h.DataTmp{Slidersteps(value)}(:,1),Xmin);
%         h.axesplotMeasDataRV.YLim =[-Inf ceil(max(h.DataTmp{Slidersteps(value)}(h.XLimMinIndRV:end,2))/10)*10];
%     elseif strcmp(h.DetselRV,'Detector 2')
%         Slidersteps = 1:2:length(h.Measurement);
%         h.XLimMinIndRV = Tools.Data.DataSetOperations.FindNearestIndex(h.DataTmp{Slidersteps(value)}(:,1),Xmin);
%         h.axesplotMeasDataRV.YLim =[-Inf ceil(max(h.DataTmp{Slidersteps(value)}(h.XLimMinIndRV:end,2))/10)*10];
%     end            
% else
%     h.XLimMinIndRV = Tools.Data.DataSetOperations.FindNearestIndex(h.DataTmp{value}(:,1),Xmin);
%     h.axesplotMeasDataRV.YLim =[-Inf ceil(max(h.DataTmp{value}(h.XLimMinIndRV:end,2))/10)*10];
% end
% 
% % Change entries of hkl table
% EnergyRange = get(h.axesplotMeasDataRV,'XLim');
% % Get theoretical peak positions
% a = h.TPeaks.T.Etheo > EnergyRange(1) & h.TPeaks.T.Etheo < EnergyRange(2);
% h.FitPeaksLogicalErangeRV = a;
% % Change peak list in hkl table according to new E-range
% idxnan = find(isnan(h.TPeaks.T.X3(:,1)));
% X3Limit = h.TPeaks.T.X3(((idxnan(find(a, 1, 'first'))-2):end),:);
% Y3Limit = h.TPeaks.T.Y3((idxnan(find(a, 1, 'first'))-2:end),:);
% 
% % Change Ymax according to energy range
% set(h.plotEtheoRV,'xdata',X3Limit(:,value))
% set(h.plotEtheoRV,'ydata',Y3Limit(:,value).*(max(h.DataTmp{value}(:,2))/max(Y3Limit(:,value))))
% % Set data for table with hkl, d-spacing and E[keV] values
% if ~isfield(h, 'TableBkgColorArray')
%     set(h.tablephasehklRV,'data',[num2cell(h.TPeaks.T.Peaks(a,1:3)) num2cell(h.Multiplicity(a)) num2cell(h.TPeaks.T.Peaks(a,4:5)) num2cell(false(size(num2cell(h.TPeaks.T.Peaks(a,:)),1),1))])
% else
%     PeakSelLogical = false(length(h.TableBkgColorArray(:,3)),1);
%     PeakSelLogical(h.TableBkgColorArray(:,3)==0.6) = true;
%     set(h.tablephasehklRV,'data',[num2cell(h.TPeaks.T.Peaks(a,1:3)) num2cell(h.Multiplicity(a)) num2cell(h.TPeaks.T.Peaks(a,4:5)) num2cell(PeakSelLogical)])
% end
% 
% guidata(hObj, h);
% 
% function SelectEmaxRV(hObj,~)
% % Change plot limits
% h = guidata(hObj);
% % Get slider value
% value = get(h.SliderRV,'Value');
% 
% Xmax = str2double(get(hObj,'String'));
% h.axesplotMeasDataRV.XLim(2) = Xmax;
% h.XmaxnewRV = Xmax;
% % YLim also needs to be recalculated
% % Find index of new Xmax
% if strcmp(h.Diffsel,'LEDDI')
%     if strcmp(h.DetselRV,'Detector 1')
%         Slidersteps = 2:2:length(h.Measurement);
%         h.XLimMaxIndRV = Tools.Data.DataSetOperations.FindNearestIndex(h.DataTmp{Slidersteps(value)}(:,1),Xmax);
%         h.axesplotMeasDataRV.YLim =[-Inf ceil(max(h.DataTmp{Slidersteps(value)}(h.XLimMinIndRV:h.XLimMaxIndRV,2))/10)*10];
%     elseif strcmp(h.DetselRV,'Detector 2')
%         Slidersteps = 1:2:length(h.Measurement);
%         h.XLimMaxIndRV = Tools.Data.DataSetOperations.FindNearestIndex(h.DataTmp{Slidersteps(value)}(:,1),Xmax);
%         h.axesplotMeasDataRV.YLim =[-Inf ceil(max(h.DataTmp{Slidersteps(value)}(h.XLimMinIndRV:h.XLimMaxIndRV,2))/10)*10];
%     end 
% else
%     h.XLimMaxIndRV = Tools.Data.DataSetOperations.FindNearestIndex(h.DataTmp{value}(:,1),Xmax);
%     h.axesplotMeasDataRV.YLim =[-Inf ceil(max(h.DataTmp{value}(h.XLimMinIndRV:h.XLimMaxIndRV,2))/10)*10];
% end
% 
% % Change entries of hkl table
% EnergyRange = get(h.axesplotMeasDataRV,'XLim');
% % Get theoretical peak positions
% a = h.TPeaks.T.Etheo > EnergyRange(1) & h.TPeaks.T.Etheo < EnergyRange(2);
% h.FitPeaksLogicalErangeRV = a;
% 
% % Change peak list in hkl table according to new E-range
% idxnan = find(isnan(h.TPeaks.T.X3(:,1)));
% X3Limit = h.TPeaks.T.X3(((idxnan(find(a, 1, 'first'))-2):(idxnan(find(a, 1, 'last'))-1)),:);
% Y3Limit = h.TPeaks.T.Y3((idxnan(find(a, 1, 'first'))-2:(idxnan(find(a, 1, 'last'))-1)),:);
% 
% % Change Ymax according to energy range
% set(h.plotEtheoRV,'xdata',X3Limit(:,value))
% set(h.plotEtheoRV,'ydata',Y3Limit(:,value).*(max(h.DataTmp{value}(:,2))/max(Y3Limit(:,value))))
% % Set data for table with hkl, d-spacing and E[keV] values
% if ~isfield(h, 'TableBkgColorArray')
%     set(h.tablephasehklRV,'data',[num2cell(h.TPeaks.T.Peaks(a,1:3)) num2cell(h.Multiplicity(a)) num2cell(h.TPeaks.T.Peaks(a,4:5)) num2cell(false(size(num2cell(h.TPeaks.T.Peaks(a,:)),1),1))])
% else
%     PeakSelLogical = false(length(h.TableBkgColorArray(:,3)),1);
%     PeakSelLogical(h.TableBkgColorArray(:,3)==0.6) = true;
%     set(h.tablephasehklRV,'data',[num2cell(h.TPeaks.T.Peaks(a,1:3)) num2cell(h.Multiplicity(a)) num2cell(h.TPeaks.T.Peaks(a,4:5)) num2cell(PeakSelLogical)])
% end
% 
% guidata(hObj, h);
% 
% function celleditcallbackHKLTableRV(hObj, ~)
% Callback for uitable to select peaks hkl to be used in Rietveld analysis 
h = guidata(hObj);
% Get data from hkl table 
SelectPeaktabledata = get(hObj,'data');

% Get measurement mode
measstr = get(h.popupmenuscanmodeRV,'string');
measval = get(h.popupmenuscanmodeRV,'value');
measmode = measstr{measval};
h.measmode = measmode;
% Get diffractometer name
Diffstr = get(h.popupmenudiffRV,'String');
Diffval = get(h.popupmenudiffRV,'Value');
Diffsel = Diffstr{Diffval};
h.Diffsel = Diffsel;

Detstr = get(h.popupmenuselectmeas1,'String');
Detval = get(h.popupmenuselectmeas1,'Value');
Detsel = Detstr{Detval};
h.DetselRV = Detsel;

% Extract only logical (last column) - this logical replaces the one found
% from defining peaks manually. Keep backup of original one!
idxhklPeaks = [SelectPeaktabledata{:,7}]';

if strcmp(h.Diffsel,'EDDI') || strcmp(h.Diffsel,'LIMAX-160') || strcmp(h.Diffsel,'LIMAX-70')
        h.FitPeaksLogicalRV = idxhklPeaks;
elseif strcmp(h.Diffsel,'LEDDI')
    if strcmp(h.DetselRV,'Detector 1')
            h.FitPeaksLogicalDet1RV = idxhklPeaks;
    elseif strcmp(h.DetselRV,'Detector 2')
            h.FitPeaksLogicalDet2RV = idxhklPeaks;
    end
end

% Array of table color usd to mark selected hkl peaks
TableBkgColor = [1 0.6 0.6];
TableBkgColorArray = repmat(TableBkgColor,size(idxhklPeaks,1),1);
% Create double from logical index
SelectedhklPeaks = double(idxhklPeaks);
% Set table background color for user selected peaks hkl
TableBkgColorArray = TableBkgColorArray.*SelectedhklPeaks;
TableBkgColorArray(TableBkgColorArray==0) = 1;
set(h.tablephasehklRV,'BackgroundColor',TableBkgColorArray)

guidata(hObj, h);